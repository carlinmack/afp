<div id="Randomised_Quick_Sort">
<div class="head">
<h1>Theory Randomised_Quick_Sort</h1>
</div>
<pre class="source"><span class="comment1">(*
  File:     Randomised_Quick_Sort.thy
  Author:   Manuel Eberl &lt;eberlm@in.tum.de&gt;

  Definition and cost analysis of randomised QuickSort (i.e. pivot chosen uniformly at random).
*)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Randomised QuickSort›</span></span>
<span class="keyword1"><span class="command">theory</span></span> Randomised_Quick_Sort
  <span class="keyword2"><span class="keyword">imports</span></span> 
    <span class="quoted">"<a href="../../HOL/HOL-Probability/Probability.html">HOL-Probability.Probability</a>"</span>
    <span class="quoted">"<a href="../Landau_Symbols/Landau_More.html">Landau_Symbols.Landau_More</a>"</span>
    <a href="../Comparison_Sort_Lower_Bound/Linorder_Relations.html">Comparison_Sort_Lower_Bound.Linorder_Relations</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Deletion by index›</span></span>  

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The following function deletes the $n$-th element of a list.
›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">delete_index</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">delete_index</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">delete_index</span> <span class="main">0</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">delete_index</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free">delete_index</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> delete_index_altdef<span class="main">:</span> <span class="quoted"><span class="quoted">"delete_index <span class="free">n</span> <span class="free">xs</span> <span class="main">=</span> take <span class="free">n</span> <span class="free">xs</span> <span class="main">@</span> drop <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> delete_index.induct<span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> delete_index_ge_length<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≥</span> length <span class="free">xs</span> <span class="main">⟹</span> delete_index <span class="free">n</span> <span class="free">xs</span> <span class="main">=</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> delete_index_altdef<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> length_delete_index <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">⟹</span> length <span class="main">(</span>delete_index <span class="free">n</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> length <span class="free">xs</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> delete_index_altdef<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> delete_index_Cons<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"delete_index <span class="free">n</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">n</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="free">xs</span> <span class="keyword1">else</span> <span class="free">x</span> <span class="main">#</span> delete_index <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="operator">simp_all</span>
    
<span class="keyword1"><span class="command">lemma</span></span> insert_set_delete_index<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">⟹</span> insert <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> <span class="free">n</span><span class="main">)</span> <span class="main">(</span>set <span class="main">(</span>delete_index <span class="free">n</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> set <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> delete_index.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> add_mset_delete_index<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">⟹</span> add_mset <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="main">(</span>mset <span class="main">(</span>delete_index <span class="free">i</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> mset <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> delete_index.induct<span class="main">)</span> <span class="operator">simp_all</span>
    
<span class="keyword1"><span class="command">lemma</span></span> nth_delete_index<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">⟹</span> <span class="free">n</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">⟹</span> 
     delete_index <span class="free">n</span> <span class="free">xs</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">i</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="keyword1">then</span> <span class="free">xs</span> <span class="main">!</span> <span class="free">i</span> <span class="keyword1">else</span> <span class="free">xs</span> <span class="main">!</span> Suc <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> delete_index_altdef nth_append min_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> set_delete_index_distinct<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&lt;</span> length <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"set <span class="main">(</span>delete_index <span class="free">n</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> set <span class="free">xs</span> <span class="main">-</span> <span class="main">{</span><span class="free">xs</span> <span class="main">!</span> <span class="free">n</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> delete_index.induct<span class="main">)</span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>
    
<span class="keyword1"><span class="command">lemma</span></span> distinct_delete_index <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main">]</span><span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>delete_index <span class="free">n</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&lt;</span> length <span class="free">xs</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> delete_index.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> set_delete_index_distinct<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> delete_index_ge_length assms<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mset_delete_index <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">⟹</span> mset <span class="main">(</span>delete_index <span class="free">i</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> mset <span class="free">xs</span> <span class="main">-</span> <span class="main">{#</span> <span class="free">xs</span><span class="main">!</span><span class="free">i</span> <span class="main">#}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> delete_index.induct<span class="main">)</span> <span class="operator">simp_all</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Definition›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The following is a functional randomised version of QuickSort that also records the number 
  of comparisons that were made. The randomisation is in the selection of the pivot element: 
  In each step, the next pivot is chosen uniformly at random from all remaining list elements.

  The function takes the ordering relation to use as a first argument in the form of a set of 
  pairs.
›</span></span>  

<span class="keyword1"><span class="command">function</span></span> <span class="entity">rquicksort</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'a</span><span class="main">)</span> set <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> list <span class="main">×</span> nat<span class="main">)</span> pmf"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">rquicksort</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> 
     <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> <span class="main">[]</span> <span class="keyword1">then</span> 
        return_pmf <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span>
      <span class="keyword1">else</span>
        <span class="keyword1">do</span> <span class="main">{</span>
          <span class="bound">i</span> <span class="main">←</span> pmf_of_set <span class="main">{..&lt;</span>length <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">}</span><span class="main">;</span>
          <span class="keyword1">let</span> <span class="bound">x</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">!</span> <span class="bound">i</span><span class="main">;</span>
          <span class="keyword1">case</span> partition <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="bound">y</span><span class="main">,</span><span class="bound">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">)</span> <span class="main">(</span>delete_index <span class="bound">i</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="keyword1">of</span>
            <span class="main">(</span><span class="bound">ls</span><span class="main">,</span> <span class="bound">rs</span><span class="main">)</span> <span class="main">⇒</span> <span class="keyword1">do</span> <span class="main">{</span>
              <span class="main">(</span><span class="bound">ls</span><span class="main">,</span> <span class="bound">n1</span><span class="main">)</span> <span class="main">←</span> <span class="free">rquicksort</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="bound">ls</span><span class="main">;</span>
              <span class="main">(</span><span class="bound">rs</span><span class="main">,</span> <span class="bound">n2</span><span class="main">)</span> <span class="main">←</span> <span class="free">rquicksort</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="bound">rs</span><span class="main">;</span>
              return_pmf <span class="main">(</span><span class="bound">ls</span> <span class="main">@</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span> <span class="main">@</span> <span class="bound">rs</span><span class="main">,</span> length <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">-</span> <span class="main">1</span> <span class="main">+</span> <span class="bound">n1</span> <span class="main">+</span> <span class="bound">n2</span><span class="main">)</span>
            <span class="main">}</span>
        <span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">termination</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">relation</span> <span class="quoted"><span class="quoted">"Wellfounded.measure <span class="main">(</span>length <span class="main">∘</span> snd<span class="main">)</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wf <span class="main">(</span>Wellfounded.measure <span class="main">(</span>length <span class="main">∘</span> snd<span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> set_pmf_of_set<span class="main"><span class="keyword3">;</span></span> <span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> le_less_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> length_filter_le<span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">declare</span></span> rquicksort.simps <span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> rquicksort_Nil <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"rquicksort <span class="free">R</span> <span class="main">[]</span> <span class="main">=</span> return_pmf <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rquicksort.simps<span class="main">)</span>

 
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Correctness proof›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> set_pmf_of_set_lessThan_length <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span> set_pmf <span class="main">(</span>pmf_of_set <span class="main">{..&lt;</span>length <span class="free">xs</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="main">{..&lt;</span>length <span class="free">xs</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> set_pmf_of_set<span class="main">)</span> <span class="operator">auto</span>
    
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We can now prove that any list that can be returned by QuickSort is sorted w.\,r.\,t.\ the 
  given relation. (as long as that relation is reflexive, transitive, and total)
›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> rquicksort_correct<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"trans <span class="free">R</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"total_on <span class="main">(</span>set <span class="free">xs</span><span class="main">)</span> <span class="free">R</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>set <span class="free">xs</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ys</span><span class="main">,</span> <span class="free">n</span><span class="main">)</span> <span class="main">∈</span> set_pmf <span class="main">(</span>rquicksort <span class="free">R</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"sorted_wrt <span class="free">R</span> <span class="free">ys</span> <span class="main">∧</span> mset <span class="free">ys</span> <span class="main">=</span> mset <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2-<span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> length_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"sorted_wrt <span class="free">R</span> <span class="skolem">zs</span>"</span></span> <span class="quoted"><span class="quoted">"mset <span class="skolem">zs</span> <span class="main">=</span> mset <span class="skolem">ys</span>"</span></span> 
    <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">zs</span><span class="main">,</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">∈</span> set_pmf <span class="main">(</span>rquicksort <span class="free">R</span> <span class="skolem">ys</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">ys</span> <span class="main">&lt;</span> length <span class="skolem">xs</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">ys</span> <span class="main">⊆</span> set <span class="skolem">xs</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">zs</span> <span class="skolem">ys</span> <span class="skolem">n</span>
    <span class="keyword1"><span class="command">using</span></span> that <span class="quoted">"1.IH"</span> total_on_subset<span class="main">[</span><span class="operator">OF</span> <span class="quoted">"1.prems"</span><span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> that<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="quoted">"1.prems"</span><span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">=</span> <span class="main">[]</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted">"1.prems"</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ls</span></span> <span class="skolem"><span class="skolem">rs</span></span> <span class="skolem"><span class="skolem">n1</span></span> <span class="skolem"><span class="skolem">n2</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> *<span class="main">:</span>
       <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="skolem">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">ls</span><span class="main">,</span> <span class="skolem">n1</span><span class="main">)</span> <span class="main">∈</span> set_pmf <span class="main">(</span>rquicksort <span class="free">R</span> <span class="main">[</span><span class="bound">y</span><span class="main">←</span>delete_index <span class="skolem">i</span> <span class="skolem">xs</span><span class="main">.</span> <span class="main">(</span><span class="bound">y</span><span class="main">,</span> <span class="skolem">xs</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span><span class="main">]</span><span class="main">)</span>"</span></span>
       <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">rs</span><span class="main">,</span> <span class="skolem">n2</span><span class="main">)</span> <span class="main">∈</span> set_pmf <span class="main">(</span>rquicksort <span class="free">R</span> <span class="main">[</span><span class="bound">y</span><span class="main">←</span>delete_index <span class="skolem">i</span> <span class="skolem">xs</span><span class="main">.</span> <span class="main">(</span><span class="bound">y</span><span class="main">,</span> <span class="skolem">xs</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">∉</span> <span class="free">R</span><span class="main">]</span><span class="main">)</span>"</span></span>
       <span class="quoted"><span class="quoted">"<span class="skolem">ys</span> <span class="main">=</span> <span class="skolem">ls</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">xs</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">rs</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> rquicksort.simps<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">xs</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def o_def<span class="main">)</span>
    <span class="keyword1"><span class="command">note</span></span> ys <span class="main">=</span> <span class="quoted"><span class="quoted">‹<span class="skolem">ys</span> <span class="main">=</span> <span class="skolem">ls</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">xs</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">rs</span>›</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">ls'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ls'</span> <span class="main">=</span> <span class="main">[</span><span class="bound">y</span><span class="main">←</span>delete_index <span class="skolem">i</span> <span class="skolem">xs</span><span class="main">.</span> <span class="main">(</span><span class="bound">y</span><span class="main">,</span> <span class="skolem">xs</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span><span class="main">]</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">rs'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rs'</span> <span class="main">=</span> <span class="main">[</span><span class="bound">y</span><span class="main">←</span>delete_index <span class="skolem">i</span> <span class="skolem">xs</span><span class="main">.</span> <span class="main">(</span><span class="bound">y</span><span class="main">,</span> <span class="skolem">xs</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">∉</span> <span class="free">R</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="skolem">xs</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> less<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">ls'</span> <span class="main">&lt;</span> length <span class="skolem">xs</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">rs'</span> <span class="main">&lt;</span> length <span class="skolem">xs</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> ls'_def rs'_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> le_less_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> length_filter_le<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">force</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">have</span></span> ls<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">ls</span><span class="main">,</span> <span class="skolem">n1</span><span class="main">)</span> <span class="main">∈</span> set_pmf <span class="main">(</span>rquicksort <span class="free">R</span> <span class="skolem">ls'</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> rs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">rs</span><span class="main">,</span> <span class="skolem">n2</span><span class="main">)</span> <span class="main">∈</span> set_pmf <span class="main">(</span>rquicksort <span class="free">R</span> <span class="skolem">rs'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">unfolding</span></span> ls'_def rs'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">have</span></span> subset<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="skolem">ls'</span> <span class="main">⊆</span> set <span class="skolem">xs</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">rs'</span> <span class="main">⊆</span> set <span class="skolem">xs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> insert_set_delete_index<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">i</span></span> <span class="quoted"><span class="skolem">xs</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="skolem">xs</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ls'_def rs'_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> sorted<span class="main">:</span> <span class="quoted"><span class="quoted">"sorted_wrt <span class="free">R</span> <span class="skolem">ls</span>"</span></span> <span class="quoted"><span class="quoted">"sorted_wrt <span class="free">R</span> <span class="skolem">rs</span>"</span></span> 
     <span class="keyword2"><span class="keyword">and</span></span> mset<span class="main">:</span> <span class="quoted"><span class="quoted">"mset <span class="skolem">ls</span> <span class="main">=</span> mset <span class="skolem">ls'</span>"</span></span> <span class="quoted"><span class="quoted">"mset <span class="skolem">rs</span> <span class="main">=</span> mset <span class="skolem">rs'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> IH<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">ls</span></span></span></span></span></span></span></span></span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">n1</span></span></span></span></span></span></span></span></span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">ls'</span></span></span></span></span></span></span></span></span></span></span></span><span class="main"><span class="main">]</span></span> IH<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">rs</span></span></span></span></span></span></span></span></span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">n2</span></span></span></span></span></span></span></span></span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">rs'</span></span></span></span></span></span></span></span></span></span></span></span><span class="main"><span class="main">]</span></span> less ls rs subset<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
        
    <span class="keyword1"><span class="command">have</span></span> ls_le<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">xs</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set <span class="skolem">ls</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">from</span></span> that <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈#</span> mset <span class="skolem">ls</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">note</span></span> mset<span class="main">(</span>1<span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ls'_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">have</span></span> rs_ge<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">xs</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">∉</span> <span class="free">R</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">xs</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">,</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set <span class="skolem">rs</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">from</span></span> that <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈#</span> mset <span class="skolem">rs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">note</span></span> mset<span class="main">(</span>2<span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set <span class="skolem">rs'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">xs</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">∉</span> <span class="free">R</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rs'_def<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> x <span class="keyword2"><span class="keyword">and</span></span> subset <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="skolem">xs</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set <span class="skolem">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">∈</span> set <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> <span class="quoted">"1.prems"</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">xs</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">∉</span> <span class="free">R</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">xs</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">,</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> total_on_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sorted_wrt <span class="free">R</span> <span class="skolem">ys</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> ys
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sorted_wrt_append <span class="quoted"><span class="quoted">‹trans <span class="free">R</span>›</span></span> sorted_wrt_singleton sorted<span class="main">)</span>
         <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> rs_ge ls_le transD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹trans <span class="free">R</span>›</span></span><span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span><span class="main">!</span><span class="skolem">i</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mset <span class="skolem">ys</span> <span class="main">=</span> mset <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> ys <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="skolem">xs</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mset ls'_def rs'_def add_mset_delete_index<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> <span class="quoted">"1.prems"</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>
  

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Cost analysis›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The following distribution describes the number of comparisons made by randomised 
  QuickSort in terms of the list length. (This is only valid if all list elements are distinct)

  A succinct explanation of this cost analysis is given by Jacek Cicho\'{n}~\cite{cichon}.
›</span></span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">rqs_cost</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat pmf"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">rqs_cost</span> <span class="main">0</span> <span class="main">=</span> return_pmf <span class="main">0</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">rqs_cost</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> 
     <span class="keyword1">do</span> <span class="main">{</span><span class="bound">i</span> <span class="main">←</span> pmf_of_set <span class="main">{..</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">}</span><span class="main">;</span> <span class="bound">a</span> <span class="main">←</span> <span class="free">rqs_cost</span> <span class="bound">i</span><span class="main">;</span> <span class="bound">b</span> <span class="main">←</span> <span class="free">rqs_cost</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">-</span> <span class="bound">i</span><span class="main">)</span><span class="main">;</span> return_pmf <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">+</span> <span class="bound">a</span> <span class="main">+</span> <span class="bound">b</span><span class="main">)</span><span class="main">}</span>"</span></span>
     
<span class="keyword1"><span class="command">lemma</span></span> finite_set_pmf_rqs_cost <span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>set_pmf <span class="main">(</span>rqs_cost <span class="free">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rqs_cost.induct<span class="main">)</span> <span class="operator">simp_all</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We connect the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> rqs_cost<span class="antiquote"><span class="antiquote">}</span></span></span></span> function to the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> rquicksort<span class="antiquote"><span class="antiquote">}</span></span></span></span> function by showing that
  projecting out the number of comparisons from a run of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> rquicksort<span class="antiquote"><span class="antiquote">}</span></span></span></span> on a list with distinct
  elements yields the same distribution as <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> rqs_cost<span class="antiquote"><span class="antiquote">}</span></span></span></span> for the length of that list.
›</span></span>
<span class="keyword1"><span class="command">theorem</span></span> snd_rquicksort<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"linorder_on <span class="free">A</span> <span class="free">R</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"set <span class="free">xs</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"map_pmf snd <span class="main">(</span>rquicksort <span class="free">R</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> rqs_cost <span class="main">(</span>length <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2-<span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> length_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"map_pmf snd <span class="main">(</span>rquicksort <span class="free">R</span> <span class="skolem">ys</span><span class="main">)</span> <span class="main">=</span> rqs_cost <span class="main">(</span>length <span class="skolem">ys</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">ys</span> <span class="main">&lt;</span> length <span class="skolem">xs</span>"</span></span> <span class="quoted"><span class="quoted">"mset <span class="skolem">ys</span> <span class="main">⊆#</span> mset <span class="skolem">xs</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">ys</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> set_mset_mono<span class="main">[</span><span class="operator">OF</span> that<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">ys</span> <span class="main">⊆</span> set <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">note</span></span> <span class="quoted"><span class="quoted">‹set <span class="skolem">xs</span> <span class="main">⊆</span> <span class="free">A</span>›</span></span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">ys</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹distinct <span class="skolem">xs</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> that<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distinct <span class="skolem">ys</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> distinct_mset_mono<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> that <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted">"1.IH"</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> length <span class="skolem">xs</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">cnt</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">cnt</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> length <span class="main">[</span><span class="bound">y</span><span class="main">←</span>delete_index <span class="bound">i</span> <span class="skolem">xs</span><span class="main">.</span> <span class="main">(</span><span class="bound">y</span><span class="main">,</span> <span class="skolem">xs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> cnt_altdef<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">cnt</span> <span class="skolem">i</span> <span class="main">=</span> linorder_rank <span class="free">R</span> <span class="main">(</span>set <span class="skolem">xs</span><span class="main">)</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">n</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">cnt</span> <span class="skolem">i</span> <span class="main">=</span> length <span class="main">[</span><span class="bound">y</span><span class="main">←</span>delete_index <span class="skolem">i</span> <span class="skolem">xs</span><span class="main">.</span> <span class="main">(</span><span class="bound">y</span><span class="main">,</span> <span class="skolem">xs</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cnt_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> card <span class="main">(</span>set <span class="main">[</span><span class="bound">y</span><span class="main">←</span>delete_index <span class="skolem">i</span> <span class="skolem">xs</span><span class="main">.</span> <span class="main">(</span><span class="bound">y</span><span class="main">,</span> <span class="skolem">xs</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span><span class="main">]</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> distinct_card <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> distinct_filter distinct_delete_index <span class="quoted">"1.prems"</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">[</span><span class="bound">y</span><span class="main">←</span>delete_index <span class="skolem">i</span> <span class="skolem">xs</span><span class="main">.</span> <span class="main">(</span><span class="bound">y</span><span class="main">,</span> <span class="skolem">xs</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span><span class="main">]</span> <span class="main">=</span> 
                      <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> set <span class="skolem">xs</span><span class="main">-</span><span class="main">{</span><span class="skolem">xs</span><span class="main">!</span><span class="skolem">i</span><span class="main">}</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="skolem">xs</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1.prems"</span> <span class="keyword2"><span class="keyword">and</span></span> i <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> set_delete_index_distinct n_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">…</span> <span class="main">=</span> linorder_rank <span class="free">R</span> <span class="main">(</span>set <span class="skolem">xs</span><span class="main">)</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> linorder_rank_def<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted">"1.prems"</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bij_betw <span class="main">(</span><span class="main">(!)</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">{..&lt;</span><span class="skolem">n</span><span class="main">}</span> <span class="main">(</span>set <span class="skolem">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> bij_betw_byWitness<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f' <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"index <span class="skolem"><span class="skolem"><span class="skolem">xs</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> n_def index_nth_id<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bij_betw <span class="main">(</span>linorder_rank <span class="free">R</span> <span class="main">(</span>set <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>set <span class="skolem">xs</span><span class="main">)</span> <span class="main">{..&lt;</span>card <span class="main">(</span>set <span class="skolem">xs</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> bij_betw_linorder_rank<span class="main">)</span> <span class="main">(</span><span class="operator">insert</span> <span class="quoted">"1.prems"</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bij_betw <span class="main">(</span>linorder_rank <span class="free">R</span> <span class="main">(</span>set <span class="skolem">xs</span><span class="main">)</span> <span class="main">∘</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">xs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">{..&lt;</span><span class="skolem">n</span><span class="main">}</span> <span class="main">{..&lt;</span>card <span class="main">(</span>set <span class="skolem">xs</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> bij_betw_trans<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> bij<span class="main">:</span> <span class="quoted"><span class="quoted">"bij_betw <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> linorder_rank <span class="free">R</span> <span class="main">(</span>set <span class="skolem">xs</span><span class="main">)</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">{..&lt;</span><span class="skolem">n</span><span class="main">}</span> <span class="main">{..&lt;</span><span class="skolem">n</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1.prems"</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> n_def o_def distinct_card<span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">=</span> <span class="main">[]</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> n_def<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> notI<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> False <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map_pmf snd <span class="main">(</span>rquicksort <span class="free">R</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> 
             pmf_of_set <span class="main">{..&lt;</span>length <span class="skolem">xs</span><span class="main">}</span> <span class="main">⤜</span> 
               <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> map_pmf <span class="main">(</span><span class="main">λ</span><span class="bound">z</span><span class="main">.</span> length <span class="skolem">xs</span> <span class="main">-</span> <span class="main">1</span> <span class="main">+</span> fst <span class="bound">z</span> <span class="main">+</span> snd <span class="bound">z</span><span class="main">)</span>
                  <span class="main">(</span>pair_pmf <span class="main">(</span>map_pmf snd <span class="main">(</span>rquicksort <span class="free">R</span> <span class="main">[</span><span class="bound">y</span><span class="main">←</span>delete_index <span class="bound">i</span> <span class="skolem">xs</span><span class="main">.</span> <span class="main">(</span><span class="bound">y</span><span class="main">,</span> <span class="skolem">xs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>
                            <span class="main">(</span>map_pmf snd <span class="main">(</span>rquicksort <span class="free">R</span> <span class="main">[</span><span class="bound">y</span><span class="main">←</span>delete_index <span class="bound">i</span> <span class="skolem">xs</span><span class="main">.</span> <span class="main">(</span><span class="bound">y</span><span class="main">,</span> <span class="skolem">xs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∉</span> <span class="free">R</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> rquicksort.simps<span class="main">)</span>
         <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_bind_pmf bind_map_pmf Let_def case_prod_unfold o_def pair_pmf_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> pmf_of_set <span class="main">{..&lt;</span>length <span class="skolem">xs</span><span class="main">}</span> <span class="main">⤜</span> 
                      <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> map_pmf <span class="main">(</span><span class="main">λ</span><span class="bound">z</span><span class="main">.</span> <span class="skolem">n</span> <span class="main">-</span> <span class="main">1</span> <span class="main">+</span> fst <span class="bound">z</span> <span class="main">+</span> snd <span class="bound">z</span><span class="main">)</span>
                         <span class="main">(</span>pair_pmf <span class="main">(</span>rqs_cost <span class="main">(</span><span class="skolem">cnt</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>rqs_cost <span class="main">(</span><span class="skolem">n</span> <span class="main">-</span> <span class="main">1</span> <span class="main">-</span> <span class="skolem">cnt</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> bind_pmf_cong refl<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">i</span><span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">xs</span> <span class="main">≠</span> <span class="main">[]</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> i <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map_pmf snd <span class="main">(</span>rquicksort <span class="free">R</span> <span class="main">[</span><span class="bound">y</span><span class="main">←</span>delete_index <span class="skolem">i</span> <span class="skolem">xs</span><span class="main">.</span> <span class="main">(</span><span class="bound">y</span><span class="main">,</span> <span class="skolem">xs</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">∉</span> <span class="free">R</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> 
                              rqs_cost <span class="main">(</span>length <span class="main">[</span><span class="bound">y</span><span class="main">←</span>delete_index <span class="skolem">i</span> <span class="skolem">xs</span><span class="main">.</span> <span class="main">(</span><span class="bound">y</span><span class="main">,</span> <span class="skolem">xs</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">∉</span> <span class="free">R</span><span class="main">]</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> IH<span class="main">)</span> 
           <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> le_less_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> length_filter_le<span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mset_filter 
                 <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> subset_mset.order.trans multiset_filter_subset diff_subset_eq_self<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">[</span><span class="bound">y</span><span class="main">←</span>delete_index <span class="skolem">i</span> <span class="skolem">xs</span><span class="main">.</span> <span class="main">(</span><span class="bound">y</span><span class="main">,</span> <span class="skolem">xs</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">∉</span> <span class="free">R</span><span class="main">]</span> <span class="main">=</span> <span class="skolem">n</span> <span class="main">-</span> <span class="main">1</span> <span class="main">-</span> <span class="skolem">cnt</span> <span class="skolem">i</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> n_def cnt_def 
        <span class="keyword1"><span class="command">using</span></span> sum_length_filter_compl<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="bound">y</span><span class="main">,</span> <span class="skolem">xs</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span>"</span></span> <span class="quoted"><span class="quoted">"delete_index <span class="skolem">i</span> <span class="skolem">xs</span>"</span></span><span class="main">]</span> i <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map_pmf snd <span class="main">(</span>rquicksort <span class="free">R</span> <span class="main">[</span><span class="bound">y</span><span class="main">←</span>delete_index <span class="skolem">i</span> <span class="skolem">xs</span><span class="main">.</span> <span class="main">(</span><span class="bound">y</span><span class="main">,</span> <span class="skolem">xs</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">∉</span> <span class="free">R</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> 
                      rqs_cost <span class="main">(</span><span class="skolem">n</span> <span class="main">-</span> <span class="main">1</span> <span class="main">-</span> <span class="skolem">cnt</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map_pmf snd <span class="main">(</span>rquicksort <span class="free">R</span> <span class="main">[</span><span class="bound">y</span><span class="main">←</span>delete_index <span class="skolem">i</span> <span class="skolem">xs</span><span class="main">.</span> <span class="main">(</span><span class="bound">y</span><span class="main">,</span> <span class="skolem">xs</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> 
                       rqs_cost <span class="main">(</span><span class="skolem">cnt</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> cnt_def <span class="keyword1"><span class="command">using</span></span> i
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> IH<span class="main">)</span> 
           <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> le_less_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> length_filter_le<span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mset_filter 
                 <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> subset_mset.order.trans multiset_filter_subset diff_subset_eq_self<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> n_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> map_pmf <span class="skolem">cnt</span> <span class="main">(</span>pmf_of_set <span class="main">{..&lt;</span><span class="skolem">n</span><span class="main">}</span><span class="main">)</span> <span class="main">⤜</span> 
          <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> map_pmf <span class="main">(</span><span class="main">λ</span><span class="bound">z</span><span class="main">.</span> <span class="skolem">n</span> <span class="main">-</span> <span class="main">1</span> <span class="main">+</span> fst <span class="bound">z</span> <span class="main">+</span> snd <span class="bound">z</span><span class="main">)</span> <span class="main">(</span>pair_pmf <span class="main">(</span>rqs_cost <span class="bound">i</span><span class="main">)</span> <span class="main">(</span>rqs_cost <span class="main">(</span><span class="skolem">n</span> <span class="main">-</span> <span class="main">1</span> <span class="main">-</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> bind_pmf <span class="main">_</span> <span class="var">?f</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_map_pmf n_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map_pmf <span class="skolem">cnt</span> <span class="main">(</span>pmf_of_set <span class="main">{..&lt;</span><span class="skolem">n</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> 
                 map_pmf <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> linorder_rank <span class="free">R</span> <span class="main">(</span>set <span class="skolem">xs</span><span class="main">)</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>pmf_of_set <span class="main">{..&lt;</span><span class="skolem">n</span><span class="main">}</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> map_pmf_cong refl<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> set_pmf_of_set<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cnt_altdef<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> pmf_of_set <span class="main">{..&lt;</span><span class="skolem">n</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> map_pmf_of_set_bij_betw bij<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pmf_of_set <span class="main">{..&lt;</span><span class="skolem">n</span><span class="main">}</span> <span class="main">⤜</span> <span class="var">?f</span> <span class="main">=</span> rqs_cost <span class="skolem">n</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lessThan_Suc_atMost bind_map_pmf map_bind_pmf pair_pmf_def<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> n_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Expected cost›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  It is relatively straightforward to see that the following recursive function 
  (sometimes called the `QuickSort equation') describes the expectation of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> rqs_cost<span class="antiquote"><span class="antiquote">}</span></span></span></span>, 
  i.e. the expected number of comparisons of QuickSort when run on a list with distinct elements.
›</span></span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">rqs_cost_exp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">rqs_cost_exp</span> <span class="main">0</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">rqs_cost_exp</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> real <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">≤</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">.</span> <span class="free">rqs_cost_exp</span> <span class="bound">i</span> <span class="main">+</span> <span class="free">rqs_cost_exp</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">-</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> real <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> rqs_cost_exp_0 <span class="main">=</span> rqs_cost_exp.simps<span class="main">(</span>1<span class="main">)</span>
<span class="keyword1"><span class="command">lemmas</span></span> rqs_cost_exp_Suc <span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span> <span class="main">=</span> rqs_cost_exp.simps<span class="main">(</span>2<span class="main">)</span>
<span class="keyword1"><span class="command">lemma</span></span> rqs_cost_exp_Suc_0 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"rqs_cost_exp <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rqs_cost_exp_Suc<span class="main">)</span>
  
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The following theorem shows that <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> rqs_cost_exp<span class="antiquote"><span class="antiquote">}</span></span></span></span> is indeed the expectation of 
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> rqs_cost<span class="antiquote"><span class="antiquote">}</span></span></span></span>.
›</span></span>
<span class="keyword1"><span class="command">theorem</span></span> expectation_rqs_cost<span class="main">:</span> <span class="quoted"><span class="quoted">"measure_pmf.expectation <span class="main">(</span>rqs_cost <span class="free">n</span><span class="main">)</span> real <span class="main">=</span> rqs_cost_exp <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rqs_cost.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> IH <span class="main">=</span> <span class="quoted">"2.IH"</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"measure_pmf.expectation <span class="main">(</span>rqs_cost <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> real <span class="main">=</span> 
          <span class="main">(</span><span class="main">∑</span><span class="bound">a</span><span class="main">≤</span><span class="skolem">n</span><span class="main">.</span> inverse <span class="main">(</span>real <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span>
              measure_pmf.expectation <span class="main">(</span>rqs_cost <span class="bound">a</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">aa</span><span class="main">.</span> rqs_cost <span class="main">(</span><span class="skolem">n</span> <span class="main">-</span> <span class="bound">a</span><span class="main">)</span> <span class="main">⤜</span>
                 <span class="main">(</span><span class="main">λ</span><span class="bound">b</span><span class="main">.</span> return_pmf <span class="main">(</span><span class="skolem">n</span> <span class="main">+</span> <span class="bound">aa</span> <span class="main">+</span> <span class="bound">b</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> real<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> rqs_cost.simps <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> pmf_expectation_bind_pmf_of_set<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">≤</span><span class="skolem">n</span><span class="main">.</span> inverse <span class="main">(</span>real <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>real <span class="skolem">n</span> <span class="main">+</span> rqs_cost_exp <span class="bound">i</span> <span class="main">+</span> rqs_cost_exp <span class="main">(</span><span class="skolem">n</span> <span class="main">-</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> sum.cong refl<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">i</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rqs_cost <span class="skolem">i</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> rqs_cost <span class="main">(</span><span class="skolem">n</span> <span class="main">-</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">b</span><span class="main">.</span> return_pmf <span class="main">(</span><span class="skolem">n</span> <span class="main">+</span> <span class="bound">a</span> <span class="main">+</span> <span class="bound">b</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
            map_pmf <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span><span class="main">.</span> <span class="skolem">n</span> <span class="main">+</span> <span class="bound">a</span> <span class="main">+</span> <span class="bound">b</span><span class="main">)</span> <span class="main">(</span>pair_pmf <span class="main">(</span>rqs_cost <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span>rqs_cost <span class="main">(</span><span class="skolem">n</span> <span class="main">-</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pair_pmf_def map_bind_pmf<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"measure_pmf.expectation <span class="main">…</span> real <span class="main">=</span> 
                 measure_pmf.expectation <span class="main">(</span>pair_pmf <span class="main">(</span>rqs_cost <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span>rqs_cost <span class="main">(</span><span class="skolem">n</span> <span class="main">-</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> 
                   <span class="main">(</span><span class="main">λ</span><span class="bound">z</span><span class="main">.</span> real <span class="skolem">n</span> <span class="main">+</span> <span class="main">(</span>real <span class="main">(</span>fst <span class="bound">z</span><span class="main">)</span> <span class="main">+</span> real <span class="main">(</span>snd <span class="bound">z</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> integral_map_pmf<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> case_prod_unfold add_ac<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> real <span class="skolem">n</span> <span class="main">+</span> measure_pmf.expectation <span class="main">(</span>pair_pmf <span class="main">(</span>rqs_cost <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span>rqs_cost <span class="main">(</span><span class="skolem">n</span> <span class="main">-</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
                      <span class="main">(</span><span class="main">λ</span><span class="bound">z</span><span class="main">.</span> real <span class="main">(</span>fst <span class="bound">z</span><span class="main">)</span> <span class="main">+</span> real <span class="main">(</span>snd <span class="bound">z</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="main">_</span> <span class="main">+</span> <span class="var">?A</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> Bochner_Integration.integral_add<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> integrable_measure_pmf_finite<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?A</span> <span class="main">=</span> measure_pmf.expectation <span class="main">(</span>map_pmf fst <span class="main">(</span>pair_pmf <span class="main">(</span>rqs_cost <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span>rqs_cost <span class="main">(</span><span class="skolem">n</span> <span class="main">-</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> real <span class="main">+</span>
                    measure_pmf.expectation <span class="main">(</span>map_pmf snd <span class="main">(</span>pair_pmf <span class="main">(</span>rqs_cost <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span>rqs_cost <span class="main">(</span><span class="skolem">n</span> <span class="main">-</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> real"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> integral_map_pmf
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> Bochner_Integration.integral_add<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> integrable_measure_pmf_finite<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> measure_pmf.expectation <span class="main">(</span>rqs_cost <span class="skolem">i</span><span class="main">)</span> real <span class="main">+</span>
                    measure_pmf.expectation <span class="main">(</span>rqs_cost <span class="main">(</span><span class="skolem">n</span> <span class="main">-</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> real"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> map_fst_pair_pmf map_snd_pair_pmf <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> 1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> rqs_cost_exp <span class="skolem">i</span> <span class="main">+</span> rqs_cost_exp <span class="main">(</span><span class="skolem">n</span> <span class="main">-</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> IH<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">≤</span><span class="skolem">n</span><span class="main">.</span> inverse <span class="main">(</span>real <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> real <span class="skolem">n</span><span class="main">)</span> <span class="main">+</span> 
                    <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">≤</span><span class="skolem">n</span><span class="main">.</span> rqs_cost_exp <span class="bound">i</span> <span class="main">+</span> rqs_cost_exp <span class="main">(</span><span class="skolem">n</span> <span class="main">-</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> real <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum.distrib <span class="dynamic"><span class="dynamic">field_simps</span></span> sum_distrib_left sum_distrib_right 
          sum_divide_distrib <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> of_nat_Suc<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">≤</span><span class="skolem">n</span><span class="main">.</span> inverse <span class="main">(</span>real <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> real <span class="skolem">n</span><span class="main">)</span> <span class="main">=</span> real <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">≤</span><span class="skolem">n</span><span class="main">.</span> rqs_cost_exp <span class="bound">i</span> <span class="main">+</span> rqs_cost_exp <span class="main">(</span><span class="skolem">n</span> <span class="main">-</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> real <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">=</span> rqs_cost_exp <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rqs_cost_exp_Suc<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We will now obtain a closed-form solution for <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> rqs_cost_exp<span class="antiquote"><span class="antiquote">}</span></span></span></span>. First of all, we can 
  reindex the right-most sum in the recursion step and obtain:
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> rqs_cost_exp_Suc'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"rqs_cost_exp <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">=</span> real <span class="free">n</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">/</span> real <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">≤</span><span class="free">n</span><span class="main">.</span> rqs_cost_exp <span class="bound">i</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rqs_cost_exp <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">=</span> real <span class="free">n</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">≤</span><span class="free">n</span><span class="main">.</span> rqs_cost_exp <span class="bound">i</span> <span class="main">+</span> rqs_cost_exp <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> real <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> rqs_cost_exp_Suc<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">≤</span><span class="free">n</span><span class="main">.</span> rqs_cost_exp <span class="bound">i</span> <span class="main">+</span> rqs_cost_exp <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">≤</span><span class="free">n</span><span class="main">.</span> rqs_cost_exp <span class="bound">i</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">≤</span><span class="free">n</span><span class="main">.</span> rqs_cost_exp <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum.distrib<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">≤</span><span class="free">n</span><span class="main">.</span> rqs_cost_exp <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">≤</span><span class="free">n</span><span class="main">.</span> rqs_cost_exp <span class="bound">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum.reindex_bij_witness<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">λ</span></span></span><span class="bound"><span class="bound"><span class="bound">i</span></span></span><span class="main"><span class="main"><span class="main">.</span></span></span> <span class="free"><span class="free"><span class="free">n</span></span></span> <span class="main"><span class="main"><span class="main">-</span></span></span> <span class="bound"><span class="bound"><span class="bound">i</span></span></span>"</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">λ</span></span></span><span class="bound"><span class="bound"><span class="bound">i</span></span></span><span class="main"><span class="main"><span class="main">.</span></span></span> <span class="free"><span class="free"><span class="free">n</span></span></span> <span class="main"><span class="main"><span class="main">-</span></span></span> <span class="bound"><span class="bound"><span class="bound">i</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">+</span> <span class="main">…</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">*</span> <span class="main">…</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">/</span> real <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">/</span> real <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">≤</span><span class="free">n</span><span class="main">.</span> rqs_cost_exp <span class="bound">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Next, we can apply some standard techniques to transform this equation into a simple
  linear recurrence, which we can then solve easily in terms of harmonic numbers:
›</span></span>
<span class="keyword1"><span class="command">theorem</span></span> rqs_cost_exp_eq <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"rqs_cost_exp <span class="free">n</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">*</span> real <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> harm <span class="free">n</span> <span class="main">-</span> <span class="numeral">4</span> <span class="main">*</span> real <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">F</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">F</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> rqs_cost_exp <span class="bound">n</span> <span class="main">/</span> <span class="main">(</span>real <span class="bound">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">F</span> <span class="main">0</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">F</span> <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> F_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> F_Suc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">F</span> <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">F</span> <span class="skolem">m</span> <span class="main">+</span> real <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="skolem">m</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span>real <span class="main">(</span><span class="main">(</span><span class="skolem">m</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">*</span><span class="main">(</span><span class="skolem">m</span><span class="main">+</span><span class="numeral">2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">m</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">m</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"rqs_cost_exp <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> real <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
            real <span class="main">(</span><span class="main">(</span><span class="skolem">n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">*</span><span class="main">(</span><span class="skolem">n</span><span class="main">+</span><span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">≤</span><span class="skolem">n</span><span class="main">.</span> rqs_cost_exp <span class="bound">i</span><span class="main">)</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">*</span> rqs_cost_exp <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> rqs_cost_exp_Suc'<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"rqs_cost_exp <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">*</span> real <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">=</span> real <span class="main">(</span><span class="skolem">n</span><span class="main">*</span><span class="main">(</span><span class="skolem">n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">≤</span><span class="skolem">n</span><span class="main">.</span> rqs_cost_exp <span class="bound">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> rqs_cost_exp_Suc'<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rqs_cost_exp <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> real <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> rqs_cost_exp <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">*</span> real <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">=</span>
            real <span class="main">(</span><span class="main">(</span><span class="skolem">n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">*</span><span class="main">(</span><span class="skolem">n</span><span class="main">+</span><span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> real <span class="main">(</span><span class="skolem">n</span><span class="main">*</span><span class="main">(</span><span class="skolem">n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">*</span> rqs_cost_exp <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> A<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> B<span class="main">)</span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"real <span class="main">(</span><span class="main">(</span><span class="skolem">n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">*</span><span class="main">(</span><span class="skolem">n</span><span class="main">+</span><span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> real <span class="main">(</span><span class="skolem">n</span><span class="main">*</span><span class="main">(</span><span class="skolem">n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> real <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="main">(</span><span class="skolem">n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rqs_cost_exp <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> real <span class="main">(</span><span class="skolem">n</span><span class="main">+</span><span class="numeral">2</span><span class="main">)</span> <span class="main">=</span> rqs_cost_exp <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">*</span> real <span class="main">(</span><span class="skolem">n</span><span class="main">+</span><span class="numeral">3</span><span class="main">)</span> <span class="main">+</span> real <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="main">(</span><span class="skolem">n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"rqs_cost_exp <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> real <span class="main">(</span><span class="skolem">n</span><span class="main">+</span><span class="numeral">3</span><span class="main">)</span> <span class="main">=</span> 
             rqs_cost_exp <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">/</span> real <span class="main">(</span><span class="skolem">n</span><span class="main">+</span><span class="numeral">2</span><span class="main">)</span> <span class="main">+</span> real <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="main">(</span><span class="skolem">n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span>real <span class="main">(</span><span class="skolem">n</span><span class="main">+</span><span class="numeral">2</span><span class="main">)</span><span class="main">*</span>real <span class="main">(</span><span class="skolem">n</span><span class="main">+</span><span class="numeral">3</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">divide_simps</span></span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> of_nat_Suc of_nat_add<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> F_def <span class="dynamic"><span class="dynamic">algebra_simps</span></span> Suc<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>
  
  <span class="keyword1"><span class="command">have</span></span> F_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">F</span> <span class="skolem">n</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="skolem">n</span><span class="main">.</span> real <span class="main">(</span><span class="bound">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">/</span> real <span class="main">(</span><span class="bound">k</span> <span class="main">*</span> <span class="main">(</span><span class="bound">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">n</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">≥</span> <span class="main">1</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">n</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> dec_induct<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> F_Suc <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> not_le<span class="main">)</span>
  
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">F</span> <span class="free">n</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> real <span class="main">(</span><span class="bound">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">/</span> real <span class="main">(</span><span class="bound">k</span> <span class="main">*</span> <span class="main">(</span><span class="bound">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">*</span> <span class="var">?S</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> F_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?S</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> <span class="numeral">2</span> <span class="main">/</span> real <span class="main">(</span>Suc <span class="bound">k</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span> <span class="main">/</span> real <span class="bound">k</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum.cong<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span> of_nat_diff<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> inverse <span class="main">(</span>real <span class="main">(</span>Suc <span class="bound">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> harm <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sum_subtractf<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> harm_def sum.distrib sum_distrib_left <span class="dynamic"><span class="dynamic">divide_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> inverse <span class="main">(</span>real <span class="main">(</span>Suc <span class="bound">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">=</span>Suc <span class="main">1</span><span class="main">..</span>Suc <span class="free">n</span><span class="main">.</span> inverse <span class="main">(</span>real <span class="bound">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum.reindex_bij_witness<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">λ</span></span></span><span class="bound"><span class="bound"><span class="bound">x</span></span></span><span class="main"><span class="main"><span class="main">.</span></span></span> <span class="bound"><span class="bound"><span class="bound">x</span></span></span> <span class="main"><span class="main"><span class="main">-</span></span></span> <span class="main"><span class="main"><span class="main">1</span></span></span>"</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">Suc</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> harm <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> harm_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> sum.atLeast_Suc_atMost<span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">F</span> <span class="free">n</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">*</span> harm <span class="free">n</span> <span class="main">+</span> <span class="numeral">4</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> harm_Suc <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">*</span> real <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">*</span> real <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> harm <span class="free">n</span> <span class="main">-</span> <span class="numeral">4</span> <span class="main">*</span> real <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">F</span> <span class="free">n</span> <span class="main">*</span> real <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> rqs_cost_exp <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> F_def add_ac<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* TODO Move *)</span>
<span class="keyword1"><span class="command">lemma</span></span> asymp_equiv_harm <span class="main">[</span><span class="operator">asymp_equiv_intros</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"harm <span class="main">∼[</span>at_top<span class="main">]</span> <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> ln <span class="main">(</span>real <span class="bound">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> harm <span class="bound">n</span> <span class="main">-</span> ln <span class="main">(</span>real <span class="bound">n</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1">O(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> euler_mascheroni_LIMSEQ
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> bigoI_tendsto<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> c <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">euler_mascheroni</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">1</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1">o(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> ln <span class="main">(</span>real <span class="bound">n</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> ln <span class="main">(</span>real <span class="bound">n</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span>harm <span class="bound">n</span> <span class="main">-</span> ln <span class="main">(</span>real <span class="bound">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∼[</span>at_top<span class="main">]</span> <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> ln <span class="main">(</span>real <span class="bound">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> asymp_equiv_add_right<span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>
  
<span class="keyword1"><span class="command">corollary</span></span> rqs_cost_exp_asymp_equiv<span class="main">:</span> <span class="quoted"><span class="quoted">"rqs_cost_exp <span class="main">∼[</span>at_top<span class="main">]</span> <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="numeral">2</span> <span class="main">*</span> <span class="bound">n</span> <span class="main">*</span> ln <span class="bound">n</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rqs_cost_exp <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="numeral">2</span> <span class="main">*</span> real <span class="main">(</span><span class="bound">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> harm <span class="bound">n</span> <span class="main">-</span> <span class="numeral">4</span> <span class="main">*</span> real <span class="bound">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> rqs_cost_exp_eq <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="numeral">2</span> <span class="main">*</span> real <span class="bound">n</span> <span class="main">*</span> harm <span class="bound">n</span> <span class="main">+</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> harm <span class="bound">n</span> <span class="main">-</span> <span class="numeral">4</span> <span class="main">*</span> real <span class="bound">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rqs_cost_exp <span class="main">∼[</span>at_top<span class="main">]</span> <span class="main">…</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">∼[</span>at_top<span class="main">]</span> <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="numeral">2</span> <span class="main">*</span> real <span class="bound">n</span> <span class="main">*</span> harm <span class="bound">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">subst</span> asymp_equiv_add_right<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">1</span> <span class="main">*</span> harm <span class="bound">x</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1">o(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> real <span class="bound">x</span> <span class="main">*</span> harm <span class="bound">x</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> landau_o.small_big_mult smallo_real_nat_transfer<span class="main">)</span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"harm <span class="main">∈</span> <span class="keyword1">ω(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">1</span> <span class="main">::</span> real<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> smallomegaI_filterlim_at_top_norm<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> harm_at_top<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> real <span class="bound">x</span> <span class="main">*</span> <span class="main">1</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1">o(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> real <span class="bound">x</span> <span class="main">*</span> harm <span class="bound">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> landau_o.big_small_mult<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> smallomega_iff_smallo<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="numeral">2</span> <span class="main">*</span> harm <span class="bound">n</span> <span class="main">-</span> <span class="numeral">4</span> <span class="main">*</span> real <span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1">o(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="numeral">2</span> <span class="main">*</span> real <span class="bound">n</span> <span class="main">*</span> harm <span class="bound">n</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum_in_smallo<span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">∼[</span>at_top<span class="main">]</span> <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="numeral">2</span> <span class="main">*</span> real <span class="bound">n</span> <span class="main">*</span> ln <span class="main">(</span>real <span class="bound">n</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> <span class="dynamic"><span class="dynamic">asymp_equiv_intros</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> harm_mono<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">≤</span> <span class="free">n</span> <span class="main">⟹</span> harm <span class="free">m</span> <span class="main">≤</span> <span class="main">(</span>harm <span class="free">n</span> <span class="main">::</span> real<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> harm_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum_mono2<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> harm_Suc_0 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"harm <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> harm_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> harm_ge_1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟹</span> harm <span class="free">n</span> <span class="main">≥</span> <span class="main">(</span><span class="main">1</span><span class="main">::</span>real<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> harm_mono<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">1</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> mono_rqs_cost_exp<span class="main">:</span> <span class="quoted"><span class="quoted">"mono rqs_cost_exp"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> incseq_SucI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"rqs_cost_exp <span class="skolem">n</span> <span class="main">≤</span> rqs_cost_exp <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="main">(</span><span class="main">1</span> <span class="main">*</span> <span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span>real <span class="skolem">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">-</span> <span class="numeral">2</span> <span class="main">*</span> real <span class="skolem">n</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span>real <span class="skolem">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">(</span>harm <span class="skolem">n</span> <span class="main">*</span> <span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span>real <span class="skolem">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">-</span> <span class="numeral">2</span> <span class="main">*</span> real <span class="skolem">n</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span>real <span class="skolem">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> False
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> divide_right_mono diff_right_mono mult_right_mono<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> harm_ge_1<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> rqs_cost_exp <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">-</span> rqs_cost_exp <span class="skolem">n</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rqs_cost_exp_eq harm_Suc <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> rqs_cost_exp_leI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">≤</span> <span class="free">n</span> <span class="main">⟹</span> rqs_cost_exp <span class="free">m</span> <span class="main">≤</span> rqs_cost_exp <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> mono_rqs_cost_exp <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mono_def<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Version for lists with repeated elements›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">threeway_partition</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">threeway_partition</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> 
     <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="bound">y</span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span><span class="bound">y</span><span class="main">)</span> <span class="main">∉</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span> 
      filter <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span><span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="bound">y</span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span> 
      filter <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span><span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="bound">y</span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">∉</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The following version of randomised Quicksort uses a three-way partitioning function
  in order to also achieve expected logarithmic running time on lists with repeated elements.
›</span></span>
<span class="keyword1"><span class="command">function</span></span> <span class="entity">rquicksort'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'a</span><span class="main">)</span> set <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> list <span class="main">×</span> nat<span class="main">)</span> pmf"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">rquicksort'</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> 
     <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> <span class="main">[]</span> <span class="keyword1">then</span> 
        return_pmf <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span>
      <span class="keyword1">else</span>
        <span class="keyword1">do</span> <span class="main">{</span>
          <span class="bound">i</span> <span class="main">←</span> pmf_of_set <span class="main">{..&lt;</span>length <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">}</span><span class="main">;</span>
          <span class="keyword1">let</span> <span class="bound">x</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">!</span> <span class="bound">i</span><span class="main">;</span>
          <span class="keyword1">case</span> threeway_partition <span class="bound">x</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">(</span>delete_index <span class="bound">i</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="keyword1">of</span>
            <span class="main">(</span><span class="bound">ls</span><span class="main">,</span> <span class="bound">es</span><span class="main">,</span> <span class="bound">rs</span><span class="main">)</span> <span class="main">⇒</span> <span class="keyword1">do</span> <span class="main">{</span>
              <span class="main">(</span><span class="bound">ls</span><span class="main">,</span> <span class="bound">n1</span><span class="main">)</span> <span class="main">←</span> <span class="free">rquicksort'</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="bound">ls</span><span class="main">;</span>
              <span class="main">(</span><span class="bound">rs</span><span class="main">,</span> <span class="bound">n2</span><span class="main">)</span> <span class="main">←</span> <span class="free">rquicksort'</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="bound">rs</span><span class="main">;</span>
              return_pmf <span class="main">(</span><span class="bound">ls</span> <span class="main">@</span> <span class="bound">x</span> <span class="main">#</span> <span class="bound">es</span> <span class="main">@</span> <span class="bound">rs</span><span class="main">,</span> length <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">-</span> <span class="main">1</span> <span class="main">+</span> <span class="bound">n1</span> <span class="main">+</span> <span class="bound">n2</span><span class="main">)</span>
            <span class="main">}</span>
        <span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">termination</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">relation</span> <span class="quoted"><span class="quoted">"Wellfounded.measure <span class="main">(</span>length <span class="main">∘</span> snd<span class="main">)</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wf <span class="main">(</span>Wellfounded.measure <span class="main">(</span>length <span class="main">∘</span> snd<span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> set_pmf_of_set<span class="main"><span class="keyword3">;</span></span>
     <span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> le_less_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> length_filter_le<span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> threeway_partition_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">declare</span></span> rquicksort'.simps <span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> rquicksort'_Nil <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"rquicksort' <span class="free">R</span> <span class="main">[]</span> <span class="main">=</span> return_pmf <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rquicksort'.simps<span class="main">)</span>

<span class="keyword1"><span class="command">context</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>
  
<span class="keyword2"><span class="keyword">qualified</span></span> <span class="keyword1"><span class="command">definition</span></span> <span class="entity">lesss</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'a</span><span class="main">)</span> set <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">lesss</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> filter <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="bound">y</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∉</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span>"</span></span>

<span class="keyword2"><span class="keyword">qualified</span></span> <span class="keyword1"><span class="command">definition</span></span> <span class="entity">greaters</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'a</span><span class="main">)</span> set <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">greaters</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> filter <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="bound">y</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">∉</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span>"</span></span>

<span class="keyword2"><span class="keyword">qualified</span></span> <span class="keyword1"><span class="command">lemma</span></span> lesss_Cons<span class="main">:</span>
  <span class="quoted"><span class="quoted">"lesss <span class="free">R</span> <span class="free">x</span> <span class="main">(</span><span class="free">y</span> <span class="main">#</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> 
     <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span><span class="free">y</span><span class="main">,</span> <span class="free">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="main">∧</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">∉</span> <span class="free">R</span> <span class="keyword1">then</span> <span class="free">y</span> <span class="main">#</span> lesss <span class="free">R</span> <span class="free">x</span> <span class="free">ys</span> <span class="keyword1">else</span> lesss <span class="free">R</span> <span class="free">x</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lesss_def<span class="main">)</span>

<span class="keyword2"><span class="keyword">qualified</span></span> <span class="keyword1"><span class="command">lemma</span></span> length_lesss_le <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>lesss <span class="free">R</span> <span class="free">x</span> <span class="free">xs</span><span class="main">)</span> <span class="main">≤</span> length <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lesss_def<span class="main">)</span>

<span class="keyword2"><span class="keyword">qualified</span></span> <span class="keyword1"><span class="command">lemma</span></span> length_lesss_less <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> set <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"length <span class="main">(</span>lesss <span class="free">R</span> <span class="free">x</span> <span class="free">xs</span><span class="main">)</span> <span class="main">&lt;</span> length <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lesss_Cons <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> le_less_trans<span class="main">)</span>

<span class="keyword2"><span class="keyword">qualified</span></span> <span class="keyword1"><span class="command">lemma</span></span> greaters_Cons<span class="main">:</span>
  <span class="quoted"><span class="quoted">"greaters <span class="free">R</span> <span class="free">x</span> <span class="main">(</span><span class="free">y</span> <span class="main">#</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> 
     <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="main">∧</span> <span class="main">(</span><span class="free">y</span><span class="main">,</span> <span class="free">x</span><span class="main">)</span> <span class="main">∉</span> <span class="free">R</span> <span class="keyword1">then</span> <span class="free">y</span> <span class="main">#</span> greaters <span class="free">R</span> <span class="free">x</span> <span class="free">ys</span> <span class="keyword1">else</span> greaters <span class="free">R</span> <span class="free">x</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> greaters_def<span class="main">)</span>

<span class="keyword2"><span class="keyword">qualified</span></span> <span class="keyword1"><span class="command">lemma</span></span> length_greaters_le <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>greaters <span class="free">R</span> <span class="free">x</span> <span class="free">xs</span><span class="main">)</span> <span class="main">≤</span> length <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> greaters_def<span class="main">)</span>

<span class="keyword2"><span class="keyword">qualified</span></span> <span class="keyword1"><span class="command">lemma</span></span> length_greaters_less <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> set <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"length <span class="main">(</span>greaters <span class="free">R</span> <span class="free">x</span> <span class="free">xs</span><span class="main">)</span> <span class="main">&lt;</span> length <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> greaters_Cons <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> le_less_trans<span class="main">)</span>
  

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The following function counts the comparisons made by the modified randomised Quicksort.
›</span></span>
<span class="keyword1"><span class="command">function</span></span> <span class="entity">rqs'_cost</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'a</span><span class="main">)</span> set <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> nat pmf"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">rqs'_cost</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> 
     <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> <span class="main">[]</span> <span class="keyword1">then</span> 
        return_pmf <span class="main">0</span>
      <span class="keyword1">else</span>
        <span class="keyword1">do</span> <span class="main">{</span>
          <span class="bound">i</span> <span class="main">←</span> pmf_of_set <span class="main">{..&lt;</span>length <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">}</span><span class="main">;</span>
          <span class="keyword1">let</span> <span class="bound">x</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">!</span> <span class="bound">i</span><span class="main">;</span>
          map_pmf <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">n1</span><span class="main">,</span><span class="bound">n2</span><span class="main">)</span><span class="main">.</span> length <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">-</span> <span class="main">1</span> <span class="main">+</span> <span class="bound">n1</span> <span class="main">+</span> <span class="bound">n2</span><span class="main">)</span> 
            <span class="main">(</span>pair_pmf <span class="main">(</span><span class="free">rqs'_cost</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">(</span>lesss <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="bound">x</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">rqs'_cost</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">(</span>greaters <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="bound">x</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
        <span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">termination</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">relation</span> <span class="quoted"><span class="quoted">"Wellfounded.measure <span class="main">(</span>length <span class="main">∘</span> snd<span class="main">)</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">declare</span></span> rqs'_cost.simps <span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> rqs'_cost_nonempty<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span> rqs'_cost <span class="free">R</span> <span class="free">xs</span> <span class="main">=</span> 
     <span class="keyword1">do</span> <span class="main">{</span>
       <span class="bound">i</span> <span class="main">←</span> pmf_of_set <span class="main">{..&lt;</span>length <span class="free">xs</span><span class="main">}</span><span class="main">;</span>
       <span class="keyword1">let</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">xs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">;</span>
       <span class="bound">n1</span> <span class="main">←</span> rqs'_cost <span class="free">R</span> <span class="main">(</span>lesss <span class="free">R</span> <span class="bound">x</span> <span class="free">xs</span><span class="main">)</span><span class="main">;</span>
       <span class="bound">n2</span> <span class="main">←</span> rqs'_cost <span class="free">R</span> <span class="main">(</span>greaters <span class="free">R</span> <span class="bound">x</span> <span class="free">xs</span><span class="main">)</span><span class="main">;</span>
       return_pmf <span class="main">(</span>length <span class="free">xs</span> <span class="main">-</span> <span class="main">1</span> <span class="main">+</span> <span class="bound">n1</span> <span class="main">+</span> <span class="bound">n2</span><span class="main">)</span>
     <span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> rqs'_cost.simps<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pair_pmf_def Let_def map_bind_pmf<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> finite_set_pmf_rqs'_cost <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"finite <span class="main">(</span>set_pmf <span class="main">(</span>rqs'_cost <span class="free">R</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">R</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rqs'_cost.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rqs'_cost.simps Let_def<span class="main">)</span>

<span class="comment1">(* TODO: Move? *)</span>
<span class="keyword1"><span class="command">lemma</span></span> expectation_pair_pmf_fst <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span><span class="main">{</span>banach<span class="main">,</span> second_countable_topology<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"measure_pmf.expectation <span class="main">(</span>pair_pmf <span class="free">p</span> <span class="free">q</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span>fst <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> measure_pmf.expectation <span class="free">p</span> <span class="free">f</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"measure_pmf.expectation <span class="main">(</span>pair_pmf <span class="free">p</span> <span class="free">q</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span>fst <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
          measure_pmf.expectation <span class="main">(</span>map_pmf fst <span class="main">(</span>pair_pmf <span class="free">p</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span> <span class="free">f</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map_pmf fst <span class="main">(</span>pair_pmf <span class="free">p</span> <span class="free">q</span><span class="main">)</span> <span class="main">=</span> <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_fst_pair_pmf<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> expectation_pair_pmf_snd <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span><span class="main">{</span>banach<span class="main">,</span> second_countable_topology<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"measure_pmf.expectation <span class="main">(</span>pair_pmf <span class="free">p</span> <span class="free">q</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span>snd <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> measure_pmf.expectation <span class="free">q</span> <span class="free">f</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"measure_pmf.expectation <span class="main">(</span>pair_pmf <span class="free">p</span> <span class="free">q</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span>snd <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
          measure_pmf.expectation <span class="main">(</span>map_pmf snd <span class="main">(</span>pair_pmf <span class="free">p</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span> <span class="free">f</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map_pmf snd <span class="main">(</span>pair_pmf <span class="free">p</span> <span class="free">q</span><span class="main">)</span> <span class="main">=</span> <span class="free">q</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_snd_pair_pmf<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">qualified</span></span> <span class="keyword1"><span class="command">lemma</span></span> length_lesss_le_sorted<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"sorted_wrt <span class="free">R</span> <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"length <span class="main">(</span>lesss <span class="free">R</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span> <span class="main">≤</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> sorted_wrt.induct<span class="main">)</span>
                 <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lesss_def nth_Cons le_Suc_eq <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.splits<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword2"><span class="keyword">qualified</span></span> <span class="keyword1"><span class="command">lemma</span></span> length_greaters_le_sorted<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"sorted_wrt <span class="free">R</span> <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"length <span class="main">(</span>greaters <span class="free">R</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span> <span class="main">≤</span> length <span class="free">xs</span> <span class="main">-</span> <span class="free">i</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> sorted_wrt.induct<span class="main">)</span>
     <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> greaters_def nth_Cons le_Suc_eq <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.splits<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword2"><span class="keyword">qualified</span></span> <span class="keyword1"><span class="command">lemma</span></span> length_lesss_le'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"linorder_on <span class="free">A</span> <span class="free">R</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="free">xs</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"length <span class="main">(</span>lesss <span class="free">R</span> <span class="main">(</span>insort_wrt <span class="free">R</span> <span class="free">xs</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span> <span class="main">≤</span> <span class="free">i</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> insort_wrt <span class="free">R</span> <span class="free">xs</span> <span class="main">!</span> <span class="free">i</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">less</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">less</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">y</span><span class="main">,</span><span class="bound">x</span><span class="main">)</span> <span class="main">∉</span> <span class="free">R</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>lesss <span class="free">R</span> <span class="skolem">x</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> size <span class="main">{#</span> <span class="bound">y</span> <span class="main">∈#</span> mset <span class="free">xs</span><span class="main">.</span> <span class="skolem">less</span> <span class="bound">y</span> <span class="skolem">x</span> <span class="main">#}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lesss_def size_mset <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> less_def mset_filter <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> size_mset<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mset <span class="free">xs</span> <span class="main">=</span> mset <span class="main">(</span>insort_wrt <span class="free">R</span> <span class="free">xs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"size <span class="main">{#</span><span class="bound">y</span> <span class="main">∈#</span> mset <span class="main">(</span>insort_wrt <span class="free">R</span> <span class="free">xs</span><span class="main">)</span><span class="main">.</span> <span class="skolem">less</span> <span class="bound">y</span> <span class="skolem">x</span><span class="main">#}</span> <span class="main">=</span>
               length <span class="main">(</span>lesss <span class="free">R</span> <span class="skolem">x</span> <span class="main">(</span>insort_wrt <span class="free">R</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> mset_filter <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> size_mset lesss_def less_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> x_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> length_lesss_le_sorted<span class="main">)</span> <span class="main">(</span><span class="operator">use</span> assms <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> x_def <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">qualified</span></span> <span class="keyword1"><span class="command">lemma</span></span> length_greaters_le'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"linorder_on <span class="free">A</span> <span class="free">R</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="free">xs</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"length <span class="main">(</span>greaters <span class="free">R</span> <span class="main">(</span>insort_wrt <span class="free">R</span> <span class="free">xs</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span> <span class="main">≤</span> length <span class="free">xs</span> <span class="main">-</span> <span class="free">i</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> insort_wrt <span class="free">R</span> <span class="free">xs</span> <span class="main">!</span> <span class="free">i</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">less</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">less</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">y</span><span class="main">,</span><span class="bound">x</span><span class="main">)</span> <span class="main">∉</span> <span class="free">R</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>greaters <span class="free">R</span> <span class="skolem">x</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> size <span class="main">{#</span> <span class="bound">y</span> <span class="main">∈#</span> mset <span class="free">xs</span><span class="main">.</span> <span class="skolem">less</span> <span class="skolem">x</span> <span class="bound">y</span> <span class="main">#}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> greaters_def size_mset <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> less_def mset_filter <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> size_mset<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mset <span class="free">xs</span> <span class="main">=</span> mset <span class="main">(</span>insort_wrt <span class="free">R</span> <span class="free">xs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"size <span class="main">{#</span><span class="bound">y</span> <span class="main">∈#</span> mset <span class="main">(</span>insort_wrt <span class="free">R</span> <span class="free">xs</span><span class="main">)</span><span class="main">.</span> <span class="skolem">less</span> <span class="skolem">x</span> <span class="bound">y</span><span class="main">#}</span> <span class="main">=</span>
               length <span class="main">(</span>greaters <span class="free">R</span> <span class="skolem">x</span> <span class="main">(</span>insort_wrt <span class="free">R</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> mset_filter <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> size_mset greaters_def less_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> length <span class="main">(</span>insort_wrt <span class="free">R</span> <span class="free">xs</span><span class="main">)</span> <span class="main">-</span> <span class="free">i</span> <span class="main">-</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> x_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> length_greaters_le_sorted<span class="main">)</span> <span class="main">(</span><span class="operator">use</span> assms <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> x_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We can show quite easily that the expected number of comparisons in this modified
  QuickSort is bounded above by the expected number of comparisons on a list of the same length
  with no repeated elements.
›</span></span>
<span class="keyword1"><span class="command">theorem</span></span> rqs'_cost_expectation_le<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"linorder_on <span class="free">A</span> <span class="free">R</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="free">xs</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"measure_pmf.expectation <span class="main">(</span>rqs'_cost <span class="free">R</span> <span class="free">xs</span><span class="main">)</span> real <span class="main">≤</span> rqs_cost_exp <span class="main">(</span>length <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">R</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rqs'_cost.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">R</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">=</span> <span class="main">[]</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> length <span class="skolem">xs</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> length_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">xs</span> <span class="main">=</span> Suc <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> n_def<span class="main">)</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">E</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">E</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">xs</span><span class="main">.</span> measure_pmf.expectation <span class="main">(</span>rqs'_cost <span class="skolem">R</span> <span class="bound">xs</span><span class="main">)</span> real<span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> rqs_cost_exp <span class="main">(</span>length <span class="main">(</span>lesss <span class="skolem">R</span> <span class="bound">x</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span>
                                rqs_cost_exp <span class="main">(</span>length <span class="main">(</span>greaters <span class="skolem">R</span> <span class="bound">x</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rqs'_cost <span class="skolem">R</span> <span class="skolem">xs</span> <span class="main">=</span>
            <span class="keyword1">do</span> <span class="main">{</span>
              <span class="bound">i</span> <span class="main">←</span> pmf_of_set <span class="main">{..&lt;</span>length <span class="skolem">xs</span><span class="main">}</span><span class="main">;</span>
              map_pmf <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">n1</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> length <span class="skolem">xs</span> <span class="main">-</span> Suc <span class="main">0</span> <span class="main">+</span> <span class="bound">n1</span> <span class="main">+</span> <span class="bound">y</span><span class="main">)</span>
                <span class="main">(</span>pair_pmf <span class="main">(</span>rqs'_cost <span class="skolem">R</span> <span class="main">(</span>lesss <span class="skolem">R</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span>
                          <span class="main">(</span>rqs'_cost <span class="skolem">R</span> <span class="main">(</span>greaters <span class="skolem">R</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
            <span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> rqs'_cost.simps<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"measure_pmf.expectation <span class="main">…</span> real <span class="main">=</span> real <span class="skolem">n</span> <span class="main">+</span>
           <span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">&lt;</span>length <span class="skolem">xs</span><span class="main">.</span> <span class="skolem">E</span> <span class="main">(</span>lesss <span class="skolem">R</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">E</span> <span class="main">(</span>greaters <span class="skolem">R</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> real <span class="main">(</span>length <span class="skolem">xs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> False
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> pmf_expectation_bind_pmf_of_set<span class="main">)</span>
         <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> finite_imageI finite_cartesian_product <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> case_prod_unfold
            integrable_measure_pmf_finite sum_divide_distrib <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span>
            length_eq sum.distrib E_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> real <span class="skolem">n</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">&lt;</span>length <span class="skolem">xs</span><span class="main">.</span> <span class="skolem">f</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> real <span class="main">(</span>length <span class="skolem">xs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> E_def f_def <span class="keyword1"><span class="command">using</span></span> False <span class="quoted">"1.prems"</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> add_mono order.refl divide_right_mono sum_mono <span class="quoted">"1.IH"</span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ _ refl<span class="main"><span class="main">]</span></span> False<span class="main">)</span>
         <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lesss_def greaters_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">&lt;</span>length <span class="skolem">xs</span><span class="main">.</span> <span class="skolem">f</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈#</span>mset <span class="skolem">xs</span><span class="main">.</span> <span class="skolem">f</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> mset_map <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> sum_mset_sum_list sum_list_sum_nth<span class="main">)</span>
         <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> atLeast0LessThan<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mset <span class="skolem">xs</span> <span class="main">=</span> mset <span class="main">(</span>insort_wrt <span class="skolem">R</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈#</span><span class="main">…</span><span class="main">.</span> <span class="skolem">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span>length <span class="skolem">xs</span><span class="main">.</span> <span class="skolem">f</span> <span class="main">(</span>insort_wrt <span class="skolem">R</span> <span class="skolem">xs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> mset_map <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> sum_mset_sum_list sum_list_sum_nth<span class="main">)</span>
         <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> atLeast0LessThan<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span>length <span class="skolem">xs</span><span class="main">.</span> rqs_cost_exp <span class="bound">i</span> <span class="main">+</span> rqs_cost_exp <span class="main">(</span>length <span class="skolem">xs</span> <span class="main">-</span> <span class="bound">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> f_def
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> sum_mono add_mono rqs_cost_exp_leI<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="keyword3"><span class="command">assume</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="main">{..&lt;</span>length <span class="skolem">xs</span><span class="main">}</span>"</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>lesss <span class="skolem">R</span> <span class="main">(</span>insort_wrt <span class="skolem">R</span> <span class="skolem">xs</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">i</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> i <span class="quoted">"1.prems"</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> length_lesss_le'<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> A <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">A</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>greaters <span class="skolem">R</span> <span class="main">(</span>insort_wrt <span class="skolem">R</span> <span class="skolem">xs</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">≤</span> length <span class="skolem">xs</span> <span class="main">-</span> <span class="skolem">i</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> i <span class="quoted">"1.prems"</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> length_greaters_le'<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> A <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">A</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">≤</span><span class="skolem">n</span><span class="main">.</span> rqs_cost_exp <span class="bound">i</span> <span class="main">+</span> rqs_cost_exp <span class="main">(</span><span class="skolem">n</span> <span class="main">-</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum.cong<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> length_eq<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"real <span class="skolem">n</span> <span class="main">+</span> <span class="main">…</span> <span class="main">/</span> real <span class="main">(</span>length <span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> rqs_cost_exp <span class="main">(</span>length <span class="skolem">xs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> length_eq rqs_cost_exp.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> divide_right_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rqs'_cost.simps<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Quick_Sort_Average_Case">
<div class="head">
<h1>Theory Quick_Sort_Average_Case</h1>
</div>
<pre class="source"><span class="comment1">(*
  File:     Quick_Sort_Average_Case.thy
  Author:   Manuel Eberl &lt;eberlm@in.tum.de&gt;

  Definition and average-case analysis of the standard deterministic QuickSort algorithm
*)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Average case analysis of deterministic QuickSort›</span></span>
<span class="keyword1"><span class="command">theory</span></span> Quick_Sort_Average_Case
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="Randomised_Quick_Sort.html">Randomised_Quick_Sort</a>
<span class="keyword2"><span class="keyword">begin</span></span>
  
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Definition of deterministic QuickSort›</span></span>
  
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  This is the functional description of the standard variant of deterministic QuickSort that 
  always chooses the first list element as the pivot as given by Hoare in 1962~\cite{hoare}. 
  For a list that is already sorted, this leads to $n(n-1)$ 
  comparisons, but as is well known, the average case is not that bad.
›</span></span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">quicksort</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'a</span><span class="main">)</span> set <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">quicksort</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">quicksort</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span> 
     <span class="free">quicksort</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="bound">y</span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">]</span> <span class="main">@</span> <span class="free">quicksort</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="bound">y</span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">∉</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We can easily show that this QuickSort is correct:
›</span></span>
<span class="keyword1"><span class="command">theorem</span></span> mset_quicksort <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"mset <span class="main">(</span>quicksort <span class="free">R</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> mset <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">R</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> quicksort.induct<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span><span class="main">)</span>

<span class="keyword1"><span class="command">corollary</span></span> set_quicksort <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>quicksort <span class="free">R</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> set <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">R</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> quicksort.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">theorem</span></span> sorted_wrt_quicksort<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"trans <span class="free">R</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"total_on <span class="main">(</span>set <span class="free">xs</span><span class="main">)</span> <span class="free">R</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="main">⟹</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"sorted_wrt <span class="free">R</span> <span class="main">(</span>quicksort <span class="free">R</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">R</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> quicksort.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">R</span> <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> total<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">R</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">b</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">∉</span> <span class="skolem">R</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> set <span class="main">(</span><span class="skolem">x</span><span class="main">#</span><span class="skolem">xs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">∈</span> set <span class="main">(</span><span class="skolem">x</span><span class="main">#</span><span class="skolem">xs</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">a</span> <span class="skolem">b</span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"2.prems"</span> that <span class="keyword1"><span class="command">unfolding</span></span> total_on_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> <span class="skolem">b</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>
    
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"sorted_wrt <span class="skolem">R</span> <span class="main">(</span>quicksort <span class="skolem">R</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="bound">y</span><span class="main">,</span><span class="skolem">x</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">R</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="quoted"><span class="quoted">"sorted_wrt <span class="skolem">R</span> <span class="main">(</span>quicksort <span class="skolem">R</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="bound">y</span><span class="main">,</span><span class="skolem">x</span><span class="main">)</span> <span class="main">∉</span> <span class="skolem">R</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="main">(</span><span class="operator">rule</span> 2 total_on_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹total_on <span class="main">(</span>set <span class="main">(</span><span class="skolem">x</span><span class="main">#</span><span class="skolem">xs</span><span class="main">)</span><span class="main">)</span> <span class="skolem">R</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main"><span class="keyword3">|</span></span> <span class="operator">force</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sorted_wrt_append sorted_wrt.intros <span class="quoted"><span class="quoted">‹trans <span class="skolem">R</span>›</span></span> * 
             <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> transD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹trans <span class="skolem">R</span>›</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> total <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> total_on_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">corollary</span></span> sorted_wrt_quicksort'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"linorder_on <span class="free">A</span> <span class="free">R</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"set <span class="free">xs</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"sorted_wrt <span class="free">R</span> <span class="main">(</span>quicksort <span class="free">R</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sorted_wrt_quicksort<span class="main">)</span>
     <span class="main">(</span><span class="operator">insert</span> assms<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> linorder_on_def refl_on_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> total_on_subset<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We now define another version of QuickSort that is identical to the previous one but also 
  counts the number of comparisons that were made.
›</span></span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">quicksort'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'a</span><span class="main">)</span> set <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">×</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">quicksort'</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">quicksort'</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
     <span class="keyword1">let</span> <span class="main">(</span><span class="bound">ls</span><span class="main">,</span> <span class="bound">rs</span><span class="main">)</span>  <span class="main">=</span> partition <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="bound">y</span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">;</span>
         <span class="main">(</span><span class="bound">ls'</span><span class="main">,</span> <span class="bound">n1</span><span class="main">)</span> <span class="main">=</span> <span class="free">quicksort'</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="bound">ls</span><span class="main">;</span>
         <span class="main">(</span><span class="bound">rs'</span><span class="main">,</span> <span class="bound">n2</span><span class="main">)</span> <span class="main">=</span> <span class="free">quicksort'</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="bound">rs</span>
     <span class="keyword1">in</span>
         <span class="main">(</span><span class="bound">ls'</span> <span class="main">@</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">]</span> <span class="main">@</span> <span class="bound">rs'</span><span class="main">,</span> length <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">+</span> <span class="bound">n1</span> <span class="main">+</span> <span class="bound">n2</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  For convenience, we also define a function that computes only the number of comparisons that 
  were made and not the result list.
›</span></span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">qs_cost</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'a</span><span class="main">)</span> set <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">qs_cost</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">qs_cost</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span> 
     length <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">+</span> <span class="free">qs_cost</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="bound">y</span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">+</span> <span class="free">qs_cost</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="bound">y</span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">∉</span><span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  It is obvious that the original QuickSort and the cost function are the projections 
  of the cost-counting QuickSort.
›</span></span>  
<span class="keyword1"><span class="command">lemma</span></span> fst_quicksort' <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>quicksort' <span class="free">R</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> quicksort <span class="free">R</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">R</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> quicksort.induct<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> case_prod_unfold Let_def o_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> snd_quicksort' <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>quicksort' <span class="free">R</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> qs_cost <span class="free">R</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">R</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> quicksort.induct<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> case_prod_unfold Let_def o_def<span class="main">)</span>

    
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Analysis›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We will reduce the average-case analysis to showing that it is essentially equivalent to 
  the randomised QuickSort we analysed earlier. Similar, but more direct analyses are given 
  by Hoare~\cite{hoare} and Sedgewick~\cite{sedgewick}. 

  The proof is relatively straightforward -- but still a bit messy. We show that the cost 
  distribution of QuickSort run on a random permutation of a set of size $n$ is exactly the same 
  as that of randomised QuickSort being run on any fixed list of size $n$ (which we analysed 
  before):  
›</span></span>
<span class="keyword1"><span class="command">theorem</span></span> qs_cost_average_conv_rqs_cost<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"linorder_on <span class="free">B</span> <span class="free">R</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">⊆</span> <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"map_pmf <span class="main">(</span>qs_cost <span class="free">R</span><span class="main">)</span> <span class="main">(</span>pmf_of_set <span class="main">(</span>permutations_of_set <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> rqs_cost <span class="main">(</span>card <span class="free">A</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">,</span>3<span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">A</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> finite_psubset_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>psubset <span class="skolem">A</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">=</span> <span class="main">{}</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pmf_of_set_singleton<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">note</span></span> A <span class="main">=</span> <span class="quoted"><span class="quoted">‹finite <span class="skolem">A</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">A</span> <span class="main">≠</span> <span class="main">{}</span>›</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> card <span class="skolem">A</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> A <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pmf_of_set <span class="main">(</span>permutations_of_set <span class="skolem">A</span><span class="main">)</span> <span class="main">=</span> 
      <span class="keyword1">do</span> <span class="main">{</span><span class="bound">x</span> <span class="main">←</span> pmf_of_set <span class="skolem">A</span><span class="main">;</span> <span class="bound">xs</span> <span class="main">←</span> pmf_of_set <span class="main">(</span>permutations_of_set <span class="main">(</span><span class="skolem">A</span> <span class="main">-</span> <span class="main">{</span><span class="bound">x</span><span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="main">;</span> return_pmf <span class="main">(</span><span class="bound">x</span><span class="main">#</span><span class="bound">xs</span><span class="main">)</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> random_permutation_of_set<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map_pmf <span class="main">(</span>qs_cost <span class="free">R</span><span class="main">)</span> <span class="main">…</span> <span class="main">=</span>
                 <span class="keyword1">do</span> <span class="main">{</span>
                   <span class="bound">x</span> <span class="main">←</span> pmf_of_set <span class="skolem">A</span><span class="main">;</span>
                   <span class="bound">xs</span> <span class="main">←</span> pmf_of_set <span class="main">(</span>permutations_of_set <span class="main">(</span><span class="skolem">A</span> <span class="main">-</span> <span class="main">{</span><span class="bound">x</span><span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
                   return_pmf <span class="main">(</span>length <span class="bound">xs</span> <span class="main">+</span> qs_cost <span class="free">R</span> <span class="main">[</span><span class="bound">y</span><span class="main">←</span><span class="bound">xs</span><span class="main">.</span> <span class="main">(</span><span class="bound">y</span><span class="main">,</span><span class="bound">x</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span><span class="main">]</span> <span class="main">+</span> qs_cost <span class="free">R</span> <span class="main">[</span><span class="bound">y</span><span class="main">←</span><span class="bound">xs</span><span class="main">.</span> <span class="main">(</span><span class="bound">y</span><span class="main">,</span><span class="bound">x</span><span class="main">)</span><span class="main">∉</span><span class="free">R</span><span class="main">]</span><span class="main">)</span>
                 <span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_bind_pmf<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> map_pmf <span class="main">(</span><span class="main">λ</span><span class="bound">m</span><span class="main">.</span> <span class="skolem">n</span> <span class="main">+</span> <span class="bound">m</span><span class="main">)</span> <span class="main">(</span>
          <span class="keyword1">do</span> <span class="main">{</span>
            <span class="bound">x</span> <span class="main">←</span> pmf_of_set <span class="skolem">A</span><span class="main">;</span>
            <span class="bound">xs</span> <span class="main">←</span> pmf_of_set <span class="main">(</span>permutations_of_set <span class="main">(</span><span class="skolem">A</span> <span class="main">-</span> <span class="main">{</span><span class="bound">x</span><span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
            return_pmf <span class="main">(</span>qs_cost <span class="free">R</span> <span class="main">[</span><span class="bound">y</span><span class="main">←</span><span class="bound">xs</span><span class="main">.</span> <span class="main">(</span><span class="bound">y</span><span class="main">,</span><span class="bound">x</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span><span class="main">]</span> <span class="main">+</span> qs_cost <span class="free">R</span> <span class="main">[</span><span class="bound">y</span><span class="main">←</span><span class="bound">xs</span><span class="main">.</span> <span class="main">(</span><span class="bound">y</span><span class="main">,</span><span class="bound">x</span><span class="main">)</span><span class="main">∉</span><span class="free">R</span><span class="main">]</span><span class="main">)</span>
          <span class="main">}</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> map_pmf <span class="main">_</span> <span class="var">?X</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">unfolding</span></span> n_def map_bind_pmf
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> bind_pmf_cong map_pmf_cong refl<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> length_finite_permutations_of_set<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?X</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
                      <span class="bound">x</span> <span class="main">←</span> pmf_of_set <span class="skolem">A</span><span class="main">;</span>
                      <span class="main">(</span><span class="bound">ls</span><span class="main">,</span><span class="bound">rs</span><span class="main">)</span> <span class="main">←</span> map_pmf <span class="main">(</span>partition <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="bound">y</span><span class="main">,</span><span class="bound">x</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span><span class="main">)</span><span class="main">)</span> 
                                   <span class="main">(</span>pmf_of_set <span class="main">(</span>permutations_of_set <span class="main">(</span><span class="skolem">A</span> <span class="main">-</span> <span class="main">{</span><span class="bound">x</span><span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
                      return_pmf <span class="main">(</span>qs_cost <span class="free">R</span> <span class="bound">ls</span> <span class="main">+</span> qs_cost <span class="free">R</span> <span class="bound">rs</span><span class="main">)</span>
                    <span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_map_pmf o_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
                      <span class="bound">x</span> <span class="main">←</span> pmf_of_set <span class="skolem">A</span><span class="main">;</span>
                      <span class="main">(</span><span class="bound">n1</span><span class="main">,</span> <span class="bound">n2</span><span class="main">)</span> <span class="main">←</span> pair_pmf 
                        <span class="main">(</span>rqs_cost <span class="main">(</span>linorder_rank <span class="free">R</span> <span class="skolem">A</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>rqs_cost <span class="main">(</span><span class="skolem">n</span> <span class="main">-</span> linorder_rank <span class="free">R</span> <span class="skolem">A</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
                      return_pmf <span class="main">(</span><span class="bound">n1</span> <span class="main">+</span> <span class="bound">n2</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> bind_pmf_cong refl<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">x</span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map_pmf <span class="main">(</span>partition <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="bound">y</span><span class="main">,</span><span class="skolem">x</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>pmf_of_set <span class="main">(</span>permutations_of_set <span class="main">(</span><span class="skolem">A</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
              <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">ls</span><span class="main">,</span> <span class="bound">rs</span><span class="main">)</span><span class="main">.</span> return_pmf <span class="main">(</span>qs_cost <span class="free">R</span> <span class="bound">ls</span> <span class="main">+</span> qs_cost <span class="free">R</span> <span class="bound">rs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
            map_pmf <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">n1</span><span class="main">,</span> <span class="bound">n2</span><span class="main">)</span><span class="main">.</span> <span class="bound">n1</span> <span class="main">+</span> <span class="bound">n2</span><span class="main">)</span> <span class="main">(</span>pair_pmf
              <span class="main">(</span>map_pmf <span class="main">(</span>qs_cost <span class="free">R</span><span class="main">)</span> <span class="main">(</span>pmf_of_set <span class="main">(</span>permutations_of_set <span class="main">{</span><span class="bound"><span class="bound">xa</span></span> <span class="main">∈</span> <span class="skolem">A</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span><span class="main">.</span> <span class="main">(</span><span class="bound">xa</span><span class="main">,</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span><span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
              <span class="main">(</span>map_pmf <span class="main">(</span>qs_cost <span class="free">R</span><span class="main">)</span> <span class="main">(</span>pmf_of_set <span class="main">(</span>permutations_of_set <span class="main">{</span><span class="bound"><span class="bound">xa</span></span> <span class="main">∈</span> <span class="skolem">A</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span><span class="main">.</span> <span class="main">(</span><span class="bound">xa</span><span class="main">,</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∉</span> <span class="free">R</span><span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> map_pmf <span class="main">_</span> <span class="main">(</span>pair_pmf <span class="var">?X</span> <span class="var">?Y</span><span class="main">)</span>"</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> partition_random_permutations<span class="main">)</span>
           <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_pmf_def case_prod_unfold bind_return_pmf bind_assoc_pmf pair_pmf_def A<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">xa</span></span> <span class="main">∈</span> <span class="skolem">A</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span><span class="main">.</span> <span class="main">(</span><span class="bound">xa</span><span class="main">,</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span><span class="main">}</span> <span class="main">⊆</span> <span class="skolem">A</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⊂</span> <span class="skolem">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 A <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> subset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">xa</span></span> <span class="main">∈</span> <span class="skolem">A</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span><span class="main">.</span> <span class="main">(</span><span class="bound">xa</span><span class="main">,</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span><span class="main">}</span> <span class="main">⊂</span> <span class="skolem">A</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⊆</span> <span class="free">B</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?X</span> <span class="main">=</span> rqs_cost <span class="main">(</span>card <span class="main">{</span><span class="bound"><span class="bound">xa</span></span> <span class="main">∈</span> <span class="skolem">A</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span><span class="main">.</span> <span class="main">(</span><span class="bound">xa</span><span class="main">,</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> subset
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> psubset.IH<span class="main">)</span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound"><span class="bound">xa</span></span> <span class="main">∈</span> <span class="skolem">A</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span><span class="main">.</span> <span class="main">(</span><span class="bound">xa</span><span class="main">,</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span><span class="main">}</span> <span class="main">=</span> linorder_rank <span class="free">R</span> <span class="skolem">A</span> <span class="skolem">x</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> linorder_rank_def<span class="main">)</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?X</span> <span class="main">=</span> rqs_cost <span class="main">…</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">xa</span></span> <span class="main">∈</span> <span class="skolem">A</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span><span class="main">.</span> <span class="main">(</span><span class="bound">xa</span><span class="main">,</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∉</span> <span class="free">R</span><span class="main">}</span> <span class="main">⊆</span> <span class="skolem">A</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⊂</span> <span class="skolem">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 A <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> subset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">xa</span></span> <span class="main">∈</span> <span class="skolem">A</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span><span class="main">.</span> <span class="main">(</span><span class="bound">xa</span><span class="main">,</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∉</span> <span class="free">R</span><span class="main">}</span> <span class="main">⊂</span> <span class="skolem">A</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⊆</span> <span class="free">B</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Y</span> <span class="main">=</span> rqs_cost <span class="main">(</span>card <span class="main">{</span><span class="bound"><span class="bound">xa</span></span> <span class="main">∈</span> <span class="skolem">A</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span><span class="main">.</span> <span class="main">(</span><span class="bound">xa</span><span class="main">,</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∉</span> <span class="free">R</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> subset
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> psubset.IH<span class="main">)</span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">{</span></span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="main">{</span><span class="bound"><span class="bound">y</span></span><span class="main">∈</span><span class="skolem">A</span><span class="main">-</span><span class="main">{</span><span class="skolem">x</span><span class="main">}</span><span class="main">.</span> <span class="main">(</span><span class="bound">y</span><span class="main">,</span><span class="skolem">x</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="bound"><span class="bound">y</span></span><span class="main">∈</span><span class="skolem">A</span><span class="main">-</span><span class="main">{</span><span class="skolem">x</span><span class="main">}</span><span class="main">.</span> <span class="main">(</span><span class="bound">y</span><span class="main">,</span><span class="skolem">x</span><span class="main">)</span><span class="main">∉</span><span class="free">R</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> 
                  linorder_rank <span class="free">R</span> <span class="skolem">A</span> <span class="skolem">x</span> <span class="main">+</span> card <span class="main">{</span><span class="bound"><span class="bound">xa</span></span> <span class="main">∈</span> <span class="skolem">A</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span><span class="main">.</span> <span class="main">(</span><span class="bound">xa</span><span class="main">,</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∉</span> <span class="free">R</span><span class="main">}</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> linorder_rank_def <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> card_Un_disjoint<span class="main">)</span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">y</span></span><span class="main">∈</span><span class="skolem">A</span><span class="main">-</span><span class="main">{</span><span class="skolem">x</span><span class="main">}</span><span class="main">.</span> <span class="main">(</span><span class="bound">y</span><span class="main">,</span><span class="skolem">x</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="bound"><span class="bound">y</span></span><span class="main">∈</span><span class="skolem">A</span><span class="main">-</span><span class="main">{</span><span class="skolem">x</span><span class="main">}</span><span class="main">.</span> <span class="main">(</span><span class="bound">y</span><span class="main">,</span><span class="skolem">x</span><span class="main">)</span><span class="main">∉</span><span class="free">R</span><span class="main">}</span> <span class="main">=</span> <span class="skolem">A</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">…</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> A 1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> n_def<span class="main">)</span>
          <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound"><span class="bound">xa</span></span> <span class="main">∈</span> <span class="skolem">A</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span><span class="main">.</span> <span class="main">(</span><span class="bound">xa</span><span class="main">,</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∉</span> <span class="free">R</span><span class="main">}</span> <span class="main">=</span> <span class="skolem">n</span> <span class="main">-</span> linorder_rank <span class="free">R</span> <span class="skolem">A</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Y</span> <span class="main">=</span> rqs_cost <span class="main">(</span><span class="skolem">n</span> <span class="main">-</span> linorder_rank <span class="free">R</span> <span class="skolem">A</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> case_prod_unfold map_pmf_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
                      <span class="bound">i</span> <span class="main">←</span> map_pmf <span class="main">(</span>linorder_rank <span class="free">R</span> <span class="skolem">A</span><span class="main">)</span> <span class="main">(</span>pmf_of_set <span class="skolem">A</span><span class="main">)</span><span class="main">;</span>
                      <span class="main">(</span><span class="bound">n1</span><span class="main">,</span> <span class="bound">n2</span><span class="main">)</span> <span class="main">←</span> pair_pmf <span class="main">(</span>rqs_cost <span class="bound">i</span><span class="main">)</span> <span class="main">(</span>rqs_cost <span class="main">(</span><span class="skolem">n</span> <span class="main">-</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
                      return_pmf <span class="main">(</span><span class="bound">n1</span> <span class="main">+</span> <span class="bound">n2</span><span class="main">)</span>
                    <span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_map_pmf<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map_pmf <span class="main">(</span>linorder_rank <span class="free">R</span> <span class="skolem">A</span><span class="main">)</span> <span class="main">(</span>pmf_of_set <span class="skolem">A</span><span class="main">)</span> <span class="main">=</span> pmf_of_set <span class="main">{..&lt;</span>card <span class="skolem">A</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> map_pmf_of_set_bij_betw bij_betw_linorder_rank<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span> A psubset.prems<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> A <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="skolem">A</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> Nat.gr0I<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">{..&lt;</span>card <span class="skolem">A</span><span class="main">}</span> <span class="main">=</span> <span class="main">{..</span><span class="skolem">n</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> n_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map_pmf <span class="main">(</span><span class="main">λ</span><span class="bound">m</span><span class="main">.</span> <span class="skolem">n</span> <span class="main">+</span> <span class="bound">m</span><span class="main">)</span> <span class="main">(</span>
                 <span class="keyword1">do</span> <span class="main">{</span>
                      <span class="bound">i</span> <span class="main">←</span> pmf_of_set <span class="main">{..</span><span class="skolem">n</span><span class="main">}</span><span class="main">;</span>
                      <span class="main">(</span><span class="bound">n1</span><span class="main">,</span> <span class="bound">n2</span><span class="main">)</span> <span class="main">←</span> pair_pmf <span class="main">(</span>rqs_cost <span class="bound">i</span><span class="main">)</span> <span class="main">(</span>rqs_cost <span class="main">(</span><span class="skolem">n</span> <span class="main">-</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
                      return_pmf <span class="main">(</span><span class="bound">n1</span> <span class="main">+</span> <span class="bound">n2</span><span class="main">)</span>
                    <span class="main">}</span><span class="main">)</span> <span class="main">=</span> rqs_cost <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pair_pmf_def map_bind_pmf case_prod_unfold
                    bind_assoc_pmf bind_return_pmf add_ac<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> A <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="skolem">A</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> Nat.gr0I<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">n</span> <span class="main">=</span> card <span class="skolem">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> n_def<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We therefore have the same expectation as well. (Note that we showed 
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> rqs_cost_exp_eq <span class="main"><span class="main">[</span></span><span class="operator"><span class="operator">no_vars</span></span><span class="main"><span class="main">]</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> rqs_cost_exp_asymp_equiv <span class="main"><span class="main">[</span></span><span class="operator"><span class="operator">no_vars</span></span><span class="main"><span class="main">]</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> before.
›</span></span>
<span class="keyword1"><span class="command">corollary</span></span> expectation_qs_cost<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"linorder_on <span class="free">B</span> <span class="free">R</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">⊆</span> <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">random_list</span> <span class="main">≡</span> pmf_of_set <span class="main">(</span>permutations_of_set <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"measure_pmf.expectation <span class="main">(</span>map_pmf <span class="main">(</span>qs_cost <span class="free">R</span><span class="main">)</span> <span class="free">random_list</span><span class="main">)</span> real <span class="main">=</span> 
             rqs_cost_exp <span class="main">(</span>card <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> random_list_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> qs_cost_average_conv_rqs_cost<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1-3<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> expectation_rqs_cost<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div>