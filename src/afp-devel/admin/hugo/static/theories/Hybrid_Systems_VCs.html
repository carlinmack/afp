<div id="HS_Preliminaries">
<div class="head">
<h1>Theory HS_Preliminaries</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:       Preliminaries for hybrid systems verification
    Author:      Jonathan Julián Huerta y Munive, 2020
    Maintainer:  Jonathan Julián Huerta y Munive &lt;jonjulian23@gmail.com&gt;
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹ Hybrid Systems Preliminaries ›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Hybrid systems combine continuous dynamics with discrete control. This section contains
auxiliary lemmas for verification of hybrid systems.›</span></span>

<span class="keyword1"><span class="command">theory</span></span> HS_Preliminaries
  <span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="../Ordinary_Differential_Equations/Picard_Lindeloef_Qualitative.html">Ordinary_Differential_Equations.Picard_Lindeloef_Qualitative</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="comment1">― ‹ Syntax ›</span>

<span class="keyword1"><span class="command">no_notation</span></span> has_vderiv_on <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword3">(</span><span class="keyword1">has'_vderiv'_on</span><span class="keyword3">)</span>"</span> 50<span class="main">)</span>

<span class="keyword1"><span class="command">notation</span></span> has_derivative <span class="main">(</span><span class="quoted">"<span class="keyword3">(1</span><span class="keyword3">(</span><span class="keyword1">D</span> _ <span class="keyword1">↦</span> <span class="keyword3">(</span>_<span class="keyword3">)</span><span class="keyword3">)</span><span class="keyword3">/ </span>_<span class="keyword3">)</span>"</span> <span class="main">[</span>65<span class="main">,</span>65<span class="main">]</span> 61<span class="main">)</span>
     <span class="keyword2"><span class="keyword">and</span></span> has_vderiv_on <span class="main">(</span><span class="quoted">"<span class="keyword3">(1</span> <span class="keyword1">D</span> _ <span class="keyword1">=</span> <span class="keyword3">(</span>_<span class="keyword3">)</span><span class="keyword3">/ </span><span class="keyword1">on</span> _<span class="keyword3">)</span>"</span> <span class="main">[</span>65<span class="main">,</span>65<span class="main">]</span> 61<span class="main">)</span>
     <span class="keyword2"><span class="keyword">and</span></span> norm <span class="main">(</span><span class="quoted">"<span class="keyword3">(1</span><span class="keyword1">∥</span>_<span class="keyword1">∥</span><span class="keyword3">)</span>"</span> <span class="main">[</span>65<span class="main">]</span> 61<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹ Real numbers ›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> abs_le_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">r</span><span class="main">::</span>real<span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">¦</span><span class="free">x</span><span class="main">¦</span> <span class="main">&lt;</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">-</span><span class="free">r</span> <span class="main">&lt;</span> <span class="free">x</span> <span class="main">∧</span> <span class="free">x</span> <span class="main">&lt;</span> <span class="free">r</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">r</span><span class="main">::</span>real<span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">¦</span><span class="free">x</span><span class="main">¦</span> <span class="main">≤</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">-</span><span class="free">r</span> <span class="main">≤</span> <span class="free">x</span> <span class="main">∧</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> real_ivl_eqs<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">r</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ball <span class="free">x</span> <span class="free">r</span> <span class="main">=</span> <span class="main">{</span><span class="free">x</span><span class="main">-</span><span class="free">r</span><span class="main">&lt;--&lt;</span> <span class="free">x</span><span class="main">+</span><span class="free">r</span><span class="main">}</span>"</span></span>         <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">x</span><span class="main">-</span><span class="free">r</span><span class="main">&lt;--&lt;</span> <span class="free">x</span><span class="main">+</span><span class="free">r</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="free">x</span><span class="main">-</span><span class="free">r</span><span class="main">&lt;..&lt;</span> <span class="free">x</span><span class="main">+</span><span class="free">r</span><span class="main">}</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"ball <span class="main">(</span><span class="free">r</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">(</span><span class="free">r</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="main">0</span><span class="main">&lt;--&lt;</span><span class="free">r</span><span class="main">}</span>"</span></span>  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">0</span><span class="main">&lt;--&lt;</span><span class="free">r</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="main">0</span><span class="main">&lt;..&lt;</span><span class="free">r</span><span class="main">}</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"ball <span class="main">0</span> <span class="free">r</span> <span class="main">=</span> <span class="main">{</span><span class="main">-</span><span class="free">r</span><span class="main">&lt;--&lt;</span><span class="free">r</span><span class="main">}</span>"</span></span>             <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">-</span><span class="free">r</span><span class="main">&lt;--&lt;</span><span class="free">r</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="main">-</span><span class="free">r</span><span class="main">&lt;..&lt;</span><span class="free">r</span><span class="main">}</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"cball <span class="free">x</span> <span class="free">r</span> <span class="main">=</span> <span class="main">{</span><span class="free">x</span><span class="main">-</span><span class="free">r</span><span class="main">--</span><span class="free">x</span><span class="main">+</span><span class="free">r</span><span class="main">}</span>"</span></span>           <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">x</span><span class="main">-</span><span class="free">r</span><span class="main">--</span><span class="free">x</span><span class="main">+</span><span class="free">r</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="free">x</span><span class="main">-</span><span class="free">r</span><span class="main">..</span><span class="free">x</span><span class="main">+</span><span class="free">r</span><span class="main">}</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"cball <span class="main">(</span><span class="free">r</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">(</span><span class="free">r</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="main">0</span><span class="main">--</span><span class="free">r</span><span class="main">}</span>"</span></span>   <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">0</span><span class="main">--</span><span class="free">r</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">r</span><span class="main">}</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"cball <span class="main">0</span> <span class="free">r</span> <span class="main">=</span> <span class="main">{</span><span class="main">-</span><span class="free">r</span><span class="main">--</span><span class="free">r</span><span class="main">}</span>"</span></span>              <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">-</span><span class="free">r</span><span class="main">--</span><span class="free">r</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="main">-</span><span class="free">r</span><span class="main">..</span><span class="free">r</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> open_segment_eq_real_ivl closed_segment_eq_real_ivl
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cball_def ball_def dist_norm <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> is_interval_real_nonneg<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"is_interval <span class="main">(</span>Collect <span class="main">(</span><span class="main">(≤)</span> <span class="main">(</span><span class="main">0</span><span class="main">::</span>real<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_interval_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> norm_rotate_eq<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">x</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span> <span class="main">{</span>banach<span class="main">,</span>real_normed_field<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">*</span> cos <span class="free">t</span> <span class="main">-</span> <span class="free">y</span> <span class="main">*</span> sin <span class="free">t</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">+</span> <span class="main">(</span><span class="free">x</span> <span class="main">*</span> sin <span class="free">t</span> <span class="main">+</span> <span class="free">y</span> <span class="main">*</span> cos <span class="free">t</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">=</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">+</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">*</span> cos <span class="free">t</span> <span class="main">+</span> <span class="free">y</span> <span class="main">*</span> sin <span class="free">t</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">+</span> <span class="main">(</span><span class="free">y</span> <span class="main">*</span> cos <span class="free">t</span> <span class="main">-</span> <span class="free">x</span> <span class="main">*</span> sin <span class="free">t</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">=</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">+</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">*</span> cos <span class="free">t</span> <span class="main">-</span> <span class="free">y</span> <span class="main">*</span> sin <span class="free">t</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">=</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">*</span> <span class="main">(</span>cos <span class="free">t</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">+</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">*</span> <span class="main">(</span>sin <span class="free">t</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">-</span> <span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="free">x</span> <span class="main">*</span> cos <span class="free">t</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">y</span> <span class="main">*</span> sin <span class="free">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> power2_diff power_mult_distrib<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">*</span> sin <span class="free">t</span> <span class="main">+</span> <span class="free">y</span> <span class="main">*</span> cos <span class="free">t</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">=</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">*</span> <span class="main">(</span>cos <span class="free">t</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">+</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">*</span> <span class="main">(</span>sin <span class="free">t</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="free">x</span> <span class="main">*</span> cos <span class="free">t</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">y</span> <span class="main">*</span> sin <span class="free">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> power2_sum power_mult_distrib<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">*</span> cos <span class="free">t</span> <span class="main">-</span> <span class="free">y</span> <span class="main">*</span> sin <span class="free">t</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">+</span> <span class="main">(</span><span class="free">x</span> <span class="main">*</span> sin <span class="free">t</span> <span class="main">+</span> <span class="free">y</span> <span class="main">*</span> cos <span class="free">t</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">=</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">+</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Groups.mult_ac<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> Groups.mult_ac<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> right_diff_distrib sin_squared_eq<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">*</span> cos <span class="free">t</span> <span class="main">+</span> <span class="free">y</span> <span class="main">*</span> sin <span class="free">t</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">+</span> <span class="main">(</span><span class="free">y</span> <span class="main">*</span> cos <span class="free">t</span> <span class="main">-</span> <span class="free">x</span> <span class="main">*</span> sin <span class="free">t</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">=</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">+</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add.commute add.left_commute power2_diff power2_sum<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹ Single variable derivatives ›</span></span>

<span class="keyword1"><span class="command">named_theorems</span></span> poly_derivatives <span class="quoted">"compilation of optimised miscellaneous derivative rules."</span>

<span class="keyword1"><span class="command">declare</span></span> has_vderiv_on_const <span class="main">[</span><span class="operator">poly_derivatives</span><span class="main">]</span>
    <span class="keyword2"><span class="keyword">and</span></span> has_vderiv_on_id <span class="main">[</span><span class="operator">poly_derivatives</span><span class="main">]</span>
    <span class="keyword2"><span class="keyword">and</span></span> has_vderiv_on_add<span class="main">[</span><span class="operator">THEN</span> has_vderiv_on_eq_rhs<span class="main">,</span> <span class="operator">poly_derivatives</span><span class="main">]</span>
    <span class="keyword2"><span class="keyword">and</span></span> has_vderiv_on_diff<span class="main">[</span><span class="operator">THEN</span> has_vderiv_on_eq_rhs<span class="main">,</span> <span class="operator">poly_derivatives</span><span class="main">]</span>
    <span class="keyword2"><span class="keyword">and</span></span> has_vderiv_on_mult<span class="main">[</span><span class="operator">THEN</span> has_vderiv_on_eq_rhs<span class="main">,</span> <span class="operator">poly_derivatives</span><span class="main">]</span>
    <span class="keyword2"><span class="keyword">and</span></span> has_vderiv_on_ln<span class="main">[</span><span class="operator">poly_derivatives</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> vderiv_on_composeI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">D</span> <span class="free">f</span> <span class="main">=</span> <span class="free">f'</span> <span class="keyword1">on</span> <span class="free">g</span> <span class="main">`</span> <span class="free">T</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">" <span class="keyword1">D</span> <span class="free">g</span> <span class="main">=</span> <span class="free">g'</span> <span class="keyword1">on</span> <span class="free">T</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">g'</span> <span class="bound">t</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">f'</span> <span class="main">(</span><span class="free">g</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">D</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="free">g</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">h</span> <span class="keyword1">on</span> <span class="free">T</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> ssubst<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">h</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> assms has_vderiv_on_compose <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> vderiv_uminusI<span class="main">[</span><span class="operator">poly_derivatives</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="keyword1">D</span> <span class="free">f</span> <span class="main">=</span> <span class="free">f'</span> <span class="keyword1">on</span> <span class="free">T</span> <span class="main">⟹</span> <span class="free">g</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="main">-</span> <span class="free">f'</span> <span class="bound">t</span><span class="main">)</span> <span class="main">⟹</span> <span class="keyword1">D</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="main">-</span> <span class="free">f</span> <span class="bound">t</span><span class="main">)</span> <span class="main">=</span> <span class="free">g</span> <span class="keyword1">on</span> <span class="free">T</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> has_vderiv_on_uminus <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> vderiv_npowI<span class="main">[</span><span class="operator">poly_derivatives</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span><span class="main">::</span><span class="quoted"><span class="quoted">"real <span class="main">⇒</span> real"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≥</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">D</span> <span class="free">f</span> <span class="main">=</span> <span class="free">f'</span> <span class="keyword1">on</span> <span class="free">T</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">n</span> <span class="main">*</span> <span class="main">(</span><span class="free">f'</span> <span class="bound">t</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">f</span> <span class="bound">t</span><span class="main">)</span><span class="main">^</span><span class="main">(</span><span class="free">n</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">D</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span> <span class="bound">t</span><span class="main">)</span><span class="main">^</span><span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="free">g</span> <span class="keyword1">on</span> <span class="free">T</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> has_vderiv_on_def has_vector_derivative_def 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">derivative_eq_intros</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> vderiv_divI<span class="main">[</span><span class="operator">poly_derivatives</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t</span><span class="main">∈</span><span class="free">T</span><span class="main">.</span> <span class="free">g</span> <span class="bound">t</span> <span class="main">≠</span> <span class="main">(</span><span class="main">0</span><span class="main">::</span>real<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">D</span> <span class="free">f</span> <span class="main">=</span> <span class="free">f'</span> <span class="keyword1">on</span> <span class="free">T</span>"</span></span><span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">D</span> <span class="free">g</span> <span class="main">=</span> <span class="free">g'</span> <span class="keyword1">on</span> <span class="free">T</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="main">(</span><span class="free">f'</span> <span class="bound">t</span> <span class="main">*</span> <span class="free">g</span> <span class="bound">t</span> <span class="main">-</span> <span class="free">f</span> <span class="bound">t</span> <span class="main">*</span> <span class="main">(</span><span class="free">g'</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="free">g</span> <span class="bound">t</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">D</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span> <span class="bound">t</span><span class="main">)</span><span class="main">/</span><span class="main">(</span><span class="free">g</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">h</span> <span class="keyword1">on</span> <span class="free">T</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span> <span class="bound">t</span><span class="main">)</span><span class="main">/</span><span class="main">(</span><span class="free">g</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span> <span class="bound">t</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span><span class="main">/</span><span class="main">(</span><span class="free">g</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> ssubst<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> <span class="dynamic"><span class="dynamic">poly_derivatives</span></span><span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> vderiv_on_composeI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> g<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free">g</span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> f<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span><span class="bound"><span class="bound">t</span></span><span class="main"><span class="main">.</span></span> <span class="main"><span class="main">1</span></span><span class="main"><span class="main">/</span></span><span class="bound"><span class="bound">t</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> f'<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span><span class="bound"><span class="bound">t</span></span><span class="main"><span class="main">.</span></span> <span class="main"><span class="main">-</span></span> <span class="main"><span class="main">1</span></span><span class="main"><span class="main">/</span></span><span class="bound"><span class="bound">t</span></span><span class="main"><span class="main">^</span></span><span class="numeral"><span class="numeral">2</span></span>"</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> _ assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> has_vderiv_on_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> has_vector_derivative_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
   <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">derivative_eq_intros</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fun_eq_iff power2_eq_square<span class="main">)</span>
   <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span> power2_eq_square<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> vderiv_cosI<span class="main">[</span><span class="operator">poly_derivatives</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">D</span> <span class="main">(</span><span class="free">f</span><span class="main">::</span>real <span class="main">⇒</span> real<span class="main">)</span> <span class="main">=</span> <span class="free">f'</span> <span class="keyword1">on</span> <span class="free">T</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="main">-</span> <span class="main">(</span><span class="free">f'</span> <span class="bound">t</span><span class="main">)</span> <span class="main">*</span> sin <span class="main">(</span><span class="free">f</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">D</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> cos <span class="main">(</span><span class="free">f</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">g</span> <span class="keyword1">on</span> <span class="free">T</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> vderiv_on_composeI<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span><span class="bound"><span class="bound">t</span></span><span class="main"><span class="main">.</span></span> cos <span class="bound"><span class="bound">t</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> has_vderiv_on_def has_vector_derivative_def 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">derivative_eq_intros</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> assms<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> vderiv_sinI<span class="main">[</span><span class="operator">poly_derivatives</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">D</span> <span class="main">(</span><span class="free">f</span><span class="main">::</span>real <span class="main">⇒</span> real<span class="main">)</span> <span class="main">=</span> <span class="free">f'</span> <span class="keyword1">on</span> <span class="free">T</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="main">(</span><span class="free">f'</span> <span class="bound">t</span><span class="main">)</span> <span class="main">*</span> cos <span class="main">(</span><span class="free">f</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">D</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> sin <span class="main">(</span><span class="free">f</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">g</span> <span class="keyword1">on</span> <span class="free">T</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> vderiv_on_composeI<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span><span class="bound"><span class="bound">t</span></span><span class="main"><span class="main">.</span></span> sin <span class="bound"><span class="bound">t</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> has_vderiv_on_def has_vector_derivative_def 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">derivative_eq_intros</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> assms<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> vderiv_expI<span class="main">[</span><span class="operator">poly_derivatives</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">D</span> <span class="main">(</span><span class="free">f</span><span class="main">::</span>real <span class="main">⇒</span> real<span class="main">)</span> <span class="main">=</span> <span class="free">f'</span> <span class="keyword1">on</span> <span class="free">T</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="main">(</span><span class="free">f'</span> <span class="bound">t</span><span class="main">)</span> <span class="main">*</span> exp <span class="main">(</span><span class="free">f</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">D</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> exp <span class="main">(</span><span class="free">f</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">g</span> <span class="keyword1">on</span> <span class="free">T</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> vderiv_on_composeI<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span><span class="bound"><span class="bound">t</span></span><span class="main"><span class="main">.</span></span> exp <span class="bound"><span class="bound">t</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> has_vderiv_on_def has_vector_derivative_def 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">derivative_eq_intros</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> assms<span class="main">)</span>

<span class="comment1">― ‹Examples for checking derivatives›</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">D</span> <span class="main">(*)</span> <span class="free">a</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">a</span><span class="main">)</span> <span class="keyword1">on</span> <span class="free">T</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">poly_derivatives</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟹</span> <span class="keyword1">D</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="bound">t</span><span class="main">/</span><span class="free">a</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="main">1</span><span class="main">/</span><span class="free">a</span><span class="main">)</span> <span class="keyword1">on</span> <span class="free">T</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">poly_derivatives</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> power2_eq_square<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span><span class="main">::</span>real<span class="main">)</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟹</span> <span class="keyword1">D</span> <span class="free">f</span> <span class="main">=</span> <span class="free">f'</span> <span class="keyword1">on</span> <span class="free">T</span> <span class="main">⟹</span> <span class="free">g</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="main">(</span><span class="free">f'</span> <span class="bound">t</span><span class="main">)</span><span class="main">/</span><span class="free">a</span><span class="main">)</span> <span class="main">⟹</span> <span class="keyword1">D</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span> <span class="bound">t</span><span class="main">)</span><span class="main">/</span><span class="free">a</span><span class="main">)</span> <span class="main">=</span> <span class="free">g</span> <span class="keyword1">on</span> <span class="free">T</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">poly_derivatives</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> power2_eq_square<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t</span><span class="main">∈</span><span class="free">T</span><span class="main">.</span> <span class="free">f</span> <span class="bound">t</span> <span class="main">≠</span> <span class="main">(</span><span class="main">0</span><span class="main">::</span>real<span class="main">)</span> <span class="main">⟹</span> <span class="keyword1">D</span> <span class="free">f</span> <span class="main">=</span> <span class="free">f'</span> <span class="keyword1">on</span> <span class="free">T</span> <span class="main">⟹</span> <span class="free">g</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="main">-</span> <span class="free">a</span> <span class="main">*</span> <span class="free">f'</span> <span class="bound">t</span> <span class="main">/</span> <span class="main">(</span><span class="free">f</span> <span class="bound">t</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span><span class="main">)</span> <span class="main">⟹</span> 
  <span class="keyword1">D</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">a</span><span class="main">/</span><span class="main">(</span><span class="free">f</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">g</span> <span class="keyword1">on</span> <span class="free">T</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">poly_derivatives</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> power2_eq_square<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">D</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">a</span> <span class="main">*</span> <span class="bound">t</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">+</span> <span class="free">v</span> <span class="main">*</span> <span class="bound">t</span> <span class="main">+</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">a</span> <span class="main">*</span> <span class="bound">t</span> <span class="main">+</span> <span class="free">v</span><span class="main">)</span> <span class="keyword1">on</span> <span class="free">T</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">poly_derivatives</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">D</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">v</span> <span class="main">*</span> <span class="bound">t</span> <span class="main">-</span> <span class="free">a</span> <span class="main">*</span> <span class="bound">t</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">+</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">v</span> <span class="main">-</span> <span class="free">a</span> <span class="main">*</span> <span class="bound">x</span><span class="main">)</span> <span class="keyword1">on</span> <span class="free">T</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">poly_derivatives</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">D</span> <span class="free">x</span> <span class="main">=</span> <span class="free">x'</span> <span class="keyword1">on</span> <span class="main">(</span><span class="main">λ</span><span class="bound">τ</span><span class="main">.</span> <span class="bound">τ</span> <span class="main">+</span> <span class="free">t</span><span class="main">)</span> <span class="main">`</span> <span class="free">T</span> <span class="main">⟹</span> <span class="keyword1">D</span> <span class="main">(</span><span class="main">λ</span><span class="bound">τ</span><span class="main">.</span> <span class="free">x</span> <span class="main">(</span><span class="bound">τ</span> <span class="main">+</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">τ</span><span class="main">.</span> <span class="free">x'</span> <span class="main">(</span><span class="bound">τ</span> <span class="main">+</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">on</span> <span class="free">T</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> vderiv_on_composeI<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">poly_derivatives</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟹</span> <span class="keyword1">D</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="bound">t</span><span class="main">/</span><span class="free">a</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="main">1</span><span class="main">/</span><span class="free">a</span><span class="main">)</span> <span class="keyword1">on</span> <span class="free">T</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">poly_derivatives</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> power2_eq_square<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟹</span> <span class="keyword1">D</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">a5</span> <span class="main">*</span> <span class="bound">t</span><span class="main">^</span><span class="numeral">5</span> <span class="main">+</span> <span class="free">a3</span> <span class="main">*</span> <span class="main">(</span><span class="bound">t</span><span class="main">^</span><span class="numeral">3</span> <span class="main">/</span> <span class="free">c</span><span class="main">)</span> <span class="main">-</span> <span class="free">a2</span> <span class="main">*</span> exp <span class="main">(</span><span class="bound">t</span><span class="main">^</span><span class="numeral">2</span><span class="main">)</span> <span class="main">+</span> <span class="free">a1</span> <span class="main">*</span> cos <span class="bound">t</span> <span class="main">+</span> <span class="free">a0</span><span class="main">)</span> <span class="main">=</span> 
  <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="numeral">5</span> <span class="main">*</span> <span class="free">a5</span> <span class="main">*</span> <span class="bound">t</span><span class="main">^</span><span class="numeral">4</span> <span class="main">+</span> <span class="numeral">3</span> <span class="main">*</span> <span class="free">a3</span> <span class="main">*</span> <span class="main">(</span><span class="bound">t</span><span class="main">^</span><span class="numeral">2</span> <span class="main">/</span> <span class="free">c</span><span class="main">)</span> <span class="main">-</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">a2</span> <span class="main">*</span> <span class="bound">t</span> <span class="main">*</span> exp <span class="main">(</span><span class="bound">t</span><span class="main">^</span><span class="numeral">2</span><span class="main">)</span> <span class="main">-</span> <span class="free">a1</span> <span class="main">*</span> sin <span class="bound">t</span><span class="main">)</span> <span class="keyword1">on</span> <span class="free">T</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">poly_derivatives</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> power2_eq_square<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟹</span> <span class="keyword1">D</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="main">-</span> <span class="free">a3</span> <span class="main">*</span> exp <span class="main">(</span><span class="bound">t</span><span class="main">^</span><span class="numeral">3</span> <span class="main">/</span> <span class="free">c</span><span class="main">)</span> <span class="main">+</span> <span class="free">a1</span> <span class="main">*</span> sin <span class="bound">t</span> <span class="main">+</span> <span class="free">a2</span> <span class="main">*</span> <span class="bound">t</span><span class="main">^</span><span class="numeral">2</span><span class="main">)</span> <span class="main">=</span> 
  <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">a1</span> <span class="main">*</span> cos <span class="bound">t</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">a2</span> <span class="main">*</span> <span class="bound">t</span> <span class="main">-</span> <span class="numeral">3</span> <span class="main">*</span> <span class="free">a3</span> <span class="main">*</span> <span class="bound">t</span><span class="main">^</span><span class="numeral">2</span> <span class="main">/</span> <span class="free">c</span> <span class="main">*</span> exp <span class="main">(</span><span class="bound">t</span><span class="main">^</span><span class="numeral">3</span> <span class="main">/</span> <span class="free">c</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">on</span> <span class="free">T</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">poly_derivatives</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> power2_eq_square<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟹</span> <span class="keyword1">D</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> exp <span class="main">(</span><span class="free">a</span> <span class="main">*</span> sin <span class="main">(</span>cos <span class="main">(</span><span class="bound">t</span><span class="main">^</span><span class="numeral">4</span><span class="main">)</span> <span class="main">/</span> <span class="free">c</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
  <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="main">-</span> <span class="numeral">4</span> <span class="main">*</span> <span class="free">a</span> <span class="main">*</span> <span class="bound">t</span><span class="main">^</span><span class="numeral">3</span> <span class="main">*</span> sin <span class="main">(</span><span class="bound">t</span><span class="main">^</span><span class="numeral">4</span><span class="main">)</span> <span class="main">/</span> <span class="free">c</span> <span class="main">*</span> cos <span class="main">(</span>cos <span class="main">(</span><span class="bound">t</span><span class="main">^</span><span class="numeral">4</span><span class="main">)</span> <span class="main">/</span> <span class="free">c</span><span class="main">)</span> <span class="main">*</span> exp <span class="main">(</span><span class="free">a</span> <span class="main">*</span> sin <span class="main">(</span>cos <span class="main">(</span><span class="bound">t</span><span class="main">^</span><span class="numeral">4</span><span class="main">)</span> <span class="main">/</span> <span class="free">c</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">on</span> <span class="free">T</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> <span class="dynamic"><span class="dynamic">poly_derivatives</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">poly_derivatives</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> power2_eq_square<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹ Intermediate Value Theorem ›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> IVT_two_functions<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>linear_continuum_topology<span class="main">,</span> real_vector<span class="main">}</span><span class="main">)</span> <span class="main">⇒</span> 
  <span class="main">(</span><span class="tfree">'b</span><span class="main">::</span><span class="main">{</span>linorder_topology<span class="main">,</span>real_normed_vector<span class="main">,</span>ordered_ab_group_add<span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> conts<span class="main">:</span> <span class="quoted"><span class="quoted">"continuous_on <span class="main">{</span><span class="free">a</span><span class="main">..</span><span class="free">b</span><span class="main">}</span> <span class="free">f</span>"</span></span> <span class="quoted"><span class="quoted">"continuous_on <span class="main">{</span><span class="free">a</span><span class="main">..</span><span class="free">b</span><span class="main">}</span> <span class="free">g</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> ahyp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">a</span> <span class="main">&lt;</span> <span class="free">g</span> <span class="free">a</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> bhyp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="free">b</span> <span class="main">&lt;</span> <span class="free">f</span> <span class="free">b</span> "</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≤</span> <span class="free">b</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">∈</span><span class="main">{</span><span class="free">a</span><span class="main">..</span><span class="free">b</span><span class="main">}</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">g</span> <span class="bound">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="quoted"><span class="quoted">"<span class="var">?h</span> <span class="free">x</span>"</span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">x</span> <span class="main">-</span> <span class="free">g</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?h</span> <span class="free">a</span> <span class="main">≤</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="var">?h</span> <span class="free">b</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ahyp bhyp <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"continuous_on <span class="main">{</span><span class="free">a</span><span class="main">..</span><span class="free">b</span><span class="main">}</span> <span class="var">?h</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> conts continuous_on_diff <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≤</span> <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≤</span> <span class="free">b</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="var">?h</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> IVT'<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="var">?h</span>"</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="free">a</span> <span class="main">≤</span> <span class="free">b</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">a</span> <span class="main">≤</span> <span class="free">b</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> IVT_two_functions_real_ivl<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real <span class="main">⇒</span> real"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> conts<span class="main">:</span> <span class="quoted"><span class="quoted">"continuous_on <span class="main">{</span><span class="free">a</span><span class="main">--</span><span class="free">b</span><span class="main">}</span> <span class="free">f</span>"</span></span> <span class="quoted"><span class="quoted">"continuous_on <span class="main">{</span><span class="free">a</span><span class="main">--</span><span class="free">b</span><span class="main">}</span> <span class="free">g</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> ahyp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">a</span> <span class="main">&lt;</span> <span class="free">g</span> <span class="free">a</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> bhyp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="free">b</span> <span class="main">&lt;</span> <span class="free">f</span> <span class="free">b</span> "</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">∈</span><span class="main">{</span><span class="free">a</span><span class="main">--</span><span class="free">b</span><span class="main">}</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">g</span> <span class="bound">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≤</span> <span class="free">b</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">using</span></span> IVT_two_functions assms 
    <span class="keyword1"><span class="command">unfolding</span></span> closed_segment_eq_real_ivl <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≥</span> <span class="free">b</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"continuous_on <span class="main">{</span><span class="free">b</span><span class="main">..</span><span class="free">a</span><span class="main">}</span> <span class="free">f</span>"</span></span> <span class="quoted"><span class="quoted">"continuous_on <span class="main">{</span><span class="free">b</span><span class="main">..</span><span class="free">a</span><span class="main">}</span> <span class="free">g</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> conts False <span class="keyword1"><span class="command">unfolding</span></span> closed_segment_eq_real_ivl <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">∈</span><span class="main">{</span><span class="free">b</span><span class="main">..</span><span class="free">a</span><span class="main">}</span><span class="main">.</span> <span class="free">g</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">f</span> <span class="bound">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> IVT_two_functions<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">b</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">g</span></span> <span class="quoted"><span class="free">f</span></span><span class="main">]</span> assms<span class="main">(</span>3<span class="main">,</span>4<span class="main">)</span> False <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>  
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">a</span> <span class="main">≥</span> <span class="free">b</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> closed_segment_eq_real_ivl <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="operator">force</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹ Filters ›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> eventually_at_within_mono<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> interior <span class="free">T</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">T</span> <span class="main">⊆</span> <span class="free">S</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"eventually <span class="free">P</span> <span class="main">(</span><span class="keyword1">at</span> <span class="free">t</span> <span class="keyword1">within</span> <span class="free">T</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"eventually <span class="free">P</span> <span class="main">(</span><span class="keyword1">at</span> <span class="free">t</span> <span class="keyword1">within</span> <span class="free">S</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> assms eventually_within_interior interior_mono subsetD<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> netlimit_at_within_mono<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">t</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>perfect_space<span class="main">,</span>t2_space<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> interior <span class="free">T</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">T</span> <span class="main">⊆</span> <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"netlimit <span class="main">(</span><span class="keyword1">at</span> <span class="free">t</span> <span class="keyword1">within</span> <span class="free">S</span><span class="main">)</span> <span class="main">=</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> interior_mono<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">T</span> <span class="main">⊆</span> <span class="free">S</span>›</span></span><span class="main">]</span> netlimit_within_interior <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> has_derivative_at_within_mono<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">t</span><span class="main">::</span>real<span class="main">)</span> <span class="main">∈</span> interior <span class="free">T</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">T</span> <span class="main">⊆</span> <span class="free">S</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">D</span> <span class="free">f</span> <span class="main">↦</span> <span class="free">f'</span> <span class="keyword1">at</span> <span class="free">t</span> <span class="keyword1">within</span> <span class="free">T</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">D</span> <span class="free">f</span> <span class="main">↦</span> <span class="free">f'</span> <span class="keyword1">at</span> <span class="free">t</span> <span class="keyword1">within</span> <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">unfold</span> has_derivative_def tendsto_iff<span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main">)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> netlimit_at_within_mono<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> netlimit_within_interior<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> eventually_at_within_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">,</span></span></span>2<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> eventually_all_finite2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">P</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>finite<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> h<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> eventually <span class="main">(</span><span class="free">P</span> <span class="bound">i</span><span class="main">)</span> <span class="free">F</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"eventually <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="free">P</span> <span class="bound">i</span> <span class="bound">x</span><span class="main">)</span> <span class="free">F</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">unfold</span> eventually_def<span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?F</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Rep_filter <span class="free">F</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> obs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="var">?F</span> <span class="main">(</span><span class="free">P</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> h <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?F</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">∀</span><span class="bound">i</span> <span class="main">∈</span> UNIV<span class="main">.</span> <span class="free">P</span> <span class="bound">i</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> finite_induct<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> eventually_conj <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> obs h<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="var">?F</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="free">P</span> <span class="bound">i</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> eventually_all_finite_mono<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">P</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>finite<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> h1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> eventually <span class="main">(</span><span class="free">P</span> <span class="bound">i</span><span class="main">)</span> <span class="free">F</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> h2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="free">P</span> <span class="bound">i</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">Q</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"eventually <span class="free">Q</span> <span class="free">F</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eventually <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="free">P</span> <span class="bound">i</span> <span class="bound">x</span><span class="main">)</span> <span class="free">F</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> h1 eventually_all_finite2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"eventually <span class="free">Q</span> <span class="free">F</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> eventually_def
    <span class="keyword1"><span class="command">using</span></span> h2 eventually_mono <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹ Multivariable derivatives ›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">vec_upd</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">^</span><span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">^</span><span class="tfree">'b</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">vec_upd</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">χ</span> <span class="bound">j</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="main">($)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">:=</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span><span class="main">)</span> <span class="bound">j</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> vec_upd_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"vec_upd <span class="free">s</span> <span class="free">i</span> <span class="free">a</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">χ</span> <span class="bound">j</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">j</span> <span class="main">=</span> <span class="free">i</span> <span class="keyword1">then</span> <span class="free">a</span> <span class="keyword1">else</span> <span class="free">s</span><span class="main">$</span><span class="bound">j</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> vec_upd_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> frechet_vec_lambda<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span><span class="main">::</span><span class="quoted"><span class="quoted">"real <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>banach<span class="main">)</span><span class="main">^</span><span class="main">(</span><span class="tfree">'m</span><span class="main">::</span>finite<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">x</span><span class="main">::</span><span class="quoted">real</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">T</span><span class="main">::</span><span class="quoted"><span class="quoted">"real set"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">x<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">≡</span> netlimit <span class="main">(</span><span class="keyword1">at</span> <span class="free">x</span> <span class="keyword1">within</span> <span class="free">T</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">≡</span> real <span class="keyword1">CARD</span><span class="main">(</span><span class="tfree">'m</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span> <span class="bound">y</span> <span class="main">$</span> <span class="bound">i</span> <span class="main">-</span> <span class="free">f</span> <span class="free">x<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">$</span> <span class="bound">i</span> <span class="main">-</span> <span class="main">(</span><span class="bound">y</span> <span class="main">-</span> <span class="free">x<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">f'</span> <span class="free">x</span> <span class="main">$</span> <span class="bound">i</span><span class="main">)</span> <span class="keyword1">/<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">(</span><span class="main">∥</span><span class="bound">y</span> <span class="main">-</span> <span class="free">x<span class="hidden">⇩</span><sub>0</sub></span><span class="main">∥</span><span class="main">)</span><span class="main">)</span> <span class="main">⤏</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="free">x</span> <span class="keyword1">within</span> <span class="free">T</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span> <span class="bound">y</span> <span class="main">-</span> <span class="free">f</span> <span class="free">x<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">-</span> <span class="main">(</span><span class="bound">y</span> <span class="main">-</span> <span class="free">x<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">f'</span> <span class="free">x</span><span class="main">)</span> <span class="keyword1">/<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">(</span><span class="main">∥</span><span class="bound">y</span> <span class="main">-</span> <span class="free">x<span class="hidden">⇩</span><sub>0</sub></span><span class="main">∥</span><span class="main">)</span><span class="main">)</span> <span class="main">⤏</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="free">x</span> <span class="keyword1">within</span> <span class="free">T</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tendsto_iff<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarify</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ε</span><span class="main">::</span><span class="quoted">real</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">ε</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Δ</span>"</span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">-</span> <span class="free">x<span class="hidden">⇩</span><sub>0</sub></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Δf</span>"</span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="free">f</span> <span class="bound">y</span> <span class="main">-</span> <span class="free">f</span> <span class="free">x<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span>"</span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">i</span> <span class="bound">e</span> <span class="bound">y</span><span class="main">.</span> inverse <span class="main">¦</span><span class="var">?Δ</span> <span class="bound">y</span><span class="main">¦</span> <span class="main">*</span> <span class="main">(</span><span class="main">∥</span><span class="free">f</span> <span class="bound">y</span> <span class="main">$</span> <span class="bound">i</span> <span class="main">-</span> <span class="free">f</span> <span class="free">x<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">$</span> <span class="bound">i</span> <span class="main">-</span> <span class="var">?Δ</span> <span class="bound">y</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">f'</span> <span class="free">x</span> <span class="main">$</span> <span class="bound">i</span><span class="main">∥</span><span class="main">)</span> <span class="main">&lt;</span> <span class="bound">e</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Q</span>"</span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">y</span><span class="main">.</span> inverse <span class="main">¦</span><span class="var">?Δ</span> <span class="bound">y</span><span class="main">¦</span> <span class="main">*</span> <span class="main">(</span><span class="main">∥</span><span class="var">?Δf</span> <span class="bound">y</span> <span class="main">-</span> <span class="var">?Δ</span> <span class="bound">y</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">f'</span> <span class="free">x</span><span class="main">∥</span><span class="main">)</span> <span class="main">&lt;</span> <span class="skolem">ε</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">ε</span> <span class="main">/</span> sqrt <span class="free">m</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">ε</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> assms<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> eventually <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="var">?P</span> <span class="bound">i</span> <span class="main">(</span><span class="skolem">ε</span> <span class="main">/</span> sqrt <span class="free">m</span><span class="main">)</span> <span class="bound">y</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="free">x</span> <span class="keyword1">within</span> <span class="free">T</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> tendsto_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"eventually <span class="var">?Q</span> <span class="main">(</span><span class="keyword1">at</span> <span class="free">x</span> <span class="keyword1">within</span> <span class="free">T</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> eventually_all_finite_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> norm_vec_def L2_set_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarify</span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span><span class="main">::</span><span class="quoted">real</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?c</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"inverse <span class="main">¦</span><span class="skolem">t</span> <span class="main">-</span> <span class="free">x<span class="hidden">⇩</span><sub>0</sub></span><span class="main">¦</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="var">?u</span> <span class="skolem">t</span>"</span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">f</span> <span class="skolem">t</span> <span class="main">$</span> <span class="bound">i</span> <span class="main">-</span> <span class="free">f</span> <span class="free">x<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">$</span> <span class="bound">i</span> <span class="main">-</span> <span class="var">?Δ</span> <span class="skolem">t</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">f'</span> <span class="free">x</span> <span class="main">$</span> <span class="bound">i</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> hyp<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="var">?c</span> <span class="main">*</span> <span class="main">(</span><span class="main">∥</span><span class="var">?u</span> <span class="skolem">t</span> <span class="bound">i</span><span class="main">∥</span><span class="main">)</span> <span class="main">&lt;</span> <span class="skolem">ε</span> <span class="main">/</span> sqrt <span class="free">m</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="var">?c</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">(</span><span class="main">∥</span><span class="var">?u</span> <span class="skolem">t</span> <span class="bound">i</span><span class="main">∥</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">&lt;</span> <span class="main">(</span><span class="skolem">ε</span> <span class="main">/</span> sqrt <span class="free">m</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> power_strict_mono<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="var">?c</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="main">∥</span><span class="var">?u</span> <span class="skolem">t</span> <span class="bound">i</span><span class="main">∥</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">&lt;</span> <span class="skolem">ε</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">/</span> <span class="free">m</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> power_mult_distrib power_divide assms<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="var">?c</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="main">∥</span><span class="var">?u</span> <span class="skolem">t</span> <span class="bound">i</span><span class="main">∥</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">&lt;</span> <span class="skolem">ε</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">/</span> <span class="free">m</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> assms<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">{}</span><span class="main">::</span><span class="tfree">'m</span> set<span class="main">)</span> <span class="main">≠</span> UNIV <span class="main">∧</span> finite <span class="main">(</span>UNIV <span class="main">::</span> <span class="tfree">'m</span> set<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span>UNIV<span class="main">.</span> <span class="var">?c</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="main">∥</span><span class="var">?u</span> <span class="skolem">t</span> <span class="bound">i</span><span class="main">∥</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span> <span class="main">&lt;</span> <span class="main">(</span><span class="main">∑</span><span class="main">(</span><span class="bound">i</span><span class="main">::</span><span class="tfree">'m</span><span class="main">)</span><span class="main">∈</span>UNIV<span class="main">.</span> <span class="skolem">ε</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">/</span> <span class="free">m</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">)</span></span> sum_strict_mono<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?c</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span>UNIV<span class="main">.</span> <span class="main">(</span><span class="main">∥</span><span class="var">?u</span> <span class="skolem">t</span> <span class="bound">i</span><span class="main">∥</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span>UNIV<span class="main">.</span> <span class="var">?c</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">*</span>  <span class="main">(</span><span class="main">∥</span><span class="var">?u</span> <span class="skolem">t</span> <span class="bound">i</span><span class="main">∥</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> sum_distrib_left <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?c</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span>UNIV<span class="main">.</span> <span class="main">(</span><span class="main">∥</span><span class="var">?u</span> <span class="skolem">t</span> <span class="bound">i</span><span class="main">∥</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span> <span class="main">&lt;</span> <span class="skolem">ε</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"sqrt <span class="main">(</span><span class="var">?c</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span>UNIV<span class="main">.</span> <span class="main">(</span><span class="main">∥</span><span class="var">?u</span> <span class="skolem">t</span> <span class="bound">i</span><span class="main">∥</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span><span class="main">)</span> <span class="main">&lt;</span> sqrt <span class="main">(</span><span class="skolem">ε</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> real_sqrt_less_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="skolem">ε</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">ε</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?c</span> <span class="main">*</span> sqrt <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span>UNIV<span class="main">.</span> <span class="main">(</span><span class="main">∥</span><span class="var">?u</span> <span class="skolem">t</span> <span class="bound">i</span><span class="main">∥</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span> <span class="main">=</span> sqrt <span class="main">(</span><span class="var">?c</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span>UNIV<span class="main">.</span> <span class="main">(</span><span class="main">∥</span><span class="var">?u</span> <span class="skolem">t</span> <span class="bound">i</span><span class="main">∥</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> real_sqrt_mult<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?c</span> <span class="main">*</span> sqrt <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span>UNIV<span class="main">.</span> <span class="main">(</span><span class="main">∥</span><span class="var">?u</span> <span class="skolem">t</span> <span class="bound">i</span><span class="main">∥</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span> <span class="main">&lt;</span> <span class="skolem">ε</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> tendsto_norm_bound<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="main">∥</span><span class="free">G</span> <span class="bound">x</span> <span class="main">-</span> <span class="free">L</span><span class="main">∥</span> <span class="main">≤</span> <span class="main">∥</span><span class="free">F</span> <span class="bound">x</span> <span class="main">-</span> <span class="free">L</span><span class="main">∥</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">F</span> <span class="main">⤏</span> <span class="free">L</span><span class="main">)</span> <span class="free">net</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">G</span> <span class="main">⤏</span> <span class="free">L</span><span class="main">)</span> <span class="free">net</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">unfold</span> tendsto_iff dist_norm<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> P<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">∥</span><span class="free">F</span> <span class="bound">x</span> <span class="main">-</span> <span class="free">L</span><span class="main">∥</span> <span class="main">&lt;</span> <span class="improper">e</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> eventually_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rename_tac</span> e z<span class="main">)</span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">z</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> tendsto_zero_norm_bound<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="main">∥</span><span class="free">G</span> <span class="bound">x</span><span class="main">∥</span> <span class="main">≤</span> <span class="main">∥</span><span class="free">F</span> <span class="bound">x</span><span class="main">∥</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">F</span> <span class="main">⤏</span> <span class="main">0</span><span class="main">)</span> <span class="free">net</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">G</span> <span class="main">⤏</span> <span class="main">0</span><span class="main">)</span> <span class="free">net</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">unfold</span> tendsto_iff dist_norm<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> P<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">∥</span><span class="free">F</span> <span class="bound">x</span><span class="main">∥</span> <span class="main">&lt;</span> <span class="improper">e</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> eventually_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rename_tac</span> e z<span class="main">)</span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">z</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> frechet_vec_nth<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span><span class="main">::</span><span class="quoted"><span class="quoted">"real <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>real_normed_vector<span class="main">)</span><span class="main">^</span><span class="tfree">'m</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span> <span class="main">-</span> <span class="free">f</span> <span class="free">x<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">-</span> <span class="main">(</span><span class="bound">x</span> <span class="main">-</span> <span class="free">x<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">f'</span> <span class="free">t</span><span class="main">)</span> <span class="keyword1">/<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">(</span><span class="main">∥</span><span class="bound">x</span> <span class="main">-</span> <span class="free">x<span class="hidden">⇩</span><sub>0</sub></span><span class="main">∥</span><span class="main">)</span><span class="main">)</span> <span class="main">⤏</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="free">t</span> <span class="keyword1">within</span> <span class="free">T</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span> <span class="main">$</span> <span class="free">i</span> <span class="main">-</span> <span class="free">f</span> <span class="free">x<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">$</span> <span class="free">i</span> <span class="main">-</span> <span class="main">(</span><span class="bound">x</span> <span class="main">-</span> <span class="free">x<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">f'</span> <span class="free">t</span> <span class="main">$</span> <span class="free">i</span><span class="main">)</span> <span class="keyword1">/<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">(</span><span class="main">∥</span><span class="bound">x</span> <span class="main">-</span> <span class="free">x<span class="hidden">⇩</span><sub>0</sub></span><span class="main">∥</span><span class="main">)</span><span class="main">)</span> <span class="main">⤏</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="free">t</span> <span class="keyword1">within</span> <span class="free">T</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> F<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span> <span class="main">-</span> <span class="free">f</span> <span class="free">x<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">-</span> <span class="main">(</span><span class="bound">x</span> <span class="main">-</span> <span class="free">x<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">f'</span> <span class="free">t</span><span class="main">)</span> <span class="keyword1">/<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">(</span><span class="main">∥</span><span class="bound">x</span> <span class="main">-</span> <span class="free">x<span class="hidden">⇩</span><sub>0</sub></span><span class="main">∥</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> tendsto_zero_norm_bound<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> mult_left_mono<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> Finite_Cartesian_Product.norm_nth_le vector_minus_component vector_scaleR_component<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> has_derivative_vec_lambda<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span><span class="main">::</span><span class="quoted"><span class="quoted">"real <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>banach<span class="main">)</span><span class="main">^</span><span class="main">(</span><span class="tfree">'n</span><span class="main">::</span>finite<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="keyword1">D</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">f</span> <span class="bound">t</span> <span class="main">$</span> <span class="bound">i</span><span class="main">)</span> <span class="main">↦</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">h</span><span class="main">.</span> <span class="bound">h</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">f'</span> <span class="free">x</span> <span class="main">$</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="free">x</span> <span class="keyword1">within</span> <span class="free">T</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">D</span> <span class="free">f</span> <span class="main">↦</span> <span class="main">(</span><span class="main">λ</span><span class="bound">h</span><span class="main">.</span> <span class="bound">h</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">f'</span> <span class="free">x</span><span class="main">)</span> <span class="keyword1">at</span> <span class="free">x</span> <span class="keyword1">within</span> <span class="free">T</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">unfold</span> has_derivative_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> bounded_linear_def bounded_linear_axioms_def<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> assms frechet_vec_lambda<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">T</span></span> <span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> has_derivative_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> has_derivative_vec_nth<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">D</span> <span class="free">f</span> <span class="main">↦</span> <span class="main">(</span><span class="main">λ</span><span class="bound">h</span><span class="main">.</span> <span class="bound">h</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">f'</span> <span class="free">x</span><span class="main">)</span> <span class="keyword1">at</span> <span class="free">x</span> <span class="keyword1">within</span> <span class="free">T</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">D</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">f</span> <span class="bound">t</span> <span class="main">$</span> <span class="free">i</span><span class="main">)</span> <span class="main">↦</span> <span class="main">(</span><span class="main">λ</span><span class="bound">h</span><span class="main">.</span> <span class="bound">h</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">f'</span> <span class="free">x</span> <span class="main">$</span> <span class="free">i</span><span class="main">)</span> <span class="keyword1">at</span> <span class="free">x</span> <span class="keyword1">within</span> <span class="free">T</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">unfold</span> has_derivative_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> bounded_linear_def bounded_linear_axioms_def<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> frechet_vec_nth assms <span class="keyword1"><span class="command">unfolding</span></span> has_derivative_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> has_vderiv_on_vec_eq<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">x</span><span class="main">::</span><span class="quoted"><span class="quoted">"real <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>banach<span class="main">)</span><span class="main">^</span><span class="main">(</span><span class="tfree">'n</span><span class="main">::</span>finite<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">D</span> <span class="free">x</span> <span class="main">=</span> <span class="free">x'</span> <span class="keyword1">on</span> <span class="free">T</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="keyword1">D</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">x</span> <span class="bound">t</span> <span class="main">$</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">x'</span> <span class="bound">t</span> <span class="main">$</span> <span class="bound">i</span><span class="main">)</span> <span class="keyword1">on</span> <span class="free">T</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> has_vderiv_on_def has_vector_derivative_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
  <span class="keyword1"><span class="command">using</span></span> has_derivative_vec_nth has_derivative_vec_lambda <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="HS_ODEs">
<div class="head">
<h1>Theory HS_ODEs</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:       ODEs and Dynamical Systems for HS verification
    Author:      Jonathan Julián Huerta y Munive, 2020
    Maintainer:  Jonathan Julián Huerta y Munive &lt;jonjulian23@gmail.com&gt;
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹ Ordinary Differential Equations ›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Vector fields <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"f::real ⇒ 'a ⇒ ('a::real_normed_vector)"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> represent systems 
of ordinary differential equations (ODEs). Picard-Lindeloef's theorem guarantees existence 
and uniqueness of local solutions to initial value problems involving Lipschitz continuous 
vector fields. A (local) flow <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"φ::real ⇒ 'a ⇒ ('a::real_normed_vector)"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> for such 
a system is the function that maps initial conditions to their unique solutions. In dynamical 
systems, the set of all points <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"φ t s::'a"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> for a fixed <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"s::'a"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is the flow's 
orbit. If the orbit of each <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"s ∈ I"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is conatined in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">I</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, then <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">I</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is an 
invariant set of this system. This section formalises these concepts with a focus on hybrid 
systems (HS) verification.›</span></span>

<span class="keyword1"><span class="command">theory</span></span> HS_ODEs
  <span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="HS_Preliminaries.html">HS_Preliminaries</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹ Initial value problems and orbits ›</span></span>

<span class="keyword1"><span class="command">notation</span></span> image <span class="main">(</span><span class="quoted">"<span class="keyword1">𝒫</span>"</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> image_le_pred<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">𝒫</span> <span class="free">f</span> <span class="free">A</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="free">G</span> <span class="bound">s</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="free">G</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> image_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ivp_sols</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>real <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>real_normed_vector<span class="main">)</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> real set<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> set <span class="main">⇒</span> 
  real <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span>real <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">)</span> set"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">Sols</span>"</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">Sols</span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">X</span></span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">→</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">.</span> <span class="main">(</span><span class="keyword1">D</span> <span class="bound">X</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">t</span> <span class="main">(</span><span class="bound">X</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">on</span> <span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">∧</span> <span class="bound">X</span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ivp_solsI<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">D</span> <span class="free">X</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">f</span> <span class="bound">t</span> <span class="main">(</span><span class="free">X</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> <span class="free">s</span>"</span></span> 
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">∈</span> <span class="free">U</span> <span class="free">s</span> <span class="main">→</span> <span class="free">S</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∈</span> <span class="free">U</span> <span class="free">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">∈</span> <span class="keyword1">Sols</span> <span class="free">f</span> <span class="free">U</span> <span class="free">S</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> ivp_sols_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> ivp_solsD<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">∈</span> <span class="keyword1">Sols</span> <span class="free">f</span> <span class="free">U</span> <span class="free">S</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">D</span> <span class="free">X</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">f</span> <span class="bound">t</span> <span class="main">(</span><span class="free">X</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> <span class="free">s</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">∈</span> <span class="free">U</span> <span class="free">s</span> <span class="main">→</span> <span class="free">S</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∈</span> <span class="free">U</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> ivp_sols_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> in_ivp_sols_subset<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∈</span> <span class="main">(</span><span class="free">U</span> <span class="free">s</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">U</span> <span class="free">s</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">(</span><span class="free">T</span> <span class="free">s</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">X</span> <span class="main">∈</span> <span class="keyword1">Sols</span> <span class="free">f</span> <span class="free">T</span> <span class="free">S</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">s</span> <span class="main">⟹</span> <span class="free">X</span> <span class="main">∈</span> <span class="keyword1">Sols</span> <span class="free">f</span> <span class="free">U</span> <span class="free">S</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">s</span> "</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ivp_solsI<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> ivp_solsD<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> has_vderiv_on_subset 
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule</span> ivp_solsD<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">down</span> <span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="bound"><span class="bound">τ</span></span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">U</span></span></span><span class="main">.</span> <span class="bound">τ</span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">g_orbit</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>ord<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'b</span> set"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">γ</span>"</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">γ</span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="main">=</span> <span class="main">⋃</span><span class="main">{</span><span class="keyword1">𝒫</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">(</span>down <span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="bound">t</span><span class="main">)</span> <span class="main">|</span><span class="bound">t</span><span class="main">.</span> <span class="keyword1">𝒫</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">(</span>down <span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="bound">t</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="bound">s</span><span class="main">}</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> g_orbit_eq<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">X</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>preorder<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">γ</span> <span class="free">X</span> <span class="free">G</span> <span class="free">U</span> <span class="main">=</span> <span class="main">{</span><span class="free">X</span> <span class="bound">t</span> <span class="main">|</span><span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> <span class="free">U</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">τ</span><span class="main">∈</span>down <span class="free">U</span> <span class="bound">t</span><span class="main">.</span> <span class="free">G</span> <span class="main">(</span><span class="free">X</span> <span class="bound">τ</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> g_orbit_def <span class="keyword1"><span class="command">using</span></span> order_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">g_orbital</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>real <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> real set<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> set <span class="main">⇒</span> real <span class="main">⇒</span> 
  <span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>real_normed_vector<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> set"</span></span> 
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">g_orbital</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="main">⋃</span><span class="main">{</span><span class="keyword1">γ</span> <span class="bound">X</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">|</span><span class="bound">X</span><span class="main">.</span> <span class="bound">X</span> <span class="main">∈</span> ivp_sols <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> g_orbital_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"g_orbital <span class="free">f</span> <span class="free">G</span> <span class="free">U</span> <span class="free">S</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">s</span> <span class="main">=</span> 
  <span class="main">{</span><span class="bound">X</span> <span class="bound">t</span> <span class="main">|</span><span class="bound">t</span> <span class="bound">X</span><span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> <span class="free">U</span> <span class="free">s</span> <span class="main">∧</span> <span class="keyword1">𝒫</span> <span class="bound">X</span> <span class="main">(</span>down <span class="main">(</span><span class="free">U</span> <span class="free">s</span><span class="main">)</span> <span class="bound">t</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="free">G</span> <span class="bound">s</span><span class="main">}</span> <span class="main">∧</span> <span class="bound">X</span> <span class="main">∈</span> <span class="keyword1">Sols</span> <span class="free">f</span> <span class="free">U</span> <span class="free">S</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">s</span> <span class="main">}</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> g_orbital_def ivp_sols_def g_orbit_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> g_orbitalI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">∈</span> <span class="keyword1">Sols</span> <span class="free">f</span> <span class="free">U</span> <span class="free">S</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> <span class="free">U</span> <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">𝒫</span> <span class="free">X</span> <span class="main">(</span>down <span class="main">(</span><span class="free">U</span> <span class="free">s</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="free">G</span> <span class="bound">s</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="free">t</span> <span class="main">∈</span> g_orbital <span class="free">f</span> <span class="free">G</span> <span class="free">U</span> <span class="free">S</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> g_orbital_eq<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> g_orbitalD<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">s'</span> <span class="main">∈</span> g_orbital <span class="free">f</span> <span class="free">G</span> <span class="free">U</span> <span class="free">S</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">X</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">t</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">∈</span> <span class="keyword1">Sols</span> <span class="free">f</span> <span class="free">U</span> <span class="free">S</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="free">t</span> <span class="main">=</span> <span class="free">s'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> <span class="free">U</span> <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">𝒫</span> <span class="free">X</span> <span class="main">(</span>down <span class="main">(</span><span class="free">U</span> <span class="free">s</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="free">G</span> <span class="bound">s</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> g_orbital_def g_orbit_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"g_orbital <span class="free">f</span> <span class="free">G</span> <span class="free">U</span> <span class="free">S</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">s</span> <span class="main">=</span> <span class="main">{</span><span class="bound">X</span> <span class="bound">t</span> <span class="main">|</span><span class="bound">t</span> <span class="bound">X</span><span class="main">.</span> <span class="bound">X</span> <span class="bound">t</span> <span class="main">∈</span> <span class="keyword1">γ</span> <span class="bound">X</span> <span class="free">G</span> <span class="main">(</span><span class="free">U</span> <span class="free">s</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">X</span> <span class="main">∈</span> <span class="keyword1">Sols</span> <span class="free">f</span> <span class="free">U</span> <span class="free">S</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">s</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> g_orbital_eq g_orbit_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">∈</span> <span class="keyword1">Sols</span> <span class="free">f</span> <span class="free">U</span> <span class="free">S</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">s</span> <span class="main">⟹</span> <span class="keyword1">γ</span> <span class="free">X</span> <span class="free">G</span> <span class="main">(</span><span class="free">U</span> <span class="free">s</span><span class="main">)</span> <span class="main">⊆</span> g_orbital <span class="free">f</span> <span class="free">G</span> <span class="free">U</span> <span class="free">S</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> g_orbital_eq g_orbit_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"g_orbital <span class="free">f</span> <span class="free">G</span> <span class="free">U</span> <span class="free">S</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">s</span> <span class="main">⊆</span> g_orbital <span class="free">f</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> True<span class="main">)</span> <span class="free">U</span> <span class="free">S</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> g_orbital_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">no_notation</span></span> g_orbit <span class="main">(</span><span class="quoted">"<span class="keyword1">γ</span>"</span><span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹ Differential Invariants ›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">diff_invariant</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span>real <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>real_normed_vector<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">⇒</span> 
  <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> real set<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> set <span class="main">⇒</span> real <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> bool"</span></span> 
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">diff_invariant</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">⋃</span> <span class="main">∘</span> <span class="main">(</span><span class="keyword1">𝒫</span> <span class="main">(</span>g_orbital <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="bound">s</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="bound">s</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> diff_invariant_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"diff_invariant <span class="free">I</span> <span class="free">f</span> <span class="free">U</span> <span class="free">S</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">G</span> <span class="main">=</span> 
  <span class="main">(</span><span class="main">∀</span><span class="bound">s</span><span class="main">.</span> <span class="free">I</span> <span class="bound">s</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">X</span><span class="main">∈</span><span class="keyword1">Sols</span> <span class="free">f</span> <span class="free">U</span> <span class="free">S</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">s</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">t</span><span class="main">∈</span><span class="free">U</span> <span class="bound">s</span><span class="main">.</span><span class="main">(</span><span class="main">∀</span><span class="bound">τ</span><span class="main">∈</span><span class="main">(</span>down <span class="main">(</span><span class="free">U</span> <span class="bound">s</span><span class="main">)</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> <span class="free">G</span> <span class="main">(</span><span class="bound">X</span> <span class="bound">τ</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">I</span> <span class="main">(</span><span class="bound">X</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> diff_invariant_def g_orbital_eq image_le_pred <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> diff_inv_eq_inv_set<span class="main">:</span>
  <span class="quoted"><span class="quoted">"diff_invariant <span class="free">I</span> <span class="free">f</span> <span class="free">U</span> <span class="free">S</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">G</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">s</span><span class="main">.</span> <span class="free">I</span> <span class="bound">s</span> <span class="main">⟶</span> <span class="main">(</span>g_orbital <span class="free">f</span> <span class="free">G</span> <span class="free">U</span> <span class="free">S</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">s</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="free">I</span> <span class="bound">s</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> diff_invariant_eq g_orbital_eq image_le_pred <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"diff_invariant <span class="free">I</span> <span class="free">f</span> <span class="free">U</span> <span class="free">S</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> True<span class="main">)</span> <span class="main">⟹</span> diff_invariant <span class="free">I</span> <span class="free">f</span> <span class="free">U</span> <span class="free">S</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">G</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> diff_invariant_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">named_theorems</span></span> diff_invariant_rules <span class="quoted">"rules for certifying differential invariants."</span>

<span class="keyword1"><span class="command">lemma</span></span> diff_invariant_eq_rule <span class="main">[</span><span class="operator">diff_invariant_rules</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> Uhyp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> is_interval <span class="main">(</span><span class="free">U</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> dX<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">X</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">D</span> <span class="bound">X</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">τ</span><span class="main">.</span> <span class="free">f</span> <span class="bound">τ</span> <span class="main">(</span><span class="bound">X</span> <span class="bound">τ</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">on</span> <span class="free">U</span><span class="main">(</span><span class="bound">X</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="keyword1">D</span> <span class="main">(</span><span class="main">λ</span><span class="bound">τ</span><span class="main">.</span> <span class="free">μ</span><span class="main">(</span><span class="bound">X</span> <span class="bound">τ</span><span class="main">)</span><span class="main">-</span><span class="free">ν</span><span class="main">(</span><span class="bound">X</span> <span class="bound">τ</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">(*<span class="hidden">⇩</span><sub>R</sub>)</span> <span class="main">0</span><span class="main">)</span> <span class="keyword1">on</span> <span class="free">U</span><span class="main">(</span><span class="bound">X</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"diff_invariant <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">μ</span> <span class="bound">s</span> <span class="main">=</span> <span class="free">ν</span> <span class="bound">s</span><span class="main">)</span> <span class="free">f</span> <span class="free">U</span> <span class="free">S</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">G</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> diff_invariant_eq ivp_sols_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">X</span> <span class="skolem">t</span> 
  <span class="keyword3"><span class="command">assume</span></span> xivp<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="keyword1">D</span> <span class="skolem">X</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">τ</span><span class="main">.</span> <span class="free">f</span> <span class="bound">τ</span> <span class="main">(</span><span class="skolem">X</span> <span class="bound">τ</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="main">(</span><span class="skolem">X</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">μ</span> <span class="main">(</span><span class="skolem">X</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">=</span> <span class="free">ν</span> <span class="main">(</span><span class="skolem">X</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> <span class="free">U</span> <span class="main">(</span><span class="skolem">X</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">→</span> <span class="free">S</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> tHyp<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> <span class="free">U</span> <span class="main">(</span><span class="skolem">X</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> t0Hyp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∈</span> <span class="free">U</span> <span class="main">(</span><span class="skolem">X</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">--</span><span class="skolem">t</span><span class="main">}</span> <span class="main">⊆</span> <span class="free">U</span> <span class="main">(</span><span class="skolem">X</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> closed_segment_subset_interval<span class="main">[</span><span class="operator">OF</span> Uhyp t0Hyp tHyp<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">D</span> <span class="main">(</span><span class="main">λ</span><span class="bound">τ</span><span class="main">.</span> <span class="free">μ</span> <span class="main">(</span><span class="skolem">X</span> <span class="bound">τ</span><span class="main">)</span> <span class="main">-</span> <span class="free">ν</span> <span class="main">(</span><span class="skolem">X</span> <span class="bound">τ</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">τ</span><span class="main">.</span> <span class="bound">τ</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">0</span><span class="main">)</span> <span class="keyword1">on</span> <span class="main">{</span><span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">--</span><span class="skolem">t</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> has_vderiv_on_subset<span class="main">[</span><span class="operator">OF</span> dX<span class="main"><span class="main">[</span></span><span class="operator">OF</span> xivp<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">τ</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">μ</span> <span class="main">(</span><span class="skolem">X</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">-</span> <span class="free">ν</span> <span class="main">(</span><span class="skolem">X</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span><span class="free">μ</span> <span class="main">(</span><span class="skolem">X</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">-</span> <span class="free">ν</span> <span class="main">(</span><span class="skolem">X</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">t</span> <span class="main">-</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">*</span> <span class="skolem">τ</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> mvt_very_simple_closed_segmentE <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">μ</span> <span class="main">(</span><span class="skolem">X</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">=</span> <span class="free">ν</span> <span class="main">(</span><span class="skolem">X</span> <span class="skolem">t</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> xivp<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> diff_invariant_leq_rule <span class="main">[</span><span class="operator">diff_invariant_rules</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">μ</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>banach <span class="main">⇒</span> real"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> Uhyp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> is_interval <span class="main">(</span><span class="free">U</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> Gg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">X</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">D</span> <span class="bound">X</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">τ</span><span class="main">.</span> <span class="free">f</span> <span class="bound">τ</span> <span class="main">(</span><span class="bound">X</span> <span class="bound">τ</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">on</span> <span class="free">U</span><span class="main">(</span><span class="bound">X</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">∀</span><span class="bound">τ</span><span class="main">∈</span><span class="free">U</span><span class="main">(</span><span class="bound">X</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span><span class="main">.</span> <span class="bound">τ</span> <span class="main">&gt;</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">⟶</span> <span class="free">G</span> <span class="main">(</span><span class="bound">X</span> <span class="bound">τ</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">μ'</span> <span class="main">(</span><span class="bound">X</span> <span class="bound">τ</span><span class="main">)</span> <span class="main">≥</span> <span class="free">ν'</span> <span class="main">(</span><span class="bound">X</span> <span class="bound">τ</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> Gl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">X</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">D</span> <span class="bound">X</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">τ</span><span class="main">.</span> <span class="free">f</span> <span class="bound">τ</span> <span class="main">(</span><span class="bound">X</span> <span class="bound">τ</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">on</span> <span class="free">U</span><span class="main">(</span><span class="bound">X</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">∀</span><span class="bound">τ</span><span class="main">∈</span><span class="free">U</span><span class="main">(</span><span class="bound">X</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span><span class="main">.</span> <span class="bound">τ</span> <span class="main">&lt;</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">⟶</span> <span class="free">μ'</span> <span class="main">(</span><span class="bound">X</span> <span class="bound">τ</span><span class="main">)</span> <span class="main">≤</span> <span class="free">ν'</span> <span class="main">(</span><span class="bound">X</span> <span class="bound">τ</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> dX<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">X</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">D</span> <span class="bound">X</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">τ</span><span class="main">.</span> <span class="free">f</span> <span class="bound">τ</span> <span class="main">(</span><span class="bound">X</span> <span class="bound">τ</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">on</span> <span class="free">U</span><span class="main">(</span><span class="bound">X</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="keyword1">D</span> <span class="main">(</span><span class="main">λ</span><span class="bound">τ</span><span class="main">.</span> <span class="free">μ</span><span class="main">(</span><span class="bound">X</span> <span class="bound">τ</span><span class="main">)</span><span class="main">-</span><span class="free">ν</span><span class="main">(</span><span class="bound">X</span> <span class="bound">τ</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">τ</span><span class="main">.</span> <span class="free">μ'</span><span class="main">(</span><span class="bound">X</span> <span class="bound">τ</span><span class="main">)</span><span class="main">-</span><span class="free">ν'</span><span class="main">(</span><span class="bound">X</span> <span class="bound">τ</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">on</span> <span class="free">U</span><span class="main">(</span><span class="bound">X</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"diff_invariant <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">ν</span> <span class="bound">s</span> <span class="main">≤</span> <span class="free">μ</span> <span class="bound">s</span><span class="main">)</span> <span class="free">f</span> <span class="free">U</span> <span class="free">S</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">G</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> diff_invariant_eq ivp_sols_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">X</span> <span class="skolem">t</span> <span class="keyword3"><span class="command">assume</span></span> Ghyp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">τ</span><span class="main">.</span> <span class="bound">τ</span> <span class="main">∈</span> <span class="free">U</span> <span class="main">(</span><span class="skolem">X</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">∧</span> <span class="bound">τ</span> <span class="main">≤</span> <span class="skolem">t</span> <span class="main">⟶</span> <span class="free">G</span> <span class="main">(</span><span class="skolem">X</span> <span class="bound">τ</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> xivp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">D</span> <span class="skolem">X</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">(</span><span class="skolem">X</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="main">(</span><span class="skolem">X</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">ν</span> <span class="main">(</span><span class="skolem">X</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">≤</span> <span class="free">μ</span> <span class="main">(</span><span class="skolem">X</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> <span class="free">U</span> <span class="main">(</span><span class="skolem">X</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">→</span> <span class="free">S</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> tHyp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> <span class="free">U</span> <span class="main">(</span><span class="skolem">X</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> t0Hyp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∈</span> <span class="free">U</span> <span class="main">(</span><span class="skolem">X</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">hence</span></span> obs1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">--</span><span class="skolem">t</span><span class="main">}</span> <span class="main">⊆</span> <span class="free">U</span> <span class="main">(</span><span class="skolem">X</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">&lt;--&lt;</span><span class="skolem">t</span><span class="main">}</span> <span class="main">⊆</span> <span class="free">U</span> <span class="main">(</span><span class="skolem">X</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> closed_segment_subset_interval<span class="main">[</span><span class="operator">OF</span> Uhyp t0Hyp tHyp<span class="main">]</span> xivp<span class="main">(</span>3<span class="main">)</span> segment_open_subset_closed
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> PiE <span class="quoted"><span class="quoted">‹<span class="skolem">X</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> <span class="main">{</span><span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">--</span><span class="skolem">t</span><span class="main">}</span> <span class="main">⊆</span> <span class="free">U</span> <span class="main">(</span><span class="skolem">X</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span>›</span></span> dual_order.trans<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> obs2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">D</span> <span class="main">(</span><span class="main">λ</span><span class="bound">τ</span><span class="main">.</span> <span class="free">μ</span> <span class="main">(</span><span class="skolem">X</span> <span class="bound">τ</span><span class="main">)</span> <span class="main">-</span> <span class="free">ν</span> <span class="main">(</span><span class="skolem">X</span> <span class="bound">τ</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">τ</span><span class="main">.</span> <span class="free">μ'</span> <span class="main">(</span><span class="skolem">X</span> <span class="bound">τ</span><span class="main">)</span> <span class="main">-</span> <span class="free">ν'</span> <span class="main">(</span><span class="skolem">X</span> <span class="bound">τ</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">on</span> <span class="main">{</span><span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">--</span><span class="skolem">t</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> has_vderiv_on_subset<span class="main">[</span><span class="operator">OF</span> dX<span class="main"><span class="main">[</span></span><span class="operator">OF</span> xivp<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">≠</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> rHyp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> <span class="main">{</span><span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">&lt;--&lt;</span><span class="skolem">t</span><span class="main">}</span>"</span></span> 
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">μ</span><span class="main">(</span><span class="skolem">X</span> <span class="skolem">t</span><span class="main">)</span><span class="main">-</span><span class="free">ν</span><span class="main">(</span><span class="skolem">X</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span><span class="free">μ</span><span class="main">(</span><span class="skolem">X</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span><span class="main">-</span><span class="free">ν</span><span class="main">(</span><span class="skolem">X</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">τ</span><span class="main">.</span> <span class="bound">τ</span><span class="main">*</span><span class="main">(</span><span class="free">μ'</span><span class="main">(</span><span class="skolem">X</span> <span class="skolem">r</span><span class="main">)</span><span class="main">-</span><span class="free">ν'</span><span class="main">(</span><span class="skolem">X</span> <span class="skolem">r</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">t</span> <span class="main">-</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> mvt_simple_closed_segmentE obs2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">hence</span></span> mvt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">μ</span><span class="main">(</span><span class="skolem">X</span> <span class="skolem">t</span><span class="main">)</span><span class="main">-</span><span class="free">ν</span><span class="main">(</span><span class="skolem">X</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">t</span> <span class="main">-</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span><span class="main">*</span><span class="main">(</span><span class="free">μ'</span><span class="main">(</span><span class="skolem">X</span> <span class="skolem">r</span><span class="main">)</span><span class="main">-</span><span class="free">ν'</span><span class="main">(</span><span class="skolem">X</span> <span class="skolem">r</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">μ</span><span class="main">(</span><span class="skolem">X</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span><span class="main">-</span><span class="free">ν</span><span class="main">(</span><span class="skolem">X</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">have</span></span> primed<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">τ</span><span class="main">.</span> <span class="bound">τ</span> <span class="main">∈</span> <span class="free">U</span> <span class="main">(</span><span class="skolem">X</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">τ</span> <span class="main">&gt;</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">⟹</span> <span class="free">G</span> <span class="main">(</span><span class="skolem">X</span> <span class="bound">τ</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">μ'</span> <span class="main">(</span><span class="skolem">X</span> <span class="bound">τ</span><span class="main">)</span> <span class="main">≥</span> <span class="free">ν'</span> <span class="main">(</span><span class="skolem">X</span> <span class="bound">τ</span><span class="main">)</span>"</span></span> 
      <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">τ</span><span class="main">.</span> <span class="bound">τ</span> <span class="main">∈</span> <span class="free">U</span> <span class="main">(</span><span class="skolem">X</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">τ</span> <span class="main">&lt;</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">⟹</span> <span class="free">μ'</span> <span class="main">(</span><span class="skolem">X</span> <span class="bound">τ</span><span class="main">)</span> <span class="main">≤</span> <span class="free">ν'</span> <span class="main">(</span><span class="skolem">X</span> <span class="bound">τ</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Gg<span class="main">[</span><span class="operator">OF</span> xivp<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> Gl<span class="main">[</span><span class="operator">OF</span> xivp<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">&gt;</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">⟹</span> <span class="skolem">r</span> <span class="main">&gt;</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∧</span> <span class="free">G</span> <span class="main">(</span><span class="skolem">X</span> <span class="skolem">r</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">≤</span> <span class="skolem">t</span> <span class="main">⟹</span> <span class="skolem">r</span> <span class="main">&lt;</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> <span class="free">U</span> <span class="main">(</span><span class="skolem">X</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">∈</span> <span class="main">{</span><span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">&lt;--&lt;</span><span class="skolem">t</span><span class="main">}</span>›</span></span> obs1 Ghyp
      <span class="keyword1"><span class="command">unfolding</span></span> open_segment_eq_real_ivl closed_segment_eq_real_ivl <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">&gt;</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">⟹</span> <span class="free">G</span> <span class="main">(</span><span class="skolem">X</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">μ'</span><span class="main">(</span><span class="skolem">X</span> <span class="skolem">r</span><span class="main">)</span><span class="main">-</span> <span class="free">ν'</span><span class="main">(</span><span class="skolem">X</span> <span class="skolem">r</span><span class="main">)</span><span class="main">)</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">&lt;</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">⟹</span> <span class="main">(</span><span class="free">μ'</span><span class="main">(</span><span class="skolem">X</span> <span class="skolem">r</span><span class="main">)</span><span class="main">-</span><span class="free">ν'</span><span class="main">(</span><span class="skolem">X</span> <span class="skolem">r</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> primed<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted"><span class="quoted">‹<span class="skolem"><span class="skolem">r</span></span> <span class="main"><span class="main">∈</span></span> <span class="free"><span class="free">U</span></span> <span class="main"><span class="main">(</span></span><span class="skolem"><span class="skolem">X</span></span> <span class="free"><span class="free">t<span class="hidden">⇩</span><sub>0</sub></span></span><span class="main"><span class="main">)</span></span>›</span></span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t</span> <span class="main">-</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">μ'</span><span class="main">(</span><span class="skolem">X</span> <span class="skolem">r</span><span class="main">)</span><span class="main">-</span><span class="free">ν'</span><span class="main">(</span><span class="skolem">X</span> <span class="skolem">r</span><span class="main">)</span><span class="main">)</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">≥</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> split_mult_pos_le<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t</span> <span class="main">-</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">μ'</span><span class="main">(</span><span class="skolem">X</span> <span class="skolem">r</span><span class="main">)</span><span class="main">-</span><span class="free">ν'</span><span class="main">(</span><span class="skolem">X</span> <span class="skolem">r</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">μ</span><span class="main">(</span><span class="skolem">X</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span><span class="main">-</span><span class="free">ν</span><span class="main">(</span><span class="skolem">X</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> xivp<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">ν</span> <span class="main">(</span><span class="skolem">X</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">≤</span> <span class="free">μ</span> <span class="main">(</span><span class="skolem">X</span> <span class="skolem">t</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> mvt <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span><span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">ν</span> <span class="main">(</span><span class="skolem">X</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">≤</span> <span class="free">μ</span> <span class="main">(</span><span class="skolem">X</span> <span class="skolem">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> xivp <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> diff_invariant_less_rule <span class="main">[</span><span class="operator">diff_invariant_rules</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">μ</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>banach <span class="main">⇒</span> real"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> Uhyp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> is_interval <span class="main">(</span><span class="free">U</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> Gg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">X</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">D</span> <span class="bound">X</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">τ</span><span class="main">.</span> <span class="free">f</span> <span class="bound">τ</span> <span class="main">(</span><span class="bound">X</span> <span class="bound">τ</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">on</span> <span class="free">U</span><span class="main">(</span><span class="bound">X</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">∀</span><span class="bound">τ</span><span class="main">∈</span><span class="free">U</span><span class="main">(</span><span class="bound">X</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span><span class="main">.</span> <span class="bound">τ</span> <span class="main">&gt;</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">⟶</span> <span class="free">G</span> <span class="main">(</span><span class="bound">X</span> <span class="bound">τ</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">μ'</span> <span class="main">(</span><span class="bound">X</span> <span class="bound">τ</span><span class="main">)</span> <span class="main">≥</span> <span class="free">ν'</span> <span class="main">(</span><span class="bound">X</span> <span class="bound">τ</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> Gl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">X</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">D</span> <span class="bound">X</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">τ</span><span class="main">.</span> <span class="free">f</span> <span class="bound">τ</span> <span class="main">(</span><span class="bound">X</span> <span class="bound">τ</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">on</span> <span class="free">U</span><span class="main">(</span><span class="bound">X</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">∀</span><span class="bound">τ</span><span class="main">∈</span><span class="free">U</span><span class="main">(</span><span class="bound">X</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span><span class="main">.</span> <span class="bound">τ</span> <span class="main">&lt;</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">⟶</span> <span class="free">μ'</span> <span class="main">(</span><span class="bound">X</span> <span class="bound">τ</span><span class="main">)</span> <span class="main">≤</span> <span class="free">ν'</span> <span class="main">(</span><span class="bound">X</span> <span class="bound">τ</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> dX<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">X</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">D</span> <span class="bound">X</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">τ</span><span class="main">.</span> <span class="free">f</span> <span class="bound">τ</span> <span class="main">(</span><span class="bound">X</span> <span class="bound">τ</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">on</span> <span class="free">U</span><span class="main">(</span><span class="bound">X</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="keyword1">D</span> <span class="main">(</span><span class="main">λ</span><span class="bound">τ</span><span class="main">.</span> <span class="free">μ</span><span class="main">(</span><span class="bound">X</span> <span class="bound">τ</span><span class="main">)</span><span class="main">-</span><span class="free">ν</span><span class="main">(</span><span class="bound">X</span> <span class="bound">τ</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">τ</span><span class="main">.</span> <span class="free">μ'</span><span class="main">(</span><span class="bound">X</span> <span class="bound">τ</span><span class="main">)</span><span class="main">-</span><span class="free">ν'</span><span class="main">(</span><span class="bound">X</span> <span class="bound">τ</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">on</span> <span class="free">U</span><span class="main">(</span><span class="bound">X</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"diff_invariant <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">ν</span> <span class="bound">s</span> <span class="main">&lt;</span> <span class="free">μ</span> <span class="bound">s</span><span class="main">)</span> <span class="free">f</span> <span class="free">U</span> <span class="free">S</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">G</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> diff_invariant_eq ivp_sols_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">X</span> <span class="skolem">t</span> <span class="keyword3"><span class="command">assume</span></span> Ghyp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">τ</span><span class="main">.</span> <span class="bound">τ</span> <span class="main">∈</span> <span class="free">U</span> <span class="main">(</span><span class="skolem">X</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">∧</span> <span class="bound">τ</span> <span class="main">≤</span> <span class="skolem">t</span> <span class="main">⟶</span> <span class="free">G</span> <span class="main">(</span><span class="skolem">X</span> <span class="bound">τ</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> xivp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">D</span> <span class="skolem">X</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">(</span><span class="skolem">X</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="main">(</span><span class="skolem">X</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">ν</span> <span class="main">(</span><span class="skolem">X</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">&lt;</span> <span class="free">μ</span> <span class="main">(</span><span class="skolem">X</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> <span class="free">U</span> <span class="main">(</span><span class="skolem">X</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">→</span> <span class="free">S</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> tHyp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> <span class="free">U</span> <span class="main">(</span><span class="skolem">X</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> t0Hyp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∈</span> <span class="free">U</span> <span class="main">(</span><span class="skolem">X</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">hence</span></span> obs1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">--</span><span class="skolem">t</span><span class="main">}</span> <span class="main">⊆</span> <span class="free">U</span> <span class="main">(</span><span class="skolem">X</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">&lt;--&lt;</span><span class="skolem">t</span><span class="main">}</span> <span class="main">⊆</span> <span class="free">U</span> <span class="main">(</span><span class="skolem">X</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> closed_segment_subset_interval<span class="main">[</span><span class="operator">OF</span> Uhyp t0Hyp tHyp<span class="main">]</span> xivp<span class="main">(</span>3<span class="main">)</span> segment_open_subset_closed
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> PiE <span class="quoted"><span class="quoted">‹<span class="skolem">X</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> <span class="main">{</span><span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">--</span><span class="skolem">t</span><span class="main">}</span> <span class="main">⊆</span> <span class="free">U</span> <span class="main">(</span><span class="skolem">X</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span>›</span></span> dual_order.trans<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> obs2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">D</span> <span class="main">(</span><span class="main">λ</span><span class="bound">τ</span><span class="main">.</span> <span class="free">μ</span> <span class="main">(</span><span class="skolem">X</span> <span class="bound">τ</span><span class="main">)</span> <span class="main">-</span> <span class="free">ν</span> <span class="main">(</span><span class="skolem">X</span> <span class="bound">τ</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">τ</span><span class="main">.</span> <span class="free">μ'</span> <span class="main">(</span><span class="skolem">X</span> <span class="bound">τ</span><span class="main">)</span> <span class="main">-</span> <span class="free">ν'</span> <span class="main">(</span><span class="skolem">X</span> <span class="bound">τ</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">on</span> <span class="main">{</span><span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">--</span><span class="skolem">t</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> has_vderiv_on_subset<span class="main">[</span><span class="operator">OF</span> dX<span class="main"><span class="main">[</span></span><span class="operator">OF</span> xivp<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">≠</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> rHyp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> <span class="main">{</span><span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">&lt;--&lt;</span><span class="skolem">t</span><span class="main">}</span>"</span></span> 
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">μ</span><span class="main">(</span><span class="skolem">X</span> <span class="skolem">t</span><span class="main">)</span><span class="main">-</span><span class="free">ν</span><span class="main">(</span><span class="skolem">X</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span><span class="free">μ</span><span class="main">(</span><span class="skolem">X</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span><span class="main">-</span><span class="free">ν</span><span class="main">(</span><span class="skolem">X</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">τ</span><span class="main">.</span> <span class="bound">τ</span><span class="main">*</span><span class="main">(</span><span class="free">μ'</span><span class="main">(</span><span class="skolem">X</span> <span class="skolem">r</span><span class="main">)</span><span class="main">-</span><span class="free">ν'</span><span class="main">(</span><span class="skolem">X</span> <span class="skolem">r</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">t</span> <span class="main">-</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> mvt_simple_closed_segmentE obs2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">hence</span></span> mvt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">μ</span><span class="main">(</span><span class="skolem">X</span> <span class="skolem">t</span><span class="main">)</span><span class="main">-</span><span class="free">ν</span><span class="main">(</span><span class="skolem">X</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">t</span> <span class="main">-</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span><span class="main">*</span><span class="main">(</span><span class="free">μ'</span><span class="main">(</span><span class="skolem">X</span> <span class="skolem">r</span><span class="main">)</span><span class="main">-</span><span class="free">ν'</span><span class="main">(</span><span class="skolem">X</span> <span class="skolem">r</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">μ</span><span class="main">(</span><span class="skolem">X</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span><span class="main">-</span><span class="free">ν</span><span class="main">(</span><span class="skolem">X</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">have</span></span> primed<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">τ</span><span class="main">.</span> <span class="bound">τ</span> <span class="main">∈</span> <span class="free">U</span> <span class="main">(</span><span class="skolem">X</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">τ</span> <span class="main">&gt;</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">⟹</span> <span class="free">G</span> <span class="main">(</span><span class="skolem">X</span> <span class="bound">τ</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">μ'</span> <span class="main">(</span><span class="skolem">X</span> <span class="bound">τ</span><span class="main">)</span> <span class="main">≥</span> <span class="free">ν'</span> <span class="main">(</span><span class="skolem">X</span> <span class="bound">τ</span><span class="main">)</span>"</span></span> 
      <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">τ</span><span class="main">.</span> <span class="bound">τ</span> <span class="main">∈</span> <span class="free">U</span> <span class="main">(</span><span class="skolem">X</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">τ</span> <span class="main">&lt;</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">⟹</span> <span class="free">μ'</span> <span class="main">(</span><span class="skolem">X</span> <span class="bound">τ</span><span class="main">)</span> <span class="main">≤</span> <span class="free">ν'</span> <span class="main">(</span><span class="skolem">X</span> <span class="bound">τ</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Gg<span class="main">[</span><span class="operator">OF</span> xivp<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> Gl<span class="main">[</span><span class="operator">OF</span> xivp<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">&gt;</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">⟹</span> <span class="skolem">r</span> <span class="main">&gt;</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∧</span> <span class="free">G</span> <span class="main">(</span><span class="skolem">X</span> <span class="skolem">r</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">≤</span> <span class="skolem">t</span> <span class="main">⟹</span> <span class="skolem">r</span> <span class="main">&lt;</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> <span class="free">U</span> <span class="main">(</span><span class="skolem">X</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">∈</span> <span class="main">{</span><span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">&lt;--&lt;</span><span class="skolem">t</span><span class="main">}</span>›</span></span> obs1 Ghyp
      <span class="keyword1"><span class="command">unfolding</span></span> open_segment_eq_real_ivl closed_segment_eq_real_ivl <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">&gt;</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">⟹</span> <span class="free">G</span> <span class="main">(</span><span class="skolem">X</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">μ'</span><span class="main">(</span><span class="skolem">X</span> <span class="skolem">r</span><span class="main">)</span><span class="main">-</span> <span class="free">ν'</span><span class="main">(</span><span class="skolem">X</span> <span class="skolem">r</span><span class="main">)</span><span class="main">)</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">&lt;</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">⟹</span> <span class="main">(</span><span class="free">μ'</span><span class="main">(</span><span class="skolem">X</span> <span class="skolem">r</span><span class="main">)</span><span class="main">-</span><span class="free">ν'</span><span class="main">(</span><span class="skolem">X</span> <span class="skolem">r</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> primed<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted"><span class="quoted">‹<span class="skolem"><span class="skolem">r</span></span> <span class="main"><span class="main">∈</span></span> <span class="free"><span class="free">U</span></span> <span class="main"><span class="main">(</span></span><span class="skolem"><span class="skolem">X</span></span> <span class="free"><span class="free">t<span class="hidden">⇩</span><sub>0</sub></span></span><span class="main"><span class="main">)</span></span>›</span></span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t</span> <span class="main">-</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">μ'</span><span class="main">(</span><span class="skolem">X</span> <span class="skolem">r</span><span class="main">)</span><span class="main">-</span><span class="free">ν'</span><span class="main">(</span><span class="skolem">X</span> <span class="skolem">r</span><span class="main">)</span><span class="main">)</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">≥</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> split_mult_pos_le<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t</span> <span class="main">-</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">μ'</span><span class="main">(</span><span class="skolem">X</span> <span class="skolem">r</span><span class="main">)</span><span class="main">-</span><span class="free">ν'</span><span class="main">(</span><span class="skolem">X</span> <span class="skolem">r</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">μ</span><span class="main">(</span><span class="skolem">X</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span><span class="main">-</span><span class="free">ν</span><span class="main">(</span><span class="skolem">X</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> xivp<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">ν</span> <span class="main">(</span><span class="skolem">X</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">&lt;</span> <span class="free">μ</span> <span class="main">(</span><span class="skolem">X</span> <span class="skolem">t</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> mvt <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span><span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">ν</span> <span class="main">(</span><span class="skolem">X</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">&lt;</span> <span class="free">μ</span> <span class="main">(</span><span class="skolem">X</span> <span class="skolem">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> xivp <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> diff_invariant_nleq_rule<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">μ</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>banach <span class="main">⇒</span> real"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"diff_invariant <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">¬</span> <span class="free">ν</span> <span class="bound">s</span> <span class="main">≤</span> <span class="free">μ</span> <span class="bound">s</span><span class="main">)</span> <span class="free">f</span> <span class="free">U</span> <span class="free">S</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">G</span> <span class="main">⟷</span> diff_invariant <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">ν</span> <span class="bound">s</span> <span class="main">&gt;</span> <span class="free">μ</span> <span class="bound">s</span><span class="main">)</span> <span class="free">f</span> <span class="free">U</span> <span class="free">S</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">G</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> diff_invariant_eq <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">clarsimp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper"><span class="quoted"><span class="improper">s</span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper"><span class="quoted"><span class="improper">X</span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> ballE<span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> diff_invariant_neq_rule <span class="main">[</span><span class="operator">diff_invariant_rules</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">μ</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>banach <span class="main">⇒</span> real"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"diff_invariant <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">ν</span> <span class="bound">s</span> <span class="main">&lt;</span> <span class="free">μ</span> <span class="bound">s</span><span class="main">)</span> <span class="free">f</span> <span class="free">U</span> <span class="free">S</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">G</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"diff_invariant <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">ν</span> <span class="bound">s</span> <span class="main">&gt;</span> <span class="free">μ</span> <span class="bound">s</span><span class="main">)</span> <span class="free">f</span> <span class="free">U</span> <span class="free">S</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">G</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"diff_invariant <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">ν</span> <span class="bound">s</span> <span class="main">≠</span> <span class="free">μ</span> <span class="bound">s</span><span class="main">)</span> <span class="free">f</span> <span class="free">U</span> <span class="free">S</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">G</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">unfold</span> diff_invariant_eq<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span><span class="main">::</span><span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">X</span><span class="main">::</span><span class="quoted"><span class="quoted">"real <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">t</span><span class="main">::</span><span class="quoted">real</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">ν</span> <span class="skolem">s</span> <span class="main">≠</span> <span class="free">μ</span> <span class="skolem">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> Xhyp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> <span class="keyword1">Sols</span> <span class="free">f</span> <span class="free">U</span> <span class="free">S</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">s</span>"</span></span> 
     <span class="keyword2"><span class="keyword">and</span></span> thyp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> <span class="free">U</span> <span class="skolem">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> Ghyp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">τ</span><span class="main">.</span> <span class="bound">τ</span> <span class="main">∈</span> <span class="free">U</span> <span class="skolem">s</span> <span class="main">∧</span> <span class="bound">τ</span> <span class="main">≤</span> <span class="skolem">t</span> <span class="main">⟶</span> <span class="free">G</span> <span class="main">(</span><span class="skolem">X</span> <span class="bound">τ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">ν</span> <span class="skolem">s</span> <span class="main">&lt;</span> <span class="free">μ</span> <span class="skolem">s</span> <span class="main">∨</span> <span class="free">ν</span> <span class="skolem">s</span> <span class="main">&gt;</span> <span class="free">μ</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">ν</span> <span class="skolem">s</span> <span class="main">&lt;</span> <span class="free">μ</span> <span class="skolem">s</span> <span class="main">⟹</span> <span class="free">ν</span> <span class="main">(</span><span class="skolem">X</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">&lt;</span> <span class="free">μ</span> <span class="main">(</span><span class="skolem">X</span> <span class="skolem">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> Xhyp thyp Ghyp <span class="keyword1"><span class="command">unfolding</span></span> diff_invariant_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">ν</span> <span class="skolem">s</span> <span class="main">&gt;</span> <span class="free">μ</span> <span class="skolem">s</span> <span class="main">⟹</span> <span class="free">ν</span> <span class="main">(</span><span class="skolem">X</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">&gt;</span> <span class="free">μ</span> <span class="main">(</span><span class="skolem">X</span> <span class="skolem">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> Xhyp thyp Ghyp <span class="keyword1"><span class="command">unfolding</span></span> diff_invariant_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">ν</span> <span class="main">(</span><span class="skolem">X</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">=</span> <span class="free">μ</span> <span class="main">(</span><span class="skolem">X</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">⟹</span> False"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> diff_invariant_neq_rule_converse<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">μ</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>banach <span class="main">⇒</span> real"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> Uhyp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> is_interval <span class="main">(</span><span class="free">U</span> <span class="bound">s</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span> <span class="bound">t</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> <span class="bound">t</span> <span class="main">∈</span> <span class="free">U</span> <span class="bound">s</span> <span class="main">⟹</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">≤</span> <span class="bound">t</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> conts<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">X</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">D</span> <span class="bound">X</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">τ</span><span class="main">.</span> <span class="free">f</span> <span class="bound">τ</span> <span class="main">(</span><span class="bound">X</span> <span class="bound">τ</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">on</span> <span class="free">U</span><span class="main">(</span><span class="bound">X</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> continuous_on <span class="main">(</span><span class="keyword1">𝒫</span> <span class="bound">X</span> <span class="main">(</span><span class="free">U</span> <span class="main">(</span><span class="bound">X</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">ν</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">X</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">D</span> <span class="bound">X</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">τ</span><span class="main">.</span> <span class="free">f</span> <span class="bound">τ</span> <span class="main">(</span><span class="bound">X</span> <span class="bound">τ</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">on</span> <span class="free">U</span><span class="main">(</span><span class="bound">X</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> continuous_on <span class="main">(</span><span class="keyword1">𝒫</span> <span class="bound">X</span> <span class="main">(</span><span class="free">U</span> <span class="main">(</span><span class="bound">X</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">μ</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> dI<span class="main">:</span><span class="quoted"><span class="quoted">"diff_invariant <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">ν</span> <span class="bound">s</span> <span class="main">≠</span> <span class="free">μ</span> <span class="bound">s</span><span class="main">)</span> <span class="free">f</span> <span class="free">U</span> <span class="free">S</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">G</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"diff_invariant <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">ν</span> <span class="bound">s</span> <span class="main">&lt;</span> <span class="free">μ</span> <span class="bound">s</span><span class="main">)</span> <span class="free">f</span> <span class="free">U</span> <span class="free">S</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">G</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">unfold</span> diff_invariant_eq ivp_sols_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">X</span> <span class="skolem">t</span> <span class="keyword3"><span class="command">assume</span></span> Ghyp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">τ</span><span class="main">.</span> <span class="bound">τ</span> <span class="main">∈</span> <span class="free">U</span> <span class="main">(</span><span class="skolem">X</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">∧</span> <span class="bound">τ</span> <span class="main">≤</span> <span class="skolem">t</span> <span class="main">⟶</span> <span class="free">G</span> <span class="main">(</span><span class="skolem">X</span> <span class="bound">τ</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> xivp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">D</span> <span class="skolem">X</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">(</span><span class="skolem">X</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="main">(</span><span class="skolem">X</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">ν</span> <span class="main">(</span><span class="skolem">X</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">&lt;</span> <span class="free">μ</span> <span class="main">(</span><span class="skolem">X</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> <span class="free">U</span> <span class="main">(</span><span class="skolem">X</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">→</span> <span class="free">S</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> tHyp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> <span class="free">U</span> <span class="main">(</span><span class="skolem">X</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> t0Hyp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∈</span> <span class="free">U</span> <span class="main">(</span><span class="skolem">X</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">≤</span> <span class="skolem">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">μ</span> <span class="main">(</span><span class="skolem">X</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">≠</span> <span class="free">ν</span> <span class="main">(</span><span class="skolem">X</span> <span class="skolem">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> xivp<span class="main">(</span>3<span class="main">)</span> Uhyp<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">using</span></span> dI tHyp xivp<span class="main">(</span>2<span class="main">)</span> Ghyp ivp_solsI<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">X</span></span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">U</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span>"</span></span><span class="main">,</span> <span class="operator">OF</span> xivp<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> _ xivp<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> t0Hyp<span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> diff_invariant_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> ineq2<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">ν</span> <span class="main">(</span><span class="skolem">X</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">&gt;</span> <span class="free">μ</span> <span class="main">(</span><span class="skolem">X</span> <span class="skolem">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">note</span></span> continuous_on_compose<span class="main">[</span><span class="operator">OF</span> vderiv_on_continuous_on<span class="main"><span class="main">[</span></span><span class="operator">OF</span> xivp<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"continuous_on <span class="main">(</span><span class="free">U</span> <span class="main">(</span><span class="skolem">X</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">ν</span> <span class="main">∘</span> <span class="skolem">X</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"continuous_on <span class="main">(</span><span class="free">U</span> <span class="main">(</span><span class="skolem">X</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">μ</span> <span class="main">∘</span> <span class="skolem">X</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> xivp<span class="main">(</span>1<span class="main">)</span> conts <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">--</span><span class="skolem">t</span><span class="main">}</span> <span class="main">⊆</span> <span class="free">U</span> <span class="main">(</span><span class="skolem">X</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> closed_segment_subset_interval<span class="main">[</span><span class="operator">OF</span> Uhyp<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> t0Hyp tHyp<span class="main">]</span> xivp<span class="main">(</span>3<span class="main">)</span> t0Hyp <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"continuous_on <span class="main">{</span><span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">--</span><span class="skolem">t</span><span class="main">}</span> <span class="main">(</span><span class="main">λ</span><span class="bound">τ</span><span class="main">.</span> <span class="free">ν</span> <span class="main">(</span><span class="skolem">X</span> <span class="bound">τ</span><span class="main">)</span><span class="main">)</span>"</span></span> 
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"continuous_on <span class="main">{</span><span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">--</span><span class="skolem">t</span><span class="main">}</span> <span class="main">(</span><span class="main">λ</span><span class="bound">τ</span><span class="main">.</span> <span class="free">μ</span> <span class="main">(</span><span class="skolem">X</span> <span class="bound">τ</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> continuous_on_subset <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">τ</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">τ</span> <span class="main">∈</span> <span class="main">{</span><span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">--</span><span class="skolem">t</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">μ</span> <span class="main">(</span><span class="skolem">X</span> <span class="skolem">τ</span><span class="main">)</span> <span class="main">=</span> <span class="free">ν</span> <span class="main">(</span><span class="skolem">X</span> <span class="skolem">τ</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> IVT_two_functions_real_ivl<span class="main">[</span><span class="operator">OF</span> _ _ xivp<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> ineq2<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">r</span><span class="main">∈</span>down <span class="main">(</span><span class="free">U</span> <span class="main">(</span><span class="skolem">X</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span><span class="main">)</span> <span class="skolem">τ</span><span class="main">.</span> <span class="free">G</span> <span class="main">(</span><span class="skolem">X</span> <span class="bound">r</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">τ</span> <span class="main">∈</span> <span class="free">U</span> <span class="main">(</span><span class="skolem">X</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Ghyp <span class="quoted"><span class="quoted">‹<span class="skolem">τ</span> <span class="main">∈</span> <span class="main">{</span><span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">--</span><span class="skolem">t</span><span class="main">}</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">≤</span> <span class="skolem">t</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">{</span><span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">--</span><span class="skolem">t</span><span class="main">}</span> <span class="main">⊆</span> <span class="free">U</span> <span class="main">(</span><span class="skolem">X</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span>›</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> closed_segment_eq_real_ivl<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">μ</span> <span class="main">(</span><span class="skolem">X</span> <span class="skolem">τ</span><span class="main">)</span> <span class="main">≠</span> <span class="free">ν</span> <span class="main">(</span><span class="skolem">X</span> <span class="skolem">τ</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> dI tHyp xivp<span class="main">(</span>2<span class="main">)</span> ivp_solsI<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">X</span></span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">U</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span>"</span></span><span class="main">,</span> <span class="operator">OF</span> xivp<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> _ xivp<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> t0Hyp<span class="main">]</span>
      <span class="keyword1"><span class="command">unfolding</span></span> diff_invariant_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"False"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">μ</span> <span class="main">(</span><span class="skolem">X</span> <span class="skolem">τ</span><span class="main">)</span> <span class="main">=</span> <span class="free">ν</span> <span class="main">(</span><span class="skolem">X</span> <span class="skolem">τ</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">ν</span> <span class="main">(</span><span class="skolem">X</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">&lt;</span> <span class="free">μ</span> <span class="main">(</span><span class="skolem">X</span> <span class="skolem">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> diff_invariant_conj_rule <span class="main">[</span><span class="operator">diff_invariant_rules</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"diff_invariant <span class="free">I<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">f</span> <span class="free">U</span> <span class="free">S</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">G</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"diff_invariant <span class="free">I<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">f</span> <span class="free">U</span> <span class="free">S</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">G</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"diff_invariant <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">I<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">s</span> <span class="main">∧</span> <span class="free">I<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">s</span><span class="main">)</span> <span class="free">f</span> <span class="free">U</span> <span class="free">S</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">G</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> diff_invariant_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> diff_invariant_disj_rule <span class="main">[</span><span class="operator">diff_invariant_rules</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"diff_invariant <span class="free">I<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">f</span> <span class="free">U</span> <span class="free">S</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">G</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"diff_invariant <span class="free">I<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">f</span> <span class="free">U</span> <span class="free">S</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">G</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"diff_invariant <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">I<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">s</span> <span class="main">∨</span> <span class="free">I<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">s</span><span class="main">)</span> <span class="free">f</span> <span class="free">U</span> <span class="free">S</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">G</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> diff_invariant_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹ Picard-Lindeloef ›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹ A locale with the assumptions of Picard-Lindeloef's theorem. It extends 
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"ll_on_open_it"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> by providing an initial time <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">t<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="main"><span class="main">∈</span></span> <span class="free"><span class="free">T</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">locale</span></span> picard_lindeloef <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span><span class="main">::</span><span class="quoted"><span class="quoted">"real <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>heine_borel<span class="main">,</span>banach<span class="main">}</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">T</span><span class="main">::</span><span class="quoted"><span class="quoted">"real set"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">S</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">::</span><span class="quoted">real</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> open_domain<span class="main">:</span> <span class="quoted"><span class="quoted">"open <span class="free">T</span>"</span></span> <span class="quoted"><span class="quoted">"open <span class="free">S</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> interval_time<span class="main">:</span> <span class="quoted"><span class="quoted">"is_interval <span class="free">T</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> init_time<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∈</span> <span class="free">T</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> cont_vec_field<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s</span> <span class="main">∈</span> <span class="free">S</span><span class="main">.</span> continuous_on <span class="free">T</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">f</span> <span class="bound">t</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> lipschitz_vec_field<span class="main">:</span> <span class="quoted"><span class="quoted">"local_lipschitz <span class="free">T</span> <span class="free">S</span> <span class="free">f</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> ll_on_open_it <span class="quoted"><span class="free">T</span></span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">S</span></span> <span class="quoted"><span class="free">t<span class="hidden">⇩</span><sub>0</sub></span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cont_vec_field lipschitz_vec_field interval_time open_domain<span class="main">)</span> 

<span class="keyword1"><span class="command">lemma</span></span> ll_on_open<span class="main">:</span> <span class="quoted"><span class="quoted">"ll_on_open <span class="free">T</span> <span class="free">f</span> <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> local.general.ll_on_open_axioms <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> subintervalI <span class="main">=</span> closed_segment_subset_domain
   <span class="keyword2"><span class="keyword">and</span></span> init_time_ex_ivl <span class="main">=</span> existence_ivl_initial_time<span class="main">[</span><span class="operator">OF</span> init_time<span class="main">]</span>
   <span class="keyword2"><span class="keyword">and</span></span> flow_at_init<span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> general.flow_initial_time<span class="main">[</span><span class="operator">OF</span> init_time<span class="main">]</span>
                               
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">ex_ivl</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> existence_ivl <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> flow_has_vderiv_on_ex_ivl<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">D</span> flow <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">s</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">f</span> <span class="bound">t</span> <span class="main">(</span>flow <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">s</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">on</span> ex_ivl <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> flow_usolves_ode<span class="main">[</span><span class="operator">OF</span> init_time <span class="quoted"><span class="quoted">‹<span class="free">s</span> <span class="main">∈</span> <span class="free">S</span>›</span></span><span class="main">]</span> 
  <span class="keyword1"><span class="command">unfolding</span></span> usolves_ode_from_def solves_ode_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> flow_funcset_ex_ivl<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"flow <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">s</span> <span class="main">∈</span> ex_ivl <span class="free">s</span> <span class="main">→</span> <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> flow_usolves_ode<span class="main">[</span><span class="operator">OF</span> init_time <span class="quoted"><span class="quoted">‹<span class="free">s</span> <span class="main">∈</span> <span class="free">S</span>›</span></span><span class="main">]</span> 
  <span class="keyword1"><span class="command">unfolding</span></span> usolves_ode_from_def solves_ode_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> flow_in_ivp_sols_ex_ivl<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"flow <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">s</span> <span class="main">∈</span> <span class="keyword1">Sols</span> <span class="free">f</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> ex_ivl <span class="bound">s</span><span class="main">)</span> <span class="free">S</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> flow_has_vderiv_on_ex_ivl<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ivp_solsI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> init_time assms<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> flow_funcset_ex_ivl<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> csols_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"csols <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">s</span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> <span class="free">T</span> <span class="main">∧</span>  <span class="bound">x</span> <span class="main">∈</span> <span class="keyword1">Sols</span> <span class="free">f</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">{</span><span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">--</span><span class="bound">t</span><span class="main">}</span><span class="main">)</span> <span class="free">S</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">s</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> ivp_sols_def csols_def solves_ode_def 
  <span class="keyword1"><span class="command">using</span></span> closed_segment_subset_domain init_time <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> subset_ex_ivlI<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">Y<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∈</span> <span class="keyword1">Sols</span> <span class="free">f</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">T</span><span class="main">)</span> <span class="free">S</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">s</span> <span class="main">⟹</span> <span class="main">{</span><span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">--</span><span class="free">t</span><span class="main">}</span> <span class="main">⊆</span> <span class="free">T</span> <span class="main">⟹</span> <span class="free">A</span> <span class="main">⊆</span> <span class="main">{</span><span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">--</span><span class="free">t</span><span class="main">}</span> <span class="main">⟹</span> <span class="free">A</span> <span class="main">⊆</span> ex_ivl <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> existence_ivl_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∈</span> <span class="free">T</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> csols_eq<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">Y<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">t</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> in_ivp_sols_subset<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> T<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">λ</span></span></span><span class="bound"><span class="bound"><span class="bound">s</span></span></span><span class="main"><span class="main"><span class="main">.</span></span></span> <span class="free"><span class="free"><span class="free">T</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> unique_solution<span class="main">:</span> <span class="comment1">― ‹ proved for a subset of T for general applications ›</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> <span class="free">S</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∈</span> <span class="free">U</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> <span class="free">U</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"is_interval <span class="free">U</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">U</span> <span class="main">⊆</span> ex_ivl <span class="free">s</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> xivp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">D</span> <span class="free">Y<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">f</span> <span class="bound">t</span> <span class="main">(</span><span class="free">Y<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">on</span> <span class="free">U</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">Y<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">Y<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∈</span> <span class="free">U</span> <span class="main">→</span> <span class="free">S</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> yivp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">D</span> <span class="free">Y<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">f</span> <span class="bound">t</span> <span class="main">(</span><span class="free">Y<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">on</span> <span class="free">U</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">Y<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">Y<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∈</span> <span class="free">U</span> <span class="main">→</span> <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Y<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">t</span> <span class="main">=</span> <span class="free">Y<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∈</span> <span class="free">T</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms existence_ivl_subset <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> key<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>flow <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">s</span> <span class="keyword1">usolves_ode</span> <span class="free">f</span> <span class="keyword1">from</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">(</span>ex_ivl <span class="free">s</span><span class="main">)</span> <span class="free">S</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> flow_usolves_ode<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∈</span> <span class="free">T</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">s</span> <span class="main">∈</span> <span class="free">S</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t</span><span class="main">∈</span><span class="free">U</span><span class="main">.</span> <span class="free">Y<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">t</span> <span class="main">=</span> flow <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">s</span> <span class="bound">t</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> usolves_ode_from_def solves_ode_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">Y<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">U</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> assms<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t</span><span class="main">∈</span><span class="free">U</span><span class="main">.</span> <span class="free">Y<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">t</span> <span class="main">=</span> flow <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">s</span> <span class="bound">t</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> key <span class="keyword1"><span class="command">unfolding</span></span> usolves_ode_from_def solves_ode_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">Y<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">U</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> assms<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">Y<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">t</span> <span class="main">=</span> <span class="free">Y<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">t</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Applications of lemma <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"unique_solution"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>: ›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> unique_solution_closed_ivl<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> xivp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">D</span> <span class="free">X</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">f</span> <span class="bound">t</span> <span class="main">(</span><span class="free">X</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">on</span> <span class="main">{</span><span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">--</span><span class="free">t</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">∈</span> <span class="main">{</span><span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">--</span><span class="free">t</span><span class="main">}</span> <span class="main">→</span> <span class="free">S</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> <span class="free">T</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> yivp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">D</span> <span class="free">Y</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">f</span> <span class="bound">t</span> <span class="main">(</span><span class="free">Y</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">on</span> <span class="main">{</span><span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">--</span><span class="free">t</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">Y</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">Y</span> <span class="main">∈</span> <span class="main">{</span><span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">--</span><span class="free">t</span><span class="main">}</span> <span class="main">→</span> <span class="free">S</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> <span class="free">S</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="free">t</span> <span class="main">=</span> <span class="free">Y</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> unique_solution<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">s</span> <span class="main">∈</span> <span class="free">S</span>›</span></span><span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">{</span></span><span class="free"><span class="free">t<span class="hidden">⇩</span><sub>0</sub></span></span><span class="main"><span class="main">--</span></span><span class="free"><span class="free">t</span></span><span class="main"><span class="main">}</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">unfold</span> existence_ivl_def csols_eq ivp_sols_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> xivp <span class="quoted"><span class="quoted">‹<span class="free">t</span> <span class="main">∈</span> <span class="free">T</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> solution_eq_flow<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> xivp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">D</span> <span class="free">X</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">f</span> <span class="bound">t</span> <span class="main">(</span><span class="free">X</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">on</span> ex_ivl <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">∈</span> ex_ivl <span class="free">s</span> <span class="main">→</span> <span class="free">S</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> ex_ivl <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> <span class="free">S</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="free">t</span> <span class="main">=</span> flow <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">s</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> unique_solution<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">s</span> <span class="main">∈</span> <span class="free">S</span>›</span></span> init_time_ex_ivl <span class="quoted"><span class="quoted">‹<span class="free">t</span> <span class="main">∈</span> ex_ivl <span class="free">s</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> flow_has_vderiv_on_ex_ivl flow_funcset_ex_ivl <span class="quoted"><span class="quoted">‹<span class="free">s</span> <span class="main">∈</span> <span class="free">S</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> assms<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ivp_unique_solution<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> <span class="free">S</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ivl<span class="main">:</span> <span class="quoted"><span class="quoted">"is_interval <span class="main">(</span><span class="free">U</span> <span class="free">s</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">U</span> <span class="free">s</span> <span class="main">⊆</span> <span class="free">T</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> <span class="free">U</span> <span class="free">s</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> ivp1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Y<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∈</span> <span class="keyword1">Sols</span> <span class="free">f</span> <span class="free">U</span> <span class="free">S</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ivp2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Y<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∈</span> <span class="keyword1">Sols</span> <span class="free">f</span> <span class="free">U</span> <span class="free">S</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Y<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">t</span> <span class="main">=</span> <span class="free">Y<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> unique_solution<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">s</span> <span class="main">∈</span> <span class="free">S</span>›</span></span><span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">{</span></span><span class="free"><span class="free">t<span class="hidden">⇩</span><sub>0</sub></span></span><span class="main"><span class="main">--</span></span><span class="free"><span class="free">t</span></span><span class="main"><span class="main">}</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∈</span> <span class="free">U</span> <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ivp_solsD<span class="main">[</span><span class="operator">OF</span> ivp1<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> obs0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">--</span><span class="free">t</span><span class="main">}</span> <span class="main">⊆</span> <span class="free">U</span> <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> closed_segment_subset_interval<span class="main">[</span><span class="operator">OF</span> ivl<span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="free">t</span> <span class="main">∈</span> <span class="free">U</span> <span class="free">s</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> obs1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Y<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∈</span> <span class="keyword1">Sols</span> <span class="free">f</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">{</span><span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">--</span><span class="free">t</span><span class="main">}</span><span class="main">)</span> <span class="free">S</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> in_ivp_sols_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ calculation<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> ivp1<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> obs2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Y<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∈</span> <span class="keyword1">Sols</span> <span class="free">f</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">{</span><span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">--</span><span class="free">t</span><span class="main">}</span><span class="main">)</span> <span class="free">S</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> in_ivp_sols_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ calculation<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> ivp2<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">--</span><span class="free">t</span><span class="main">}</span> <span class="main">⊆</span> ex_ivl <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">unfold</span> existence_ivl_def csols_eq<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">Y<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">t</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">t</span> <span class="main">∈</span> <span class="free">U</span> <span class="free">s</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">U</span> <span class="free">s</span> <span class="main">⊆</span> <span class="free">T</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">D</span> <span class="free">Y<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">f</span> <span class="bound">t</span> <span class="main">(</span><span class="free">Y<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">on</span> <span class="main">{</span><span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">--</span><span class="free">t</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ivp_solsD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> in_ivp_sols_subset<span class="main"><span class="main">[</span></span><span class="operator"><span class="operator"><span class="operator"><span class="operator">OF</span></span></span></span> _ _ ivp1<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> obs0<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">D</span> <span class="free">Y<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">f</span> <span class="bound">t</span> <span class="main">(</span><span class="free">Y<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">on</span> <span class="main">{</span><span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">--</span><span class="free">t</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ivp_solsD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> in_ivp_sols_subset<span class="main"><span class="main">[</span></span><span class="operator"><span class="operator"><span class="operator"><span class="operator">OF</span></span></span></span> _ _ ivp2<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> obs0<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">Y<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">Y<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ivp_solsD<span class="main">[</span><span class="operator">OF</span> ivp1<span class="main">]</span> ivp_solsD<span class="main">[</span><span class="operator">OF</span> ivp2<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">Y<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∈</span> <span class="main">{</span><span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">--</span><span class="free">t</span><span class="main">}</span> <span class="main">→</span> <span class="free">S</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">Y<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∈</span> <span class="main">{</span><span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">--</span><span class="free">t</span><span class="main">}</span> <span class="main">→</span> <span class="free">S</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ivp_solsD<span class="main">[</span><span class="operator">OF</span> obs1<span class="main">]</span> ivp_solsD<span class="main">[</span><span class="operator">OF</span> obs2<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> g_orbital_orbit<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> <span class="free">S</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ivl<span class="main">:</span> <span class="quoted"><span class="quoted">"is_interval <span class="main">(</span><span class="free">U</span> <span class="free">s</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">U</span> <span class="free">s</span> <span class="main">⊆</span> <span class="free">T</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> ivp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Y</span> <span class="main">∈</span> <span class="keyword1">Sols</span> <span class="free">f</span> <span class="free">U</span> <span class="free">S</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"g_orbital <span class="free">f</span> <span class="free">G</span> <span class="free">U</span> <span class="free">S</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">s</span> <span class="main">=</span> g_orbit <span class="free">Y</span> <span class="free">G</span> <span class="main">(</span><span class="free">U</span> <span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> eq1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">Z</span> <span class="main">∈</span> <span class="keyword1">Sols</span> <span class="free">f</span> <span class="free">U</span> <span class="free">S</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">t</span><span class="main">∈</span><span class="free">U</span> <span class="free">s</span><span class="main">.</span> <span class="bound">Z</span> <span class="bound">t</span> <span class="main">=</span> <span class="free">Y</span> <span class="bound">t</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">clarsimp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> ivp_unique_solution<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">,</span></span></span>2<span class="main"><span class="main"><span class="main">,</span></span></span>3<span class="main"><span class="main"><span class="main">)</span></span></span> _ _ ivp<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"g_orbital <span class="free">f</span> <span class="free">G</span> <span class="free">U</span> <span class="free">S</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">s</span> <span class="main">⊆</span> g_orbit <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">Y</span> <span class="bound">t</span><span class="main">)</span> <span class="free">G</span> <span class="main">(</span><span class="free">U</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> g_orbital <span class="free">f</span> <span class="free">G</span> <span class="free">U</span> <span class="free">S</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Z</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem"><span class="skolem">t</span></span> 
      <span class="keyword2"><span class="keyword">where</span></span> z_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">Z</span> <span class="skolem">t</span> <span class="main">∧</span> <span class="skolem">t</span> <span class="main">∈</span> <span class="free">U</span> <span class="free">s</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">τ</span><span class="main">∈</span>down <span class="main">(</span><span class="free">U</span> <span class="free">s</span><span class="main">)</span> <span class="skolem">t</span><span class="main">.</span> <span class="free">G</span> <span class="main">(</span><span class="skolem">Z</span> <span class="bound">τ</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="skolem">Z</span> <span class="main">∈</span> <span class="keyword1">Sols</span> <span class="free">f</span> <span class="free">U</span> <span class="free">S</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">s</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> g_orbital_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">--</span><span class="skolem">t</span><span class="main">}</span> <span class="main">⊆</span> <span class="free">U</span> <span class="free">s</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> closed_segment_subset_interval<span class="main">[</span><span class="operator">OF</span> ivl ivp_solsD<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> ivp<span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">τ</span><span class="main">∈</span><span class="main">{</span><span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">--</span><span class="skolem">t</span><span class="main">}</span><span class="main">.</span> <span class="skolem">Z</span> <span class="bound">τ</span> <span class="main">=</span> <span class="free">Y</span> <span class="bound">τ</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> z_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ivp_unique_solution<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">,</span></span></span>2<span class="main"><span class="main"><span class="main">,</span></span></span>3<span class="main"><span class="main"><span class="main">)</span></span></span> _ _ ivp<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> g_orbit <span class="free">Y</span> <span class="free">G</span> <span class="main">(</span><span class="free">U</span> <span class="free">s</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> z_def eq1 <span class="keyword1"><span class="command">unfolding</span></span> g_orbit_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"g_orbit <span class="free">Y</span> <span class="free">G</span> <span class="main">(</span><span class="free">U</span> <span class="free">s</span><span class="main">)</span> <span class="main">⊆</span> g_orbital <span class="free">f</span> <span class="free">G</span> <span class="free">U</span> <span class="free">S</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">unfold</span> g_orbital_eq g_orbit_eq ivp_sols_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">t</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">Y</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> ivp_solsD<span class="main">[</span><span class="operator">OF</span> ivp<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemma</span></span> local_lipschitz_add<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f1</span> <span class="free">f2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">::</span>banach <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"local_lipschitz <span class="free">T</span> <span class="free">S</span> <span class="free">f1</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"local_lipschitz <span class="free">T</span> <span class="free">S</span> <span class="free">f2</span>"</span></span> 
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"local_lipschitz <span class="free">T</span> <span class="free">S</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span> <span class="bound">s</span><span class="main">.</span> <span class="free">f1</span> <span class="bound">t</span> <span class="bound">s</span> <span class="main">+</span> <span class="free">f2</span> <span class="bound">t</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">unfold</span> local_lipschitz_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">t</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> <span class="free">S</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> <span class="free">T</span>"</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ε<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="skolem"><span class="skolem">L1</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ε<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> L1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">τ</span><span class="main">.</span> <span class="bound">τ</span><span class="main">∈</span>cball <span class="skolem">t</span> <span class="skolem">ε<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∩</span> <span class="free">T</span> <span class="main">⟹</span> <span class="skolem">L1</span><span class="keyword1">-lipschitz_on</span> <span class="main">(</span>cball <span class="skolem">s</span> <span class="skolem">ε<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∩</span> <span class="free">S</span><span class="main">)</span> <span class="main">(</span><span class="free">f1</span> <span class="bound">τ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> local_lipschitzE<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="main">∈</span> <span class="free">T</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">s</span> <span class="main">∈</span> <span class="free">S</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ε<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="skolem"><span class="skolem">L2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ε<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> L2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">τ</span><span class="main">.</span> <span class="bound">τ</span><span class="main">∈</span>cball <span class="skolem">t</span> <span class="skolem">ε<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∩</span> <span class="free">T</span> <span class="main">⟹</span> <span class="skolem">L2</span><span class="keyword1">-lipschitz_on</span> <span class="main">(</span>cball <span class="skolem">s</span> <span class="skolem">ε<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∩</span> <span class="free">S</span><span class="main">)</span> <span class="main">(</span><span class="free">f2</span> <span class="bound">τ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> local_lipschitzE<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="main">∈</span> <span class="free">T</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">s</span> <span class="main">∈</span> <span class="free">S</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> ballH<span class="main">:</span> <span class="quoted"><span class="quoted">"cball <span class="skolem">s</span> <span class="main">(</span>min <span class="skolem">ε<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">ε<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">∩</span> <span class="free">S</span> <span class="main">⊆</span> cball <span class="skolem">s</span> <span class="skolem">ε<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∩</span> <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"cball <span class="skolem">s</span> <span class="main">(</span>min <span class="skolem">ε<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">ε<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">∩</span> <span class="free">S</span> <span class="main">⊆</span> cball <span class="skolem">s</span> <span class="skolem">ε<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∩</span> <span class="free">S</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> obs1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">τ</span><span class="main">∈</span>cball <span class="skolem">t</span> <span class="skolem">ε<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∩</span> <span class="free">T</span><span class="main">.</span> <span class="skolem">L1</span><span class="keyword1">-lipschitz_on</span> <span class="main">(</span>cball <span class="skolem">s</span> <span class="main">(</span>min <span class="skolem">ε<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">ε<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">∩</span> <span class="free">S</span><span class="main">)</span> <span class="main">(</span><span class="free">f1</span> <span class="bound">τ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> lipschitz_on_subset<span class="main">[</span><span class="operator">OF</span> L1 ballH<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> obs2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">τ</span><span class="main">∈</span>cball <span class="skolem">t</span> <span class="skolem">ε<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∩</span> <span class="free">T</span><span class="main">.</span> <span class="skolem">L2</span><span class="keyword1">-lipschitz_on</span> <span class="main">(</span>cball <span class="skolem">s</span> <span class="main">(</span>min <span class="skolem">ε<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">ε<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">∩</span> <span class="free">S</span><span class="main">)</span> <span class="main">(</span><span class="free">f2</span> <span class="bound">τ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> lipschitz_on_subset<span class="main">[</span><span class="operator">OF</span> L2 ballH<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">τ</span><span class="main">∈</span>cball <span class="skolem">t</span> <span class="main">(</span>min <span class="skolem">ε<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">ε<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">∩</span> <span class="free">T</span><span class="main">.</span> 
    <span class="main">(</span><span class="skolem">L1</span> <span class="main">+</span> <span class="skolem">L2</span><span class="main">)</span><span class="keyword1">-lipschitz_on</span> <span class="main">(</span>cball <span class="skolem">s</span> <span class="main">(</span>min <span class="skolem">ε<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">ε<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">∩</span> <span class="free">S</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">f1</span> <span class="bound">τ</span> <span class="bound">s</span> <span class="main">+</span> <span class="free">f2</span> <span class="bound">τ</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> lipschitz_on_add <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">u</span></span><span class="main">&gt;</span><span class="main">0</span><span class="main">.</span> <span class="main">∃</span><span class="bound">L</span><span class="main">.</span> <span class="main">∀</span><span class="bound">t</span><span class="main">∈</span>cball <span class="skolem">t</span> <span class="bound">u</span> <span class="main">∩</span> <span class="free">T</span><span class="main">.</span> <span class="bound">L</span><span class="keyword1">-lipschitz_on</span> <span class="main">(</span>cball <span class="skolem">s</span> <span class="bound">u</span> <span class="main">∩</span> <span class="free">S</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">f1</span> <span class="bound">t</span> <span class="bound">s</span> <span class="main">+</span> <span class="free">f2</span> <span class="bound">t</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"min <span class="skolem">ε<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">ε<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">ε<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">ε<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> picard_lindeloef_add<span class="main">:</span> <span class="quoted"><span class="quoted">"picard_lindeloef <span class="free">f1</span> <span class="free">T</span> <span class="free">S</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">⟹</span> picard_lindeloef <span class="free">f2</span> <span class="free">T</span> <span class="free">S</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">⟹</span> 
  picard_lindeloef <span class="main">(</span><span class="main">λ</span><span class="bound">t</span> <span class="bound">s</span><span class="main">.</span> <span class="free">f1</span> <span class="bound">t</span> <span class="bound">s</span> <span class="main">+</span> <span class="free">f2</span> <span class="bound">t</span> <span class="bound">s</span><span class="main">)</span> <span class="free">T</span> <span class="free">S</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> picard_lindeloef_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> conjI<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> continuous_on_add <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">using</span></span> local_lipschitz_add <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> picard_lindeloef_constant<span class="main">:</span> <span class="quoted"><span class="quoted">"picard_lindeloef <span class="main">(</span><span class="main">λ</span><span class="bound">t</span> <span class="bound">s</span><span class="main">.</span> <span class="free">c</span><span class="main">)</span> UNIV UNIV <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> local_lipschitz_def lipschitz_on_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="main">1</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">1</span><span class="main">/</span><span class="numeral">2</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹ Flows for ODEs ›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹ A locale designed for verification of hybrid systems. The user can select the interval 
of existence and the defining flow equation via the variables <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">T</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">φ</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">locale</span></span> local_flow <span class="main">=</span> picard_lindeloef <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span> <span class="bound">t</span><span class="main">.</span> <span class="free">f</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">T</span></span> <span class="quoted"><span class="free">S</span></span> <span class="quoted"><span class="main">0</span></span> 
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">f</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>heine_borel<span class="main">,</span>banach<span class="main">}</span> <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">T</span> <span class="free">S</span> <span class="free">L</span> <span class="main">+</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">φ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ivp<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">t</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> <span class="free">T</span> <span class="main">⟹</span> <span class="bound">s</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> <span class="keyword1">D</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">φ</span> <span class="bound">t</span> <span class="bound">s</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">t</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">on</span> <span class="main">{</span><span class="main">0</span><span class="main">--</span><span class="bound">t</span><span class="main">}</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> <span class="free">φ</span> <span class="main">0</span> <span class="bound">s</span> <span class="main">=</span> <span class="bound">s</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">t</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> <span class="free">T</span> <span class="main">⟹</span> <span class="bound">s</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">φ</span> <span class="bound">t</span> <span class="bound">s</span><span class="main">)</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">--</span><span class="bound">t</span><span class="main">}</span> <span class="main">→</span> <span class="free">S</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> in_ivp_sols_ivl<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> <span class="free">T</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">φ</span> <span class="bound">t</span> <span class="free">s</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1">Sols</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">f</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">{</span><span class="main">0</span><span class="main">--</span><span class="free">t</span><span class="main">}</span><span class="main">)</span> <span class="free">S</span> <span class="main">0</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ivp_solsI<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> ivp assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> eq_solution_ivl<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> xivp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">D</span> <span class="free">X</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="free">X</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">on</span> <span class="main">{</span><span class="main">0</span><span class="main">--</span><span class="free">t</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">0</span> <span class="main">=</span> <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">--</span><span class="free">t</span><span class="main">}</span> <span class="main">→</span> <span class="free">S</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> indom<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> <span class="free">T</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="free">t</span> <span class="main">=</span> <span class="free">φ</span> <span class="free">t</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> unique_solution_closed_ivl<span class="main"><span class="main">[</span></span><span class="operator">OF</span> xivp <span class="quoted"><span class="quoted">‹<span class="free">t</span> <span class="main">∈</span> <span class="free">T</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">s</span> <span class="main">∈</span> <span class="free">S</span>›</span></span> ivp indom <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> ex_ivl_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ex_ivl <span class="free">s</span> <span class="main">=</span> <span class="free">T</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> existence_ivl_subset<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">s</span></span><span class="main">]</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
  <span class="keyword1"><span class="command">unfolding</span></span> existence_ivl_def csols_eq
  <span class="keyword1"><span class="command">using</span></span> in_ivp_sols_ivl<span class="main">[</span><span class="operator">OF</span> _ assms<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> has_derivative_on_open1<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span>  <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> <span class="free">T</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">B</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> <span class="free">B</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"open <span class="free">B</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">⊆</span> <span class="free">T</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">D</span> <span class="main">(</span><span class="main">λ</span><span class="bound">τ</span><span class="main">.</span> <span class="free">φ</span> <span class="bound">τ</span> <span class="free">s</span><span class="main">)</span> <span class="main">↦</span> <span class="main">(</span><span class="main">λ</span><span class="bound">τ</span><span class="main">.</span> <span class="bound">τ</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">f</span> <span class="main">(</span><span class="free">φ</span> <span class="free">t</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">at</span> <span class="free">t</span> <span class="keyword1">within</span> <span class="free">B</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r</span></span><span class="main">::</span><span class="quoted">real</span> <span class="keyword2"><span class="keyword">where</span></span> rHyp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"ball <span class="free">t</span> <span class="skolem">r</span> <span class="main">⊆</span> <span class="free">T</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> open_contains_ball_eq open_domain<span class="main">(</span>1<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="free">t</span> <span class="main">∈</span> <span class="free">T</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">+</span> <span class="skolem">r</span><span class="main">/</span><span class="numeral">2</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">t</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">0</span><span class="main">--</span><span class="free">t</span><span class="main">}</span> <span class="main">⊆</span> <span class="free">T</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> subintervalI<span class="main">[</span><span class="operator">OF</span> init_time <span class="quoted"><span class="quoted">‹<span class="free">t</span> <span class="main">∈</span> <span class="free">T</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> subs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">0</span><span class="main">&lt;--&lt;</span><span class="free">t</span> <span class="main">+</span> <span class="skolem">r</span><span class="main">/</span><span class="numeral">2</span><span class="main">}</span> <span class="main">⊆</span> <span class="free">T</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> abs_le_eq abs_le_eq real_ivl_eqs<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">‹<span class="free"><span class="free"><span class="free"><span class="free"><span class="free"><span class="free"><span class="free"><span class="free"><span class="free"><span class="free"><span class="free"><span class="free">t</span></span></span></span></span></span></span></span></span></span></span></span> <span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">&gt;</span></span></span></span></span></span></span></span></span></span></span></span> <span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">0</span></span></span></span></span></span></span></span></span></span></span></span>›</span></span></span></span></span></span></span></span></span></span></span></span></span><span class="main">]</span> real_ivl_eqs<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">‹<span class="free"><span class="free"><span class="free"><span class="free"><span class="free"><span class="free"><span class="free"><span class="free"><span class="free"><span class="free"><span class="free"><span class="free">t</span></span></span></span></span></span></span></span></span></span></span></span> <span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">+</span></span></span></span></span></span></span></span></span></span></span></span> <span class="skolem"><span class="skolem"><span class="skolem"><span class="skolem"><span class="skolem"><span class="skolem"><span class="skolem"><span class="skolem"><span class="skolem"><span class="skolem"><span class="skolem"><span class="skolem">r</span></span></span></span></span></span></span></span></span></span></span></span><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">/</span></span></span></span></span></span></span></span></span></span></span></span><span class="numeral"><span class="numeral"><span class="numeral"><span class="numeral"><span class="numeral"><span class="numeral"><span class="numeral"><span class="numeral"><span class="numeral"><span class="numeral"><span class="numeral"><span class="numeral">2</span></span></span></span></span></span></span></span></span></span></span></span> <span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">&gt;</span></span></span></span></span></span></span></span></span></span></span></span> <span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">0</span></span></span></span></span></span></span></span></span></span></span></span>›</span></span></span></span></span></span></span></span></span></span></span></span></span><span class="main">]</span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">clarify</span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">&lt;</span> <span class="improper">x</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cball_def ball_def dist_norm subset_eq <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">+</span> <span class="skolem">r</span><span class="main">/</span><span class="numeral">2</span> <span class="main">∈</span> <span class="free">T</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> rHyp <span class="keyword1"><span class="command">unfolding</span></span> real_ivl_eqs<span class="main">[</span><span class="operator">OF</span> rHyp<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span></span></span></span></span></span></span></span></span>1<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span></span></span></span></span></span></span></span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subset_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">0</span><span class="main">--</span><span class="free">t</span> <span class="main">+</span> <span class="skolem">r</span><span class="main">/</span><span class="numeral">2</span><span class="main">}</span> <span class="main">⊆</span> <span class="free">T</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> subintervalI<span class="main">[</span><span class="operator">OF</span> init_time<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">D</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">φ</span> <span class="bound">t</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">t</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">on</span> <span class="main">{</span><span class="main">0</span><span class="main">--</span><span class="main">(</span><span class="free">t</span> <span class="main">+</span> <span class="skolem">r</span><span class="main">/</span><span class="numeral">2</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ivp<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> _ <span class="quoted"><span class="quoted">‹<span class="free">s</span> <span class="main">∈</span> <span class="free">S</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> vderiv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">D</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">φ</span> <span class="bound">t</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">t</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">on</span> <span class="main">{</span><span class="main">0</span><span class="main">&lt;--&lt;</span><span class="free">t</span> <span class="main">+</span> <span class="skolem">r</span><span class="main">/</span><span class="numeral">2</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> has_vderiv_on_subset<span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> real_ivl_eqs<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">‹<span class="free"><span class="free"><span class="free"><span class="free"><span class="free"><span class="free"><span class="free"><span class="free"><span class="free"><span class="free"><span class="free"><span class="free">t</span></span></span></span></span></span></span></span></span></span></span></span> <span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">+</span></span></span></span></span></span></span></span></span></span></span></span> <span class="skolem"><span class="skolem"><span class="skolem"><span class="skolem"><span class="skolem"><span class="skolem"><span class="skolem"><span class="skolem"><span class="skolem"><span class="skolem"><span class="skolem"><span class="skolem">r</span></span></span></span></span></span></span></span></span></span></span></span><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">/</span></span></span></span></span></span></span></span></span></span></span></span><span class="numeral"><span class="numeral"><span class="numeral"><span class="numeral"><span class="numeral"><span class="numeral"><span class="numeral"><span class="numeral"><span class="numeral"><span class="numeral"><span class="numeral"><span class="numeral">2</span></span></span></span></span></span></span></span></span></span></span></span> <span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">&gt;</span></span></span></span></span></span></span></span></span></span></span></span> <span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">0</span></span></span></span></span></span></span></span></span></span></span></span>›</span></span></span></span></span></span></span></span></span></span></span></span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">&lt;--&lt;</span><span class="free">t</span> <span class="main">+</span> <span class="skolem">r</span><span class="main">/</span><span class="numeral">2</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> real_ivl_eqs<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">‹<span class="free"><span class="free"><span class="free"><span class="free"><span class="free"><span class="free"><span class="free"><span class="free"><span class="free"><span class="free"><span class="free"><span class="free">t</span></span></span></span></span></span></span></span></span></span></span></span> <span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">+</span></span></span></span></span></span></span></span></span></span></span></span> <span class="skolem"><span class="skolem"><span class="skolem"><span class="skolem"><span class="skolem"><span class="skolem"><span class="skolem"><span class="skolem"><span class="skolem"><span class="skolem"><span class="skolem"><span class="skolem">r</span></span></span></span></span></span></span></span></span></span></span></span><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">/</span></span></span></span></span></span></span></span></span></span></span></span><span class="numeral"><span class="numeral"><span class="numeral"><span class="numeral"><span class="numeral"><span class="numeral"><span class="numeral"><span class="numeral"><span class="numeral"><span class="numeral"><span class="numeral"><span class="numeral">2</span></span></span></span></span></span></span></span></span></span></span></span> <span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">&gt;</span></span></span></span></span></span></span></span></span></span></span></span> <span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">0</span></span></span></span></span></span></span></span></span></span></span></span>›</span></span></span></span></span></span></span></span></span></span></span></span></span><span class="main">]</span> <span class="keyword1"><span class="command">using</span></span> rHyp <span class="quoted"><span class="quoted">‹<span class="free">t</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">D</span> <span class="main">(</span><span class="main">λ</span><span class="bound">τ</span><span class="main">.</span> <span class="free">φ</span> <span class="bound">τ</span> <span class="free">s</span><span class="main">)</span> <span class="main">↦</span> <span class="main">(</span><span class="main">λ</span><span class="bound">τ</span><span class="main">.</span> <span class="bound">τ</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">f</span> <span class="main">(</span><span class="free">φ</span> <span class="free">t</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="free">t</span> <span class="keyword1">within</span> <span class="main">{</span><span class="main">0</span><span class="main">&lt;--&lt;</span><span class="free">t</span> <span class="main">+</span> <span class="skolem">r</span><span class="main">/</span><span class="numeral">2</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> vderiv calculation <span class="keyword1"><span class="command">unfolding</span></span> has_vderiv_on_def has_vector_derivative_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"open <span class="main">{</span><span class="main">0</span><span class="main">&lt;--&lt;</span><span class="free">t</span> <span class="main">+</span> <span class="skolem">r</span><span class="main">/</span><span class="numeral">2</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> real_ivl_eqs<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">‹<span class="free"><span class="free"><span class="free"><span class="free"><span class="free"><span class="free"><span class="free"><span class="free"><span class="free"><span class="free"><span class="free"><span class="free">t</span></span></span></span></span></span></span></span></span></span></span></span> <span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">+</span></span></span></span></span></span></span></span></span></span></span></span> <span class="skolem"><span class="skolem"><span class="skolem"><span class="skolem"><span class="skolem"><span class="skolem"><span class="skolem"><span class="skolem"><span class="skolem"><span class="skolem"><span class="skolem"><span class="skolem">r</span></span></span></span></span></span></span></span></span></span></span></span><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">/</span></span></span></span></span></span></span></span></span></span></span></span><span class="numeral"><span class="numeral"><span class="numeral"><span class="numeral"><span class="numeral"><span class="numeral"><span class="numeral"><span class="numeral"><span class="numeral"><span class="numeral"><span class="numeral"><span class="numeral">2</span></span></span></span></span></span></span></span></span></span></span></span> <span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">&gt;</span></span></span></span></span></span></span></span></span></span></span></span> <span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">0</span></span></span></span></span></span></span></span></span></span></span></span>›</span></span></span></span></span></span></span></span></span></span></span></span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> subs that <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> has_derivative_on_open2<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> <span class="free">T</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">B</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> <span class="free">B</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"open <span class="free">B</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">⊆</span> <span class="free">T</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">D</span> <span class="main">(</span><span class="main">λ</span><span class="bound">τ</span><span class="main">.</span> <span class="free">φ</span> <span class="bound">τ</span> <span class="free">s</span><span class="main">)</span> <span class="main">↦</span> <span class="main">(</span><span class="main">λ</span><span class="bound">τ</span><span class="main">.</span> <span class="bound">τ</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">f</span> <span class="main">(</span><span class="free">φ</span> <span class="free">t</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">at</span> <span class="free">t</span> <span class="keyword1">within</span> <span class="free">B</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r</span></span><span class="main">::</span><span class="quoted">real</span> <span class="keyword2"><span class="keyword">where</span></span> rHyp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"ball <span class="free">t</span> <span class="skolem">r</span> <span class="main">⊆</span> <span class="free">T</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> open_contains_ball_eq open_domain<span class="main">(</span>1<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="free">t</span> <span class="main">∈</span> <span class="free">T</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">-</span> <span class="skolem">r</span><span class="main">/</span><span class="numeral">2</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">t</span> <span class="main">&lt;</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">0</span><span class="main">--</span><span class="free">t</span><span class="main">}</span> <span class="main">⊆</span> <span class="free">T</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> subintervalI<span class="main">[</span><span class="operator">OF</span> init_time <span class="quoted"><span class="quoted">‹<span class="free">t</span> <span class="main">∈</span> <span class="free">T</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> subs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">0</span><span class="main">&lt;--&lt;</span><span class="free">t</span> <span class="main">-</span> <span class="skolem">r</span><span class="main">/</span><span class="numeral">2</span><span class="main">}</span> <span class="main">⊆</span> <span class="free">T</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> open_segment_eq_real_ivl closed_segment_eq_real_ivl
      real_ivl_eqs<span class="main">[</span><span class="operator">OF</span> rHyp<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span></span></span></span></span></span></span></span></span>1<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span></span></span></span></span></span></span></span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> subset_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">-</span> <span class="skolem">r</span><span class="main">/</span><span class="numeral">2</span> <span class="main">∈</span> <span class="free">T</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> rHyp <span class="keyword1"><span class="command">unfolding</span></span> real_ivl_eqs <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subset_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">0</span><span class="main">--</span><span class="free">t</span> <span class="main">-</span> <span class="skolem">r</span><span class="main">/</span><span class="numeral">2</span><span class="main">}</span> <span class="main">⊆</span> <span class="free">T</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> subintervalI<span class="main">[</span><span class="operator">OF</span> init_time<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">D</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">φ</span> <span class="bound">t</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">t</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">on</span> <span class="main">{</span><span class="main">0</span><span class="main">--</span><span class="main">(</span><span class="free">t</span> <span class="main">-</span> <span class="skolem">r</span><span class="main">/</span><span class="numeral">2</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ivp<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> _ <span class="quoted"><span class="quoted">‹<span class="free">s</span> <span class="main">∈</span> <span class="free">S</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> vderiv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">D</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">φ</span> <span class="bound">t</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">t</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">on</span> <span class="main">{</span><span class="main">0</span><span class="main">&lt;--&lt;</span><span class="free">t</span> <span class="main">-</span> <span class="skolem">r</span><span class="main">/</span><span class="numeral">2</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> has_vderiv_on_subset<span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> open_segment_eq_real_ivl closed_segment_eq_real_ivl <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">&lt;--&lt;</span><span class="free">t</span> <span class="main">-</span> <span class="skolem">r</span><span class="main">/</span><span class="numeral">2</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> open_segment_eq_real_ivl <span class="keyword1"><span class="command">using</span></span> rHyp <span class="quoted"><span class="quoted">‹<span class="free">t</span> <span class="main">&lt;</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">D</span> <span class="main">(</span><span class="main">λ</span><span class="bound">τ</span><span class="main">.</span> <span class="free">φ</span> <span class="bound">τ</span> <span class="free">s</span><span class="main">)</span> <span class="main">↦</span> <span class="main">(</span><span class="main">λ</span><span class="bound">τ</span><span class="main">.</span> <span class="bound">τ</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">f</span> <span class="main">(</span><span class="free">φ</span> <span class="free">t</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="free">t</span> <span class="keyword1">within</span> <span class="main">{</span><span class="main">0</span><span class="main">&lt;--&lt;</span><span class="free">t</span> <span class="main">-</span> <span class="skolem">r</span><span class="main">/</span><span class="numeral">2</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> vderiv calculation <span class="keyword1"><span class="command">unfolding</span></span> has_vderiv_on_def has_vector_derivative_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"open <span class="main">{</span><span class="main">0</span><span class="main">&lt;--&lt;</span><span class="free">t</span> <span class="main">-</span> <span class="skolem">r</span><span class="main">/</span><span class="numeral">2</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> open_segment_eq_real_ivl <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> subs that <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> has_derivative_on_open3<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">B</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">∈</span> <span class="free">B</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"open <span class="free">B</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">⊆</span> <span class="free">T</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">D</span> <span class="main">(</span><span class="main">λ</span><span class="bound">τ</span><span class="main">.</span> <span class="free">φ</span> <span class="bound">τ</span> <span class="free">s</span><span class="main">)</span> <span class="main">↦</span> <span class="main">(</span><span class="main">λ</span><span class="bound">τ</span><span class="main">.</span> <span class="bound">τ</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">f</span> <span class="main">(</span><span class="free">φ</span> <span class="main">0</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">at</span> <span class="main">0</span> <span class="keyword1">within</span> <span class="free">B</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r</span></span><span class="main">::</span><span class="quoted">real</span> <span class="keyword2"><span class="keyword">where</span></span> rHyp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"ball <span class="main">0</span> <span class="skolem">r</span> <span class="main">⊆</span> <span class="free">T</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> open_contains_ball_eq open_domain<span class="main">(</span>1<span class="main">)</span> init_time <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span><span class="main">/</span><span class="numeral">2</span> <span class="main">∈</span> <span class="free">T</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="skolem">r</span><span class="main">/</span><span class="numeral">2</span> <span class="main">∈</span> <span class="free">T</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span><span class="main">/</span><span class="numeral">2</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> real_ivl_eqs <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> subs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">0</span><span class="main">--</span><span class="skolem">r</span><span class="main">/</span><span class="numeral">2</span><span class="main">}</span> <span class="main">⊆</span> <span class="free">T</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">0</span><span class="main">--</span><span class="main">(</span><span class="main">-</span><span class="skolem">r</span><span class="main">/</span><span class="numeral">2</span><span class="main">)</span><span class="main">}</span> <span class="main">⊆</span> <span class="free">T</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> subintervalI<span class="main">[</span><span class="operator">OF</span> init_time<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">D</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">φ</span> <span class="bound">t</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">t</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">on</span> <span class="main">{</span><span class="main">0</span><span class="main">--</span><span class="skolem">r</span><span class="main">/</span><span class="numeral">2</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">D</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">φ</span> <span class="bound">t</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">t</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">on</span> <span class="main">{</span><span class="main">0</span><span class="main">--</span><span class="main">(</span><span class="main">-</span><span class="skolem">r</span><span class="main">/</span><span class="numeral">2</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ivp<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> _ <span class="quoted"><span class="quoted">‹<span class="free">s</span> <span class="main">∈</span> <span class="free">S</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">0</span><span class="main">--</span><span class="skolem">r</span><span class="main">/</span><span class="numeral">2</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="main">0</span><span class="main">--</span><span class="skolem">r</span><span class="main">/</span><span class="numeral">2</span><span class="main">}</span> <span class="main">∪</span> closure <span class="main">{</span><span class="main">0</span><span class="main">--</span><span class="skolem">r</span><span class="main">/</span><span class="numeral">2</span><span class="main">}</span> <span class="main">∩</span> closure <span class="main">{</span><span class="main">0</span><span class="main">--</span><span class="main">(</span><span class="main">-</span><span class="skolem">r</span><span class="main">/</span><span class="numeral">2</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">0</span><span class="main">--</span><span class="main">(</span><span class="main">-</span><span class="skolem">r</span><span class="main">/</span><span class="numeral">2</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="main">0</span><span class="main">--</span><span class="main">(</span><span class="main">-</span><span class="skolem">r</span><span class="main">/</span><span class="numeral">2</span><span class="main">)</span><span class="main">}</span> <span class="main">∪</span> closure <span class="main">{</span><span class="main">0</span><span class="main">--</span><span class="skolem">r</span><span class="main">/</span><span class="numeral">2</span><span class="main">}</span> <span class="main">∩</span> closure <span class="main">{</span><span class="main">0</span><span class="main">--</span><span class="main">(</span><span class="main">-</span><span class="skolem">r</span><span class="main">/</span><span class="numeral">2</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> closed_segment_eq_real_ivl <span class="quoted"><span class="quoted">‹<span class="skolem">r</span><span class="main">/</span><span class="numeral">2</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> vderivs<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">D</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">φ</span> <span class="bound">t</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">t</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">on</span> <span class="main">{</span><span class="main">0</span><span class="main">--</span><span class="skolem">r</span><span class="main">/</span><span class="numeral">2</span><span class="main">}</span> <span class="main">∪</span> closure <span class="main">{</span><span class="main">0</span><span class="main">--</span><span class="skolem">r</span><span class="main">/</span><span class="numeral">2</span><span class="main">}</span> <span class="main">∩</span> closure <span class="main">{</span><span class="main">0</span><span class="main">--</span><span class="main">(</span><span class="main">-</span><span class="skolem">r</span><span class="main">/</span><span class="numeral">2</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">D</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">φ</span> <span class="bound">t</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">t</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">on</span> <span class="main">{</span><span class="main">0</span><span class="main">--</span><span class="main">(</span><span class="main">-</span><span class="skolem">r</span><span class="main">/</span><span class="numeral">2</span><span class="main">)</span><span class="main">}</span> <span class="main">∪</span> closure <span class="main">{</span><span class="main">0</span><span class="main">--</span><span class="skolem">r</span><span class="main">/</span><span class="numeral">2</span><span class="main">}</span> <span class="main">∩</span> closure <span class="main">{</span><span class="main">0</span><span class="main">--</span><span class="main">(</span><span class="main">-</span><span class="skolem">r</span><span class="main">/</span><span class="numeral">2</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> closed_segment_eq_real_ivl <span class="quoted"><span class="quoted">‹<span class="skolem">r</span><span class="main">/</span><span class="numeral">2</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> obs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">∈</span> <span class="main">{</span><span class="main">-</span><span class="skolem">r</span><span class="main">/</span><span class="numeral">2</span><span class="main">&lt;--&lt;</span><span class="skolem">r</span><span class="main">/</span><span class="numeral">2</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> open_segment_eq_real_ivl <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span><span class="main">/</span><span class="numeral">2</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> union<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">-</span><span class="skolem">r</span><span class="main">/</span><span class="numeral">2</span><span class="main">--</span><span class="skolem">r</span><span class="main">/</span><span class="numeral">2</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="main">0</span><span class="main">--</span><span class="skolem">r</span><span class="main">/</span><span class="numeral">2</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="main">0</span><span class="main">--</span><span class="main">(</span><span class="main">-</span><span class="skolem">r</span><span class="main">/</span><span class="numeral">2</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> closed_segment_eq_real_ivl <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">D</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">φ</span> <span class="bound">t</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">t</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">on</span> <span class="main">{</span><span class="main">-</span><span class="skolem">r</span><span class="main">/</span><span class="numeral">2</span><span class="main">--</span><span class="skolem">r</span><span class="main">/</span><span class="numeral">2</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> has_vderiv_on_union<span class="main">[</span><span class="operator">OF</span> vderivs<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">D</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">φ</span> <span class="bound">t</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">t</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">on</span> <span class="main">{</span><span class="main">-</span><span class="skolem">r</span><span class="main">/</span><span class="numeral">2</span><span class="main">&lt;--&lt;</span><span class="skolem">r</span><span class="main">/</span><span class="numeral">2</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> has_vderiv_on_subset<span class="main">[</span><span class="operator">OF</span> _ segment_open_subset_closed<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="skolem">r</span><span class="main">/</span><span class="numeral">2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span><span class="main">/</span><span class="numeral">2</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">D</span> <span class="main">(</span><span class="main">λ</span><span class="bound">τ</span><span class="main">.</span> <span class="free">φ</span> <span class="bound">τ</span> <span class="free">s</span><span class="main">)</span> <span class="main">↦</span> <span class="main">(</span><span class="main">λ</span><span class="bound">τ</span><span class="main">.</span> <span class="bound">τ</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">f</span> <span class="main">(</span><span class="free">φ</span> <span class="main">0</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="main">0</span> <span class="keyword1">within</span> <span class="main">{</span><span class="main">-</span><span class="skolem">r</span><span class="main">/</span><span class="numeral">2</span><span class="main">&lt;--&lt;</span><span class="skolem">r</span><span class="main">/</span><span class="numeral">2</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> has_vderiv_on_def has_vector_derivative_def <span class="keyword1"><span class="command">using</span></span> obs <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"open <span class="main">{</span><span class="main">-</span><span class="skolem">r</span><span class="main">/</span><span class="numeral">2</span><span class="main">&lt;--&lt;</span><span class="skolem">r</span><span class="main">/</span><span class="numeral">2</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> open_segment_eq_real_ivl <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">-</span><span class="skolem">r</span><span class="main">/</span><span class="numeral">2</span><span class="main">&lt;--&lt;</span><span class="skolem">r</span><span class="main">/</span><span class="numeral">2</span><span class="main">}</span> <span class="main">⊆</span> <span class="free">T</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> subs union segment_open_subset_closed <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> obs that <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> has_derivative_on_open<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> <span class="free">T</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">B</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> <span class="free">B</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"open <span class="free">B</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">⊆</span> <span class="free">T</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">D</span> <span class="main">(</span><span class="main">λ</span><span class="bound">τ</span><span class="main">.</span> <span class="free">φ</span> <span class="bound">τ</span> <span class="free">s</span><span class="main">)</span> <span class="main">↦</span> <span class="main">(</span><span class="main">λ</span><span class="bound">τ</span><span class="main">.</span> <span class="bound">τ</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">f</span> <span class="main">(</span><span class="free">φ</span> <span class="free">t</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">at</span> <span class="free">t</span> <span class="keyword1">within</span> <span class="free">B</span>"</span></span> 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">∨</span> <span class="free">t</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> <span class="free">t</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> has_derivative_on_open1<span class="main">[</span><span class="operator">OF</span> _ assms<span class="main">]</span> has_derivative_on_open2<span class="main">[</span><span class="operator">OF</span> _ assms<span class="main">]</span>
    has_derivative_on_open3<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">s</span> <span class="main">∈</span> <span class="free">S</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> <span class="operator">force</span>

<span class="keyword1"><span class="command">lemma</span></span> in_domain<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">φ</span> <span class="bound">t</span> <span class="free">s</span><span class="main">)</span> <span class="main">∈</span> <span class="free">T</span> <span class="main">→</span> <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> ivp<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> _ assms<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> has_vderiv_on_domain<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">D</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">φ</span> <span class="bound">t</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">t</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">on</span> <span class="free">T</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">unfold</span> has_vderiv_on_def has_vector_derivative_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> <span class="free">T</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">B</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> <span class="skolem">B</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"open <span class="skolem">B</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">⊆</span> <span class="free">T</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> Dhyp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">D</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">φ</span> <span class="bound">t</span> <span class="free">s</span><span class="main">)</span> <span class="main">↦</span> <span class="main">(</span><span class="main">λ</span><span class="bound">τ</span><span class="main">.</span> <span class="bound">τ</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">f</span> <span class="main">(</span><span class="free">φ</span> <span class="skolem">t</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">at</span> <span class="skolem">t</span> <span class="keyword1">within</span> <span class="skolem">B</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms has_derivative_on_open<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="main">∈</span> <span class="free">T</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> interior <span class="skolem">B</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> interior_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">D</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">φ</span> <span class="bound">t</span> <span class="free">s</span><span class="main">)</span> <span class="main">↦</span> <span class="main">(</span><span class="main">λ</span><span class="bound">τ</span><span class="main">.</span> <span class="bound">τ</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">f</span> <span class="main">(</span><span class="free">φ</span> <span class="skolem">t</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">at</span> <span class="skolem">t</span> <span class="keyword1">within</span> <span class="free">T</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> has_derivative_at_within_mono<span class="main">[</span><span class="operator">OF</span> _ <span class="quoted"><span class="quoted">‹<span class="skolem">B</span> <span class="main">⊆</span> <span class="free">T</span>›</span></span> Dhyp<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> in_ivp_sols<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> <span class="free">S</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">∈</span> <span class="free">U</span> <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">U</span> <span class="free">s</span> <span class="main">⊆</span> <span class="free">T</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">φ</span> <span class="bound">t</span> <span class="free">s</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1">Sols</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">f</span><span class="main">)</span> <span class="free">U</span> <span class="free">S</span> <span class="main">0</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> in_ivp_sols_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ _ ivp_solsI<span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span><span class="bound"><span class="bound">s</span></span><span class="main"><span class="main">.</span></span> <span class="free"><span class="free">T</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span>  ivp<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">s</span> <span class="main">∈</span> <span class="free">S</span>›</span></span><span class="main">]</span> has_vderiv_on_domain<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">s</span> <span class="main">∈</span> <span class="free">S</span>›</span></span><span class="main">]</span> 
    in_domain<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">s</span> <span class="main">∈</span> <span class="free">S</span>›</span></span><span class="main">]</span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> eq_solution<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> <span class="free">S</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"is_interval <span class="main">(</span><span class="free">U</span> <span class="free">s</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">U</span> <span class="free">s</span> <span class="main">⊆</span> <span class="free">T</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> <span class="free">U</span> <span class="free">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> xivp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">∈</span> <span class="keyword1">Sols</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">f</span><span class="main">)</span> <span class="free">U</span> <span class="free">S</span> <span class="main">0</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="free">t</span> <span class="main">=</span> <span class="free">φ</span> <span class="free">t</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ivp_unique_solution<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> in_ivp_sols<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ivp_solsD<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> xivp<span class="main"><span class="main">]</span></span> assms<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ivp_sols_collapse<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">T</span> <span class="main">=</span> UNIV"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">Sols</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">f</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">T</span><span class="main">)</span> <span class="free">S</span> <span class="main">0</span> <span class="free">s</span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">φ</span> <span class="bound">t</span> <span class="free">s</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">safe</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_eq_iff<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> eq_solution<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span><span class="bound"><span class="bound">s</span></span><span class="main"><span class="main">.</span></span> <span class="free"><span class="free">T</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> in_ivp_sols<span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> additive_in_ivp_sols<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> <span class="free">S</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝒫</span> <span class="main">(</span><span class="main">λ</span><span class="bound">τ</span><span class="main">.</span> <span class="bound">τ</span> <span class="main">+</span> <span class="free">t</span><span class="main">)</span> <span class="free">T</span> <span class="main">⊆</span> <span class="free">T</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">τ</span><span class="main">.</span> <span class="free">φ</span> <span class="main">(</span><span class="bound">τ</span> <span class="main">+</span> <span class="free">t</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1">Sols</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">f</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">T</span><span class="main">)</span> <span class="free">S</span> <span class="main">0</span> <span class="main">(</span><span class="free">φ</span> <span class="main">(</span><span class="main">0</span> <span class="main">+</span> <span class="free">t</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ivp_solsI<span class="main"><span class="main">[</span></span><span class="operator">OF</span> vderiv_on_composeI<span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> has_vderiv_on_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> has_vderiv_on_domain<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> in_domain assms init_time <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">poly_derivatives</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> is_monoid_action<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> <span class="free">S</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">T</span> <span class="main">=</span> UNIV"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">φ</span> <span class="main">0</span> <span class="free">s</span> <span class="main">=</span> <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">φ</span> <span class="main">(</span><span class="free">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">+</span> <span class="free">t<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="free">s</span> <span class="main">=</span> <span class="free">φ</span> <span class="free">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">(</span><span class="free">φ</span> <span class="free">t<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">φ</span> <span class="main">0</span> <span class="free">s</span> <span class="main">=</span> <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ivp assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">φ</span> <span class="main">(</span><span class="main">0</span> <span class="main">+</span> <span class="free">t<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="free">s</span> <span class="main">=</span> <span class="free">φ</span> <span class="free">t<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">s</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">φ</span> <span class="main">(</span><span class="main">0</span> <span class="main">+</span> <span class="free">t<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="free">s</span> <span class="main">∈</span> <span class="free">S</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> in_domain assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">φ</span> <span class="main">(</span><span class="free">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">+</span> <span class="free">t<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="free">s</span> <span class="main">=</span> <span class="free">φ</span> <span class="free">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">(</span><span class="free">φ</span> <span class="free">t<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> eq_solution<span class="main">[</span><span class="operator">OF</span> _ _ _ _ additive_in_ivp_sols<span class="main">]</span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> g_orbital_collapses<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> <span class="free">S</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"is_interval <span class="main">(</span><span class="free">U</span> <span class="free">s</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">U</span> <span class="free">s</span> <span class="main">⊆</span> <span class="free">T</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">∈</span> <span class="free">U</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"g_orbital <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">f</span><span class="main">)</span> <span class="free">G</span> <span class="free">U</span> <span class="free">S</span> <span class="main">0</span> <span class="free">s</span> <span class="main">=</span> <span class="main">{</span><span class="free">φ</span> <span class="bound">t</span> <span class="free">s</span><span class="main">|</span> <span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> <span class="free">U</span> <span class="free">s</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">τ</span><span class="main">∈</span>down <span class="main">(</span><span class="free">U</span> <span class="free">s</span><span class="main">)</span> <span class="bound">t</span><span class="main">.</span> <span class="free">G</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">τ</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> g_orbital_orbit<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span><span class="bound"><span class="bound">t</span></span><span class="main"><span class="main">.</span></span> <span class="free"><span class="free">φ</span></span> <span class="bound"><span class="bound">t</span></span> <span class="free"><span class="free">s</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms g_orbit_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> in_ivp_sols<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">orbit</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> set"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">γ<span class="hidden">⇧</span><sup>φ</sup></span>"</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">γ<span class="hidden">⇧</span><sup>φ</sup></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> g_orbital <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">f</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> True<span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">T</span><span class="main">)</span> <span class="free">S</span> <span class="main">0</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> orbit_eq<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">γ<span class="hidden">⇧</span><sup>φ</sup></span> <span class="free">s</span> <span class="main">=</span> <span class="main">{</span><span class="free">φ</span> <span class="bound">t</span> <span class="free">s</span><span class="main">|</span> <span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> <span class="free">T</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">unfold</span> orbit_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> g_orbital_collapses<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms init_time interval_time<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> true_g_orbit_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"g_orbit <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">φ</span> <span class="bound">t</span> <span class="free">s</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> True<span class="main">)</span> <span class="free">T</span> <span class="main">=</span> <span class="keyword1">γ<span class="hidden">⇧</span><sup>φ</sup></span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> g_orbit_eq orbit_eq<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemma</span></span> line_is_local_flow<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">∈</span> <span class="free">T</span> <span class="main">⟹</span> is_interval <span class="free">T</span> <span class="main">⟹</span> open <span class="free">T</span> <span class="main">⟹</span> local_flow <span class="main">(</span><span class="main">λ</span> <span class="bound">s</span><span class="main">.</span> <span class="free">c</span><span class="main">)</span> <span class="free">T</span> UNIV <span class="main">(</span><span class="main">λ</span> <span class="bound">t</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">+</span> <span class="bound">t</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">c</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> local_lipschitz_def lipschitz_on_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="main">1</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">1</span><span class="main">/</span><span class="numeral">2</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> f'1<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">s</span><span class="main">.</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> g'1<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">s</span><span class="main">.</span> <span class="free">c</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> has_vderiv_on_add<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> has_vderiv_on_eq_rhs<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">derivative_intros</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="HS_VC_Spartan">
<div class="head">
<h1>Theory HS_VC_Spartan</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:       Verification components for hybrid systems 
    Author:      Jonathan Julián Huerta y Munive, 2020
    Maintainer:  Jonathan Julián Huerta y Munive &lt;jonjulian23@gmail.com&gt;
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹ Verification components for hybrid systems ›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ A light-weight version of the verification components. We define the forward box 
operator to compute weakest liberal preconditions (wlps) of hybrid programs. Then we 
introduce three methods for verifying correctness specifications of the continuous 
dynamics of a HS. ›</span></span>

<span class="keyword1"><span class="command">theory</span></span> HS_VC_Spartan
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="HS_ODEs.html">HS_ODEs</a>
                        
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'a</span> pred <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span>

<span class="keyword1"><span class="command">no_notation</span></span> Transitive_Closure.rtrancl <span class="main">(</span><span class="quoted">"<span class="keyword3">(</span>_<span class="keyword1"><span class="hidden">⇧</span><sup>*</sup></span><span class="keyword3">)</span>"</span> <span class="main">[</span>1000<span class="main">]</span> 999<span class="main">)</span>

<span class="keyword1"><span class="command">notation</span></span> Union <span class="main">(</span><span class="quoted">"<span class="keyword1">μ</span>"</span><span class="main">)</span>
     <span class="keyword2"><span class="keyword">and</span></span> g_orbital <span class="main">(</span><span class="quoted">"<span class="keyword3">(1</span><span class="keyword1">x´=</span>_ <span class="keyword1">&amp;</span> _ <span class="keyword1">on</span> _ _ <span class="keyword1">@</span> _<span class="keyword3">)</span>"</span><span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Verification of regular programs›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ Lemmas for verification condition generation ›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">fbox</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> set<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'b</span> pred <span class="main">⇒</span> <span class="tfree">'a</span> pred"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">|</span>_<span class="keyword1">]</span> _"</span> <span class="main">[</span>61<span class="main">,</span>81<span class="main">]</span> 82<span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="free">|</span></span><span class="free"><span class="bound"><span class="entity">F</span></span></span><span class="main"><span class="free">]</span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">s'</span><span class="main">.</span> <span class="bound">s'</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="bound">s</span> <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">s'</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> fbox_iso<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">≤</span> <span class="free">Q</span> <span class="main">⟹</span> <span class="main">|</span><span class="free">F</span><span class="main">]</span> <span class="free">P</span> <span class="main">≤</span> <span class="main">|</span><span class="free">F</span><span class="main">]</span> <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> fbox_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> fbox_anti<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s</span><span class="main">.</span> <span class="free">F<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">s</span> <span class="main">⊆</span> <span class="free">F<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">s</span> <span class="main">⟹</span> <span class="main">|</span><span class="free">F<span class="hidden">⇩</span><sub>2</sub></span><span class="main">]</span> <span class="free">P</span> <span class="main">≤</span> <span class="main">|</span><span class="free">F<span class="hidden">⇩</span><sub>1</sub></span><span class="main">]</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> fbox_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> fbox_invariants<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">≤</span> <span class="main">|</span><span class="free">F</span><span class="main">]</span> <span class="free">I</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">J</span> <span class="main">≤</span> <span class="main">|</span><span class="free">F</span><span class="main">]</span> <span class="free">J</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">I</span> <span class="bound">s</span> <span class="main">∧</span> <span class="free">J</span> <span class="bound">s</span><span class="main">)</span> <span class="main">≤</span> <span class="main">|</span><span class="free">F</span><span class="main">]</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">I</span> <span class="bound">s</span> <span class="main">∧</span> <span class="free">J</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">I</span> <span class="bound">s</span> <span class="main">∨</span> <span class="free">J</span> <span class="bound">s</span><span class="main">)</span> <span class="main">≤</span> <span class="main">|</span><span class="free">F</span><span class="main">]</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">I</span> <span class="bound">s</span> <span class="main">∨</span> <span class="free">J</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> fbox_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="comment1">― ‹ Skip ›</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">skip</span> <span class="main">≡</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">{</span><span class="bound">s</span><span class="main">}</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> fbox_eta<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"fbox skip <span class="free">P</span> <span class="main">=</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> fbox_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="comment1">― ‹ Tests ›</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">test</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> pred <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> set"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword3">(1</span><span class="keyword1">¿</span>_<span class="keyword1">?</span><span class="keyword3">)</span>"</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="free">¿</span></span><span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main"><span class="free">?</span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">s</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">x</span><span class="main">}</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> fbox_test<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">(</span> <span class="main">|</span><span class="main">¿</span><span class="free">P</span><span class="main">?</span><span class="main">]</span> <span class="free">Q</span><span class="main">)</span> <span class="bound">s</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">⟶</span> <span class="free">Q</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> fbox_def test_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="comment1">― ‹ Assignments ›</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">vec_upd</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">^</span><span class="tfree">'n</span> <span class="main">⇒</span> <span class="tfree">'n</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">^</span><span class="tfree">'n</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">vec_upd</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">χ</span> <span class="bound">j</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="main">($)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">:=</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span><span class="main">)</span> <span class="bound">j</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> vec_upd_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"vec_upd <span class="free">s</span> <span class="free">i</span> <span class="free">a</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">χ</span> <span class="bound">j</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">j</span> <span class="main">=</span> <span class="free">i</span> <span class="keyword1">then</span> <span class="free">a</span> <span class="keyword1">else</span> <span class="free">s</span><span class="main">$</span><span class="bound">j</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> vec_upd_def<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">assign</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'n</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">^</span><span class="tfree">'n</span> <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">^</span><span class="tfree">'n</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">^</span><span class="tfree">'n</span><span class="main">)</span> set"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword3">(2</span>_ <span class="keyword1">::=</span> _<span class="keyword3">)</span>"</span> <span class="main">[</span>70<span class="main">,</span> 65<span class="main">]</span> 61<span class="main">)</span> 
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main"><span class="free">::=</span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">{</span>vec_upd <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="bound">s</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>"</span></span> 

<span class="keyword1"><span class="command">lemma</span></span> fbox_assign<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">|</span><span class="free">x</span> <span class="main">::=</span> <span class="free">e</span><span class="main">]</span> <span class="free">Q</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">Q</span> <span class="main">(</span><span class="keyword1">χ</span> <span class="bound">j</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="main">($)</span> <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="main">(</span><span class="free">e</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> vec_upd_def assign_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> fbox_def<span class="main">)</span> <span class="operator">simp</span>

<span class="comment1">― ‹ Nondeterministic assignments ›</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">nondet_assign</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'n</span> <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">^</span><span class="tfree">'n</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">^</span><span class="tfree">'n</span><span class="main">)</span> set"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword3">(2</span>_ <span class="keyword1">::=</span> <span class="keyword1">?</span> <span class="keyword3">)</span>"</span> <span class="main">[</span>70<span class="main">]</span> 61<span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main"><span class="free">::=</span></span> <span class="main"><span class="free">?</span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">{</span><span class="main">(</span>vec_upd <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="bound">k</span><span class="main">)</span><span class="main">|</span><span class="bound">k</span><span class="main">.</span> True<span class="main">}</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> fbox_nondet_assign<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">|</span><span class="free">x</span> <span class="main">::=</span> <span class="main">?</span><span class="main">]</span> <span class="free">P</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="keyword1">χ</span> <span class="bound">j</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">j</span> <span class="main">=</span> <span class="free">x</span> <span class="keyword1">then</span> <span class="bound">k</span> <span class="keyword1">else</span> <span class="bound">s</span><span class="main">$</span><span class="bound">j</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> fbox_def nondet_assign_def vec_upd_eq <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_eq_iff<span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">χ</span> <span class="bound">j</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">j</span> <span class="main">=</span> <span class="free">x</span> <span class="keyword1">then</span> <span class="improper">k</span> <span class="keyword1">else</span> <span class="main">_</span> <span class="main">$</span> <span class="bound">j</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="comment1">― ‹ Nondeterministic choice ›</span>

<span class="keyword1"><span class="command">lemma</span></span> fbox_choice<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">|</span><span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">F</span> <span class="bound">s</span> <span class="main">∪</span> <span class="free">G</span> <span class="bound">s</span><span class="main">)</span><span class="main">]</span> <span class="free">P</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">(</span> <span class="main">|</span><span class="free">F</span><span class="main">]</span> <span class="free">P</span><span class="main">)</span> <span class="bound">s</span> <span class="main">∧</span> <span class="main">(</span> <span class="main">|</span><span class="free">G</span><span class="main">]</span> <span class="free">P</span><span class="main">)</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> fbox_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> le_fbox_choice_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">≤</span> <span class="main">|</span><span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">F</span> <span class="bound">s</span> <span class="main">∪</span> <span class="free">G</span> <span class="bound">s</span><span class="main">)</span><span class="main">]</span> <span class="free">Q</span> <span class="main">⟷</span> <span class="free">P</span> <span class="main">≤</span> <span class="main">|</span><span class="free">F</span><span class="main">]</span> <span class="free">Q</span> <span class="main">∧</span> <span class="free">P</span> <span class="main">≤</span> <span class="main">|</span><span class="free">G</span><span class="main">]</span> <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> fbox_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="comment1">― ‹ Sequential composition ›</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">kcomp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> set<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'c</span> set<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span>  <span class="main">⇒</span> <span class="tfree">'c</span> set<span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">;</span>"</span> 75<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="main"><span class="free">;</span></span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">=</span> <span class="keyword1">μ</span> <span class="main">∘</span> <span class="keyword1">𝒫</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">∘</span> <span class="free"><span class="bound"><span class="entity">F</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> kcomp_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="main">;</span> <span class="free">g</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> <span class="main">⋃</span> <span class="main">{</span><span class="free">g</span> <span class="bound">y</span> <span class="main">|</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">f</span> <span class="free">x</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> kcomp_def image_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> fbox_kcomp<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">|</span><span class="free">G</span> <span class="main">;</span> <span class="free">F</span><span class="main">]</span> <span class="free">P</span> <span class="main">=</span> <span class="main">|</span><span class="free">G</span><span class="main">]</span> <span class="main">|</span><span class="free">F</span><span class="main">]</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> fbox_def kcomp_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> hoare_kcomp<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">≤</span> <span class="main">|</span><span class="free">G</span><span class="main">]</span> <span class="free">R</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">≤</span> <span class="main">|</span><span class="free">F</span><span class="main">]</span> <span class="free">Q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">≤</span> <span class="main">|</span><span class="free">G</span> <span class="main">;</span> <span class="free">F</span><span class="main">]</span> <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> fbox_kcomp<span class="main">)</span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> order.trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">rule</span> fbox_iso<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="comment1">― ‹ Conditional statement ›</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ifthenelse</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> pred <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> set<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> set<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> set<span class="main">)</span>"</span></span>
  <span class="main">(</span><span class="quoted">"<span class="keyword1">IF</span> _ <span class="keyword1">THEN</span> _ <span class="keyword1">ELSE</span> _"</span> <span class="main">[</span>64<span class="main">,</span>64<span class="main">,</span>64<span class="main">]</span> 63<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">IF</span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="keyword1"><span class="free">THEN</span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="keyword1"><span class="free">ELSE</span></span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">s</span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="bound">s</span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span> <span class="bound">s</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> fbox_if_then_else<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">|</span><span class="keyword1">IF</span> <span class="free">T</span> <span class="keyword1">THEN</span> <span class="free">X</span> <span class="keyword1">ELSE</span> <span class="free">Y</span><span class="main">]</span> <span class="free">Q</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">(</span><span class="free">T</span> <span class="bound">s</span> <span class="main">⟶</span> <span class="main">(</span> <span class="main">|</span><span class="free">X</span><span class="main">]</span> <span class="free">Q</span><span class="main">)</span> <span class="bound">s</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">¬</span> <span class="free">T</span> <span class="bound">s</span> <span class="main">⟶</span> <span class="main">(</span> <span class="main">|</span><span class="free">Y</span><span class="main">]</span> <span class="free">Q</span><span class="main">)</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> fbox_def ifthenelse_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> hoare_if_then_else<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">∧</span> <span class="free">T</span> <span class="bound">s</span><span class="main">)</span> <span class="main">≤</span> <span class="main">|</span><span class="free">X</span><span class="main">]</span> <span class="free">Q</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">∧</span> <span class="main">¬</span> <span class="free">T</span> <span class="bound">s</span><span class="main">)</span> <span class="main">≤</span> <span class="main">|</span><span class="free">Y</span><span class="main">]</span> <span class="free">Q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">≤</span> <span class="main">|</span><span class="keyword1">IF</span> <span class="free">T</span> <span class="keyword1">THEN</span> <span class="free">X</span> <span class="keyword1">ELSE</span> <span class="free">Y</span><span class="main">]</span> <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> fbox_def ifthenelse_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="comment1">― ‹ Finite iteration ›</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">kpower</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> set<span class="main">)</span> <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> set<span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">kpower</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">(</span><span class="main">(;)</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">^^</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> skip <span class="bound">s</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> kpower_base<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"kpower <span class="free">f</span> <span class="main">0</span> <span class="free">s</span> <span class="main">=</span> <span class="main">{</span><span class="free">s</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"kpower <span class="free">f</span> <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="free">s</span> <span class="main">=</span> <span class="free">f</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> kpower_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> kcomp_eq<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> kpower_simp<span class="main">:</span> <span class="quoted"><span class="quoted">"kpower <span class="free">f</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="free">s</span> <span class="main">=</span> <span class="main">(</span><span class="free">f</span> <span class="main">;</span> kpower <span class="free">f</span> <span class="free">n</span><span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> kcomp_eq 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> kpower_base 
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> subset_antisym<span class="main">)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> kpower_def kcomp_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">kleene_star</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> set<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> set<span class="main">)</span>"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword3">(</span>_<span class="keyword1"><span class="hidden">⇧</span><sup>*</sup></span><span class="keyword3">)</span>"</span> <span class="main">[</span>1000<span class="main">]</span> 999<span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main"><span class="free"><span class="hidden">⇧</span><sup>*</sup></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="main">⋃</span> <span class="main">{</span>kpower <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">n</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">|</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">∈</span> UNIV<span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> kpower_inv<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">F</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s</span><span class="main">.</span> <span class="free">I</span> <span class="bound">s</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">s'</span><span class="main">.</span> <span class="bound">s'</span> <span class="main">∈</span> <span class="free">F</span> <span class="bound">s</span> <span class="main">⟶</span> <span class="free">I</span> <span class="bound">s'</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s</span><span class="main">.</span> <span class="free">I</span> <span class="bound">s</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">s'</span><span class="main">.</span> <span class="bound">s'</span> <span class="main">∈</span> <span class="main">(</span>kpower <span class="free">F</span> <span class="free">n</span> <span class="bound">s</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">I</span> <span class="bound">s'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> kpower_base kpower_simp 
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> kcomp_eq<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main">)</span> 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="improper">y</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> kstar_inv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">≤</span> <span class="main">|</span><span class="free">F</span><span class="main">]</span> <span class="free">I</span> <span class="main">⟹</span> <span class="free">I</span> <span class="main">≤</span> <span class="main">|</span><span class="free">F</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span><span class="main">]</span> <span class="free">I</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> kleene_star_def fbox_def 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">unfold</span> le_fun_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="free">I</span> <span class="bound">x</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">s'</span><span class="main">.</span> <span class="bound">s'</span> <span class="main">∈</span> <span class="free">F</span> <span class="bound">x</span> <span class="main">⟶</span> <span class="free">I</span> <span class="bound">s'</span><span class="main">)</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> kpower_inv<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">I</span></span> <span class="quoted"><span class="free">F</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> fbox_kstarI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">≤</span> <span class="free">I</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">≤</span> <span class="free">Q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">≤</span> <span class="main">|</span><span class="free">F</span><span class="main">]</span> <span class="free">I</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">≤</span> <span class="main">|</span><span class="free">F</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span><span class="main">]</span> <span class="free">Q</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">≤</span> <span class="main">|</span><span class="free">F</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span><span class="main">]</span> <span class="free">I</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> kstar_inv <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">≤</span> <span class="main">|</span><span class="free">F</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span><span class="main">]</span> <span class="free">I</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">|</span><span class="free">F</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span><span class="main">]</span> <span class="free">I</span> <span class="main">≤</span> <span class="main">|</span><span class="free">F</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span><span class="main">]</span> <span class="free">Q</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> fbox_iso<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">loopi</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> set<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> pred <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> set<span class="main">)</span>"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">LOOP</span> _ <span class="keyword1">INV</span> _ "</span> <span class="main">[</span>64<span class="main">,</span>64<span class="main">]</span> 63<span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">LOOP</span></span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="keyword1"><span class="free">INV</span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">F</span></span></span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> change_loopI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">LOOP</span> <span class="free">X</span> <span class="keyword1">INV</span> <span class="free">G</span> <span class="main">=</span> <span class="keyword1">LOOP</span> <span class="free">X</span> <span class="keyword1">INV</span> <span class="free">I</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> loopi_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> fbox_loopI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">≤</span> <span class="free">I</span> <span class="main">⟹</span> <span class="free">I</span> <span class="main">≤</span> <span class="free">Q</span> <span class="main">⟹</span> <span class="free">I</span> <span class="main">≤</span> <span class="main">|</span><span class="free">F</span><span class="main">]</span> <span class="free">I</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">≤</span> <span class="main">|</span><span class="keyword1">LOOP</span> <span class="free">F</span> <span class="keyword1">INV</span> <span class="free">I</span><span class="main">]</span> <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> loopi_def <span class="keyword1"><span class="command">using</span></span> fbox_kstarI<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">P</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> wp_loopI_break<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">≤</span> <span class="main">|</span><span class="free">Y</span><span class="main">]</span> <span class="free">I</span> <span class="main">⟹</span> <span class="free">I</span> <span class="main">≤</span> <span class="main">|</span><span class="free">X</span><span class="main">]</span> <span class="free">I</span> <span class="main">⟹</span> <span class="free">I</span> <span class="main">≤</span> <span class="free">Q</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">≤</span> <span class="main">|</span><span class="free">Y</span> <span class="main">;</span> <span class="main">(</span><span class="keyword1">LOOP</span> <span class="free">X</span> <span class="keyword1">INV</span> <span class="free">I</span><span class="main">)</span><span class="main">]</span> <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> hoare_kcomp<span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main">)</span> <span class="main">(</span><span class="operator">rule</span> fbox_loopI<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹ Verification of hybrid programs ›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ Verification by providing evolution ›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">g_evol</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>ord<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'b</span> pred <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'a</span> set<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'b</span> set<span class="main">)</span>"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">EVOL</span>"</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">EVOL</span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> g_orbit <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="bound">t</span> <span class="bound">s</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> fbox_g_evol<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">φ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>preorder<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">|</span><span class="keyword1">EVOL</span> <span class="free">φ</span> <span class="free">G</span> <span class="free">U</span><span class="main">]</span> <span class="free">Q</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">t</span><span class="main">∈</span><span class="free">U</span> <span class="bound">s</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">τ</span><span class="main">∈</span>down <span class="main">(</span><span class="free">U</span> <span class="bound">s</span><span class="main">)</span> <span class="bound">t</span><span class="main">.</span> <span class="free">G</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">τ</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">Q</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">t</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> g_evol_def g_orbit_eq fbox_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ Verification by providing solutions ›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> fbox_g_orbital<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">|</span><span class="keyword1">x´=</span><span class="free">f</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">]</span> <span class="free">Q</span> <span class="main">=</span> 
  <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">X</span><span class="main">∈</span><span class="keyword1">Sols</span> <span class="free">f</span> <span class="free">U</span> <span class="free">S</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">t</span><span class="main">∈</span><span class="free">U</span> <span class="bound">s</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">τ</span><span class="main">∈</span>down <span class="main">(</span><span class="free">U</span> <span class="bound">s</span><span class="main">)</span> <span class="bound">t</span><span class="main">.</span> <span class="free">G</span> <span class="main">(</span><span class="bound">X</span> <span class="bound">τ</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">Q</span> <span class="main">(</span><span class="bound">X</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> fbox_def g_orbital_eq <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fun_eq_iff<span class="main">)</span>

<span class="keyword1"><span class="command">context</span></span> local_flow
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> fbox_g_ode_subset<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">∈</span> <span class="free">U</span> <span class="bound">s</span> <span class="main">∧</span> is_interval <span class="main">(</span><span class="free">U</span> <span class="bound">s</span><span class="main">)</span> <span class="main">∧</span> <span class="free">U</span> <span class="bound">s</span> <span class="main">⊆</span> <span class="free">T</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">|</span><span class="keyword1">x´=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">f</span><span class="main">)</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="main">0</span><span class="main">]</span> <span class="free">Q</span> <span class="main">=</span> 
  <span class="main">(</span><span class="main">λ</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">t</span><span class="main">∈</span><span class="main">(</span><span class="free">U</span> <span class="bound">s</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">τ</span><span class="main">∈</span>down <span class="main">(</span><span class="free">U</span> <span class="bound">s</span><span class="main">)</span> <span class="bound">t</span><span class="main">.</span> <span class="free">G</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">τ</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">Q</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">t</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">unfold</span> fbox_g_orbital fun_eq_iff<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarify</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> iffI<span class="main"><span class="keyword3">;</span></span> <span class="operator">clarify</span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_ivp_sols assms<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">frule</span> ivp_solsD<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">frule</span> ivp_solsD<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">frule</span> ivp_solsD<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">τ</span><span class="main">∈</span>down <span class="main">(</span><span class="free">U</span> <span class="improper">x</span><span class="main">)</span> <span class="improper">t</span><span class="main">.</span> <span class="improper">X</span> <span class="bound">τ</span> <span class="main">=</span> <span class="free">φ</span> <span class="bound">τ</span> <span class="improper">x</span>"</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> ballI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ivp_unique_solution<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ _ _ _ _ in_ivp_sols<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                         
<span class="keyword1"><span class="command">lemma</span></span> fbox_g_ode<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">|</span><span class="keyword1">x´=</span><span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">f</span><span class="main">)</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">T</span><span class="main">)</span> <span class="free">S</span> <span class="main">@</span> <span class="main">0</span><span class="main">]</span> <span class="free">Q</span> <span class="main">=</span> 
  <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">t</span><span class="main">∈</span><span class="free">T</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">τ</span><span class="main">∈</span>down <span class="free">T</span> <span class="bound">t</span><span class="main">.</span> <span class="free">G</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">τ</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">Q</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">t</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> fbox_g_ode_subset<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> init_time interval_time<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fbox_g_ode_ivl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">≥</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free">t</span> <span class="main">∈</span> <span class="free">T</span> <span class="main">⟹</span> <span class="main">|</span><span class="keyword1">x´=</span><span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">f</span><span class="main">)</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">t</span><span class="main">}</span><span class="main">)</span> <span class="free">S</span> <span class="main">@</span> <span class="main">0</span><span class="main">]</span> <span class="free">Q</span> <span class="main">=</span> 
  <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">t</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">t</span><span class="main">}</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">τ</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="bound">t</span><span class="main">}</span><span class="main">.</span> <span class="free">G</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">τ</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">Q</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">t</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> fbox_g_ode_subset<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subintervalI init_time real_Icc_closed_segment<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> closed_segment_eq_real_ivl<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fbox_orbit<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">|</span><span class="keyword1">γ<span class="hidden">⇧</span><sup>φ</sup></span><span class="main">]</span> <span class="free">Q</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">t</span> <span class="main">∈</span> <span class="free">T</span><span class="main">.</span> <span class="free">Q</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">t</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> orbit_def fbox_g_ode <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ Verification with differential invariants ›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">g_ode_inv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>real <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>banach<span class="main">)</span><span class="main">⇒</span><span class="tfree">'a</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> pred <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> real set<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> set <span class="main">⇒</span> 
  real <span class="main">⇒</span> <span class="tfree">'a</span> pred <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> set<span class="main">)</span>"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword3">(1</span><span class="keyword1">x´=</span>_ <span class="keyword1">&amp;</span> _ <span class="keyword1">on</span> _ _ <span class="keyword1">@</span> _ <span class="keyword1">DINV</span> _ <span class="keyword3">)</span>"</span><span class="main">)</span> 
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1"><span class="free">x´=</span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main"><span class="free">&amp;</span></span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="keyword1"><span class="free">on</span></span> <span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main"><span class="free">@</span></span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="keyword1"><span class="free">DINV</span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">&amp;</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="keyword1">on</span> <span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">@</span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> fbox_g_orbital_guard<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">H</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">G</span> <span class="bound">s</span> <span class="main">∧</span> <span class="free">Q</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">|</span><span class="keyword1">x´=</span><span class="free">f</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">]</span> <span class="free">Q</span> <span class="main">=</span> <span class="main">|</span><span class="keyword1">x´=</span><span class="free">f</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">]</span> <span class="free">H</span> "</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> fbox_g_orbital <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> fbox_g_orbital_inv<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">≤</span> <span class="free">I</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">≤</span> <span class="main">|</span><span class="keyword1">x´=</span><span class="free">f</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">]</span> <span class="free">I</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">≤</span> <span class="free">Q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">≤</span> <span class="main">|</span><span class="keyword1">x´=</span><span class="free">f</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">]</span> <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> order.trans<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> order.trans<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> fbox_iso<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fbox_diff_inv<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">I</span> <span class="main">≤</span> <span class="main">|</span><span class="keyword1">x´=</span><span class="free">f</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">]</span> <span class="free">I</span><span class="main">)</span> <span class="main">=</span> diff_invariant <span class="free">I</span> <span class="free">f</span> <span class="free">U</span> <span class="free">S</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">G</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> diff_invariant_def ivp_sols_def fbox_def g_orbital_eq<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> diff_inv_guard_ignore<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">≤</span> <span class="main">|</span><span class="keyword1">x´=</span> <span class="free">f</span> <span class="main">&amp;</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> True<span class="main">)</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">]</span> <span class="free">I</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">≤</span> <span class="main">|</span><span class="keyword1">x´=</span> <span class="free">f</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">]</span> <span class="free">I</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> fbox_diff_inv diff_invariant_eq image_le_pred <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">context</span></span> local_flow
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> fbox_diff_inv_eq<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">∈</span> <span class="free">U</span> <span class="bound">s</span> <span class="main">∧</span> is_interval <span class="main">(</span><span class="free">U</span> <span class="bound">s</span><span class="main">)</span> <span class="main">∧</span> <span class="free">U</span> <span class="bound">s</span> <span class="main">⊆</span> <span class="free">T</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"diff_invariant <span class="free">I</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">f</span><span class="main">)</span> <span class="free">U</span> <span class="free">S</span> <span class="main">0</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> True<span class="main">)</span> <span class="main">=</span> 
  <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟶</span> <span class="free">I</span> <span class="bound">s</span><span class="main">)</span> <span class="main">=</span> <span class="main">|</span><span class="keyword1">x´=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">f</span><span class="main">)</span> <span class="main">&amp;</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> True<span class="main">)</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="main">0</span><span class="main">]</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟶</span> <span class="free">I</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> fbox_diff_inv<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> fbox_g_ode_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> le_fun_def fun_eq_iff<span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="main">0</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> ballE<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> init_time in_domain ivp<span class="main">(</span>2<span class="main">)</span> assms <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">force</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">x</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">t</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> ballE<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> in_domain ivp<span class="main">(</span>2<span class="main">)</span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> diff_inv_eq_inv_set<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"diff_invariant <span class="free">I</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">f</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">T</span><span class="main">)</span> <span class="free">S</span> <span class="main">0</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> True<span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">s</span><span class="main">.</span> <span class="free">I</span> <span class="bound">s</span> <span class="main">⟶</span> <span class="keyword1">γ<span class="hidden">⇧</span><sup>φ</sup></span> <span class="bound">s</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="free">I</span> <span class="bound">s</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> diff_inv_eq_inv_set orbit_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemma</span></span> fbox_g_odei<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">≤</span> <span class="free">I</span> <span class="main">⟹</span> <span class="free">I</span> <span class="main">≤</span> <span class="main">|</span><span class="keyword1">x´=</span> <span class="free">f</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">]</span> <span class="free">I</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">I</span> <span class="bound">s</span> <span class="main">∧</span> <span class="free">G</span> <span class="bound">s</span><span class="main">)</span> <span class="main">≤</span> <span class="free">Q</span> <span class="main">⟹</span> 
  <span class="free">P</span> <span class="main">≤</span> <span class="main">|</span><span class="keyword1">x´=</span> <span class="free">f</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="keyword1">DINV</span> <span class="free">I</span><span class="main">]</span> <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> g_ode_inv_def 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> b<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">|</span><span class="keyword1">x´=</span> <span class="free">f</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">]</span> <span class="free">I</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> order.trans<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> I<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">I</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> fbox_g_orbital_inv<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> fbox_g_orbital_guard<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> fbox_iso<span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹ Derivation of the rules of dL ›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ We derive rules of differential dynamic logic (dL). This allows the components to reason 
in the style of that logic. ›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">g_dl_ode</span> <span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>banach<span class="main">)</span><span class="main">⇒</span><span class="tfree">'a</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> pred <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> set"</span></span> 
  <span class="main">(</span><span class="quoted">"<span class="keyword3">(1</span><span class="keyword1">x´=</span>_ <span class="keyword1">&amp;</span> _<span class="keyword3">)</span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1"><span class="free">x´=</span></span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main"><span class="free">&amp;</span></span> <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span> <span class="main">≡</span> <span class="main">(</span><span class="keyword1">x´=</span><span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="main">&amp;</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="keyword1">on</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">{</span><span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">≥</span> <span class="main">0</span><span class="main">}</span><span class="main">)</span> UNIV <span class="main">@</span> <span class="main">0</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">g_dl_ode_inv</span> <span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>banach<span class="main">)</span><span class="main">⇒</span><span class="tfree">'a</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> pred <span class="main">⇒</span> <span class="tfree">'a</span> pred <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> set"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword3">(1</span><span class="keyword1">x´=</span>_ <span class="keyword1">&amp;</span> _ <span class="keyword1">DINV</span> _<span class="keyword3">)</span>"</span><span class="main">)</span> 
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1"><span class="free">x´=</span></span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main"><span class="free">&amp;</span></span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="keyword1"><span class="free">DINV</span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">)</span> <span class="main">≡</span> <span class="main">(</span><span class="keyword1">x´=</span><span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="main">&amp;</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="keyword1">on</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">{</span><span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">≥</span> <span class="main">0</span><span class="main">}</span><span class="main">)</span> UNIV <span class="main">@</span> <span class="main">0</span> <span class="keyword1">DINV</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> diff_solve_axiom1<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"local_flow <span class="free">f</span> UNIV UNIV <span class="free">φ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">|</span><span class="keyword1">x´=</span> <span class="free">f</span> <span class="main">&amp;</span> <span class="free">G</span><span class="main">]</span> <span class="free">Q</span> <span class="main">=</span> 
  <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound"><span class="bound">t</span></span><span class="main">≥</span><span class="main">0</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">τ</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="bound">t</span><span class="main">}</span><span class="main">.</span> <span class="free">G</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">τ</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">Q</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">t</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> local_flow.fbox_g_ode_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> diff_solve_axiom2<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">c</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>heine_borel<span class="main">,</span> banach<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">|</span><span class="keyword1">x´=</span><span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">c</span><span class="main">)</span> <span class="main">&amp;</span> <span class="free">G</span><span class="main">]</span> <span class="free">Q</span> <span class="main">=</span> 
  <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound"><span class="bound">t</span></span><span class="main">≥</span><span class="main">0</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">τ</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="bound">t</span><span class="main">}</span><span class="main">.</span> <span class="free">G</span> <span class="main">(</span><span class="bound">s</span> <span class="main">+</span> <span class="bound">τ</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">c</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">Q</span> <span class="main">(</span><span class="bound">s</span> <span class="main">+</span> <span class="bound">t</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">c</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> local_flow.fbox_g_ode_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> line_is_local_flow<span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">UNIV</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> diff_solve_rule<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"local_flow <span class="free">f</span> UNIV UNIV <span class="free">φ</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">t</span></span><span class="main">≥</span><span class="main">0</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">τ</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="bound">t</span><span class="main">}</span><span class="main">.</span> <span class="free">G</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">τ</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">Q</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">t</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">≤</span> <span class="main">|</span><span class="keyword1">x´=</span> <span class="free">f</span> <span class="main">&amp;</span> <span class="free">G</span><span class="main">]</span> <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">subst</span> local_flow.fbox_g_ode_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> diff_weak_axiom1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span> <span class="main">|</span><span class="keyword1">x´=</span> <span class="free">f</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">]</span> <span class="free">G</span><span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> fbox_def g_orbital_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> diff_weak_axiom2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">|</span><span class="keyword1">x´=</span> <span class="free">f</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="free">T</span> <span class="free">S</span> <span class="main">@</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">]</span> <span class="free">Q</span> <span class="main">=</span> <span class="main">|</span><span class="keyword1">x´=</span> <span class="free">f</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="free">T</span> <span class="free">S</span> <span class="main">@</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">]</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">G</span> <span class="bound">s</span> <span class="main">⟶</span> <span class="free">Q</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> fbox_g_orbital image_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  
<span class="keyword1"><span class="command">lemma</span></span> diff_weak_rule<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">G</span> <span class="main">≤</span> <span class="free">Q</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">≤</span> <span class="main">|</span><span class="keyword1">x´=</span> <span class="free">f</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="free">T</span> <span class="free">S</span> <span class="main">@</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">]</span> <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> g_orbitalD <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> le_fun_def g_orbital_eq fbox_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fbox_g_orbital_eq_univD<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">|</span><span class="keyword1">x´=</span> <span class="free">f</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">]</span> <span class="free">C</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> True<span class="main">)</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">τ</span><span class="main">∈</span><span class="main">(</span>down <span class="main">(</span><span class="free">U</span> <span class="free">s</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span><span class="main">.</span> <span class="free">x</span> <span class="bound">τ</span> <span class="main">∈</span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="free">f</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">τ</span><span class="main">∈</span><span class="main">(</span>down <span class="main">(</span><span class="free">U</span> <span class="free">s</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span><span class="main">.</span> <span class="free">C</span> <span class="main">(</span><span class="free">x</span> <span class="bound">τ</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">τ</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">τ</span> <span class="main">∈</span> <span class="main">(</span>down <span class="main">(</span><span class="free">U</span> <span class="free">s</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="skolem">τ</span> <span class="main">∈</span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="free">f</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="free">s</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s'</span><span class="main">.</span> <span class="bound">s'</span> <span class="main">∈</span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="free">f</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="free">s</span> <span class="main">⟶</span> <span class="free">C</span> <span class="bound">s'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> fbox_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">meson</span> 
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">(</span><span class="free">x</span> <span class="skolem">τ</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> diff_cut_axiom<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">|</span><span class="keyword1">x´=</span> <span class="free">f</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">]</span> <span class="free">C</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> True<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">|</span><span class="keyword1">x´=</span> <span class="free">f</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">]</span> <span class="free">Q</span> <span class="main">=</span> <span class="main">|</span><span class="keyword1">x´=</span> <span class="free">f</span> <span class="main">&amp;</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">G</span> <span class="bound">s</span> <span class="main">∧</span> <span class="free">C</span> <span class="bound">s</span><span class="main">)</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">]</span> <span class="free">Q</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule_tac</span> f<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="main">|</span><span class="bound">x</span><span class="main">]</span> <span class="free">Q</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> HOL.arg_cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> subset_antisym<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> 
  <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s'</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s'</span> <span class="main">∈</span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="free">f</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">τ</span></span><span class="main">::</span><span class="quoted">real</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem"><span class="skolem">X</span></span> <span class="keyword2"><span class="keyword">where</span></span> x_ivp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> <span class="keyword1">Sols</span> <span class="free">f</span> <span class="free">U</span> <span class="free">S</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">s</span>"</span></span> 
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="skolem">τ</span> <span class="main">=</span> <span class="skolem">s'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">τ</span> <span class="main">∈</span> <span class="free">U</span> <span class="skolem">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> guard_x<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="keyword1">𝒫</span> <span class="skolem">X</span> <span class="main">(</span>down <span class="main">(</span><span class="free">U</span> <span class="skolem">s</span><span class="main">)</span> <span class="skolem">τ</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="free">G</span> <span class="bound">s</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> g_orbitalD<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">s'</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span>"</span></span> <span class="quoted"><span class="free">G</span></span> <span class="quoted"><span class="free">U</span></span> <span class="quoted"><span class="free">S</span></span> <span class="quoted"><span class="free">t<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="quoted"><span class="skolem">s</span></span><span class="main">]</span>  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t</span><span class="main">∈</span><span class="main">(</span>down <span class="main">(</span><span class="free">U</span> <span class="skolem">s</span><span class="main">)</span> <span class="skolem">τ</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">𝒫</span> <span class="skolem">X</span> <span class="main">(</span>down <span class="main">(</span><span class="free">U</span> <span class="skolem">s</span><span class="main">)</span> <span class="bound">t</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="free">G</span> <span class="bound">s</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> guard_x <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> image_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t</span><span class="main">∈</span><span class="main">(</span>down <span class="main">(</span><span class="free">U</span> <span class="skolem">s</span><span class="main">)</span> <span class="skolem">τ</span><span class="main">)</span><span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> <span class="free">U</span> <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">τ</span> <span class="main">∈</span> <span class="free">U</span> <span class="skolem">s</span>›</span></span> closed_segment_subset_interval <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t</span><span class="main">∈</span><span class="main">(</span>down <span class="main">(</span><span class="free">U</span> <span class="skolem">s</span><span class="main">)</span> <span class="skolem">τ</span><span class="main">)</span><span class="main">.</span> <span class="skolem">X</span> <span class="bound">t</span> <span class="main">∈</span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="free">f</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> g_orbitalI<span class="main">[</span><span class="operator">OF</span> x_ivp<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t</span><span class="main">∈</span><span class="main">(</span>down <span class="main">(</span><span class="free">U</span> <span class="skolem">s</span><span class="main">)</span> <span class="skolem">τ</span><span class="main">)</span><span class="main">.</span> <span class="free">C</span> <span class="main">(</span><span class="skolem">X</span> <span class="bound">t</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> fbox_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">meson</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s'</span> <span class="main">∈</span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="free">f</span> <span class="main">&amp;</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">G</span> <span class="bound">s</span> <span class="main">∧</span> <span class="free">C</span> <span class="bound">s</span><span class="main">)</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> g_orbitalI<span class="main">[</span><span class="operator">OF</span> x_ivp <span class="quoted"><span class="quoted">‹<span class="skolem">τ</span> <span class="main">∈</span> <span class="free">U</span> <span class="skolem">s</span>›</span></span><span class="main">]</span> guard_x <span class="quoted"><span class="quoted">‹<span class="skolem">X</span> <span class="skolem">τ</span> <span class="main">=</span> <span class="skolem">s'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span><span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">x´=</span> <span class="free">f</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="skolem">s</span> <span class="main">⊆</span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="free">f</span> <span class="main">&amp;</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">G</span> <span class="bound">s</span> <span class="main">∧</span> <span class="free">C</span> <span class="bound">s</span><span class="main">)</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="free">f</span> <span class="main">&amp;</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">G</span> <span class="bound">s</span> <span class="main">∧</span> <span class="free">C</span> <span class="bound">s</span><span class="main">)</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="bound">s</span> <span class="main">⊆</span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="free">f</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="bound">s</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> g_orbital_eq<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> diff_cut_rule<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> fbox_C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">≤</span> <span class="main">|</span><span class="keyword1">x´=</span> <span class="free">f</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">]</span> <span class="free">C</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> fbox_Q<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">≤</span> <span class="main">|</span><span class="keyword1">x´=</span> <span class="free">f</span> <span class="main">&amp;</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">G</span> <span class="bound">s</span> <span class="main">∧</span> <span class="free">C</span> <span class="bound">s</span><span class="main">)</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">]</span> <span class="free">Q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">≤</span> <span class="main">|</span><span class="keyword1">x´=</span> <span class="free">f</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">]</span> <span class="free">Q</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">subst</span> fbox_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> g_orbital_eq<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span><span class="main">::</span><span class="quoted">real</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">X</span><span class="main">::</span><span class="quoted"><span class="quoted">"real <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">s</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> <span class="free">U</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> x_ivp<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> <span class="keyword1">Sols</span> <span class="free">f</span> <span class="free">U</span> <span class="free">S</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">s</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> guard_x<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">τ</span><span class="main">.</span> <span class="bound">τ</span> <span class="main">∈</span> <span class="free">U</span> <span class="skolem">s</span> <span class="main">∧</span> <span class="bound">τ</span> <span class="main">≤</span> <span class="skolem">t</span> <span class="main">⟶</span> <span class="free">G</span> <span class="main">(</span><span class="skolem">X</span> <span class="bound">τ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">τ</span><span class="main">∈</span><span class="main">(</span>down <span class="main">(</span><span class="free">U</span> <span class="skolem">s</span><span class="main">)</span> <span class="skolem">t</span><span class="main">)</span><span class="main">.</span> <span class="skolem">X</span> <span class="bound">τ</span> <span class="main">∈</span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="free">f</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> g_orbitalI<span class="main">[</span><span class="operator">OF</span> x_ivp<span class="main">]</span> guard_x <span class="keyword1"><span class="command">unfolding</span></span> image_le_pred <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">τ</span><span class="main">∈</span><span class="main">(</span>down <span class="main">(</span><span class="free">U</span> <span class="skolem">s</span><span class="main">)</span> <span class="skolem">t</span><span class="main">)</span><span class="main">.</span> <span class="free">C</span> <span class="main">(</span><span class="skolem">X</span> <span class="bound">τ</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> fbox_C <span class="quoted"><span class="quoted">‹<span class="free">P</span> <span class="skolem">s</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> fbox_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="skolem">t</span> <span class="main">∈</span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="free">f</span> <span class="main">&amp;</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">G</span> <span class="bound">s</span> <span class="main">∧</span> <span class="free">C</span> <span class="bound">s</span><span class="main">)</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> guard_x <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="main">∈</span> <span class="free">U</span> <span class="skolem">s</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> g_orbitalI x_ivp<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="main">(</span><span class="skolem">X</span> <span class="skolem">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">P</span> <span class="skolem">s</span>›</span></span> fbox_Q <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> fbox_def<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> diff_inv_axiom1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">G</span> <span class="free">s</span> <span class="main">⟶</span> <span class="free">I</span> <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"diff_invariant <span class="free">I</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">f</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">{</span><span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">≥</span> <span class="main">0</span><span class="main">}</span><span class="main">)</span> UNIV <span class="main">0</span> <span class="free">G</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span> <span class="main">|</span><span class="keyword1">x´=</span> <span class="free">f</span> <span class="main">&amp;</span> <span class="free">G</span><span class="main">]</span> <span class="free">I</span><span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> fbox_g_orbital diff_invariant_eq <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">s</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main"><span class="keyword3">,</span></span> <span class="operator">frule</span> ivp_solsD<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> diff_inv_axiom2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"picard_lindeloef <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">f</span><span class="main">)</span> UNIV UNIV <span class="main">0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="main">{</span><span class="bound">t</span><span class="main">::</span>real<span class="main">.</span> <span class="bound">t</span> <span class="main">≥</span> <span class="main">0</span><span class="main">}</span> <span class="main">⊆</span> picard_lindeloef.ex_ivl <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">f</span><span class="main">)</span> UNIV UNIV <span class="main">0</span> <span class="bound">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"diff_invariant <span class="free">I</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">f</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">{</span><span class="bound">t</span><span class="main">::</span>real<span class="main">.</span> <span class="bound">t</span> <span class="main">≥</span> <span class="main">0</span><span class="main">}</span><span class="main">)</span> UNIV <span class="main">0</span> <span class="free">G</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">|</span><span class="keyword1">x´=</span> <span class="free">f</span> <span class="main">&amp;</span> <span class="free">G</span><span class="main">]</span> <span class="free">I</span> <span class="main">=</span> <span class="main">|</span><span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="bound">s</span> <span class="main">=</span> <span class="bound">x</span> <span class="main">∧</span> <span class="free">G</span> <span class="bound">s</span><span class="main">}</span><span class="main">)</span><span class="main">]</span> <span class="free">I</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">unfold</span> fbox_g_orbital<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> fbox_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fun_eq_iff<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="quoted"><span class="quoted">"<span class="var">?ex_ivl</span> <span class="skolem">s</span>"</span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"picard_lindeloef.ex_ivl <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">f</span><span class="main">)</span> UNIV UNIV <span class="main">0</span> <span class="skolem">s</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="skolem">s</span>"</span></span> <span class="main">=</span> 
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">X</span><span class="main">∈</span><span class="keyword1">Sols</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">f</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">{</span><span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">≥</span> <span class="main">0</span><span class="main">}</span><span class="main">)</span> UNIV <span class="main">0</span> <span class="skolem">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound"><span class="bound">t</span></span><span class="main">≥</span><span class="main">0</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">τ</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="bound">τ</span> <span class="main">∧</span> <span class="bound">τ</span> <span class="main">≤</span> <span class="bound">t</span> <span class="main">⟶</span> <span class="free">G</span> <span class="main">(</span><span class="bound">X</span> <span class="bound">τ</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">I</span> <span class="main">(</span><span class="bound">X</span> <span class="bound">t</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">X</span></span> <span class="keyword2"><span class="keyword">where</span></span> xivp1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> <span class="keyword1">Sols</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">f</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="var">?ex_ivl</span> <span class="bound">s</span><span class="main">)</span> UNIV <span class="main">0</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> picard_lindeloef.flow_in_ivp_sols_ex_ivl<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> xivp2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> <span class="keyword1">Sols</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">f</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> Collect <span class="main">(</span><span class="main">(≤)</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> UNIV <span class="main">0</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> in_ivp_sols_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ _ xivp1<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> shyp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">0</span> <span class="main">=</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ivp_solsD <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> dinv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s</span><span class="main">.</span> <span class="free">I</span> <span class="bound">s</span> <span class="main">⟶</span> <span class="var">?lhs</span> <span class="bound">s</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> diff_invariant_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="skolem">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">G</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">X</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> ballE<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="main">0</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> shyp xivp2<span class="main">)</span><span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="skolem">s</span> <span class="main">⟶</span> <span class="main">(</span><span class="free">G</span> <span class="skolem">s</span> <span class="main">⟶</span> <span class="free">I</span> <span class="skolem">s</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">G</span> <span class="skolem">s</span> <span class="main">⟶</span> <span class="free">I</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarify</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">τ</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="bound">τ</span> <span class="main">∧</span> <span class="bound">τ</span> <span class="main">≤</span> <span class="improper">t</span> <span class="main">⟶</span> <span class="free">G</span> <span class="main">(</span><span class="improper">X</span> <span class="bound">τ</span><span class="main">)</span>"</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="main">0</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main"><span class="keyword3">,</span></span> <span class="operator">frule</span> ivp_solsD<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> dinv <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span><span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="skolem">s</span> <span class="main">=</span> <span class="main">(</span><span class="free">G</span> <span class="skolem">s</span> <span class="main">⟶</span> <span class="free">I</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> diff_inv_rule<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">≤</span> <span class="free">I</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"diff_invariant <span class="free">I</span> <span class="free">f</span> <span class="free">U</span> <span class="free">S</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">G</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">≤</span> <span class="free">Q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">≤</span> <span class="main">|</span><span class="keyword1">x´=</span> <span class="free">f</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">]</span> <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> fbox_g_orbital_inv<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> _ assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> fbox_diff_inv <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="HS_VC_Examples">
<div class="head">
<h1>Theory HS_VC_Examples</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:       Examples of hybrid systems verifications
    Author:      Jonathan Julián Huerta y Munive, 2020
    Maintainer:  Jonathan Julián Huerta y Munive &lt;jonjulian23@gmail.com&gt;
*)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹ Examples ›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ We prove partial correctness specifications of some hybrid systems with our
verification components.›</span></span>

<span class="keyword1"><span class="command">theory</span></span> HS_VC_Examples
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="HS_VC_Spartan.html">HS_VC_Spartan</a>

<span class="keyword2"><span class="keyword">begin</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Pendulum›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ The ODEs <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"x' t = y t"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and {text "y' t = - x t"} describe the circular motion of
a mass attached to a string looked from above. We use <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"s$1"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> to represent the x-coordinate
and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"s$2"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> for the y-coordinate. We prove that this motion remains circular. ›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">fpend</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real<span class="main">^</span><span class="numeral">2</span> <span class="main">⇒</span> real<span class="main">^</span><span class="numeral">2</span>"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">f</span>"</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">f</span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="keyword1">χ</span> <span class="bound">i</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">i</span> <span class="main">=</span> <span class="main">1</span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="numeral">2</span> <span class="keyword1">else</span> <span class="main">-</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="main">1</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">pend_flow</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real <span class="main">⇒</span> real<span class="main">^</span><span class="numeral">2</span> <span class="main">⇒</span> real<span class="main">^</span><span class="numeral">2</span>"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">φ</span>"</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">φ</span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="keyword1">χ</span> <span class="bound">i</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">i</span> <span class="main">=</span> <span class="main">1</span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="main">1</span> <span class="main">*</span> cos <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="numeral">2</span> <span class="main">*</span> sin <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">else</span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="main">1</span> <span class="main">*</span> sin <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="numeral">2</span> <span class="main">*</span> cos <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>

<span class="comment1">― ‹Verified with annotated dynamics. ›</span>

<span class="keyword1"><span class="command">lemma</span></span> pendulum_dyn<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">=</span> <span class="main">(</span><span class="bound">s</span><span class="main">$</span><span class="main">1</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">+</span> <span class="main">(</span><span class="bound">s</span><span class="main">$</span><span class="numeral">2</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span> <span class="main">≤</span> <span class="main">|</span><span class="keyword1">EVOL</span> <span class="keyword1">φ</span> <span class="free">G</span> <span class="free">T</span><span class="main">]</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">=</span> <span class="main">(</span><span class="bound">s</span><span class="main">$</span><span class="main">1</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">+</span> <span class="main">(</span><span class="bound">s</span><span class="main">$</span><span class="numeral">2</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="comment1">― ‹Verified with differential invariants. ›</span>

<span class="keyword1"><span class="command">lemma</span></span> pendulum_inv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">=</span> <span class="main">(</span><span class="bound">s</span><span class="main">$</span><span class="main">1</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">+</span> <span class="main">(</span><span class="bound">s</span><span class="main">$</span><span class="numeral">2</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span> <span class="main">≤</span> <span class="main">|</span><span class="keyword1">x´=</span> <span class="keyword1">f</span> <span class="main">&amp;</span> <span class="free">G</span><span class="main">]</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">=</span> <span class="main">(</span><span class="bound">s</span><span class="main">$</span><span class="main">1</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">+</span> <span class="main">(</span><span class="bound">s</span><span class="main">$</span><span class="numeral">2</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">diff_invariant_rules</span></span> <span class="dynamic"><span class="dynamic">poly_derivatives</span></span><span class="main">)</span>

<span class="comment1">― ‹Verified with the flow. ›</span>

<span class="keyword1"><span class="command">lemma</span></span> local_flow_pend<span class="main">:</span> <span class="quoted"><span class="quoted">"local_flow <span class="keyword1">f</span> UNIV UNIV <span class="keyword1">φ</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> local_lipschitz_def lipschitz_on_def vec_eq_iff<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="main">1</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dist_norm norm_vec_def L2_set_def power2_commute UNIV_2<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> forall_2 <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">poly_derivatives</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> pendulum_flow<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">=</span> <span class="main">(</span><span class="bound">s</span><span class="main">$</span><span class="main">1</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">+</span> <span class="main">(</span><span class="bound">s</span><span class="main">$</span><span class="numeral">2</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span> <span class="main">≤</span> <span class="main">|</span><span class="keyword1">x´=</span><span class="keyword1">f</span> <span class="main">&amp;</span> <span class="free">G</span><span class="main">]</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">=</span> <span class="main">(</span><span class="bound">s</span><span class="main">$</span><span class="main">1</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">+</span> <span class="main">(</span><span class="bound">s</span><span class="main">$</span><span class="numeral">2</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> local_flow.fbox_g_ode_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> local_flow_pend<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">no_notation</span></span> fpend <span class="main">(</span><span class="quoted">"<span class="keyword1">f</span>"</span><span class="main">)</span>
        <span class="keyword2"><span class="keyword">and</span></span> pend_flow <span class="main">(</span><span class="quoted">"<span class="keyword1">φ</span>"</span><span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹ Bouncing Ball ›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ A ball is dropped from rest at an initial height <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"h"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. The motion is described with
the free-fall equations <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"x' t = v t"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"v' t = g"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> where <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"g"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is the
constant acceleration due to gravity. The bounce is modelled with a variable assignment that
flips the velocity. That is, we model it as a completely elastic collision with the ground. We use 
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"s$1"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> to represent the ball's height and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"s$2"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> for its velocity. We prove that the 
ball remains above ground and below its initial resting position. ›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">fball</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real <span class="main">⇒</span> real<span class="main">^</span><span class="numeral">2</span> <span class="main">⇒</span> real<span class="main">^</span><span class="numeral">2</span>"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">f</span>"</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">f</span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="keyword1">χ</span> <span class="bound">i</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">i</span> <span class="main">=</span> <span class="main">1</span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="numeral">2</span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">ball_flow</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real <span class="main">⇒</span> real <span class="main">⇒</span> real<span class="main">^</span><span class="numeral">2</span> <span class="main">⇒</span> real<span class="main">^</span><span class="numeral">2</span>"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">φ</span>"</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">φ</span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="keyword1">χ</span> <span class="bound">i</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">i</span> <span class="main">=</span> <span class="main">1</span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">*</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">^</span> <span class="numeral">2</span><span class="main">/</span><span class="numeral">2</span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="numeral">2</span> <span class="main">*</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="main">1</span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">*</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="numeral">2</span><span class="main">)</span>"</span></span>

<span class="comment1">― ‹Verified with differential invariants. ›</span>

<span class="keyword1"><span class="command">named_theorems</span></span> bb_real_arith <span class="quoted">"real arithmetic properties for the bouncing ball."</span>

<span class="keyword1"><span class="command">lemma</span></span> inv_imp_pos_le<span class="main">[</span><span class="operator">bb_real_arith</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&gt;</span> <span class="free">g</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">*</span> <span class="free">g</span> <span class="main">*</span> <span class="free">x</span> <span class="main">-</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">g</span> <span class="main">*</span> <span class="free">h</span> <span class="main">=</span> <span class="free">v</span> <span class="main">*</span> <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">::</span>real<span class="main">)</span> <span class="main">≤</span> <span class="free">h</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">*</span> <span class="free">v</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">g</span> <span class="main">*</span> <span class="free">x</span> <span class="main">-</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">g</span> <span class="main">*</span> <span class="free">h</span> <span class="main">∧</span> <span class="main">0</span> <span class="main">&gt;</span> <span class="free">g</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> inv <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&gt;</span> <span class="free">g</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> obs<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">*</span> <span class="free">v</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">g</span> <span class="main">*</span> <span class="main">(</span><span class="free">x</span> <span class="main">-</span> <span class="free">h</span><span class="main">)</span> <span class="main">∧</span> <span class="main">0</span> <span class="main">&gt;</span> <span class="free">g</span> <span class="main">∧</span> <span class="free">v</span> <span class="main">*</span> <span class="free">v</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> left_diff_distrib mult.commute <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> zero_le_square<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">v</span> <span class="main">*</span> <span class="free">v</span><span class="main">)</span><span class="main">/</span><span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">g</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span> <span class="main">-</span> <span class="free">h</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> obs <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">v</span> <span class="main">*</span> <span class="free">v</span><span class="main">)</span><span class="main">/</span><span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">g</span><span class="main">)</span> <span class="main">≤</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> divide_nonneg_neg <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">-</span> <span class="free">x</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"diff_invariant <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">g</span> <span class="main">*</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">-</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">g</span> <span class="main">*</span> <span class="free">h</span> <span class="main">-</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span> <span class="main">*</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="keyword1">f</span> <span class="free">g</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> UNIV<span class="main">)</span> <span class="free">S</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">G</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">poly_derivatives</span></span> <span class="dynamic"><span class="dynamic">diff_invariant_rules</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> bouncing_ball_inv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free">h</span> <span class="main">≥</span> <span class="main">0</span> <span class="main">⟹</span>
  <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">=</span> <span class="free">h</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="main">≤</span>
  <span class="main">|</span><span class="keyword1">LOOP</span> <span class="main">(</span>
    <span class="main">(</span><span class="keyword1">x´=</span><span class="main">(</span><span class="keyword1">f</span> <span class="free">g</span><span class="main">)</span> <span class="main">&amp;</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">≥</span> <span class="main">0</span><span class="main">)</span> <span class="keyword1">DINV</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">g</span> <span class="main">*</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">-</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">g</span> <span class="main">*</span> <span class="free">h</span> <span class="main">-</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span> <span class="main">*</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">;</span>
    <span class="main">(</span><span class="keyword1">IF</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="keyword1">THEN</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">::=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">-</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">ELSE</span> skip<span class="main">)</span><span class="main">)</span>
  <span class="keyword1">INV</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">∧</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">g</span> <span class="main">*</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">-</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">g</span> <span class="main">*</span> <span class="free">h</span> <span class="main">-</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span> <span class="main">*</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span><span class="main">]</span>
  <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">≤</span> <span class="free">h</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> fbox_loopI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">bb_real_arith</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> fbox_g_odei<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">poly_derivatives</span></span> <span class="dynamic"><span class="dynamic">diff_invariant_rules</span></span><span class="main">)</span>

<span class="comment1">― ‹Verified with annotated dynamics. ›</span>

<span class="keyword1"><span class="command">lemma</span></span> inv_conserv_at_ground<span class="main">[</span><span class="operator">bb_real_arith</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> invar<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">*</span> <span class="free">g</span> <span class="main">*</span> <span class="free">x</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">g</span> <span class="main">*</span> <span class="free">h</span> <span class="main">+</span> <span class="free">v</span> <span class="main">*</span> <span class="free">v</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> pos<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">*</span> <span class="free">τ</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">+</span> <span class="free">v</span> <span class="main">*</span> <span class="free">τ</span> <span class="main">+</span> <span class="main">(</span><span class="free">x</span><span class="main">::</span>real<span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">*</span> <span class="free">g</span> <span class="main">*</span> <span class="free">h</span> <span class="main">+</span> <span class="main">(</span><span class="free">g</span> <span class="main">*</span> <span class="free">τ</span> <span class="main">+</span> <span class="free">v</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">g</span> <span class="main">*</span> <span class="free">τ</span> <span class="main">+</span> <span class="free">v</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> pos <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">*</span> <span class="free">τ</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span>  <span class="main">+</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">v</span> <span class="main">*</span> <span class="free">τ</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">*</span> <span class="free">τ</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span>  <span class="main">+</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">g</span> <span class="main">*</span> <span class="free">v</span> <span class="main">*</span> <span class="free">τ</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">g</span> <span class="main">*</span> <span class="free">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> Groups.mult_ac<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>3<span class="main"><span class="main">)</span></span> mult_zero_right
        monoid_mult_class.power2_eq_square semiring_class.distrib_left<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">*</span> <span class="free">τ</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">g</span> <span class="main">*</span> <span class="free">v</span> <span class="main">*</span> <span class="free">τ</span> <span class="main">+</span> <span class="free">v</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">g</span> <span class="main">*</span> <span class="free">h</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> invar <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> monoid_mult_class.power2_eq_square<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> obs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">g</span> <span class="main">*</span> <span class="free">τ</span> <span class="main">+</span> <span class="free">v</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">g</span> <span class="main">*</span> <span class="free">h</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> power2_sum<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> Groups.add_ac<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">,</span></span> 3<span class="main"><span class="main">)</span></span>
        Groups.mult_ac<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">,</span></span> 3<span class="main"><span class="main">)</span></span> monoid_mult_class.power2_eq_square nat_distrib<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">*</span> <span class="free">g</span> <span class="main">*</span> <span class="free">h</span> <span class="main">+</span> <span class="main">(</span><span class="free">g</span> <span class="main">*</span> <span class="free">τ</span> <span class="main">+</span> <span class="free">v</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">g</span> <span class="main">*</span> <span class="free">τ</span> <span class="main">+</span> <span class="free">v</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add.commute distrib_right power2_eq_square<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> inv_conserv_at_air<span class="main">[</span><span class="operator">bb_real_arith</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> invar<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">*</span> <span class="free">g</span> <span class="main">*</span> <span class="free">x</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">g</span> <span class="main">*</span> <span class="free">h</span> <span class="main">+</span> <span class="free">v</span> <span class="main">*</span> <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">*</span> <span class="free">g</span> <span class="main">*</span> <span class="main">(</span><span class="free">g</span> <span class="main">*</span> <span class="free">τ</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">+</span> <span class="free">v</span> <span class="main">*</span> <span class="free">τ</span> <span class="main">+</span> <span class="main">(</span><span class="free">x</span><span class="main">::</span>real<span class="main">)</span><span class="main">)</span> <span class="main">=</span>
  <span class="numeral">2</span> <span class="main">*</span> <span class="free">g</span> <span class="main">*</span> <span class="free">h</span> <span class="main">+</span> <span class="main">(</span><span class="free">g</span> <span class="main">*</span> <span class="free">τ</span> <span class="main">+</span> <span class="free">v</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">g</span> <span class="main">*</span> <span class="free">τ</span> <span class="main">+</span> <span class="free">v</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="free">g</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">*</span> <span class="free">τ</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">g</span> <span class="main">*</span> <span class="free">v</span> <span class="main">*</span> <span class="free">τ</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">g</span> <span class="main">*</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span> semiring_normalization_rules<span class="main"><span class="main">(</span></span>29<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="free">g</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">*</span> <span class="free">τ</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">g</span> <span class="main">*</span> <span class="free">v</span> <span class="main">*</span> <span class="free">τ</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">g</span> <span class="main">*</span> <span class="free">h</span> <span class="main">+</span> <span class="free">v</span> <span class="main">*</span> <span class="free">v</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="var">?middle</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">subst</span> invar<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?middle</span>"</span></span><span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span><span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?rhs</span> <span class="main">=</span> <span class="free">g</span> <span class="main">*</span> <span class="free">g</span> <span class="main">*</span> <span class="main">(</span><span class="free">τ</span> <span class="main">*</span> <span class="free">τ</span><span class="main">)</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">g</span> <span class="main">*</span> <span class="free">v</span> <span class="main">*</span> <span class="free">τ</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">g</span> <span class="main">*</span> <span class="free">h</span> <span class="main">+</span> <span class="free">v</span> <span class="main">*</span> <span class="free">v</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Groups.mult_ac<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">,</span></span>3<span class="main"><span class="main">)</span></span> semiring_class.distrib_left<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="var">?middle</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> semiring_normalization_rules<span class="main"><span class="main">(</span></span>29<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?rhs</span> <span class="main">=</span> <span class="var">?middle</span>"</span></span><span class="keyword1"><span class="command">.</span></span><span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> bouncing_ball_dyn<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free">h</span> <span class="main">≥</span> <span class="main">0</span> <span class="main">⟹</span>
  <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">=</span> <span class="free">h</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="main">≤</span>
  <span class="main">|</span><span class="keyword1">LOOP</span> <span class="main">(</span>
    <span class="main">(</span><span class="keyword1">EVOL</span> <span class="main">(</span><span class="keyword1">φ</span> <span class="free">g</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">≥</span> <span class="main">0</span><span class="main">)</span> <span class="free">T</span><span class="main">)</span> <span class="main">;</span>
    <span class="main">(</span><span class="keyword1">IF</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="keyword1">THEN</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">::=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">-</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">ELSE</span> skip<span class="main">)</span><span class="main">)</span>
  <span class="keyword1">INV</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">∧</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">g</span> <span class="main">*</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">g</span> <span class="main">*</span> <span class="free">h</span> <span class="main">+</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span> <span class="main">*</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span><span class="main">)</span><span class="main">]</span>
  <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">≤</span> <span class="free">h</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> fbox_loopI<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">bb_real_arith</span></span><span class="main">)</span>

<span class="comment1">― ‹Verified with the flow. ›</span>

<span class="keyword1"><span class="command">lemma</span></span> local_flow_ball<span class="main">:</span> <span class="quoted"><span class="quoted">"local_flow <span class="main">(</span><span class="keyword1">f</span> <span class="free">g</span><span class="main">)</span> UNIV UNIV <span class="main">(</span><span class="keyword1">φ</span> <span class="free">g</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> local_lipschitz_def lipschitz_on_def vec_eq_iff<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">1</span><span class="main">/</span><span class="numeral">2</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="main">1</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dist_norm norm_vec_def L2_set_def UNIV_2<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> forall_2 <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">poly_derivatives</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> bouncing_ball_flow<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free">h</span> <span class="main">≥</span> <span class="main">0</span> <span class="main">⟹</span>
  <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">=</span> <span class="free">h</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="main">≤</span>
  <span class="main">|</span><span class="keyword1">LOOP</span> <span class="main">(</span>
    <span class="main">(</span><span class="keyword1">x´=</span><span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="keyword1">f</span> <span class="free">g</span><span class="main">)</span> <span class="main">&amp;</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">≥</span> <span class="main">0</span><span class="main">)</span> <span class="keyword1">on</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> UNIV<span class="main">)</span> UNIV <span class="main">@</span> <span class="main">0</span><span class="main">)</span> <span class="main">;</span>
    <span class="main">(</span><span class="keyword1">IF</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="keyword1">THEN</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">::=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">-</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">ELSE</span> skip<span class="main">)</span><span class="main">)</span>
  <span class="keyword1">INV</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">∧</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">g</span> <span class="main">*</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">g</span> <span class="main">*</span> <span class="free">h</span> <span class="main">+</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span> <span class="main">*</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span><span class="main">)</span><span class="main">]</span>
  <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">≤</span> <span class="free">h</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> fbox_loopI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> local_flow.fbox_g_ode_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> local_flow_ball<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">bb_real_arith</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">no_notation</span></span> fball <span class="main">(</span><span class="quoted">"<span class="keyword1">f</span>"</span><span class="main">)</span>
        <span class="keyword2"><span class="keyword">and</span></span> ball_flow <span class="main">(</span><span class="quoted">"<span class="keyword1">φ</span>"</span><span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹ Thermostat ›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ A thermostat has a chronometer, a thermometer and a switch to turn on and off a heater.
At most every <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"t"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> minutes, it sets its chronometer to <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">0</span></span><span class="main"><span class="main">::</span></span>real"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, it registers
the room temperature, and it turns the heater on (or off) based on this reading. The temperature
follows the ODE <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"T' = - a * (T - U)"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> where <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"U"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"L ≥ 0"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> when the heater
is on, and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"0"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> when it is off. We use <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">1</span></span><span class="main"><span class="main">::</span></span><span class="numeral"><span class="numeral">4</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> to denote the room's temperature,
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="numeral"><span class="numeral">2</span></span><span class="main"><span class="main">::</span></span><span class="numeral"><span class="numeral">4</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is time as measured by the thermostat's chronometer, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="numeral"><span class="numeral">3</span></span><span class="main"><span class="main">::</span></span><span class="numeral"><span class="numeral">4</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is the
temperature detected by the thermometer, and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="numeral"><span class="numeral">4</span></span><span class="main"><span class="main">::</span></span><span class="numeral"><span class="numeral">4</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> states whether the heater is on
(<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"s$4 = 1"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>) or off (<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"s$4 = 0"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>). We prove that the thermostat keeps the room's
temperature between <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"Tmin"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"Tmax"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. ›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">temp_vec_field</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real <span class="main">⇒</span> real <span class="main">⇒</span> real<span class="main">^</span><span class="numeral">4</span> <span class="main">⇒</span> real<span class="main">^</span><span class="numeral">4</span>"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">f</span>"</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">f</span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="keyword1">χ</span> <span class="bound">i</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">i</span> <span class="main">=</span> <span class="numeral">2</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">i</span> <span class="main">=</span> <span class="main">1</span> <span class="keyword1">then</span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">*</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="main">1</span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">L</span></span></span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">temp_flow</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real <span class="main">⇒</span> real <span class="main">⇒</span> real <span class="main">⇒</span> real<span class="main">^</span><span class="numeral">4</span> <span class="main">⇒</span> real<span class="main">^</span><span class="numeral">4</span>"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">φ</span>"</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">φ</span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="keyword1">χ</span> <span class="bound">i</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">i</span> <span class="main">=</span> <span class="main">1</span> <span class="keyword1">then</span> <span class="main">-</span> exp<span class="main">(</span><span class="main">-</span><span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">*</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="keyword1">else</span>
  <span class="main">(</span><span class="keyword1">if</span> <span class="bound">i</span> <span class="main">=</span> <span class="numeral">2</span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="numeral">2</span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="comment1">― ‹Verified with the flow. ›</span>

<span class="keyword1"><span class="command">lemma</span></span> norm_diff_temp_dyn<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">a</span> <span class="main">⟹</span> <span class="main">∥</span><span class="keyword1">f</span> <span class="free">a</span> <span class="free">L</span> <span class="free">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">-</span> <span class="keyword1">f</span> <span class="free">a</span> <span class="free">L</span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub></span><span class="main">∥</span> <span class="main">=</span> <span class="main">¦</span><span class="free">a</span><span class="main">¦</span> <span class="main">*</span> <span class="main">¦</span><span class="free">s<span class="hidden">⇩</span><sub>1</sub></span><span class="main">$</span><span class="main">1</span> <span class="main">-</span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub></span><span class="main">$</span><span class="main">1</span><span class="main">¦</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> norm_vec_def L2_set_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> UNIV_4<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> a1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> f2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">r</span> <span class="bound">ra</span><span class="main">.</span> <span class="main">¦</span><span class="main">(</span><span class="bound">r</span><span class="main">::</span>real<span class="main">)</span> <span class="main">+</span> <span class="main">-</span> <span class="bound">ra</span><span class="main">¦</span> <span class="main">=</span> <span class="main">¦</span><span class="bound">ra</span> <span class="main">+</span> <span class="main">-</span> <span class="bound">r</span><span class="main">¦</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> abs_minus_commute minus_real_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">r</span> <span class="bound">ra</span> <span class="bound">rb</span><span class="main">.</span> <span class="main">(</span><span class="bound">r</span><span class="main">::</span>real<span class="main">)</span> <span class="main">*</span> <span class="bound">ra</span> <span class="main">+</span> <span class="main">-</span> <span class="main">(</span><span class="bound">r</span> <span class="main">*</span> <span class="bound">rb</span><span class="main">)</span> <span class="main">=</span> <span class="bound">r</span> <span class="main">*</span> <span class="main">(</span><span class="bound">ra</span> <span class="main">+</span> <span class="main">-</span> <span class="bound">rb</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> minus_real_def right_diff_distrib<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="free">a</span> <span class="main">*</span> <span class="main">(</span><span class="free">s<span class="hidden">⇩</span><sub>1</sub></span><span class="main">$</span><span class="main">1</span> <span class="main">+</span> <span class="main">-</span> <span class="free">L</span><span class="main">)</span> <span class="main">+</span> <span class="main">-</span> <span class="main">(</span><span class="free">a</span> <span class="main">*</span> <span class="main">(</span><span class="free">s<span class="hidden">⇩</span><sub>2</sub></span><span class="main">$</span><span class="main">1</span> <span class="main">+</span> <span class="main">-</span> <span class="free">L</span><span class="main">)</span><span class="main">)</span><span class="main">¦</span> <span class="main">=</span> <span class="free">a</span> <span class="main">*</span> <span class="main">¦</span><span class="free">s<span class="hidden">⇩</span><sub>1</sub></span><span class="main">$</span><span class="main">1</span> <span class="main">+</span> <span class="main">-</span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub></span><span class="main">$</span><span class="main">1</span><span class="main">¦</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> a1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> abs_mult<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="free">a</span> <span class="main">*</span> <span class="main">(</span><span class="free">s<span class="hidden">⇩</span><sub>2</sub></span><span class="main">$</span><span class="main">1</span> <span class="main">-</span> <span class="free">L</span><span class="main">)</span> <span class="main">-</span> <span class="free">a</span> <span class="main">*</span> <span class="main">(</span><span class="free">s<span class="hidden">⇩</span><sub>1</sub></span><span class="main">$</span><span class="main">1</span> <span class="main">-</span> <span class="free">L</span><span class="main">)</span><span class="main">¦</span> <span class="main">=</span> <span class="free">a</span> <span class="main">*</span> <span class="main">¦</span><span class="free">s<span class="hidden">⇩</span><sub>1</sub></span><span class="main">$</span><span class="main">1</span> <span class="main">-</span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub></span><span class="main">$</span><span class="main">1</span><span class="main">¦</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> f2 minus_real_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> local_lipschitz_temp_dyn<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="main">(</span><span class="free">a</span><span class="main">::</span>real<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"local_lipschitz UNIV UNIV <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">::</span>real<span class="main">.</span> <span class="keyword1">f</span> <span class="free">a</span> <span class="free">L</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">unfold</span> local_lipschitz_def lipschitz_on_def dist_norm<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="main">1</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">a</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> norm_diff_temp_dyn<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> norm_vec_def L2_set_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> UNIV_4<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> real_sqrt_abs<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> real_le_lsqrt<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> local_flow_temp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟹</span> local_flow <span class="main">(</span><span class="keyword1">f</span> <span class="free">a</span> <span class="free">L</span><span class="main">)</span> UNIV UNIV <span class="main">(</span><span class="keyword1">φ</span> <span class="free">a</span> <span class="free">L</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">poly_derivatives</span></span> local_lipschitz_temp_dyn <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> forall_4 vec_eq_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> temp_dyn_down_real_arith<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> Thyps<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">Tmin</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">Tmin</span> <span class="main">≤</span> <span class="free">T</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">T</span> <span class="main">≤</span> <span class="free">Tmax</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> thyps<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="main">(</span><span class="free">t</span><span class="main">::</span>real<span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">τ</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">t</span><span class="main">}</span><span class="main">.</span> <span class="bound">τ</span> <span class="main">≤</span> <span class="main">-</span> <span class="main">(</span>ln <span class="main">(</span><span class="free">Tmin</span> <span class="main">/</span> <span class="free">T</span><span class="main">)</span> <span class="main">/</span> <span class="free">a</span><span class="main">)</span> "</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Tmin</span> <span class="main">≤</span> exp <span class="main">(</span><span class="main">-</span><span class="free">a</span> <span class="main">*</span> <span class="free">t</span><span class="main">)</span> <span class="main">*</span> <span class="free">T</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"exp <span class="main">(</span><span class="main">-</span><span class="free">a</span> <span class="main">*</span> <span class="free">t</span><span class="main">)</span> <span class="main">*</span> <span class="free">T</span> <span class="main">≤</span> <span class="free">Tmax</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">t</span> <span class="main">∧</span> <span class="free">t</span> <span class="main">≤</span> <span class="main">-</span> <span class="main">(</span>ln <span class="main">(</span><span class="free">Tmin</span> <span class="main">/</span> <span class="free">T</span><span class="main">)</span> <span class="main">/</span> <span class="free">a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> thyps <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"ln <span class="main">(</span><span class="free">Tmin</span> <span class="main">/</span> <span class="free">T</span><span class="main">)</span> <span class="main">≤</span> <span class="main">-</span> <span class="free">a</span> <span class="main">*</span> <span class="free">t</span> <span class="main">∧</span> <span class="main">-</span> <span class="free">a</span> <span class="main">*</span> <span class="free">t</span> <span class="main">≤</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> divide_le_cancel <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Tmin</span> <span class="main">/</span> <span class="free">T</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Thyps <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> obs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Tmin</span> <span class="main">/</span> <span class="free">T</span> <span class="main">≤</span> exp <span class="main">(</span><span class="main">-</span><span class="free">a</span> <span class="main">*</span> <span class="free">t</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"exp <span class="main">(</span><span class="main">-</span><span class="free">a</span> <span class="main">*</span> <span class="free">t</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> exp_ln exp_le_one_iff <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> exp_less_cancel_iff not_less<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">Tmin</span> <span class="main">≤</span> exp <span class="main">(</span><span class="main">-</span><span class="free">a</span> <span class="main">*</span> <span class="free">t</span><span class="main">)</span> <span class="main">*</span> <span class="free">T</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Thyps <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pos_divide_le_eq<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"exp <span class="main">(</span><span class="main">-</span><span class="free">a</span> <span class="main">*</span> <span class="free">t</span><span class="main">)</span> <span class="main">*</span> <span class="free">T</span> <span class="main">≤</span> <span class="free">Tmax</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Thyps mult_left_le_one_le<span class="main">[</span><span class="operator">OF</span> _ exp_ge_zero obs<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">T</span></span><span class="main">]</span>
      less_eq_real_def order_trans_rules<span class="main">(</span>23<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> temp_dyn_up_real_arith<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> Thyps<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Tmin</span> <span class="main">≤</span> <span class="free">T</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">T</span> <span class="main">≤</span> <span class="free">Tmax</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">Tmax</span> <span class="main">&lt;</span> <span class="main">(</span><span class="free">L</span><span class="main">::</span>real<span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> thyps<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">τ</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">t</span><span class="main">}</span><span class="main">.</span> <span class="bound">τ</span> <span class="main">≤</span> <span class="main">-</span> <span class="main">(</span>ln <span class="main">(</span><span class="main">(</span><span class="free">L</span> <span class="main">-</span> <span class="free">Tmax</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="free">L</span> <span class="main">-</span> <span class="free">T</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> <span class="free">a</span><span class="main">)</span> "</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">L</span> <span class="main">-</span> <span class="free">Tmax</span> <span class="main">≤</span> exp <span class="main">(</span><span class="main">-</span><span class="main">(</span><span class="free">a</span> <span class="main">*</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">L</span> <span class="main">-</span> <span class="free">T</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">L</span> <span class="main">-</span> exp <span class="main">(</span><span class="main">-</span><span class="main">(</span><span class="free">a</span> <span class="main">*</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">L</span> <span class="main">-</span> <span class="free">T</span><span class="main">)</span> <span class="main">≤</span> <span class="free">Tmax</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">Tmin</span> <span class="main">≤</span> <span class="free">L</span> <span class="main">-</span> exp <span class="main">(</span><span class="main">-</span><span class="main">(</span><span class="free">a</span> <span class="main">*</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">L</span> <span class="main">-</span> <span class="free">T</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">t</span> <span class="main">∧</span> <span class="free">t</span> <span class="main">≤</span> <span class="main">-</span> <span class="main">(</span>ln <span class="main">(</span><span class="main">(</span><span class="free">L</span> <span class="main">-</span> <span class="free">Tmax</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="free">L</span> <span class="main">-</span> <span class="free">T</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> <span class="free">a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> thyps <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"ln <span class="main">(</span><span class="main">(</span><span class="free">L</span> <span class="main">-</span> <span class="free">Tmax</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="free">L</span> <span class="main">-</span> <span class="free">T</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="main">-</span> <span class="free">a</span> <span class="main">*</span> <span class="free">t</span> <span class="main">∧</span> <span class="main">-</span> <span class="free">a</span> <span class="main">*</span> <span class="free">t</span> <span class="main">≤</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> divide_le_cancel <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">L</span> <span class="main">-</span> <span class="free">Tmax</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="free">L</span> <span class="main">-</span> <span class="free">T</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Thyps <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">L</span> <span class="main">-</span> <span class="free">Tmax</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="free">L</span> <span class="main">-</span> <span class="free">T</span><span class="main">)</span> <span class="main">≤</span> exp <span class="main">(</span><span class="main">-</span><span class="free">a</span> <span class="main">*</span> <span class="free">t</span><span class="main">)</span> <span class="main">∧</span> exp <span class="main">(</span><span class="main">-</span><span class="free">a</span> <span class="main">*</span> <span class="free">t</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> exp_ln exp_le_one_iff <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> exp_less_cancel_iff not_less<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">L</span> <span class="main">-</span> <span class="free">T</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Thyps <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> obs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">L</span> <span class="main">-</span> <span class="free">Tmax</span><span class="main">)</span> <span class="main">≤</span> exp <span class="main">(</span><span class="main">-</span><span class="free">a</span> <span class="main">*</span> <span class="free">t</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">L</span> <span class="main">-</span> <span class="free">T</span><span class="main">)</span> <span class="main">∧</span> exp <span class="main">(</span><span class="main">-</span><span class="free">a</span> <span class="main">*</span> <span class="free">t</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">L</span> <span class="main">-</span> <span class="free">T</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="free">L</span> <span class="main">-</span> <span class="free">T</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pos_divide_le_eq<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">L</span> <span class="main">-</span> <span class="free">Tmax</span><span class="main">)</span> <span class="main">≤</span> exp <span class="main">(</span><span class="main">-</span><span class="main">(</span><span class="free">a</span> <span class="main">*</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">L</span> <span class="main">-</span> <span class="free">T</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">L</span> <span class="main">-</span> exp <span class="main">(</span><span class="main">-</span><span class="main">(</span><span class="free">a</span> <span class="main">*</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">L</span> <span class="main">-</span> <span class="free">T</span><span class="main">)</span> <span class="main">≤</span> <span class="free">Tmax</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">Tmin</span> <span class="main">≤</span> <span class="free">L</span> <span class="main">-</span> exp <span class="main">(</span><span class="main">-</span><span class="main">(</span><span class="free">a</span> <span class="main">*</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">L</span> <span class="main">-</span> <span class="free">T</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Thyps <span class="keyword2"><span class="keyword">and</span></span> obs <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> fbox_temp_dyn <span class="main">=</span> local_flow.fbox_g_ode_subset<span class="main">[</span><span class="operator">OF</span> local_flow_temp<span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> thermostat<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">Tmin</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">Tmax</span> <span class="main">&lt;</span> <span class="free">L</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">Tmin</span> <span class="main">≤</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">≤</span> <span class="free">Tmax</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">4</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="main">≤</span>
  <span class="main">|</span><span class="keyword1">LOOP</span>
    <span class="comment1">― ‹control›</span>
    <span class="main">(</span><span class="main">(</span><span class="numeral">2</span> <span class="main">::=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">;</span><span class="main">(</span><span class="numeral">3</span> <span class="main">::=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
    <span class="main">(</span><span class="keyword1">IF</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">4</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">3</span> <span class="main">≤</span> <span class="free">Tmin</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">THEN</span> <span class="main">(</span><span class="numeral">4</span> <span class="main">::=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">ELSE</span>
    <span class="main">(</span><span class="keyword1">IF</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">4</span> <span class="main">=</span> <span class="main">1</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">3</span> <span class="main">≥</span> <span class="free">Tmax</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">THEN</span> <span class="main">(</span><span class="numeral">4</span> <span class="main">::=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span><span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">ELSE</span> skip<span class="main">)</span><span class="main">)</span><span class="main">;</span>
    <span class="comment1">― ‹dynamics›</span>
    <span class="main">(</span><span class="keyword1">IF</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">4</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="keyword1">THEN</span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="keyword1">f</span> <span class="free">a</span> <span class="main">0</span> <span class="main">&amp;</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span> <span class="main">≤</span> <span class="main">-</span> <span class="main">(</span>ln <span class="main">(</span><span class="free">Tmin</span><span class="main">/</span><span class="bound">s</span><span class="main">$</span><span class="numeral">3</span><span class="main">)</span><span class="main">)</span><span class="main">/</span><span class="free">a</span><span class="main">)</span><span class="main">)</span>
    <span class="keyword1">ELSE</span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="keyword1">f</span> <span class="free">a</span> <span class="free">L</span> <span class="main">&amp;</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span> <span class="main">≤</span> <span class="main">-</span> <span class="main">(</span>ln <span class="main">(</span><span class="main">(</span><span class="free">L</span><span class="main">-</span><span class="free">Tmax</span><span class="main">)</span><span class="main">/</span><span class="main">(</span><span class="free">L</span><span class="main">-</span><span class="bound">s</span><span class="main">$</span><span class="numeral">3</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">/</span><span class="free">a</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">)</span>
  <span class="keyword1">INV</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">Tmin</span> <span class="main">≤</span><span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">≤</span> <span class="free">Tmax</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">s</span><span class="main">$</span><span class="numeral">4</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">4</span> <span class="main">=</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">]</span>
  <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">Tmin</span> <span class="main">≤</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">≤</span> <span class="free">Tmax</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> fbox_loopI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fbox_temp_dyn<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span> le_fun_def<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> temp_dyn_up_real_arith<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span>1<span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span> _ _ assms<span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span>3<span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">Tmin</span></span></span></span></span></span><span class="main">]</span>
    <span class="keyword2"><span class="keyword">and</span></span> temp_dyn_down_real_arith<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">,</span></span></span>2<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main">,</span> <span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">Tmax</span></span></span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">no_notation</span></span> temp_vec_field <span class="main">(</span><span class="quoted">"<span class="keyword1">f</span>"</span><span class="main">)</span>
        <span class="keyword2"><span class="keyword">and</span></span> temp_flow <span class="main">(</span><span class="quoted">"<span class="keyword1">φ</span>"</span><span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹ Tank ›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ A controller turns a water pump on and off to keep the level of water <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"h"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> in a tank
within an acceptable range <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"hmin ≤ h ≤ hmax"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. Just like in the previous example, after 
each intervention, the controller registers the current level of water and resets its chronometer,
then it changes the status of the water pump accordingly. The level of water grows linearly 
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"h' = k"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> at a rate of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"k = c<span class="hidden">⇩</span><sub>i</sub>-c<span class="hidden">⇩</span><sub>o</sub>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> if the pump is on, and at a rate of 
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"k = -c<span class="hidden">⇩</span><sub>o</sub>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> if the pump is off. We use <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">1</span></span><span class="main"><span class="main">::</span></span><span class="numeral"><span class="numeral">4</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> to denote the tank's level of water,
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="numeral"><span class="numeral">2</span></span><span class="main"><span class="main">::</span></span><span class="numeral"><span class="numeral">4</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is time as measured by the controller's chronometer, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="numeral"><span class="numeral">3</span></span><span class="main"><span class="main">::</span></span><span class="numeral"><span class="numeral">4</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is the
level of water measured by the chronometer, and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="numeral"><span class="numeral">4</span></span><span class="main"><span class="main">::</span></span><span class="numeral"><span class="numeral">4</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> states whether the pump is on
(<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"s$4 = 1"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>) or off (<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"s$4 = 0"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>). We prove that the controller keeps the level of
water between <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"hmin"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"hmax"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. ›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">tank_vec_field</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real <span class="main">⇒</span> real<span class="main">^</span><span class="numeral">4</span> <span class="main">⇒</span> real<span class="main">^</span><span class="numeral">4</span>"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">f</span>"</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">f</span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="keyword1">χ</span> <span class="bound">i</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">i</span> <span class="main">=</span> <span class="numeral">2</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">i</span> <span class="main">=</span> <span class="main">1</span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">tank_flow</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real <span class="main">⇒</span> real <span class="main">⇒</span> real<span class="main">^</span><span class="numeral">4</span> <span class="main">⇒</span> real<span class="main">^</span><span class="numeral">4</span>"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">φ</span>"</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">φ</span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="keyword1">χ</span> <span class="bound">i</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">i</span> <span class="main">=</span> <span class="main">1</span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">*</span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="main">1</span> <span class="keyword1">else</span> 
  <span class="main">(</span><span class="keyword1">if</span> <span class="bound">i</span> <span class="main">=</span> <span class="numeral">2</span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="numeral">2</span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">tank_guard</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real <span class="main">⇒</span> real <span class="main">⇒</span> real<span class="main">^</span><span class="numeral">4</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">G</span>"</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">G</span></span> <span class="free"><span class="bound"><span class="entity">Hm</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="numeral">2</span> <span class="main">≤</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Hm</span></span></span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="numeral">3</span><span class="main">)</span><span class="main">/</span><span class="free"><span class="bound"><span class="entity">k</span></span></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">tank_loop_inv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real <span class="main">⇒</span> real <span class="main">⇒</span> real<span class="main">^</span><span class="numeral">4</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">I</span>"</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">I</span></span> <span class="free"><span class="bound"><span class="entity">hmin</span></span></span> <span class="free"><span class="bound"><span class="entity">hmax</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">hmin</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="main">1</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="main">1</span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">hmax</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="numeral">4</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="numeral">4</span> <span class="main">=</span> <span class="main">1</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">tank_diff_inv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real <span class="main">⇒</span> real <span class="main">⇒</span> real <span class="main">⇒</span> real<span class="main">^</span><span class="numeral">4</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">dI</span>"</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">dI</span></span> <span class="free"><span class="bound"><span class="entity">hmin</span></span></span> <span class="free"><span class="bound"><span class="entity">hmax</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="main">1</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">*</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="numeral">2</span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="numeral">3</span> <span class="main">∧</span> <span class="main">0</span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="numeral">2</span> <span class="main">∧</span> 
    <span class="free"><span class="bound"><span class="entity">hmin</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="numeral">3</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="numeral">3</span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">hmax</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="numeral">4</span> <span class="main">=</span><span class="main">0</span> <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="numeral">4</span> <span class="main">=</span> <span class="main">1</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> local_flow_tank<span class="main">:</span> <span class="quoted"><span class="quoted">"local_flow <span class="main">(</span><span class="keyword1">f</span> <span class="free">k</span><span class="main">)</span> UNIV UNIV <span class="main">(</span><span class="keyword1">φ</span> <span class="free">k</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> local_lipschitz_def lipschitz_on_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">1</span><span class="main">/</span><span class="numeral">2</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="main">1</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dist_norm norm_vec_def L2_set_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> UNIV_4<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">poly_derivatives</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> vec_eq_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> tank_arith<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="main">(</span><span class="free">τ</span><span class="main">::</span>real<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">c<span class="hidden">⇩</span><sub>o</sub></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">c<span class="hidden">⇩</span><sub>o</sub></span> <span class="main">&lt;</span> <span class="free">c<span class="hidden">⇩</span><sub>i</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">τ</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">τ</span><span class="main">}</span><span class="main">.</span> <span class="bound">τ</span> <span class="main">≤</span> <span class="main">-</span> <span class="main">(</span><span class="main">(</span><span class="free">hmin</span> <span class="main">-</span> <span class="free">y</span><span class="main">)</span> <span class="main">/</span> <span class="free">c<span class="hidden">⇩</span><sub>o</sub></span><span class="main">)</span> <span class="main">⟹</span>  <span class="free">hmin</span> <span class="main">≤</span> <span class="free">y</span> <span class="main">-</span> <span class="free">c<span class="hidden">⇩</span><sub>o</sub></span> <span class="main">*</span> <span class="free">τ</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">τ</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">τ</span><span class="main">}</span><span class="main">.</span> <span class="bound">τ</span> <span class="main">≤</span> <span class="main">(</span><span class="free">hmax</span> <span class="main">-</span> <span class="free">y</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="free">c<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">-</span> <span class="free">c<span class="hidden">⇩</span><sub>o</sub></span><span class="main">)</span> <span class="main">⟹</span>  <span class="main">(</span><span class="free">c<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">-</span> <span class="free">c<span class="hidden">⇩</span><sub>o</sub></span><span class="main">)</span> <span class="main">*</span> <span class="free">τ</span> <span class="main">+</span> <span class="free">y</span> <span class="main">≤</span> <span class="free">hmax</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">hmin</span> <span class="main">≤</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">hmin</span> <span class="main">≤</span> <span class="main">(</span><span class="free">c<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">-</span> <span class="free">c<span class="hidden">⇩</span><sub>o</sub></span><span class="main">)</span> <span class="main">*</span> <span class="free">τ</span> <span class="main">+</span> <span class="free">y</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">≤</span> <span class="free">hmax</span> <span class="main">⟹</span> <span class="free">y</span> <span class="main">-</span> <span class="free">c<span class="hidden">⇩</span><sub>o</sub></span> <span class="main">*</span> <span class="free">τ</span> <span class="main">≤</span> <span class="free">hmax</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span> le_divide_eq assms<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">meson</span> add_mono less_eq_real_def mult_left_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> add_increasing2 less_eq_real_def mult_nonneg_nonneg<span class="main">)</span> 

<span class="keyword1"><span class="command">lemma</span></span> tank_flow<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">c<span class="hidden">⇩</span><sub>o</sub></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">c<span class="hidden">⇩</span><sub>o</sub></span> <span class="main">&lt;</span> <span class="free">c<span class="hidden">⇩</span><sub>i</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">I</span> <span class="free">hmin</span> <span class="free">hmax</span> <span class="main">≤</span>
  <span class="main">|</span><span class="keyword1">LOOP</span> 
    <span class="comment1">― ‹control›</span>
    <span class="main">(</span><span class="main">(</span><span class="numeral">2</span> <span class="main">::=</span><span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span><span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">;</span><span class="main">(</span><span class="numeral">3</span> <span class="main">::=</span><span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
    <span class="main">(</span><span class="keyword1">IF</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">4</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">3</span> <span class="main">≤</span> <span class="free">hmin</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">THEN</span> <span class="main">(</span><span class="numeral">4</span> <span class="main">::=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">ELSE</span> 
    <span class="main">(</span><span class="keyword1">IF</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">4</span> <span class="main">=</span> <span class="main">1</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">3</span> <span class="main">≥</span> <span class="free">hmax</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">THEN</span> <span class="main">(</span><span class="numeral">4</span> <span class="main">::=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span><span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">ELSE</span> skip<span class="main">)</span><span class="main">)</span><span class="main">;</span>
    <span class="comment1">― ‹dynamics›</span>
    <span class="main">(</span><span class="keyword1">IF</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">4</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="keyword1">THEN</span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="keyword1">f</span> <span class="main">(</span><span class="free">c<span class="hidden">⇩</span><sub>i</sub></span><span class="main">-</span><span class="free">c<span class="hidden">⇩</span><sub>o</sub></span><span class="main">)</span> <span class="main">&amp;</span> <span class="main">(</span><span class="keyword1">G</span> <span class="free">hmax</span> <span class="main">(</span><span class="free">c<span class="hidden">⇩</span><sub>i</sub></span><span class="main">-</span><span class="free">c<span class="hidden">⇩</span><sub>o</sub></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> 
     <span class="keyword1">ELSE</span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="keyword1">f</span> <span class="main">(</span><span class="main">-</span><span class="free">c<span class="hidden">⇩</span><sub>o</sub></span><span class="main">)</span> <span class="main">&amp;</span> <span class="main">(</span><span class="keyword1">G</span> <span class="free">hmin</span> <span class="main">(</span><span class="main">-</span><span class="free">c<span class="hidden">⇩</span><sub>o</sub></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">)</span> <span class="keyword1">INV</span> <span class="keyword1">I</span> <span class="free">hmin</span> <span class="free">hmax</span><span class="main">]</span>  
  <span class="keyword1">I</span> <span class="free">hmin</span> <span class="free">hmax</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> fbox_loopI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> le_fun_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> le_fun_def local_flow.fbox_g_ode_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> local_flow_tank<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> assms tank_arith<span class="main">[</span><span class="operator">OF</span> _ assms<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">no_notation</span></span> tank_vec_field <span class="main">(</span><span class="quoted">"<span class="keyword1">f</span>"</span><span class="main">)</span>
        <span class="keyword2"><span class="keyword">and</span></span> tank_flow <span class="main">(</span><span class="quoted">"<span class="keyword1">φ</span>"</span><span class="main">)</span>
        <span class="keyword2"><span class="keyword">and</span></span> tank_loop_inv <span class="main">(</span><span class="quoted">"<span class="keyword1">I</span>"</span><span class="main">)</span>
        <span class="keyword2"><span class="keyword">and</span></span> tank_diff_inv <span class="main">(</span><span class="quoted">"<span class="keyword1">dI</span>"</span><span class="main">)</span>
        <span class="keyword2"><span class="keyword">and</span></span> tank_guard <span class="main">(</span><span class="quoted">"<span class="keyword1">G</span>"</span><span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="HS_VC_PT">
<div class="head">
<h1>Theory HS_VC_PT</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:       Verification components with predicate transformers
    Author:      Jonathan Julián Huerta y Munive, 2020
    Maintainer:  Jonathan Julián Huerta y Munive &lt;jonjulian23@gmail.com&gt;
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹ Verification components with Predicate Transformers ›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ We use the categorical forward box operator <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">fb<span class="hidden">⇩</span><sub>ℱ</sub></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> to compute weakest liberal 
preconditions (wlps) of hybrid programs. Then we repeat the three methods for verifying 
correctness specifications of the continuous dynamics of a HS. ›</span></span>

<span class="keyword1"><span class="command">theory</span></span> HS_VC_PT
  <span class="keyword2"><span class="keyword">imports</span></span> 
    <span class="quoted">"<a href="../Transformer_Semantics/Kleisli_Quantaloid.html">Transformer_Semantics.Kleisli_Quantaloid</a>"</span>
    <span class="quoted">"<a href="HS_ODEs.html">../HS_ODEs</a>"</span> 
                        
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">no_notation</span></span> bres <span class="main">(</span><span class="keyword2"><span class="keyword">infixr</span></span> <span class="quoted">"<span class="keyword1">→</span>"</span> 60<span class="main">)</span>
        <span class="keyword2"><span class="keyword">and</span></span> dagger <span class="main">(</span><span class="quoted">"_<span class="keyword1"><span class="hidden">⇧</span><sup>†</sup></span>"</span> <span class="main">[</span>101<span class="main">]</span> 100<span class="main">)</span>
        <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted">"Relation.relcomp"</span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">;</span>"</span> 75<span class="main">)</span> 
        <span class="keyword2"><span class="keyword">and</span></span> eta <span class="main">(</span><span class="quoted">"<span class="keyword1">η</span>"</span><span class="main">)</span>
        <span class="keyword2"><span class="keyword">and</span></span> kcomp <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">∘<span class="hidden">⇩</span><sub>K</sub></span>"</span> 75<span class="main">)</span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'a</span> pred <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span>

<span class="keyword1"><span class="command">notation</span></span> eta <span class="main">(</span><span class="quoted">"<span class="keyword1">skip</span>"</span><span class="main">)</span>
     <span class="keyword2"><span class="keyword">and</span></span> kcomp <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">;</span>"</span> 75<span class="main">)</span>
     <span class="keyword2"><span class="keyword">and</span></span> g_orbital <span class="main">(</span><span class="quoted">"<span class="keyword3">(1</span><span class="keyword1">x´=</span>_ <span class="keyword1">&amp;</span> _ <span class="keyword1">on</span> _ _ <span class="keyword1">@</span> _<span class="keyword3">)</span>"</span><span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Verification of regular programs›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Properties of the forward box operator. ›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">fb<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="free">F</span> <span class="free">S</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋂</span> <span class="main">∘</span> <span class="keyword1">𝒫</span> <span class="main">(</span><span class="main">-</span> <span class="keyword1">op<span class="hidden">⇩</span><sub>K</sub></span> <span class="free">F</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">-</span> <span class="free">S</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> ffb_def map_dual_def dual_set_def klift_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">fb<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="free">F</span> <span class="free">S</span> <span class="main">=</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="free">F</span> <span class="bound">s</span> <span class="main">⊆</span> <span class="free">S</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ffb_def kop_def klift_def map_dual_def dual_set_def f2r_def r2f_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ffb_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">fb<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="free">F</span> <span class="free">S</span> <span class="main">=</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">s'</span><span class="main">.</span> <span class="bound">s'</span> <span class="main">∈</span> <span class="free">F</span> <span class="bound">s</span> <span class="main">⟶</span> <span class="bound">s'</span> <span class="main">∈</span> <span class="free">S</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ffb_def kop_def klift_def map_dual_def dual_set_def f2r_def r2f_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ffb_iso<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">≤</span> <span class="free">Q</span> <span class="main">⟹</span> <span class="keyword1">fb<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="free">F</span> <span class="free">P</span> <span class="main">≤</span> <span class="keyword1">fb<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="free">F</span> <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> ffb_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> ffb_invariants<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="free">I</span> <span class="bound">s</span><span class="main">}</span> <span class="main">≤</span> <span class="keyword1">fb<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="free">F</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="free">I</span> <span class="bound">s</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="free">J</span> <span class="bound">s</span><span class="main">}</span> <span class="main">≤</span> <span class="keyword1">fb<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="free">F</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="free">J</span> <span class="bound">s</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="free">I</span> <span class="bound">s</span> <span class="main">∧</span> <span class="free">J</span> <span class="bound">s</span><span class="main">}</span> <span class="main">≤</span> <span class="keyword1">fb<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="free">F</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="free">I</span> <span class="bound">s</span> <span class="main">∧</span> <span class="free">J</span> <span class="bound">s</span><span class="main">}</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="free">I</span> <span class="bound">s</span> <span class="main">∨</span> <span class="free">J</span> <span class="bound">s</span><span class="main">}</span> <span class="main">≤</span> <span class="keyword1">fb<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="free">F</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="free">I</span> <span class="bound">s</span> <span class="main">∨</span> <span class="free">J</span> <span class="bound">s</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> ffb_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="comment1">― ‹ Skip ›</span>

<span class="keyword1"><span class="command">lemma</span></span> ffb_skip<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">fb<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="keyword1">skip</span> <span class="free">S</span> <span class="main">=</span> <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> ffb_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> kop_def klift_def map_dual_def<span class="main">)</span>

<span class="comment1">― ‹ Tests ›</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">test</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> pred <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> set"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword3">(1</span><span class="keyword1">¿</span>_<span class="keyword1">?</span><span class="keyword3">)</span>"</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="free">¿</span></span><span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main"><span class="free">?</span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">s</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">x</span><span class="main">}</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ffb_test<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">fb<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="main">¿</span><span class="free">P</span><span class="main">?</span> <span class="free">Q</span> <span class="main">=</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">⟶</span> <span class="bound">s</span> <span class="main">∈</span> <span class="free">Q</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> ffb_eq test_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="comment1">― ‹ Assignments ›</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">assign</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'n</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">^</span><span class="tfree">'n</span> <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">^</span><span class="tfree">'n</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">^</span><span class="tfree">'n</span><span class="main">)</span> set"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword3">(2</span>_ <span class="keyword1">::=</span> _<span class="keyword3">)</span>"</span> <span class="main">[</span>70<span class="main">,</span> 65<span class="main">]</span> 61<span class="main">)</span> 
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main"><span class="free">::=</span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">{</span>vec_upd <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="bound">s</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>"</span></span> 

<span class="keyword1"><span class="command">lemma</span></span> ffb_assign<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">fb<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="main">(</span><span class="free">x</span> <span class="main">::=</span> <span class="free">e</span><span class="main">)</span> <span class="free">Q</span> <span class="main">=</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">χ</span> <span class="bound">j</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="main">($)</span> <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="main">(</span><span class="free">e</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="bound">j</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Q</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> vec_upd_def assign_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> ffb_eq<span class="main">)</span> <span class="operator">simp</span>

<span class="comment1">― ‹ Nondeterministic assignments ›</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">nondet_assign</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'n</span> <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">^</span><span class="tfree">'n</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">^</span><span class="tfree">'n</span><span class="main">)</span> set"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword3">(2</span>_ <span class="keyword1">::=</span> <span class="keyword1">?</span> <span class="keyword3">)</span>"</span> <span class="main">[</span>70<span class="main">]</span> 61<span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main"><span class="free">::=</span></span> <span class="main"><span class="free">?</span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">{</span><span class="main">(</span>vec_upd <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="bound">k</span><span class="main">)</span><span class="main">|</span><span class="bound">k</span><span class="main">.</span> True<span class="main">}</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> fbox_nondet_assign<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">fb<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="main">(</span><span class="free">x</span> <span class="main">::=</span> <span class="main">?</span><span class="main">)</span> <span class="free">P</span> <span class="main">=</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">χ</span> <span class="bound">j</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">j</span> <span class="main">=</span> <span class="free">x</span> <span class="keyword1">then</span> <span class="bound">k</span> <span class="keyword1">else</span> <span class="bound">s</span><span class="main">$</span><span class="bound">j</span><span class="main">)</span> <span class="main">∈</span> <span class="free">P</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> ffb_eq nondet_assign_def vec_upd_eq <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_eq_iff<span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">χ</span> <span class="bound">j</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">j</span> <span class="main">=</span> <span class="free">x</span> <span class="keyword1">then</span> <span class="improper">k</span> <span class="keyword1">else</span> <span class="main">_</span> <span class="main">$</span> <span class="bound">j</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="comment1">― ‹ Nondeterministic choice ›</span>

<span class="keyword1"><span class="command">lemma</span></span> ffb_choice<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">fb<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">F</span> <span class="bound">s</span> <span class="main">∪</span> <span class="free">G</span> <span class="bound">s</span><span class="main">)</span> <span class="free">P</span> <span class="main">=</span> <span class="keyword1">fb<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="free">F</span> <span class="free">P</span> <span class="main">∩</span> <span class="keyword1">fb<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="free">G</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> ffb_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> le_ffb_choice_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊆</span> <span class="keyword1">fb<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">F</span> <span class="bound">s</span> <span class="main">∪</span> <span class="free">G</span> <span class="bound">s</span><span class="main">)</span> <span class="free">Q</span> <span class="main">⟷</span> <span class="free">P</span> <span class="main">⊆</span> <span class="keyword1">fb<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="free">F</span> <span class="free">Q</span> <span class="main">∧</span> <span class="free">P</span> <span class="main">⊆</span> <span class="keyword1">fb<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="free">G</span> <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> ffb_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="comment1">― ‹ Sequential composition ›</span>

<span class="keyword1"><span class="command">lemma</span></span> ffb_kcomp<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">fb<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="main">(</span><span class="free">G</span> <span class="main">;</span> <span class="free">F</span><span class="main">)</span> <span class="free">P</span> <span class="main">=</span> <span class="keyword1">fb<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="free">G</span> <span class="main">(</span><span class="keyword1">fb<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="free">F</span> <span class="free">P</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> ffb_eq <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> kcomp_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> hoare_kcomp<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">≤</span> <span class="keyword1">fb<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="free">F</span> <span class="free">R</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">≤</span> <span class="keyword1">fb<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="free">G</span> <span class="free">Q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">≤</span> <span class="keyword1">fb<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="main">(</span><span class="free">F</span> <span class="main">;</span> <span class="free">G</span><span class="main">)</span> <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> ffb_kcomp<span class="main">)</span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> order.trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">rule</span> ffb_iso<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="comment1">― ‹ Conditional statement ›</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ifthenelse</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> pred <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> set<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> set<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> set<span class="main">)</span>"</span></span>
  <span class="main">(</span><span class="quoted">"<span class="keyword1">IF</span> _ <span class="keyword1">THEN</span> _ <span class="keyword1">ELSE</span> _"</span> <span class="main">[</span>64<span class="main">,</span>64<span class="main">,</span>64<span class="main">]</span> 63<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">IF</span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="keyword1"><span class="free">THEN</span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="keyword1"><span class="free">ELSE</span></span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">x</span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="bound">x</span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span> <span class="bound">x</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ffb_if_then_else<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="keyword1">fb<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="main">(</span><span class="keyword1">IF</span> <span class="free">T</span> <span class="keyword1">THEN</span> <span class="free">X</span> <span class="keyword1">ELSE</span> <span class="free">Y</span><span class="main">)</span> <span class="free">Q</span> <span class="main">=</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="free">T</span> <span class="bound">s</span> <span class="main">⟶</span> <span class="bound">s</span> <span class="main">∈</span> <span class="keyword1">fb<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="free">X</span> <span class="free">Q</span><span class="main">}</span> <span class="main">∩</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">¬</span> <span class="free">T</span> <span class="bound">s</span> <span class="main">⟶</span> <span class="bound">s</span> <span class="main">∈</span> <span class="keyword1">fb<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="free">Y</span> <span class="free">Q</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> ffb_eq ifthenelse_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> hoare_if_then_else<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">∩</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="free">T</span> <span class="bound">s</span><span class="main">}</span> <span class="main">≤</span> <span class="keyword1">fb<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="free">X</span> <span class="free">Q</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">∩</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">¬</span> <span class="free">T</span> <span class="bound">s</span><span class="main">}</span> <span class="main">≤</span> <span class="keyword1">fb<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="free">Y</span> <span class="free">Q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">≤</span> <span class="keyword1">fb<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="main">(</span><span class="keyword1">IF</span> <span class="free">T</span> <span class="keyword1">THEN</span> <span class="free">X</span> <span class="keyword1">ELSE</span> <span class="free">Y</span><span class="main">)</span> <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> ffb_eq<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> ffb_eq<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> ifthenelse_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="comment1">― ‹ Finite iteration ›</span>

<span class="keyword1"><span class="command">lemma</span></span> kpower_inv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">≤</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">F</span> <span class="bound">s</span> <span class="main">⟶</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">I</span><span class="main">}</span> <span class="main">⟹</span> <span class="free">I</span> <span class="main">≤</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> <span class="main">(</span>kpower <span class="free">F</span> <span class="free">n</span> <span class="bound">s</span><span class="main">)</span> <span class="main">⟶</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">I</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> kcomp_prop<span class="main">)</span> 

<span class="keyword1"><span class="command">lemma</span></span> kstar_inv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">≤</span> <span class="keyword1">fb<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="free">F</span> <span class="free">I</span> <span class="main">⟹</span> <span class="free">I</span> <span class="main">⊆</span> <span class="keyword1">fb<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="main">(</span>kstar <span class="free">F</span><span class="main">)</span> <span class="free">I</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> kstar_def ffb_eq <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command">using</span></span> kpower_inv <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> ffb_kstarI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">≤</span> <span class="free">I</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">≤</span> <span class="free">Q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">≤</span> <span class="keyword1">fb<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="free">F</span> <span class="free">I</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">≤</span> <span class="keyword1">fb<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="main">(</span>kstar <span class="free">F</span><span class="main">)</span> <span class="free">Q</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">⊆</span> <span class="keyword1">fb<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="main">(</span>kstar <span class="free">F</span><span class="main">)</span> <span class="free">I</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> kstar_inv <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">≤</span> <span class="keyword1">fb<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="main">(</span>kstar <span class="free">F</span><span class="main">)</span> <span class="free">I</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">fb<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="main">(</span>kstar <span class="free">F</span><span class="main">)</span> <span class="free">I</span> <span class="main">≤</span> <span class="keyword1">fb<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="main">(</span>kstar <span class="free">F</span><span class="main">)</span> <span class="free">Q</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ffb_iso<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">loopi</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> set<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> pred <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> set<span class="main">)</span>"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">LOOP</span> _ <span class="keyword1">INV</span> _ "</span> <span class="main">[</span>64<span class="main">,</span>64<span class="main">]</span> 63<span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">LOOP</span></span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="keyword1"><span class="free">INV</span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">≡</span> <span class="main">(</span>kstar <span class="free"><span class="bound"><span class="entity">F</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> change_loopI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">LOOP</span> <span class="free">X</span> <span class="keyword1">INV</span> <span class="free">G</span> <span class="main">=</span> <span class="keyword1">LOOP</span> <span class="free">X</span> <span class="keyword1">INV</span> <span class="free">I</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> loopi_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> ffb_loopI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">≤</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="free">I</span> <span class="bound">s</span><span class="main">}</span>  <span class="main">⟹</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="free">I</span> <span class="bound">s</span><span class="main">}</span> <span class="main">≤</span> <span class="free">Q</span> <span class="main">⟹</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="free">I</span> <span class="bound">s</span><span class="main">}</span> <span class="main">≤</span> <span class="keyword1">fb<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="free">F</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="free">I</span> <span class="bound">s</span><span class="main">}</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">≤</span> <span class="keyword1">fb<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="main">(</span><span class="keyword1">LOOP</span> <span class="free">F</span> <span class="keyword1">INV</span> <span class="free">I</span><span class="main">)</span> <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> loopi_def <span class="keyword1"><span class="command">using</span></span> ffb_kstarI<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">P</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> ffb_loopI_break<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">≤</span> <span class="keyword1">fb<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="free">Y</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="free">I</span> <span class="bound">s</span><span class="main">}</span> <span class="main">⟹</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="free">I</span> <span class="bound">s</span><span class="main">}</span> <span class="main">≤</span> <span class="keyword1">fb<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="free">X</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="free">I</span> <span class="bound">s</span><span class="main">}</span> <span class="main">⟹</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="free">I</span> <span class="bound">s</span><span class="main">}</span> <span class="main">≤</span> <span class="free">Q</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">≤</span> <span class="keyword1">fb<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="main">(</span><span class="free">Y</span> <span class="main">;</span> <span class="main">(</span><span class="keyword1">LOOP</span> <span class="free">X</span> <span class="keyword1">INV</span> <span class="free">I</span><span class="main">)</span><span class="main">)</span> <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> hoare_kcomp<span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main">)</span> <span class="main">(</span><span class="operator">rule</span> ffb_loopI<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Verification of hybrid programs›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Verification by providing evolution›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">g_evol</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>ord<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'b</span> pred <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'a</span> set<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'b</span> set<span class="main">)</span>"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">EVOL</span>"</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">EVOL</span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> g_orbit <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="bound">t</span> <span class="bound">s</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> fbox_g_evol<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">φ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>preorder<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">fb<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="main">(</span><span class="keyword1">EVOL</span> <span class="free">φ</span> <span class="free">G</span> <span class="free">U</span><span class="main">)</span> <span class="free">Q</span> <span class="main">=</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">t</span><span class="main">∈</span><span class="free">U</span> <span class="bound">s</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">τ</span><span class="main">∈</span>down <span class="main">(</span><span class="free">U</span> <span class="bound">s</span><span class="main">)</span> <span class="bound">t</span><span class="main">.</span> <span class="free">G</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">τ</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">t</span> <span class="bound">s</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Q</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> g_evol_def g_orbit_eq ffb_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Verification by providing solutions›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ffb_g_orbital<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">fb<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="free">f</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="free">Q</span> <span class="main">=</span> 
  <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">X</span><span class="main">∈</span><span class="keyword1">Sols</span> <span class="free">f</span> <span class="free">U</span> <span class="free">S</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">t</span><span class="main">∈</span><span class="free">U</span> <span class="bound">s</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">τ</span><span class="main">∈</span>down <span class="main">(</span><span class="free">U</span> <span class="bound">s</span><span class="main">)</span> <span class="bound">t</span><span class="main">.</span> <span class="free">G</span> <span class="main">(</span><span class="bound">X</span> <span class="bound">τ</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="bound">X</span> <span class="bound">t</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Q</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> ffb_eq g_orbital_eq <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fun_eq_iff<span class="main">)</span>

<span class="keyword1"><span class="command">context</span></span> local_flow
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ffb_g_ode_subset<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">∈</span> <span class="free">U</span> <span class="bound">s</span> <span class="main">∧</span> is_interval <span class="main">(</span><span class="free">U</span> <span class="bound">s</span><span class="main">)</span> <span class="main">∧</span> <span class="free">U</span> <span class="bound">s</span> <span class="main">⊆</span> <span class="free">T</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">fb<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">f</span><span class="main">)</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="main">0</span><span class="main">)</span> <span class="free">Q</span> <span class="main">=</span> 
  <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">t</span><span class="main">∈</span><span class="main">(</span><span class="free">U</span> <span class="bound">s</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">τ</span><span class="main">∈</span>down <span class="main">(</span><span class="free">U</span> <span class="bound">s</span><span class="main">)</span> <span class="bound">t</span><span class="main">.</span> <span class="free">G</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">τ</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">t</span> <span class="bound">s</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Q</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">unfold</span> ffb_g_orbital set_eq_iff<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarify</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> iffI<span class="main"><span class="keyword3">;</span></span> <span class="operator">clarify</span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_ivp_sols assms<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">frule</span> ivp_solsD<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">frule</span> ivp_solsD<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">frule</span> ivp_solsD<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">τ</span><span class="main">∈</span>down <span class="main">(</span><span class="free">U</span> <span class="improper">x</span><span class="main">)</span> <span class="improper">t</span><span class="main">.</span> <span class="improper">X</span> <span class="bound">τ</span> <span class="main">=</span> <span class="free">φ</span> <span class="bound">τ</span> <span class="improper">x</span>"</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> ballI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ivp_unique_solution<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ _ _ _ _ in_ivp_sols<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> ffb_g_ode<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">fb<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">f</span><span class="main">)</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">T</span><span class="main">)</span> <span class="free">S</span> <span class="main">@</span> <span class="main">0</span><span class="main">)</span> <span class="free">Q</span> <span class="main">=</span> 
  <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">t</span><span class="main">∈</span><span class="free">T</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">τ</span><span class="main">∈</span>down <span class="free">T</span> <span class="bound">t</span><span class="main">.</span> <span class="free">G</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">τ</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">t</span> <span class="bound">s</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Q</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="var">?wlp</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> ffb_g_ode_subset<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> init_time interval_time<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ffb_g_ode_ivl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">≥</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free">t</span> <span class="main">∈</span> <span class="free">T</span> <span class="main">⟹</span> <span class="keyword1">fb<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="main">(</span><span class="keyword1">x´=</span><span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">f</span><span class="main">)</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">t</span><span class="main">}</span><span class="main">)</span> <span class="free">S</span> <span class="main">@</span> <span class="main">0</span><span class="main">)</span> <span class="free">Q</span> <span class="main">=</span> 
  <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">t</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">t</span><span class="main">}</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">τ</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="bound">t</span><span class="main">}</span><span class="main">.</span> <span class="free">G</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">τ</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">t</span> <span class="bound">s</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Q</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> ffb_g_ode_subset<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subintervalI init_time real_Icc_closed_segment<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> closed_segment_eq_real_ivl<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ffb_orbit<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">fb<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="keyword1">γ<span class="hidden">⇧</span><sup>φ</sup></span> <span class="free">Q</span> <span class="main">=</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">t</span> <span class="main">∈</span> <span class="free">T</span><span class="main">.</span> <span class="free">φ</span> <span class="bound">t</span> <span class="bound">s</span> <span class="main">∈</span> <span class="free">Q</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> orbit_def ffb_g_ode <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ Verification with differential invariants ›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">g_ode_inv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>real <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>banach<span class="main">)</span><span class="main">⇒</span><span class="tfree">'a</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> pred <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> real set<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> set <span class="main">⇒</span> 
  real <span class="main">⇒</span> <span class="tfree">'a</span> pred <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> set<span class="main">)</span>"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword3">(1</span><span class="keyword1">x´=</span>_ <span class="keyword1">&amp;</span> _ <span class="keyword1">on</span> _ _ <span class="keyword1">@</span> _ <span class="keyword1">DINV</span> _ <span class="keyword3">)</span>"</span><span class="main">)</span> 
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1"><span class="free">x´=</span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main"><span class="free">&amp;</span></span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="keyword1"><span class="free">on</span></span> <span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main"><span class="free">@</span></span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="keyword1"><span class="free">DINV</span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">&amp;</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="keyword1">on</span> <span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">@</span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ffb_g_orbital_guard<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">H</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">G</span> <span class="bound">s</span> <span class="main">∧</span> <span class="free">Q</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">fb<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="free">f</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="free">Q</span> <span class="bound">s</span><span class="main">}</span> <span class="main">=</span> <span class="keyword1">fb<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="free">f</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="free">H</span> <span class="bound">s</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> ffb_g_orbital <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> ffb_g_orbital_inv<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">≤</span> <span class="free">I</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">≤</span> <span class="keyword1">fb<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="free">f</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="free">I</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">≤</span> <span class="free">Q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">≤</span> <span class="keyword1">fb<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="free">f</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> order.trans<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> order.trans<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ffb_iso<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ffb_diff_inv<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="free">I</span> <span class="bound">s</span><span class="main">}</span> <span class="main">≤</span> <span class="keyword1">fb<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="free">f</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="free">I</span> <span class="bound">s</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> diff_invariant <span class="free">I</span> <span class="free">f</span> <span class="free">U</span> <span class="free">S</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">G</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> diff_invariant_def ivp_sols_def ffb_eq g_orbital_eq<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> bdf_diff_inv<span class="main">:</span>
  <span class="quoted"><span class="quoted">"diff_invariant <span class="free">I</span> <span class="free">f</span> <span class="free">U</span> <span class="free">S</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">G</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">bd<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="free">f</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="free">I</span> <span class="bound">s</span><span class="main">}</span> <span class="main">≤</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="free">I</span> <span class="bound">s</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> ffb_fbd_galois_var <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> diff_invariant_def ivp_sols_def ffb_eq g_orbital_eq<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> diff_inv_guard_ignore<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="free">I</span> <span class="bound">s</span><span class="main">}</span> <span class="main">≤</span> <span class="keyword1">fb<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="free">f</span> <span class="main">&amp;</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> True<span class="main">)</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="free">I</span> <span class="bound">s</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="free">I</span> <span class="bound">s</span><span class="main">}</span> <span class="main">≤</span> <span class="keyword1">fb<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="free">f</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="free">I</span> <span class="bound">s</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> ffb_diff_inv diff_invariant_eq image_le_pred <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">context</span></span> local_flow
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ffb_diff_inv_eq<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">∈</span> <span class="free">U</span> <span class="bound">s</span> <span class="main">∧</span> is_interval <span class="main">(</span><span class="free">U</span> <span class="bound">s</span><span class="main">)</span> <span class="main">∧</span> <span class="free">U</span> <span class="bound">s</span> <span class="main">⊆</span> <span class="free">T</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"diff_invariant <span class="free">I</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">f</span><span class="main">)</span> <span class="free">U</span> <span class="free">S</span> <span class="main">0</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> True<span class="main">)</span> <span class="main">=</span> 
  <span class="main">(</span><span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟶</span> <span class="free">I</span> <span class="bound">s</span><span class="main">}</span> <span class="main">=</span> <span class="keyword1">fb<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">f</span><span class="main">)</span> <span class="main">&amp;</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> True<span class="main">)</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="main">0</span><span class="main">)</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟶</span> <span class="free">I</span> <span class="bound">s</span><span class="main">}</span><span class="main">)</span>"</span></span>
 <span class="keyword1"><span class="command">unfolding</span></span> ffb_diff_inv<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> ffb_g_ode_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> set_eq_iff<span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="main">0</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> ballE<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> init_time in_domain ivp<span class="main">(</span>2<span class="main">)</span> assms <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">force</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">x</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">t</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> ballE<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> in_domain ivp<span class="main">(</span>2<span class="main">)</span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> diff_inv_eq_inv_set<span class="main">:</span>
  <span class="quoted"><span class="quoted">"diff_invariant <span class="free">I</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">f</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">T</span><span class="main">)</span> <span class="free">S</span> <span class="main">0</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> True<span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">s</span><span class="main">.</span> <span class="free">I</span> <span class="bound">s</span> <span class="main">⟶</span> <span class="keyword1">γ<span class="hidden">⇧</span><sup>φ</sup></span> <span class="bound">s</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="free">I</span> <span class="bound">s</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> diff_inv_eq_inv_set orbit_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ffb_g_odei<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">≤</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="free">I</span> <span class="bound">s</span><span class="main">}</span> <span class="main">⟹</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="free">I</span> <span class="bound">s</span><span class="main">}</span> <span class="main">≤</span> <span class="keyword1">fb<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="free">f</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="free">I</span> <span class="bound">s</span><span class="main">}</span> <span class="main">⟹</span> 
  <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="free">I</span> <span class="bound">s</span> <span class="main">∧</span> <span class="free">G</span> <span class="bound">s</span><span class="main">}</span> <span class="main">≤</span> <span class="free">Q</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">≤</span> <span class="keyword1">fb<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="free">f</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="keyword1">DINV</span> <span class="free">I</span><span class="main">)</span> <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> g_ode_inv_def 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> b<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="keyword1">fb<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="free">f</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="free">I</span> <span class="bound">s</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> order.trans<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> I<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="free">I</span> <span class="bound">s</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> ffb_g_orbital_inv<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> ffb_g_orbital_guard<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ffb_iso<span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹ Derivation of the rules of dL ›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹ We derive domain specific rules of differential dynamic logic (dL). First we present a 
generalised version, then we show the rules as instances of the general ones.›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">g_dl_orbit</span> <span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>banach<span class="main">)</span><span class="main">⇒</span><span class="tfree">'a</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> pred <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> set"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword3">(1</span><span class="keyword1">x´=</span>_ <span class="keyword1">&amp;</span> _<span class="keyword3">)</span>"</span><span class="main">)</span> 
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1"><span class="free">x´=</span></span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main"><span class="free">&amp;</span></span> <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span> <span class="main">≡</span> <span class="main">(</span><span class="keyword1">x´=</span><span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="main">&amp;</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="keyword1">on</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">{</span><span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">≥</span> <span class="main">0</span><span class="main">}</span><span class="main">)</span> UNIV <span class="main">@</span> <span class="main">0</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">g_dl_ode_inv</span> <span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>banach<span class="main">)</span><span class="main">⇒</span><span class="tfree">'a</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> pred <span class="main">⇒</span> <span class="tfree">'a</span> pred <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> set"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword3">(1</span><span class="keyword1">x´=</span>_ <span class="keyword1">&amp;</span> _ <span class="keyword1">DINV</span> _<span class="keyword3">)</span>"</span><span class="main">)</span> 
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1"><span class="free">x´=</span></span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main"><span class="free">&amp;</span></span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="keyword1"><span class="free">DINV</span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">)</span> <span class="main">≡</span> <span class="main">(</span><span class="keyword1">x´=</span><span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="main">&amp;</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="keyword1">on</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">{</span><span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">≥</span> <span class="main">0</span><span class="main">}</span><span class="main">)</span> UNIV <span class="main">@</span> <span class="main">0</span> <span class="keyword1">DINV</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> diff_solve_axiom1<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"local_flow <span class="free">f</span> UNIV UNIV <span class="free">φ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">fb<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="free">f</span> <span class="main">&amp;</span> <span class="free">G</span><span class="main">)</span> <span class="free">Q</span> <span class="main">=</span> 
  <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound"><span class="bound">t</span></span><span class="main">≥</span><span class="main">0</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">τ</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="bound">t</span><span class="main">}</span><span class="main">.</span> <span class="free">G</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">τ</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">t</span> <span class="bound">s</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Q</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> local_flow.ffb_g_ode_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> diff_solve_axiom2<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">c</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>heine_borel<span class="main">,</span> banach<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">fb<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="main">(</span><span class="keyword1">x´=</span><span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">c</span><span class="main">)</span> <span class="main">&amp;</span> <span class="free">G</span><span class="main">)</span> <span class="free">Q</span> <span class="main">=</span> 
  <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound"><span class="bound">t</span></span><span class="main">≥</span><span class="main">0</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">τ</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="bound">t</span><span class="main">}</span><span class="main">.</span> <span class="free">G</span> <span class="main">(</span><span class="bound">s</span> <span class="main">+</span> <span class="bound">τ</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">c</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="bound">s</span> <span class="main">+</span> <span class="bound">t</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">c</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Q</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> local_flow.ffb_g_ode_subset<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> φ<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="main"><span class="main">λ</span></span><span class="bound"><span class="bound">t</span></span> <span class="bound"><span class="bound">s</span></span><span class="main"><span class="main">.</span></span> <span class="bound"><span class="bound">s</span></span> <span class="main"><span class="main">+</span></span> <span class="bound"><span class="bound">t</span></span> <span class="keyword1"><span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span></span> <span class="free"><span class="free">c</span></span><span class="main"><span class="main">)</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> T<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">UNIV</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> line_is_local_flow<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> diff_solve_rule<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"local_flow <span class="free">f</span> UNIV UNIV <span class="free">φ</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈</span> <span class="free">P</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">t</span></span><span class="main">≥</span><span class="main">0</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">τ</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="bound">t</span><span class="main">}</span><span class="main">.</span> <span class="free">G</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">τ</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">t</span> <span class="bound">s</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Q</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">≤</span> <span class="keyword1">fb<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="free">f</span> <span class="main">&amp;</span> <span class="free">G</span><span class="main">)</span> <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">subst</span> local_flow.ffb_g_ode_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> diff_weak_axiom1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> <span class="main">(</span><span class="keyword1">fb<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="free">f</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="free">G</span> <span class="bound">s</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> ffb_eq g_orbital_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> diff_weak_axiom2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">fb<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="free">f</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="free">T</span> <span class="free">S</span> <span class="main">@</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="free">Q</span> <span class="main">=</span> <span class="keyword1">fb<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="free">f</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="free">T</span> <span class="free">S</span> <span class="main">@</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="free">G</span> <span class="bound">s</span> <span class="main">⟶</span> <span class="bound">s</span> <span class="main">∈</span> <span class="free">Q</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> ffb_g_orbital image_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    
<span class="keyword1"><span class="command">lemma</span></span> diff_weak_rule<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="free">G</span> <span class="bound">s</span><span class="main">}</span> <span class="main">≤</span> <span class="free">Q</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">≤</span> <span class="keyword1">fb<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="free">f</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="free">T</span> <span class="free">S</span> <span class="main">@</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> g_orbitalD <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> le_fun_def g_orbital_eq ffb_eq<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ffb_g_orbital_eq_univD<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">fb<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="free">f</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="free">C</span> <span class="bound">s</span><span class="main">}</span> <span class="main">=</span> UNIV"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">τ</span><span class="main">∈</span><span class="main">(</span>down <span class="main">(</span><span class="free">U</span> <span class="free">s</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span><span class="main">.</span> <span class="free">x</span> <span class="bound">τ</span> <span class="main">∈</span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="free">f</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">τ</span><span class="main">∈</span><span class="main">(</span>down <span class="main">(</span><span class="free">U</span> <span class="free">s</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span><span class="main">.</span> <span class="free">C</span> <span class="main">(</span><span class="free">x</span> <span class="bound">τ</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">τ</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">τ</span> <span class="main">∈</span> <span class="main">(</span>down <span class="main">(</span><span class="free">U</span> <span class="free">s</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="skolem">τ</span> <span class="main">∈</span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="free">f</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="free">s</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="free">f</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="free">s</span> <span class="main">⟶</span> <span class="free">C</span> <span class="bound">y</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> ffb_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">(</span><span class="free">x</span> <span class="skolem">τ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> diff_cut_axiom<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">fb<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="free">f</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="free">C</span> <span class="bound">s</span><span class="main">}</span> <span class="main">=</span> UNIV"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">fb<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="free">f</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="free">Q</span> <span class="main">=</span> <span class="keyword1">fb<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="free">f</span> <span class="main">&amp;</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">G</span> <span class="bound">s</span> <span class="main">∧</span> <span class="free">C</span> <span class="bound">s</span><span class="main">)</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="free">Q</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule_tac</span> f<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="keyword1">fb<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="bound">x</span> <span class="free">Q</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> HOL.arg_cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> subset_antisym<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> 
  <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s'</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s'</span> <span class="main">∈</span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="free">f</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">τ</span></span><span class="main">::</span><span class="quoted">real</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem"><span class="skolem">X</span></span> <span class="keyword2"><span class="keyword">where</span></span> x_ivp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> <span class="keyword1">Sols</span> <span class="free">f</span> <span class="free">U</span> <span class="free">S</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">s</span>"</span></span> 
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="skolem">τ</span> <span class="main">=</span> <span class="skolem">s'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">τ</span> <span class="main">∈</span> <span class="main">(</span><span class="free">U</span> <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> guard_x<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="keyword1">𝒫</span> <span class="skolem">X</span> <span class="main">(</span>down <span class="main">(</span><span class="free">U</span> <span class="skolem">s</span><span class="main">)</span> <span class="skolem">τ</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="free">G</span> <span class="bound">s</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> g_orbitalD<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">s'</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span>"</span></span> <span class="quoted"><span class="free">G</span></span> <span class="main">_</span> <span class="quoted"><span class="free">S</span></span> <span class="quoted"><span class="free">t<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="quoted"><span class="skolem">s</span></span><span class="main">]</span>  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t</span><span class="main">∈</span><span class="main">(</span>down <span class="main">(</span><span class="free">U</span> <span class="skolem">s</span><span class="main">)</span> <span class="skolem">τ</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">𝒫</span> <span class="skolem">X</span> <span class="main">(</span>down <span class="main">(</span><span class="free">U</span> <span class="skolem">s</span><span class="main">)</span> <span class="bound">t</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="free">G</span> <span class="bound">s</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> guard_x <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> image_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t</span><span class="main">∈</span><span class="main">(</span>down <span class="main">(</span><span class="free">U</span> <span class="skolem">s</span><span class="main">)</span> <span class="skolem">τ</span><span class="main">)</span><span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> <span class="main">(</span><span class="free">U</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">τ</span> <span class="main">∈</span> <span class="main">(</span><span class="free">U</span> <span class="skolem">s</span><span class="main">)</span>›</span></span> closed_segment_subset_interval <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t</span><span class="main">∈</span><span class="main">(</span>down <span class="main">(</span><span class="free">U</span> <span class="skolem">s</span><span class="main">)</span> <span class="skolem">τ</span><span class="main">)</span><span class="main">.</span> <span class="skolem">X</span> <span class="bound">t</span> <span class="main">∈</span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="free">f</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> g_orbitalI<span class="main">[</span><span class="operator">OF</span> x_ivp<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t</span><span class="main">∈</span><span class="main">(</span>down <span class="main">(</span><span class="free">U</span> <span class="skolem">s</span><span class="main">)</span> <span class="skolem">τ</span><span class="main">)</span><span class="main">.</span> <span class="free">C</span> <span class="main">(</span><span class="skolem">X</span> <span class="bound">t</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> ffb_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s'</span> <span class="main">∈</span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="free">f</span> <span class="main">&amp;</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">G</span> <span class="bound">s</span> <span class="main">∧</span> <span class="free">C</span> <span class="bound">s</span><span class="main">)</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> g_orbitalI<span class="main">[</span><span class="operator">OF</span> x_ivp <span class="quoted"><span class="quoted">‹<span class="skolem">τ</span> <span class="main">∈</span> <span class="main">(</span><span class="free">U</span> <span class="skolem">s</span><span class="main">)</span>›</span></span><span class="main">]</span> guard_x <span class="quoted"><span class="quoted">‹<span class="skolem">X</span> <span class="skolem">τ</span> <span class="main">=</span> <span class="skolem">s'</span>›</span></span> 
      <span class="keyword1"><span class="command">unfolding</span></span> image_le_pred <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span><span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">x´=</span> <span class="free">f</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="skolem">s</span> <span class="main">⊆</span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="free">f</span> <span class="main">&amp;</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">G</span> <span class="bound">s</span> <span class="main">∧</span> <span class="free">C</span> <span class="bound">s</span><span class="main">)</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="free">f</span> <span class="main">&amp;</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">G</span> <span class="bound">s</span> <span class="main">∧</span> <span class="free">C</span> <span class="bound">s</span><span class="main">)</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="bound">s</span> <span class="main">⊆</span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="free">f</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="bound">s</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> g_orbital_eq<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> diff_cut_rule<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ffb_C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">≤</span> <span class="keyword1">fb<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="free">f</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="free">C</span> <span class="bound">s</span><span class="main">}</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> ffb_Q<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">≤</span> <span class="keyword1">fb<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="free">f</span> <span class="main">&amp;</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">G</span> <span class="bound">s</span> <span class="main">∧</span> <span class="free">C</span> <span class="bound">s</span><span class="main">)</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="free">Q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">≤</span> <span class="keyword1">fb<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="free">f</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="free">Q</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">subst</span> ffb_eq<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> g_orbital_eq<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span><span class="main">::</span><span class="quoted">real</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">X</span><span class="main">::</span><span class="quoted"><span class="quoted">"real <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">s</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> <span class="free">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> <span class="main">(</span><span class="free">U</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> x_ivp<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> <span class="keyword1">Sols</span> <span class="free">f</span> <span class="free">U</span> <span class="free">S</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">s</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> guard_x<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">τ</span><span class="main">.</span> <span class="bound">τ</span> <span class="main">∈</span> <span class="main">(</span><span class="free">U</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">τ</span> <span class="main">≤</span> <span class="skolem">t</span> <span class="main">⟶</span> <span class="free">G</span> <span class="main">(</span><span class="skolem">X</span> <span class="bound">τ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">τ</span><span class="main">∈</span><span class="main">(</span>down <span class="main">(</span><span class="free">U</span> <span class="skolem">s</span><span class="main">)</span> <span class="skolem">t</span><span class="main">)</span><span class="main">.</span> <span class="skolem">X</span> <span class="bound">τ</span> <span class="main">∈</span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="free">f</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> g_orbitalI<span class="main">[</span><span class="operator">OF</span> x_ivp<span class="main">]</span> guard_x <span class="keyword1"><span class="command">unfolding</span></span> image_le_pred <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">τ</span><span class="main">∈</span><span class="main">(</span>down <span class="main">(</span><span class="free">U</span> <span class="skolem">s</span><span class="main">)</span> <span class="skolem">t</span><span class="main">)</span><span class="main">.</span> <span class="free">C</span> <span class="main">(</span><span class="skolem">X</span> <span class="bound">τ</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> ffb_C <span class="quoted"><span class="quoted">‹<span class="skolem">s</span> <span class="main">∈</span> <span class="free">P</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> ffb_eq<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="skolem">t</span> <span class="main">∈</span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="free">f</span> <span class="main">&amp;</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">G</span> <span class="bound">s</span> <span class="main">∧</span> <span class="free">C</span> <span class="bound">s</span><span class="main">)</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> guard_x <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="main">∈</span> <span class="main">(</span><span class="free">U</span> <span class="skolem">s</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> g_orbitalI x_ivp<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">X</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Q</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">s</span> <span class="main">∈</span> <span class="free">P</span>›</span></span> ffb_Q <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> ffb_eq<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> diff_inv_axiom1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">G</span> <span class="free">s</span> <span class="main">⟶</span> <span class="free">I</span> <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"diff_invariant <span class="free">I</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">f</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">{</span><span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">≥</span> <span class="main">0</span><span class="main">}</span><span class="main">)</span> UNIV <span class="main">0</span> <span class="free">G</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> <span class="main">(</span><span class="keyword1">fb<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="free">f</span> <span class="main">&amp;</span> <span class="free">G</span><span class="main">)</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="free">I</span> <span class="bound">s</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> ffb_g_orbital diff_invariant_eq <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">s</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main"><span class="keyword3">,</span></span> <span class="operator">frule</span> ivp_solsD<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> diff_inv_axiom2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"picard_lindeloef <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">f</span><span class="main">)</span> UNIV UNIV <span class="main">0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="main">{</span><span class="bound">t</span><span class="main">::</span>real<span class="main">.</span> <span class="bound">t</span> <span class="main">≥</span> <span class="main">0</span><span class="main">}</span> <span class="main">⊆</span> picard_lindeloef.ex_ivl <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">f</span><span class="main">)</span> UNIV UNIV <span class="main">0</span> <span class="bound">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"diff_invariant <span class="free">I</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">f</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">{</span><span class="bound">t</span><span class="main">::</span>real<span class="main">.</span> <span class="bound">t</span> <span class="main">≥</span> <span class="main">0</span><span class="main">}</span><span class="main">)</span> UNIV <span class="main">0</span> <span class="free">G</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">fb<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="free">f</span> <span class="main">&amp;</span> <span class="free">G</span><span class="main">)</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="free">I</span> <span class="bound">s</span><span class="main">}</span> <span class="main">=</span> <span class="keyword1">fb<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="bound">s</span> <span class="main">=</span> <span class="bound">x</span> <span class="main">∧</span> <span class="free">G</span> <span class="bound">s</span><span class="main">}</span><span class="main">)</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="free">I</span> <span class="bound">s</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">unfold</span> ffb_g_orbital<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> ffb_eq<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> set_eq_iff<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="quoted"><span class="quoted">"<span class="var">?ex_ivl</span> <span class="skolem">s</span>"</span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"picard_lindeloef.ex_ivl <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">f</span><span class="main">)</span> UNIV UNIV <span class="main">0</span> <span class="skolem">s</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="skolem">s</span>"</span></span> <span class="main">=</span> 
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">X</span><span class="main">∈</span><span class="keyword1">Sols</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">f</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">{</span><span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">≥</span> <span class="main">0</span><span class="main">}</span><span class="main">)</span> UNIV <span class="main">0</span> <span class="skolem">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound"><span class="bound">t</span></span><span class="main">≥</span><span class="main">0</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">τ</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="bound">τ</span> <span class="main">∧</span> <span class="bound">τ</span> <span class="main">≤</span> <span class="bound">t</span> <span class="main">⟶</span> <span class="free">G</span> <span class="main">(</span><span class="bound">X</span> <span class="bound">τ</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">I</span> <span class="main">(</span><span class="bound">X</span> <span class="bound">t</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">X</span></span> <span class="keyword2"><span class="keyword">where</span></span> xivp1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> <span class="keyword1">Sols</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">f</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="var">?ex_ivl</span> <span class="bound">s</span><span class="main">)</span> UNIV <span class="main">0</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> picard_lindeloef.flow_in_ivp_sols_ex_ivl<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> xivp2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> <span class="keyword1">Sols</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">f</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> Collect <span class="main">(</span><span class="main">(≤)</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> UNIV <span class="main">0</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> in_ivp_sols_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ _ xivp1<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> shyp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">0</span> <span class="main">=</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ivp_solsD <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> dinv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s</span><span class="main">.</span> <span class="free">I</span> <span class="bound">s</span> <span class="main">⟶</span> <span class="var">?lhs</span> <span class="bound">s</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> diff_invariant_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="skolem">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">G</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">X</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> ballE<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="main">0</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> shyp xivp2<span class="main">)</span><span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="skolem">s</span> <span class="main">⟶</span> <span class="main">(</span><span class="free">G</span> <span class="skolem">s</span> <span class="main">⟶</span> <span class="free">I</span> <span class="skolem">s</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">G</span> <span class="skolem">s</span> <span class="main">⟶</span> <span class="free">I</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarify</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">τ</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="bound">τ</span> <span class="main">∧</span> <span class="bound">τ</span> <span class="main">≤</span> <span class="improper">t</span> <span class="main">⟶</span> <span class="free">G</span> <span class="main">(</span><span class="improper">X</span> <span class="bound">τ</span><span class="main">)</span>"</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="main">0</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main"><span class="keyword3">,</span></span> <span class="operator">frule</span> ivp_solsD<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> dinv <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span><span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="skolem">s</span> <span class="main">=</span> <span class="main">(</span><span class="free">G</span> <span class="skolem">s</span> <span class="main">⟶</span> <span class="free">I</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> diff_inv_rule<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">≤</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="free">I</span> <span class="bound">s</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"diff_invariant <span class="free">I</span> <span class="free">f</span> <span class="free">U</span> <span class="free">S</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">G</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="free">I</span> <span class="bound">s</span><span class="main">}</span> <span class="main">≤</span> <span class="free">Q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">≤</span> <span class="keyword1">fb<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="free">f</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ffb_g_orbital_inv<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> _ assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> ffb_diff_inv <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="HS_VC_PT_Examples">
<div class="head">
<h1>Theory HS_VC_PT_Examples</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:       Examples of hybrid systems verifications
    Author:      Jonathan Julián Huerta y Munive, 2020
    Maintainer:  Jonathan Julián Huerta y Munive &lt;jonjulian23@gmail.com&gt;
*)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹ Examples ›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ We prove partial correctness specifications of some hybrid systems with our
recently described verification components.›</span></span>

<span class="keyword1"><span class="command">theory</span></span> HS_VC_PT_Examples
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="HS_VC_PT.html">HS_VC_PT</a>

<span class="keyword2"><span class="keyword">begin</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹ Pendulum ›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ The ODEs <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"x' t = y t"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and {text "y' t = - x t"} describe the circular motion of
a mass attached to a string looked from above. We use <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"s$1"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> to represent the x-coordinate
and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"s$2"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> for the y-coordinate. We prove that this motion remains circular. ›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">fpend</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real<span class="main">^</span><span class="numeral">2</span> <span class="main">⇒</span> real<span class="main">^</span><span class="numeral">2</span>"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">f</span>"</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">f</span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="keyword1">χ</span> <span class="bound">i</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">i</span> <span class="main">=</span> <span class="main">1</span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="numeral">2</span> <span class="keyword1">else</span> <span class="main">-</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="main">1</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">pend_flow</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real <span class="main">⇒</span> real<span class="main">^</span><span class="numeral">2</span> <span class="main">⇒</span> real<span class="main">^</span><span class="numeral">2</span>"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">φ</span>"</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">φ</span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="keyword1">χ</span> <span class="bound">i</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">i</span> <span class="main">=</span> <span class="main">1</span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="main">1</span> <span class="main">*</span> cos <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="numeral">2</span> <span class="main">*</span> sin <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">else</span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="main">1</span> <span class="main">*</span> sin <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="numeral">2</span> <span class="main">*</span> cos <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>

<span class="comment1">― ‹Verified by providing the dynamics›</span>

<span class="keyword1"><span class="command">lemma</span></span> pendulum_dyn<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">=</span> <span class="main">(</span><span class="bound">s</span><span class="main">$</span><span class="main">1</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">+</span> <span class="main">(</span><span class="bound">s</span><span class="main">$</span><span class="numeral">2</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">}</span> <span class="main">≤</span> <span class="keyword1">fb<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="main">(</span><span class="keyword1">EVOL</span> <span class="keyword1">φ</span> <span class="free">G</span> <span class="free">T</span><span class="main">)</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">=</span> <span class="main">(</span><span class="bound">s</span><span class="main">$</span><span class="main">1</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">+</span> <span class="main">(</span><span class="bound">s</span><span class="main">$</span><span class="numeral">2</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="comment1">― ‹Verified with differential invariants. ›</span>

<span class="keyword1"><span class="command">lemma</span></span> pendulum_inv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">=</span> <span class="main">(</span><span class="bound">s</span><span class="main">$</span><span class="main">1</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">+</span> <span class="main">(</span><span class="bound">s</span><span class="main">$</span><span class="numeral">2</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">}</span> <span class="main">≤</span> <span class="keyword1">fb<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="keyword1">f</span> <span class="main">&amp;</span> <span class="free">G</span><span class="main">)</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">=</span> <span class="main">(</span><span class="bound">s</span><span class="main">$</span><span class="main">1</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">+</span> <span class="main">(</span><span class="bound">s</span><span class="main">$</span><span class="numeral">2</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">diff_invariant_rules</span></span> <span class="dynamic"><span class="dynamic">poly_derivatives</span></span><span class="main">)</span>

<span class="comment1">― ‹Verified with the flow. ›</span>

<span class="keyword1"><span class="command">lemma</span></span> local_flow_pend<span class="main">:</span> <span class="quoted"><span class="quoted">"local_flow <span class="keyword1">f</span> UNIV UNIV <span class="keyword1">φ</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> local_lipschitz_def lipschitz_on_def vec_eq_iff<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="main">1</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dist_norm norm_vec_def L2_set_def power2_commute UNIV_2<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> forall_2 <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">poly_derivatives</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> pendulum_flow<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">=</span> <span class="main">(</span><span class="bound">s</span><span class="main">$</span><span class="main">1</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">+</span> <span class="main">(</span><span class="bound">s</span><span class="main">$</span><span class="numeral">2</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">}</span> <span class="main">≤</span> <span class="keyword1">fb<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="keyword1">f</span> <span class="main">&amp;</span> <span class="free">G</span><span class="main">)</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">=</span> <span class="main">(</span><span class="bound">s</span><span class="main">$</span><span class="main">1</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">+</span> <span class="main">(</span><span class="bound">s</span><span class="main">$</span><span class="numeral">2</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> local_flow.ffb_g_ode_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> local_flow_pend<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">no_notation</span></span> fpend <span class="main">(</span><span class="quoted">"<span class="keyword1">f</span>"</span><span class="main">)</span>
        <span class="keyword2"><span class="keyword">and</span></span> pend_flow <span class="main">(</span><span class="quoted">"<span class="keyword1">φ</span>"</span><span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹ Bouncing Ball ›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ A ball is dropped from rest at an initial height <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"h"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. The motion is described with
the free-fall equations <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"x' t = v t"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"v' t = g"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> where <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"g"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is the
constant acceleration due to gravity. The bounce is modelled with a variable assignment that
flips the velocity. That is, we model it as a completely elastic collision with the ground. We use 
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"s$1"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> to represent the ball's height and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"s$2"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> for its velocity. We prove that the 
ball remains above ground and below its initial resting position. ›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">fball</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real <span class="main">⇒</span> real<span class="main">^</span><span class="numeral">2</span> <span class="main">⇒</span> real<span class="main">^</span><span class="numeral">2</span>"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">f</span>"</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">f</span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="keyword1">χ</span> <span class="bound">i</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">i</span> <span class="main">=</span> <span class="main">1</span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="numeral">2</span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">ball_flow</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real <span class="main">⇒</span> real <span class="main">⇒</span> real<span class="main">^</span><span class="numeral">2</span> <span class="main">⇒</span> real<span class="main">^</span><span class="numeral">2</span>"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">φ</span>"</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">φ</span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="keyword1">χ</span> <span class="bound">i</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">i</span> <span class="main">=</span> <span class="main">1</span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">*</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">^</span> <span class="numeral">2</span><span class="main">/</span><span class="numeral">2</span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="numeral">2</span> <span class="main">*</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="main">1</span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">*</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="numeral">2</span><span class="main">)</span>"</span></span>

<span class="comment1">― ‹Verified with differential invariants. ›</span>

<span class="keyword1"><span class="command">named_theorems</span></span> bb_real_arith <span class="quoted">"real arithmetic properties for the bouncing ball."</span>

<span class="keyword1"><span class="command">lemma</span></span> inv_imp_pos_le<span class="main">[</span><span class="operator">bb_real_arith</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&gt;</span> <span class="free">g</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">*</span> <span class="free">g</span> <span class="main">*</span> <span class="free">x</span> <span class="main">-</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">g</span> <span class="main">*</span> <span class="free">h</span> <span class="main">=</span> <span class="free">v</span> <span class="main">*</span> <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">::</span>real<span class="main">)</span> <span class="main">≤</span> <span class="free">h</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">*</span> <span class="free">v</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">g</span> <span class="main">*</span> <span class="free">x</span> <span class="main">-</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">g</span> <span class="main">*</span> <span class="free">h</span> <span class="main">∧</span> <span class="main">0</span> <span class="main">&gt;</span> <span class="free">g</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> inv <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&gt;</span> <span class="free">g</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> obs<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">*</span> <span class="free">v</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">g</span> <span class="main">*</span> <span class="main">(</span><span class="free">x</span> <span class="main">-</span> <span class="free">h</span><span class="main">)</span> <span class="main">∧</span> <span class="main">0</span> <span class="main">&gt;</span> <span class="free">g</span> <span class="main">∧</span> <span class="free">v</span> <span class="main">*</span> <span class="free">v</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> left_diff_distrib mult.commute <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> zero_le_square<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">v</span> <span class="main">*</span> <span class="free">v</span><span class="main">)</span><span class="main">/</span><span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">g</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span> <span class="main">-</span> <span class="free">h</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> obs <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">v</span> <span class="main">*</span> <span class="free">v</span><span class="main">)</span><span class="main">/</span><span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">g</span><span class="main">)</span> <span class="main">≤</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> divide_nonneg_neg <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">-</span> <span class="free">x</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> bouncing_ball_inv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free">h</span> <span class="main">≥</span> <span class="main">0</span> <span class="main">⟹</span>
  <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">=</span> <span class="free">h</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span> <span class="main">≤</span> <span class="keyword1">fb<span class="hidden">⇩</span><sub>ℱ</sub></span>
  <span class="main">(</span><span class="keyword1">LOOP</span> <span class="main">(</span>
    <span class="main">(</span><span class="keyword1">x´=</span><span class="main">(</span><span class="keyword1">f</span> <span class="free">g</span><span class="main">)</span> <span class="main">&amp;</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">≥</span> <span class="main">0</span><span class="main">)</span> <span class="keyword1">DINV</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">g</span> <span class="main">*</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">-</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">g</span> <span class="main">*</span> <span class="free">h</span> <span class="main">-</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span> <span class="main">*</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">;</span>
    <span class="main">(</span><span class="keyword1">IF</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="keyword1">THEN</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">::=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">-</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">ELSE</span> <span class="keyword1">skip</span><span class="main">)</span><span class="main">)</span>
  <span class="keyword1">INV</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">∧</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">g</span> <span class="main">*</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">-</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">g</span> <span class="main">*</span> <span class="free">h</span> <span class="main">-</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span> <span class="main">*</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>
  <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">≤</span> <span class="free">h</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ffb_loopI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">force</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">bb_real_arith</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ffb_g_odei<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">diff_invariant_rules</span></span> <span class="dynamic"><span class="dynamic">poly_derivatives</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">bb_real_arith</span></span><span class="main">)</span>

<span class="comment1">― ‹Verified with annotated dynamics. ›</span>

<span class="keyword1"><span class="command">lemma</span></span> inv_conserv_at_ground<span class="main">[</span><span class="operator">bb_real_arith</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> invar<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">*</span> <span class="free">g</span> <span class="main">*</span> <span class="free">x</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">g</span> <span class="main">*</span> <span class="free">h</span> <span class="main">+</span> <span class="free">v</span> <span class="main">*</span> <span class="free">v</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> pos<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">*</span> <span class="free">τ</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">+</span> <span class="free">v</span> <span class="main">*</span> <span class="free">τ</span> <span class="main">+</span> <span class="main">(</span><span class="free">x</span><span class="main">::</span>real<span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">*</span> <span class="free">g</span> <span class="main">*</span> <span class="free">h</span> <span class="main">+</span> <span class="main">(</span><span class="free">g</span> <span class="main">*</span> <span class="free">τ</span> <span class="main">*</span> <span class="main">(</span><span class="free">g</span> <span class="main">*</span> <span class="free">τ</span> <span class="main">+</span> <span class="free">v</span><span class="main">)</span> <span class="main">+</span> <span class="free">v</span> <span class="main">*</span> <span class="main">(</span><span class="free">g</span> <span class="main">*</span> <span class="free">τ</span> <span class="main">+</span> <span class="free">v</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> pos <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">*</span> <span class="free">τ</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span>  <span class="main">+</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">v</span> <span class="main">*</span> <span class="free">τ</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">*</span> <span class="free">τ</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span>  <span class="main">+</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">g</span> <span class="main">*</span> <span class="free">v</span> <span class="main">*</span> <span class="free">τ</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">g</span> <span class="main">*</span> <span class="free">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> Groups.mult_ac<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>3<span class="main"><span class="main">)</span></span> mult_zero_right
        monoid_mult_class.power2_eq_square semiring_class.distrib_left<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">*</span> <span class="free">τ</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">g</span> <span class="main">*</span> <span class="free">v</span> <span class="main">*</span> <span class="free">τ</span> <span class="main">+</span> <span class="free">v</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">g</span> <span class="main">*</span> <span class="free">h</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> invar <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> monoid_mult_class.power2_eq_square<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> obs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">g</span> <span class="main">*</span> <span class="free">τ</span> <span class="main">+</span> <span class="free">v</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">g</span> <span class="main">*</span> <span class="free">h</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> power2_sum<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> Groups.add_ac<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">,</span></span> 3<span class="main"><span class="main">)</span></span>
        Groups.mult_ac<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">,</span></span> 3<span class="main"><span class="main">)</span></span> monoid_mult_class.power2_eq_square nat_distrib<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">*</span> <span class="free">g</span> <span class="main">*</span> <span class="free">h</span> <span class="main">+</span> <span class="main">(</span><span class="free">g</span> <span class="main">*</span> <span class="free">τ</span> <span class="main">*</span> <span class="main">(</span><span class="free">g</span> <span class="main">*</span> <span class="free">τ</span> <span class="main">+</span> <span class="free">v</span><span class="main">)</span> <span class="main">+</span> <span class="free">v</span> <span class="main">*</span> <span class="main">(</span><span class="free">g</span> <span class="main">*</span> <span class="free">τ</span> <span class="main">+</span> <span class="free">v</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add.commute distrib_right power2_eq_square<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> inv_conserv_at_air<span class="main">[</span><span class="operator">bb_real_arith</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> invar<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">*</span> <span class="free">g</span> <span class="main">*</span> <span class="free">x</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">g</span> <span class="main">*</span> <span class="free">h</span> <span class="main">+</span> <span class="free">v</span> <span class="main">*</span> <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">*</span> <span class="free">g</span> <span class="main">*</span> <span class="main">(</span><span class="free">g</span> <span class="main">*</span> <span class="free">τ</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">+</span> <span class="free">v</span> <span class="main">*</span> <span class="free">τ</span> <span class="main">+</span> <span class="main">(</span><span class="free">x</span><span class="main">::</span>real<span class="main">)</span><span class="main">)</span> <span class="main">=</span>
  <span class="numeral">2</span> <span class="main">*</span> <span class="free">g</span> <span class="main">*</span> <span class="free">h</span> <span class="main">+</span> <span class="main">(</span><span class="free">g</span> <span class="main">*</span> <span class="free">τ</span> <span class="main">+</span> <span class="free">v</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">g</span> <span class="main">*</span> <span class="free">τ</span> <span class="main">+</span> <span class="free">v</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="free">g</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">*</span> <span class="free">τ</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">g</span> <span class="main">*</span> <span class="free">v</span> <span class="main">*</span> <span class="free">τ</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">g</span> <span class="main">*</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span> semiring_normalization_rules<span class="main"><span class="main">(</span></span>29<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="free">g</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">*</span> <span class="free">τ</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">g</span> <span class="main">*</span> <span class="free">v</span> <span class="main">*</span> <span class="free">τ</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">g</span> <span class="main">*</span> <span class="free">h</span> <span class="main">+</span> <span class="free">v</span> <span class="main">*</span> <span class="free">v</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="var">?middle</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">subst</span> invar<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?middle</span>"</span></span><span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span><span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?rhs</span> <span class="main">=</span> <span class="free">g</span> <span class="main">*</span> <span class="free">g</span> <span class="main">*</span> <span class="main">(</span><span class="free">τ</span> <span class="main">*</span> <span class="free">τ</span><span class="main">)</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">g</span> <span class="main">*</span> <span class="free">v</span> <span class="main">*</span> <span class="free">τ</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">g</span> <span class="main">*</span> <span class="free">h</span> <span class="main">+</span> <span class="free">v</span> <span class="main">*</span> <span class="free">v</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Groups.mult_ac<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">,</span></span>3<span class="main"><span class="main">)</span></span> semiring_class.distrib_left<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="var">?middle</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> semiring_normalization_rules<span class="main"><span class="main">(</span></span>29<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?rhs</span> <span class="main">=</span> <span class="var">?middle</span>"</span></span><span class="keyword1"><span class="command">.</span></span><span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> bouncing_ball_dyn<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free">h</span> <span class="main">≥</span> <span class="main">0</span> <span class="main">⟹</span>
  <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">=</span> <span class="free">h</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span> <span class="main">≤</span> <span class="keyword1">fb<span class="hidden">⇩</span><sub>ℱ</sub></span>
  <span class="main">(</span><span class="keyword1">LOOP</span> <span class="main">(</span>
    <span class="main">(</span><span class="keyword1">EVOL</span> <span class="main">(</span><span class="keyword1">φ</span> <span class="free">g</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">≥</span> <span class="main">0</span><span class="main">)</span> <span class="free">T</span><span class="main">)</span> <span class="main">;</span>
    <span class="main">(</span><span class="keyword1">IF</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="keyword1">THEN</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">::=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">-</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">ELSE</span> <span class="keyword1">skip</span><span class="main">)</span><span class="main">)</span>
  <span class="keyword1">INV</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">∧</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">g</span> <span class="main">*</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">g</span> <span class="main">*</span> <span class="free">h</span> <span class="main">+</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span> <span class="main">*</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span><span class="main">)</span><span class="main">)</span>
  <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">≤</span> <span class="free">h</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ffb_loopI<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">bb_real_arith</span></span><span class="main">)</span>

<span class="comment1">― ‹Verified with the flow. ›</span>

<span class="keyword1"><span class="command">lemma</span></span> local_flow_ball<span class="main">:</span> <span class="quoted"><span class="quoted">"local_flow <span class="main">(</span><span class="keyword1">f</span> <span class="free">g</span><span class="main">)</span> UNIV UNIV <span class="main">(</span><span class="keyword1">φ</span> <span class="free">g</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> local_lipschitz_def lipschitz_on_def vec_eq_iff<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">1</span><span class="main">/</span><span class="numeral">2</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="main">1</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dist_norm norm_vec_def L2_set_def UNIV_2<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> forall_2 <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">poly_derivatives</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> bouncing_ball_flow<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free">h</span> <span class="main">≥</span> <span class="main">0</span> <span class="main">⟹</span>
  <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">=</span> <span class="free">h</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span> <span class="main">≤</span> <span class="keyword1">fb<span class="hidden">⇩</span><sub>ℱ</sub></span>
  <span class="main">(</span><span class="keyword1">LOOP</span> <span class="main">(</span>
    <span class="main">(</span><span class="keyword1">x´=</span><span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="keyword1">f</span> <span class="free">g</span><span class="main">)</span> <span class="main">&amp;</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">≥</span> <span class="main">0</span><span class="main">)</span> <span class="keyword1">on</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> UNIV<span class="main">)</span> UNIV <span class="main">@</span> <span class="main">0</span><span class="main">)</span> <span class="main">;</span>
    <span class="main">(</span><span class="keyword1">IF</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="keyword1">THEN</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">::=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">-</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">ELSE</span> <span class="keyword1">skip</span><span class="main">)</span><span class="main">)</span>
  <span class="keyword1">INV</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">∧</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">g</span> <span class="main">*</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">g</span> <span class="main">*</span> <span class="free">h</span> <span class="main">+</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span> <span class="main">*</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span><span class="main">)</span><span class="main">)</span>
  <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">≤</span> <span class="free">h</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ffb_loopI<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">bb_real_arith</span></span> local_flow.ffb_g_ode<span class="main"><span class="main">[</span></span><span class="operator">OF</span> local_flow_ball<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">no_notation</span></span> fball <span class="main">(</span><span class="quoted">"<span class="keyword1">f</span>"</span><span class="main">)</span>
        <span class="keyword2"><span class="keyword">and</span></span> ball_flow <span class="main">(</span><span class="quoted">"<span class="keyword1">φ</span>"</span><span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹ Thermostat ›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ A thermostat has a chronometer, a thermometer and a switch to turn on and off a heater.
At most every <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"t"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> minutes, it sets its chronometer to <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">0</span></span><span class="main"><span class="main">::</span></span>real"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, it registers
the room temperature, and it turns the heater on (or off) based on this reading. The temperature
follows the ODE <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"T' = - a * (T - U)"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> where <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"U"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"L ≥ 0"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> when the heater
is on, and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"0"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> when it is off. We use <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">1</span></span><span class="main"><span class="main">::</span></span><span class="numeral"><span class="numeral">4</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> to denote the room's temperature,
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="numeral"><span class="numeral">2</span></span><span class="main"><span class="main">::</span></span><span class="numeral"><span class="numeral">4</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is time as measured by the thermostat's chronometer, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="numeral"><span class="numeral">3</span></span><span class="main"><span class="main">::</span></span><span class="numeral"><span class="numeral">4</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is the
temperature detected by the thermometer, and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="numeral"><span class="numeral">4</span></span><span class="main"><span class="main">::</span></span><span class="numeral"><span class="numeral">4</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> states whether the heater is on
(<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"s$4 = 1"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>) or off (<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"s$4 = 0"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>). We prove that the thermostat keeps the room's
temperature between <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"Tmin"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"Tmax"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. ›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">temp_vec_field</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real <span class="main">⇒</span> real <span class="main">⇒</span> real<span class="main">^</span><span class="numeral">4</span> <span class="main">⇒</span> real<span class="main">^</span><span class="numeral">4</span>"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">f</span>"</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">f</span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="keyword1">χ</span> <span class="bound">i</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">i</span> <span class="main">=</span> <span class="numeral">2</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">i</span> <span class="main">=</span> <span class="main">1</span> <span class="keyword1">then</span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">*</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="main">1</span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">L</span></span></span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">temp_flow</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real <span class="main">⇒</span> real <span class="main">⇒</span> real <span class="main">⇒</span> real<span class="main">^</span><span class="numeral">4</span> <span class="main">⇒</span> real<span class="main">^</span><span class="numeral">4</span>"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">φ</span>"</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">φ</span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="keyword1">χ</span> <span class="bound">i</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">i</span> <span class="main">=</span> <span class="main">1</span> <span class="keyword1">then</span> <span class="main">-</span> exp<span class="main">(</span><span class="main">-</span><span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">*</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="keyword1">else</span>
  <span class="main">(</span><span class="keyword1">if</span> <span class="bound">i</span> <span class="main">=</span> <span class="numeral">2</span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="numeral">2</span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="comment1">― ‹Verified with the flow. ›</span>

<span class="keyword1"><span class="command">lemma</span></span> norm_diff_temp_dyn<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">a</span> <span class="main">⟹</span> <span class="main">∥</span><span class="keyword1">f</span> <span class="free">a</span> <span class="free">L</span> <span class="free">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">-</span> <span class="keyword1">f</span> <span class="free">a</span> <span class="free">L</span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub></span><span class="main">∥</span> <span class="main">=</span> <span class="main">¦</span><span class="free">a</span><span class="main">¦</span> <span class="main">*</span> <span class="main">¦</span><span class="free">s<span class="hidden">⇩</span><sub>1</sub></span><span class="main">$</span><span class="main">1</span> <span class="main">-</span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub></span><span class="main">$</span><span class="main">1</span><span class="main">¦</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> norm_vec_def L2_set_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> UNIV_4<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> a1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> f2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">r</span> <span class="bound">ra</span><span class="main">.</span> <span class="main">¦</span><span class="main">(</span><span class="bound">r</span><span class="main">::</span>real<span class="main">)</span> <span class="main">+</span> <span class="main">-</span> <span class="bound">ra</span><span class="main">¦</span> <span class="main">=</span> <span class="main">¦</span><span class="bound">ra</span> <span class="main">+</span> <span class="main">-</span> <span class="bound">r</span><span class="main">¦</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> abs_minus_commute minus_real_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">r</span> <span class="bound">ra</span> <span class="bound">rb</span><span class="main">.</span> <span class="main">(</span><span class="bound">r</span><span class="main">::</span>real<span class="main">)</span> <span class="main">*</span> <span class="bound">ra</span> <span class="main">+</span> <span class="main">-</span> <span class="main">(</span><span class="bound">r</span> <span class="main">*</span> <span class="bound">rb</span><span class="main">)</span> <span class="main">=</span> <span class="bound">r</span> <span class="main">*</span> <span class="main">(</span><span class="bound">ra</span> <span class="main">+</span> <span class="main">-</span> <span class="bound">rb</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> minus_real_def right_diff_distrib<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="free">a</span> <span class="main">*</span> <span class="main">(</span><span class="free">s<span class="hidden">⇩</span><sub>1</sub></span><span class="main">$</span><span class="main">1</span> <span class="main">+</span> <span class="main">-</span> <span class="free">L</span><span class="main">)</span> <span class="main">+</span> <span class="main">-</span> <span class="main">(</span><span class="free">a</span> <span class="main">*</span> <span class="main">(</span><span class="free">s<span class="hidden">⇩</span><sub>2</sub></span><span class="main">$</span><span class="main">1</span> <span class="main">+</span> <span class="main">-</span> <span class="free">L</span><span class="main">)</span><span class="main">)</span><span class="main">¦</span> <span class="main">=</span> <span class="free">a</span> <span class="main">*</span> <span class="main">¦</span><span class="free">s<span class="hidden">⇩</span><sub>1</sub></span><span class="main">$</span><span class="main">1</span> <span class="main">+</span> <span class="main">-</span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub></span><span class="main">$</span><span class="main">1</span><span class="main">¦</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> a1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> abs_mult<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="free">a</span> <span class="main">*</span> <span class="main">(</span><span class="free">s<span class="hidden">⇩</span><sub>2</sub></span><span class="main">$</span><span class="main">1</span> <span class="main">-</span> <span class="free">L</span><span class="main">)</span> <span class="main">-</span> <span class="free">a</span> <span class="main">*</span> <span class="main">(</span><span class="free">s<span class="hidden">⇩</span><sub>1</sub></span><span class="main">$</span><span class="main">1</span> <span class="main">-</span> <span class="free">L</span><span class="main">)</span><span class="main">¦</span> <span class="main">=</span> <span class="free">a</span> <span class="main">*</span> <span class="main">¦</span><span class="free">s<span class="hidden">⇩</span><sub>1</sub></span><span class="main">$</span><span class="main">1</span> <span class="main">-</span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub></span><span class="main">$</span><span class="main">1</span><span class="main">¦</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> f2 minus_real_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> local_lipschitz_temp_dyn<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="main">(</span><span class="free">a</span><span class="main">::</span>real<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"local_lipschitz UNIV UNIV <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">::</span>real<span class="main">.</span> <span class="keyword1">f</span> <span class="free">a</span> <span class="free">L</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">unfold</span> local_lipschitz_def lipschitz_on_def dist_norm<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="main">1</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">a</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> norm_diff_temp_dyn<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> norm_vec_def L2_set_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> UNIV_4<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> real_sqrt_abs<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> real_le_lsqrt<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> local_flow_temp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟹</span> local_flow <span class="main">(</span><span class="keyword1">f</span> <span class="free">a</span> <span class="free">L</span><span class="main">)</span> UNIV UNIV <span class="main">(</span><span class="keyword1">φ</span> <span class="free">a</span> <span class="free">L</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">poly_derivatives</span></span> local_lipschitz_temp_dyn <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> forall_4 vec_eq_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> temp_dyn_down_real_arith<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> Thyps<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">Tmin</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">Tmin</span> <span class="main">≤</span> <span class="free">T</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">T</span> <span class="main">≤</span> <span class="free">Tmax</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> thyps<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="main">(</span><span class="free">t</span><span class="main">::</span>real<span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">τ</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">t</span><span class="main">}</span><span class="main">.</span> <span class="bound">τ</span> <span class="main">≤</span> <span class="main">-</span> <span class="main">(</span>ln <span class="main">(</span><span class="free">Tmin</span> <span class="main">/</span> <span class="free">T</span><span class="main">)</span> <span class="main">/</span> <span class="free">a</span><span class="main">)</span> "</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Tmin</span> <span class="main">≤</span> exp <span class="main">(</span><span class="main">-</span><span class="free">a</span> <span class="main">*</span> <span class="free">t</span><span class="main">)</span> <span class="main">*</span> <span class="free">T</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"exp <span class="main">(</span><span class="main">-</span><span class="free">a</span> <span class="main">*</span> <span class="free">t</span><span class="main">)</span> <span class="main">*</span> <span class="free">T</span> <span class="main">≤</span> <span class="free">Tmax</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">t</span> <span class="main">∧</span> <span class="free">t</span> <span class="main">≤</span> <span class="main">-</span> <span class="main">(</span>ln <span class="main">(</span><span class="free">Tmin</span> <span class="main">/</span> <span class="free">T</span><span class="main">)</span> <span class="main">/</span> <span class="free">a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> thyps <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"ln <span class="main">(</span><span class="free">Tmin</span> <span class="main">/</span> <span class="free">T</span><span class="main">)</span> <span class="main">≤</span> <span class="main">-</span> <span class="free">a</span> <span class="main">*</span> <span class="free">t</span> <span class="main">∧</span> <span class="main">-</span> <span class="free">a</span> <span class="main">*</span> <span class="free">t</span> <span class="main">≤</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> divide_le_cancel <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Tmin</span> <span class="main">/</span> <span class="free">T</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Thyps <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> obs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Tmin</span> <span class="main">/</span> <span class="free">T</span> <span class="main">≤</span> exp <span class="main">(</span><span class="main">-</span><span class="free">a</span> <span class="main">*</span> <span class="free">t</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"exp <span class="main">(</span><span class="main">-</span><span class="free">a</span> <span class="main">*</span> <span class="free">t</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> exp_ln exp_le_one_iff <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> exp_less_cancel_iff not_less<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">Tmin</span> <span class="main">≤</span> exp <span class="main">(</span><span class="main">-</span><span class="free">a</span> <span class="main">*</span> <span class="free">t</span><span class="main">)</span> <span class="main">*</span> <span class="free">T</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Thyps <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pos_divide_le_eq<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"exp <span class="main">(</span><span class="main">-</span><span class="free">a</span> <span class="main">*</span> <span class="free">t</span><span class="main">)</span> <span class="main">*</span> <span class="free">T</span> <span class="main">≤</span> <span class="free">Tmax</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Thyps mult_left_le_one_le<span class="main">[</span><span class="operator">OF</span> _ exp_ge_zero obs<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">T</span></span><span class="main">]</span>
      less_eq_real_def order_trans_rules<span class="main">(</span>23<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> temp_dyn_up_real_arith<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> Thyps<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Tmin</span> <span class="main">≤</span> <span class="free">T</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">T</span> <span class="main">≤</span> <span class="free">Tmax</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">Tmax</span> <span class="main">&lt;</span> <span class="main">(</span><span class="free">L</span><span class="main">::</span>real<span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> thyps<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">τ</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">t</span><span class="main">}</span><span class="main">.</span> <span class="bound">τ</span> <span class="main">≤</span> <span class="main">-</span> <span class="main">(</span>ln <span class="main">(</span><span class="main">(</span><span class="free">L</span> <span class="main">-</span> <span class="free">Tmax</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="free">L</span> <span class="main">-</span> <span class="free">T</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> <span class="free">a</span><span class="main">)</span> "</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">L</span> <span class="main">-</span> <span class="free">Tmax</span> <span class="main">≤</span> exp <span class="main">(</span><span class="main">-</span><span class="main">(</span><span class="free">a</span> <span class="main">*</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">L</span> <span class="main">-</span> <span class="free">T</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">L</span> <span class="main">-</span> exp <span class="main">(</span><span class="main">-</span><span class="main">(</span><span class="free">a</span> <span class="main">*</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">L</span> <span class="main">-</span> <span class="free">T</span><span class="main">)</span> <span class="main">≤</span> <span class="free">Tmax</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">Tmin</span> <span class="main">≤</span> <span class="free">L</span> <span class="main">-</span> exp <span class="main">(</span><span class="main">-</span><span class="main">(</span><span class="free">a</span> <span class="main">*</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">L</span> <span class="main">-</span> <span class="free">T</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">t</span> <span class="main">∧</span> <span class="free">t</span> <span class="main">≤</span> <span class="main">-</span> <span class="main">(</span>ln <span class="main">(</span><span class="main">(</span><span class="free">L</span> <span class="main">-</span> <span class="free">Tmax</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="free">L</span> <span class="main">-</span> <span class="free">T</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> <span class="free">a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> thyps <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"ln <span class="main">(</span><span class="main">(</span><span class="free">L</span> <span class="main">-</span> <span class="free">Tmax</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="free">L</span> <span class="main">-</span> <span class="free">T</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="main">-</span> <span class="free">a</span> <span class="main">*</span> <span class="free">t</span> <span class="main">∧</span> <span class="main">-</span> <span class="free">a</span> <span class="main">*</span> <span class="free">t</span> <span class="main">≤</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> divide_le_cancel <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">L</span> <span class="main">-</span> <span class="free">Tmax</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="free">L</span> <span class="main">-</span> <span class="free">T</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Thyps <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">L</span> <span class="main">-</span> <span class="free">Tmax</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="free">L</span> <span class="main">-</span> <span class="free">T</span><span class="main">)</span> <span class="main">≤</span> exp <span class="main">(</span><span class="main">-</span><span class="free">a</span> <span class="main">*</span> <span class="free">t</span><span class="main">)</span> <span class="main">∧</span> exp <span class="main">(</span><span class="main">-</span><span class="free">a</span> <span class="main">*</span> <span class="free">t</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> exp_ln exp_le_one_iff <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> exp_less_cancel_iff not_less<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">L</span> <span class="main">-</span> <span class="free">T</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Thyps <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> obs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">L</span> <span class="main">-</span> <span class="free">Tmax</span><span class="main">)</span> <span class="main">≤</span> exp <span class="main">(</span><span class="main">-</span><span class="free">a</span> <span class="main">*</span> <span class="free">t</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">L</span> <span class="main">-</span> <span class="free">T</span><span class="main">)</span> <span class="main">∧</span> exp <span class="main">(</span><span class="main">-</span><span class="free">a</span> <span class="main">*</span> <span class="free">t</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">L</span> <span class="main">-</span> <span class="free">T</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="free">L</span> <span class="main">-</span> <span class="free">T</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pos_divide_le_eq<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">L</span> <span class="main">-</span> <span class="free">Tmax</span><span class="main">)</span> <span class="main">≤</span> exp <span class="main">(</span><span class="main">-</span><span class="main">(</span><span class="free">a</span> <span class="main">*</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">L</span> <span class="main">-</span> <span class="free">T</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">L</span> <span class="main">-</span> exp <span class="main">(</span><span class="main">-</span><span class="main">(</span><span class="free">a</span> <span class="main">*</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">L</span> <span class="main">-</span> <span class="free">T</span><span class="main">)</span> <span class="main">≤</span> <span class="free">Tmax</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">Tmin</span> <span class="main">≤</span> <span class="free">L</span> <span class="main">-</span> exp <span class="main">(</span><span class="main">-</span><span class="main">(</span><span class="free">a</span> <span class="main">*</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">L</span> <span class="main">-</span> <span class="free">T</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Thyps <span class="keyword2"><span class="keyword">and</span></span> obs <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> ffb_temp_dyn <span class="main">=</span> local_flow.ffb_g_ode_ivl<span class="main">[</span><span class="operator">OF</span> local_flow_temp _ UNIV_I<span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> thermostat<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">Tmin</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">Tmax</span> <span class="main">&lt;</span> <span class="free">L</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="free">Tmin</span> <span class="main">≤</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">≤</span> <span class="free">Tmax</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">4</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span> <span class="main">≤</span> <span class="keyword1">fb<span class="hidden">⇩</span><sub>ℱ</sub></span>
  <span class="main">(</span><span class="keyword1">LOOP</span>
    <span class="comment1">― ‹control›</span>
    <span class="main">(</span><span class="main">(</span><span class="numeral">2</span> <span class="main">::=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">;</span><span class="main">(</span><span class="numeral">3</span> <span class="main">::=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
    <span class="main">(</span><span class="keyword1">IF</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">4</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">3</span> <span class="main">≤</span> <span class="free">Tmin</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">THEN</span> <span class="main">(</span><span class="numeral">4</span> <span class="main">::=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">ELSE</span>
    <span class="main">(</span><span class="keyword1">IF</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">4</span> <span class="main">=</span> <span class="main">1</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">3</span> <span class="main">≥</span> <span class="free">Tmax</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">THEN</span> <span class="main">(</span><span class="numeral">4</span> <span class="main">::=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span><span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">ELSE</span> <span class="keyword1">skip</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
    <span class="comment1">― ‹dynamics›</span>
    <span class="main">(</span><span class="keyword1">IF</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">4</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="keyword1">THEN</span> <span class="main">(</span><span class="keyword1">x´=</span><span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="keyword1">f</span> <span class="free">a</span> <span class="main">0</span><span class="main">)</span> <span class="main">&amp;</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span> <span class="main">≤</span> <span class="main">-</span> <span class="main">(</span>ln <span class="main">(</span><span class="free">Tmin</span><span class="main">/</span><span class="bound">s</span><span class="main">$</span><span class="numeral">3</span><span class="main">)</span><span class="main">)</span><span class="main">/</span><span class="free">a</span><span class="main">)</span> <span class="keyword1">on</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">t</span><span class="main">}</span><span class="main">)</span> UNIV <span class="main">@</span> <span class="main">0</span><span class="main">)</span>
    <span class="keyword1">ELSE</span> <span class="main">(</span><span class="keyword1">x´=</span><span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="keyword1">f</span> <span class="free">a</span> <span class="free">L</span><span class="main">)</span> <span class="main">&amp;</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span> <span class="main">≤</span> <span class="main">-</span> <span class="main">(</span>ln <span class="main">(</span><span class="main">(</span><span class="free">L</span><span class="main">-</span><span class="free">Tmax</span><span class="main">)</span><span class="main">/</span><span class="main">(</span><span class="free">L</span><span class="main">-</span><span class="bound">s</span><span class="main">$</span><span class="numeral">3</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">/</span><span class="free">a</span><span class="main">)</span> <span class="keyword1">on</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">t</span><span class="main">}</span><span class="main">)</span> UNIV <span class="main">@</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">)</span>
  <span class="keyword1">INV</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">Tmin</span> <span class="main">≤</span><span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">≤</span> <span class="free">Tmax</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">s</span><span class="main">$</span><span class="numeral">4</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">4</span> <span class="main">=</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
  <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="free">Tmin</span> <span class="main">≤</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">≤</span> <span class="free">Tmax</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ffb_loopI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ffb_temp_dyn<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">,</span></span></span>2<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span> le_fun_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> temp_dyn_up_real_arith<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span>1<span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span> _ _ assms<span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span>4<span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">Tmin</span></span></span></span></span></span><span class="main">]</span>
    <span class="keyword2"><span class="keyword">and</span></span> temp_dyn_down_real_arith<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">,</span></span></span>3<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main">,</span> <span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">Tmax</span></span></span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">no_notation</span></span> temp_vec_field <span class="main">(</span><span class="quoted">"<span class="keyword1">f</span>"</span><span class="main">)</span>
        <span class="keyword2"><span class="keyword">and</span></span> temp_flow <span class="main">(</span><span class="quoted">"<span class="keyword1">φ</span>"</span><span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹ Tank ›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ A controller turns a water pump on and off to keep the level of water <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"h"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> in a tank
within an acceptable range <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"hmin ≤ h ≤ hmax"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. Just like in the previous example, after 
each intervention, the controller registers the current level of water and resets its chronometer,
then it changes the status of the water pump accordingly. The level of water grows linearly 
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"h' = k"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> at a rate of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"k = c<span class="hidden">⇩</span><sub>i</sub>-c<span class="hidden">⇩</span><sub>o</sub>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> if the pump is on, and at a rate of 
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"k = -c<span class="hidden">⇩</span><sub>o</sub>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> if the pump is off. We use <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">1</span></span><span class="main"><span class="main">::</span></span><span class="numeral"><span class="numeral">4</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> to denote the tank's level of water,
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="numeral"><span class="numeral">2</span></span><span class="main"><span class="main">::</span></span><span class="numeral"><span class="numeral">4</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is time as measured by the controller's chronometer, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="numeral"><span class="numeral">3</span></span><span class="main"><span class="main">::</span></span><span class="numeral"><span class="numeral">4</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is the
level of water measured by the chronometer, and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="numeral"><span class="numeral">4</span></span><span class="main"><span class="main">::</span></span><span class="numeral"><span class="numeral">4</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> states whether the pump is on
(<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"s$4 = 1"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>) or off (<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"s$4 = 0"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>). We prove that the controller keeps the level of
water between <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"hmin"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"hmax"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. ›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">tank_vec_field</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real <span class="main">⇒</span> real<span class="main">^</span><span class="numeral">4</span> <span class="main">⇒</span> real<span class="main">^</span><span class="numeral">4</span>"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">f</span>"</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">f</span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="keyword1">χ</span> <span class="bound">i</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">i</span> <span class="main">=</span> <span class="numeral">2</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">i</span> <span class="main">=</span> <span class="main">1</span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">tank_flow</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real <span class="main">⇒</span> real <span class="main">⇒</span> real<span class="main">^</span><span class="numeral">4</span> <span class="main">⇒</span> real<span class="main">^</span><span class="numeral">4</span>"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">φ</span>"</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">φ</span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="keyword1">χ</span> <span class="bound">i</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">i</span> <span class="main">=</span> <span class="main">1</span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">*</span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="main">1</span> <span class="keyword1">else</span> 
  <span class="main">(</span><span class="keyword1">if</span> <span class="bound">i</span> <span class="main">=</span> <span class="numeral">2</span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="numeral">2</span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">tank_guard</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real <span class="main">⇒</span> real <span class="main">⇒</span> real<span class="main">^</span><span class="numeral">4</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">G</span>"</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">G</span></span> <span class="free"><span class="bound"><span class="entity">Hm</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="numeral">2</span> <span class="main">≤</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Hm</span></span></span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="numeral">3</span><span class="main">)</span><span class="main">/</span><span class="free"><span class="bound"><span class="entity">k</span></span></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">tank_loop_inv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real <span class="main">⇒</span> real <span class="main">⇒</span> real<span class="main">^</span><span class="numeral">4</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">I</span>"</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">I</span></span> <span class="free"><span class="bound"><span class="entity">hmin</span></span></span> <span class="free"><span class="bound"><span class="entity">hmax</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">hmin</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="main">1</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="main">1</span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">hmax</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="numeral">4</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="numeral">4</span> <span class="main">=</span> <span class="main">1</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">tank_diff_inv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real <span class="main">⇒</span> real <span class="main">⇒</span> real <span class="main">⇒</span> real<span class="main">^</span><span class="numeral">4</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">dI</span>"</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">dI</span></span> <span class="free"><span class="bound"><span class="entity">hmin</span></span></span> <span class="free"><span class="bound"><span class="entity">hmax</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="main">1</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">*</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="numeral">2</span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="numeral">3</span> <span class="main">∧</span> <span class="main">0</span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="numeral">2</span> <span class="main">∧</span> 
    <span class="free"><span class="bound"><span class="entity">hmin</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="numeral">3</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="numeral">3</span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">hmax</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="numeral">4</span> <span class="main">=</span><span class="main">0</span> <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="numeral">4</span> <span class="main">=</span> <span class="main">1</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> local_flow_tank<span class="main">:</span> <span class="quoted"><span class="quoted">"local_flow <span class="main">(</span><span class="keyword1">f</span> <span class="free">k</span><span class="main">)</span> UNIV UNIV <span class="main">(</span><span class="keyword1">φ</span> <span class="free">k</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> local_lipschitz_def lipschitz_on_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">1</span><span class="main">/</span><span class="numeral">2</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="main">1</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dist_norm norm_vec_def L2_set_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> UNIV_4<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">poly_derivatives</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> vec_eq_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> tank_arith<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="main">(</span><span class="free">τ</span><span class="main">::</span>real<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">c<span class="hidden">⇩</span><sub>o</sub></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">c<span class="hidden">⇩</span><sub>o</sub></span> <span class="main">&lt;</span> <span class="free">c<span class="hidden">⇩</span><sub>i</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">τ</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">τ</span><span class="main">}</span><span class="main">.</span> <span class="bound">τ</span> <span class="main">≤</span> <span class="main">-</span> <span class="main">(</span><span class="main">(</span><span class="free">hmin</span> <span class="main">-</span> <span class="free">y</span><span class="main">)</span> <span class="main">/</span> <span class="free">c<span class="hidden">⇩</span><sub>o</sub></span><span class="main">)</span> <span class="main">⟹</span>  <span class="free">hmin</span> <span class="main">≤</span> <span class="free">y</span> <span class="main">-</span> <span class="free">c<span class="hidden">⇩</span><sub>o</sub></span> <span class="main">*</span> <span class="free">τ</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">τ</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">τ</span><span class="main">}</span><span class="main">.</span> <span class="bound">τ</span> <span class="main">≤</span> <span class="main">(</span><span class="free">hmax</span> <span class="main">-</span> <span class="free">y</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="free">c<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">-</span> <span class="free">c<span class="hidden">⇩</span><sub>o</sub></span><span class="main">)</span> <span class="main">⟹</span>  <span class="main">(</span><span class="free">c<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">-</span> <span class="free">c<span class="hidden">⇩</span><sub>o</sub></span><span class="main">)</span> <span class="main">*</span> <span class="free">τ</span> <span class="main">+</span> <span class="free">y</span> <span class="main">≤</span> <span class="free">hmax</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">hmin</span> <span class="main">≤</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">hmin</span> <span class="main">≤</span> <span class="main">(</span><span class="free">c<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">-</span> <span class="free">c<span class="hidden">⇩</span><sub>o</sub></span><span class="main">)</span> <span class="main">*</span> <span class="free">τ</span> <span class="main">+</span> <span class="free">y</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">≤</span> <span class="free">hmax</span> <span class="main">⟹</span> <span class="free">y</span> <span class="main">-</span> <span class="free">c<span class="hidden">⇩</span><sub>o</sub></span> <span class="main">*</span> <span class="free">τ</span> <span class="main">≤</span> <span class="free">hmax</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span> le_divide_eq assms<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">meson</span> add_mono less_eq_real_def mult_left_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> add_increasing2 less_eq_real_def mult_nonneg_nonneg<span class="main">)</span> 

<span class="keyword1"><span class="command">lemma</span></span> tank_flow<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">c<span class="hidden">⇩</span><sub>o</sub></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">c<span class="hidden">⇩</span><sub>o</sub></span> <span class="main">&lt;</span> <span class="free">c<span class="hidden">⇩</span><sub>i</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Collect <span class="main">(</span><span class="keyword1">I</span> <span class="free">hmin</span> <span class="free">hmax</span><span class="main">)</span> <span class="main">≤</span> <span class="keyword1">fb<span class="hidden">⇩</span><sub>ℱ</sub></span>
  <span class="main">(</span><span class="keyword1">LOOP</span> 
    <span class="comment1">― ‹control›</span>
    <span class="main">(</span><span class="main">(</span><span class="numeral">2</span> <span class="main">::=</span><span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span><span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">;</span><span class="main">(</span><span class="numeral">3</span> <span class="main">::=</span><span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
    <span class="main">(</span><span class="keyword1">IF</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">4</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">3</span> <span class="main">≤</span> <span class="free">hmin</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">THEN</span> <span class="main">(</span><span class="numeral">4</span> <span class="main">::=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">ELSE</span> 
    <span class="main">(</span><span class="keyword1">IF</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">4</span> <span class="main">=</span> <span class="main">1</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">3</span> <span class="main">≥</span> <span class="free">hmax</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">THEN</span> <span class="main">(</span><span class="numeral">4</span> <span class="main">::=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span><span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">ELSE</span> <span class="keyword1">skip</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
    <span class="comment1">― ‹dynamics›</span>
    <span class="main">(</span><span class="keyword1">IF</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">4</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="keyword1">THEN</span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="keyword1">f</span> <span class="main">(</span><span class="free">c<span class="hidden">⇩</span><sub>i</sub></span><span class="main">-</span><span class="free">c<span class="hidden">⇩</span><sub>o</sub></span><span class="main">)</span> <span class="main">&amp;</span> <span class="main">(</span><span class="keyword1">G</span> <span class="free">hmax</span> <span class="main">(</span><span class="free">c<span class="hidden">⇩</span><sub>i</sub></span><span class="main">-</span><span class="free">c<span class="hidden">⇩</span><sub>o</sub></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> 
     <span class="keyword1">ELSE</span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="keyword1">f</span> <span class="main">(</span><span class="main">-</span><span class="free">c<span class="hidden">⇩</span><sub>o</sub></span><span class="main">)</span> <span class="main">&amp;</span> <span class="main">(</span><span class="keyword1">G</span> <span class="free">hmin</span> <span class="main">(</span><span class="main">-</span><span class="free">c<span class="hidden">⇩</span><sub>o</sub></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">)</span> <span class="keyword1">INV</span> <span class="keyword1">I</span> <span class="free">hmin</span> <span class="free">hmax</span><span class="main">)</span>  
  <span class="main">(</span>Collect <span class="main">(</span><span class="keyword1">I</span> <span class="free">hmin</span> <span class="free">hmax</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ffb_loopI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> le_fun_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> le_fun_def local_flow.ffb_g_ode_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> local_flow_tank<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> assms tank_arith<span class="main">[</span><span class="operator">OF</span> _ assms<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">no_notation</span></span> tank_vec_field <span class="main">(</span><span class="quoted">"<span class="keyword1">f</span>"</span><span class="main">)</span>
        <span class="keyword2"><span class="keyword">and</span></span> tank_flow <span class="main">(</span><span class="quoted">"<span class="keyword1">φ</span>"</span><span class="main">)</span>
        <span class="keyword2"><span class="keyword">and</span></span> tank_loop_inv <span class="main">(</span><span class="quoted">"<span class="keyword1">I</span>"</span><span class="main">)</span>
        <span class="keyword2"><span class="keyword">and</span></span> tank_diff_inv <span class="main">(</span><span class="quoted">"<span class="keyword1">dI</span>"</span><span class="main">)</span>
        <span class="keyword2"><span class="keyword">and</span></span> tank_guard <span class="main">(</span><span class="quoted">"<span class="keyword1">G</span>"</span><span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="HS_VC_MKA">
<div class="head">
<h1>Theory HS_VC_MKA</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:       Verification components with MKAs
    Author:      Jonathan Julián Huerta y Munive, 2020
    Maintainer:  Jonathan Julián Huerta y Munive &lt;jonjulian23@gmail.com&gt;
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹ Verification components with MKA ›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ We use the forward box operator of antidomain Kleene algebras to derive rules for weakest 
liberal preconditions (wlps) of regular programs. ›</span></span>

<span class="keyword1"><span class="command">theory</span></span> HS_VC_MKA
  <span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="../KAD/Modal_Kleene_Algebra.html">KAD.Modal_Kleene_Algebra</a>"</span>

<span class="keyword2"><span class="keyword">begin</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹ Verification in AKA ›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Here we derive verification components with weakest liberal preconditions based on 
antidomain Kleene algebra ›</span></span>

<span class="keyword1"><span class="command">no_notation</span></span> Range_Semiring.antirange_semiring_class.ars_r <span class="main">(</span><span class="quoted">"<span class="keyword1">r</span>"</span><span class="main">)</span>
        <span class="keyword2"><span class="keyword">and</span></span> HOL.If <span class="main">(</span><span class="quoted">"<span class="keyword3">(</span><span class="keyword1">if</span> <span class="keyword3">(</span>_<span class="keyword3">)</span><span class="keyword3">/ </span><span class="keyword1">then</span> <span class="keyword3">(</span>_<span class="keyword3">)</span><span class="keyword3">/ </span><span class="keyword1">else</span> <span class="keyword3">(</span>_<span class="keyword3">)</span><span class="keyword3">)</span>"</span> <span class="main">[</span>0<span class="main">,</span> 0<span class="main">,</span> 10<span class="main">]</span> 10<span class="main">)</span>

<span class="keyword1"><span class="command">notation</span></span> zero_class.zero <span class="main">(</span><span class="quoted">"<span class="keyword1">0</span>"</span><span class="main">)</span>

<span class="keyword1"><span class="command">context</span></span> antidomain_kleene_algebra
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="comment1">― ‹ Skip ›</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="main">|</span><span class="main">1</span><span class="main">]</span> <span class="free">x</span> <span class="main">=</span> <span class="keyword1">d</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> fbox_one <span class="keyword1"><span class="command">.</span></span>

<span class="comment1">― ‹ Abort ›</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="main">|</span><span class="numeral">0</span><span class="main">]</span> <span class="free">q</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> fbox_zero <span class="keyword1"><span class="command">.</span></span>

<span class="comment1">― ‹ Sequential composition ›</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="main">|</span><span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span><span class="main">]</span> <span class="free">q</span> <span class="main">=</span> <span class="main">|</span><span class="free">x</span><span class="main">]</span> <span class="main">|</span><span class="free">y</span><span class="main">]</span> <span class="free">q</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> fbox_mult <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">declare</span></span> fbox_mult <span class="main">[</span><span class="operator">simp</span><span class="main">]</span>

<span class="comment1">― ‹ Nondeterministic choice ›</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="main">|</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">]</span> <span class="free">q</span> <span class="main">=</span> <span class="main">|</span><span class="free">x</span><span class="main">]</span> <span class="free">q</span> <span class="main">⋅</span> <span class="main">|</span><span class="free">y</span><span class="main">]</span> <span class="free">q</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> fbox_add2 <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lemma</span></span> le_fbox_choice_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">d</span> <span class="free">p</span> <span class="main">≤</span> <span class="main">|</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">]</span><span class="free">q</span> <span class="main">⟷</span> <span class="main">(</span><span class="keyword1">d</span> <span class="free">p</span> <span class="main">≤</span> <span class="main">|</span><span class="free">x</span><span class="main">]</span><span class="free">q</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="keyword1">d</span> <span class="free">p</span> <span class="main">≤</span> <span class="main">|</span><span class="free">y</span><span class="main">]</span><span class="free">q</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> local.a_closure' local.ads_d_def local.dnsz.dom_glb_eq local.fbox_add2 local.fbox_def<span class="main">)</span>

<span class="comment1">― ‹ Conditional statement ›</span> <span class="comment1">(* by Victor Gomes, Georg Struth *)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">aka_cond</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">if</span> _ <span class="keyword1">then</span> _ <span class="keyword1">else</span> _"</span> <span class="main">[</span>64<span class="main">,</span>64<span class="main">,</span>64<span class="main">]</span> 63<span class="main">)</span> 
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">if</span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="keyword1"><span class="free">then</span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1"><span class="free">else</span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> <span class="keyword1">d</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">⋅</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">+</span> <span class="keyword1">ad</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">⋅</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> fbox_export1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">ad</span> <span class="free">p</span> <span class="main">+</span> <span class="main">|</span><span class="free">x</span><span class="main">]</span> <span class="free">q</span> <span class="main">=</span> <span class="main">|</span><span class="keyword1">d</span> <span class="free">p</span> <span class="main">⋅</span> <span class="free">x</span><span class="main">]</span> <span class="free">q</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> a_d_add_closure addual.ars_r_def fbox_def fbox_mult <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> fbox_cond <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">|</span><span class="keyword1">if</span> <span class="free">p</span> <span class="keyword1">then</span> <span class="free">x</span> <span class="keyword1">else</span> <span class="free">y</span><span class="main">]</span> <span class="free">q</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">ad</span> <span class="free">p</span> <span class="main">+</span> <span class="main">|</span><span class="free">x</span><span class="main">]</span> <span class="free">q</span><span class="main">)</span> <span class="main">⋅</span> <span class="main">(</span><span class="keyword1">d</span> <span class="free">p</span> <span class="main">+</span> <span class="main">|</span><span class="free">y</span><span class="main">]</span> <span class="free">q</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> fbox_export1 local.ans_d_def local.fbox_mult 
  <span class="keyword1"><span class="command">unfolding</span></span> aka_cond_def ads_d_def fbox_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> fbox_cond2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">|</span><span class="keyword1">if</span> <span class="free">p</span> <span class="keyword1">then</span> <span class="free">x</span> <span class="keyword1">else</span> <span class="free">y</span><span class="main">]</span> <span class="free">q</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">d</span> <span class="free">p</span> <span class="main">⋅</span> <span class="main">|</span><span class="free">x</span><span class="main">]</span> <span class="free">q</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="keyword1">ad</span> <span class="free">p</span> <span class="main">⋅</span> <span class="main">|</span><span class="free">y</span><span class="main">]</span> <span class="free">q</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?d1</span> <span class="main">+</span> <span class="var">?d2</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> obs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="keyword1">d</span> <span class="free">p</span> <span class="main">⋅</span> <span class="var">?lhs</span> <span class="main">+</span> <span class="keyword1">ad</span> <span class="free">p</span> <span class="main">⋅</span> <span class="var">?lhs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> local.a_closure' local.a_de_morgan fbox_def ans_d_def
        ads_d_def local.am2 local.am5_lem local.dka.dsg3 local.dka.dsr5<span class="main">)</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">d</span> <span class="free">p</span> <span class="main">⋅</span> <span class="var">?lhs</span> <span class="main">=</span> <span class="keyword1">d</span> <span class="free">p</span> <span class="main">⋅</span> <span class="main">|</span><span class="free">x</span><span class="main">]</span> <span class="free">q</span> <span class="main">⋅</span> <span class="main">(</span><span class="keyword1">d</span> <span class="free">p</span> <span class="main">+</span> <span class="keyword1">d</span> <span class="main">(</span> <span class="main">|</span><span class="free">y</span><span class="main">]</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> fbox_cond local.a_d_add_closure local.ads_d_def 
      local.ds.ddual.mult_assoc local.fbox_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="keyword1">d</span> <span class="free">p</span> <span class="main">⋅</span> <span class="main">|</span><span class="free">x</span><span class="main">]</span> <span class="free">q</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> local.ads_d_def local.am2 local.dka.dns5 local.ds.ddual.mult_assoc local.fbox_def<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">d</span> <span class="free">p</span> <span class="main">⋅</span> <span class="var">?lhs</span> <span class="main">=</span> <span class="keyword1">d</span> <span class="free">p</span> <span class="main">⋅</span> <span class="main">|</span><span class="free">x</span><span class="main">]</span> <span class="free">q</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ad</span> <span class="free">p</span> <span class="main">⋅</span> <span class="var">?lhs</span> <span class="main">=</span> <span class="keyword1">ad</span> <span class="free">p</span> <span class="main">⋅</span> <span class="main">|</span><span class="free">y</span><span class="main">]</span> <span class="free">q</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add_commute fbox_cond local.a_closure' local.a_mult_add ads_d_def ans_d_def
        local.dnsz.dns5 local.ds.ddual.mult_assoc local.fbox_def<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> obs <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">― ‹ While loop ›</span> <span class="comment1">(* by Victor Gomes, Georg Struth *)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">aka_whilei</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">while</span> _ <span class="keyword1">do</span> _ <span class="keyword1">inv</span> _"</span> <span class="main">[</span>64<span class="main">,</span>64<span class="main">,</span>64<span class="main">]</span> 63<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">while</span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1"><span class="free">do</span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1"><span class="free">inv</span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span>  <span class="main">=</span> <span class="main">(</span><span class="keyword1">d</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">⋅</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="keyword1">ad</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> fbox_frame<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">d</span> <span class="free">p</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">x</span> <span class="main">⋅</span> <span class="keyword1">d</span> <span class="free">p</span> <span class="main">⟹</span> <span class="keyword1">d</span> <span class="free">q</span> <span class="main">≤</span> <span class="main">|</span><span class="free">x</span><span class="main">]</span> <span class="free">r</span> <span class="main">⟹</span> <span class="keyword1">d</span> <span class="free">p</span> <span class="main">⋅</span> <span class="keyword1">d</span> <span class="free">q</span> <span class="main">≤</span> <span class="main">|</span><span class="free">x</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">d</span> <span class="free">p</span> <span class="main">⋅</span> <span class="keyword1">d</span> <span class="free">r</span><span class="main">)</span>"</span></span>    
  <span class="keyword1"><span class="command">using</span></span> dual.mult_isol_var fbox_add1 fbox_demodalisation3 fbox_simp <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> fbox_shunt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">d</span> <span class="free">p</span> <span class="main">⋅</span> <span class="keyword1">d</span> <span class="free">q</span> <span class="main">≤</span> <span class="main">|</span><span class="free">x</span><span class="main">]</span> <span class="free">t</span> <span class="main">⟷</span> <span class="keyword1">d</span> <span class="free">p</span> <span class="main">≤</span> <span class="keyword1">ad</span> <span class="free">q</span> <span class="main">+</span> <span class="main">|</span><span class="free">x</span><span class="main">]</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> a_6 a_antitone' a_loc add_commute addual.ars_r_def am_d_def da_shunt2 fbox_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fbox_export2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">|</span><span class="free">x</span><span class="main">]</span> <span class="free">p</span> <span class="main">≤</span> <span class="main">|</span><span class="free">x</span> <span class="main">⋅</span> <span class="keyword1">ad</span> <span class="free">q</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">d</span> <span class="free">p</span> <span class="main">⋅</span> <span class="keyword1">ad</span> <span class="free">q</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span>
   <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">d</span> <span class="skolem">t</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">x</span> <span class="main">⋅</span> <span class="keyword1">d</span> <span class="free">p</span> <span class="main">⟹</span> <span class="keyword1">d</span> <span class="skolem">t</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">⋅</span> <span class="keyword1">ad</span> <span class="free">q</span> <span class="main">≤</span> <span class="free">x</span> <span class="main">⋅</span> <span class="keyword1">ad</span> <span class="free">q</span> <span class="main">⋅</span> <span class="keyword1">d</span> <span class="free">p</span> <span class="main">⋅</span> <span class="keyword1">ad</span> <span class="free">q</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> a_comm_var a_mult_idem ads_d_def am2 ds.ddual.mult_assoc phl_export2<span class="main">)</span>
   <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">d</span> <span class="skolem">t</span> <span class="main">≤</span> <span class="main">|</span><span class="free">x</span><span class="main">]</span> <span class="free">p</span> <span class="main">⟹</span> <span class="keyword1">d</span> <span class="skolem">t</span> <span class="main">≤</span> <span class="main">|</span><span class="free">x</span> <span class="main">⋅</span> <span class="keyword1">ad</span> <span class="free">q</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">d</span> <span class="free">p</span> <span class="main">⋅</span> <span class="keyword1">ad</span> <span class="free">q</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> a_closure' addual.ars_r_def ans_d_def dka.dsg3 ds.ddual.mult_assoc fbox_def fbox_demodalisation3<span class="main">)</span><span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> a_closure' addual.ars_r_def ans_d_def fbox_def order_refl<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> fbox_while<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">d</span> <span class="free">p</span> <span class="main">⋅</span> <span class="keyword1">d</span> <span class="free">t</span> <span class="main">≤</span> <span class="main">|</span><span class="free">x</span><span class="main">]</span> <span class="free">p</span> <span class="main">⟹</span> <span class="keyword1">d</span> <span class="free">p</span> <span class="main">≤</span> <span class="main">|</span><span class="main">(</span><span class="keyword1">d</span> <span class="free">t</span> <span class="main">⋅</span> <span class="free">x</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="keyword1">ad</span> <span class="free">t</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">d</span> <span class="free">p</span> <span class="main">⋅</span> <span class="keyword1">ad</span> <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">d</span> <span class="free">p</span> <span class="main">⋅</span> <span class="keyword1">d</span> <span class="free">t</span> <span class="main">≤</span> <span class="main">|</span><span class="free">x</span><span class="main">]</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">d</span> <span class="free">p</span> <span class="main">≤</span> <span class="main">|</span><span class="keyword1">d</span> <span class="free">t</span> <span class="main">⋅</span> <span class="free">x</span><span class="main">]</span> <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fbox_export1 fbox_shunt<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">d</span> <span class="free">p</span> <span class="main">≤</span> <span class="main">|</span><span class="main">(</span><span class="keyword1">d</span> <span class="free">t</span> <span class="main">⋅</span> <span class="free">x</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span><span class="main">]</span> <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fbox_star_induct_var<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> order_trans fbox_export2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> fbox_whilei<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">d</span> <span class="free">p</span> <span class="main">≤</span> <span class="keyword1">d</span> <span class="free">i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">d</span> <span class="free">i</span> <span class="main">⋅</span> <span class="keyword1">ad</span> <span class="free">t</span> <span class="main">≤</span> <span class="keyword1">d</span> <span class="free">q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">d</span> <span class="free">i</span> <span class="main">⋅</span> <span class="keyword1">d</span> <span class="free">t</span> <span class="main">≤</span> <span class="main">|</span><span class="free">x</span><span class="main">]</span> <span class="free">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">d</span> <span class="free">p</span> <span class="main">≤</span> <span class="main">|</span><span class="keyword1">while</span> <span class="free">t</span> <span class="keyword1">do</span> <span class="free">x</span> <span class="keyword1">inv</span> <span class="free">i</span><span class="main">]</span> <span class="free">q</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">d</span> <span class="free">i</span> <span class="main">≤</span> <span class="main">|</span><span class="main">(</span><span class="keyword1">d</span> <span class="free">t</span> <span class="main">⋅</span> <span class="free">x</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="keyword1">ad</span> <span class="free">t</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">d</span> <span class="free">i</span> <span class="main">⋅</span> <span class="keyword1">ad</span> <span class="free">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> fbox_while assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> <span class="main">|</span><span class="main">(</span><span class="keyword1">d</span> <span class="free">t</span> <span class="main">⋅</span> <span class="free">x</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="keyword1">ad</span> <span class="free">t</span><span class="main">]</span> <span class="free">q</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> local.dka.dom_iso local.dka.domain_invol local.fbox_iso<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> aka_whilei_def 
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> local.dual_order.trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> fbox_seq_var<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≤</span> <span class="main">|</span><span class="free">x</span><span class="main">]</span> <span class="free">p'</span> <span class="main">⟹</span> <span class="free">p'</span> <span class="main">≤</span> <span class="main">|</span><span class="free">y</span><span class="main">]</span> <span class="free">q</span> <span class="main">⟹</span>  <span class="free">p</span> <span class="main">≤</span> <span class="main">|</span><span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span><span class="main">]</span> <span class="free">q</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> h1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≤</span> <span class="main">|</span><span class="free">x</span><span class="main">]</span> <span class="free">p'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> h2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p'</span> <span class="main">≤</span> <span class="main">|</span><span class="free">y</span><span class="main">]</span> <span class="free">q</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">|</span><span class="free">x</span><span class="main">]</span> <span class="free">p'</span> <span class="main">≤</span> <span class="main">|</span><span class="free">x</span><span class="main">]</span> <span class="main">|</span><span class="free">y</span><span class="main">]</span> <span class="free">q</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> ads_d_def fbox_antitone_var fbox_dom fbox_iso<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> dual_order.trans fbox_mult h1<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> fbox_whilei_break<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="keyword1">d</span> <span class="free">p</span> <span class="main">≤</span> <span class="main">|</span><span class="free">y</span><span class="main">]</span> <span class="free">i</span> <span class="main">⟹</span> <span class="keyword1">d</span> <span class="free">i</span> <span class="main">⋅</span> <span class="keyword1">ad</span> <span class="free">t</span> <span class="main">≤</span> <span class="keyword1">d</span> <span class="free">q</span> <span class="main">⟹</span> <span class="keyword1">d</span> <span class="free">i</span> <span class="main">⋅</span> <span class="keyword1">d</span> <span class="free">t</span> <span class="main">≤</span> <span class="main">|</span><span class="free">x</span><span class="main">]</span> <span class="free">i</span> <span class="main">⟹</span> <span class="keyword1">d</span> <span class="free">p</span> <span class="main">≤</span> <span class="main">|</span><span class="free">y</span> <span class="main">⋅</span> <span class="main">(</span><span class="keyword1">while</span> <span class="free">t</span> <span class="keyword1">do</span> <span class="free">x</span> <span class="keyword1">inv</span> <span class="free">i</span><span class="main">)</span><span class="main">]</span> <span class="free">q</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fbox_seq_var<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ fbox_whilei<span class="main"><span class="main">]</span></span><span class="main">)</span> 
  <span class="keyword1"><span class="command">using</span></span> fbox_simp <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="comment1">― ‹ Finite iteration ›</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">aka_loopi</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">loop</span> _ <span class="keyword1">inv</span> _ "</span> <span class="main">[</span>64<span class="main">,</span>64<span class="main">]</span> 63<span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">loop</span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1"><span class="free">inv</span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">d</span> <span class="free">p</span> <span class="main">≤</span> <span class="main">|</span><span class="free">x</span><span class="main">]</span> <span class="free">p</span> <span class="main">⟹</span> <span class="keyword1">d</span> <span class="free">p</span> <span class="main">≤</span> <span class="main">|</span><span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span><span class="main">]</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> fbox_star_induct_var <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lemma</span></span> fbox_loopi<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≤</span> <span class="keyword1">d</span> <span class="free">i</span> <span class="main">⟹</span> <span class="keyword1">d</span> <span class="free">i</span> <span class="main">≤</span> <span class="main">|</span><span class="free">x</span><span class="main">]</span> <span class="free">i</span> <span class="main">⟹</span> <span class="keyword1">d</span> <span class="free">i</span> <span class="main">≤</span> <span class="keyword1">d</span> <span class="free">q</span> <span class="main">⟹</span> <span class="free">p</span> <span class="main">≤</span> <span class="main">|</span><span class="keyword1">loop</span> <span class="free">x</span> <span class="keyword1">inv</span> <span class="free">i</span><span class="main">]</span> <span class="free">q</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> aka_loopi_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> dual_order.trans fbox_iso fbox_star_induct_var<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fbox_loopi_break<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≤</span> <span class="main">|</span><span class="free">y</span><span class="main">]</span> <span class="keyword1">d</span> <span class="free">i</span> <span class="main">⟹</span> <span class="keyword1">d</span> <span class="free">i</span> <span class="main">≤</span> <span class="main">|</span><span class="free">x</span><span class="main">]</span> <span class="free">i</span> <span class="main">⟹</span> <span class="keyword1">d</span> <span class="free">i</span> <span class="main">≤</span> <span class="keyword1">d</span> <span class="free">q</span> <span class="main">⟹</span> <span class="free">p</span> <span class="main">≤</span> <span class="main">|</span><span class="free">y</span> <span class="main">⋅</span> <span class="main">(</span><span class="keyword1">loop</span> <span class="free">x</span> <span class="keyword1">inv</span> <span class="free">i</span><span class="main">)</span><span class="main">]</span> <span class="free">q</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> fbox_seq_var<span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main">)</span> <span class="main">(</span><span class="operator">rule</span> fbox_loopi<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span> 

<span class="comment1">― ‹ Invariants ›</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≤</span> <span class="free">i</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">≤</span> <span class="main">|</span><span class="free">x</span><span class="main">]</span><span class="free">i</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">≤</span> <span class="free">q</span> <span class="main">⟹</span> <span class="free">p</span> <span class="main">≤</span> <span class="main">|</span><span class="free">x</span><span class="main">]</span><span class="free">q</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> local.ads_d_def local.dpdz.dom_iso local.dual_order.trans local.fbox_iso<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≤</span> <span class="keyword1">d</span> <span class="free">i</span> <span class="main">⟹</span> <span class="keyword1">d</span> <span class="free">i</span> <span class="main">≤</span> <span class="main">|</span><span class="free">x</span><span class="main">]</span><span class="free">i</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">≤</span> <span class="keyword1">d</span> <span class="free">q</span> <span class="main">⟹</span> <span class="free">p</span> <span class="main">≤</span> <span class="main">|</span><span class="free">x</span><span class="main">]</span><span class="free">q</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> local.a_4 local.a_antitone' local.a_subid_aux2 ads_d_def local.antisym fbox_def
      local.dka.dsg1 local.dual.mult_isol_var local.dual_order.trans local.order.refl<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">i</span> <span class="main">≤</span> <span class="main">|</span><span class="free">x</span><span class="main">]</span> <span class="free">i</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="free">j</span> <span class="main">≤</span> <span class="main">|</span><span class="free">x</span><span class="main">]</span> <span class="free">j</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="free">j</span><span class="main">)</span> <span class="main">≤</span> <span class="main">|</span><span class="free">x</span><span class="main">]</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="free">j</span><span class="main">)</span>"</span></span>
  <span class="comment1">(*nitpick*)</span>
  <span class="keyword1"><span class="command">oops</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">d</span> <span class="free">i</span> <span class="main">≤</span> <span class="main">|</span><span class="free">x</span><span class="main">]</span> <span class="free">i</span> <span class="main">⟹</span> <span class="keyword1">d</span> <span class="free">j</span> <span class="main">≤</span> <span class="main">|</span><span class="free">x</span><span class="main">]</span> <span class="free">j</span> <span class="main">⟹</span> <span class="main">(</span><span class="keyword1">d</span> <span class="free">i</span> <span class="main">+</span> <span class="keyword1">d</span> <span class="free">j</span><span class="main">)</span> <span class="main">≤</span> <span class="main">|</span><span class="free">x</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">d</span> <span class="free">i</span> <span class="main">+</span> <span class="keyword1">d</span> <span class="free">j</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> dual_order.trans fbox_simp fbox_subdist join.le_supE join.le_supI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> plus_inv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="main">|</span><span class="free">x</span><span class="main">]</span> <span class="free">i</span> <span class="main">⟹</span> <span class="free">j</span> <span class="main">≤</span> <span class="main">|</span><span class="free">x</span><span class="main">]</span> <span class="free">j</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="free">j</span><span class="main">)</span> <span class="main">≤</span> <span class="main">|</span><span class="free">x</span><span class="main">]</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="free">j</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> ads_d_def dka.dsr5 fbox_simp fbox_subdist join.sup_mono order_trans<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mult_inv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">d</span> <span class="free">i</span> <span class="main">≤</span> <span class="main">|</span><span class="free">x</span><span class="main">]</span> <span class="free">i</span> <span class="main">⟹</span> <span class="keyword1">d</span> <span class="free">j</span> <span class="main">≤</span> <span class="main">|</span><span class="free">x</span><span class="main">]</span> <span class="free">j</span> <span class="main">⟹</span> <span class="main">(</span><span class="keyword1">d</span> <span class="free">i</span> <span class="main">⋅</span> <span class="keyword1">d</span> <span class="free">j</span><span class="main">)</span> <span class="main">≤</span> <span class="main">|</span><span class="free">x</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">d</span> <span class="free">i</span> <span class="main">⋅</span> <span class="keyword1">d</span> <span class="free">j</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> fbox_demodalisation3 fbox_frame fbox_simp <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="HS_VC_KA_rel">
<div class="head">
<h1>Theory HS_VC_KA_rel</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:       Verification components with relational MKA 
    Author:      Jonathan Julián Huerta y Munive, 2020
    Maintainer:  Jonathan Julián Huerta y Munive &lt;jonjulian23@gmail.com&gt;
*)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹ Relational model ›</span></span> <span class="comment1">(* by Victor Gomes, Georg Struth *)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ In this subsection, we follow Gomes and Struth~\cite{afp:vericomp} and show that relations 
form Kleene algebras.  ›</span></span>

<span class="keyword1"><span class="command">theory</span></span> HS_VC_KA_rel
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="../Kleene_Algebra/Kleene_Algebra.html">Kleene_Algebra.Kleene_Algebra</a>

<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">context</span></span> dioid_one_zero
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> power_inductl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">+</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">≤</span> <span class="free">y</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">x</span> <span class="main">^</span> <span class="free">n</span><span class="main">)</span> <span class="main">⋅</span> <span class="free">z</span> <span class="main">≤</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> mult.assoc mult_isol order_trans<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> power_inductr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">+</span> <span class="free">y</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">z</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">x</span> <span class="main">^</span> <span class="free">n</span><span class="main">)</span> <span class="main">≤</span> <span class="free">y</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"0.prems"</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">case</span></span> Suc
  <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">+</span> <span class="free">y</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">z</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">^</span> <span class="skolem">n</span> <span class="main">≤</span> <span class="free">y</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">+</span> <span class="free">y</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">y</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">^</span> <span class="skolem">n</span> <span class="main">≤</span> <span class="free">y</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">^</span> Suc <span class="skolem">n</span> <span class="main">=</span> <span class="free">z</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">^</span> <span class="skolem">n</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> mult.assoc power_Suc<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="free">z</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">^</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">⋅</span> <span class="free">x</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> mult.assoc power_commutes<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> <span class="free">y</span> <span class="main">⋅</span> <span class="free">x</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> calculation<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> mult_isor<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> <span class="free">y</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">z</span> <span class="main">+</span> <span class="free">y</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">y</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">^</span> Suc <span class="skolem">n</span> <span class="main">≤</span> <span class="free">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span><span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> rel_dioid<span class="main">:</span> dioid_one_zero <span class="quoted"><span class="quoted">"<span class="main">(∪)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">(O)</span>"</span></span> <span class="quoted">Id</span> <span class="quoted"><span class="quoted">"<span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(⊆)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(⊂)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> power_is_relpow<span class="main">:</span> <span class="quoted"><span class="quoted">"rel_dioid.power <span class="free">X</span> <span class="free">n</span> <span class="main">=</span> <span class="free">X</span> <span class="main">^^</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> rel_dioid.power_0 relpow.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Suc <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> rel_dioid.power_Suc2 relpow.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> rel_star_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X</span><span class="main">^*</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">n</span><span class="main">.</span> rel_dioid.power <span class="free">X</span> <span class="bound">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> power_is_relpow rtrancl_is_UN_relpow<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> rel_star_contl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="keyword1">O</span> <span class="free">Y</span><span class="main">^*</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">n</span><span class="main">.</span> <span class="free">X</span> <span class="keyword1">O</span> rel_dioid.power <span class="free">Y</span> <span class="bound">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> rel_star_def relcomp_UNION_distrib<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> rel_star_contr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X</span><span class="main">^*</span> <span class="keyword1">O</span> <span class="free">Y</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">n</span><span class="main">.</span> <span class="main">(</span>rel_dioid.power <span class="free">X</span> <span class="bound">n</span><span class="main">)</span> <span class="keyword1">O</span> <span class="free">Y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> rel_star_def relcomp_UNION_distrib2<span class="main">)</span>

<span class="keyword1"><span class="command">interpretation</span></span> rel_ka<span class="main">:</span> kleene_algebra <span class="quoted"><span class="quoted">"<span class="main">(∪)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">(O)</span>"</span></span> <span class="quoted">Id</span> <span class="quoted"><span class="quoted">"<span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(⊆)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(⊂)</span>"</span></span> <span class="quoted">rtrancl</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">z</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rel"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Id <span class="main">∪</span> <span class="skolem">x</span> <span class="keyword1">O</span> <span class="skolem">x</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">⊆</span> <span class="skolem">x</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> order_refl r_comp_rtrancl_eq rtrancl_unfold<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">z</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rel"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∪</span> <span class="skolem">x</span> <span class="keyword1">O</span> <span class="skolem">y</span> <span class="main">⊆</span> <span class="skolem">y</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="keyword1">O</span> <span class="skolem">z</span> <span class="main">⊆</span> <span class="skolem">y</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> rel_star_contr<span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">)</span></span> SUP_le_iff rel_dioid.power_inductl<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">z</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rel"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∪</span> <span class="skolem">y</span> <span class="keyword1">O</span> <span class="skolem">x</span> <span class="main">⊆</span> <span class="skolem">y</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="keyword1">O</span> <span class="skolem">x</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">⊆</span> <span class="skolem">y</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> rel_star_contl<span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">)</span></span> SUP_le_iff rel_dioid.power_inductr<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="HS_VC_MKA_rel">
<div class="head">
<h1>Theory HS_VC_MKA_rel</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:       Verification components with relational MKA 
    Author:      Jonathan Julián Huerta y Munive, 2020
    Maintainer:  Jonathan Julián Huerta y Munive &lt;jonjulian23@gmail.com&gt;
*)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Verification of hybrid programs›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ We show that relations form an antidomain Kleene algebra. This allows us to inherit 
the rules of the wlp calculus for regular programs. Finally, we derive three methods for 
verifying correctness specifications for the continuous dynamics of hybrid systems in this 
setting. ›</span></span>

<span class="keyword1"><span class="command">theory</span></span> HS_VC_MKA_rel
  <span class="keyword2"><span class="keyword">imports</span></span> 
    <span class="quoted">"<a href="HS_ODEs.html">../HS_ODEs</a>"</span> 
    <span class="quoted">"<a href="HS_VC_MKA.html">HS_VC_MKA</a>"</span>
    <span class="quoted">"<a href="HS_VC_KA_rel.html">../HS_VC_KA_rel</a>"</span>

<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">rel_ad</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rel <span class="main">⇒</span> <span class="tfree">'a</span> rel"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">rel_ad</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">x</span><span class="main">)</span> <span class="main">|</span> <span class="bound">x</span><span class="main">.</span> <span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> rel_aka<span class="main">:</span> antidomain_kleene_algebra <span class="quoted">rel_ad</span> <span class="quoted"><span class="quoted">"<span class="main">(∪)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">(O)</span>"</span></span> <span class="quoted">Id</span> <span class="quoted"><span class="quoted">"<span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(⊆)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(⊂)</span>"</span></span> <span class="quoted">rtrancl</span>
  <span class="keyword1"><span class="command">by</span></span>  <span class="operator">unfold_locales</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rel_ad_def<span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹ Regular programs›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ Lemmas for manipulation of predicates in the relational model ›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'a</span> pred <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span>

<span class="keyword1"><span class="command">no_notation</span></span> Archimedean_Field.ceiling <span class="main">(</span><span class="quoted">"<span class="keyword1">⌈</span>_<span class="keyword1">⌉</span>"</span><span class="main">)</span>
        <span class="keyword2"><span class="keyword">and</span></span> antidomain_semiringl.ads_d <span class="main">(</span><span class="quoted">"<span class="keyword1">d</span>"</span><span class="main">)</span>

<span class="keyword1"><span class="command">notation</span></span> Id <span class="main">(</span><span class="quoted">"<span class="keyword1">skip</span>"</span><span class="main">)</span>
     <span class="keyword2"><span class="keyword">and</span></span> relcomp <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">;</span>"</span> 70<span class="main">)</span>
     <span class="keyword2"><span class="keyword">and</span></span> zero_class.zero <span class="main">(</span><span class="quoted">"<span class="keyword1">0</span>"</span><span class="main">)</span>
     <span class="keyword2"><span class="keyword">and</span></span> rel_aka.fbox <span class="main">(</span><span class="quoted">"<span class="keyword1">wp</span>"</span><span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">p2r</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> pred <span class="main">⇒</span> <span class="tfree">'a</span> rel"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword3">(1</span><span class="keyword1">⌈</span>_<span class="keyword1">⌉</span><span class="keyword3">)</span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="main"><span class="free">⌈</span></span><span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main"><span class="free">⌉</span></span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="bound">s</span><span class="main">)</span> <span class="main">|</span><span class="bound">s</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">s</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> p2r_simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">≤</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">⟶</span> <span class="free">Q</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">=</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">=</span> <span class="free">Q</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">;</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span><span class="main">)</span> <span class="main">=</span> <span class="main">⌈</span><span class="main">λ</span> <span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">∧</span> <span class="free">Q</span> <span class="bound">s</span><span class="main">⌉</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">∪</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span><span class="main">)</span> <span class="main">=</span> <span class="main">⌈</span><span class="main">λ</span> <span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">∨</span> <span class="free">Q</span> <span class="bound">s</span><span class="main">⌉</span>"</span></span>
  <span class="quoted"><span class="quoted">"rel_ad <span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">=</span> <span class="main">⌈</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">¬</span> <span class="free">P</span> <span class="bound">s</span><span class="main">⌉</span>"</span></span>
  <span class="quoted"><span class="quoted">"rel_aka.ads_d <span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">=</span> <span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> p2r_def rel_ad_def rel_aka.ads_d_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> in_p2r <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">b</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">=</span> <span class="main">(</span><span class="free">P</span> <span class="free">a</span> <span class="main">∧</span> <span class="free">a</span> <span class="main">=</span> <span class="free">b</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> p2r_def<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ Lemmas for verification condition generation ›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> wp_rel<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">wp</span> <span class="free">R</span> <span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">=</span> <span class="main">⌈</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="main">⟶</span> <span class="free">P</span> <span class="bound">y</span><span class="main">⌉</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> rel_aka.fbox_def p2r_def rel_ad_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="comment1">― ‹ Tests ›</span>

<span class="keyword1"><span class="command">lemma</span></span> wp_test<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">wp</span> <span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span> <span class="main">=</span> <span class="main">⌈</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">⟶</span> <span class="free">Q</span> <span class="bound">s</span><span class="main">⌉</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> wp_rel<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> p2r_def<span class="main">)</span>

<span class="comment1">― ‹ Assignments ›</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">assign</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">^</span><span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">^</span><span class="tfree">'b</span><span class="main">)</span> rel"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword3">(2</span>_ <span class="keyword1">::=</span> _<span class="keyword3">)</span>"</span> <span class="main">[</span>70<span class="main">,</span> 65<span class="main">]</span> 61<span class="main">)</span> 
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main"><span class="free">::=</span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> vec_upd <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">|</span> <span class="bound">s</span><span class="main">.</span> True<span class="main">}</span>"</span></span> 

<span class="keyword1"><span class="command">lemma</span></span> wp_assign <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">wp</span> <span class="main">(</span><span class="free">x</span> <span class="main">::=</span> <span class="free">e</span><span class="main">)</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span> <span class="main">=</span> <span class="main">⌈</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">Q</span> <span class="main">(</span><span class="keyword1">χ</span> <span class="bound">j</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="main">($)</span> <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="main">(</span><span class="free">e</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="bound">j</span><span class="main">)</span><span class="main">⌉</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> wp_rel vec_upd_def assign_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fun_upd_def<span class="main">)</span>

<span class="comment1">― ‹ Nondeterministic assignments ›</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">nondet_assign</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">^</span><span class="tfree">'b</span><span class="main">)</span> rel"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword3">(2</span>_ <span class="keyword1">::=</span> <span class="keyword1">?</span> <span class="keyword3">)</span>"</span> <span class="main">[</span>70<span class="main">]</span> 61<span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main"><span class="free">::=</span></span> <span class="main"><span class="free">?</span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span>vec_upd <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="bound">k</span><span class="main">)</span><span class="main">|</span><span class="bound">s</span> <span class="bound">k</span><span class="main">.</span> True<span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> wp_nondet_assign<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">wp</span> <span class="main">(</span><span class="free">x</span> <span class="main">::=</span> <span class="main">?</span><span class="main">)</span> <span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">=</span> <span class="main">⌈</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="keyword1">χ</span> <span class="bound">j</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="main">($)</span> <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="bound">j</span><span class="main">)</span><span class="main">⌉</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> wp_rel nondet_assign_def vec_upd_eq <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">χ</span> <span class="bound">j</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">j</span> <span class="main">=</span> <span class="free">x</span> <span class="keyword1">then</span> <span class="improper">k</span> <span class="keyword1">else</span> <span class="improper">s</span> <span class="main">$</span> <span class="bound">j</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="comment1">― ‹ Nondeterministic choice ›</span>

<span class="keyword1"><span class="command">lemma</span></span> le_wp_choice_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">≤</span> <span class="keyword1">wp</span> <span class="main">(</span><span class="free">X</span> <span class="main">∪</span> <span class="free">Y</span><span class="main">)</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span> <span class="main">⟷</span> <span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">≤</span> <span class="keyword1">wp</span> <span class="free">X</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span> <span class="main">∧</span> <span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">≤</span> <span class="keyword1">wp</span> <span class="free">Y</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> rel_aka.le_fbox_choice_iff<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="comment1">― ‹ Conditional statement ›</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">cond_sugar</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> pred <span class="main">⇒</span> <span class="tfree">'a</span> rel <span class="main">⇒</span> <span class="tfree">'a</span> rel <span class="main">⇒</span> <span class="tfree">'a</span> rel"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">IF</span> _ <span class="keyword1">THEN</span> _ <span class="keyword1">ELSE</span> _"</span> <span class="main">[</span>64<span class="main">,</span>64<span class="main">]</span> 63<span class="main">)</span> 
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">IF</span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="keyword1"><span class="free">THEN</span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="keyword1"><span class="free">ELSE</span></span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span> <span class="main">≡</span> rel_aka.aka_cond <span class="main">⌈</span><span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">⌉</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span>"</span></span>

<span class="comment1">― ‹ Finite iteration ›</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">loopi_sugar</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rel <span class="main">⇒</span> <span class="tfree">'a</span> pred <span class="main">⇒</span> <span class="tfree">'a</span> rel"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">LOOP</span> _ <span class="keyword1">INV</span> _ "</span> <span class="main">[</span>64<span class="main">,</span>64<span class="main">]</span> 63<span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">LOOP</span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="keyword1"><span class="free">INV</span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">≡</span> rel_aka.aka_loopi <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">⌈</span><span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">⌉</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> change_loopI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">LOOP</span> <span class="free">X</span> <span class="keyword1">INV</span> <span class="free">G</span> <span class="main">=</span> <span class="keyword1">LOOP</span> <span class="free">X</span> <span class="keyword1">INV</span> <span class="free">I</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> rel_aka.aka_loopi_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> wp_loopI<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">≤</span> <span class="main">⌈</span><span class="free">I</span><span class="main">⌉</span> <span class="main">⟹</span> <span class="main">⌈</span><span class="free">I</span><span class="main">⌉</span> <span class="main">≤</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span> <span class="main">⟹</span> <span class="main">⌈</span><span class="free">I</span><span class="main">⌉</span> <span class="main">≤</span> <span class="keyword1">wp</span> <span class="free">R</span> <span class="main">⌈</span><span class="free">I</span><span class="main">⌉</span> <span class="main">⟹</span> <span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">≤</span> <span class="keyword1">wp</span> <span class="main">(</span><span class="keyword1">LOOP</span> <span class="free">R</span> <span class="keyword1">INV</span> <span class="free">I</span><span class="main">)</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> rel_aka.fbox_loopi<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> wp_loopI_break<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">≤</span> <span class="keyword1">wp</span> <span class="free">Y</span> <span class="main">⌈</span><span class="free">I</span><span class="main">⌉</span> <span class="main">⟹</span> <span class="main">⌈</span><span class="free">I</span><span class="main">⌉</span> <span class="main">≤</span> <span class="keyword1">wp</span> <span class="free">X</span> <span class="main">⌈</span><span class="free">I</span><span class="main">⌉</span> <span class="main">⟹</span> <span class="main">⌈</span><span class="free">I</span><span class="main">⌉</span> <span class="main">≤</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span>  <span class="main">⟹</span> <span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">≤</span> <span class="keyword1">wp</span> <span class="main">(</span><span class="free">Y</span> <span class="main">;</span> <span class="main">(</span><span class="keyword1">LOOP</span> <span class="free">X</span> <span class="keyword1">INV</span> <span class="free">I</span><span class="main">)</span><span class="main">)</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> rel_aka.fbox_loopi_break<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹ Evolution commands ›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Verification by providing evolution›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">g_evol</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>ord<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'b</span> pred <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'a</span> set<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'b</span> rel"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">EVOL</span>"</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">EVOL</span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span> <span class="main">|</span><span class="bound">s</span> <span class="bound">s'</span><span class="main">.</span> <span class="bound">s'</span> <span class="main">∈</span> g_orbit <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="bound">t</span> <span class="bound">s</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="bound">s</span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> wp_g_dyn<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>  
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">φ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>preorder<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">wp</span> <span class="main">(</span><span class="keyword1">EVOL</span> <span class="free">φ</span> <span class="free">G</span> <span class="free">U</span><span class="main">)</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span> <span class="main">=</span> <span class="main">⌈</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">t</span><span class="main">∈</span><span class="free">U</span> <span class="bound">s</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">τ</span><span class="main">∈</span>down <span class="main">(</span><span class="free">U</span> <span class="bound">s</span><span class="main">)</span> <span class="bound">t</span><span class="main">.</span> <span class="free">G</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">τ</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">Q</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">t</span> <span class="bound">s</span><span class="main">)</span><span class="main">⌉</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> wp_rel g_evol_def g_orbit_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Verification by providing solutions›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">g_ode</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>real <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>banach<span class="main">)</span><span class="main">⇒</span><span class="tfree">'a</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> pred <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> real set<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> set <span class="main">⇒</span> real <span class="main">⇒</span> 
  <span class="tfree">'a</span> rel"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword3">(1</span><span class="keyword1">x´=</span>_ <span class="keyword1">&amp;</span> _ <span class="keyword1">on</span> _ _ <span class="keyword1">@</span> _<span class="keyword3">)</span>"</span><span class="main">)</span> 
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1"><span class="free">x´=</span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main"><span class="free">&amp;</span></span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="keyword1"><span class="free">on</span></span> <span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main"><span class="free">@</span></span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span> <span class="main">|</span><span class="bound">s</span> <span class="bound">s'</span><span class="main">.</span> <span class="bound">s'</span> <span class="main">∈</span> g_orbital <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="bound">s</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> wp_g_orbital<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">wp</span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="free">f</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span> <span class="main">=</span> 
  <span class="main">⌈</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">X</span><span class="main">∈</span><span class="keyword1">Sols</span> <span class="free">f</span> <span class="free">U</span> <span class="free">S</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">t</span><span class="main">∈</span><span class="free">U</span> <span class="bound">s</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">τ</span><span class="main">∈</span>down <span class="main">(</span><span class="free">U</span> <span class="bound">s</span><span class="main">)</span> <span class="bound">t</span><span class="main">.</span> <span class="free">G</span> <span class="main">(</span><span class="bound">X</span> <span class="bound">τ</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">Q</span> <span class="main">(</span><span class="bound">X</span> <span class="bound">t</span><span class="main">)</span><span class="main">⌉</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> g_orbital_eq wp_rel ivp_sols_def g_ode_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">context</span></span> local_flow
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> wp_g_ode_subset<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">∈</span> <span class="free">U</span> <span class="bound">s</span> <span class="main">∧</span> is_interval <span class="main">(</span><span class="free">U</span> <span class="bound">s</span><span class="main">)</span> <span class="main">∧</span> <span class="free">U</span> <span class="bound">s</span> <span class="main">⊆</span> <span class="free">T</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">wp</span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">f</span><span class="main">)</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="main">0</span><span class="main">)</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span> <span class="main">=</span> 
  <span class="main">⌈</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">t</span><span class="main">∈</span><span class="main">(</span><span class="free">U</span> <span class="bound">s</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">τ</span><span class="main">∈</span>down <span class="main">(</span><span class="free">U</span> <span class="bound">s</span><span class="main">)</span> <span class="bound">t</span><span class="main">.</span> <span class="free">G</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">τ</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">Q</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">t</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">⌉</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">unfold</span> wp_g_orbital<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> iffI<span class="main"><span class="keyword3">;</span></span> <span class="operator">clarify</span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_ivp_sols assms<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">frule</span> ivp_solsD<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">frule</span> ivp_solsD<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">frule</span> ivp_solsD<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">τ</span><span class="main">∈</span>down <span class="main">(</span><span class="free">U</span> <span class="improper">s</span><span class="main">)</span> <span class="improper">t</span><span class="main">.</span> <span class="improper">X</span> <span class="bound">τ</span> <span class="main">=</span> <span class="free">φ</span> <span class="bound">τ</span> <span class="improper">s</span>"</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> ballI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ivp_unique_solution<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ _ _ _ _ in_ivp_sols<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> wp_g_ode<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">wp</span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">f</span><span class="main">)</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">T</span><span class="main">)</span> <span class="free">S</span> <span class="main">@</span> <span class="main">0</span><span class="main">)</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span> <span class="main">=</span> 
  <span class="main">⌈</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">t</span><span class="main">∈</span><span class="free">T</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">τ</span><span class="main">∈</span>down <span class="free">T</span> <span class="bound">t</span><span class="main">.</span> <span class="free">G</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">τ</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">Q</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">t</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">⌉</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> wp_g_ode_subset<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> init_time interval_time<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> wp_g_ode_ivl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">≥</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free">t</span> <span class="main">∈</span> <span class="free">T</span> <span class="main">⟹</span> <span class="keyword1">wp</span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">f</span><span class="main">)</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">t</span><span class="main">}</span><span class="main">)</span> <span class="free">S</span> <span class="main">@</span> <span class="main">0</span><span class="main">)</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span> <span class="main">=</span> 
  <span class="main">⌈</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">t</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">t</span><span class="main">}</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">τ</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="bound">t</span><span class="main">}</span><span class="main">.</span> <span class="free">G</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">τ</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">Q</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">t</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">⌉</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> wp_g_ode_subset<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subintervalI init_time real_Icc_closed_segment<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> closed_segment_eq_real_ivl<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> wp_orbit<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">wp</span> <span class="main">(</span><span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span> <span class="main">|</span> <span class="bound">s</span> <span class="bound">s'</span><span class="main">.</span> <span class="bound">s'</span> <span class="main">∈</span> <span class="keyword1">γ<span class="hidden">⇧</span><sup>φ</sup></span> <span class="bound">s</span><span class="main">}</span><span class="main">)</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span> <span class="main">=</span> <span class="main">⌈</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">t</span><span class="main">∈</span><span class="free">T</span><span class="main">.</span> <span class="free">Q</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">t</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">⌉</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> orbit_def wp_g_ode g_ode_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ Verification with differential invariants ›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">g_ode_inv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>real <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>banach<span class="main">)</span><span class="main">⇒</span><span class="tfree">'a</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> pred <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> real set<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> set <span class="main">⇒</span> 
  real <span class="main">⇒</span> <span class="tfree">'a</span> pred <span class="main">⇒</span> <span class="tfree">'a</span> rel"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword3">(1</span><span class="keyword1">x´=</span>_ <span class="keyword1">&amp;</span> _ <span class="keyword1">on</span> _ _ <span class="keyword1">@</span> _ <span class="keyword1">DINV</span> _ <span class="keyword3">)</span>"</span><span class="main">)</span> 
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1"><span class="free">x´=</span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main"><span class="free">&amp;</span></span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="keyword1"><span class="free">on</span></span> <span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main"><span class="free">@</span></span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="keyword1"><span class="free">DINV</span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">&amp;</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="keyword1">on</span> <span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">@</span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> wp_g_orbital_guard<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">H</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">G</span> <span class="bound">s</span> <span class="main">∧</span> <span class="free">Q</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">wp</span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="free">f</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span> <span class="main">=</span> <span class="keyword1">wp</span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="free">f</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">⌈</span><span class="free">H</span><span class="main">⌉</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> wp_g_orbital <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> wp_g_orbital_inv<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">≤</span> <span class="main">⌈</span><span class="free">I</span><span class="main">⌉</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⌈</span><span class="free">I</span><span class="main">⌉</span> <span class="main">≤</span> <span class="keyword1">wp</span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="free">f</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">⌈</span><span class="free">I</span><span class="main">⌉</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⌈</span><span class="free">I</span><span class="main">⌉</span> <span class="main">≤</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">≤</span> <span class="keyword1">wp</span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="free">f</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> order.trans<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> order.trans<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> rel_aka.fbox_iso<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> wp_diff_inv<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⌈</span><span class="free">I</span><span class="main">⌉</span> <span class="main">≤</span> <span class="keyword1">wp</span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="free">f</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">⌈</span><span class="free">I</span><span class="main">⌉</span><span class="main">)</span> <span class="main">=</span> diff_invariant <span class="free">I</span> <span class="free">f</span> <span class="free">U</span> <span class="free">S</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">G</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> diff_invariant_eq wp_g_orbital <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> p2r_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> diff_inv_guard_ignore<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⌈</span><span class="free">I</span><span class="main">⌉</span> <span class="main">≤</span> <span class="keyword1">wp</span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="free">f</span> <span class="main">&amp;</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> True<span class="main">)</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">⌈</span><span class="free">I</span><span class="main">⌉</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⌈</span><span class="free">I</span><span class="main">⌉</span> <span class="main">≤</span> <span class="keyword1">wp</span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="free">f</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">⌈</span><span class="free">I</span><span class="main">⌉</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> wp_diff_inv diff_invariant_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">context</span></span> local_flow
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> wp_diff_inv_eq<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">∈</span> <span class="free">U</span> <span class="bound">s</span> <span class="main">∧</span> is_interval <span class="main">(</span><span class="free">U</span> <span class="bound">s</span><span class="main">)</span> <span class="main">∧</span> <span class="free">U</span> <span class="bound">s</span> <span class="main">⊆</span> <span class="free">T</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"diff_invariant <span class="free">I</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">f</span><span class="main">)</span> <span class="free">U</span> <span class="free">S</span> <span class="main">0</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> True<span class="main">)</span> <span class="main">=</span> 
  <span class="main">(</span><span class="main">⌈</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟶</span> <span class="free">I</span> <span class="bound">s</span><span class="main">⌉</span> <span class="main">=</span> <span class="keyword1">wp</span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">f</span><span class="main">)</span> <span class="main">&amp;</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> True<span class="main">)</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="main">0</span><span class="main">)</span> <span class="main">⌈</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟶</span> <span class="free">I</span> <span class="bound">s</span><span class="main">⌉</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> wp_diff_inv<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> wp_g_ode_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="main">0</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> ballE<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> init_time in_domain ivp<span class="main">(</span>2<span class="main">)</span> assms <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">force</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">s</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">t</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> ballE<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> in_domain ivp<span class="main">(</span>2<span class="main">)</span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> diff_inv_eq_inv_set<span class="main">:</span>
  <span class="quoted"><span class="quoted">"diff_invariant <span class="free">I</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">f</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">T</span><span class="main">)</span> <span class="free">S</span> <span class="main">0</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> True<span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">s</span><span class="main">.</span> <span class="free">I</span> <span class="bound">s</span> <span class="main">⟶</span> <span class="keyword1">γ<span class="hidden">⇧</span><sup>φ</sup></span> <span class="bound">s</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="free">I</span> <span class="bound">s</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> diff_inv_eq_inv_set orbit_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> p2r_def<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemma</span></span> wp_g_odei<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">≤</span> <span class="main">⌈</span><span class="free">I</span><span class="main">⌉</span> <span class="main">⟹</span> <span class="main">⌈</span><span class="free">I</span><span class="main">⌉</span> <span class="main">≤</span> <span class="keyword1">wp</span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="free">f</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">⌈</span><span class="free">I</span><span class="main">⌉</span> <span class="main">⟹</span> <span class="main">⌈</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">I</span> <span class="bound">s</span> <span class="main">∧</span> <span class="free">G</span> <span class="bound">s</span><span class="main">⌉</span> <span class="main">≤</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span> <span class="main">⟹</span> 
  <span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">≤</span> <span class="keyword1">wp</span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="free">f</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="keyword1">DINV</span> <span class="free">I</span><span class="main">)</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> g_ode_inv_def 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> b<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="keyword1">wp</span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="free">f</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">⌈</span><span class="free">I</span><span class="main">⌉</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> order.trans<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> I<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">I</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> wp_g_orbital_inv<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> wp_g_orbital_guard<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> rel_aka.fbox_iso<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹ Derivation of the rules of dL ›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ We derive rules of differential dynamic logic (dL). This allows the components to reason 
in the style of that logic. ›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">g_dl_ode</span> <span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>banach<span class="main">)</span><span class="main">⇒</span><span class="tfree">'a</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> pred <span class="main">⇒</span> <span class="tfree">'a</span> rel"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword3">(1</span><span class="keyword1">x´=</span>_ <span class="keyword1">&amp;</span> _<span class="keyword3">)</span>"</span><span class="main">)</span> 
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1"><span class="free">x´=</span></span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main"><span class="free">&amp;</span></span> <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span> <span class="main">≡</span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="main">&amp;</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="keyword1">on</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">{</span><span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">≥</span> <span class="main">0</span><span class="main">}</span><span class="main">)</span> UNIV <span class="main">@</span> <span class="main">0</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">g_dl_ode_inv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>banach<span class="main">)</span><span class="main">⇒</span><span class="tfree">'a</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> pred <span class="main">⇒</span> <span class="tfree">'a</span> pred <span class="main">⇒</span> <span class="tfree">'a</span> rel"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword3">(1</span><span class="keyword1">x´=</span>_ <span class="keyword1">&amp;</span> _ <span class="keyword1">DINV</span> _<span class="keyword3">)</span>"</span><span class="main">)</span> 
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1"><span class="free">x´=</span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main"><span class="free">&amp;</span></span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="keyword1"><span class="free">DINV</span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">)</span> <span class="main">≡</span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="main">&amp;</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="keyword1">on</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">{</span><span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">≥</span> <span class="main">0</span><span class="main">}</span><span class="main">)</span> UNIV <span class="main">@</span> <span class="main">0</span> <span class="keyword1">DINV</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> diff_solve_axiom1<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"local_flow <span class="free">f</span> UNIV UNIV <span class="free">φ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">wp</span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="free">f</span> <span class="main">&amp;</span> <span class="free">G</span><span class="main">)</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span> <span class="main">=</span> 
  <span class="main">⌈</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound"><span class="bound">t</span></span><span class="main">≥</span><span class="main">0</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">τ</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="bound">t</span><span class="main">}</span><span class="main">.</span> <span class="free">G</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">τ</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">Q</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">t</span> <span class="bound">s</span><span class="main">)</span><span class="main">⌉</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> local_flow.wp_g_ode_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> diff_solve_axiom2<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">c</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>heine_borel<span class="main">,</span> banach<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">wp</span> <span class="main">(</span><span class="keyword1">x´=</span><span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">c</span><span class="main">)</span> <span class="main">&amp;</span> <span class="free">G</span><span class="main">)</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span> <span class="main">=</span> 
  <span class="main">⌈</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound"><span class="bound">t</span></span><span class="main">≥</span><span class="main">0</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">τ</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="bound">t</span><span class="main">}</span><span class="main">.</span> <span class="free">G</span> <span class="main">(</span><span class="bound">s</span> <span class="main">+</span> <span class="bound">τ</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">c</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">Q</span> <span class="main">(</span><span class="bound">s</span> <span class="main">+</span> <span class="bound">t</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">c</span><span class="main">)</span><span class="main">⌉</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> local_flow.wp_g_ode_subset<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> φ<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="main"><span class="main">λ</span></span><span class="bound"><span class="bound">t</span></span> <span class="bound"><span class="bound">s</span></span><span class="main"><span class="main">.</span></span> <span class="bound"><span class="bound">s</span></span> <span class="main"><span class="main">+</span></span> <span class="bound"><span class="bound">t</span></span> <span class="keyword1"><span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span></span> <span class="free"><span class="free">c</span></span><span class="main"><span class="main">)</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> T<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">UNIV</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> line_is_local_flow<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> diff_solve_rule<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"local_flow <span class="free">f</span> UNIV UNIV <span class="free">φ</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">t</span></span><span class="main">≥</span><span class="main">0</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">τ</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="bound">t</span><span class="main">}</span><span class="main">.</span> <span class="free">G</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">τ</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">Q</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">t</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">≤</span> <span class="keyword1">wp</span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="free">f</span> <span class="main">&amp;</span> <span class="free">G</span><span class="main">)</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> local_flow.wp_g_ode_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> diff_weak_axiom1<span class="main">:</span> <span class="quoted"><span class="quoted">"Id <span class="main">⊆</span> <span class="keyword1">wp</span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="free">f</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">⌈</span><span class="free">G</span><span class="main">⌉</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> wp_rel g_ode_def g_orbital_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> diff_weak_axiom2<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="keyword1">wp</span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="free">f</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="free">T</span> <span class="free">S</span> <span class="main">@</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span> <span class="main">=</span> <span class="keyword1">wp</span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="free">f</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="free">T</span> <span class="free">S</span> <span class="main">@</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">⌈</span><span class="main">λ</span> <span class="bound">s</span><span class="main">.</span> <span class="free">G</span> <span class="bound">s</span> <span class="main">⟶</span> <span class="free">Q</span> <span class="bound">s</span><span class="main">⌉</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> wp_g_orbital image_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1"><span class="command">lemma</span></span> diff_weak_rule<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⌈</span><span class="free">G</span><span class="main">⌉</span> <span class="main">≤</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">≤</span> <span class="keyword1">wp</span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="free">f</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wp_g_orbital<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> wp_g_evol_IdD<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">wp</span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="free">f</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">⌈</span><span class="free">C</span><span class="main">⌉</span> <span class="main">=</span> Id"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">τ</span><span class="main">∈</span><span class="main">(</span>down <span class="main">(</span><span class="free">U</span> <span class="free">s</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="free">x</span> <span class="bound">τ</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="free">f</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">τ</span><span class="main">∈</span><span class="main">(</span>down <span class="main">(</span><span class="free">U</span> <span class="free">s</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span><span class="main">.</span> <span class="free">C</span> <span class="main">(</span><span class="free">x</span> <span class="bound">τ</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">τ</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">τ</span> <span class="main">∈</span> <span class="main">(</span>down <span class="main">(</span><span class="free">U</span> <span class="free">s</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="skolem">τ</span> <span class="main">∈</span> g_orbital <span class="free">f</span> <span class="free">G</span> <span class="free">U</span> <span class="free">S</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">s</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> g_ode_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> <span class="main">(</span>g_orbital <span class="free">f</span> <span class="free">G</span> <span class="free">U</span> <span class="free">S</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">s</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">C</span> <span class="bound">y</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> wp_rel g_ode_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> p2r_def<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">(</span><span class="free">x</span> <span class="skolem">τ</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> diff_cut_axiom<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">wp</span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="free">f</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">⌈</span><span class="free">C</span><span class="main">⌉</span> <span class="main">=</span> Id"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">wp</span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="free">f</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span> <span class="main">=</span> <span class="keyword1">wp</span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="free">f</span> <span class="main">&amp;</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">G</span> <span class="bound">s</span> <span class="main">∧</span> <span class="free">C</span> <span class="bound">s</span><span class="main">)</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule_tac</span> f<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="keyword1">wp</span> <span class="bound">x</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> HOL.arg_cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> subset_antisym<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">x´=</span><span class="free">f</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">⊆</span> <span class="main">(</span><span class="keyword1">x´=</span><span class="free">f</span> <span class="main">&amp;</span> <span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">G</span> <span class="bound">s</span> <span class="main">∧</span> <span class="free">C</span> <span class="bound">s</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> g_ode_def<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">s'</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s'</span> <span class="main">∈</span> g_orbital <span class="free">f</span> <span class="free">G</span> <span class="free">U</span> <span class="free">S</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">τ</span></span><span class="main">::</span><span class="quoted">real</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem"><span class="skolem">X</span></span> <span class="keyword2"><span class="keyword">where</span></span> x_ivp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> <span class="keyword1">Sols</span> <span class="free">f</span> <span class="free">U</span> <span class="free">S</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">s</span>"</span></span> 
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="skolem">τ</span> <span class="main">=</span> <span class="skolem">s'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">τ</span> <span class="main">∈</span> <span class="free">U</span> <span class="skolem">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> guard_x<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">𝒫</span> <span class="skolem">X</span> <span class="main">(</span>down <span class="main">(</span><span class="free">U</span> <span class="skolem">s</span><span class="main">)</span> <span class="skolem">τ</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="free">G</span> <span class="bound">s</span><span class="main">}</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> g_orbitalD<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">s'</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span>"</span></span> <span class="quoted"><span class="free">G</span></span> <span class="main">_</span> <span class="quoted"><span class="free">S</span></span> <span class="quoted"><span class="free">t<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="quoted"><span class="skolem">s</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t</span><span class="main">∈</span><span class="main">(</span>down <span class="main">(</span><span class="free">U</span> <span class="skolem">s</span><span class="main">)</span> <span class="skolem">τ</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">𝒫</span> <span class="skolem">X</span> <span class="main">(</span>down <span class="main">(</span><span class="free">U</span> <span class="skolem">s</span><span class="main">)</span> <span class="bound">t</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="free">G</span> <span class="bound">s</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> guard_x <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> image_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t</span><span class="main">∈</span><span class="main">(</span>down <span class="main">(</span><span class="free">U</span> <span class="skolem">s</span><span class="main">)</span> <span class="skolem">τ</span><span class="main">)</span><span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> <span class="free">U</span> <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">τ</span> <span class="main">∈</span> <span class="free">U</span> <span class="skolem">s</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t</span><span class="main">∈</span><span class="main">(</span>down <span class="main">(</span><span class="free">U</span> <span class="skolem">s</span><span class="main">)</span> <span class="skolem">τ</span><span class="main">)</span><span class="main">.</span> <span class="skolem">X</span> <span class="bound">t</span> <span class="main">∈</span> g_orbital <span class="free">f</span> <span class="free">G</span> <span class="free">U</span> <span class="free">S</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> g_orbitalI<span class="main">[</span><span class="operator">OF</span> x_ivp<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t</span><span class="main">∈</span><span class="main">(</span>down <span class="main">(</span><span class="free">U</span> <span class="skolem">s</span><span class="main">)</span> <span class="skolem">τ</span><span class="main">)</span><span class="main">.</span> <span class="free">C</span> <span class="main">(</span><span class="skolem">X</span> <span class="bound">t</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> wp_g_evol_IdD<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> g_ode_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s'</span> <span class="main">∈</span> g_orbital <span class="free">f</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">G</span> <span class="bound">s</span> <span class="main">∧</span> <span class="free">C</span> <span class="bound">s</span><span class="main">)</span> <span class="free">U</span> <span class="free">S</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> g_orbitalI<span class="main">[</span><span class="operator">OF</span> x_ivp <span class="quoted"><span class="quoted">‹<span class="skolem">τ</span> <span class="main">∈</span> <span class="free">U</span> <span class="skolem">s</span>›</span></span><span class="main">]</span> guard_x <span class="quoted"><span class="quoted">‹<span class="skolem">X</span> <span class="skolem">τ</span> <span class="main">=</span> <span class="skolem">s'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">x´=</span><span class="free">f</span> <span class="main">&amp;</span> <span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">G</span> <span class="bound">s</span> <span class="main">∧</span> <span class="free">C</span> <span class="bound">s</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">⊆</span> <span class="main">(</span><span class="keyword1">x´=</span><span class="free">f</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span>"</span></span>  
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> g_orbital_eq g_ode_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> diff_cut_rule<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> wp_C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">≤</span> <span class="keyword1">wp</span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="free">f</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">⌈</span><span class="free">C</span><span class="main">⌉</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> wp_Q<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">≤</span> <span class="keyword1">wp</span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="free">f</span> <span class="main">&amp;</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">G</span> <span class="bound">s</span> <span class="main">∧</span> <span class="free">C</span> <span class="bound">s</span><span class="main">)</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">≤</span> <span class="keyword1">wp</span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="free">f</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">subst</span> wp_rel<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> g_orbital_eq p2r_def g_ode_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span><span class="main">::</span><span class="quoted">real</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">X</span><span class="main">::</span><span class="quoted"><span class="quoted">"real <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">s</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> <span class="free">U</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> x_ivp<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> <span class="keyword1">Sols</span> <span class="free">f</span> <span class="free">U</span> <span class="free">S</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">s</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> guard_x<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">U</span> <span class="skolem">s</span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">≤</span> <span class="skolem">t</span> <span class="main">⟶</span> <span class="free">G</span> <span class="main">(</span><span class="skolem">X</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t</span><span class="main">∈</span><span class="main">(</span>down <span class="main">(</span><span class="free">U</span> <span class="skolem">s</span><span class="main">)</span> <span class="skolem">t</span><span class="main">)</span><span class="main">.</span> <span class="skolem">X</span> <span class="bound">t</span> <span class="main">∈</span> g_orbital <span class="free">f</span> <span class="free">G</span> <span class="free">U</span> <span class="free">S</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> g_orbitalI<span class="main">[</span><span class="operator">OF</span> x_ivp<span class="main">]</span> guard_x <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t</span><span class="main">∈</span><span class="main">(</span>down <span class="main">(</span><span class="free">U</span> <span class="skolem">s</span><span class="main">)</span> <span class="skolem">t</span><span class="main">)</span><span class="main">.</span> <span class="free">C</span> <span class="main">(</span><span class="skolem">X</span> <span class="bound">t</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> wp_C <span class="quoted"><span class="quoted">‹<span class="free">P</span> <span class="skolem">s</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> wp_rel<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> g_ode_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="skolem">t</span> <span class="main">∈</span> g_orbital <span class="free">f</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">G</span> <span class="bound">s</span> <span class="main">∧</span> <span class="free">C</span> <span class="bound">s</span><span class="main">)</span> <span class="free">U</span> <span class="free">S</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> guard_x <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="main">∈</span> <span class="free">U</span> <span class="skolem">s</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> g_orbitalI x_ivp<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="main">(</span><span class="skolem">X</span> <span class="skolem">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">P</span> <span class="skolem">s</span>›</span></span> wp_Q <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> wp_rel<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> g_ode_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> diff_inv_axiom1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">G</span> <span class="free">s</span> <span class="main">⟶</span> <span class="free">I</span> <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"diff_invariant <span class="free">I</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">f</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">{</span><span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">≥</span> <span class="main">0</span><span class="main">}</span><span class="main">)</span> UNIV <span class="main">0</span> <span class="free">G</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">s</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1">wp</span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="free">f</span> <span class="main">&amp;</span> <span class="free">G</span><span class="main">)</span> <span class="main">⌈</span><span class="free">I</span><span class="main">⌉</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> wp_g_orbital diff_invariant_eq <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">s</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main"><span class="keyword3">,</span></span> <span class="operator">frule</span> ivp_solsD<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> diff_inv_axiom2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"picard_lindeloef <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">f</span><span class="main">)</span> UNIV UNIV <span class="main">0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="main">{</span><span class="bound">t</span><span class="main">::</span>real<span class="main">.</span> <span class="bound">t</span> <span class="main">≥</span> <span class="main">0</span><span class="main">}</span> <span class="main">⊆</span> picard_lindeloef.ex_ivl <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">f</span><span class="main">)</span> UNIV UNIV <span class="main">0</span> <span class="bound">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"diff_invariant <span class="free">I</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">f</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">{</span><span class="bound">t</span><span class="main">::</span>real<span class="main">.</span> <span class="bound">t</span> <span class="main">≥</span> <span class="main">0</span><span class="main">}</span><span class="main">)</span> UNIV <span class="main">0</span> <span class="free">G</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">wp</span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="free">f</span> <span class="main">&amp;</span> <span class="free">G</span><span class="main">)</span> <span class="main">⌈</span><span class="free">I</span><span class="main">⌉</span> <span class="main">=</span> <span class="keyword1">wp</span> <span class="main">⌈</span><span class="free">G</span><span class="main">⌉</span> <span class="main">⌈</span><span class="free">I</span><span class="main">⌉</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">unfold</span> wp_g_orbital<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> wp_rel<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fun_eq_iff<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="quoted"><span class="quoted">"<span class="var">?ex_ivl</span> <span class="skolem">s</span>"</span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"picard_lindeloef.ex_ivl <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">f</span><span class="main">)</span> UNIV UNIV <span class="main">0</span> <span class="skolem">s</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="skolem">s</span>"</span></span> <span class="main">=</span> 
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">X</span><span class="main">∈</span><span class="keyword1">Sols</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">f</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">{</span><span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">≥</span> <span class="main">0</span><span class="main">}</span><span class="main">)</span> UNIV <span class="main">0</span> <span class="skolem">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound"><span class="bound">t</span></span><span class="main">≥</span><span class="main">0</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">τ</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="bound">τ</span> <span class="main">∧</span> <span class="bound">τ</span> <span class="main">≤</span> <span class="bound">t</span> <span class="main">⟶</span> <span class="free">G</span> <span class="main">(</span><span class="bound">X</span> <span class="bound">τ</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">I</span> <span class="main">(</span><span class="bound">X</span> <span class="bound">t</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">X</span></span> <span class="keyword2"><span class="keyword">where</span></span> xivp1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> <span class="keyword1">Sols</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">f</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="var">?ex_ivl</span> <span class="bound">s</span><span class="main">)</span> UNIV <span class="main">0</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> picard_lindeloef.flow_in_ivp_sols_ex_ivl<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> xivp2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> <span class="keyword1">Sols</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">f</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> Collect <span class="main">(</span><span class="main">(≤)</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> UNIV <span class="main">0</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> in_ivp_sols_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ _ xivp1<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> shyp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">0</span> <span class="main">=</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ivp_solsD <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> dinv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s</span><span class="main">.</span> <span class="free">I</span> <span class="bound">s</span> <span class="main">⟶</span> <span class="var">?lhs</span> <span class="bound">s</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> diff_invariant_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="skolem">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">G</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">X</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> ballE<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="main">0</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> shyp xivp2<span class="main">)</span><span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="skolem">s</span> <span class="main">⟶</span> <span class="main">(</span><span class="free">G</span> <span class="skolem">s</span> <span class="main">⟶</span> <span class="free">I</span> <span class="skolem">s</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">G</span> <span class="skolem">s</span> <span class="main">⟶</span> <span class="free">I</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarify</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">τ</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="bound">τ</span> <span class="main">∧</span> <span class="bound">τ</span> <span class="main">≤</span> <span class="improper">t</span> <span class="main">⟶</span> <span class="free">G</span> <span class="main">(</span><span class="improper">X</span> <span class="bound">τ</span><span class="main">)</span>"</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="main">0</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main"><span class="keyword3">,</span></span> <span class="operator">frule</span> ivp_solsD<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> dinv <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span><span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="skolem">s</span> <span class="main">=</span> <span class="main">(</span><span class="free">G</span> <span class="skolem">s</span> <span class="main">⟶</span> <span class="free">I</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> diff_inv_rule<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">≤</span> <span class="main">⌈</span><span class="free">I</span><span class="main">⌉</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"diff_invariant <span class="free">I</span> <span class="free">f</span> <span class="free">U</span> <span class="free">S</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">G</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⌈</span><span class="free">I</span><span class="main">⌉</span> <span class="main">≤</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">≤</span> <span class="keyword1">wp</span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="free">f</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> wp_g_orbital_inv<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> _ assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> wp_diff_inv <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="HS_VC_MKA_Examples_rel">
<div class="head">
<h1>Theory HS_VC_MKA_Examples_rel</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:       Examples of hybrid systems verifications
    Author:      Jonathan Julián Huerta y Munive, 2020
    Maintainer:  Jonathan Julián Huerta y Munive &lt;jonjulian23@gmail.com&gt;
*)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹ Examples ›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ We prove partial correctness specifications of some hybrid systems with our
recently described verification components.›</span></span>

<span class="keyword1"><span class="command">theory</span></span> HS_VC_MKA_Examples_rel
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="HS_VC_MKA_rel.html">HS_VC_MKA_rel</a>

<span class="keyword2"><span class="keyword">begin</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹Pendulum›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ The ODEs <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"x' t = y t"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and {text "y' t = - x t"} describe the circular motion of
a mass attached to a string looked from above. We use <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"s$1"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> to represent the x-coordinate
and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"s$2"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> for the y-coordinate. We prove that this motion remains circular. ›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">fpend</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real<span class="main">^</span><span class="numeral">2</span> <span class="main">⇒</span> real<span class="main">^</span><span class="numeral">2</span>"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">f</span>"</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">f</span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="keyword1">χ</span> <span class="bound">i</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">i</span> <span class="main">=</span> <span class="main">1</span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="numeral">2</span> <span class="keyword1">else</span> <span class="main">-</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="main">1</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">pend_flow</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real <span class="main">⇒</span> real<span class="main">^</span><span class="numeral">2</span> <span class="main">⇒</span> real<span class="main">^</span><span class="numeral">2</span>"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">φ</span>"</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">φ</span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="keyword1">χ</span> <span class="bound">i</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">i</span> <span class="main">=</span> <span class="main">1</span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="main">1</span> <span class="main">*</span> cos <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="numeral">2</span> <span class="main">*</span> sin <span class="free"><span class="bound"><span class="entity">t</span></span></span>
  <span class="keyword1">else</span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="main">1</span> <span class="main">*</span> sin <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="numeral">2</span> <span class="main">*</span> cos <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>

<span class="comment1">― ‹Verified by providing dynamics. ›</span>

<span class="keyword1"><span class="command">lemma</span></span> pendulum_dyn<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⌈</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">=</span> <span class="main">(</span><span class="bound">s</span><span class="main">$</span><span class="main">1</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">+</span> <span class="main">(</span><span class="bound">s</span><span class="main">$</span><span class="numeral">2</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">⌉</span> <span class="main">≤</span> <span class="keyword1">wp</span> <span class="main">(</span><span class="keyword1">EVOL</span> <span class="keyword1">φ</span> <span class="free">G</span> <span class="free">T</span><span class="main">)</span> <span class="main">⌈</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">=</span> <span class="main">(</span><span class="bound">s</span><span class="main">$</span><span class="main">1</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">+</span> <span class="main">(</span><span class="bound">s</span><span class="main">$</span><span class="numeral">2</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">⌉</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="comment1">― ‹Verified with differential invariants. ›</span>

<span class="keyword1"><span class="command">lemma</span></span> pendulum_inv<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⌈</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">=</span> <span class="main">(</span><span class="bound">s</span><span class="main">$</span><span class="main">1</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">+</span> <span class="main">(</span><span class="bound">s</span><span class="main">$</span><span class="numeral">2</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">⌉</span> <span class="main">≤</span> <span class="keyword1">wp</span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="keyword1">f</span> <span class="main">&amp;</span> <span class="free">G</span><span class="main">)</span> <span class="main">⌈</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">=</span> <span class="main">(</span><span class="bound">s</span><span class="main">$</span><span class="main">1</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">+</span> <span class="main">(</span><span class="bound">s</span><span class="main">$</span><span class="numeral">2</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">⌉</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">poly_derivatives</span></span> <span class="dynamic"><span class="dynamic">diff_invariant_rules</span></span><span class="main">)</span>

<span class="comment1">― ‹Verified with the flow. ›</span>

<span class="keyword1"><span class="command">lemma</span></span> local_flow_pend<span class="main">:</span> <span class="quoted"><span class="quoted">"local_flow <span class="keyword1">f</span> UNIV UNIV <span class="keyword1">φ</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> local_lipschitz_def lipschitz_on_def vec_eq_iff<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="main">1</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dist_norm norm_vec_def L2_set_def power2_commute UNIV_2<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> forall_2 <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">poly_derivatives</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> pendulum_flow<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⌈</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">=</span> <span class="main">(</span><span class="bound">s</span><span class="main">$</span><span class="main">1</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">+</span> <span class="main">(</span><span class="bound">s</span><span class="main">$</span><span class="numeral">2</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">⌉</span> <span class="main">≤</span> <span class="keyword1">wp</span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="keyword1">f</span> <span class="main">&amp;</span> <span class="free">G</span><span class="main">)</span> <span class="main">⌈</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">=</span> <span class="main">(</span><span class="bound">s</span><span class="main">$</span><span class="main">1</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">+</span> <span class="main">(</span><span class="bound">s</span><span class="main">$</span><span class="numeral">2</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">⌉</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> local_flow.wp_g_ode_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> local_flow_pend<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">no_notation</span></span> fpend <span class="main">(</span><span class="quoted">"<span class="keyword1">f</span>"</span><span class="main">)</span>
        <span class="keyword2"><span class="keyword">and</span></span> pend_flow <span class="main">(</span><span class="quoted">"<span class="keyword1">φ</span>"</span><span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹ Bouncing Ball ›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ A ball is dropped from rest at an initial height <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"h"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. The motion is described with
the free-fall equations <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"x' t = v t"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"v' t = g"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> where <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"g"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is the
constant acceleration due to gravity. The bounce is modelled with a variable assignment that
flips the velocity. That is, we model it as a completely elastic collision with the ground. We use 
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"s$1"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> to represent the ball's height and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"s$2"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> for its velocity. We prove that the 
ball remains above ground and below its initial resting position. ›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">fball</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real <span class="main">⇒</span> real<span class="main">^</span><span class="numeral">2</span> <span class="main">⇒</span> real<span class="main">^</span><span class="numeral">2</span>"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">f</span>"</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">f</span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="keyword1">χ</span> <span class="bound">i</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">i</span> <span class="main">=</span> <span class="main">1</span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="numeral">2</span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">ball_flow</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real <span class="main">⇒</span> real <span class="main">⇒</span> real<span class="main">^</span><span class="numeral">2</span> <span class="main">⇒</span> real<span class="main">^</span><span class="numeral">2</span>"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">φ</span>"</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">φ</span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="keyword1">χ</span> <span class="bound">i</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">i</span> <span class="main">=</span> <span class="main">1</span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">*</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">^</span> <span class="numeral">2</span><span class="main">/</span><span class="numeral">2</span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="numeral">2</span> <span class="main">*</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="main">1</span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">*</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="numeral">2</span><span class="main">)</span>"</span></span>

<span class="comment1">― ‹Verified with differential invariants. ›</span>

<span class="keyword1"><span class="command">named_theorems</span></span> bb_real_arith <span class="quoted">"real arithmetic properties for the bouncing ball."</span>

<span class="keyword1"><span class="command">lemma</span></span> inv_imp_pos_le<span class="main">[</span><span class="operator">bb_real_arith</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&gt;</span> <span class="free">g</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">*</span> <span class="free">g</span> <span class="main">*</span> <span class="free">x</span> <span class="main">-</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">g</span> <span class="main">*</span> <span class="free">h</span> <span class="main">=</span> <span class="free">v</span> <span class="main">*</span> <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">::</span>real<span class="main">)</span> <span class="main">≤</span> <span class="free">h</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">*</span> <span class="free">v</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">g</span> <span class="main">*</span> <span class="free">x</span> <span class="main">-</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">g</span> <span class="main">*</span> <span class="free">h</span> <span class="main">∧</span> <span class="main">0</span> <span class="main">&gt;</span> <span class="free">g</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> inv <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&gt;</span> <span class="free">g</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> obs<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">*</span> <span class="free">v</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">g</span> <span class="main">*</span> <span class="main">(</span><span class="free">x</span> <span class="main">-</span> <span class="free">h</span><span class="main">)</span> <span class="main">∧</span> <span class="main">0</span> <span class="main">&gt;</span> <span class="free">g</span> <span class="main">∧</span> <span class="free">v</span> <span class="main">*</span> <span class="free">v</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> left_diff_distrib mult.commute <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> zero_le_square<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">v</span> <span class="main">*</span> <span class="free">v</span><span class="main">)</span><span class="main">/</span><span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">g</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span> <span class="main">-</span> <span class="free">h</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> obs <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">v</span> <span class="main">*</span> <span class="free">v</span><span class="main">)</span><span class="main">/</span><span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">g</span><span class="main">)</span> <span class="main">≤</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> divide_nonneg_neg <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">-</span> <span class="free">x</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> bouncing_ball_inv<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">h</span><span class="main">::</span><span class="quoted">real</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free">h</span> <span class="main">≥</span> <span class="main">0</span> <span class="main">⟹</span> <span class="main">⌈</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">=</span> <span class="free">h</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span> <span class="main">=</span> <span class="main">0</span><span class="main">⌉</span> <span class="main">≤</span>
  <span class="keyword1">wp</span>
    <span class="main">(</span><span class="keyword1">LOOP</span>
      <span class="main">(</span><span class="main">(</span><span class="keyword1">x´=</span> <span class="keyword1">f</span> <span class="free">g</span> <span class="main">&amp;</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">≥</span> <span class="main">0</span><span class="main">)</span> <span class="keyword1">DINV</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">g</span> <span class="main">*</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">-</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">g</span> <span class="main">*</span> <span class="free">h</span> <span class="main">-</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span> <span class="main">*</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
       <span class="main">(</span><span class="keyword1">IF</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="keyword1">THEN</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">::=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">-</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">ELSE</span> <span class="keyword1">skip</span><span class="main">)</span><span class="main">)</span>
    <span class="keyword1">INV</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">∧</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">g</span> <span class="main">*</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">-</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">g</span> <span class="main">*</span> <span class="free">h</span> <span class="main">-</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span> <span class="main">*</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span>
  <span class="main">)</span> <span class="main">⌈</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">≤</span> <span class="free">h</span><span class="main">⌉</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> wp_loopI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">bb_real_arith</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> wp_g_odei<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">poly_derivatives</span></span> <span class="dynamic"><span class="dynamic">diff_invariant_rules</span></span><span class="main">)</span>

<span class="comment1">― ‹Verified with annotated dynamics. ›</span>

<span class="keyword1"><span class="command">lemma</span></span> inv_conserv_at_ground<span class="main">[</span><span class="operator">bb_real_arith</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> invar<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">*</span> <span class="free">g</span> <span class="main">*</span> <span class="free">x</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">g</span> <span class="main">*</span> <span class="free">h</span> <span class="main">+</span> <span class="free">v</span> <span class="main">*</span> <span class="free">v</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> pos<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">*</span> <span class="free">τ</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">+</span> <span class="free">v</span> <span class="main">*</span> <span class="free">τ</span> <span class="main">+</span> <span class="main">(</span><span class="free">x</span><span class="main">::</span>real<span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">*</span> <span class="free">g</span> <span class="main">*</span> <span class="free">h</span> <span class="main">+</span> <span class="main">(</span><span class="free">g</span> <span class="main">*</span> <span class="free">τ</span> <span class="main">*</span> <span class="main">(</span><span class="free">g</span> <span class="main">*</span> <span class="free">τ</span> <span class="main">+</span> <span class="free">v</span><span class="main">)</span> <span class="main">+</span> <span class="free">v</span> <span class="main">*</span> <span class="main">(</span><span class="free">g</span> <span class="main">*</span> <span class="free">τ</span> <span class="main">+</span> <span class="free">v</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> pos <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">*</span> <span class="free">τ</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span>  <span class="main">+</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">v</span> <span class="main">*</span> <span class="free">τ</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">*</span> <span class="free">τ</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span>  <span class="main">+</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">g</span> <span class="main">*</span> <span class="free">v</span> <span class="main">*</span> <span class="free">τ</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">g</span> <span class="main">*</span> <span class="free">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> Groups.mult_ac<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>3<span class="main"><span class="main">)</span></span> mult_zero_right
        monoid_mult_class.power2_eq_square semiring_class.distrib_left<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">*</span> <span class="free">τ</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">g</span> <span class="main">*</span> <span class="free">v</span> <span class="main">*</span> <span class="free">τ</span> <span class="main">+</span> <span class="free">v</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">g</span> <span class="main">*</span> <span class="free">h</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> invar <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> monoid_mult_class.power2_eq_square<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> obs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">g</span> <span class="main">*</span> <span class="free">τ</span> <span class="main">+</span> <span class="free">v</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">g</span> <span class="main">*</span> <span class="free">h</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> power2_sum<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> Groups.add_ac<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">,</span></span> 3<span class="main"><span class="main">)</span></span>
        Groups.mult_ac<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">,</span></span> 3<span class="main"><span class="main">)</span></span> monoid_mult_class.power2_eq_square nat_distrib<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">*</span> <span class="free">g</span> <span class="main">*</span> <span class="free">h</span> <span class="main">+</span> <span class="main">(</span><span class="free">g</span> <span class="main">*</span> <span class="free">τ</span> <span class="main">*</span> <span class="main">(</span><span class="free">g</span> <span class="main">*</span> <span class="free">τ</span> <span class="main">+</span> <span class="free">v</span><span class="main">)</span> <span class="main">+</span> <span class="free">v</span> <span class="main">*</span> <span class="main">(</span><span class="free">g</span> <span class="main">*</span> <span class="free">τ</span> <span class="main">+</span> <span class="free">v</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> monoid_mult_class.power2_eq_square<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> inv_conserv_at_air<span class="main">[</span><span class="operator">bb_real_arith</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> invar<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">*</span> <span class="free">g</span> <span class="main">*</span> <span class="free">x</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">g</span> <span class="main">*</span> <span class="free">h</span> <span class="main">+</span> <span class="free">v</span> <span class="main">*</span> <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">*</span> <span class="free">g</span> <span class="main">*</span> <span class="main">(</span><span class="free">g</span> <span class="main">*</span> <span class="free">τ</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">+</span> <span class="free">v</span> <span class="main">*</span> <span class="free">τ</span> <span class="main">+</span> <span class="main">(</span><span class="free">x</span><span class="main">::</span>real<span class="main">)</span><span class="main">)</span> <span class="main">=</span>
  <span class="numeral">2</span> <span class="main">*</span> <span class="free">g</span> <span class="main">*</span> <span class="free">h</span> <span class="main">+</span> <span class="main">(</span><span class="free">g</span> <span class="main">*</span> <span class="free">τ</span> <span class="main">*</span> <span class="main">(</span><span class="free">g</span> <span class="main">*</span> <span class="free">τ</span> <span class="main">+</span> <span class="free">v</span><span class="main">)</span> <span class="main">+</span> <span class="free">v</span> <span class="main">*</span> <span class="main">(</span><span class="free">g</span> <span class="main">*</span> <span class="free">τ</span> <span class="main">+</span> <span class="free">v</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="free">g</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">*</span> <span class="free">τ</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">g</span> <span class="main">*</span> <span class="free">v</span> <span class="main">*</span> <span class="free">τ</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">g</span> <span class="main">*</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span> semiring_normalization_rules<span class="main"><span class="main">(</span></span>29<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="free">g</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">*</span> <span class="free">τ</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">g</span> <span class="main">*</span> <span class="free">v</span> <span class="main">*</span> <span class="free">τ</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">g</span> <span class="main">*</span> <span class="free">h</span> <span class="main">+</span> <span class="free">v</span> <span class="main">*</span> <span class="free">v</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="var">?middle</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">subst</span> invar<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?middle</span>"</span></span><span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span><span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?rhs</span> <span class="main">=</span> <span class="free">g</span> <span class="main">*</span> <span class="free">g</span> <span class="main">*</span> <span class="main">(</span><span class="free">τ</span> <span class="main">*</span> <span class="free">τ</span><span class="main">)</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">g</span> <span class="main">*</span> <span class="free">v</span> <span class="main">*</span> <span class="free">τ</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">g</span> <span class="main">*</span> <span class="free">h</span> <span class="main">+</span> <span class="free">v</span> <span class="main">*</span> <span class="free">v</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Groups.mult_ac<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">,</span></span>3<span class="main"><span class="main">)</span></span> semiring_class.distrib_left<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="var">?middle</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> semiring_normalization_rules<span class="main"><span class="main">(</span></span>29<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?rhs</span> <span class="main">=</span> <span class="var">?middle</span>"</span></span><span class="keyword1"><span class="command">.</span></span><span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> bouncing_ball_dyn<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">h</span><span class="main">::</span><span class="quoted">real</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free">h</span> <span class="main">≥</span> <span class="main">0</span> <span class="main">⟹</span>
  <span class="main">⌈</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">=</span> <span class="free">h</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span> <span class="main">=</span> <span class="main">0</span><span class="main">⌉</span> <span class="main">≤</span> <span class="keyword1">wp</span>
    <span class="main">(</span><span class="keyword1">LOOP</span>
      <span class="main">(</span><span class="main">(</span><span class="keyword1">EVOL</span> <span class="main">(</span><span class="keyword1">φ</span> <span class="free">g</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span><span class="main">)</span> <span class="free">T</span><span class="main">)</span><span class="main">;</span>
      <span class="main">(</span><span class="keyword1">IF</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="keyword1">THEN</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">::=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">-</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">ELSE</span> <span class="keyword1">skip</span><span class="main">)</span><span class="main">)</span>
    <span class="keyword1">INV</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">∧</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">g</span> <span class="main">*</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">g</span> <span class="main">*</span> <span class="free">h</span> <span class="main">+</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span> <span class="main">*</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span><span class="main">)</span><span class="main">)</span>
  <span class="main">⌈</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">≤</span> <span class="free">h</span><span class="main">⌉</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> wp_loopI<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">bb_real_arith</span></span><span class="main">)</span>

<span class="comment1">― ‹Verified with the flow. ›</span>

<span class="keyword1"><span class="command">lemma</span></span> local_flow_ball<span class="main">:</span> <span class="quoted"><span class="quoted">"local_flow <span class="main">(</span><span class="keyword1">f</span> <span class="free">g</span><span class="main">)</span> UNIV UNIV <span class="main">(</span><span class="keyword1">φ</span> <span class="free">g</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> local_lipschitz_def lipschitz_on_def vec_eq_iff<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">1</span><span class="main">/</span><span class="numeral">2</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="main">1</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dist_norm norm_vec_def L2_set_def UNIV_2<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> forall_2 <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">poly_derivatives</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> bouncing_ball_flow<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">h</span><span class="main">::</span><span class="quoted">real</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free">h</span> <span class="main">≥</span> <span class="main">0</span> <span class="main">⟹</span>
  <span class="main">⌈</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">=</span> <span class="free">h</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span> <span class="main">=</span> <span class="main">0</span><span class="main">⌉</span> <span class="main">≤</span> <span class="keyword1">wp</span>
    <span class="main">(</span><span class="keyword1">LOOP</span>
      <span class="main">(</span><span class="main">(</span><span class="keyword1">x´=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="keyword1">f</span> <span class="free">g</span><span class="main">)</span> <span class="main">&amp;</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">≥</span> <span class="main">0</span><span class="main">)</span> <span class="keyword1">on</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> UNIV<span class="main">)</span> UNIV <span class="main">@</span> <span class="main">0</span><span class="main">)</span><span class="main">;</span>
      <span class="main">(</span><span class="keyword1">IF</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="keyword1">THEN</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">::=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">-</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">ELSE</span> <span class="keyword1">skip</span><span class="main">)</span><span class="main">)</span>
    <span class="keyword1">INV</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">∧</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">g</span> <span class="main">*</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">g</span> <span class="main">*</span> <span class="free">h</span> <span class="main">+</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span> <span class="main">*</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span><span class="main">)</span><span class="main">)</span>
  <span class="main">⌈</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">≤</span> <span class="free">h</span><span class="main">⌉</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> wp_loopI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> local_flow.wp_g_ode_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> local_flow_ball<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">bb_real_arith</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">no_notation</span></span> fball <span class="main">(</span><span class="quoted">"<span class="keyword1">f</span>"</span><span class="main">)</span>
        <span class="keyword2"><span class="keyword">and</span></span> ball_flow <span class="main">(</span><span class="quoted">"<span class="keyword1">φ</span>"</span><span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹ Thermostat ›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ A thermostat has a chronometer, a thermometer and a switch to turn on and off a heater.
At most every <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"t"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> minutes, it sets its chronometer to <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">0</span></span><span class="main"><span class="main">::</span></span>real"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, it registers
the room temperature, and it turns the heater on (or off) based on this reading. The temperature
follows the ODE <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"T' = - a * (T - U)"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> where <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"U"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"L ≥ 0"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> when the heater
is on, and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"0"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> when it is off. We use <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">1</span></span><span class="main"><span class="main">::</span></span><span class="numeral"><span class="numeral">4</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> to denote the room's temperature,
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="numeral"><span class="numeral">2</span></span><span class="main"><span class="main">::</span></span><span class="numeral"><span class="numeral">4</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is time as measured by the thermostat's chronometer, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="numeral"><span class="numeral">3</span></span><span class="main"><span class="main">::</span></span><span class="numeral"><span class="numeral">4</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is the
temperature detected by the thermometer, and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="numeral"><span class="numeral">4</span></span><span class="main"><span class="main">::</span></span><span class="numeral"><span class="numeral">4</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> states whether the heater is on
(<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"s$4 = 1"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>) or off (<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"s$4 = 0"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>). We prove that the thermostat keeps the room's
temperature between <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"Tmin"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"Tmax"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. ›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">temp_vec_field</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real <span class="main">⇒</span> real <span class="main">⇒</span> real<span class="main">^</span><span class="numeral">4</span> <span class="main">⇒</span> real<span class="main">^</span><span class="numeral">4</span>"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">f</span>"</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">f</span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="keyword1">χ</span> <span class="bound">i</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">i</span> <span class="main">=</span> <span class="numeral">2</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">i</span> <span class="main">=</span> <span class="main">1</span> <span class="keyword1">then</span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">*</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="main">1</span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">L</span></span></span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">temp_flow</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real <span class="main">⇒</span> real <span class="main">⇒</span> real <span class="main">⇒</span> real<span class="main">^</span><span class="numeral">4</span> <span class="main">⇒</span> real<span class="main">^</span><span class="numeral">4</span>"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">φ</span>"</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">φ</span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="keyword1">χ</span> <span class="bound">i</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">i</span> <span class="main">=</span> <span class="main">1</span> <span class="keyword1">then</span> <span class="main">-</span> exp<span class="main">(</span><span class="main">-</span><span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">*</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="keyword1">else</span>
  <span class="main">(</span><span class="keyword1">if</span> <span class="bound">i</span> <span class="main">=</span> <span class="numeral">2</span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="numeral">2</span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="comment1">― ‹Verified with the flow. ›</span>

<span class="keyword1"><span class="command">lemma</span></span> norm_diff_temp_dyn<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">a</span> <span class="main">⟹</span> <span class="main">∥</span><span class="keyword1">f</span> <span class="free">a</span> <span class="free">L</span> <span class="free">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">-</span> <span class="keyword1">f</span> <span class="free">a</span> <span class="free">L</span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub></span><span class="main">∥</span> <span class="main">=</span> <span class="main">¦</span><span class="free">a</span><span class="main">¦</span> <span class="main">*</span> <span class="main">¦</span><span class="free">s<span class="hidden">⇩</span><sub>1</sub></span><span class="main">$</span><span class="main">1</span> <span class="main">-</span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub></span><span class="main">$</span><span class="main">1</span><span class="main">¦</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> norm_vec_def L2_set_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> UNIV_4<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> a1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> f2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">r</span> <span class="bound">ra</span><span class="main">.</span> <span class="main">¦</span><span class="main">(</span><span class="bound">r</span><span class="main">::</span>real<span class="main">)</span> <span class="main">+</span> <span class="main">-</span> <span class="bound">ra</span><span class="main">¦</span> <span class="main">=</span> <span class="main">¦</span><span class="bound">ra</span> <span class="main">+</span> <span class="main">-</span> <span class="bound">r</span><span class="main">¦</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> abs_minus_commute minus_real_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">r</span> <span class="bound">ra</span> <span class="bound">rb</span><span class="main">.</span> <span class="main">(</span><span class="bound">r</span><span class="main">::</span>real<span class="main">)</span> <span class="main">*</span> <span class="bound">ra</span> <span class="main">+</span> <span class="main">-</span> <span class="main">(</span><span class="bound">r</span> <span class="main">*</span> <span class="bound">rb</span><span class="main">)</span> <span class="main">=</span> <span class="bound">r</span> <span class="main">*</span> <span class="main">(</span><span class="bound">ra</span> <span class="main">+</span> <span class="main">-</span> <span class="bound">rb</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> minus_real_def right_diff_distrib<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="free">a</span> <span class="main">*</span> <span class="main">(</span><span class="free">s<span class="hidden">⇩</span><sub>1</sub></span><span class="main">$</span><span class="main">1</span> <span class="main">+</span> <span class="main">-</span> <span class="free">L</span><span class="main">)</span> <span class="main">+</span> <span class="main">-</span> <span class="main">(</span><span class="free">a</span> <span class="main">*</span> <span class="main">(</span><span class="free">s<span class="hidden">⇩</span><sub>2</sub></span><span class="main">$</span><span class="main">1</span> <span class="main">+</span> <span class="main">-</span> <span class="free">L</span><span class="main">)</span><span class="main">)</span><span class="main">¦</span> <span class="main">=</span> <span class="free">a</span> <span class="main">*</span> <span class="main">¦</span><span class="free">s<span class="hidden">⇩</span><sub>1</sub></span><span class="main">$</span><span class="main">1</span> <span class="main">+</span> <span class="main">-</span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub></span><span class="main">$</span><span class="main">1</span><span class="main">¦</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> a1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> abs_mult<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="free">a</span> <span class="main">*</span> <span class="main">(</span><span class="free">s<span class="hidden">⇩</span><sub>2</sub></span><span class="main">$</span><span class="main">1</span> <span class="main">-</span> <span class="free">L</span><span class="main">)</span> <span class="main">-</span> <span class="free">a</span> <span class="main">*</span> <span class="main">(</span><span class="free">s<span class="hidden">⇩</span><sub>1</sub></span><span class="main">$</span><span class="main">1</span> <span class="main">-</span> <span class="free">L</span><span class="main">)</span><span class="main">¦</span> <span class="main">=</span> <span class="free">a</span> <span class="main">*</span> <span class="main">¦</span><span class="free">s<span class="hidden">⇩</span><sub>1</sub></span><span class="main">$</span><span class="main">1</span> <span class="main">-</span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub></span><span class="main">$</span><span class="main">1</span><span class="main">¦</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> f2 minus_real_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> local_lipschitz_temp_dyn<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="main">(</span><span class="free">a</span><span class="main">::</span>real<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"local_lipschitz UNIV UNIV <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">::</span>real<span class="main">.</span> <span class="keyword1">f</span> <span class="free">a</span> <span class="free">L</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">unfold</span> local_lipschitz_def lipschitz_on_def dist_norm<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="main">1</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">a</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> norm_diff_temp_dyn<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> norm_vec_def L2_set_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> UNIV_4<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> real_sqrt_abs<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> real_le_lsqrt<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> local_flow_temp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟹</span> local_flow <span class="main">(</span><span class="keyword1">f</span> <span class="free">a</span> <span class="free">L</span><span class="main">)</span> UNIV UNIV <span class="main">(</span><span class="keyword1">φ</span> <span class="free">a</span> <span class="free">L</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">poly_derivatives</span></span> local_lipschitz_temp_dyn <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> forall_4 vec_eq_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> temp_dyn_down_real_arith<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> Thyps<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">Tmin</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">Tmin</span> <span class="main">≤</span> <span class="free">T</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">T</span> <span class="main">≤</span> <span class="free">Tmax</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> thyps<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="main">(</span><span class="free">t</span><span class="main">::</span>real<span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">τ</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">t</span><span class="main">}</span><span class="main">.</span> <span class="bound">τ</span> <span class="main">≤</span> <span class="main">-</span> <span class="main">(</span>ln <span class="main">(</span><span class="free">Tmin</span> <span class="main">/</span> <span class="free">T</span><span class="main">)</span> <span class="main">/</span> <span class="free">a</span><span class="main">)</span> "</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Tmin</span> <span class="main">≤</span> exp <span class="main">(</span><span class="main">-</span><span class="free">a</span> <span class="main">*</span> <span class="free">t</span><span class="main">)</span> <span class="main">*</span> <span class="free">T</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"exp <span class="main">(</span><span class="main">-</span><span class="free">a</span> <span class="main">*</span> <span class="free">t</span><span class="main">)</span> <span class="main">*</span> <span class="free">T</span> <span class="main">≤</span> <span class="free">Tmax</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">t</span> <span class="main">∧</span> <span class="free">t</span> <span class="main">≤</span> <span class="main">-</span> <span class="main">(</span>ln <span class="main">(</span><span class="free">Tmin</span> <span class="main">/</span> <span class="free">T</span><span class="main">)</span> <span class="main">/</span> <span class="free">a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> thyps <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"ln <span class="main">(</span><span class="free">Tmin</span> <span class="main">/</span> <span class="free">T</span><span class="main">)</span> <span class="main">≤</span> <span class="main">-</span> <span class="free">a</span> <span class="main">*</span> <span class="free">t</span> <span class="main">∧</span> <span class="main">-</span> <span class="free">a</span> <span class="main">*</span> <span class="free">t</span> <span class="main">≤</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> divide_le_cancel <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Tmin</span> <span class="main">/</span> <span class="free">T</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Thyps <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> obs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Tmin</span> <span class="main">/</span> <span class="free">T</span> <span class="main">≤</span> exp <span class="main">(</span><span class="main">-</span><span class="free">a</span> <span class="main">*</span> <span class="free">t</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"exp <span class="main">(</span><span class="main">-</span><span class="free">a</span> <span class="main">*</span> <span class="free">t</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> exp_ln exp_le_one_iff <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> exp_less_cancel_iff not_less<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">Tmin</span> <span class="main">≤</span> exp <span class="main">(</span><span class="main">-</span><span class="free">a</span> <span class="main">*</span> <span class="free">t</span><span class="main">)</span> <span class="main">*</span> <span class="free">T</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Thyps <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pos_divide_le_eq<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"exp <span class="main">(</span><span class="main">-</span><span class="free">a</span> <span class="main">*</span> <span class="free">t</span><span class="main">)</span> <span class="main">*</span> <span class="free">T</span> <span class="main">≤</span> <span class="free">Tmax</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Thyps mult_left_le_one_le<span class="main">[</span><span class="operator">OF</span> _ exp_ge_zero obs<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">T</span></span><span class="main">]</span>
      less_eq_real_def order_trans_rules<span class="main">(</span>23<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> temp_dyn_up_real_arith<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> Thyps<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Tmin</span> <span class="main">≤</span> <span class="free">T</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">T</span> <span class="main">≤</span> <span class="free">Tmax</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">Tmax</span> <span class="main">&lt;</span> <span class="main">(</span><span class="free">L</span><span class="main">::</span>real<span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> thyps<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">τ</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">t</span><span class="main">}</span><span class="main">.</span> <span class="bound">τ</span> <span class="main">≤</span> <span class="main">-</span> <span class="main">(</span>ln <span class="main">(</span><span class="main">(</span><span class="free">L</span> <span class="main">-</span> <span class="free">Tmax</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="free">L</span> <span class="main">-</span> <span class="free">T</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> <span class="free">a</span><span class="main">)</span> "</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">L</span> <span class="main">-</span> <span class="free">Tmax</span> <span class="main">≤</span> exp <span class="main">(</span><span class="main">-</span><span class="main">(</span><span class="free">a</span> <span class="main">*</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">L</span> <span class="main">-</span> <span class="free">T</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">L</span> <span class="main">-</span> exp <span class="main">(</span><span class="main">-</span><span class="main">(</span><span class="free">a</span> <span class="main">*</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">L</span> <span class="main">-</span> <span class="free">T</span><span class="main">)</span> <span class="main">≤</span> <span class="free">Tmax</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">Tmin</span> <span class="main">≤</span> <span class="free">L</span> <span class="main">-</span> exp <span class="main">(</span><span class="main">-</span><span class="main">(</span><span class="free">a</span> <span class="main">*</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">L</span> <span class="main">-</span> <span class="free">T</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">t</span> <span class="main">∧</span> <span class="free">t</span> <span class="main">≤</span> <span class="main">-</span> <span class="main">(</span>ln <span class="main">(</span><span class="main">(</span><span class="free">L</span> <span class="main">-</span> <span class="free">Tmax</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="free">L</span> <span class="main">-</span> <span class="free">T</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> <span class="free">a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> thyps <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"ln <span class="main">(</span><span class="main">(</span><span class="free">L</span> <span class="main">-</span> <span class="free">Tmax</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="free">L</span> <span class="main">-</span> <span class="free">T</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="main">-</span> <span class="free">a</span> <span class="main">*</span> <span class="free">t</span> <span class="main">∧</span> <span class="main">-</span> <span class="free">a</span> <span class="main">*</span> <span class="free">t</span> <span class="main">≤</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> divide_le_cancel <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">L</span> <span class="main">-</span> <span class="free">Tmax</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="free">L</span> <span class="main">-</span> <span class="free">T</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Thyps <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">L</span> <span class="main">-</span> <span class="free">Tmax</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="free">L</span> <span class="main">-</span> <span class="free">T</span><span class="main">)</span> <span class="main">≤</span> exp <span class="main">(</span><span class="main">-</span><span class="free">a</span> <span class="main">*</span> <span class="free">t</span><span class="main">)</span> <span class="main">∧</span> exp <span class="main">(</span><span class="main">-</span><span class="free">a</span> <span class="main">*</span> <span class="free">t</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> exp_ln exp_le_one_iff <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> exp_less_cancel_iff not_less<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">L</span> <span class="main">-</span> <span class="free">T</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Thyps <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> obs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">L</span> <span class="main">-</span> <span class="free">Tmax</span><span class="main">)</span> <span class="main">≤</span> exp <span class="main">(</span><span class="main">-</span><span class="free">a</span> <span class="main">*</span> <span class="free">t</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">L</span> <span class="main">-</span> <span class="free">T</span><span class="main">)</span> <span class="main">∧</span> exp <span class="main">(</span><span class="main">-</span><span class="free">a</span> <span class="main">*</span> <span class="free">t</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">L</span> <span class="main">-</span> <span class="free">T</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="free">L</span> <span class="main">-</span> <span class="free">T</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pos_divide_le_eq<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">L</span> <span class="main">-</span> <span class="free">Tmax</span><span class="main">)</span> <span class="main">≤</span> exp <span class="main">(</span><span class="main">-</span><span class="main">(</span><span class="free">a</span> <span class="main">*</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">L</span> <span class="main">-</span> <span class="free">T</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">L</span> <span class="main">-</span> exp <span class="main">(</span><span class="main">-</span><span class="main">(</span><span class="free">a</span> <span class="main">*</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">L</span> <span class="main">-</span> <span class="free">T</span><span class="main">)</span> <span class="main">≤</span> <span class="free">Tmax</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">Tmin</span> <span class="main">≤</span> <span class="free">L</span> <span class="main">-</span> exp <span class="main">(</span><span class="main">-</span><span class="main">(</span><span class="free">a</span> <span class="main">*</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">L</span> <span class="main">-</span> <span class="free">T</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Thyps <span class="keyword2"><span class="keyword">and</span></span> obs <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> fbox_temp_dyn <span class="main">=</span> local_flow.wp_g_ode_subset<span class="main">[</span><span class="operator">OF</span> local_flow_temp<span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> thermostat<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">Tmin</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">Tmax</span> <span class="main">&lt;</span> <span class="free">L</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⌈</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">Tmin</span> <span class="main">≤</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">≤</span> <span class="free">Tmax</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">4</span> <span class="main">=</span> <span class="main">0</span><span class="main">⌉</span> <span class="main">≤</span> <span class="keyword1">wp</span>
  <span class="main">(</span><span class="keyword1">LOOP</span>
    <span class="comment1">― ‹control›</span>
    <span class="main">(</span><span class="main">(</span><span class="numeral">2</span> <span class="main">::=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">;</span><span class="main">(</span><span class="numeral">3</span> <span class="main">::=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
    <span class="main">(</span><span class="keyword1">IF</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">4</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">3</span> <span class="main">≤</span> <span class="free">Tmin</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">THEN</span> <span class="main">(</span><span class="numeral">4</span> <span class="main">::=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">ELSE</span>
    <span class="main">(</span><span class="keyword1">IF</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">4</span> <span class="main">=</span> <span class="main">1</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">3</span> <span class="main">≥</span> <span class="free">Tmax</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">THEN</span> <span class="main">(</span><span class="numeral">4</span> <span class="main">::=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span><span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">ELSE</span> <span class="keyword1">skip</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
    <span class="comment1">― ‹dynamics›</span>
    <span class="main">(</span><span class="keyword1">IF</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">4</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="keyword1">THEN</span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="keyword1">f</span> <span class="free">a</span> <span class="main">0</span> <span class="main">&amp;</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span> <span class="main">≤</span> <span class="main">-</span> <span class="main">(</span>ln <span class="main">(</span><span class="free">Tmin</span><span class="main">/</span><span class="bound">s</span><span class="main">$</span><span class="numeral">3</span><span class="main">)</span><span class="main">)</span><span class="main">/</span><span class="free">a</span><span class="main">)</span><span class="main">)</span>
    <span class="keyword1">ELSE</span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="keyword1">f</span> <span class="free">a</span> <span class="free">L</span> <span class="main">&amp;</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span> <span class="main">≤</span> <span class="main">-</span> <span class="main">(</span>ln <span class="main">(</span><span class="main">(</span><span class="free">L</span><span class="main">-</span><span class="free">Tmax</span><span class="main">)</span><span class="main">/</span><span class="main">(</span><span class="free">L</span><span class="main">-</span><span class="bound">s</span><span class="main">$</span><span class="numeral">3</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">/</span><span class="free">a</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">)</span>
  <span class="keyword1">INV</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">Tmin</span> <span class="main">≤</span><span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">≤</span> <span class="free">Tmax</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">s</span><span class="main">$</span><span class="numeral">4</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">4</span> <span class="main">=</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
  <span class="main">⌈</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">Tmin</span> <span class="main">≤</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">≤</span> <span class="free">Tmax</span><span class="main">⌉</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> wp_loopI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fbox_temp_dyn<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> temp_dyn_up_real_arith<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span>1<span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span> _ _ assms<span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span>3<span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">Tmin</span></span></span></span></span></span><span class="main">]</span>
    <span class="keyword2"><span class="keyword">and</span></span> temp_dyn_down_real_arith<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">,</span></span></span>2<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main">,</span> <span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">Tmax</span></span></span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">no_notation</span></span> temp_vec_field <span class="main">(</span><span class="quoted">"<span class="keyword1">f</span>"</span><span class="main">)</span>
        <span class="keyword2"><span class="keyword">and</span></span> temp_flow <span class="main">(</span><span class="quoted">"<span class="keyword1">φ</span>"</span><span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹ Tank ›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ A controller turns a water pump on and off to keep the level of water <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"h"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> in a tank
within an acceptable range <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"hmin ≤ h ≤ hmax"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. Just like in the previous example, after 
each intervention, the controller registers the current level of water and resets its chronometer,
then it changes the status of the water pump accordingly. The level of water grows linearly 
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"h' = k"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> at a rate of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"k = c<span class="hidden">⇩</span><sub>i</sub>-c<span class="hidden">⇩</span><sub>o</sub>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> if the pump is on, and at a rate of 
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"k = -c<span class="hidden">⇩</span><sub>o</sub>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> if the pump is off. We use <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">1</span></span><span class="main"><span class="main">::</span></span><span class="numeral"><span class="numeral">4</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> to denote the tank's level of water,
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="numeral"><span class="numeral">2</span></span><span class="main"><span class="main">::</span></span><span class="numeral"><span class="numeral">4</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is time as measured by the controller's chronometer, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="numeral"><span class="numeral">3</span></span><span class="main"><span class="main">::</span></span><span class="numeral"><span class="numeral">4</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is the
level of water measured by the chronometer, and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="numeral"><span class="numeral">4</span></span><span class="main"><span class="main">::</span></span><span class="numeral"><span class="numeral">4</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> states whether the pump is on
(<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"s$4 = 1"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>) or off (<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"s$4 = 0"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>). We prove that the controller keeps the level of
water between <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"hmin"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"hmax"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. ›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">tank_vec_field</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real <span class="main">⇒</span> real<span class="main">^</span><span class="numeral">4</span> <span class="main">⇒</span> real<span class="main">^</span><span class="numeral">4</span>"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">f</span>"</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">f</span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="keyword1">χ</span> <span class="bound">i</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">i</span> <span class="main">=</span> <span class="numeral">2</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">i</span> <span class="main">=</span> <span class="main">1</span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">tank_flow</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real <span class="main">⇒</span> real <span class="main">⇒</span> real<span class="main">^</span><span class="numeral">4</span> <span class="main">⇒</span> real<span class="main">^</span><span class="numeral">4</span>"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">φ</span>"</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">φ</span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="keyword1">χ</span> <span class="bound">i</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">i</span> <span class="main">=</span> <span class="main">1</span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">*</span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="main">1</span> <span class="keyword1">else</span> 
  <span class="main">(</span><span class="keyword1">if</span> <span class="bound">i</span> <span class="main">=</span> <span class="numeral">2</span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="numeral">2</span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">tank_guard</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real <span class="main">⇒</span> real <span class="main">⇒</span> real<span class="main">^</span><span class="numeral">4</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">G</span>"</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">G</span></span> <span class="free"><span class="bound"><span class="entity">Hm</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="numeral">2</span> <span class="main">≤</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Hm</span></span></span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="numeral">3</span><span class="main">)</span><span class="main">/</span><span class="free"><span class="bound"><span class="entity">k</span></span></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">tank_loop_inv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real <span class="main">⇒</span> real <span class="main">⇒</span> real<span class="main">^</span><span class="numeral">4</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">I</span>"</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">I</span></span> <span class="free"><span class="bound"><span class="entity">hmin</span></span></span> <span class="free"><span class="bound"><span class="entity">hmax</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">hmin</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="main">1</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="main">1</span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">hmax</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="numeral">4</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="numeral">4</span> <span class="main">=</span> <span class="main">1</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">tank_diff_inv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real <span class="main">⇒</span> real <span class="main">⇒</span> real <span class="main">⇒</span> real<span class="main">^</span><span class="numeral">4</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">dI</span>"</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">dI</span></span> <span class="free"><span class="bound"><span class="entity">hmin</span></span></span> <span class="free"><span class="bound"><span class="entity">hmax</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="main">1</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">*</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="numeral">2</span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="numeral">3</span> <span class="main">∧</span> <span class="main">0</span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="numeral">2</span> <span class="main">∧</span> 
    <span class="free"><span class="bound"><span class="entity">hmin</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="numeral">3</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="numeral">3</span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">hmax</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="numeral">4</span> <span class="main">=</span><span class="main">0</span> <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="numeral">4</span> <span class="main">=</span> <span class="main">1</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> local_flow_tank<span class="main">:</span> <span class="quoted"><span class="quoted">"local_flow <span class="main">(</span><span class="keyword1">f</span> <span class="free">k</span><span class="main">)</span> UNIV UNIV <span class="main">(</span><span class="keyword1">φ</span> <span class="free">k</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> local_lipschitz_def lipschitz_on_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">1</span><span class="main">/</span><span class="numeral">2</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="main">1</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dist_norm norm_vec_def L2_set_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> UNIV_4<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">poly_derivatives</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> vec_eq_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> tank_arith<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="main">(</span><span class="free">τ</span><span class="main">::</span>real<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">c<span class="hidden">⇩</span><sub>o</sub></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">c<span class="hidden">⇩</span><sub>o</sub></span> <span class="main">&lt;</span> <span class="free">c<span class="hidden">⇩</span><sub>i</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">τ</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">τ</span><span class="main">}</span><span class="main">.</span> <span class="bound">τ</span> <span class="main">≤</span> <span class="main">-</span> <span class="main">(</span><span class="main">(</span><span class="free">hmin</span> <span class="main">-</span> <span class="free">y</span><span class="main">)</span> <span class="main">/</span> <span class="free">c<span class="hidden">⇩</span><sub>o</sub></span><span class="main">)</span> <span class="main">⟹</span>  <span class="free">hmin</span> <span class="main">≤</span> <span class="free">y</span> <span class="main">-</span> <span class="free">c<span class="hidden">⇩</span><sub>o</sub></span> <span class="main">*</span> <span class="free">τ</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">τ</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">τ</span><span class="main">}</span><span class="main">.</span> <span class="bound">τ</span> <span class="main">≤</span> <span class="main">(</span><span class="free">hmax</span> <span class="main">-</span> <span class="free">y</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="free">c<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">-</span> <span class="free">c<span class="hidden">⇩</span><sub>o</sub></span><span class="main">)</span> <span class="main">⟹</span>  <span class="main">(</span><span class="free">c<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">-</span> <span class="free">c<span class="hidden">⇩</span><sub>o</sub></span><span class="main">)</span> <span class="main">*</span> <span class="free">τ</span> <span class="main">+</span> <span class="free">y</span> <span class="main">≤</span> <span class="free">hmax</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">hmin</span> <span class="main">≤</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">hmin</span> <span class="main">≤</span> <span class="main">(</span><span class="free">c<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">-</span> <span class="free">c<span class="hidden">⇩</span><sub>o</sub></span><span class="main">)</span> <span class="main">*</span> <span class="free">τ</span> <span class="main">+</span> <span class="free">y</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">≤</span> <span class="free">hmax</span> <span class="main">⟹</span> <span class="free">y</span> <span class="main">-</span> <span class="free">c<span class="hidden">⇩</span><sub>o</sub></span> <span class="main">*</span> <span class="free">τ</span> <span class="main">≤</span> <span class="free">hmax</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span> le_divide_eq assms<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">meson</span> add_mono less_eq_real_def mult_left_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> add_increasing2 less_eq_real_def mult_nonneg_nonneg<span class="main">)</span> 

<span class="keyword1"><span class="command">lemma</span></span> tank_flow<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">c<span class="hidden">⇩</span><sub>o</sub></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">c<span class="hidden">⇩</span><sub>o</sub></span> <span class="main">&lt;</span> <span class="free">c<span class="hidden">⇩</span><sub>i</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⌈</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="keyword1">I</span> <span class="free">hmin</span> <span class="free">hmax</span> <span class="bound">s</span><span class="main">⌉</span> <span class="main">≤</span> <span class="keyword1">wp</span>
  <span class="main">(</span><span class="keyword1">LOOP</span> 
    <span class="comment1">― ‹control›</span>
    <span class="main">(</span><span class="main">(</span><span class="numeral">2</span> <span class="main">::=</span><span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span><span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">;</span><span class="main">(</span><span class="numeral">3</span> <span class="main">::=</span><span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
    <span class="main">(</span><span class="keyword1">IF</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">4</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">3</span> <span class="main">≤</span> <span class="free">hmin</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">THEN</span> <span class="main">(</span><span class="numeral">4</span> <span class="main">::=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">ELSE</span> 
    <span class="main">(</span><span class="keyword1">IF</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">4</span> <span class="main">=</span> <span class="main">1</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">3</span> <span class="main">≥</span> <span class="free">hmax</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">THEN</span> <span class="main">(</span><span class="numeral">4</span> <span class="main">::=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span><span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">ELSE</span> <span class="keyword1">skip</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
    <span class="comment1">― ‹dynamics›</span>
    <span class="main">(</span><span class="keyword1">IF</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">4</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="keyword1">THEN</span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="keyword1">f</span> <span class="main">(</span><span class="free">c<span class="hidden">⇩</span><sub>i</sub></span><span class="main">-</span><span class="free">c<span class="hidden">⇩</span><sub>o</sub></span><span class="main">)</span> <span class="main">&amp;</span> <span class="main">(</span><span class="keyword1">G</span> <span class="free">hmax</span> <span class="main">(</span><span class="free">c<span class="hidden">⇩</span><sub>i</sub></span><span class="main">-</span><span class="free">c<span class="hidden">⇩</span><sub>o</sub></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> 
     <span class="keyword1">ELSE</span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="keyword1">f</span> <span class="main">(</span><span class="main">-</span><span class="free">c<span class="hidden">⇩</span><sub>o</sub></span><span class="main">)</span> <span class="main">&amp;</span> <span class="main">(</span><span class="keyword1">G</span> <span class="free">hmin</span> <span class="main">(</span><span class="main">-</span><span class="free">c<span class="hidden">⇩</span><sub>o</sub></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">)</span> <span class="keyword1">INV</span> <span class="keyword1">I</span> <span class="free">hmin</span> <span class="free">hmax</span><span class="main">)</span> 
  <span class="main">⌈</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="keyword1">I</span> <span class="free">hmin</span> <span class="free">hmax</span> <span class="bound">s</span><span class="main">⌉</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> wp_loopI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> local_flow.wp_g_ode_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> local_flow_tank<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> assms tank_arith<span class="main">[</span><span class="operator">OF</span> _ assms<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">no_notation</span></span> tank_vec_field <span class="main">(</span><span class="quoted">"<span class="keyword1">f</span>"</span><span class="main">)</span>
        <span class="keyword2"><span class="keyword">and</span></span> tank_flow <span class="main">(</span><span class="quoted">"<span class="keyword1">φ</span>"</span><span class="main">)</span>
        <span class="keyword2"><span class="keyword">and</span></span> tank_loop_inv <span class="main">(</span><span class="quoted">"<span class="keyword1">I</span>"</span><span class="main">)</span>
        <span class="keyword2"><span class="keyword">and</span></span> tank_diff_inv <span class="main">(</span><span class="quoted">"<span class="keyword1">dI</span>"</span><span class="main">)</span>
        <span class="keyword2"><span class="keyword">and</span></span> tank_guard <span class="main">(</span><span class="quoted">"<span class="keyword1">G</span>"</span><span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="HS_VC_KA_ndfun">
<div class="head">
<h1>Theory HS_VC_KA_ndfun</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:       Verification components with relational MKA 
    Author:      Jonathan Julián Huerta y Munive, 2020
    Maintainer:  Jonathan Julián Huerta y Munive &lt;jonjulian23@gmail.com&gt;
*)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹ State transformer model ›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ We show that Kleene algebras have a state transformer model. For this we use the type of 
non-deterministic functions of the Transformer\_Semantics.Kleisli\_Quantale theory. Below we 
prove some auxiliary lemmas for them and show this instantiation. ›</span></span>

<span class="keyword1"><span class="command">theory</span></span> HS_VC_KA_ndfun
  <span class="keyword2"><span class="keyword">imports</span></span> 
    <a href="../Kleene_Algebra/Kleene_Algebra.html">Kleene_Algebra.Kleene_Algebra</a>
    <span class="quoted">"<a href="../Transformer_Semantics/Kleisli_Quantale.html">Transformer_Semantics.Kleisli_Quantale</a>"</span>

<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">notation</span></span> Abs_nd_fun <span class="main">(</span><span class="quoted">"_<span class="keyword1"><span class="hidden">⇧</span><sup>∙</sup></span>"</span> <span class="main">[</span>101<span class="main">]</span> 100<span class="main">)</span> 
     <span class="keyword2"><span class="keyword">and</span></span> Rep_nd_fun <span class="main">(</span><span class="quoted">"_<span class="keyword1"><span class="hidden">⇩</span><sub>∙</sub></span>"</span> <span class="main">[</span>101<span class="main">]</span> 100<span class="main">)</span>

<span class="keyword1"><span class="command">declare</span></span> Abs_nd_fun_inverse <span class="main">[</span><span class="operator">simp</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> nd_fun_ext<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span><span class="main"><span class="hidden">⇩</span><sub>∙</sub></span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">(</span><span class="free">g</span><span class="main"><span class="hidden">⇩</span><sub>∙</sub></span><span class="main">)</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">f</span> <span class="main">=</span> <span class="free">g</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"Rep_nd_fun <span class="free">f</span> <span class="main">=</span> Rep_nd_fun <span class="free">g</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> Rep_nd_fun_inject 
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> nd_fun_eq_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="main">=</span> <span class="free">g</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span><span class="main"><span class="hidden">⇩</span><sub>∙</sub></span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">(</span><span class="free">g</span><span class="main"><span class="hidden">⇩</span><sub>∙</sub></span><span class="main">)</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nd_fun_ext<span class="main">)</span>

<span class="keyword1"><span class="command">instantiation</span></span> nd_fun <span class="main">::</span> <span class="main">(</span><span class="quoted">type</span><span class="main">)</span> <span class="quoted">kleene_algebra</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">=</span> <span class="keyword1">ζ</span><span class="main"><span class="hidden">⇧</span><sup>∙</sup></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="class_parameter">star_nd_fun</span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> qstar <span class="free"><span class="bound"><span class="entity">f</span></span></span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">f</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> nd_fun"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main"><span class="hidden">⇩</span><sub>∙</sub></span><span class="main">)</span> <span class="main">⊔</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main"><span class="hidden">⇩</span><sub>∙</sub></span><span class="main">)</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>∙</sup></span>"</span></span>

<span class="keyword1"><span class="command">thm</span></span> sup_nd_fun_def sup_fun_def

<span class="keyword1"><span class="command">named_theorems</span></span> nd_fun_ka <span class="quoted">"kleene algebra properties for nondeterministic functions."</span>

<span class="keyword1"><span class="command">lemma</span></span> nd_fun_plus_assoc<span class="main">[</span><span class="operator">nd_fun_ka</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">+</span> <span class="free">y</span> <span class="main">+</span> <span class="free">z</span> <span class="main">=</span> <span class="free">x</span> <span class="main">+</span> <span class="main">(</span><span class="free">y</span> <span class="main">+</span> <span class="free">z</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> nd_fun_plus_comm<span class="main">[</span><span class="operator">nd_fun_ka</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">+</span> <span class="free">y</span> <span class="main">=</span> <span class="free">y</span> <span class="main">+</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> nd_fun_plus_idem<span class="main">[</span><span class="operator">nd_fun_ka</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">+</span> <span class="free">x</span> <span class="main">=</span> <span class="free">x</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">x</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> nd_fun"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> plus_nd_fun_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ksup_assoc<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ksup_comm<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> nd_fun_distr<span class="main">[</span><span class="operator">nd_fun_ka</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span> <span class="main">⋅</span> <span class="free">z</span> <span class="main">=</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">z</span> <span class="main">+</span> <span class="free">y</span> <span class="main">⋅</span> <span class="free">z</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> nd_fun_distl<span class="main">[</span><span class="operator">nd_fun_ka</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">y</span> <span class="main">+</span> <span class="free">z</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">+</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">z</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">x</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> nd_fun"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> plus_nd_fun_def times_nd_fun_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> kcomp_distr kcomp_distl<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> nd_fun_plus_zerol<span class="main">[</span><span class="operator">nd_fun_ka</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">+</span> <span class="free">x</span> <span class="main">=</span> <span class="free">x</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> nd_fun_mult_zerol<span class="main">[</span><span class="operator">nd_fun_ka</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> nd_fun_mult_zeror<span class="main">[</span><span class="operator">nd_fun_ka</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⋅</span> <span class="main">0</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">x</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> nd_fun"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> plus_nd_fun_def zero_nd_fun_def times_nd_fun_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> nd_fun_leq<span class="main">[</span><span class="operator">nd_fun_ka</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">≤</span> <span class="free">y</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span> <span class="main">=</span> <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> nd_fun_less<span class="main">[</span><span class="operator">nd_fun_ka</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">&lt;</span> <span class="free">y</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span> <span class="main">=</span> <span class="free">y</span> <span class="main">∧</span> <span class="free">x</span> <span class="main">≠</span> <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> nd_fun_leq_add<span class="main">[</span><span class="operator">nd_fun_ka</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">z</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">x</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> nd_fun"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> less_eq_nd_fun_def less_nd_fun_def plus_nd_fun_def times_nd_fun_def sup_fun_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> nd_fun_eq_iff le_fun_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> kcomp_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> nd_star_one<span class="main">[</span><span class="operator">nd_fun_ka</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">+</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">≤</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> nd_star_unfoldl<span class="main">[</span><span class="operator">nd_fun_ka</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">+</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">≤</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">z</span> <span class="main">≤</span> <span class="free">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> nd_star_unfoldr<span class="main">[</span><span class="operator">nd_fun_ka</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">+</span> <span class="free">y</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">z</span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">≤</span> <span class="free">y</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">x</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> nd_fun"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> plus_nd_fun_def star_nd_fun_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_star_inductl sup_nd_fun.rep_eq fun_star_inductr<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> order_refl sup_nd_fun.rep_eq uwqlka.conway.dagger_unfoldl_eq<span class="main">)</span>

<span class="keyword1"><span class="command">instance</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">intro_classes</span>
  <span class="keyword1"><span class="command">using</span></span> <span class="dynamic"><span class="dynamic">nd_fun_ka</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="HS_VC_MKA_ndfun">
<div class="head">
<h1>Theory HS_VC_MKA_ndfun</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:       Verification components with MKA and non-deterministic functions
    Author:      Jonathan Julián Huerta y Munive, 2020
    Maintainer:  Jonathan Julián Huerta y Munive &lt;jonjulian23@gmail.com&gt;
*)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Verification of hybrid programs›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ We show that non-deterministic functions or state transformers form an antidomain 
Kleene algebra. We use this algebra's forward box operator to derive rules for weakest liberal 
preconditions (wlps) of regular programs. Finally, we derive our three methods for verifying 
correctness specifications for the continuous dynamics of HS. ›</span></span>

<span class="keyword1"><span class="command">theory</span></span> HS_VC_MKA_ndfun
  <span class="keyword2"><span class="keyword">imports</span></span> 
    <span class="quoted">"<a href="HS_ODEs.html">../HS_ODEs</a>"</span>
    <span class="quoted">"<a href="HS_VC_MKA.html">HS_VC_MKA</a>"</span>
    <span class="quoted">"<a href="HS_VC_KA_ndfun.html">../HS_VC_KA_ndfun</a>"</span>

<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> nd_fun <span class="main">::</span> <span class="main">(</span><span class="quoted">type</span><span class="main">)</span> <span class="quoted">antidomain_kleene_algebra</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ad</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="keyword1">if</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main"><span class="hidden">⇩</span><sub>∙</sub></span><span class="main">)</span> <span class="bound">s</span> <span class="main">=</span> <span class="main">{}</span><span class="main">)</span> <span class="keyword1">then</span> <span class="main">{</span><span class="bound">s</span><span class="main">}</span> <span class="keyword1">else</span> <span class="main">{}</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>∙</sup></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> nd_fun_ad_zero<span class="main">[</span><span class="operator">nd_fun_ka</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">ad</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> nd_fun_ad<span class="main">[</span><span class="operator">nd_fun_ka</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">ad</span> <span class="main">(</span><span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span><span class="main">)</span> <span class="main">+</span> <span class="keyword1">ad</span> <span class="main">(</span><span class="free">x</span> <span class="main">⋅</span> <span class="keyword1">ad</span> <span class="main">(</span><span class="keyword1">ad</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">ad</span> <span class="main">(</span><span class="free">x</span> <span class="main">⋅</span> <span class="keyword1">ad</span> <span class="main">(</span><span class="keyword1">ad</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> nd_fun_ad_one<span class="main">[</span><span class="operator">nd_fun_ka</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">ad</span> <span class="main">(</span><span class="keyword1">ad</span> <span class="free">x</span><span class="main">)</span> <span class="main">+</span> <span class="keyword1">ad</span> <span class="free">x</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">x</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> nd_fun"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> antidomain_op_nd_fun_def times_nd_fun_def plus_nd_fun_def zero_nd_fun_def 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nd_fun_eq_iff kcomp_def one_nd_fun_def<span class="main">)</span>

<span class="keyword1"><span class="command">instance</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">intro_classes</span>
  <span class="keyword1"><span class="command">using</span></span> <span class="dynamic"><span class="dynamic">nd_fun_ka</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹ Regular programs›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹ Now that we know that non-deterministic functions form an Antidomain Kleene Algebra, we give
 a lifting operation from predicates to <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">"<span class="tfree"><span class="tfree">'a</span></span> nd_fun"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and use it to compute weakest liberal
preconditions.›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'a</span> pred <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span>

<span class="keyword1"><span class="command">notation</span></span> fbox <span class="main">(</span><span class="quoted">"<span class="keyword1">wp</span>"</span><span class="main">)</span>

<span class="keyword1"><span class="command">no_notation</span></span> Archimedean_Field.ceiling <span class="main">(</span><span class="quoted">"<span class="keyword1">⌈</span>_<span class="keyword1">⌉</span>"</span><span class="main">)</span>
        <span class="keyword2"><span class="keyword">and</span></span> Relation.relcomp <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">;</span>"</span> 75<span class="main">)</span>
        <span class="keyword2"><span class="keyword">and</span></span> Range_Semiring.antirange_semiring_class.ars_r <span class="main">(</span><span class="quoted">"<span class="keyword1">r</span>"</span><span class="main">)</span>
        <span class="keyword2"><span class="keyword">and</span></span> antidomain_semiringl.ads_d <span class="main">(</span><span class="quoted">"<span class="keyword1">d</span>"</span><span class="main">)</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">p2ndf</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> pred <span class="main">⇒</span> <span class="tfree">'a</span> nd_fun"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword3">(1</span><span class="keyword1">⌈</span>_<span class="keyword1">⌉</span><span class="keyword3">)</span>"</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="free">⌈</span></span><span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main"><span class="free">⌉</span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">::</span><span class="tfree">'a</span><span class="main">.</span> <span class="main">{</span><span class="bound">s</span><span class="main">::</span><span class="tfree">'a</span><span class="main">.</span> <span class="bound">s</span> <span class="main">=</span> <span class="bound">x</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="bound">s</span><span class="main">}</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>∙</sup></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> p2ndf_simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">≤</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">⟶</span> <span class="free">Q</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">=</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">=</span> <span class="free">Q</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">⋅</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span><span class="main">)</span> <span class="main">=</span> <span class="main">⌈</span><span class="main">λ</span> <span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">∧</span> <span class="free">Q</span> <span class="bound">s</span><span class="main">⌉</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">+</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span><span class="main">)</span> <span class="main">=</span> <span class="main">⌈</span><span class="main">λ</span> <span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">∨</span> <span class="free">Q</span> <span class="bound">s</span><span class="main">⌉</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1">ad</span> <span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">=</span> <span class="main">⌈</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">¬</span> <span class="free">P</span> <span class="bound">s</span><span class="main">⌉</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1">d</span> <span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">=</span> <span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">≤</span> <span class="keyword1">η</span><span class="main"><span class="hidden">⇧</span><sup>∙</sup></span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> less_eq_nd_fun_def times_nd_fun_def plus_nd_fun_def ads_d_def 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nd_fun_eq_iff kcomp_def le_fun_def antidomain_op_nd_fun_def<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ Lemmas for verification condition generation ›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> wp_nd_fun<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">wp</span> <span class="free">F</span> <span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">=</span> <span class="main">⌈</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">s'</span><span class="main">.</span> <span class="bound">s'</span> <span class="main">∈</span> <span class="main">(</span><span class="main">(</span><span class="free">F</span><span class="main"><span class="hidden">⇩</span><sub>∙</sub></span><span class="main">)</span> <span class="bound">s</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">P</span> <span class="bound">s'</span><span class="main">⌉</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fbox_def antidomain_op_nd_fun_def<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> nd_fun_ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Rep_comp_hom kcomp_prop<span class="main">)</span>

<span class="comment1">― ‹ Skip ›</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">skip</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> nd_fun"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">skip</span> <span class="main">≡</span> <span class="main">1</span>"</span></span>

<span class="comment1">― ‹ Tests ›</span>

<span class="keyword1"><span class="command">lemma</span></span> wp_test<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">wp</span> <span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span> <span class="main">=</span> <span class="main">⌈</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">⟶</span> <span class="free">Q</span> <span class="bound">s</span><span class="main">⌉</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> wp_nd_fun<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="comment1">― ‹ Assignments ›</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">assign</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">^</span><span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">^</span><span class="tfree">'b</span><span class="main">)</span> nd_fun"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword3">(2</span>_ <span class="keyword1">::=</span> _<span class="keyword3">)</span>"</span> <span class="main">[</span>70<span class="main">,</span> 65<span class="main">]</span> 61<span class="main">)</span> 
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main"><span class="free">::=</span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">{</span>vec_upd <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="bound">s</span><span class="main">)</span><span class="main">}</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>∙</sup></span>"</span></span> 

<span class="keyword1"><span class="command">lemma</span></span> wp_assign<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">wp</span> <span class="main">(</span><span class="free">x</span> <span class="main">::=</span> <span class="free">e</span><span class="main">)</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span> <span class="main">=</span> <span class="main">⌈</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">Q</span> <span class="main">(</span><span class="keyword1">χ</span> <span class="bound">j</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="main">($)</span> <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="main">(</span><span class="free">e</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="bound">j</span><span class="main">)</span><span class="main">⌉</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> wp_nd_fun nd_fun_eq_iff vec_upd_def assign_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="comment1">― ‹ Nondeterministic assignments ›</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">nondet_assign</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">^</span><span class="tfree">'b</span><span class="main">)</span> nd_fun"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword3">(2</span>_ <span class="keyword1">::=</span> <span class="keyword1">?</span> <span class="keyword3">)</span>"</span> <span class="main">[</span>70<span class="main">]</span> 61<span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main"><span class="free">::=</span></span> <span class="main"><span class="free">?</span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">{</span><span class="main">(</span>vec_upd <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="bound">k</span><span class="main">)</span><span class="main">|</span><span class="bound">k</span><span class="main">.</span> True<span class="main">}</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>∙</sup></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> wp_nondet_assign<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">wp</span> <span class="main">(</span><span class="free">x</span> <span class="main">::=</span> <span class="main">?</span><span class="main">)</span> <span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">=</span> <span class="main">⌈</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="keyword1">χ</span> <span class="bound">j</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="main">($)</span> <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="bound">j</span><span class="main">)</span><span class="main">⌉</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> wp_nd_fun nondet_assign_def vec_upd_eq <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">χ</span> <span class="bound">j</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">j</span> <span class="main">=</span> <span class="free">x</span> <span class="keyword1">then</span> <span class="improper">k</span> <span class="keyword1">else</span> <span class="improper">s</span> <span class="main">$</span> <span class="bound">j</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="comment1">― ‹ Nondeterministic choice ›</span>

<span class="keyword1"><span class="command">lemma</span></span> le_wp_choice_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">≤</span> <span class="keyword1">wp</span> <span class="main">(</span><span class="free">X</span> <span class="main">+</span> <span class="free">Y</span><span class="main">)</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span> <span class="main">⟷</span> <span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">≤</span> <span class="keyword1">wp</span> <span class="free">X</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span> <span class="main">∧</span> <span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">≤</span> <span class="keyword1">wp</span> <span class="free">Y</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> le_fbox_choice_iff<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="comment1">― ‹ Sequential composition ›</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">seq_comp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> nd_fun <span class="main">⇒</span> <span class="tfree">'a</span> nd_fun <span class="main">⇒</span> <span class="tfree">'a</span> nd_fun"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">;</span>"</span> 75<span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main"><span class="free">;</span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">⋅</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span>"</span></span>

<span class="comment1">― ‹ Conditional statement ›</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">cond_sugar</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> pred <span class="main">⇒</span> <span class="tfree">'a</span> nd_fun <span class="main">⇒</span> <span class="tfree">'a</span> nd_fun <span class="main">⇒</span> <span class="tfree">'a</span> nd_fun"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">IF</span> _ <span class="keyword1">THEN</span> _ <span class="keyword1">ELSE</span> _"</span> <span class="main">[</span>64<span class="main">,</span>64<span class="main">]</span> 63<span class="main">)</span> 
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">IF</span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="keyword1"><span class="free">THEN</span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="keyword1"><span class="free">ELSE</span></span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span> <span class="main">≡</span> aka_cond <span class="main">⌈</span><span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">⌉</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span>"</span></span>

<span class="comment1">― ‹ Finite iteration ›</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">loopi_sugar</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> nd_fun <span class="main">⇒</span> <span class="tfree">'a</span> pred <span class="main">⇒</span> <span class="tfree">'a</span> nd_fun"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">LOOP</span> _ <span class="keyword1">INV</span> _ "</span> <span class="main">[</span>64<span class="main">,</span>64<span class="main">]</span> 63<span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">LOOP</span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="keyword1"><span class="free">INV</span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">≡</span> aka_loopi <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">⌈</span><span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">⌉</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> change_loopI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">LOOP</span> <span class="free">X</span> <span class="keyword1">INV</span> <span class="free">G</span> <span class="main">=</span> <span class="keyword1">LOOP</span> <span class="free">X</span> <span class="keyword1">INV</span> <span class="free">I</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> aka_loopi_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> wp_loopI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">≤</span> <span class="main">⌈</span><span class="free">I</span><span class="main">⌉</span> <span class="main">⟹</span> <span class="main">⌈</span><span class="free">I</span><span class="main">⌉</span> <span class="main">≤</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span> <span class="main">⟹</span> <span class="main">⌈</span><span class="free">I</span><span class="main">⌉</span> <span class="main">≤</span> <span class="keyword1">wp</span> <span class="free">R</span> <span class="main">⌈</span><span class="free">I</span><span class="main">⌉</span> <span class="main">⟹</span> <span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">≤</span> <span class="keyword1">wp</span> <span class="main">(</span><span class="keyword1">LOOP</span> <span class="free">R</span> <span class="keyword1">INV</span> <span class="free">I</span><span class="main">)</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> fbox_loopi<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> wp_loopI_break<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">≤</span> <span class="keyword1">wp</span> <span class="free">Y</span> <span class="main">⌈</span><span class="free">I</span><span class="main">⌉</span> <span class="main">⟹</span> <span class="main">⌈</span><span class="free">I</span><span class="main">⌉</span> <span class="main">≤</span> <span class="keyword1">wp</span> <span class="free">X</span> <span class="main">⌈</span><span class="free">I</span><span class="main">⌉</span> <span class="main">⟹</span> <span class="main">⌈</span><span class="free">I</span><span class="main">⌉</span> <span class="main">≤</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span>  <span class="main">⟹</span> <span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">≤</span> <span class="keyword1">wp</span> <span class="main">(</span><span class="free">Y</span> <span class="main">;</span> <span class="main">(</span><span class="keyword1">LOOP</span> <span class="free">X</span> <span class="keyword1">INV</span> <span class="free">I</span><span class="main">)</span><span class="main">)</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> fbox_loopi_break<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹ Evolution commands ›</span></span>

<span class="keyword1"><span class="command">text</span></span>  <span class="quoted"><span class="plain_text">‹Verification by providing evolution›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">g_evol</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>ord<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'b</span> pred <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'a</span> set<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'b</span> nd_fun"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">EVOL</span>"</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">EVOL</span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> g_orbit <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="bound">t</span> <span class="bound">s</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>∙</sup></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> wp_g_dyn<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">φ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>preorder<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">wp</span> <span class="main">(</span><span class="keyword1">EVOL</span> <span class="free">φ</span> <span class="free">G</span> <span class="free">U</span><span class="main">)</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span> <span class="main">=</span> <span class="main">⌈</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">t</span><span class="main">∈</span><span class="free">U</span> <span class="bound">s</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">τ</span><span class="main">∈</span>down <span class="main">(</span><span class="free">U</span> <span class="bound">s</span><span class="main">)</span> <span class="bound">t</span><span class="main">.</span> <span class="free">G</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">τ</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">Q</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">t</span> <span class="bound">s</span><span class="main">)</span><span class="main">⌉</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> wp_nd_fun g_evol_def g_orbit_eq <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fun_eq_iff<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Verification by providing solutions›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">g_ode</span> <span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">(</span>real <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>banach<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> pred <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> real set<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> set <span class="main">⇒</span> 
  real <span class="main">⇒</span> <span class="tfree">'a</span> nd_fun"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword3">(1</span><span class="keyword1">x´=</span> _ <span class="keyword1">&amp;</span> _ <span class="keyword1">on</span> _ _ <span class="keyword1">@</span> _<span class="keyword3">)</span>"</span><span class="main">)</span> 
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1"><span class="free">x´=</span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main"><span class="free">&amp;</span></span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="keyword1"><span class="free">on</span></span> <span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main"><span class="free">@</span></span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">)</span> <span class="main">≡</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">s</span><span class="main">.</span> g_orbital <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="bound">s</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>∙</sup></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> wp_g_orbital<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">wp</span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="free">f</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span><span class="main">=</span> 
  <span class="main">⌈</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">X</span><span class="main">∈</span><span class="keyword1">Sols</span> <span class="free">f</span> <span class="free">U</span> <span class="free">S</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">t</span><span class="main">∈</span><span class="free">U</span> <span class="bound">s</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">τ</span><span class="main">∈</span>down <span class="main">(</span><span class="free">U</span> <span class="bound">s</span><span class="main">)</span> <span class="bound">t</span><span class="main">.</span> <span class="free">G</span> <span class="main">(</span><span class="bound">X</span> <span class="bound">τ</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">Q</span> <span class="main">(</span><span class="bound">X</span> <span class="bound">t</span><span class="main">)</span><span class="main">⌉</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> g_orbital_eq<span class="main">(</span>1<span class="main">)</span> wp_nd_fun g_ode_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fun_eq_iff<span class="main">)</span>

<span class="keyword1"><span class="command">context</span></span> local_flow
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> wp_g_ode_subset<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">∈</span> <span class="free">U</span> <span class="bound">s</span> <span class="main">∧</span> is_interval <span class="main">(</span><span class="free">U</span> <span class="bound">s</span><span class="main">)</span> <span class="main">∧</span> <span class="free">U</span> <span class="bound">s</span> <span class="main">⊆</span> <span class="free">T</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">wp</span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">f</span><span class="main">)</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="main">0</span><span class="main">)</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span> <span class="main">=</span> 
  <span class="main">⌈</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">t</span><span class="main">∈</span><span class="free">U</span> <span class="bound">s</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">τ</span><span class="main">∈</span>down <span class="main">(</span><span class="free">U</span> <span class="bound">s</span><span class="main">)</span> <span class="bound">t</span><span class="main">.</span> <span class="free">G</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">τ</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">Q</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">t</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">⌉</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">unfold</span> wp_g_orbital<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> iffI<span class="main"><span class="keyword3">;</span></span> <span class="operator">clarify</span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_ivp_sols assms<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">frule</span> ivp_solsD<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">frule</span> ivp_solsD<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">frule</span> ivp_solsD<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">τ</span><span class="main">∈</span>down <span class="main">(</span><span class="free">U</span> <span class="improper">s</span><span class="main">)</span> <span class="improper">t</span><span class="main">.</span> <span class="improper">X</span> <span class="bound">τ</span> <span class="main">=</span> <span class="free">φ</span> <span class="bound">τ</span> <span class="improper">s</span>"</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> ballI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ivp_unique_solution<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ _ _ _ _ in_ivp_sols<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> wp_g_ode<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">wp</span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">f</span><span class="main">)</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">T</span><span class="main">)</span> <span class="free">S</span> <span class="main">@</span> <span class="main">0</span><span class="main">)</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span> <span class="main">=</span> 
  <span class="main">⌈</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">t</span><span class="main">∈</span><span class="free">T</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">τ</span><span class="main">∈</span>down <span class="free">T</span> <span class="bound">t</span><span class="main">.</span> <span class="free">G</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">τ</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">Q</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">t</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">⌉</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> wp_g_ode_subset<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> init_time interval_time<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> wp_g_ode_ivl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">≥</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free">t</span> <span class="main">∈</span> <span class="free">T</span> <span class="main">⟹</span> <span class="keyword1">wp</span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">f</span><span class="main">)</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">t</span><span class="main">}</span><span class="main">)</span> <span class="free">S</span> <span class="main">@</span> <span class="main">0</span><span class="main">)</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span> <span class="main">=</span> 
  <span class="main">⌈</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">t</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">t</span><span class="main">}</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">τ</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="bound">t</span><span class="main">}</span><span class="main">.</span> <span class="free">G</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">τ</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">Q</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">t</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">⌉</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> wp_g_ode_subset<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subintervalI init_time real_Icc_closed_segment<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> closed_segment_eq_real_ivl<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> wp_orbit<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">wp</span> <span class="main">(</span><span class="keyword1">γ<span class="hidden">⇧</span><sup>φ</sup></span><span class="main"><span class="hidden">⇧</span><sup>∙</sup></span><span class="main">)</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span> <span class="main">=</span> <span class="main">⌈</span><span class="main">λ</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">t</span> <span class="main">∈</span> <span class="free">T</span><span class="main">.</span> <span class="free">Q</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">t</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">⌉</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> orbit_def wp_g_ode g_ode_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ Verification with differential invariants ›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">g_ode_inv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>real <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>banach<span class="main">)</span><span class="main">⇒</span><span class="tfree">'a</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> pred <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> real set<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> set <span class="main">⇒</span> 
  real <span class="main">⇒</span> <span class="tfree">'a</span> pred <span class="main">⇒</span> <span class="tfree">'a</span> nd_fun"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword3">(1</span><span class="keyword1">x´=</span>_ <span class="keyword1">&amp;</span> _ <span class="keyword1">on</span> _ _ <span class="keyword1">@</span> _ <span class="keyword1">DINV</span> _ <span class="keyword3">)</span>"</span><span class="main">)</span> 
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1"><span class="free">x´=</span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main"><span class="free">&amp;</span></span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="keyword1"><span class="free">on</span></span> <span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main"><span class="free">@</span></span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="keyword1"><span class="free">DINV</span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">&amp;</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="keyword1">on</span> <span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">@</span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> wp_g_orbital_guard<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">H</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">G</span> <span class="bound">s</span> <span class="main">∧</span> <span class="free">Q</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">wp</span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="free">f</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span> <span class="main">=</span> <span class="keyword1">wp</span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="free">f</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">⌈</span><span class="free">H</span><span class="main">⌉</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> wp_g_orbital <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> wp_g_orbital_inv<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">≤</span> <span class="main">⌈</span><span class="free">I</span><span class="main">⌉</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⌈</span><span class="free">I</span><span class="main">⌉</span> <span class="main">≤</span> <span class="keyword1">wp</span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="free">f</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">⌈</span><span class="free">I</span><span class="main">⌉</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⌈</span><span class="free">I</span><span class="main">⌉</span> <span class="main">≤</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">≤</span> <span class="keyword1">wp</span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="free">f</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> order.trans<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> order.trans<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> fbox_iso<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> wp_diff_inv<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⌈</span><span class="free">I</span><span class="main">⌉</span> <span class="main">≤</span> <span class="keyword1">wp</span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="free">f</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">⌈</span><span class="free">I</span><span class="main">⌉</span><span class="main">)</span> <span class="main">=</span> diff_invariant <span class="free">I</span> <span class="free">f</span> <span class="free">U</span> <span class="free">S</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">G</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> diff_invariant_eq wp_g_orbital <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fun_eq_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> diff_inv_guard_ignore<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⌈</span><span class="free">I</span><span class="main">⌉</span> <span class="main">≤</span> <span class="keyword1">wp</span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="free">f</span> <span class="main">&amp;</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> True<span class="main">)</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">⌈</span><span class="free">I</span><span class="main">⌉</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⌈</span><span class="free">I</span><span class="main">⌉</span> <span class="main">≤</span> <span class="keyword1">wp</span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="free">f</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">⌈</span><span class="free">I</span><span class="main">⌉</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> wp_diff_inv diff_invariant_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">context</span></span> local_flow
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> wp_diff_inv_eq<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">∈</span> <span class="free">U</span> <span class="bound">s</span> <span class="main">∧</span> is_interval <span class="main">(</span><span class="free">U</span> <span class="bound">s</span><span class="main">)</span> <span class="main">∧</span> <span class="free">U</span> <span class="bound">s</span> <span class="main">⊆</span> <span class="free">T</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"diff_invariant <span class="free">I</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">f</span><span class="main">)</span> <span class="free">U</span> <span class="free">S</span> <span class="main">0</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> True<span class="main">)</span> <span class="main">=</span> 
  <span class="main">(</span><span class="main">⌈</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟶</span> <span class="free">I</span> <span class="bound">s</span><span class="main">⌉</span> <span class="main">=</span> <span class="keyword1">wp</span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">f</span><span class="main">)</span> <span class="main">&amp;</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> True<span class="main">)</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="main">0</span><span class="main">)</span> <span class="main">⌈</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟶</span> <span class="free">I</span> <span class="bound">s</span><span class="main">⌉</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> wp_diff_inv<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> wp_g_ode_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="main">0</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> ballE<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> init_time in_domain ivp<span class="main">(</span>2<span class="main">)</span> assms <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">force</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">s</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">t</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> ballE<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> in_domain ivp<span class="main">(</span>2<span class="main">)</span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> diff_inv_eq_inv_set<span class="main">:</span>
  <span class="quoted"><span class="quoted">"diff_invariant <span class="free">I</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">f</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">T</span><span class="main">)</span> <span class="free">S</span> <span class="main">0</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> True<span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">s</span><span class="main">.</span> <span class="free">I</span> <span class="bound">s</span> <span class="main">⟶</span> <span class="keyword1">γ<span class="hidden">⇧</span><sup>φ</sup></span> <span class="bound">s</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="free">I</span> <span class="bound">s</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> diff_inv_eq_inv_set orbit_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemma</span></span> wp_g_odei<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">≤</span> <span class="main">⌈</span><span class="free">I</span><span class="main">⌉</span> <span class="main">⟹</span> <span class="main">⌈</span><span class="free">I</span><span class="main">⌉</span> <span class="main">≤</span> <span class="keyword1">wp</span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="free">f</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">⌈</span><span class="free">I</span><span class="main">⌉</span> <span class="main">⟹</span> <span class="main">⌈</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">I</span> <span class="bound">s</span> <span class="main">∧</span> <span class="free">G</span> <span class="bound">s</span><span class="main">⌉</span> <span class="main">≤</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span> <span class="main">⟹</span>
  <span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">≤</span> <span class="keyword1">wp</span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="free">f</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="keyword1">DINV</span> <span class="free">I</span><span class="main">)</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> g_ode_inv_def 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> b<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="keyword1">wp</span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="free">f</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">⌈</span><span class="free">I</span><span class="main">⌉</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> order.trans<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> I<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">I</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> wp_g_orbital_inv<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> wp_g_orbital_guard<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> fbox_iso<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹ Derivation of the rules of dL ›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ We derive rules of differential dynamic logic (dL). This allows the components to reason 
in the style of that logic. ›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">g_dl_ode</span> <span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>banach<span class="main">)</span><span class="main">⇒</span><span class="tfree">'a</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> pred <span class="main">⇒</span> <span class="tfree">'a</span> nd_fun"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword3">(1</span><span class="keyword1">x´=</span>_ <span class="keyword1">&amp;</span> _<span class="keyword3">)</span>"</span><span class="main">)</span> 
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1"><span class="free">x´=</span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main"><span class="free">&amp;</span></span> <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span> <span class="main">≡</span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="main">&amp;</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="keyword1">on</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">{</span><span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">≥</span> <span class="main">0</span><span class="main">}</span><span class="main">)</span> UNIV <span class="main">@</span> <span class="main">0</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">g_dl_ode_inv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>banach<span class="main">)</span><span class="main">⇒</span><span class="tfree">'a</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> pred <span class="main">⇒</span> <span class="tfree">'a</span> pred <span class="main">⇒</span> <span class="tfree">'a</span> nd_fun"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword3">(1</span><span class="keyword1">x´=</span>_ <span class="keyword1">&amp;</span> _ <span class="keyword1">DINV</span> _<span class="keyword3">)</span>"</span><span class="main">)</span> 
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1"><span class="free">x´=</span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main"><span class="free">&amp;</span></span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="keyword1"><span class="free">DINV</span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">)</span> <span class="main">≡</span> <span class="main">(</span><span class="keyword1">x´=</span><span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="main">&amp;</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="keyword1">on</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">{</span><span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">≥</span> <span class="main">0</span><span class="main">}</span><span class="main">)</span> UNIV <span class="main">@</span> <span class="main">0</span> <span class="keyword1">DINV</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> diff_solve_axiom1<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"local_flow <span class="free">f</span> UNIV UNIV <span class="free">φ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">wp</span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="free">f</span> <span class="main">&amp;</span> <span class="free">G</span><span class="main">)</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span> <span class="main">=</span> 
  <span class="main">⌈</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound"><span class="bound">t</span></span><span class="main">≥</span><span class="main">0</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">τ</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="bound">t</span><span class="main">}</span><span class="main">.</span> <span class="free">G</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">τ</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">Q</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">t</span> <span class="bound">s</span><span class="main">)</span><span class="main">⌉</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> local_flow.wp_g_ode_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> diff_solve_axiom2<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">c</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>heine_borel<span class="main">,</span> banach<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">wp</span> <span class="main">(</span><span class="keyword1">x´=</span><span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">c</span><span class="main">)</span> <span class="main">&amp;</span> <span class="free">G</span><span class="main">)</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span> <span class="main">=</span> 
  <span class="main">⌈</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound"><span class="bound">t</span></span><span class="main">≥</span><span class="main">0</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">τ</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="bound">t</span><span class="main">}</span><span class="main">.</span> <span class="free">G</span> <span class="main">(</span><span class="bound">s</span> <span class="main">+</span> <span class="bound">τ</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">c</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">Q</span> <span class="main">(</span><span class="bound">s</span> <span class="main">+</span> <span class="bound">t</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">c</span><span class="main">)</span><span class="main">⌉</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> local_flow.wp_g_ode_subset<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> φ<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="main"><span class="main">λ</span></span><span class="bound"><span class="bound">t</span></span> <span class="bound"><span class="bound">s</span></span><span class="main"><span class="main">.</span></span> <span class="bound"><span class="bound">s</span></span> <span class="main"><span class="main">+</span></span> <span class="bound"><span class="bound">t</span></span> <span class="keyword1"><span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span></span> <span class="free"><span class="free">c</span></span><span class="main"><span class="main">)</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> T<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">UNIV</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> line_is_local_flow<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> diff_solve_rule<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"local_flow <span class="free">f</span> UNIV UNIV <span class="free">φ</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">t</span></span><span class="main">≥</span><span class="main">0</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">τ</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="bound">t</span><span class="main">}</span><span class="main">.</span> <span class="free">G</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">τ</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">Q</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">t</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">≤</span> <span class="keyword1">wp</span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="free">f</span> <span class="main">&amp;</span> <span class="free">G</span><span class="main">)</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> local_flow.wp_g_ode_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> diff_weak_axiom1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">η</span><span class="main"><span class="hidden">⇧</span><sup>∙</sup></span> <span class="main">≤</span> <span class="keyword1">wp</span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="free">f</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">⌈</span><span class="free">G</span><span class="main">⌉</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> wp_nd_fun g_ode_def g_orbital_eq less_eq_nd_fun_def 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> le_fun_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> diff_weak_axiom2<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="keyword1">wp</span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="free">f</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="free">T</span> <span class="free">S</span> <span class="main">@</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span> <span class="main">=</span> <span class="keyword1">wp</span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="free">f</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="free">T</span> <span class="free">S</span> <span class="main">@</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">⌈</span><span class="main">λ</span> <span class="bound">s</span><span class="main">.</span> <span class="free">G</span> <span class="bound">s</span> <span class="main">⟶</span> <span class="free">Q</span> <span class="bound">s</span><span class="main">⌉</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> wp_g_orbital image_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1"><span class="command">lemma</span></span> diff_weak_rule<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⌈</span><span class="free">G</span><span class="main">⌉</span> <span class="main">≤</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">≤</span> <span class="keyword1">wp</span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="free">f</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wp_g_orbital<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> wp_g_orbit_IdD<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">wp</span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="free">f</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">⌈</span><span class="free">C</span><span class="main">⌉</span> <span class="main">=</span> <span class="keyword1">η</span><span class="main"><span class="hidden">⇧</span><sup>∙</sup></span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">τ</span><span class="main">∈</span><span class="main">(</span>down <span class="main">(</span><span class="free">U</span> <span class="free">s</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span><span class="main">.</span> <span class="free">x</span> <span class="bound">τ</span> <span class="main">∈</span> g_orbital <span class="free">f</span> <span class="free">G</span> <span class="free">U</span> <span class="free">S</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">τ</span><span class="main">∈</span><span class="main">(</span>down <span class="main">(</span><span class="free">U</span> <span class="free">s</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span><span class="main">.</span> <span class="free">C</span> <span class="main">(</span><span class="free">x</span> <span class="bound">τ</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">τ</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">τ</span> <span class="main">∈</span> <span class="main">(</span>down <span class="main">(</span><span class="free">U</span> <span class="free">s</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="skolem">τ</span> <span class="main">∈</span> g_orbital <span class="free">f</span> <span class="free">G</span> <span class="free">U</span> <span class="free">S</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">s</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> <span class="main">(</span>g_orbital <span class="free">f</span> <span class="free">G</span> <span class="free">U</span> <span class="free">S</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">s</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">C</span> <span class="bound">y</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> wp_nd_fun g_ode_def 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> nd_fun_eq_iff<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">(</span><span class="free">x</span> <span class="skolem">τ</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> diff_cut_axiom<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">wp</span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="free">f</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">⌈</span><span class="free">C</span><span class="main">⌉</span> <span class="main">=</span> <span class="keyword1">η</span><span class="main"><span class="hidden">⇧</span><sup>∙</sup></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">wp</span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="free">f</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span> <span class="main">=</span> <span class="keyword1">wp</span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="free">f</span> <span class="main">&amp;</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">G</span> <span class="bound">s</span> <span class="main">∧</span> <span class="free">C</span> <span class="bound">s</span><span class="main">)</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule_tac</span> f<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="keyword1">wp</span> <span class="bound">x</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> HOL.arg_cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> nd_fun_ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> subset_antisym<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="keyword1">x´=</span> <span class="free">f</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span><span class="main"><span class="hidden">⇩</span><sub>∙</sub></span><span class="main">)</span> <span class="skolem">s</span> <span class="main">⊆</span> <span class="main">(</span><span class="main">(</span><span class="keyword1">x´=</span> <span class="free">f</span> <span class="main">&amp;</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">G</span> <span class="bound">s</span> <span class="main">∧</span> <span class="free">C</span> <span class="bound">s</span><span class="main">)</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span><span class="main"><span class="hidden">⇩</span><sub>∙</sub></span><span class="main">)</span> <span class="skolem">s</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> g_ode_def<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s'</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s'</span> <span class="main">∈</span> g_orbital <span class="free">f</span> <span class="free">G</span> <span class="free">U</span> <span class="free">S</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">τ</span></span><span class="main">::</span><span class="quoted">real</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem"><span class="skolem">X</span></span> <span class="keyword2"><span class="keyword">where</span></span> x_ivp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> ivp_sols <span class="free">f</span> <span class="free">U</span> <span class="free">S</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">s</span>"</span></span> 
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="skolem">τ</span> <span class="main">=</span> <span class="skolem">s'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">τ</span> <span class="main">∈</span> <span class="free">U</span> <span class="skolem">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> guard_x<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">𝒫</span> <span class="skolem">X</span> <span class="main">(</span>down <span class="main">(</span><span class="free">U</span> <span class="skolem">s</span><span class="main">)</span> <span class="skolem">τ</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="free">G</span> <span class="bound">s</span><span class="main">}</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> g_orbitalD<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">s'</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span>"</span></span> <span class="quoted"><span class="free">G</span></span> <span class="main">_</span> <span class="quoted"><span class="free">S</span></span> <span class="quoted"><span class="free">t<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="quoted"><span class="skolem">s</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t</span><span class="main">∈</span><span class="main">(</span>down <span class="main">(</span><span class="free">U</span> <span class="skolem">s</span><span class="main">)</span> <span class="skolem">τ</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">𝒫</span> <span class="skolem">X</span> <span class="main">(</span>down <span class="main">(</span><span class="free">U</span> <span class="skolem">s</span><span class="main">)</span> <span class="bound">t</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="free">G</span> <span class="bound">s</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> guard_x <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> image_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t</span><span class="main">∈</span><span class="main">(</span>down <span class="main">(</span><span class="free">U</span> <span class="skolem">s</span><span class="main">)</span> <span class="skolem">τ</span><span class="main">)</span><span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> <span class="main">(</span><span class="free">U</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">τ</span> <span class="main">∈</span> <span class="main">(</span><span class="free">U</span> <span class="skolem">s</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t</span><span class="main">∈</span><span class="main">(</span>down <span class="main">(</span><span class="free">U</span> <span class="skolem">s</span><span class="main">)</span> <span class="skolem">τ</span><span class="main">)</span><span class="main">.</span> <span class="skolem">X</span> <span class="bound">t</span> <span class="main">∈</span> g_orbital <span class="free">f</span> <span class="free">G</span> <span class="free">U</span> <span class="free">S</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> g_orbitalI<span class="main">[</span><span class="operator">OF</span> x_ivp<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t</span><span class="main">∈</span><span class="main">(</span>down <span class="main">(</span><span class="free">U</span> <span class="skolem">s</span><span class="main">)</span> <span class="skolem">τ</span><span class="main">)</span><span class="main">.</span> <span class="free">C</span> <span class="main">(</span><span class="skolem">X</span> <span class="bound">t</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> wp_g_orbit_IdD<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s'</span> <span class="main">∈</span> g_orbital <span class="free">f</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">G</span> <span class="bound">s</span> <span class="main">∧</span> <span class="free">C</span> <span class="bound">s</span><span class="main">)</span> <span class="free">U</span> <span class="free">S</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> g_orbitalI<span class="main">[</span><span class="operator">OF</span> x_ivp <span class="quoted"><span class="quoted">‹<span class="skolem">τ</span> <span class="main">∈</span> <span class="main">(</span><span class="free">U</span> <span class="skolem">s</span><span class="main">)</span>›</span></span><span class="main">]</span> guard_x <span class="quoted"><span class="quoted">‹<span class="skolem">X</span> <span class="skolem">τ</span> <span class="main">=</span> <span class="skolem">s'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span> 
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="keyword1">x´=</span> <span class="free">f</span> <span class="main">&amp;</span> <span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">G</span> <span class="bound">s</span> <span class="main">∧</span> <span class="free">C</span> <span class="bound">s</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span><span class="main"><span class="hidden">⇩</span><sub>∙</sub></span><span class="main">)</span> <span class="skolem">s</span> <span class="main">⊆</span> <span class="main">(</span><span class="main">(</span><span class="keyword1">x´=</span> <span class="free">f</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span><span class="main"><span class="hidden">⇩</span><sub>∙</sub></span><span class="main">)</span> <span class="skolem">s</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> g_orbital_eq g_ode_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> diff_cut_rule<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> wp_C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">≤</span> <span class="keyword1">wp</span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="free">f</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">⌈</span><span class="free">C</span><span class="main">⌉</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> wp_Q<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">≤</span> <span class="keyword1">wp</span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="free">f</span> <span class="main">&amp;</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">G</span> <span class="bound">s</span> <span class="main">∧</span> <span class="free">C</span> <span class="bound">s</span><span class="main">)</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">≤</span> <span class="keyword1">wp</span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="free">f</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wp_nd_fun g_orbital_eq g_ode_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span><span class="main">::</span><span class="quoted">real</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">X</span><span class="main">::</span><span class="quoted"><span class="quoted">"real <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">s</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> <span class="free">U</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> x_ivp<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> ivp_sols <span class="free">f</span> <span class="free">U</span> <span class="free">S</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">s</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> guard_x<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">U</span> <span class="skolem">s</span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">≤</span> <span class="skolem">t</span> <span class="main">⟶</span> <span class="free">G</span> <span class="main">(</span><span class="skolem">X</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t</span><span class="main">∈</span><span class="main">(</span>down <span class="main">(</span><span class="free">U</span> <span class="skolem">s</span><span class="main">)</span> <span class="skolem">t</span><span class="main">)</span><span class="main">.</span> <span class="skolem">X</span> <span class="bound">t</span> <span class="main">∈</span> g_orbital <span class="free">f</span> <span class="free">G</span> <span class="free">U</span> <span class="free">S</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> g_orbitalI<span class="main">[</span><span class="operator">OF</span> x_ivp<span class="main">]</span> guard_x <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t</span><span class="main">∈</span><span class="main">(</span>down <span class="main">(</span><span class="free">U</span> <span class="skolem">s</span><span class="main">)</span> <span class="skolem">t</span><span class="main">)</span><span class="main">.</span> <span class="free">C</span> <span class="main">(</span><span class="skolem">X</span> <span class="bound">t</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> wp_C <span class="quoted"><span class="quoted">‹<span class="free">P</span> <span class="skolem">s</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> wp_nd_fun<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> g_ode_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="skolem">t</span> <span class="main">∈</span> g_orbital <span class="free">f</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">G</span> <span class="bound">s</span> <span class="main">∧</span> <span class="free">C</span> <span class="bound">s</span><span class="main">)</span> <span class="free">U</span> <span class="free">S</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> guard_x <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="main">∈</span> <span class="main">(</span><span class="free">U</span> <span class="skolem">s</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> g_orbitalI x_ivp<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="main">(</span><span class="skolem">X</span> <span class="skolem">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">P</span> <span class="skolem">s</span>›</span></span> wp_Q <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> wp_nd_fun<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> g_ode_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> diff_inv_axiom1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">G</span> <span class="free">s</span> <span class="main">⟶</span> <span class="free">I</span> <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"diff_invariant <span class="free">I</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">f</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">{</span><span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">≥</span> <span class="main">0</span><span class="main">}</span><span class="main">)</span> UNIV <span class="main">0</span> <span class="free">G</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> <span class="main">(</span><span class="main">(</span><span class="keyword1">wp</span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="free">f</span> <span class="main">&amp;</span> <span class="free">G</span><span class="main">)</span> <span class="main">⌈</span><span class="free">I</span><span class="main">⌉</span><span class="main">)</span><span class="main"><span class="hidden">⇩</span><sub>∙</sub></span><span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> wp_g_orbital diff_invariant_eq <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">s</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main"><span class="keyword3">,</span></span> <span class="operator">frule</span> ivp_solsD<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> diff_inv_axiom2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"picard_lindeloef <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">f</span><span class="main">)</span> UNIV UNIV <span class="main">0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="main">{</span><span class="bound">t</span><span class="main">::</span>real<span class="main">.</span> <span class="bound">t</span> <span class="main">≥</span> <span class="main">0</span><span class="main">}</span> <span class="main">⊆</span> picard_lindeloef.ex_ivl <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">f</span><span class="main">)</span> UNIV UNIV <span class="main">0</span> <span class="bound">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"diff_invariant <span class="free">I</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">f</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">{</span><span class="bound">t</span><span class="main">::</span>real<span class="main">.</span> <span class="bound">t</span> <span class="main">≥</span> <span class="main">0</span><span class="main">}</span><span class="main">)</span> UNIV <span class="main">0</span> <span class="free">G</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">wp</span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="free">f</span> <span class="main">&amp;</span> <span class="free">G</span><span class="main">)</span> <span class="main">⌈</span><span class="free">I</span><span class="main">⌉</span> <span class="main">=</span> <span class="keyword1">wp</span> <span class="main">⌈</span><span class="free">G</span><span class="main">⌉</span> <span class="main">⌈</span><span class="free">I</span><span class="main">⌉</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">unfold</span> wp_g_orbital<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> wp_nd_fun<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fun_eq_iff<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="quoted"><span class="quoted">"<span class="var">?ex_ivl</span> <span class="skolem">s</span>"</span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"picard_lindeloef.ex_ivl <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">f</span><span class="main">)</span> UNIV UNIV <span class="main">0</span> <span class="skolem">s</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="skolem">s</span>"</span></span> <span class="main">=</span> 
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">X</span><span class="main">∈</span><span class="keyword1">Sols</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">f</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">{</span><span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">≥</span> <span class="main">0</span><span class="main">}</span><span class="main">)</span> UNIV <span class="main">0</span> <span class="skolem">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound"><span class="bound">t</span></span><span class="main">≥</span><span class="main">0</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">τ</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="bound">τ</span> <span class="main">∧</span> <span class="bound">τ</span> <span class="main">≤</span> <span class="bound">t</span> <span class="main">⟶</span> <span class="free">G</span> <span class="main">(</span><span class="bound">X</span> <span class="bound">τ</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">I</span> <span class="main">(</span><span class="bound">X</span> <span class="bound">t</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">X</span></span> <span class="keyword2"><span class="keyword">where</span></span> xivp1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> <span class="keyword1">Sols</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">f</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="var">?ex_ivl</span> <span class="bound">s</span><span class="main">)</span> UNIV <span class="main">0</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> picard_lindeloef.flow_in_ivp_sols_ex_ivl<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> xivp2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> <span class="keyword1">Sols</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">f</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> Collect <span class="main">(</span><span class="main">(≤)</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> UNIV <span class="main">0</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> in_ivp_sols_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ _ xivp1<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> shyp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">0</span> <span class="main">=</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ivp_solsD <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> dinv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s</span><span class="main">.</span> <span class="free">I</span> <span class="bound">s</span> <span class="main">⟶</span> <span class="var">?lhs</span> <span class="bound">s</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> diff_invariant_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="skolem">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">G</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">X</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> ballE<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="main">0</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> shyp xivp2<span class="main">)</span><span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="skolem">s</span> <span class="main">⟶</span> <span class="main">(</span><span class="free">G</span> <span class="skolem">s</span> <span class="main">⟶</span> <span class="free">I</span> <span class="skolem">s</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">G</span> <span class="skolem">s</span> <span class="main">⟶</span> <span class="free">I</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarify</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">τ</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="bound">τ</span> <span class="main">∧</span> <span class="bound">τ</span> <span class="main">≤</span> <span class="improper">t</span> <span class="main">⟶</span> <span class="free">G</span> <span class="main">(</span><span class="improper">X</span> <span class="bound">τ</span><span class="main">)</span>"</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="main">0</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main"><span class="keyword3">,</span></span> <span class="operator">frule</span> ivp_solsD<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> dinv <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span><span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="skolem">s</span> <span class="main">=</span> <span class="main">(</span><span class="free">G</span> <span class="skolem">s</span> <span class="main">⟶</span> <span class="free">I</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> diff_inv_rule<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">≤</span> <span class="main">⌈</span><span class="free">I</span><span class="main">⌉</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"diff_invariant <span class="free">I</span> <span class="free">f</span> <span class="free">U</span> <span class="free">S</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">G</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⌈</span><span class="free">I</span><span class="main">⌉</span> <span class="main">≤</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">≤</span> <span class="keyword1">wp</span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="free">f</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> wp_g_orbital_inv<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> _ assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> wp_diff_inv <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="HS_VC_MKA_Examples_ndfun">
<div class="head">
<h1>Theory HS_VC_MKA_Examples_ndfun</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:       Examples of hybrid systems verifications
    Author:      Jonathan Julián Huerta y Munive, 2020
    Maintainer:  Jonathan Julián Huerta y Munive &lt;jonjulian23@gmail.com&gt;
*)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹ Examples ›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ We prove partial correctness specifications of some hybrid systems with our
recently described verification components. Notice that this is an exact copy of
the file <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">HS_VC_MKA_Examples</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, meaning our components are truly modular and
we can choose either a relational or predicate transformer semantics.›</span></span>

<span class="keyword1"><span class="command">theory</span></span> HS_VC_MKA_Examples_ndfun
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="HS_VC_MKA_ndfun.html">HS_VC_MKA_ndfun</a>

<span class="keyword2"><span class="keyword">begin</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹Pendulum›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ The ODEs <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"x' t = y t"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and {text "y' t = - x t"} describe the circular motion of
a mass attached to a string looked from above. We use <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"s$1"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> to represent the x-coordinate
and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"s$2"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> for the y-coordinate. We prove that this motion remains circular. ›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">fpend</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real<span class="main">^</span><span class="numeral">2</span> <span class="main">⇒</span> real<span class="main">^</span><span class="numeral">2</span>"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">f</span>"</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">f</span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="keyword1">χ</span> <span class="bound">i</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">i</span> <span class="main">=</span> <span class="main">1</span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="numeral">2</span> <span class="keyword1">else</span> <span class="main">-</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="main">1</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">pend_flow</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real <span class="main">⇒</span> real<span class="main">^</span><span class="numeral">2</span> <span class="main">⇒</span> real<span class="main">^</span><span class="numeral">2</span>"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">φ</span>"</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">φ</span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="keyword1">χ</span> <span class="bound">i</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">i</span> <span class="main">=</span> <span class="main">1</span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="main">1</span> <span class="main">*</span> cos <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="numeral">2</span> <span class="main">*</span> sin <span class="free"><span class="bound"><span class="entity">t</span></span></span>
  <span class="keyword1">else</span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="main">1</span> <span class="main">*</span> sin <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="numeral">2</span> <span class="main">*</span> cos <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>

<span class="comment1">― ‹Verified by providing dynamics. ›</span>

<span class="keyword1"><span class="command">lemma</span></span> pendulum_dyn<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⌈</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">=</span> <span class="main">(</span><span class="bound">s</span><span class="main">$</span><span class="main">1</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">+</span> <span class="main">(</span><span class="bound">s</span><span class="main">$</span><span class="numeral">2</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">⌉</span> <span class="main">≤</span> <span class="keyword1">wp</span> <span class="main">(</span><span class="keyword1">EVOL</span> <span class="keyword1">φ</span> <span class="free">G</span> <span class="free">T</span><span class="main">)</span> <span class="main">⌈</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">=</span> <span class="main">(</span><span class="bound">s</span><span class="main">$</span><span class="main">1</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">+</span> <span class="main">(</span><span class="bound">s</span><span class="main">$</span><span class="numeral">2</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">⌉</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="comment1">― ‹Verified with differential invariants. ›</span>

<span class="keyword1"><span class="command">lemma</span></span> pendulum_inv<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⌈</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">=</span> <span class="main">(</span><span class="bound">s</span><span class="main">$</span><span class="main">1</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">+</span> <span class="main">(</span><span class="bound">s</span><span class="main">$</span><span class="numeral">2</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">⌉</span> <span class="main">≤</span> <span class="keyword1">wp</span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="keyword1">f</span> <span class="main">&amp;</span> <span class="free">G</span><span class="main">)</span> <span class="main">⌈</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">=</span> <span class="main">(</span><span class="bound">s</span><span class="main">$</span><span class="main">1</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">+</span> <span class="main">(</span><span class="bound">s</span><span class="main">$</span><span class="numeral">2</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">⌉</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">poly_derivatives</span></span> <span class="dynamic"><span class="dynamic">diff_invariant_rules</span></span><span class="main">)</span>

<span class="comment1">― ‹Verified with the flow. ›</span>

<span class="keyword1"><span class="command">lemma</span></span> local_flow_pend<span class="main">:</span> <span class="quoted"><span class="quoted">"local_flow <span class="keyword1">f</span> UNIV UNIV <span class="keyword1">φ</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> local_lipschitz_def lipschitz_on_def vec_eq_iff<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="main">1</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dist_norm norm_vec_def L2_set_def power2_commute UNIV_2<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> forall_2 <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">poly_derivatives</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> pendulum_flow<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⌈</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">=</span> <span class="main">(</span><span class="bound">s</span><span class="main">$</span><span class="main">1</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">+</span> <span class="main">(</span><span class="bound">s</span><span class="main">$</span><span class="numeral">2</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">⌉</span> <span class="main">≤</span> <span class="keyword1">wp</span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="keyword1">f</span> <span class="main">&amp;</span> <span class="free">G</span><span class="main">)</span> <span class="main">⌈</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">=</span> <span class="main">(</span><span class="bound">s</span><span class="main">$</span><span class="main">1</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">+</span> <span class="main">(</span><span class="bound">s</span><span class="main">$</span><span class="numeral">2</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">⌉</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> local_flow.wp_g_ode_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> local_flow_pend<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">no_notation</span></span> fpend <span class="main">(</span><span class="quoted">"<span class="keyword1">f</span>"</span><span class="main">)</span>
        <span class="keyword2"><span class="keyword">and</span></span> pend_flow <span class="main">(</span><span class="quoted">"<span class="keyword1">φ</span>"</span><span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹ Bouncing Ball ›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ A ball is dropped from rest at an initial height <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"h"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. The motion is described with
the free-fall equations <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"x' t = v t"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"v' t = g"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> where <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"g"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is the
constant acceleration due to gravity. The bounce is modelled with a variable assignment that
flips the velocity. That is, we model it as a completely elastic collision with the ground. We use 
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"s$1"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> to represent the ball's height and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"s$2"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> for its velocity. We prove that the 
ball remains above ground and below its initial resting position. ›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">fball</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real <span class="main">⇒</span> real<span class="main">^</span><span class="numeral">2</span> <span class="main">⇒</span> real<span class="main">^</span><span class="numeral">2</span>"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">f</span>"</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">f</span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="keyword1">χ</span> <span class="bound">i</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">i</span> <span class="main">=</span> <span class="main">1</span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="numeral">2</span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">ball_flow</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real <span class="main">⇒</span> real <span class="main">⇒</span> real<span class="main">^</span><span class="numeral">2</span> <span class="main">⇒</span> real<span class="main">^</span><span class="numeral">2</span>"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">φ</span>"</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">φ</span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="keyword1">χ</span> <span class="bound">i</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">i</span> <span class="main">=</span> <span class="main">1</span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">*</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">^</span> <span class="numeral">2</span><span class="main">/</span><span class="numeral">2</span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="numeral">2</span> <span class="main">*</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="main">1</span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">*</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="numeral">2</span><span class="main">)</span>"</span></span>

<span class="comment1">― ‹Verified with differential invariants. ›</span>

<span class="keyword1"><span class="command">named_theorems</span></span> bb_real_arith <span class="quoted">"real arithmetic properties for the bouncing ball."</span>

<span class="keyword1"><span class="command">lemma</span></span> inv_imp_pos_le<span class="main">[</span><span class="operator">bb_real_arith</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&gt;</span> <span class="free">g</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">*</span> <span class="free">g</span> <span class="main">*</span> <span class="free">x</span> <span class="main">-</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">g</span> <span class="main">*</span> <span class="free">h</span> <span class="main">=</span> <span class="free">v</span> <span class="main">*</span> <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">::</span>real<span class="main">)</span> <span class="main">≤</span> <span class="free">h</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">*</span> <span class="free">v</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">g</span> <span class="main">*</span> <span class="free">x</span> <span class="main">-</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">g</span> <span class="main">*</span> <span class="free">h</span> <span class="main">∧</span> <span class="main">0</span> <span class="main">&gt;</span> <span class="free">g</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> inv <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&gt;</span> <span class="free">g</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> obs<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">*</span> <span class="free">v</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">g</span> <span class="main">*</span> <span class="main">(</span><span class="free">x</span> <span class="main">-</span> <span class="free">h</span><span class="main">)</span> <span class="main">∧</span> <span class="main">0</span> <span class="main">&gt;</span> <span class="free">g</span> <span class="main">∧</span> <span class="free">v</span> <span class="main">*</span> <span class="free">v</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> left_diff_distrib mult.commute <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> zero_le_square<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">v</span> <span class="main">*</span> <span class="free">v</span><span class="main">)</span><span class="main">/</span><span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">g</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span> <span class="main">-</span> <span class="free">h</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> obs <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">v</span> <span class="main">*</span> <span class="free">v</span><span class="main">)</span><span class="main">/</span><span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">g</span><span class="main">)</span> <span class="main">≤</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> divide_nonneg_neg <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">-</span> <span class="free">x</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> bouncing_ball_inv<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">h</span><span class="main">::</span><span class="quoted">real</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free">h</span> <span class="main">≥</span> <span class="main">0</span> <span class="main">⟹</span> <span class="main">⌈</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">=</span> <span class="free">h</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span> <span class="main">=</span> <span class="main">0</span><span class="main">⌉</span> <span class="main">≤</span>
  <span class="keyword1">wp</span>
    <span class="main">(</span><span class="keyword1">LOOP</span>
      <span class="main">(</span><span class="main">(</span><span class="keyword1">x´=</span> <span class="keyword1">f</span> <span class="free">g</span> <span class="main">&amp;</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">≥</span> <span class="main">0</span><span class="main">)</span> <span class="keyword1">DINV</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">g</span> <span class="main">*</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">-</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">g</span> <span class="main">*</span> <span class="free">h</span> <span class="main">-</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span> <span class="main">*</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
       <span class="main">(</span><span class="keyword1">IF</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="keyword1">THEN</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">::=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">-</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">ELSE</span> skip<span class="main">)</span><span class="main">)</span>
    <span class="keyword1">INV</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">∧</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">g</span> <span class="main">*</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">-</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">g</span> <span class="main">*</span> <span class="free">h</span> <span class="main">-</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span> <span class="main">*</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span>
  <span class="main">)</span> <span class="main">⌈</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">≤</span> <span class="free">h</span><span class="main">⌉</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> wp_loopI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">bb_real_arith</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> wp_g_odei<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">poly_derivatives</span></span> <span class="dynamic"><span class="dynamic">diff_invariant_rules</span></span><span class="main">)</span>

<span class="comment1">― ‹Verified with annotated dynamics. ›</span>

<span class="keyword1"><span class="command">lemma</span></span> inv_conserv_at_ground<span class="main">[</span><span class="operator">bb_real_arith</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> invar<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">*</span> <span class="free">g</span> <span class="main">*</span> <span class="free">x</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">g</span> <span class="main">*</span> <span class="free">h</span> <span class="main">+</span> <span class="free">v</span> <span class="main">*</span> <span class="free">v</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> pos<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">*</span> <span class="free">τ</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">+</span> <span class="free">v</span> <span class="main">*</span> <span class="free">τ</span> <span class="main">+</span> <span class="main">(</span><span class="free">x</span><span class="main">::</span>real<span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">*</span> <span class="free">g</span> <span class="main">*</span> <span class="free">h</span> <span class="main">+</span> <span class="main">(</span><span class="free">g</span> <span class="main">*</span> <span class="free">τ</span> <span class="main">*</span> <span class="main">(</span><span class="free">g</span> <span class="main">*</span> <span class="free">τ</span> <span class="main">+</span> <span class="free">v</span><span class="main">)</span> <span class="main">+</span> <span class="free">v</span> <span class="main">*</span> <span class="main">(</span><span class="free">g</span> <span class="main">*</span> <span class="free">τ</span> <span class="main">+</span> <span class="free">v</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> pos <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">*</span> <span class="free">τ</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span>  <span class="main">+</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">v</span> <span class="main">*</span> <span class="free">τ</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">*</span> <span class="free">τ</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span>  <span class="main">+</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">g</span> <span class="main">*</span> <span class="free">v</span> <span class="main">*</span> <span class="free">τ</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">g</span> <span class="main">*</span> <span class="free">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> Groups.mult_ac<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>3<span class="main"><span class="main">)</span></span> mult_zero_right
        monoid_mult_class.power2_eq_square semiring_class.distrib_left<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">*</span> <span class="free">τ</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">g</span> <span class="main">*</span> <span class="free">v</span> <span class="main">*</span> <span class="free">τ</span> <span class="main">+</span> <span class="free">v</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">g</span> <span class="main">*</span> <span class="free">h</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> invar <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> monoid_mult_class.power2_eq_square<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> obs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">g</span> <span class="main">*</span> <span class="free">τ</span> <span class="main">+</span> <span class="free">v</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">g</span> <span class="main">*</span> <span class="free">h</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> power2_sum<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> Groups.add_ac<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">,</span></span> 3<span class="main"><span class="main">)</span></span>
        Groups.mult_ac<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">,</span></span> 3<span class="main"><span class="main">)</span></span> monoid_mult_class.power2_eq_square nat_distrib<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">*</span> <span class="free">g</span> <span class="main">*</span> <span class="free">h</span> <span class="main">+</span> <span class="main">(</span><span class="free">g</span> <span class="main">*</span> <span class="free">τ</span> <span class="main">*</span> <span class="main">(</span><span class="free">g</span> <span class="main">*</span> <span class="free">τ</span> <span class="main">+</span> <span class="free">v</span><span class="main">)</span> <span class="main">+</span> <span class="free">v</span> <span class="main">*</span> <span class="main">(</span><span class="free">g</span> <span class="main">*</span> <span class="free">τ</span> <span class="main">+</span> <span class="free">v</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> monoid_mult_class.power2_eq_square<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> inv_conserv_at_air<span class="main">[</span><span class="operator">bb_real_arith</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> invar<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">*</span> <span class="free">g</span> <span class="main">*</span> <span class="free">x</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">g</span> <span class="main">*</span> <span class="free">h</span> <span class="main">+</span> <span class="free">v</span> <span class="main">*</span> <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">*</span> <span class="free">g</span> <span class="main">*</span> <span class="main">(</span><span class="free">g</span> <span class="main">*</span> <span class="free">τ</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">+</span> <span class="free">v</span> <span class="main">*</span> <span class="free">τ</span> <span class="main">+</span> <span class="main">(</span><span class="free">x</span><span class="main">::</span>real<span class="main">)</span><span class="main">)</span> <span class="main">=</span>
  <span class="numeral">2</span> <span class="main">*</span> <span class="free">g</span> <span class="main">*</span> <span class="free">h</span> <span class="main">+</span> <span class="main">(</span><span class="free">g</span> <span class="main">*</span> <span class="free">τ</span> <span class="main">*</span> <span class="main">(</span><span class="free">g</span> <span class="main">*</span> <span class="free">τ</span> <span class="main">+</span> <span class="free">v</span><span class="main">)</span> <span class="main">+</span> <span class="free">v</span> <span class="main">*</span> <span class="main">(</span><span class="free">g</span> <span class="main">*</span> <span class="free">τ</span> <span class="main">+</span> <span class="free">v</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="free">g</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">*</span> <span class="free">τ</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">g</span> <span class="main">*</span> <span class="free">v</span> <span class="main">*</span> <span class="free">τ</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">g</span> <span class="main">*</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span> semiring_normalization_rules<span class="main"><span class="main">(</span></span>29<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="free">g</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">*</span> <span class="free">τ</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">g</span> <span class="main">*</span> <span class="free">v</span> <span class="main">*</span> <span class="free">τ</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">g</span> <span class="main">*</span> <span class="free">h</span> <span class="main">+</span> <span class="free">v</span> <span class="main">*</span> <span class="free">v</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="var">?middle</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">subst</span> invar<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?middle</span>"</span></span><span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span><span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?rhs</span> <span class="main">=</span> <span class="free">g</span> <span class="main">*</span> <span class="free">g</span> <span class="main">*</span> <span class="main">(</span><span class="free">τ</span> <span class="main">*</span> <span class="free">τ</span><span class="main">)</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">g</span> <span class="main">*</span> <span class="free">v</span> <span class="main">*</span> <span class="free">τ</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">g</span> <span class="main">*</span> <span class="free">h</span> <span class="main">+</span> <span class="free">v</span> <span class="main">*</span> <span class="free">v</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Groups.mult_ac<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">,</span></span>3<span class="main"><span class="main">)</span></span> semiring_class.distrib_left<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="var">?middle</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> semiring_normalization_rules<span class="main"><span class="main">(</span></span>29<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?rhs</span> <span class="main">=</span> <span class="var">?middle</span>"</span></span><span class="keyword1"><span class="command">.</span></span><span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> bouncing_ball_dyn<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">h</span><span class="main">::</span><span class="quoted">real</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free">h</span> <span class="main">≥</span> <span class="main">0</span> <span class="main">⟹</span>
  <span class="main">⌈</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">=</span> <span class="free">h</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span> <span class="main">=</span> <span class="main">0</span><span class="main">⌉</span> <span class="main">≤</span> <span class="keyword1">wp</span>
    <span class="main">(</span><span class="keyword1">LOOP</span>
      <span class="main">(</span><span class="main">(</span><span class="keyword1">EVOL</span> <span class="main">(</span><span class="keyword1">φ</span> <span class="free">g</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span><span class="main">)</span> <span class="free">T</span><span class="main">)</span><span class="main">;</span>
      <span class="main">(</span><span class="keyword1">IF</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="keyword1">THEN</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">::=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">-</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">ELSE</span> skip<span class="main">)</span><span class="main">)</span>
    <span class="keyword1">INV</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">∧</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">g</span> <span class="main">*</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">g</span> <span class="main">*</span> <span class="free">h</span> <span class="main">+</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span> <span class="main">*</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span><span class="main">)</span><span class="main">)</span>
  <span class="main">⌈</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">≤</span> <span class="free">h</span><span class="main">⌉</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> wp_loopI<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">bb_real_arith</span></span><span class="main">)</span>

<span class="comment1">― ‹Verified with the flow. ›</span>

<span class="keyword1"><span class="command">lemma</span></span> local_flow_ball<span class="main">:</span> <span class="quoted"><span class="quoted">"local_flow <span class="main">(</span><span class="keyword1">f</span> <span class="free">g</span><span class="main">)</span> UNIV UNIV <span class="main">(</span><span class="keyword1">φ</span> <span class="free">g</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> local_lipschitz_def lipschitz_on_def vec_eq_iff<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">1</span><span class="main">/</span><span class="numeral">2</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="main">1</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dist_norm norm_vec_def L2_set_def UNIV_2<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> forall_2 <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">poly_derivatives</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> bouncing_ball_flow<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">h</span><span class="main">::</span><span class="quoted">real</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free">h</span> <span class="main">≥</span> <span class="main">0</span> <span class="main">⟹</span>
  <span class="main">⌈</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">=</span> <span class="free">h</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span> <span class="main">=</span> <span class="main">0</span><span class="main">⌉</span> <span class="main">≤</span> <span class="keyword1">wp</span>
    <span class="main">(</span><span class="keyword1">LOOP</span>
      <span class="main">(</span><span class="main">(</span><span class="keyword1">x´=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="keyword1">f</span> <span class="free">g</span><span class="main">)</span> <span class="main">&amp;</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">≥</span> <span class="main">0</span><span class="main">)</span> <span class="keyword1">on</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> UNIV<span class="main">)</span> UNIV <span class="main">@</span> <span class="main">0</span><span class="main">)</span><span class="main">;</span>
      <span class="main">(</span><span class="keyword1">IF</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="keyword1">THEN</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">::=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">-</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">ELSE</span> skip<span class="main">)</span><span class="main">)</span>
    <span class="keyword1">INV</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">∧</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">g</span> <span class="main">*</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">g</span> <span class="main">*</span> <span class="free">h</span> <span class="main">+</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span> <span class="main">*</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span><span class="main">)</span><span class="main">)</span>
  <span class="main">⌈</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">≤</span> <span class="free">h</span><span class="main">⌉</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> wp_loopI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> local_flow.wp_g_ode_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> local_flow_ball<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">bb_real_arith</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">no_notation</span></span> fball <span class="main">(</span><span class="quoted">"<span class="keyword1">f</span>"</span><span class="main">)</span>
        <span class="keyword2"><span class="keyword">and</span></span> ball_flow <span class="main">(</span><span class="quoted">"<span class="keyword1">φ</span>"</span><span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹ Thermostat ›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ A thermostat has a chronometer, a thermometer and a switch to turn on and off a heater.
At most every <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"t"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> minutes, it sets its chronometer to <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">0</span></span><span class="main"><span class="main">::</span></span>real"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, it registers
the room temperature, and it turns the heater on (or off) based on this reading. The temperature
follows the ODE <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"T' = - a * (T - U)"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> where <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"U"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"L ≥ 0"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> when the heater
is on, and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"0"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> when it is off. We use <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">1</span></span><span class="main"><span class="main">::</span></span><span class="numeral"><span class="numeral">4</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> to denote the room's temperature,
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="numeral"><span class="numeral">2</span></span><span class="main"><span class="main">::</span></span><span class="numeral"><span class="numeral">4</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is time as measured by the thermostat's chronometer, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="numeral"><span class="numeral">3</span></span><span class="main"><span class="main">::</span></span><span class="numeral"><span class="numeral">4</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is the
temperature detected by the thermometer, and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="numeral"><span class="numeral">4</span></span><span class="main"><span class="main">::</span></span><span class="numeral"><span class="numeral">4</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> states whether the heater is on
(<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"s$4 = 1"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>) or off (<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"s$4 = 0"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>). We prove that the thermostat keeps the room's
temperature between <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"Tmin"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"Tmax"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. ›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">temp_vec_field</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real <span class="main">⇒</span> real <span class="main">⇒</span> real<span class="main">^</span><span class="numeral">4</span> <span class="main">⇒</span> real<span class="main">^</span><span class="numeral">4</span>"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">f</span>"</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">f</span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="keyword1">χ</span> <span class="bound">i</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">i</span> <span class="main">=</span> <span class="numeral">2</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">i</span> <span class="main">=</span> <span class="main">1</span> <span class="keyword1">then</span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">*</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="main">1</span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">L</span></span></span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">temp_flow</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real <span class="main">⇒</span> real <span class="main">⇒</span> real <span class="main">⇒</span> real<span class="main">^</span><span class="numeral">4</span> <span class="main">⇒</span> real<span class="main">^</span><span class="numeral">4</span>"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">φ</span>"</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">φ</span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="keyword1">χ</span> <span class="bound">i</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">i</span> <span class="main">=</span> <span class="main">1</span> <span class="keyword1">then</span> <span class="main">-</span> exp<span class="main">(</span><span class="main">-</span><span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">*</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="keyword1">else</span>
  <span class="main">(</span><span class="keyword1">if</span> <span class="bound">i</span> <span class="main">=</span> <span class="numeral">2</span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="numeral">2</span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="comment1">― ‹Verified with the flow. ›</span>

<span class="keyword1"><span class="command">lemma</span></span> norm_diff_temp_dyn<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">a</span> <span class="main">⟹</span> <span class="main">∥</span><span class="keyword1">f</span> <span class="free">a</span> <span class="free">L</span> <span class="free">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">-</span> <span class="keyword1">f</span> <span class="free">a</span> <span class="free">L</span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub></span><span class="main">∥</span> <span class="main">=</span> <span class="main">¦</span><span class="free">a</span><span class="main">¦</span> <span class="main">*</span> <span class="main">¦</span><span class="free">s<span class="hidden">⇩</span><sub>1</sub></span><span class="main">$</span><span class="main">1</span> <span class="main">-</span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub></span><span class="main">$</span><span class="main">1</span><span class="main">¦</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> norm_vec_def L2_set_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> UNIV_4<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> a1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> f2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">r</span> <span class="bound">ra</span><span class="main">.</span> <span class="main">¦</span><span class="main">(</span><span class="bound">r</span><span class="main">::</span>real<span class="main">)</span> <span class="main">+</span> <span class="main">-</span> <span class="bound">ra</span><span class="main">¦</span> <span class="main">=</span> <span class="main">¦</span><span class="bound">ra</span> <span class="main">+</span> <span class="main">-</span> <span class="bound">r</span><span class="main">¦</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> abs_minus_commute minus_real_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">r</span> <span class="bound">ra</span> <span class="bound">rb</span><span class="main">.</span> <span class="main">(</span><span class="bound">r</span><span class="main">::</span>real<span class="main">)</span> <span class="main">*</span> <span class="bound">ra</span> <span class="main">+</span> <span class="main">-</span> <span class="main">(</span><span class="bound">r</span> <span class="main">*</span> <span class="bound">rb</span><span class="main">)</span> <span class="main">=</span> <span class="bound">r</span> <span class="main">*</span> <span class="main">(</span><span class="bound">ra</span> <span class="main">+</span> <span class="main">-</span> <span class="bound">rb</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> minus_real_def right_diff_distrib<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="free">a</span> <span class="main">*</span> <span class="main">(</span><span class="free">s<span class="hidden">⇩</span><sub>1</sub></span><span class="main">$</span><span class="main">1</span> <span class="main">+</span> <span class="main">-</span> <span class="free">L</span><span class="main">)</span> <span class="main">+</span> <span class="main">-</span> <span class="main">(</span><span class="free">a</span> <span class="main">*</span> <span class="main">(</span><span class="free">s<span class="hidden">⇩</span><sub>2</sub></span><span class="main">$</span><span class="main">1</span> <span class="main">+</span> <span class="main">-</span> <span class="free">L</span><span class="main">)</span><span class="main">)</span><span class="main">¦</span> <span class="main">=</span> <span class="free">a</span> <span class="main">*</span> <span class="main">¦</span><span class="free">s<span class="hidden">⇩</span><sub>1</sub></span><span class="main">$</span><span class="main">1</span> <span class="main">+</span> <span class="main">-</span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub></span><span class="main">$</span><span class="main">1</span><span class="main">¦</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> a1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> abs_mult<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="free">a</span> <span class="main">*</span> <span class="main">(</span><span class="free">s<span class="hidden">⇩</span><sub>2</sub></span><span class="main">$</span><span class="main">1</span> <span class="main">-</span> <span class="free">L</span><span class="main">)</span> <span class="main">-</span> <span class="free">a</span> <span class="main">*</span> <span class="main">(</span><span class="free">s<span class="hidden">⇩</span><sub>1</sub></span><span class="main">$</span><span class="main">1</span> <span class="main">-</span> <span class="free">L</span><span class="main">)</span><span class="main">¦</span> <span class="main">=</span> <span class="free">a</span> <span class="main">*</span> <span class="main">¦</span><span class="free">s<span class="hidden">⇩</span><sub>1</sub></span><span class="main">$</span><span class="main">1</span> <span class="main">-</span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub></span><span class="main">$</span><span class="main">1</span><span class="main">¦</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> f2 minus_real_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> local_lipschitz_temp_dyn<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="main">(</span><span class="free">a</span><span class="main">::</span>real<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"local_lipschitz UNIV UNIV <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">::</span>real<span class="main">.</span> <span class="keyword1">f</span> <span class="free">a</span> <span class="free">L</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">unfold</span> local_lipschitz_def lipschitz_on_def dist_norm<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="main">1</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">a</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> norm_diff_temp_dyn<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> norm_vec_def L2_set_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> UNIV_4<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> real_sqrt_abs<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> real_le_lsqrt<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> local_flow_temp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟹</span> local_flow <span class="main">(</span><span class="keyword1">f</span> <span class="free">a</span> <span class="free">L</span><span class="main">)</span> UNIV UNIV <span class="main">(</span><span class="keyword1">φ</span> <span class="free">a</span> <span class="free">L</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">poly_derivatives</span></span> local_lipschitz_temp_dyn <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> forall_4 vec_eq_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> temp_dyn_down_real_arith<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> Thyps<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">Tmin</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">Tmin</span> <span class="main">≤</span> <span class="free">T</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">T</span> <span class="main">≤</span> <span class="free">Tmax</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> thyps<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="main">(</span><span class="free">t</span><span class="main">::</span>real<span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">τ</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">t</span><span class="main">}</span><span class="main">.</span> <span class="bound">τ</span> <span class="main">≤</span> <span class="main">-</span> <span class="main">(</span>ln <span class="main">(</span><span class="free">Tmin</span> <span class="main">/</span> <span class="free">T</span><span class="main">)</span> <span class="main">/</span> <span class="free">a</span><span class="main">)</span> "</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Tmin</span> <span class="main">≤</span> exp <span class="main">(</span><span class="main">-</span><span class="free">a</span> <span class="main">*</span> <span class="free">t</span><span class="main">)</span> <span class="main">*</span> <span class="free">T</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"exp <span class="main">(</span><span class="main">-</span><span class="free">a</span> <span class="main">*</span> <span class="free">t</span><span class="main">)</span> <span class="main">*</span> <span class="free">T</span> <span class="main">≤</span> <span class="free">Tmax</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">t</span> <span class="main">∧</span> <span class="free">t</span> <span class="main">≤</span> <span class="main">-</span> <span class="main">(</span>ln <span class="main">(</span><span class="free">Tmin</span> <span class="main">/</span> <span class="free">T</span><span class="main">)</span> <span class="main">/</span> <span class="free">a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> thyps <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"ln <span class="main">(</span><span class="free">Tmin</span> <span class="main">/</span> <span class="free">T</span><span class="main">)</span> <span class="main">≤</span> <span class="main">-</span> <span class="free">a</span> <span class="main">*</span> <span class="free">t</span> <span class="main">∧</span> <span class="main">-</span> <span class="free">a</span> <span class="main">*</span> <span class="free">t</span> <span class="main">≤</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> divide_le_cancel <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Tmin</span> <span class="main">/</span> <span class="free">T</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Thyps <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> obs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Tmin</span> <span class="main">/</span> <span class="free">T</span> <span class="main">≤</span> exp <span class="main">(</span><span class="main">-</span><span class="free">a</span> <span class="main">*</span> <span class="free">t</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"exp <span class="main">(</span><span class="main">-</span><span class="free">a</span> <span class="main">*</span> <span class="free">t</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> exp_ln exp_le_one_iff <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> exp_less_cancel_iff not_less<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">Tmin</span> <span class="main">≤</span> exp <span class="main">(</span><span class="main">-</span><span class="free">a</span> <span class="main">*</span> <span class="free">t</span><span class="main">)</span> <span class="main">*</span> <span class="free">T</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Thyps <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pos_divide_le_eq<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"exp <span class="main">(</span><span class="main">-</span><span class="free">a</span> <span class="main">*</span> <span class="free">t</span><span class="main">)</span> <span class="main">*</span> <span class="free">T</span> <span class="main">≤</span> <span class="free">Tmax</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Thyps mult_left_le_one_le<span class="main">[</span><span class="operator">OF</span> _ exp_ge_zero obs<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">T</span></span><span class="main">]</span>
      less_eq_real_def order_trans_rules<span class="main">(</span>23<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> temp_dyn_up_real_arith<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> Thyps<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Tmin</span> <span class="main">≤</span> <span class="free">T</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">T</span> <span class="main">≤</span> <span class="free">Tmax</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">Tmax</span> <span class="main">&lt;</span> <span class="main">(</span><span class="free">L</span><span class="main">::</span>real<span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> thyps<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">τ</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">t</span><span class="main">}</span><span class="main">.</span> <span class="bound">τ</span> <span class="main">≤</span> <span class="main">-</span> <span class="main">(</span>ln <span class="main">(</span><span class="main">(</span><span class="free">L</span> <span class="main">-</span> <span class="free">Tmax</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="free">L</span> <span class="main">-</span> <span class="free">T</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> <span class="free">a</span><span class="main">)</span> "</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">L</span> <span class="main">-</span> <span class="free">Tmax</span> <span class="main">≤</span> exp <span class="main">(</span><span class="main">-</span><span class="main">(</span><span class="free">a</span> <span class="main">*</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">L</span> <span class="main">-</span> <span class="free">T</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">L</span> <span class="main">-</span> exp <span class="main">(</span><span class="main">-</span><span class="main">(</span><span class="free">a</span> <span class="main">*</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">L</span> <span class="main">-</span> <span class="free">T</span><span class="main">)</span> <span class="main">≤</span> <span class="free">Tmax</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">Tmin</span> <span class="main">≤</span> <span class="free">L</span> <span class="main">-</span> exp <span class="main">(</span><span class="main">-</span><span class="main">(</span><span class="free">a</span> <span class="main">*</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">L</span> <span class="main">-</span> <span class="free">T</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">t</span> <span class="main">∧</span> <span class="free">t</span> <span class="main">≤</span> <span class="main">-</span> <span class="main">(</span>ln <span class="main">(</span><span class="main">(</span><span class="free">L</span> <span class="main">-</span> <span class="free">Tmax</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="free">L</span> <span class="main">-</span> <span class="free">T</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> <span class="free">a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> thyps <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"ln <span class="main">(</span><span class="main">(</span><span class="free">L</span> <span class="main">-</span> <span class="free">Tmax</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="free">L</span> <span class="main">-</span> <span class="free">T</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="main">-</span> <span class="free">a</span> <span class="main">*</span> <span class="free">t</span> <span class="main">∧</span> <span class="main">-</span> <span class="free">a</span> <span class="main">*</span> <span class="free">t</span> <span class="main">≤</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> divide_le_cancel <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">L</span> <span class="main">-</span> <span class="free">Tmax</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="free">L</span> <span class="main">-</span> <span class="free">T</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Thyps <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">L</span> <span class="main">-</span> <span class="free">Tmax</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="free">L</span> <span class="main">-</span> <span class="free">T</span><span class="main">)</span> <span class="main">≤</span> exp <span class="main">(</span><span class="main">-</span><span class="free">a</span> <span class="main">*</span> <span class="free">t</span><span class="main">)</span> <span class="main">∧</span> exp <span class="main">(</span><span class="main">-</span><span class="free">a</span> <span class="main">*</span> <span class="free">t</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> exp_ln exp_le_one_iff <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> exp_less_cancel_iff not_less<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">L</span> <span class="main">-</span> <span class="free">T</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Thyps <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> obs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">L</span> <span class="main">-</span> <span class="free">Tmax</span><span class="main">)</span> <span class="main">≤</span> exp <span class="main">(</span><span class="main">-</span><span class="free">a</span> <span class="main">*</span> <span class="free">t</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">L</span> <span class="main">-</span> <span class="free">T</span><span class="main">)</span> <span class="main">∧</span> exp <span class="main">(</span><span class="main">-</span><span class="free">a</span> <span class="main">*</span> <span class="free">t</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">L</span> <span class="main">-</span> <span class="free">T</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="free">L</span> <span class="main">-</span> <span class="free">T</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pos_divide_le_eq<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">L</span> <span class="main">-</span> <span class="free">Tmax</span><span class="main">)</span> <span class="main">≤</span> exp <span class="main">(</span><span class="main">-</span><span class="main">(</span><span class="free">a</span> <span class="main">*</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">L</span> <span class="main">-</span> <span class="free">T</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">L</span> <span class="main">-</span> exp <span class="main">(</span><span class="main">-</span><span class="main">(</span><span class="free">a</span> <span class="main">*</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">L</span> <span class="main">-</span> <span class="free">T</span><span class="main">)</span> <span class="main">≤</span> <span class="free">Tmax</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">Tmin</span> <span class="main">≤</span> <span class="free">L</span> <span class="main">-</span> exp <span class="main">(</span><span class="main">-</span><span class="main">(</span><span class="free">a</span> <span class="main">*</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">L</span> <span class="main">-</span> <span class="free">T</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Thyps <span class="keyword2"><span class="keyword">and</span></span> obs <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> fbox_temp_dyn <span class="main">=</span> local_flow.wp_g_ode_subset<span class="main">[</span><span class="operator">OF</span> local_flow_temp<span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> thermostat<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">Tmin</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">Tmax</span> <span class="main">&lt;</span> <span class="free">L</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⌈</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">Tmin</span> <span class="main">≤</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">≤</span> <span class="free">Tmax</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">4</span> <span class="main">=</span> <span class="main">0</span><span class="main">⌉</span> <span class="main">≤</span> <span class="keyword1">wp</span>
  <span class="main">(</span><span class="keyword1">LOOP</span>
    <span class="comment1">― ‹control›</span>
    <span class="main">(</span><span class="main">(</span><span class="numeral">2</span> <span class="main">::=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">;</span><span class="main">(</span><span class="numeral">3</span> <span class="main">::=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
    <span class="main">(</span><span class="keyword1">IF</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">4</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">3</span> <span class="main">≤</span> <span class="free">Tmin</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">THEN</span> <span class="main">(</span><span class="numeral">4</span> <span class="main">::=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">ELSE</span>
    <span class="main">(</span><span class="keyword1">IF</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">4</span> <span class="main">=</span> <span class="main">1</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">3</span> <span class="main">≥</span> <span class="free">Tmax</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">THEN</span> <span class="main">(</span><span class="numeral">4</span> <span class="main">::=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span><span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">ELSE</span> skip<span class="main">)</span><span class="main">)</span><span class="main">;</span>
    <span class="comment1">― ‹dynamics›</span>
    <span class="main">(</span><span class="keyword1">IF</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">4</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="keyword1">THEN</span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="keyword1">f</span> <span class="free">a</span> <span class="main">0</span> <span class="main">&amp;</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span> <span class="main">≤</span> <span class="main">-</span> <span class="main">(</span>ln <span class="main">(</span><span class="free">Tmin</span><span class="main">/</span><span class="bound">s</span><span class="main">$</span><span class="numeral">3</span><span class="main">)</span><span class="main">)</span><span class="main">/</span><span class="free">a</span><span class="main">)</span><span class="main">)</span>
    <span class="keyword1">ELSE</span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="keyword1">f</span> <span class="free">a</span> <span class="free">L</span> <span class="main">&amp;</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span> <span class="main">≤</span> <span class="main">-</span> <span class="main">(</span>ln <span class="main">(</span><span class="main">(</span><span class="free">L</span><span class="main">-</span><span class="free">Tmax</span><span class="main">)</span><span class="main">/</span><span class="main">(</span><span class="free">L</span><span class="main">-</span><span class="bound">s</span><span class="main">$</span><span class="numeral">3</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">/</span><span class="free">a</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">)</span>
  <span class="keyword1">INV</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">Tmin</span> <span class="main">≤</span><span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">≤</span> <span class="free">Tmax</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">s</span><span class="main">$</span><span class="numeral">4</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">4</span> <span class="main">=</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
  <span class="main">⌈</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">Tmin</span> <span class="main">≤</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">≤</span> <span class="free">Tmax</span><span class="main">⌉</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> wp_loopI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fbox_temp_dyn<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> temp_dyn_up_real_arith<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span>1<span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span> _ _ assms<span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span>3<span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">Tmin</span></span></span></span></span></span><span class="main">]</span>
    <span class="keyword2"><span class="keyword">and</span></span> temp_dyn_down_real_arith<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">,</span></span></span>2<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main">,</span> <span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">Tmax</span></span></span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">no_notation</span></span> temp_vec_field <span class="main">(</span><span class="quoted">"<span class="keyword1">f</span>"</span><span class="main">)</span>
        <span class="keyword2"><span class="keyword">and</span></span> temp_flow <span class="main">(</span><span class="quoted">"<span class="keyword1">φ</span>"</span><span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹ Tank ›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ A controller turns a water pump on and off to keep the level of water <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"h"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> in a tank
within an acceptable range <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"hmin ≤ h ≤ hmax"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. Just like in the previous example, after 
each intervention, the controller registers the current level of water and resets its chronometer,
then it changes the status of the water pump accordingly. The level of water grows linearly 
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"h' = k"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> at a rate of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"k = c<span class="hidden">⇩</span><sub>i</sub>-c<span class="hidden">⇩</span><sub>o</sub>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> if the pump is on, and at a rate of 
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"k = -c<span class="hidden">⇩</span><sub>o</sub>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> if the pump is off. We use <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">1</span></span><span class="main"><span class="main">::</span></span><span class="numeral"><span class="numeral">4</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> to denote the tank's level of water,
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="numeral"><span class="numeral">2</span></span><span class="main"><span class="main">::</span></span><span class="numeral"><span class="numeral">4</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is time as measured by the controller's chronometer, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="numeral"><span class="numeral">3</span></span><span class="main"><span class="main">::</span></span><span class="numeral"><span class="numeral">4</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is the
level of water measured by the chronometer, and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="numeral"><span class="numeral">4</span></span><span class="main"><span class="main">::</span></span><span class="numeral"><span class="numeral">4</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> states whether the pump is on
(<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"s$4 = 1"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>) or off (<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"s$4 = 0"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>). We prove that the controller keeps the level of
water between <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"hmin"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"hmax"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. ›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">tank_vec_field</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real <span class="main">⇒</span> real<span class="main">^</span><span class="numeral">4</span> <span class="main">⇒</span> real<span class="main">^</span><span class="numeral">4</span>"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">f</span>"</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">f</span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="keyword1">χ</span> <span class="bound">i</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">i</span> <span class="main">=</span> <span class="numeral">2</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">i</span> <span class="main">=</span> <span class="main">1</span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">tank_flow</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real <span class="main">⇒</span> real <span class="main">⇒</span> real<span class="main">^</span><span class="numeral">4</span> <span class="main">⇒</span> real<span class="main">^</span><span class="numeral">4</span>"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">φ</span>"</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">φ</span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="keyword1">χ</span> <span class="bound">i</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">i</span> <span class="main">=</span> <span class="main">1</span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">*</span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="main">1</span> <span class="keyword1">else</span> 
  <span class="main">(</span><span class="keyword1">if</span> <span class="bound">i</span> <span class="main">=</span> <span class="numeral">2</span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="numeral">2</span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">tank_guard</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real <span class="main">⇒</span> real <span class="main">⇒</span> real<span class="main">^</span><span class="numeral">4</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">G</span>"</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">G</span></span> <span class="free"><span class="bound"><span class="entity">Hm</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="numeral">2</span> <span class="main">≤</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Hm</span></span></span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="numeral">3</span><span class="main">)</span><span class="main">/</span><span class="free"><span class="bound"><span class="entity">k</span></span></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">tank_loop_inv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real <span class="main">⇒</span> real <span class="main">⇒</span> real<span class="main">^</span><span class="numeral">4</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">I</span>"</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">I</span></span> <span class="free"><span class="bound"><span class="entity">hmin</span></span></span> <span class="free"><span class="bound"><span class="entity">hmax</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">hmin</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="main">1</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="main">1</span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">hmax</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="numeral">4</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="numeral">4</span> <span class="main">=</span> <span class="main">1</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">tank_diff_inv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real <span class="main">⇒</span> real <span class="main">⇒</span> real <span class="main">⇒</span> real<span class="main">^</span><span class="numeral">4</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">dI</span>"</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">dI</span></span> <span class="free"><span class="bound"><span class="entity">hmin</span></span></span> <span class="free"><span class="bound"><span class="entity">hmax</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="main">1</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">*</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="numeral">2</span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="numeral">3</span> <span class="main">∧</span> <span class="main">0</span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="numeral">2</span> <span class="main">∧</span> 
    <span class="free"><span class="bound"><span class="entity">hmin</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="numeral">3</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="numeral">3</span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">hmax</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="numeral">4</span> <span class="main">=</span><span class="main">0</span> <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="numeral">4</span> <span class="main">=</span> <span class="main">1</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> local_flow_tank<span class="main">:</span> <span class="quoted"><span class="quoted">"local_flow <span class="main">(</span><span class="keyword1">f</span> <span class="free">k</span><span class="main">)</span> UNIV UNIV <span class="main">(</span><span class="keyword1">φ</span> <span class="free">k</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> local_lipschitz_def lipschitz_on_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">1</span><span class="main">/</span><span class="numeral">2</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="main">1</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dist_norm norm_vec_def L2_set_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> UNIV_4<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">poly_derivatives</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> vec_eq_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> tank_arith<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="main">(</span><span class="free">τ</span><span class="main">::</span>real<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">c<span class="hidden">⇩</span><sub>o</sub></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">c<span class="hidden">⇩</span><sub>o</sub></span> <span class="main">&lt;</span> <span class="free">c<span class="hidden">⇩</span><sub>i</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">τ</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">τ</span><span class="main">}</span><span class="main">.</span> <span class="bound">τ</span> <span class="main">≤</span> <span class="main">-</span> <span class="main">(</span><span class="main">(</span><span class="free">hmin</span> <span class="main">-</span> <span class="free">y</span><span class="main">)</span> <span class="main">/</span> <span class="free">c<span class="hidden">⇩</span><sub>o</sub></span><span class="main">)</span> <span class="main">⟹</span>  <span class="free">hmin</span> <span class="main">≤</span> <span class="free">y</span> <span class="main">-</span> <span class="free">c<span class="hidden">⇩</span><sub>o</sub></span> <span class="main">*</span> <span class="free">τ</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">τ</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">τ</span><span class="main">}</span><span class="main">.</span> <span class="bound">τ</span> <span class="main">≤</span> <span class="main">(</span><span class="free">hmax</span> <span class="main">-</span> <span class="free">y</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="free">c<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">-</span> <span class="free">c<span class="hidden">⇩</span><sub>o</sub></span><span class="main">)</span> <span class="main">⟹</span>  <span class="main">(</span><span class="free">c<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">-</span> <span class="free">c<span class="hidden">⇩</span><sub>o</sub></span><span class="main">)</span> <span class="main">*</span> <span class="free">τ</span> <span class="main">+</span> <span class="free">y</span> <span class="main">≤</span> <span class="free">hmax</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">hmin</span> <span class="main">≤</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">hmin</span> <span class="main">≤</span> <span class="main">(</span><span class="free">c<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">-</span> <span class="free">c<span class="hidden">⇩</span><sub>o</sub></span><span class="main">)</span> <span class="main">*</span> <span class="free">τ</span> <span class="main">+</span> <span class="free">y</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">≤</span> <span class="free">hmax</span> <span class="main">⟹</span> <span class="free">y</span> <span class="main">-</span> <span class="free">c<span class="hidden">⇩</span><sub>o</sub></span> <span class="main">*</span> <span class="free">τ</span> <span class="main">≤</span> <span class="free">hmax</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span> le_divide_eq assms<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">meson</span> add_mono less_eq_real_def mult_left_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> add_increasing2 less_eq_real_def mult_nonneg_nonneg<span class="main">)</span> 

<span class="keyword1"><span class="command">lemma</span></span> tank_flow<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">c<span class="hidden">⇩</span><sub>o</sub></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">c<span class="hidden">⇩</span><sub>o</sub></span> <span class="main">&lt;</span> <span class="free">c<span class="hidden">⇩</span><sub>i</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⌈</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="keyword1">I</span> <span class="free">hmin</span> <span class="free">hmax</span> <span class="bound">s</span><span class="main">⌉</span> <span class="main">≤</span> <span class="keyword1">wp</span>
  <span class="main">(</span><span class="keyword1">LOOP</span> 
    <span class="comment1">― ‹control›</span>
    <span class="main">(</span><span class="main">(</span><span class="numeral">2</span> <span class="main">::=</span><span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span><span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">;</span><span class="main">(</span><span class="numeral">3</span> <span class="main">::=</span><span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
    <span class="main">(</span><span class="keyword1">IF</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">4</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">3</span> <span class="main">≤</span> <span class="free">hmin</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">THEN</span> <span class="main">(</span><span class="numeral">4</span> <span class="main">::=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">ELSE</span> 
    <span class="main">(</span><span class="keyword1">IF</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">4</span> <span class="main">=</span> <span class="main">1</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">3</span> <span class="main">≥</span> <span class="free">hmax</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">THEN</span> <span class="main">(</span><span class="numeral">4</span> <span class="main">::=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span><span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">ELSE</span> skip<span class="main">)</span><span class="main">)</span><span class="main">;</span>
    <span class="comment1">― ‹dynamics›</span>
    <span class="main">(</span><span class="keyword1">IF</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">4</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="keyword1">THEN</span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="keyword1">f</span> <span class="main">(</span><span class="free">c<span class="hidden">⇩</span><sub>i</sub></span><span class="main">-</span><span class="free">c<span class="hidden">⇩</span><sub>o</sub></span><span class="main">)</span> <span class="main">&amp;</span> <span class="main">(</span><span class="keyword1">G</span> <span class="free">hmax</span> <span class="main">(</span><span class="free">c<span class="hidden">⇩</span><sub>i</sub></span><span class="main">-</span><span class="free">c<span class="hidden">⇩</span><sub>o</sub></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> 
     <span class="keyword1">ELSE</span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="keyword1">f</span> <span class="main">(</span><span class="main">-</span><span class="free">c<span class="hidden">⇩</span><sub>o</sub></span><span class="main">)</span> <span class="main">&amp;</span> <span class="main">(</span><span class="keyword1">G</span> <span class="free">hmin</span> <span class="main">(</span><span class="main">-</span><span class="free">c<span class="hidden">⇩</span><sub>o</sub></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">)</span> <span class="keyword1">INV</span> <span class="keyword1">I</span> <span class="free">hmin</span> <span class="free">hmax</span><span class="main">)</span> 
  <span class="main">⌈</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="keyword1">I</span> <span class="free">hmin</span> <span class="free">hmax</span> <span class="bound">s</span><span class="main">⌉</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> wp_loopI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> local_flow.wp_g_ode_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> local_flow_tank<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> assms tank_arith<span class="main">[</span><span class="operator">OF</span> _ assms<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">no_notation</span></span> tank_vec_field <span class="main">(</span><span class="quoted">"<span class="keyword1">f</span>"</span><span class="main">)</span>
        <span class="keyword2"><span class="keyword">and</span></span> tank_flow <span class="main">(</span><span class="quoted">"<span class="keyword1">φ</span>"</span><span class="main">)</span>
        <span class="keyword2"><span class="keyword">and</span></span> tank_loop_inv <span class="main">(</span><span class="quoted">"<span class="keyword1">I</span>"</span><span class="main">)</span>
        <span class="keyword2"><span class="keyword">and</span></span> tank_diff_inv <span class="main">(</span><span class="quoted">"<span class="keyword1">dI</span>"</span><span class="main">)</span>
        <span class="keyword2"><span class="keyword">and</span></span> tank_guard <span class="main">(</span><span class="quoted">"<span class="keyword1">G</span>"</span><span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="HS_VC_KAT">
<div class="head">
<h1>Theory HS_VC_KAT</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:       Verification components with Kleene Algebras
    Author:      Jonathan Julián Huerta y Munive, 2020
    Maintainer:  Jonathan Julián Huerta y Munive &lt;jonjulian23@gmail.com&gt;
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹ Verification components with KAT  ›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ We use Kleene algebras with tests to derive rules for verification condition generation and 
refinement laws. ›</span></span>

<span class="keyword1"><span class="command">theory</span></span> HS_VC_KAT
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="../KAT_and_DRA/PHL_KAT.html">KAT_and_DRA.PHL_KAT</a>

<span class="keyword2"><span class="keyword">begin</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹ Hoare logic in KAT ›</span></span> 

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ Here we derive the rules of Hoare Logic. ›</span></span>

<span class="keyword1"><span class="command">notation</span></span> t <span class="main">(</span><span class="quoted">"<span class="keyword1">𝔱𝔱</span>"</span><span class="main">)</span>

<span class="keyword1"><span class="command">hide_const</span></span> t

<span class="keyword1"><span class="command">no_notation</span></span> if_then_else <span class="main">(</span><span class="quoted">"<span class="keyword1">if</span> _ <span class="keyword1">then</span> _ <span class="keyword1">else</span> _ <span class="keyword1">fi</span>"</span> <span class="main">[</span>64<span class="main">,</span>64<span class="main">,</span>64<span class="main">]</span> 63<span class="main">)</span>
        <span class="keyword2"><span class="keyword">and</span></span> HOL.If <span class="main">(</span><span class="quoted">"<span class="keyword3">(</span><span class="keyword1">if</span> <span class="keyword3">(</span>_<span class="keyword3">)</span><span class="keyword3">/ </span><span class="keyword1">then</span> <span class="keyword3">(</span>_<span class="keyword3">)</span><span class="keyword3">/ </span><span class="keyword1">else</span> <span class="keyword3">(</span>_<span class="keyword3">)</span><span class="keyword3">)</span>"</span> <span class="main">[</span>0<span class="main">,</span> 0<span class="main">,</span> 10<span class="main">]</span> 10<span class="main">)</span>
        <span class="keyword2"><span class="keyword">and</span></span> while <span class="main">(</span><span class="quoted">"<span class="keyword1">while</span> _ <span class="keyword1">do</span> _ <span class="keyword1">od</span>"</span> <span class="main">[</span>64<span class="main">,</span>64<span class="main">]</span> 63<span class="main">)</span>

<span class="keyword1"><span class="command">context</span></span> kat <span class="comment1">(* mostly by Victor Gomes, Georg Struth *)</span>
<span class="keyword2"><span class="keyword">begin</span></span>
 
<span class="comment1">― ‹ Definitions of Hoare Triple ›</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Hoare</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">H</span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">H</span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">⟷</span> <span class="keyword1">𝔱𝔱</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">⋅</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">⋅</span> <span class="keyword1">𝔱𝔱</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span>"</span></span> 

<span class="keyword1"><span class="command">lemma</span></span> H_consl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝔱𝔱</span> <span class="free">p</span> <span class="main">≤</span> <span class="keyword1">𝔱𝔱</span> <span class="free">p'</span> <span class="main">⟹</span> <span class="keyword1">H</span> <span class="free">p'</span> <span class="free">x</span> <span class="free">q</span> <span class="main">⟹</span> <span class="keyword1">H</span> <span class="free">p</span> <span class="free">x</span> <span class="free">q</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> Hoare_def phl_cons1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> H_consr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝔱𝔱</span> <span class="free">q'</span> <span class="main">≤</span> <span class="keyword1">𝔱𝔱</span> <span class="free">q</span> <span class="main">⟹</span> <span class="keyword1">H</span> <span class="free">p</span> <span class="free">x</span> <span class="free">q'</span> <span class="main">⟹</span> <span class="keyword1">H</span> <span class="free">p</span> <span class="free">x</span> <span class="free">q</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> Hoare_def phl_cons2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>         

<span class="keyword1"><span class="command">lemma</span></span> H_cons<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝔱𝔱</span> <span class="free">p</span> <span class="main">≤</span> <span class="keyword1">𝔱𝔱</span> <span class="free">p'</span> <span class="main">⟹</span> <span class="keyword1">𝔱𝔱</span> <span class="free">q'</span> <span class="main">≤</span> <span class="keyword1">𝔱𝔱</span> <span class="free">q</span> <span class="main">⟹</span> <span class="keyword1">H</span> <span class="free">p'</span> <span class="free">x</span> <span class="free">q'</span> <span class="main">⟹</span> <span class="keyword1">H</span> <span class="free">p</span> <span class="free">x</span> <span class="free">q</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> H_consl H_consr<span class="main">)</span>

<span class="comment1">― ‹ Skip ›</span>

<span class="keyword1"><span class="command">lemma</span></span> H_skip<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="keyword1">H</span> <span class="free">p</span> <span class="main">1</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Hoare_def<span class="main">)</span>

<span class="comment1">― ‹ Abort ›</span>

<span class="keyword1"><span class="command">lemma</span></span> H_abort<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">H</span> <span class="free">p</span> <span class="main">0</span> <span class="free">q</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Hoare_def<span class="main">)</span>

<span class="comment1">― ‹ Sequential composition ›</span>

<span class="keyword1"><span class="command">lemma</span></span> H_seq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">H</span> <span class="free">p</span> <span class="free">x</span> <span class="free">r</span> <span class="main">⟹</span> <span class="keyword1">H</span> <span class="free">r</span> <span class="free">y</span> <span class="free">q</span> <span class="main">⟹</span> <span class="keyword1">H</span> <span class="free">p</span> <span class="main">(</span><span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span><span class="main">)</span> <span class="free">q</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Hoare_def phl_seq<span class="main">)</span>

<span class="comment1">― ‹ Nondeterministic choice ›</span>

<span class="keyword1"><span class="command">lemma</span></span> H_choice<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">H</span> <span class="free">p</span> <span class="free">x</span> <span class="free">q</span> <span class="main">⟹</span> <span class="keyword1">H</span> <span class="free">p</span> <span class="free">y</span> <span class="free">q</span> <span class="main">⟹</span> <span class="keyword1">H</span> <span class="free">p</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span> <span class="free">q</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> local.distrib_left local.join.sup.mono <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Hoare_def<span class="main">)</span>

<span class="comment1">― ‹ Conditional statement ›</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">kat_cond</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">if</span> _ <span class="keyword1">then</span> _ <span class="keyword1">else</span> _"</span> <span class="main">[</span>64<span class="main">,</span>64<span class="main">,</span>64<span class="main">]</span> 63<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">if</span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="keyword1"><span class="free">then</span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1"><span class="free">else</span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">𝔱𝔱</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">⋅</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">+</span> <span class="keyword1">n</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">⋅</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> H_var<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">H</span> <span class="free">p</span> <span class="free">x</span> <span class="free">q</span> <span class="main">⟷</span> <span class="keyword1">𝔱𝔱</span> <span class="free">p</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">⋅</span> <span class="keyword1">n</span> <span class="free">q</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Hoare_def n_kat_3 t_n_closed<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> H_cond_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">H</span> <span class="free">p</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">r</span> <span class="keyword1">then</span> <span class="free">x</span> <span class="keyword1">else</span> <span class="free">y</span><span class="main">)</span> <span class="free">q</span> <span class="main">⟷</span> <span class="keyword1">H</span> <span class="main">(</span><span class="keyword1">𝔱𝔱</span> <span class="free">p</span> <span class="main">⋅</span> <span class="keyword1">𝔱𝔱</span> <span class="free">r</span><span class="main">)</span> <span class="free">x</span> <span class="free">q</span> <span class="main">∧</span> <span class="keyword1">H</span> <span class="main">(</span><span class="keyword1">𝔱𝔱</span> <span class="free">p</span> <span class="main">⋅</span> <span class="keyword1">n</span> <span class="free">r</span><span class="main">)</span> <span class="free">y</span> <span class="free">q</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">H</span> <span class="free">p</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">r</span> <span class="keyword1">then</span> <span class="free">x</span> <span class="keyword1">else</span> <span class="free">y</span><span class="main">)</span> <span class="free">q</span> <span class="main">⟷</span> <span class="keyword1">𝔱𝔱</span> <span class="free">p</span> <span class="main">⋅</span> <span class="main">(</span><span class="keyword1">𝔱𝔱</span> <span class="free">r</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">+</span> <span class="keyword1">n</span> <span class="free">r</span> <span class="main">⋅</span> <span class="free">y</span><span class="main">)</span> <span class="main">⋅</span> <span class="keyword1">n</span> <span class="free">q</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> H_var kat_cond_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⟷</span> <span class="keyword1">𝔱𝔱</span> <span class="free">p</span> <span class="main">⋅</span> <span class="keyword1">𝔱𝔱</span> <span class="free">r</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">⋅</span> <span class="keyword1">n</span> <span class="free">q</span> <span class="main">+</span> <span class="keyword1">𝔱𝔱</span> <span class="free">p</span> <span class="main">⋅</span> <span class="keyword1">n</span> <span class="free">r</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">⋅</span> <span class="keyword1">n</span> <span class="free">q</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> distrib_left mult_assoc<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⟷</span> <span class="keyword1">𝔱𝔱</span> <span class="free">p</span> <span class="main">⋅</span> <span class="keyword1">𝔱𝔱</span> <span class="free">r</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">⋅</span> <span class="keyword1">n</span> <span class="free">q</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> <span class="keyword1">𝔱𝔱</span> <span class="free">p</span> <span class="main">⋅</span> <span class="keyword1">n</span> <span class="free">r</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">⋅</span> <span class="keyword1">n</span> <span class="free">q</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add_0_left no_trivial_inverse<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> H_var test_mult<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> H_cond<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">H</span> <span class="main">(</span><span class="keyword1">𝔱𝔱</span> <span class="free">p</span> <span class="main">⋅</span> <span class="keyword1">𝔱𝔱</span> <span class="free">r</span><span class="main">)</span> <span class="free">x</span> <span class="free">q</span> <span class="main">⟹</span> <span class="keyword1">H</span> <span class="main">(</span><span class="keyword1">𝔱𝔱</span> <span class="free">p</span> <span class="main">⋅</span> <span class="keyword1">n</span> <span class="free">r</span><span class="main">)</span> <span class="free">y</span> <span class="free">q</span> <span class="main">⟹</span> <span class="keyword1">H</span> <span class="free">p</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">r</span> <span class="keyword1">then</span> <span class="free">x</span> <span class="keyword1">else</span> <span class="free">y</span><span class="main">)</span> <span class="free">q</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> H_cond_iff<span class="main">)</span>

<span class="comment1">― ‹ While loop ›</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">kat_while</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">while</span> _ <span class="keyword1">do</span> _"</span> <span class="main">[</span>64<span class="main">,</span>64<span class="main">]</span> 63<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">while</span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1"><span class="free">do</span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">𝔱𝔱</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">⋅</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="keyword1">n</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">kat_while_inv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">while</span> _ <span class="keyword1">inv</span> _ <span class="keyword1">do</span> _"</span> <span class="main">[</span>64<span class="main">,</span>64<span class="main">,</span>64<span class="main">]</span> 63<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">while</span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="keyword1"><span class="free">inv</span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="keyword1"><span class="free">do</span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="keyword1">while</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="keyword1">do</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> H_exp1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">H</span> <span class="main">(</span><span class="keyword1">𝔱𝔱</span> <span class="free">p</span> <span class="main">⋅</span> <span class="keyword1">𝔱𝔱</span> <span class="free">r</span><span class="main">)</span> <span class="free">x</span> <span class="free">q</span> <span class="main">⟹</span> <span class="keyword1">H</span> <span class="free">p</span> <span class="main">(</span><span class="keyword1">𝔱𝔱</span> <span class="free">r</span> <span class="main">⋅</span> <span class="free">x</span><span class="main">)</span> <span class="free">q</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> Hoare_def n_de_morgan_var2 phl.ht_at_phl_export1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> H_while<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">H</span> <span class="main">(</span><span class="keyword1">𝔱𝔱</span> <span class="free">p</span> <span class="main">⋅</span> <span class="keyword1">𝔱𝔱</span> <span class="free">r</span><span class="main">)</span> <span class="free">x</span> <span class="free">p</span> <span class="main">⟹</span> <span class="keyword1">H</span> <span class="free">p</span> <span class="main">(</span><span class="keyword1">while</span> <span class="free">r</span> <span class="keyword1">do</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">𝔱𝔱</span> <span class="free">p</span> <span class="main">⋅</span> <span class="keyword1">n</span> <span class="free">r</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> a1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">H</span> <span class="main">(</span><span class="keyword1">𝔱𝔱</span> <span class="free">p</span> <span class="main">⋅</span> <span class="keyword1">𝔱𝔱</span> <span class="free">r</span><span class="main">)</span> <span class="free">x</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝔱𝔱</span> <span class="main">(</span><span class="keyword1">𝔱𝔱</span> <span class="free">p</span> <span class="main">⋅</span> <span class="keyword1">n</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">n</span> <span class="free">r</span> <span class="main">⋅</span> <span class="keyword1">𝔱𝔱</span> <span class="free">p</span> <span class="main">⋅</span> <span class="keyword1">n</span> <span class="free">r</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> n_preserve test_mult <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> a1 Hoare_def H_exp1 conway.phl.it_simr phl_export2 kat_while_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> H_while_inv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝔱𝔱</span> <span class="free">p</span> <span class="main">≤</span> <span class="keyword1">𝔱𝔱</span> <span class="free">i</span> <span class="main">⟹</span> <span class="keyword1">𝔱𝔱</span> <span class="free">i</span> <span class="main">⋅</span> <span class="keyword1">n</span> <span class="free">r</span> <span class="main">≤</span> <span class="keyword1">𝔱𝔱</span> <span class="free">q</span> <span class="main">⟹</span> <span class="keyword1">H</span> <span class="main">(</span><span class="keyword1">𝔱𝔱</span> <span class="free">i</span> <span class="main">⋅</span> <span class="keyword1">𝔱𝔱</span> <span class="free">r</span><span class="main">)</span> <span class="free">x</span> <span class="free">i</span> <span class="main">⟹</span> <span class="keyword1">H</span> <span class="free">p</span> <span class="main">(</span><span class="keyword1">while</span> <span class="free">r</span> <span class="keyword1">inv</span> <span class="free">i</span> <span class="keyword1">do</span> <span class="free">x</span><span class="main">)</span> <span class="free">q</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> H_cons H_while test_mult kat_while_inv_def<span class="main">)</span>

<span class="comment1">― ‹ Finite iteration ›</span>

<span class="keyword1"><span class="command">lemma</span></span> H_star<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">H</span> <span class="free">i</span> <span class="free">x</span> <span class="free">i</span> <span class="main">⟹</span> <span class="keyword1">H</span> <span class="free">i</span> <span class="main">(</span><span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span><span class="main">)</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Hoare_def <span class="keyword1"><span class="command">using</span></span> star_sim2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> H_star_inv<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝔱𝔱</span> <span class="free">p</span> <span class="main">≤</span> <span class="keyword1">𝔱𝔱</span> <span class="free">i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">H</span> <span class="free">i</span> <span class="free">x</span> <span class="free">i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">𝔱𝔱</span> <span class="free">i</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="keyword1">𝔱𝔱</span> <span class="free">q</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">H</span> <span class="free">p</span> <span class="main">(</span><span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span><span class="main">)</span> <span class="free">q</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">H</span> <span class="free">i</span> <span class="main">(</span><span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span><span class="main">)</span> <span class="free">i</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> H_star <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">H</span> <span class="free">p</span> <span class="main">(</span><span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span><span class="main">)</span> <span class="free">i</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> Hoare_def <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> phl_cons1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> Hoare_def <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> phl_cons2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">kat_loop_inv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">loop</span> _ <span class="keyword1">inv</span> _ "</span> <span class="main">[</span>64<span class="main">,</span>64<span class="main">]</span> 63<span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">loop</span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1"><span class="free">inv</span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> H_loop<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">H</span> <span class="free">p</span> <span class="free">x</span> <span class="free">p</span> <span class="main">⟹</span> <span class="keyword1">H</span> <span class="free">p</span> <span class="main">(</span><span class="keyword1">loop</span> <span class="free">x</span> <span class="keyword1">inv</span> <span class="free">i</span><span class="main">)</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> kat_loop_inv_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> H_star<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> H_loop_inv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝔱𝔱</span> <span class="free">p</span> <span class="main">≤</span> <span class="keyword1">𝔱𝔱</span> <span class="free">i</span> <span class="main">⟹</span> <span class="keyword1">H</span> <span class="free">i</span> <span class="free">x</span> <span class="free">i</span> <span class="main">⟹</span> <span class="keyword1">𝔱𝔱</span> <span class="free">i</span> <span class="main">≤</span> <span class="keyword1">𝔱𝔱</span> <span class="free">q</span> <span class="main">⟹</span> <span class="keyword1">H</span> <span class="free">p</span> <span class="main">(</span><span class="keyword1">loop</span> <span class="free">x</span> <span class="keyword1">inv</span> <span class="free">i</span><span class="main">)</span> <span class="free">q</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> kat_loop_inv_def <span class="keyword1"><span class="command">using</span></span> H_star_inv <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="comment1">― ‹ Invariants ›</span>

<span class="keyword1"><span class="command">lemma</span></span> H_inv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝔱𝔱</span> <span class="free">p</span> <span class="main">≤</span> <span class="keyword1">𝔱𝔱</span> <span class="free">i</span> <span class="main">⟹</span> <span class="keyword1">𝔱𝔱</span> <span class="free">i</span> <span class="main">≤</span> <span class="keyword1">𝔱𝔱</span> <span class="free">q</span> <span class="main">⟹</span> <span class="keyword1">H</span> <span class="free">i</span> <span class="free">x</span> <span class="free">i</span> <span class="main">⟹</span> <span class="keyword1">H</span> <span class="free">p</span> <span class="free">x</span> <span class="free">q</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> p'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">i</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> q'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">i</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> H_cons<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> H_inv_plus<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝔱𝔱</span> <span class="free">i</span> <span class="main">=</span> <span class="free">i</span> <span class="main">⟹</span> <span class="keyword1">𝔱𝔱</span> <span class="free">j</span> <span class="main">=</span> <span class="free">j</span> <span class="main">⟹</span> <span class="keyword1">H</span> <span class="free">i</span> <span class="free">x</span> <span class="free">i</span> <span class="main">⟹</span>  <span class="keyword1">H</span> <span class="free">j</span> <span class="free">x</span> <span class="free">j</span> <span class="main">⟹</span>  <span class="keyword1">H</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="free">j</span><span class="main">)</span> <span class="free">x</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="free">j</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Hoare_def <span class="keyword1"><span class="command">using</span></span> combine_common_factor
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> add_commute add.left_commute distrib_left join.sup.absorb_iff1 t_add_closed<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> H_inv_mult<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝔱𝔱</span> <span class="free">i</span> <span class="main">=</span> <span class="free">i</span> <span class="main">⟹</span> <span class="keyword1">𝔱𝔱</span> <span class="free">j</span> <span class="main">=</span> <span class="free">j</span> <span class="main">⟹</span> <span class="keyword1">H</span> <span class="free">i</span> <span class="free">x</span> <span class="free">i</span> <span class="main">⟹</span>  <span class="keyword1">H</span> <span class="free">j</span> <span class="free">x</span> <span class="free">j</span> <span class="main">⟹</span>  <span class="keyword1">H</span> <span class="main">(</span><span class="free">i</span> <span class="main">⋅</span> <span class="free">j</span><span class="main">)</span> <span class="free">x</span> <span class="main">(</span><span class="free">i</span> <span class="main">⋅</span> <span class="free">j</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Hoare_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> n_kat_2 n_mult_comm t_mult_closure mult_assoc<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹ refinement KAT ›</span></span> 

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ Here we derive the laws of the refinement calculus. ›</span></span>

<span class="keyword1"><span class="command">class</span></span> rkat <span class="main">=</span> kat <span class="main">+</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free"><span class="free"><span class="free">Ref</span></span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> spec_def<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≤</span> <span class="free">Ref</span> <span class="free">p</span> <span class="free">q</span> <span class="main">⟷</span> <span class="keyword1">H</span> <span class="free">p</span> <span class="free">x</span> <span class="free">q</span>"</span></span>

<span class="keyword2"><span class="keyword">begin</span></span> <span class="comment1">(* mostly by Victor Gomes, Georg Struth *)</span>

<span class="keyword1"><span class="command">lemma</span></span> R1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">H</span> <span class="free">p</span> <span class="main">(</span>Ref <span class="free">p</span> <span class="free">q</span><span class="main">)</span> <span class="free">q</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> spec_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> R2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">H</span> <span class="free">p</span> <span class="free">x</span> <span class="free">q</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">≤</span> Ref <span class="free">p</span> <span class="free">q</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> spec_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> R_cons<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝔱𝔱</span> <span class="free">p</span> <span class="main">≤</span> <span class="keyword1">𝔱𝔱</span> <span class="free">p'</span> <span class="main">⟹</span> <span class="keyword1">𝔱𝔱</span> <span class="free">q'</span> <span class="main">≤</span> <span class="keyword1">𝔱𝔱</span> <span class="free">q</span> <span class="main">⟹</span> Ref <span class="free">p'</span> <span class="free">q'</span> <span class="main">≤</span> Ref <span class="free">p</span> <span class="free">q</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> h1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝔱𝔱</span> <span class="free">p</span> <span class="main">≤</span> <span class="keyword1">𝔱𝔱</span> <span class="free">p'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> h2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝔱𝔱</span> <span class="free">q'</span> <span class="main">≤</span> <span class="keyword1">𝔱𝔱</span> <span class="free">q</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">H</span> <span class="free">p'</span> <span class="main">(</span>Ref <span class="free">p'</span> <span class="free">q'</span><span class="main">)</span> <span class="free">q'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> R1<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">H</span> <span class="free">p</span> <span class="main">(</span>Ref <span class="free">p'</span> <span class="free">q'</span><span class="main">)</span> <span class="free">q</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> h1 h2 H_consl H_consr <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> R2<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">― ‹ Skip ›</span>

<span class="keyword1"><span class="command">lemma</span></span> R_skip<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">≤</span> Ref <span class="free">p</span> <span class="free">p</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">H</span> <span class="free">p</span> <span class="main">1</span> <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> H_skip<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> R2<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">― ‹ Abort ›</span>

<span class="keyword1"><span class="command">lemma</span></span> R_zero_one<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≤</span> Ref <span class="main">0</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">H</span> <span class="main">0</span> <span class="free">x</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Hoare_def<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> R2<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> R_one_zero<span class="main">:</span> <span class="quoted"><span class="quoted">"Ref <span class="main">1</span> <span class="main">0</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">H</span> <span class="main">1</span> <span class="main">(</span>Ref <span class="main">1</span> <span class="main">0</span><span class="main">)</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> R1<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Hoare_def join.le_bot<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> R_abort<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> Ref <span class="free">p</span> <span class="free">q</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> bot_least <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="comment1">― ‹ Sequential composition ›</span>

<span class="keyword1"><span class="command">lemma</span></span> R_seq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Ref <span class="free">p</span> <span class="free">r</span><span class="main">)</span> <span class="main">⋅</span> <span class="main">(</span>Ref <span class="free">r</span> <span class="free">q</span><span class="main">)</span> <span class="main">≤</span> Ref <span class="free">p</span> <span class="free">q</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">H</span> <span class="free">p</span> <span class="main">(</span>Ref <span class="free">p</span> <span class="free">r</span><span class="main">)</span> <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">H</span> <span class="free">r</span> <span class="main">(</span>Ref <span class="free">r</span> <span class="free">q</span><span class="main">)</span> <span class="free">q</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> R1<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">H</span> <span class="free">p</span> <span class="main">(</span><span class="main">(</span>Ref <span class="free">p</span> <span class="free">r</span><span class="main">)</span> <span class="main">⋅</span> <span class="main">(</span>Ref <span class="free">r</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span> <span class="free">q</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> H_seq<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> R2<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">― ‹ Nondeterministic choice ›</span>

<span class="keyword1"><span class="command">lemma</span></span> R_choice<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Ref <span class="free">p</span> <span class="free">q</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span>Ref <span class="free">p</span> <span class="free">q</span><span class="main">)</span> <span class="main">≤</span> Ref <span class="free">p</span> <span class="free">q</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> spec_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> H_choice<span class="main">)</span> <span class="main">(</span><span class="operator">rule</span> R1<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="comment1">― ‹ Conditional statement ›</span>

<span class="keyword1"><span class="command">lemma</span></span> R_cond<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">if</span> <span class="free">v</span> <span class="keyword1">then</span> <span class="main">(</span>Ref <span class="main">(</span><span class="keyword1">𝔱𝔱</span> <span class="free">v</span> <span class="main">⋅</span> <span class="keyword1">𝔱𝔱</span> <span class="free">p</span><span class="main">)</span> <span class="free">q</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">(</span>Ref <span class="main">(</span><span class="keyword1">n</span> <span class="free">v</span> <span class="main">⋅</span> <span class="keyword1">𝔱𝔱</span> <span class="free">p</span><span class="main">)</span> <span class="free">q</span><span class="main">)</span> <span class="main">≤</span> Ref <span class="free">p</span> <span class="free">q</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">H</span> <span class="main">(</span><span class="keyword1">𝔱𝔱</span> <span class="free">v</span> <span class="main">⋅</span> <span class="keyword1">𝔱𝔱</span> <span class="free">p</span><span class="main">)</span> <span class="main">(</span>Ref <span class="main">(</span><span class="keyword1">𝔱𝔱</span> <span class="free">v</span> <span class="main">⋅</span> <span class="keyword1">𝔱𝔱</span> <span class="free">p</span><span class="main">)</span> <span class="free">q</span><span class="main">)</span> <span class="free">q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">H</span> <span class="main">(</span><span class="keyword1">n</span> <span class="free">v</span> <span class="main">⋅</span> <span class="keyword1">𝔱𝔱</span> <span class="free">p</span><span class="main">)</span> <span class="main">(</span>Ref <span class="main">(</span><span class="keyword1">n</span> <span class="free">v</span> <span class="main">⋅</span> <span class="keyword1">𝔱𝔱</span> <span class="free">p</span><span class="main">)</span> <span class="free">q</span><span class="main">)</span> <span class="free">q</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> R1<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">H</span> <span class="free">p</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">v</span> <span class="keyword1">then</span> <span class="main">(</span>Ref <span class="main">(</span><span class="keyword1">𝔱𝔱</span> <span class="free">v</span> <span class="main">⋅</span> <span class="keyword1">𝔱𝔱</span> <span class="free">p</span><span class="main">)</span> <span class="free">q</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">(</span>Ref <span class="main">(</span><span class="keyword1">n</span> <span class="free">v</span> <span class="main">⋅</span> <span class="keyword1">𝔱𝔱</span> <span class="free">p</span><span class="main">)</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span> <span class="free">q</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> H_cond n_mult_comm<span class="main">)</span>
 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> R2<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">― ‹ While loop ›</span>

<span class="keyword1"><span class="command">lemma</span></span> R_while<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">while</span> <span class="free">q</span> <span class="keyword1">do</span> <span class="main">(</span>Ref <span class="main">(</span><span class="keyword1">𝔱𝔱</span> <span class="free">p</span> <span class="main">⋅</span> <span class="keyword1">𝔱𝔱</span> <span class="free">q</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="main">≤</span> Ref <span class="free">p</span> <span class="main">(</span><span class="keyword1">𝔱𝔱</span> <span class="free">p</span> <span class="main">⋅</span> <span class="keyword1">n</span> <span class="free">q</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">H</span> <span class="main">(</span><span class="keyword1">𝔱𝔱</span> <span class="free">p</span> <span class="main">⋅</span> <span class="keyword1">𝔱𝔱</span> <span class="free">q</span><span class="main">)</span> <span class="main">(</span>Ref <span class="main">(</span><span class="keyword1">𝔱𝔱</span> <span class="free">p</span> <span class="main">⋅</span> <span class="keyword1">𝔱𝔱</span> <span class="free">q</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span>  <span class="free">p</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> R1<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">H</span> <span class="free">p</span> <span class="main">(</span><span class="keyword1">while</span> <span class="free">q</span> <span class="keyword1">do</span> <span class="main">(</span>Ref <span class="main">(</span><span class="keyword1">𝔱𝔱</span> <span class="free">p</span> <span class="main">⋅</span> <span class="keyword1">𝔱𝔱</span> <span class="free">q</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">𝔱𝔱</span> <span class="free">p</span> <span class="main">⋅</span> <span class="keyword1">n</span> <span class="free">q</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> H_while<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> R2<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">― ‹ Finite iteration ›</span>

<span class="keyword1"><span class="command">lemma</span></span> R_star<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Ref <span class="free">i</span> <span class="free">i</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">≤</span> Ref <span class="free">i</span> <span class="free">i</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">H</span> <span class="free">i</span> <span class="main">(</span>Ref <span class="free">i</span> <span class="free">i</span><span class="main">)</span> <span class="free">i</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> R1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">H</span> <span class="free">i</span> <span class="main">(</span><span class="main">(</span>Ref <span class="free">i</span> <span class="free">i</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span><span class="main">)</span> <span class="free">i</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> H_star <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"Ref <span class="free">i</span> <span class="free">i</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">≤</span> Ref <span class="free">i</span> <span class="free">i</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> R2<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> R_loop<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">loop</span> <span class="main">(</span>Ref <span class="free">p</span> <span class="free">p</span><span class="main">)</span> <span class="keyword1">inv</span> <span class="free">i</span> <span class="main">≤</span> Ref <span class="free">p</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> kat_loop_inv_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> R_star<span class="main">)</span>

<span class="comment1">― ‹ Invariants ›</span>

<span class="keyword1"><span class="command">lemma</span></span> R_inv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝔱𝔱</span> <span class="free">p</span> <span class="main">≤</span> <span class="keyword1">𝔱𝔱</span> <span class="free">i</span> <span class="main">⟹</span> <span class="keyword1">𝔱𝔱</span> <span class="free">i</span> <span class="main">≤</span> <span class="keyword1">𝔱𝔱</span> <span class="free">q</span> <span class="main">⟹</span> Ref <span class="free">i</span> <span class="free">i</span> <span class="main">≤</span> Ref <span class="free">p</span> <span class="free">q</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> R_cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="HS_VC_KAT_rel">
<div class="head">
<h1>Theory HS_VC_KAT_rel</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:       Verification and refinement of hybrid systems in the relational KAT
    Author:      Jonathan Julián Huerta y Munive, 2020
    Maintainer:  Jonathan Julián Huerta y Munive &lt;jonjulian23@gmail.com&gt;
*)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Verification of hybrid programs›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ We use our relational model to obtain verification and refinement components for hybrid 
programs. We devise three methods for reasoning with evolution commands and their continuous 
dynamics: providing flows, solutions or invariants. ›</span></span>

<span class="keyword1"><span class="command">theory</span></span> HS_VC_KAT_rel
  <span class="keyword2"><span class="keyword">imports</span></span> 
    <span class="quoted">"<a href="HS_ODEs.html">../HS_ODEs</a>"</span>
    <span class="quoted">"<a href="HS_VC_KAT.html">HS_VC_KAT</a>"</span>
    <span class="quoted">"<a href="HS_VC_KA_rel.html">../HS_VC_KA_rel</a>"</span>

<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> rel_tests<span class="main">:</span> test_semiring <span class="quoted"><span class="quoted">"<span class="main">(∪)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">(O)</span>"</span></span> <span class="quoted">Id</span> <span class="quoted"><span class="quoted">"<span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(⊆)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(⊂)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> Id <span class="main">∩</span> <span class="main">(</span> <span class="main">-</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">interpretation</span></span> rel_kat<span class="main">:</span> kat <span class="quoted"><span class="quoted">"<span class="main">(∪)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">(O)</span>"</span></span> <span class="quoted">Id</span> <span class="quoted"><span class="quoted">"<span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(⊆)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(⊂)</span>"</span></span> <span class="quoted">rtrancl</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> Id <span class="main">∩</span> <span class="main">(</span> <span class="main">-</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">rel_R</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rel <span class="main">⇒</span> <span class="tfree">'a</span> rel <span class="main">⇒</span> <span class="tfree">'a</span> rel"</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">rel_R</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="main">=</span> <span class="main">⋃</span><span class="main">{</span><span class="bound">X</span><span class="main">.</span> rel_kat.Hoare <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">X</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> rel_rkat<span class="main">:</span> rkat <span class="quoted"><span class="quoted">"<span class="main">(∪)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">(O)</span>"</span></span> <span class="quoted">Id</span> <span class="quoted"><span class="quoted">"<span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(⊆)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(⊂)</span>"</span></span> <span class="quoted">rtrancl</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">X</span><span class="main">.</span> Id <span class="main">∩</span> <span class="main">-</span> <span class="bound">X</span><span class="main">)</span>"</span></span> <span class="quoted">rel_R</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rel_R_def rel_kat.Hoare_def<span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹ Regular programs›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ Lemmas for manipulation of predicates in the relational model ›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'a</span> pred <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span>

<span class="keyword1"><span class="command">notation</span></span> Id <span class="main">(</span><span class="quoted">"<span class="keyword1">skip</span>"</span><span class="main">)</span>
     <span class="keyword2"><span class="keyword">and</span></span> empty <span class="main">(</span><span class="quoted">"<span class="keyword1">abort</span>"</span><span class="main">)</span>
     <span class="keyword2"><span class="keyword">and</span></span> relcomp <span class="main">(</span><span class="keyword2"><span class="keyword">infixr</span></span> <span class="quoted">"<span class="keyword1">;</span>"</span> 75<span class="main">)</span>

<span class="keyword1"><span class="command">no_notation</span></span> Archimedean_Field.ceiling <span class="main">(</span><span class="quoted">"<span class="keyword1">⌈</span>_<span class="keyword1">⌉</span>"</span><span class="main">)</span>
        <span class="keyword2"><span class="keyword">and</span></span> Archimedean_Field.floor_ceiling_class.floor <span class="main">(</span><span class="quoted">"<span class="keyword1">⌊</span>_<span class="keyword1">⌋</span>"</span><span class="main">)</span>
        <span class="keyword2"><span class="keyword">and</span></span> tau <span class="main">(</span><span class="quoted">"<span class="keyword1">τ</span>"</span><span class="main">)</span>
        <span class="keyword2"><span class="keyword">and</span></span> n_op <span class="main">(</span><span class="quoted">"<span class="keyword1">n</span> _"</span> <span class="main">[</span>90<span class="main">]</span> 91<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">p2r</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> pred <span class="main">⇒</span> <span class="tfree">'a</span> rel"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">⌈</span>_<span class="keyword1">⌉</span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="main"><span class="free">⌈</span></span><span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main"><span class="free">⌉</span></span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="bound">s</span><span class="main">)</span> <span class="main">|</span><span class="bound">s</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">s</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> p2r_simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">≤</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">⟶</span> <span class="free">Q</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">=</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">=</span> <span class="free">Q</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">;</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span><span class="main">)</span> <span class="main">=</span> <span class="main">⌈</span><span class="main">λ</span> <span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">∧</span> <span class="free">Q</span> <span class="bound">s</span><span class="main">⌉</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">∪</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span><span class="main">)</span> <span class="main">=</span> <span class="main">⌈</span><span class="main">λ</span> <span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">∨</span> <span class="free">Q</span> <span class="bound">s</span><span class="main">⌉</span>"</span></span>
  <span class="quoted"><span class="quoted">"rel_tests.t <span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">=</span> <span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">-</span> Id<span class="main">)</span> <span class="main">∪</span> <span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">=</span> <span class="main">-</span> <span class="main">⌈</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">¬</span> <span class="free">P</span> <span class="bound">s</span><span class="main">⌉</span>"</span></span>
  <span class="quoted"><span class="quoted">"Id <span class="main">∩</span> <span class="main">(</span><span class="main">-</span> <span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span><span class="main">)</span> <span class="main">=</span> <span class="main">⌈</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">¬</span> <span class="free">P</span> <span class="bound">s</span><span class="main">⌉</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> p2r_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ Lemmas for verification condition generation ›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> RdL_is_rRKAT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">x</span><span class="main">)</span><span class="main">}</span><span class="main">;</span> <span class="free">R1</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">x</span><span class="main">)</span><span class="main">}</span><span class="main">;</span> <span class="free">R2</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">R1</span> <span class="main">⊆</span> <span class="free">R2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="comment1">(* Refinement in dL is that of rKAT *)</span>

<span class="comment1">― ‹ Hoare Triples ›</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">relHoare</span> <span class="main">(</span><span class="quoted">"<span class="keyword1"><span class="hidden">❙</span><b>{</b></span>_<span class="keyword1"><span class="hidden">❙</span><b>}</b></span>_<span class="keyword1"><span class="hidden">❙</span><b>{</b></span>_<span class="keyword1"><span class="hidden">❙</span><b>}</b></span>"</span><span class="main">)</span> 
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="free"><span class="hidden">❙</span><b>{</b></span></span><span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main"><span class="free"><span class="hidden">❙</span><b>}</b></span></span><span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main"><span class="free"><span class="hidden">❙</span><b>{</b></span></span><span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main"><span class="free"><span class="hidden">❙</span><b>}</b></span></span> <span class="main">≡</span> rel_kat.Hoare <span class="main">⌈</span><span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">⌉</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">⌈</span><span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main">⌉</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> rel_kat_H<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">P</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="free">X</span> <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">Q</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">s</span> <span class="bound">s'</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">⟶</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">X</span> <span class="main">⟶</span> <span class="free">Q</span> <span class="bound">s'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_kat.Hoare_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> p2r_def<span class="main">)</span>

<span class="comment1">― ‹ Skip ›</span>

<span class="keyword1"><span class="command">lemma</span></span> sH_skip<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">P</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="keyword1">skip</span> <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">Q</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="main">⟷</span> <span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">≤</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> rel_kat_H <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> H_skip<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">P</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="keyword1">skip</span> <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">P</span><span class="main"><span class="hidden">❙</span><b>}</b></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="comment1">― ‹ Tests ›</span>

<span class="keyword1"><span class="command">lemma</span></span> sH_test<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">P</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="main">⌈</span><span class="free">R</span><span class="main">⌉</span> <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">Q</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">⟶</span> <span class="free">R</span> <span class="bound">s</span> <span class="main">⟶</span> <span class="free">Q</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> rel_kat_H<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> p2r_def<span class="main">)</span>

<span class="comment1">― ‹ Abort ›</span>

<span class="keyword1"><span class="command">lemma</span></span> sH_abort<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">P</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="keyword1">abort</span> <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">Q</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="main">⟷</span> True"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> rel_kat_H <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> H_abort<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">P</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="keyword1">abort</span> <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">Q</span><span class="main"><span class="hidden">❙</span><b>}</b></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="comment1">― ‹ Assignments ›</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">assign</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">^</span><span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">^</span><span class="tfree">'b</span><span class="main">)</span> rel"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword3">(2</span>_ <span class="keyword1">::=</span> _<span class="keyword3">)</span>"</span> <span class="main">[</span>70<span class="main">,</span> 65<span class="main">]</span> 61<span class="main">)</span> 
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main"><span class="free">::=</span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> vec_upd <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">|</span> <span class="bound">s</span><span class="main">.</span> True<span class="main">}</span>"</span></span> 

<span class="keyword1"><span class="command">lemma</span></span> sH_assign<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">P</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="main">(</span><span class="free">x</span> <span class="main">::=</span> <span class="free">e</span><span class="main">)</span> <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">Q</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">⟶</span> <span class="free">Q</span> <span class="main">(</span><span class="keyword1">χ</span> <span class="bound">j</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="main">($)</span> <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="main">(</span><span class="free">e</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> rel_kat_H vec_upd_def assign_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fun_upd_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> H_assign<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">Q</span> <span class="main">(</span><span class="keyword1">χ</span> <span class="bound">j</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="main">($)</span> <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="main">(</span><span class="free">e</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">P</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="main">(</span><span class="free">x</span> <span class="main">::=</span> <span class="free">e</span><span class="main">)</span> <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">Q</span><span class="main"><span class="hidden">❙</span><b>}</b></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="comment1">― ‹ Nondeterministic assignments ›</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">nondet_assign</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">^</span><span class="tfree">'b</span><span class="main">)</span> rel"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword3">(2</span>_ <span class="keyword1">::=</span> <span class="keyword1">?</span> <span class="keyword3">)</span>"</span> <span class="main">[</span>70<span class="main">]</span> 61<span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main"><span class="free">::=</span></span> <span class="main"><span class="free">?</span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span>vec_upd <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="bound">k</span><span class="main">)</span><span class="main">|</span><span class="bound">s</span> <span class="bound">k</span><span class="main">.</span> True<span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sH_nondet_assign<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">P</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="main">(</span><span class="free">x</span> <span class="main">::=</span> <span class="main">?</span><span class="main">)</span> <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">Q</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="free">Q</span> <span class="main">(</span><span class="keyword1">χ</span> <span class="bound">j</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="main">($)</span> <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> rel_kat_H vec_upd_def nondet_assign_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fun_upd_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> H_nondet_assign<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>{</b></span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="keyword1">χ</span> <span class="bound">j</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="main">($)</span> <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="bound">j</span><span class="main">)</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="main">(</span><span class="free">x</span> <span class="main">::=</span> <span class="main">?</span><span class="main">)</span> <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">P</span><span class="main"><span class="hidden">❙</span><b>}</b></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="comment1">― ‹ Sequential Composition ›</span>

<span class="keyword1"><span class="command">lemma</span></span> H_seq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">P</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="free">X</span> <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">R</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="main">⟹</span> <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">R</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="free">Y</span> <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">Q</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="main">⟹</span> <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">P</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="free">X</span><span class="main">;</span><span class="free">Y</span> <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">Q</span><span class="main"><span class="hidden">❙</span><b>}</b></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> rel_kat.H_seq <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sH_seq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">P</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="free">X</span><span class="main">;</span><span class="free">Y</span> <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">Q</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="main">=</span> <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">P</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="free">X</span> <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">s'</span><span class="main">.</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Y</span> <span class="main">⟶</span> <span class="free">Q</span> <span class="bound">s'</span><span class="main"><span class="hidden">❙</span><b>}</b></span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> rel_kat_H <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> H_assignl<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">K</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="free">X</span> <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">Q</span><span class="main"><span class="hidden">❙</span><b>}</b></span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">⟶</span> <span class="free">K</span> <span class="main">(</span>vec_lambda <span class="main">(</span><span class="main">(</span><span class="main">($)</span> <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="free">e</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">P</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="main">(</span><span class="free">x</span> <span class="main">::=</span> <span class="free">e</span><span class="main">)</span><span class="main">;</span><span class="free">X</span> <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">Q</span><span class="main"><span class="hidden">❙</span><b>}</b></span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> H_seq<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> sH_assign<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="comment1">― ‹ Nondeterministic Choice ›</span>

<span class="keyword1"><span class="command">lemma</span></span> sH_choice<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">P</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="free">X</span> <span class="main">∪</span> <span class="free">Y</span> <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">Q</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="main">⟷</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">P</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="free">X</span> <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">Q</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="main">∧</span> <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">P</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="free">Y</span> <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">Q</span><span class="main"><span class="hidden">❙</span><b>}</b></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> rel_kat_H <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> H_choice<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">P</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="free">X</span> <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">Q</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="main">⟹</span> <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">P</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="free">Y</span> <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">Q</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="main">⟹</span> <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">P</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="free">X</span> <span class="main">∪</span> <span class="free">Y</span> <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">Q</span><span class="main"><span class="hidden">❙</span><b>}</b></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> rel_kat.H_choice <span class="keyword1"><span class="command">.</span></span>

<span class="comment1">― ‹ Conditional Statement ›</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">cond_sugar</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> pred <span class="main">⇒</span> <span class="tfree">'a</span> rel <span class="main">⇒</span> <span class="tfree">'a</span> rel <span class="main">⇒</span> <span class="tfree">'a</span> rel"</span></span> 
  <span class="main">(</span><span class="quoted">"<span class="keyword1">IF</span> _ <span class="keyword1">THEN</span> _ <span class="keyword1">ELSE</span> _"</span> <span class="main">[</span>64<span class="main">,</span>64<span class="main">]</span> 63<span class="main">)</span> 
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">IF</span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="keyword1"><span class="free">THEN</span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="keyword1"><span class="free">ELSE</span></span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span> <span class="main">≡</span> rel_kat.kat_cond <span class="main">⌈</span><span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">⌉</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sH_cond<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">P</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="main">(</span><span class="keyword1">IF</span> <span class="free">B</span> <span class="keyword1">THEN</span> <span class="free">X</span> <span class="keyword1">ELSE</span> <span class="free">Y</span><span class="main">)</span> <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">Q</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="main">⟷</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>{</b></span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">∧</span> <span class="free">B</span> <span class="bound">s</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="free">X</span> <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">Q</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="main">∧</span> <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">∧</span> <span class="main">¬</span> <span class="free">B</span> <span class="bound">s</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="free">Y</span> <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">Q</span><span class="main"><span class="hidden">❙</span><b>}</b></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rel_kat.H_cond_iff rel_kat_H<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> H_cond<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>{</b></span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">∧</span> <span class="free">B</span> <span class="bound">s</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="free">X</span> <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">Q</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="main">⟹</span> <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">∧</span> <span class="main">¬</span> <span class="free">B</span> <span class="bound">s</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="free">Y</span> <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">Q</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="main">⟹</span> <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">P</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="main">(</span><span class="keyword1">IF</span> <span class="free">B</span> <span class="keyword1">THEN</span> <span class="free">X</span> <span class="keyword1">ELSE</span> <span class="free">Y</span><span class="main">)</span> <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">Q</span><span class="main"><span class="hidden">❙</span><b>}</b></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="comment1">― ‹ While Loop ›</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">while_inv_sugar</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> pred <span class="main">⇒</span> <span class="tfree">'a</span> pred <span class="main">⇒</span> <span class="tfree">'a</span> rel <span class="main">⇒</span> <span class="tfree">'a</span> rel"</span></span> 
  <span class="main">(</span><span class="quoted">"<span class="keyword1">WHILE</span> _ <span class="keyword1">INV</span> _ <span class="keyword1">DO</span> _"</span> <span class="main">[</span>64<span class="main">,</span>64<span class="main">,</span>64<span class="main">]</span> 63<span class="main">)</span> 
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">WHILE</span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="keyword1"><span class="free">INV</span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="keyword1"><span class="free">DO</span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">≡</span> rel_kat.kat_while_inv <span class="main">⌈</span><span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">⌉</span> <span class="main">⌈</span><span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">⌉</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sH_whileI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">⟶</span> <span class="free">I</span> <span class="bound">s</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">s</span><span class="main">.</span> <span class="free">I</span> <span class="bound">s</span> <span class="main">∧</span> <span class="main">¬</span> <span class="free">B</span> <span class="bound">s</span> <span class="main">⟶</span> <span class="free">Q</span> <span class="bound">s</span> <span class="main">⟹</span> <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">I</span> <span class="bound">s</span> <span class="main">∧</span> <span class="free">B</span> <span class="bound">s</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="free">X</span> <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">I</span><span class="main"><span class="hidden">❙</span><b>}</b></span> 
  <span class="main">⟹</span> <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">P</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="main">(</span><span class="keyword1">WHILE</span> <span class="free">B</span> <span class="keyword1">INV</span> <span class="free">I</span> <span class="keyword1">DO</span> <span class="free">X</span><span class="main">)</span> <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">Q</span><span class="main"><span class="hidden">❙</span><b>}</b></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> rel_kat.H_while_inv<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> p2r_def rel_kat.Hoare_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">fastforce</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>{</b></span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">∧</span> <span class="free">B</span> <span class="bound">s</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="free">X</span> <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="main">⟹</span> <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">P</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="main">(</span><span class="keyword1">WHILE</span> <span class="free">B</span> <span class="keyword1">INV</span> <span class="free">I</span> <span class="keyword1">DO</span> <span class="free">X</span><span class="main">)</span> <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">∧</span> <span class="main">¬</span> <span class="free">B</span> <span class="bound">s</span><span class="main"><span class="hidden">❙</span><b>}</b></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> rel_kat.H_while<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⌈</span><span class="free">B</span><span class="main">⌉</span>"</span></span> <span class="quoted"><span class="free">X</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">unfolding</span></span> rel_kat.kat_while_inv_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="comment1">― ‹ Finite Iteration ›</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">loopi_sugar</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rel <span class="main">⇒</span> <span class="tfree">'a</span> pred <span class="main">⇒</span> <span class="tfree">'a</span> rel"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">LOOP</span> _ <span class="keyword1">INV</span> _ "</span> <span class="main">[</span>64<span class="main">,</span>64<span class="main">]</span> 63<span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">LOOP</span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="keyword1"><span class="free">INV</span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">≡</span> rel_kat.kat_loop_inv <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">⌈</span><span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">⌉</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> H_loop<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">P</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="free">X</span> <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">P</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="main">⟹</span> <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">P</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="main">(</span><span class="keyword1">LOOP</span> <span class="free">X</span> <span class="keyword1">INV</span> <span class="free">I</span><span class="main">)</span> <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">P</span><span class="main"><span class="hidden">❙</span><b>}</b></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> rel_kat.H_loop<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> H_loopI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">I</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="free">X</span> <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">I</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="main">⟹</span> <span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">⊆</span> <span class="main">⌈</span><span class="free">I</span><span class="main">⌉</span> <span class="main">⟹</span> <span class="main">⌈</span><span class="free">I</span><span class="main">⌉</span> <span class="main">⊆</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span> <span class="main">⟹</span> <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">P</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="main">(</span><span class="keyword1">LOOP</span> <span class="free">X</span> <span class="keyword1">INV</span> <span class="free">I</span><span class="main">)</span> <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">Q</span><span class="main"><span class="hidden">❙</span><b>}</b></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> rel_kat.H_loop_inv<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⌈</span><span class="free">I</span><span class="main">⌉</span>"</span></span> <span class="quoted"><span class="free">X</span></span> <span class="quoted"><span class="quoted">"<span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹ Evolution commands ›</span></span>

<span class="comment1">― ‹Verification by providing evolution›</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">g_evol</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>ord<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'b</span> pred <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'a</span> set<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'b</span> rel"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">EVOL</span>"</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">EVOL</span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span> <span class="main">|</span><span class="bound">s</span> <span class="bound">s'</span><span class="main">.</span> <span class="bound">s'</span> <span class="main">∈</span> g_orbit <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="bound">t</span> <span class="bound">s</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="bound">s</span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sH_g_evol<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>  
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">φ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>preorder<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">P</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="main">(</span><span class="keyword1">EVOL</span> <span class="free">φ</span> <span class="free">G</span> <span class="free">U</span><span class="main">)</span> <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">Q</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">t</span><span class="main">∈</span><span class="free">U</span> <span class="bound">s</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">τ</span><span class="main">∈</span>down <span class="main">(</span><span class="free">U</span> <span class="bound">s</span><span class="main">)</span> <span class="bound">t</span><span class="main">.</span> <span class="free">G</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">τ</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">Q</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">t</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> rel_kat_H g_evol_def g_orbit_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> H_g_evol<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">φ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>preorder<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'b</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">t</span><span class="main">∈</span><span class="free">U</span> <span class="bound">s</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">τ</span><span class="main">∈</span>down <span class="main">(</span><span class="free">U</span> <span class="bound">s</span><span class="main">)</span> <span class="bound">t</span><span class="main">.</span> <span class="free">G</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">τ</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">Q</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">t</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">P</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="main">(</span><span class="keyword1">EVOL</span> <span class="free">φ</span> <span class="free">G</span> <span class="free">U</span><span class="main">)</span> <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">Q</span><span class="main"><span class="hidden">❙</span><b>}</b></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main">)</span>

<span class="comment1">― ‹Verification by providing solutions›</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">g_ode</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>real <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>banach<span class="main">)</span><span class="main">⇒</span><span class="tfree">'a</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> pred <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> real set<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> set <span class="main">⇒</span> real <span class="main">⇒</span> 
  <span class="tfree">'a</span> rel"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword3">(1</span><span class="keyword1">x´=</span>_ <span class="keyword1">&amp;</span> _ <span class="keyword1">on</span> _ _ <span class="keyword1">@</span> _<span class="keyword3">)</span>"</span><span class="main">)</span> 
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1"><span class="free">x´=</span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main"><span class="free">&amp;</span></span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="keyword1"><span class="free">on</span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main"><span class="free">@</span></span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span> <span class="main">|</span><span class="bound">s</span> <span class="bound">s'</span><span class="main">.</span> <span class="bound">s'</span> <span class="main">∈</span> g_orbital <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="bound">s</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> H_g_orbital<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">X</span><span class="main">∈</span>ivp_sols <span class="free">f</span> <span class="free">U</span> <span class="free">S</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">t</span><span class="main">∈</span><span class="free">U</span> <span class="bound">s</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">τ</span><span class="main">∈</span>down <span class="main">(</span><span class="free">U</span> <span class="bound">s</span><span class="main">)</span> <span class="bound">t</span><span class="main">.</span> <span class="free">G</span> <span class="main">(</span><span class="bound">X</span> <span class="bound">τ</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">Q</span> <span class="main">(</span><span class="bound">X</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> 
  <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">P</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="free">f</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">Q</span><span class="main"><span class="hidden">❙</span><b>}</b></span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> rel_kat_H g_ode_def g_orbital_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">clarsimp</span>

<span class="keyword1"><span class="command">lemma</span></span> sH_g_orbital<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">P</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="free">f</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">Q</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="main">=</span> 
  <span class="main">(</span><span class="main">∀</span><span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">X</span><span class="main">∈</span>ivp_sols <span class="free">f</span> <span class="free">U</span> <span class="free">S</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">t</span><span class="main">∈</span><span class="free">U</span> <span class="bound">s</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">τ</span><span class="main">∈</span>down <span class="main">(</span><span class="free">U</span> <span class="bound">s</span><span class="main">)</span> <span class="bound">t</span><span class="main">.</span> <span class="free">G</span> <span class="main">(</span><span class="bound">X</span> <span class="bound">τ</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">Q</span> <span class="main">(</span><span class="bound">X</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> g_orbital_eq g_ode_def rel_kat_H <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">context</span></span> local_flow
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sH_g_ode_subset<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">∈</span> <span class="free">U</span> <span class="bound">s</span> <span class="main">∧</span> is_interval <span class="main">(</span><span class="free">U</span> <span class="bound">s</span><span class="main">)</span> <span class="main">∧</span> <span class="free">U</span> <span class="bound">s</span> <span class="main">⊆</span> <span class="free">T</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">P</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">f</span><span class="main">)</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="main">0</span><span class="main">)</span> <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">Q</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="main">=</span> 
  <span class="main">(</span><span class="main">∀</span><span class="bound">s</span><span class="main">∈</span><span class="free">S</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">t</span><span class="main">∈</span><span class="free">U</span> <span class="bound">s</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">τ</span><span class="main">∈</span>down <span class="main">(</span><span class="free">U</span> <span class="bound">s</span><span class="main">)</span> <span class="bound">t</span><span class="main">.</span> <span class="free">G</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">τ</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">Q</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">t</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">unfold</span> sH_g_orbital<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="skolem">t</span>
  <span class="keyword3"><span class="command">assume</span></span> hyps<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> <span class="free">U</span> <span class="skolem">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">τ</span><span class="main">.</span> <span class="bound">τ</span> <span class="main">∈</span> <span class="free">U</span> <span class="skolem">s</span> <span class="main">∧</span> <span class="bound">τ</span> <span class="main">≤</span> <span class="skolem">t</span> <span class="main">⟶</span> <span class="free">G</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">τ</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> main<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">X</span><span class="main">∈</span><span class="keyword1">Sols</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">f</span><span class="main">)</span> <span class="free">U</span> <span class="free">S</span> <span class="main">0</span> <span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">t</span><span class="main">∈</span><span class="free">U</span> <span class="bound">s</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">τ</span><span class="main">.</span> <span class="bound">τ</span> <span class="main">∈</span> <span class="free">U</span> <span class="bound">s</span> <span class="main">∧</span> <span class="bound">τ</span> <span class="main">≤</span> <span class="bound">t</span> <span class="main">⟶</span> <span class="free">G</span> <span class="main">(</span><span class="bound">X</span> <span class="bound">τ</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">Q</span> <span class="main">(</span><span class="bound">X</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">φ</span> <span class="bound">t</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1">Sols</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">f</span><span class="main">)</span> <span class="free">U</span> <span class="free">S</span> <span class="main">0</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> in_ivp_sols assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="main">(</span><span class="free">φ</span> <span class="skolem">t</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> main hyps <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="skolem">X</span> <span class="skolem">t</span>
  <span class="keyword3"><span class="command">assume</span></span> hyps<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> <span class="keyword1">Sols</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">f</span><span class="main">)</span> <span class="free">U</span> <span class="free">S</span> <span class="main">0</span> <span class="skolem">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> <span class="free">U</span> <span class="skolem">s</span>"</span></span>  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">τ</span><span class="main">.</span> <span class="bound">τ</span> <span class="main">∈</span> <span class="free">U</span> <span class="skolem">s</span> <span class="main">∧</span> <span class="bound">τ</span> <span class="main">≤</span> <span class="skolem">t</span> <span class="main">⟶</span> <span class="free">G</span> <span class="main">(</span><span class="skolem">X</span> <span class="bound">τ</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> main<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s</span><span class="main">∈</span><span class="free">S</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">t</span><span class="main">∈</span><span class="free">U</span> <span class="bound">s</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">τ</span><span class="main">.</span> <span class="bound">τ</span> <span class="main">∈</span> <span class="free">U</span> <span class="bound">s</span> <span class="main">∧</span> <span class="bound">τ</span> <span class="main">≤</span> <span class="bound">t</span> <span class="main">⟶</span> <span class="free">G</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">τ</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">Q</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">t</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> obs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> <span class="free">S</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ivp_sols_def<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">f</span>"</span></span><span class="main">]</span> init_time <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">τ</span><span class="main">∈</span>down <span class="main">(</span><span class="free">U</span> <span class="skolem">s</span><span class="main">)</span> <span class="skolem">t</span><span class="main">.</span> <span class="skolem">X</span> <span class="bound">τ</span> <span class="main">=</span> <span class="free">φ</span> <span class="bound">τ</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> eq_solution hyps assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="main">(</span><span class="skolem">X</span> <span class="skolem">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> hyps main obs <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> H_g_ode_subset<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">∈</span> <span class="free">U</span> <span class="bound">s</span> <span class="main">∧</span> is_interval <span class="main">(</span><span class="free">U</span> <span class="bound">s</span><span class="main">)</span> <span class="main">∧</span> <span class="free">U</span> <span class="bound">s</span> <span class="main">⊆</span> <span class="free">T</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">t</span><span class="main">∈</span><span class="free">U</span> <span class="bound">s</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">τ</span><span class="main">∈</span>down <span class="main">(</span><span class="free">U</span> <span class="bound">s</span><span class="main">)</span> <span class="bound">t</span><span class="main">.</span> <span class="free">G</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">τ</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">Q</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">t</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">P</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">f</span><span class="main">)</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="main">0</span><span class="main">)</span> <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">Q</span><span class="main"><span class="hidden">❙</span><b>}</b></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> sH_g_ode_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> sH_g_ode<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">P</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">f</span><span class="main">)</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">T</span><span class="main">)</span> <span class="free">S</span> <span class="main">@</span> <span class="main">0</span><span class="main">)</span> <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">Q</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="main">=</span> 
  <span class="main">(</span><span class="main">∀</span><span class="bound">s</span><span class="main">∈</span><span class="free">S</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">t</span><span class="main">∈</span><span class="free">T</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">τ</span><span class="main">∈</span>down <span class="free">T</span> <span class="bound">t</span><span class="main">.</span> <span class="free">G</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">τ</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">Q</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">t</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sH_g_ode_subset<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> init_time interval_time<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sH_g_ode_ivl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">≥</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free">t</span> <span class="main">∈</span> <span class="free">T</span> <span class="main">⟹</span> <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">P</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">f</span><span class="main">)</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">t</span><span class="main">}</span><span class="main">)</span> <span class="free">S</span> <span class="main">@</span> <span class="main">0</span><span class="main">)</span> <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">Q</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="main">=</span> 
  <span class="main">(</span><span class="main">∀</span><span class="bound">s</span><span class="main">∈</span><span class="free">S</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">t</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">t</span><span class="main">}</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">τ</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="bound">t</span><span class="main">}</span><span class="main">.</span> <span class="free">G</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">τ</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">Q</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">t</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> sH_g_ode_subset<span class="main"><span class="keyword3">;</span></span> <span class="operator">clarsimp</span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">force</span><span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> init_time interval_time mem_is_interval_1_I <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> sH_orbit<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">P</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="main">(</span><span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span> <span class="main">|</span> <span class="bound">s</span> <span class="bound">s'</span><span class="main">.</span> <span class="bound">s'</span> <span class="main">∈</span> <span class="keyword1">γ<span class="hidden">⇧</span><sup>φ</sup></span> <span class="bound">s</span><span class="main">}</span><span class="main">)</span> <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">Q</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">s</span> <span class="main">∈</span> <span class="free">S</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">t</span> <span class="main">∈</span> <span class="free">T</span><span class="main">.</span> <span class="free">Q</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">t</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> sH_g_ode <span class="keyword1"><span class="command">unfolding</span></span> orbit_def g_ode_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="comment1">― ‹ Verification with differential invariants ›</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">g_ode_inv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>real <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>banach<span class="main">)</span><span class="main">⇒</span><span class="tfree">'a</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> pred <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> real set<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> set <span class="main">⇒</span> 
  real <span class="main">⇒</span> <span class="tfree">'a</span> pred <span class="main">⇒</span> <span class="tfree">'a</span> rel"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword3">(1</span><span class="keyword1">x´=</span>_ <span class="keyword1">&amp;</span> _ <span class="keyword1">on</span> _ _ <span class="keyword1">@</span> _ <span class="keyword1">DINV</span> _ <span class="keyword3">)</span>"</span><span class="main">)</span> 
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1"><span class="free">x´=</span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main"><span class="free">&amp;</span></span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="keyword1"><span class="free">on</span></span> <span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main"><span class="free">@</span></span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="keyword1"><span class="free">DINV</span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">&amp;</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="keyword1">on</span> <span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">@</span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sH_g_orbital_guard<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">G</span> <span class="bound">s</span> <span class="main">∧</span> <span class="free">Q</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">P</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="free">f</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">Q</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="main">=</span> <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">P</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="free">f</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">R</span><span class="main"><span class="hidden">❙</span><b>}</b></span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> g_orbital_eq rel_kat_H ivp_sols_def g_ode_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> sH_g_orbital_inv<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">≤</span> <span class="main">⌈</span><span class="free">I</span><span class="main">⌉</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">I</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="free">f</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">I</span><span class="main"><span class="hidden">❙</span><b>}</b></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⌈</span><span class="free">I</span><span class="main">⌉</span> <span class="main">≤</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">" <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">P</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="free">f</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">Q</span><span class="main"><span class="hidden">❙</span><b>}</b></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> p'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">⌈</span><span class="free">I</span><span class="main">⌉</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> rel_kat.H_consl<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> q'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">⌈</span><span class="free">I</span><span class="main">⌉</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> rel_kat.H_consr<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> sH_diff_inv<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">I</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="free">f</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">I</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="main">=</span> diff_invariant <span class="free">I</span> <span class="free">f</span> <span class="free">U</span> <span class="free">S</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">G</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> diff_invariant_eq rel_kat_H g_orbital_eq g_ode_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> H_g_ode_inv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">I</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="free">f</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">I</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="main">⟹</span> <span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">≤</span> <span class="main">⌈</span><span class="free">I</span><span class="main">⌉</span> <span class="main">⟹</span> 
  <span class="main">⌈</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">I</span> <span class="bound">s</span> <span class="main">∧</span> <span class="free">G</span> <span class="bound">s</span><span class="main">⌉</span> <span class="main">≤</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span> <span class="main">⟹</span> <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">P</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="free">f</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="keyword1">DINV</span> <span class="free">I</span><span class="main">)</span> <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">Q</span><span class="main"><span class="hidden">❙</span><b>}</b></span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> g_ode_inv_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> q'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">⌈</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">I</span> <span class="bound">s</span> <span class="main">∧</span> <span class="free">G</span> <span class="bound">s</span><span class="main">⌉</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> rel_kat.H_consr<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> sH_g_orbital_guard<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> I<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">I</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> sH_g_orbital_inv<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹ Refinement Components ›</span></span>

<span class="comment1">― ‹ Skip ›</span>

<span class="keyword1"><span class="command">lemma</span></span> R_skip<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">⟶</span> <span class="free">Q</span> <span class="bound">s</span><span class="main">)</span> <span class="main">⟹</span> <span class="keyword1">skip</span> <span class="main">≤</span> rel_R <span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> rel_rkat.R2<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="comment1">― ‹ Abort ›</span>

<span class="keyword1"><span class="command">lemma</span></span> R_abort<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">abort</span> <span class="main">≤</span> rel_R <span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> rel_rkat.R2<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="comment1">― ‹ Sequential Composition ›</span>

<span class="keyword1"><span class="command">lemma</span></span> R_seq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>rel_R <span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">⌈</span><span class="free">R</span><span class="main">⌉</span><span class="main">)</span> <span class="main">;</span> <span class="main">(</span>rel_R <span class="main">⌈</span><span class="free">R</span><span class="main">⌉</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span><span class="main">)</span> <span class="main">≤</span> rel_R <span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> rel_rkat.R_seq <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> R_seq_law<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">≤</span> rel_R <span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">⌈</span><span class="free">R</span><span class="main">⌉</span> <span class="main">⟹</span> <span class="free">Y</span> <span class="main">≤</span> rel_R <span class="main">⌈</span><span class="free">R</span><span class="main">⌉</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span> <span class="main">⟹</span> <span class="free">X</span><span class="main">;</span> <span class="free">Y</span> <span class="main">≤</span> rel_R <span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> rel_rkat.spec_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> H_seq<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> R_seq_mono <span class="main">=</span> relcomp_mono

<span class="comment1">― ‹ Nondeterministic Choice ›</span>

<span class="keyword1"><span class="command">lemma</span></span> R_choice<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>rel_R <span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span>rel_R <span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span><span class="main">)</span> <span class="main">≤</span> rel_R <span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> rel_rkat.R_choice<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lemma</span></span> R_choice_law<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">≤</span> rel_R <span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span> <span class="main">⟹</span> <span class="free">Y</span> <span class="main">≤</span> rel_R <span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span> <span class="main">⟹</span> <span class="free">X</span> <span class="main">∪</span> <span class="free">Y</span> <span class="main">≤</span> rel_R <span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> le_supI <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lemma</span></span> R_choice_mono<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P'</span> <span class="main">⊆</span> <span class="free">P</span> <span class="main">⟹</span> <span class="free">Q'</span> <span class="main">⊆</span> <span class="free">Q</span> <span class="main">⟹</span> <span class="free">P'</span> <span class="main">∪</span> <span class="free">Q'</span> <span class="main">⊆</span> <span class="free">P</span> <span class="main">∪</span> <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> Un_mono <span class="keyword1"><span class="command">.</span></span>

<span class="comment1">― ‹ Assignment ›</span>

<span class="keyword1"><span class="command">lemma</span></span> R_assign<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">::=</span> <span class="free">e</span><span class="main">)</span> <span class="main">≤</span> rel_R <span class="main">⌈</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="keyword1">χ</span> <span class="bound">j</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="main">($)</span> <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="free">e</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="bound">j</span><span class="main">)</span><span class="main">⌉</span> <span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> rel_rkat.spec_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> H_assign<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fun_upd_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> R_assign_law<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">⟶</span> <span class="free">Q</span> <span class="main">(</span><span class="keyword1">χ</span> <span class="bound">j</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="main">($)</span> <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="main">(</span><span class="free">e</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">x</span> <span class="main">::=</span> <span class="free">e</span><span class="main">)</span> <span class="main">≤</span> rel_R <span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> sH_assign<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> rel_rkat.R2<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> R_assignl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">R</span> <span class="main">(</span><span class="keyword1">χ</span> <span class="bound">j</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="main">($)</span> <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="free">e</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> 
  <span class="main">(</span><span class="free">x</span> <span class="main">::=</span> <span class="free">e</span><span class="main">)</span> <span class="main">;</span> rel_R <span class="main">⌈</span><span class="free">R</span><span class="main">⌉</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span> <span class="main">≤</span> rel_R <span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> R_seq_law<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> R_assign_law<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> R_assignr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">Q</span> <span class="main">(</span><span class="keyword1">χ</span> <span class="bound">j</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="main">($)</span> <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="free">e</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> 
  rel_R <span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">⌈</span><span class="free">R</span><span class="main">⌉</span><span class="main">;</span> <span class="main">(</span><span class="free">x</span> <span class="main">::=</span> <span class="free">e</span><span class="main">)</span> <span class="main">≤</span> rel_R <span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> R_seq_law<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> R_assign_law<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">::=</span> <span class="free">e</span><span class="main">)</span> <span class="main">;</span> rel_R <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span> <span class="main">≤</span> rel_R <span class="main">⌈</span><span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">Q</span> <span class="main">(</span><span class="keyword1">χ</span> <span class="bound">j</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="main">($)</span> <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="free">e</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span><span class="main">⌉</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> R_assignl<span class="main">)</span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"rel_R <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span> <span class="main">⌈</span><span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">Q</span> <span class="main">(</span><span class="keyword1">χ</span> <span class="bound">j</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="main">($)</span> <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="free">e</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span><span class="main">⌉</span><span class="main">;</span> <span class="main">(</span><span class="free">x</span> <span class="main">::=</span> <span class="free">e</span><span class="main">)</span> <span class="main">≤</span> rel_R <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> R_assignr<span class="main">)</span> <span class="operator">simp</span>

<span class="comment1">― ‹ Nondeterministic Assignment ›</span>

<span class="keyword1"><span class="command">lemma</span></span> R_nondet_assign<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">::=</span> <span class="main">?</span><span class="main">)</span> <span class="main">≤</span> rel_R <span class="main">⌈</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="keyword1">χ</span> <span class="bound">j</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="main">($)</span> <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="bound">j</span><span class="main">)</span><span class="main">⌉</span> <span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> rel_rkat.spec_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> H_nondet_assign<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> R_nondet_assign_law<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="free">Q</span> <span class="main">(</span><span class="keyword1">χ</span> <span class="bound">j</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="main">($)</span> <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">x</span> <span class="main">::=</span> <span class="main">?</span><span class="main">)</span> <span class="main">≤</span> rel_R <span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> sH_nondet_assign<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> rel_rkat.R2<span class="main">)</span>

<span class="comment1">― ‹ Conditional Statement ›</span>

<span class="keyword1"><span class="command">lemma</span></span> R_cond<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">IF</span> <span class="free">B</span> <span class="keyword1">THEN</span> rel_R <span class="main">⌈</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">B</span> <span class="bound">s</span> <span class="main">∧</span> <span class="free">P</span> <span class="bound">s</span><span class="main">⌉</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span> <span class="keyword1">ELSE</span> rel_R <span class="main">⌈</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">¬</span> <span class="free">B</span> <span class="bound">s</span> <span class="main">∧</span> <span class="free">P</span> <span class="bound">s</span><span class="main">⌉</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span><span class="main">)</span> <span class="main">≤</span> rel_R <span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> rel_rkat.R_cond<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">⌈</span><span class="free">B</span><span class="main">⌉</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> R_cond_mono<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">≤</span> <span class="free">X'</span> <span class="main">⟹</span> <span class="free">Y</span> <span class="main">≤</span> <span class="free">Y'</span> <span class="main">⟹</span> <span class="main">(</span><span class="keyword1">IF</span> <span class="free">P</span> <span class="keyword1">THEN</span> <span class="free">X</span> <span class="keyword1">ELSE</span> <span class="free">Y</span><span class="main">)</span> <span class="main">≤</span> <span class="keyword1">IF</span> <span class="free">P</span> <span class="keyword1">THEN</span> <span class="free">X'</span> <span class="keyword1">ELSE</span> <span class="free">Y'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rel_kat.kat_cond_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> R_cond_law<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">≤</span> rel_R <span class="main">⌈</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">B</span> <span class="bound">s</span> <span class="main">∧</span> <span class="free">P</span> <span class="bound">s</span><span class="main">⌉</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span> <span class="main">⟹</span> <span class="free">Y</span> <span class="main">≤</span> rel_R <span class="main">⌈</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">¬</span> <span class="free">B</span> <span class="bound">s</span> <span class="main">∧</span> <span class="free">P</span> <span class="bound">s</span><span class="main">⌉</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span> <span class="main">⟹</span> 
  <span class="main">(</span><span class="keyword1">IF</span> <span class="free">B</span> <span class="keyword1">THEN</span> <span class="free">X</span> <span class="keyword1">ELSE</span> <span class="free">Y</span><span class="main">)</span> <span class="main">≤</span> rel_R <span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> order_trans<span class="main"><span class="keyword3">;</span></span> <span class="main">(</span><span class="operator">rule</span> R_cond_mono<span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">rule</span> R_cond<span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="comment1">― ‹ While Loop ›</span>

<span class="keyword1"><span class="command">lemma</span></span> R_while<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">K</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">∧</span> <span class="main">¬</span> <span class="free">B</span> <span class="bound">s</span><span class="main">)</span> <span class="main">⟹</span> 
  <span class="keyword1">WHILE</span> <span class="free">B</span> <span class="keyword1">INV</span> <span class="free">I</span> <span class="keyword1">DO</span> <span class="main">(</span>rel_R <span class="main">⌈</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">∧</span> <span class="free">B</span> <span class="bound">s</span><span class="main">⌉</span> <span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span><span class="main">)</span> <span class="main">≤</span> rel_R <span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">⌈</span><span class="free">K</span><span class="main">⌉</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> rel_kat.kat_while_inv_def <span class="keyword1"><span class="command">using</span></span> rel_rkat.R_while<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">⌈</span><span class="free">B</span><span class="main">⌉</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> R_whileI<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">≤</span> rel_R <span class="main">⌈</span><span class="free">I</span><span class="main">⌉</span> <span class="main">⌈</span><span class="free">I</span><span class="main">⌉</span> <span class="main">⟹</span> <span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">≤</span> <span class="main">⌈</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">I</span> <span class="bound">s</span> <span class="main">∧</span> <span class="free">B</span> <span class="bound">s</span><span class="main">⌉</span> <span class="main">⟹</span> <span class="main">⌈</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">I</span> <span class="bound">s</span> <span class="main">∧</span> <span class="main">¬</span> <span class="free">B</span> <span class="bound">s</span><span class="main">⌉</span> <span class="main">≤</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span> <span class="main">⟹</span> 
  <span class="keyword1">WHILE</span> <span class="free">B</span> <span class="keyword1">INV</span> <span class="free">I</span> <span class="keyword1">DO</span> <span class="free">X</span> <span class="main">≤</span> rel_R <span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> rel_rkat.R2<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> rel_kat.H_while_inv<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rel_kat_H rel_rkat.spec_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> R_while_mono<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">≤</span> <span class="free">X'</span> <span class="main">⟹</span> <span class="main">(</span><span class="keyword1">WHILE</span> <span class="free">P</span> <span class="keyword1">INV</span> <span class="free">I</span> <span class="keyword1">DO</span> <span class="free">X</span><span class="main">)</span> <span class="main">⊆</span> <span class="keyword1">WHILE</span> <span class="free">P</span> <span class="keyword1">INV</span> <span class="free">I</span> <span class="keyword1">DO</span> <span class="free">X'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_dioid.mult_isol rel_dioid.mult_isor rel_ka.conway.dagger_iso 
      rel_kat.kat_while_def rel_kat.kat_while_inv_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> R_while_law<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">≤</span> rel_R <span class="main">⌈</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">∧</span> <span class="free">B</span> <span class="bound">s</span><span class="main">⌉</span> <span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">∧</span> <span class="main">¬</span> <span class="free">B</span> <span class="bound">s</span><span class="main">)</span> <span class="main">⟹</span> 
  <span class="main">(</span><span class="keyword1">WHILE</span> <span class="free">B</span> <span class="keyword1">INV</span> <span class="free">I</span> <span class="keyword1">DO</span> <span class="free">X</span><span class="main">)</span> <span class="main">≤</span> rel_R <span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> order_trans<span class="main"><span class="keyword3">;</span></span> <span class="main">(</span><span class="operator">rule</span> R_while_mono<span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">rule</span> R_while<span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main">)</span>

<span class="comment1">― ‹ Finite Iteration ›</span>

<span class="keyword1"><span class="command">lemma</span></span> R_loop<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="keyword1">LOOP</span> rel_R <span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="keyword1">INV</span> <span class="free">I</span> <span class="main">≤</span> rel_R <span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> rel_rkat.R_loop <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lemma</span></span> R_loopI<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">≤</span> rel_R <span class="main">⌈</span><span class="free">I</span><span class="main">⌉</span> <span class="main">⌈</span><span class="free">I</span><span class="main">⌉</span> <span class="main">⟹</span> <span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">≤</span> <span class="main">⌈</span><span class="free">I</span><span class="main">⌉</span> <span class="main">⟹</span> <span class="main">⌈</span><span class="free">I</span><span class="main">⌉</span> <span class="main">≤</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span> <span class="main">⟹</span> <span class="keyword1">LOOP</span> <span class="free">X</span> <span class="keyword1">INV</span> <span class="free">I</span> <span class="main">≤</span> rel_R <span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> rel_rkat.spec_def <span class="keyword1"><span class="command">using</span></span> H_loopI <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> R_loop_mono<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">≤</span> <span class="free">X'</span> <span class="main">⟹</span> <span class="keyword1">LOOP</span> <span class="free">X</span> <span class="keyword1">INV</span> <span class="free">I</span> <span class="main">⊆</span> <span class="keyword1">LOOP</span> <span class="free">X'</span> <span class="keyword1">INV</span> <span class="free">I</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> rel_kat.kat_loop_inv_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_ka.star_iso<span class="main">)</span>

<span class="comment1">― ‹ Evolution command (flow) ›</span>

<span class="keyword1"><span class="command">lemma</span></span> R_g_evol<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">φ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>preorder<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">EVOL</span> <span class="free">φ</span> <span class="free">G</span> <span class="free">U</span><span class="main">)</span> <span class="main">≤</span> rel_R <span class="main">⌈</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">t</span><span class="main">∈</span><span class="free">U</span> <span class="bound">s</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">τ</span><span class="main">∈</span>down <span class="main">(</span><span class="free">U</span> <span class="bound">s</span><span class="main">)</span> <span class="bound">t</span><span class="main">.</span> <span class="free">G</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">τ</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">P</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">t</span> <span class="bound">s</span><span class="main">)</span><span class="main">⌉</span> <span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> rel_rkat.spec_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> H_g_evol<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> R_g_evol_law<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">φ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>preorder<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">t</span><span class="main">∈</span><span class="free">U</span> <span class="bound">s</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">τ</span><span class="main">∈</span>down <span class="main">(</span><span class="free">U</span> <span class="bound">s</span><span class="main">)</span> <span class="bound">t</span><span class="main">.</span> <span class="free">G</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">τ</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">Q</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">t</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="keyword1">EVOL</span> <span class="free">φ</span> <span class="free">G</span> <span class="free">U</span><span class="main">)</span> <span class="main">≤</span> rel_R <span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> sH_g_evol<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> rel_rkat.spec_def <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lemma</span></span> R_g_evoll<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">φ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>preorder<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">t</span><span class="main">∈</span><span class="free">U</span> <span class="bound">s</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">τ</span><span class="main">∈</span>down <span class="main">(</span><span class="free">U</span> <span class="bound">s</span><span class="main">)</span> <span class="bound">t</span><span class="main">.</span> <span class="free">G</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">τ</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">R</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">t</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> 
  <span class="main">(</span><span class="keyword1">EVOL</span> <span class="free">φ</span> <span class="free">G</span> <span class="free">U</span><span class="main">)</span> <span class="main">;</span> rel_R <span class="main">⌈</span><span class="free">R</span><span class="main">⌉</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span> <span class="main">≤</span> rel_R <span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> R_seq_law<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> R_g_evol_law<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> R_g_evolr<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">φ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>preorder<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">t</span><span class="main">∈</span><span class="free">U</span> <span class="bound">s</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">τ</span><span class="main">∈</span>down <span class="main">(</span><span class="free">U</span> <span class="bound">s</span><span class="main">)</span> <span class="bound">t</span><span class="main">.</span> <span class="free">G</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">τ</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">Q</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">t</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> 
  rel_R <span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">⌈</span><span class="free">R</span><span class="main">⌉</span><span class="main">;</span> <span class="main">(</span><span class="keyword1">EVOL</span> <span class="free">φ</span> <span class="free">G</span> <span class="free">U</span><span class="main">)</span> <span class="main">≤</span> rel_R <span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> R_seq_law<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> R_g_evol_law<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">φ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>preorder<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">EVOL</span> <span class="free">φ</span> <span class="free">G</span> <span class="free">U</span> <span class="main">;</span> rel_R <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span> <span class="main">≤</span> rel_R <span class="main">⌈</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">t</span><span class="main">∈</span><span class="free">U</span> <span class="bound">s</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">τ</span><span class="main">∈</span>down <span class="main">(</span><span class="free">U</span> <span class="bound">s</span><span class="main">)</span> <span class="bound">t</span><span class="main">.</span> <span class="free">G</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">τ</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">Q</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">t</span> <span class="bound">s</span><span class="main">)</span><span class="main">⌉</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> R_g_evoll<span class="main">)</span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">φ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>preorder<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"rel_R <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span> <span class="main">⌈</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">t</span><span class="main">∈</span><span class="free">U</span> <span class="bound">s</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">τ</span><span class="main">∈</span>down <span class="main">(</span><span class="free">U</span> <span class="bound">s</span><span class="main">)</span> <span class="bound">t</span><span class="main">.</span> <span class="free">G</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">τ</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">Q</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">t</span> <span class="bound">s</span><span class="main">)</span><span class="main">⌉</span><span class="main">;</span> <span class="keyword1">EVOL</span> <span class="free">φ</span> <span class="free">G</span> <span class="free">U</span> <span class="main">≤</span> rel_R <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> R_g_evolr<span class="main">)</span> <span class="operator">simp</span>

<span class="comment1">― ‹ Evolution command (ode) ›</span>

<span class="keyword1"><span class="command">context</span></span> local_flow
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> R_g_ode_subset<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">∈</span> <span class="free">U</span> <span class="bound">s</span> <span class="main">∧</span> is_interval <span class="main">(</span><span class="free">U</span> <span class="bound">s</span><span class="main">)</span> <span class="main">∧</span> <span class="free">U</span> <span class="bound">s</span> <span class="main">⊆</span> <span class="free">T</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">x´=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">f</span><span class="main">)</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="main">0</span><span class="main">)</span> <span class="main">≤</span> 
  rel_R <span class="main">⌈</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">∈</span><span class="free">S</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">t</span><span class="main">∈</span><span class="free">U</span> <span class="bound">s</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">τ</span><span class="main">∈</span>down <span class="main">(</span><span class="free">U</span> <span class="bound">s</span><span class="main">)</span> <span class="bound">t</span><span class="main">.</span> <span class="free">G</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">τ</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">P</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">t</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">⌉</span> <span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> rel_rkat.spec_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> H_g_ode_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> R_g_ode_rule_subset<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">∈</span> <span class="free">U</span> <span class="bound">s</span> <span class="main">∧</span> is_interval <span class="main">(</span><span class="free">U</span> <span class="bound">s</span><span class="main">)</span> <span class="main">∧</span> <span class="free">U</span> <span class="bound">s</span> <span class="main">⊆</span> <span class="free">T</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">s</span><span class="main">∈</span><span class="free">S</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">t</span><span class="main">∈</span><span class="free">U</span> <span class="bound">s</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">τ</span><span class="main">∈</span>down <span class="main">(</span><span class="free">U</span> <span class="bound">s</span><span class="main">)</span> <span class="bound">t</span><span class="main">.</span> <span class="free">G</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">τ</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">Q</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">t</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> 
  <span class="main">(</span><span class="keyword1">x´=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">f</span><span class="main">)</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="main">0</span><span class="main">)</span> <span class="main">≤</span> rel_R <span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> rel_rkat.R2<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> sH_g_ode_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> R_g_odel_subset<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">∈</span> <span class="free">U</span> <span class="bound">s</span> <span class="main">∧</span> is_interval <span class="main">(</span><span class="free">U</span> <span class="bound">s</span><span class="main">)</span> <span class="main">∧</span> <span class="free">U</span> <span class="bound">s</span> <span class="main">⊆</span> <span class="free">T</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">t</span><span class="main">∈</span><span class="free">U</span> <span class="bound">s</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">τ</span><span class="main">∈</span>down <span class="main">(</span><span class="free">U</span> <span class="bound">s</span><span class="main">)</span> <span class="bound">t</span><span class="main">.</span> <span class="free">G</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">τ</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">R</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">t</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">x´=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">f</span><span class="main">)</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="main">0</span><span class="main">)</span> <span class="main">;</span> rel_R <span class="main">⌈</span><span class="free">R</span><span class="main">⌉</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span> <span class="main">≤</span> rel_R <span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> R_seq_law<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> R_g_ode_rule_subset<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> R_g_oder_subset<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">∈</span> <span class="free">U</span> <span class="bound">s</span> <span class="main">∧</span> is_interval <span class="main">(</span><span class="free">U</span> <span class="bound">s</span><span class="main">)</span> <span class="main">∧</span> <span class="free">U</span> <span class="bound">s</span> <span class="main">⊆</span> <span class="free">T</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">t</span><span class="main">∈</span><span class="free">U</span> <span class="bound">s</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">τ</span><span class="main">∈</span>down <span class="main">(</span><span class="free">U</span> <span class="bound">s</span><span class="main">)</span> <span class="bound">t</span><span class="main">.</span> <span class="free">G</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">τ</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">Q</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">t</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"rel_R <span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">⌈</span><span class="free">R</span><span class="main">⌉</span><span class="main">;</span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">f</span><span class="main">)</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="main">0</span><span class="main">)</span> <span class="main">≤</span> rel_R <span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> R_seq_law<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> R_g_ode_rule_subset<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> R_g_ode<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">x´=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">f</span><span class="main">)</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">T</span><span class="main">)</span> <span class="free">S</span> <span class="main">@</span> <span class="main">0</span><span class="main">)</span> <span class="main">≤</span> 
  rel_R <span class="main">⌈</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">∈</span><span class="free">S</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">t</span><span class="main">∈</span><span class="free">T</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">τ</span><span class="main">∈</span>down <span class="free">T</span> <span class="bound">t</span><span class="main">.</span> <span class="free">G</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">τ</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">P</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">t</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">⌉</span> <span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> R_g_ode_subset<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> init_time interval_time<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> R_g_ode_law<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">s</span><span class="main">∈</span><span class="free">S</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">t</span><span class="main">∈</span><span class="free">T</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">τ</span><span class="main">∈</span>down <span class="free">T</span> <span class="bound">t</span><span class="main">.</span> <span class="free">G</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">τ</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">Q</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">t</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> 
  <span class="main">(</span><span class="keyword1">x´=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">f</span><span class="main">)</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">T</span><span class="main">)</span> <span class="free">S</span> <span class="main">@</span> <span class="main">0</span><span class="main">)</span> <span class="main">≤</span> rel_R <span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> sH_g_ode<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> rel_rkat.R2<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> R_g_odel<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">t</span><span class="main">∈</span><span class="free">T</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">τ</span><span class="main">∈</span>down <span class="free">T</span> <span class="bound">t</span><span class="main">.</span> <span class="free">G</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">τ</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">R</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">t</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> 
  <span class="main">(</span><span class="keyword1">x´=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">f</span><span class="main">)</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">T</span><span class="main">)</span> <span class="free">S</span> <span class="main">@</span> <span class="main">0</span><span class="main">)</span> <span class="main">;</span> rel_R <span class="main">⌈</span><span class="free">R</span><span class="main">⌉</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span> <span class="main">≤</span> rel_R <span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> R_g_odel_subset<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> init_time interval_time<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> R_g_oder<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">t</span><span class="main">∈</span><span class="free">T</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">τ</span><span class="main">∈</span>down <span class="free">T</span> <span class="bound">t</span><span class="main">.</span> <span class="free">G</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">τ</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">Q</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">t</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> 
  rel_R <span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">⌈</span><span class="free">R</span><span class="main">⌉</span><span class="main">;</span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">f</span><span class="main">)</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">T</span><span class="main">)</span> <span class="free">S</span> <span class="main">@</span> <span class="main">0</span><span class="main">)</span> <span class="main">≤</span> rel_R <span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> R_g_oder_subset<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> init_time interval_time<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> R_g_ode_ivl<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">≥</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free">t</span> <span class="main">∈</span> <span class="free">T</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">∀</span><span class="bound">s</span><span class="main">∈</span><span class="free">S</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">t</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">t</span><span class="main">}</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">τ</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="bound">t</span><span class="main">}</span><span class="main">.</span> <span class="free">G</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">τ</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">Q</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">t</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> 
  <span class="main">(</span><span class="keyword1">x´=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">f</span><span class="main">)</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">t</span><span class="main">}</span><span class="main">)</span> <span class="free">S</span> <span class="main">@</span> <span class="main">0</span><span class="main">)</span> <span class="main">≤</span> rel_R <span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> sH_g_ode_ivl<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> rel_rkat.R2<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="comment1">― ‹ Evolution command (invariants) ›</span>

<span class="keyword1"><span class="command">lemma</span></span> R_g_ode_inv<span class="main">:</span> <span class="quoted"><span class="quoted">"diff_invariant <span class="free">I</span> <span class="free">f</span> <span class="free">T</span> <span class="free">S</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">G</span> <span class="main">⟹</span> <span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">≤</span> <span class="main">⌈</span><span class="free">I</span><span class="main">⌉</span> <span class="main">⟹</span> <span class="main">⌈</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">I</span> <span class="bound">s</span> <span class="main">∧</span> <span class="free">G</span> <span class="bound">s</span><span class="main">⌉</span> <span class="main">≤</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span> <span class="main">⟹</span> 
  <span class="main">(</span><span class="keyword1">x´=</span><span class="free">f</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="free">T</span> <span class="free">S</span> <span class="main">@</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="keyword1">DINV</span> <span class="free">I</span><span class="main">)</span> <span class="main">≤</span> rel_R <span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> rel_rkat.spec_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> H_g_ode_inv<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹ Derivation of the rules of dL ›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ We derive rules of differential dynamic logic (dL). This allows the components to reason 
in the style of that logic. ›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">g_dl_ode</span> <span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>banach<span class="main">)</span><span class="main">⇒</span><span class="tfree">'a</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> pred <span class="main">⇒</span> <span class="tfree">'a</span> rel"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword3">(1</span><span class="keyword1">x´=</span>_ <span class="keyword1">&amp;</span> _<span class="keyword3">)</span>"</span><span class="main">)</span> 
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1"><span class="free">x´=</span></span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main"><span class="free">&amp;</span></span> <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span> <span class="main">≡</span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="main">&amp;</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="keyword1">on</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">{</span><span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">≥</span> <span class="main">0</span><span class="main">}</span><span class="main">)</span> UNIV <span class="main">@</span> <span class="main">0</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">g_dl_ode_inv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>banach<span class="main">)</span><span class="main">⇒</span><span class="tfree">'a</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> pred <span class="main">⇒</span> <span class="tfree">'a</span> pred <span class="main">⇒</span> <span class="tfree">'a</span> rel"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword3">(1</span><span class="keyword1">x´=</span>_ <span class="keyword1">&amp;</span> _ <span class="keyword1">DINV</span> _<span class="keyword3">)</span>"</span><span class="main">)</span> 
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1"><span class="free">x´=</span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main"><span class="free">&amp;</span></span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="keyword1"><span class="free">DINV</span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">)</span> <span class="main">≡</span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="main">&amp;</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="keyword1">on</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">{</span><span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">≥</span> <span class="main">0</span><span class="main">}</span><span class="main">)</span> UNIV <span class="main">@</span> <span class="main">0</span> <span class="keyword1">DINV</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> diff_solve_rule1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"local_flow <span class="free">f</span> UNIV UNIV <span class="free">φ</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">t</span></span><span class="main">≥</span><span class="main">0</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">τ</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="bound">t</span><span class="main">}</span><span class="main">.</span> <span class="free">G</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">τ</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">Q</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">t</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">P</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="free">f</span> <span class="main">&amp;</span> <span class="free">G</span><span class="main">)</span> <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">Q</span><span class="main"><span class="hidden">❙</span><b>}</b></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">subst</span> local_flow.sH_g_ode_subset<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> diff_solve_rule2<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">c</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>heine_borel<span class="main">,</span> banach<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">t</span></span><span class="main">≥</span><span class="main">0</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">τ</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="bound">t</span><span class="main">}</span><span class="main">.</span> <span class="free">G</span> <span class="main">(</span><span class="bound">s</span> <span class="main">+</span> <span class="bound">τ</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">c</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">Q</span> <span class="main">(</span><span class="bound">s</span> <span class="main">+</span> <span class="bound">t</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">c</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">P</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="main">(</span><span class="keyword1">x´=</span><span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">c</span><span class="main">)</span> <span class="main">&amp;</span> <span class="free">G</span><span class="main">)</span> <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">Q</span><span class="main"><span class="hidden">❙</span><b>}</b></span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> local_flow.sH_g_ode_subset<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> T<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">UNIV</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> φ<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="main"><span class="main">λ</span></span> <span class="bound"><span class="bound">t</span></span> <span class="bound"><span class="bound">x</span></span><span class="main"><span class="main">.</span></span> <span class="bound"><span class="bound">x</span></span> <span class="main"><span class="main">+</span></span> <span class="bound"><span class="bound">t</span></span> <span class="keyword1"><span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span></span> <span class="free"><span class="free">c</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> line_is_local_flow assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> diff_weak_rule<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⌈</span><span class="free">G</span><span class="main">⌉</span> <span class="main">≤</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">P</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="free">f</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">Q</span><span class="main"><span class="hidden">❙</span><b>}</b></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> g_orbital_eq rel_kat_H ivp_sols_def g_ode_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> diff_cut_rule<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> wp_C<span class="main">:</span><span class="quoted"><span class="quoted">"rel_kat.Hoare <span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="free">f</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">⌈</span><span class="free">C</span><span class="main">⌉</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> wp_Q<span class="main">:</span><span class="quoted"><span class="quoted">"rel_kat.Hoare <span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="free">f</span> <span class="main">&amp;</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">s</span><span class="main">.</span> <span class="free">G</span> <span class="bound">s</span> <span class="main">∧</span> <span class="free">C</span> <span class="bound">s</span><span class="main">)</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">P</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="free">f</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">Q</span><span class="main"><span class="hidden">❙</span><b>}</b></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">subst</span> rel_kat_H<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> g_orbital_eq p2r_def g_ode_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span><span class="main">::</span><span class="quoted">real</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">X</span><span class="main">::</span><span class="quoted"><span class="quoted">"real <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">s</span> 
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> <span class="free">U</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> x_ivp<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> ivp_sols <span class="free">f</span> <span class="free">U</span> <span class="free">S</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">s</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> guard_x<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">U</span> <span class="skolem">s</span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">≤</span> <span class="skolem">t</span> <span class="main">⟶</span> <span class="free">G</span> <span class="main">(</span><span class="skolem">X</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t</span><span class="main">∈</span><span class="main">(</span>down <span class="main">(</span><span class="free">U</span> <span class="skolem">s</span><span class="main">)</span> <span class="skolem">t</span><span class="main">)</span><span class="main">.</span> <span class="skolem">X</span> <span class="bound">t</span> <span class="main">∈</span> g_orbital <span class="free">f</span> <span class="free">G</span> <span class="free">U</span> <span class="free">S</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> g_orbitalI<span class="main">[</span><span class="operator">OF</span> x_ivp<span class="main">]</span> guard_x <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t</span><span class="main">∈</span><span class="main">(</span>down <span class="main">(</span><span class="free">U</span> <span class="skolem">s</span><span class="main">)</span> <span class="skolem">t</span><span class="main">)</span><span class="main">.</span> <span class="free">C</span> <span class="main">(</span><span class="skolem">X</span> <span class="bound">t</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> wp_C <span class="quoted"><span class="quoted">‹<span class="free">P</span> <span class="skolem">s</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> rel_kat_H<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> g_ode_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="skolem">t</span> <span class="main">∈</span> g_orbital <span class="free">f</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">G</span> <span class="bound">s</span> <span class="main">∧</span> <span class="free">C</span> <span class="bound">s</span><span class="main">)</span> <span class="free">U</span> <span class="free">S</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> guard_x <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="main">∈</span> <span class="free">U</span> <span class="skolem">s</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> g_orbitalI x_ivp<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="main">(</span><span class="skolem">X</span> <span class="skolem">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">P</span> <span class="skolem">s</span>›</span></span> wp_Q <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> rel_kat_H<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> g_ode_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> diff_inv_rule<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">≤</span> <span class="main">⌈</span><span class="free">I</span><span class="main">⌉</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"diff_invariant <span class="free">I</span> <span class="free">f</span> <span class="free">U</span> <span class="free">S</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">G</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⌈</span><span class="free">I</span><span class="main">⌉</span> <span class="main">≤</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">P</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="free">f</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">Q</span><span class="main"><span class="hidden">❙</span><b>}</b></span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> g_ode_inv_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">,</span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> I<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free">I</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> H_g_ode_inv<span class="main">)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> sH_diff_inv <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="HS_VC_KAT_Examples_rel">
<div class="head">
<h1>Theory HS_VC_KAT_Examples_rel</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:       Examples of hybrid systems verifications
    Author:      Jonathan Julián Huerta y Munive, 2020
    Maintainer:  Jonathan Julián Huerta y Munive &lt;jonjulian23@gmail.com&gt;
*)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹ Examples ›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ We prove partial correctness specifications of some hybrid systems with our 
refinement and verification components.›</span></span>

<span class="keyword1"><span class="command">theory</span></span> HS_VC_KAT_Examples_rel
  <span class="keyword2"><span class="keyword">imports</span></span> 
    <a href="HS_VC_KAT_rel.html">HS_VC_KAT_rel</a>
    <span class="quoted">"<a href="../../HOL/HOL-Eisbach/Eisbach.html">HOL-Eisbach.Eisbach</a>"</span>

<span class="keyword2"><span class="keyword">begin</span></span>

<span class="comment1">― ‹A tactic for verification of hybrid programs ›</span>

<span class="keyword1"><span class="command">named_theorems</span></span> hoare_intros

<span class="keyword1"><span class="command">declare</span></span> H_assignl <span class="main">[</span><span class="operator">hoare_intros</span><span class="main">]</span>
    <span class="keyword2"><span class="keyword">and</span></span> H_cond <span class="main">[</span><span class="operator">hoare_intros</span><span class="main">]</span>
    <span class="keyword2"><span class="keyword">and</span></span> local_flow.H_g_ode_subset <span class="main">[</span><span class="operator">hoare_intros</span><span class="main">]</span>
    <span class="keyword2"><span class="keyword">and</span></span> H_g_ode_inv <span class="main">[</span><span class="operator">hoare_intros</span><span class="main">]</span>

<span class="keyword1"><span class="command">method</span></span> body_hoare 
  <span class="main">=</span> <span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">hoare_intros</span></span><span class="main"><span class="keyword3">,</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">body_hoare</span><span class="main"><span class="keyword3">?</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">method</span></span> hyb_hoare <span class="keyword2"><span class="keyword">for</span></span> <span class="free">P</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> pred"</span></span> 
  <span class="main">=</span> <span class="main">(</span><span class="operator">rule</span> H_loopI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> H_seq<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> R<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">P</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">body_hoare</span><span class="main"><span class="keyword3">?</span></span><span class="main">)</span>

<span class="comment1">― ‹A tactic for refinement of hybrid programs ›</span>

<span class="keyword1"><span class="command">named_theorems</span></span> refine_intros <span class="quoted">"selected refinement lemmas"</span>

<span class="keyword1"><span class="command">declare</span></span> R_loopI <span class="main">[</span><span class="operator">refine_intros</span><span class="main">]</span>
    <span class="keyword2"><span class="keyword">and</span></span> R_loop_mono <span class="main">[</span><span class="operator">refine_intros</span><span class="main">]</span>
    <span class="keyword2"><span class="keyword">and</span></span> R_cond_law <span class="main">[</span><span class="operator">refine_intros</span><span class="main">]</span>
    <span class="keyword2"><span class="keyword">and</span></span> R_cond_mono <span class="main">[</span><span class="operator">refine_intros</span><span class="main">]</span>
    <span class="keyword2"><span class="keyword">and</span></span> R_while_law <span class="main">[</span><span class="operator">refine_intros</span><span class="main">]</span>
    <span class="keyword2"><span class="keyword">and</span></span> R_assignl <span class="main">[</span><span class="operator">refine_intros</span><span class="main">]</span>
    <span class="keyword2"><span class="keyword">and</span></span> R_seq_law <span class="main">[</span><span class="operator">refine_intros</span><span class="main">]</span>
    <span class="keyword2"><span class="keyword">and</span></span> R_seq_mono <span class="main">[</span><span class="operator">refine_intros</span><span class="main">]</span>
    <span class="keyword2"><span class="keyword">and</span></span> R_g_evol_law <span class="main">[</span><span class="operator">refine_intros</span><span class="main">]</span>
    <span class="keyword2"><span class="keyword">and</span></span> R_skip <span class="main">[</span><span class="operator">refine_intros</span><span class="main">]</span>
    <span class="keyword2"><span class="keyword">and</span></span> R_g_ode_inv <span class="main">[</span><span class="operator">refine_intros</span><span class="main">]</span>

<span class="keyword1"><span class="command">method</span></span> refinement
  <span class="main">=</span> <span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">refine_intros</span></span><span class="main"><span class="keyword3">;</span></span> <span class="main">(</span><span class="operator">refinement</span><span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Pendulum›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ The ODEs <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"x' t = y t"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and {text "y' t = - x t"} describe the circular motion of 
a mass attached to a string looked from above. We use <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"s$1"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> to represent the x-coordinate
and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"s$2"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> for the y-coordinate. We prove that this motion remains circular. ›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">fpend</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real<span class="main">^</span><span class="numeral">2</span> <span class="main">⇒</span> real<span class="main">^</span><span class="numeral">2</span>"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">f</span>"</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">f</span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="keyword1">χ</span> <span class="bound">i</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">i</span><span class="main">=</span><span class="main">1</span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="numeral">2</span> <span class="keyword1">else</span> <span class="main">-</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="main">1</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">pend_flow</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real <span class="main">⇒</span> real<span class="main">^</span><span class="numeral">2</span> <span class="main">⇒</span> real<span class="main">^</span><span class="numeral">2</span>"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">φ</span>"</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">φ</span></span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="keyword1">χ</span> <span class="bound">i</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">i</span> <span class="main">=</span> <span class="main">1</span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="main">1</span> <span class="main">⋅</span> cos <span class="free"><span class="bound"><span class="entity">τ</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="numeral">2</span> <span class="main">⋅</span> sin <span class="free"><span class="bound"><span class="entity">τ</span></span></span> 
  <span class="keyword1">else</span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="main">1</span> <span class="main">⋅</span> sin <span class="free"><span class="bound"><span class="entity">τ</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="numeral">2</span> <span class="main">⋅</span> cos <span class="free"><span class="bound"><span class="entity">τ</span></span></span><span class="main">)</span>"</span></span>

<span class="comment1">― ‹Verified with annotated dynamics ›</span>

<span class="keyword1"><span class="command">lemma</span></span> pendulum_dyn<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>{</b></span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">=</span> <span class="main">(</span><span class="bound">s</span> <span class="main">$</span> <span class="main">1</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">+</span> <span class="main">(</span><span class="bound">s</span> <span class="main">$</span> <span class="numeral">2</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="keyword1">EVOL</span> <span class="keyword1">φ</span> <span class="free">G</span> <span class="free">T</span> <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">=</span> <span class="main">(</span><span class="bound">s</span> <span class="main">$</span> <span class="main">1</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">+</span> <span class="main">(</span><span class="bound">s</span> <span class="main">$</span> <span class="numeral">2</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main"><span class="hidden">❙</span><b>}</b></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="comment1">― ‹Verified with differential invariants ›</span>

<span class="keyword1"><span class="command">lemma</span></span> pendulum_inv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>{</b></span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">=</span> <span class="main">(</span><span class="bound">s</span> <span class="main">$</span> <span class="main">1</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">+</span> <span class="main">(</span><span class="bound">s</span> <span class="main">$</span> <span class="numeral">2</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="main">(</span><span class="keyword1">x´=</span><span class="keyword1">f</span> <span class="main">&amp;</span> <span class="free">G</span><span class="main">)</span> <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">=</span> <span class="main">(</span><span class="bound">s</span> <span class="main">$</span> <span class="main">1</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">+</span> <span class="main">(</span><span class="bound">s</span> <span class="main">$</span> <span class="numeral">2</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main"><span class="hidden">❙</span><b>}</b></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">diff_invariant_rules</span></span> <span class="dynamic"><span class="dynamic">poly_derivatives</span></span><span class="main">)</span>

<span class="comment1">― ‹Verified with the flow ›</span>

<span class="keyword1"><span class="command">lemma</span></span> local_flow_pend<span class="main">:</span> <span class="quoted"><span class="quoted">"local_flow <span class="keyword1">f</span> UNIV UNIV <span class="keyword1">φ</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> local_lipschitz_def lipschitz_on_def vec_eq_iff<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="main">1</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dist_norm norm_vec_def L2_set_def power2_commute UNIV_2<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> forall_2 <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">poly_derivatives</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> pendulum_flow<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>{</b></span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">=</span> <span class="main">(</span><span class="bound">s</span> <span class="main">$</span> <span class="main">1</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">+</span> <span class="main">(</span><span class="bound">s</span> <span class="main">$</span> <span class="numeral">2</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="main">(</span><span class="keyword1">x´=</span><span class="keyword1">f</span> <span class="main">&amp;</span> <span class="free">G</span><span class="main">)</span> <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">=</span> <span class="main">(</span><span class="bound">s</span> <span class="main">$</span> <span class="main">1</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">+</span> <span class="main">(</span><span class="bound">s</span> <span class="main">$</span> <span class="numeral">2</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main"><span class="hidden">❙</span><b>}</b></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> local_flow.sH_g_ode_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> local_flow_pend<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>

<span class="keyword1"><span class="command">no_notation</span></span> fpend <span class="main">(</span><span class="quoted">"<span class="keyword1">f</span>"</span><span class="main">)</span>
        <span class="keyword2"><span class="keyword">and</span></span> pend_flow <span class="main">(</span><span class="quoted">"<span class="keyword1">φ</span>"</span><span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹ Bouncing Ball ›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ A ball is dropped from rest at an initial height <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"h"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. The motion is described with
the free-fall equations <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"x' t = v t"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"v' t = g"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> where <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"g"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is the
constant acceleration due to gravity. The bounce is modelled with a variable assignment that
flips the velocity. That is, we model it as a completely elastic collision with the ground. We use 
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"s$1"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> to represent the ball's height and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"s$2"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> for its velocity. We prove that the 
ball remains above ground and below its initial resting position. ›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">fball</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real <span class="main">⇒</span> real<span class="main">^</span><span class="numeral">2</span> <span class="main">⇒</span> real<span class="main">^</span><span class="numeral">2</span>"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">f</span>"</span><span class="main">)</span> 
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">f</span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="keyword1">χ</span> <span class="bound">i</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">i</span><span class="main">=</span><span class="main">1</span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="numeral">2</span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">ball_flow</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real <span class="main">⇒</span> real <span class="main">⇒</span> real<span class="main">^</span><span class="numeral">2</span> <span class="main">⇒</span> real<span class="main">^</span><span class="numeral">2</span>"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">φ</span>"</span><span class="main">)</span> 
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">φ</span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="keyword1">χ</span> <span class="bound">i</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">i</span><span class="main">=</span><span class="main">1</span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">⋅</span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span> <span class="main">^</span> <span class="numeral">2</span><span class="main">/</span><span class="numeral">2</span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="numeral">2</span> <span class="main">⋅</span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="main">1</span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">⋅</span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="numeral">2</span><span class="main">)</span>"</span></span>

<span class="comment1">― ‹Verified with differential invariants ›</span>

<span class="keyword1"><span class="command">named_theorems</span></span> bb_real_arith <span class="quoted">"real arithmetic properties for the bouncing ball."</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">bb_real_arith</span><span class="main">]</span><span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&gt;</span> <span class="free">g</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">⋅</span> <span class="free">g</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">-</span> <span class="numeral">2</span> <span class="main">⋅</span> <span class="free">g</span> <span class="main">⋅</span> <span class="free">h</span> <span class="main">=</span> <span class="free">v</span> <span class="main">⋅</span> <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">::</span>real<span class="main">)</span> <span class="main">≤</span> <span class="free">h</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">⋅</span> <span class="free">v</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">⋅</span> <span class="free">g</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">-</span> <span class="numeral">2</span> <span class="main">⋅</span> <span class="free">g</span> <span class="main">⋅</span> <span class="free">h</span> <span class="main">∧</span> <span class="main">0</span> <span class="main">&gt;</span> <span class="free">g</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> inv <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&gt;</span> <span class="free">g</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> obs<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">⋅</span> <span class="free">v</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">⋅</span> <span class="free">g</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">x</span> <span class="main">-</span> <span class="free">h</span><span class="main">)</span> <span class="main">∧</span> <span class="main">0</span> <span class="main">&gt;</span> <span class="free">g</span> <span class="main">∧</span> <span class="free">v</span> <span class="main">⋅</span> <span class="free">v</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> left_diff_distrib mult.commute <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> zero_le_square<span class="main">)</span> 
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">v</span> <span class="main">⋅</span> <span class="free">v</span><span class="main">)</span><span class="main">/</span><span class="main">(</span><span class="numeral">2</span> <span class="main">⋅</span> <span class="free">g</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span> <span class="main">-</span> <span class="free">h</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> obs <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">v</span> <span class="main">⋅</span> <span class="free">v</span><span class="main">)</span><span class="main">/</span><span class="main">(</span><span class="numeral">2</span> <span class="main">⋅</span> <span class="free">g</span><span class="main">)</span> <span class="main">≤</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> divide_nonneg_neg <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> 
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">-</span> <span class="free">x</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> fball_invariant<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">g</span> <span class="free">h</span> <span class="main">::</span> <span class="quoted">real</span>
  <span class="keyword2"><span class="keyword">defines</span></span> dinv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">≡</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="numeral">2</span> <span class="main">⋅</span> <span class="free">g</span> <span class="main">⋅</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">-</span> <span class="numeral">2</span> <span class="main">⋅</span> <span class="free">g</span> <span class="main">⋅</span> <span class="free">h</span> <span class="main">-</span> <span class="main">(</span><span class="bound">s</span><span class="main">$</span><span class="numeral">2</span> <span class="main">⋅</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"diff_invariant <span class="free">I</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="keyword1">f</span> <span class="free">g</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> UNIV<span class="main">)</span> UNIV <span class="main">0</span> <span class="free">G</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> dinv <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">diff_invariant_rules</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">poly_derivatives</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> bouncing_ball_inv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free">h</span> <span class="main">≥</span> <span class="main">0</span> <span class="main">⟹</span>
 <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">=</span> <span class="free">h</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span> <span class="main">=</span> <span class="main">0</span><span class="main"><span class="hidden">❙</span><b>}</b></span>
  <span class="main">(</span><span class="keyword1">LOOP</span> 
      <span class="main">(</span><span class="main">(</span><span class="keyword1">x´=</span> <span class="keyword1">f</span> <span class="free">g</span> <span class="main">&amp;</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">≥</span> <span class="main">0</span><span class="main">)</span> <span class="keyword1">DINV</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="numeral">2</span> <span class="main">⋅</span> <span class="free">g</span> <span class="main">⋅</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">-</span> <span class="numeral">2</span> <span class="main">⋅</span> <span class="free">g</span> <span class="main">⋅</span> <span class="free">h</span> <span class="main">-</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span> <span class="main">⋅</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
       <span class="main">(</span><span class="keyword1">IF</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="keyword1">THEN</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">::=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">-</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">ELSE</span> <span class="keyword1">skip</span><span class="main">)</span><span class="main">)</span> 
    <span class="keyword1">INV</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">∧</span> <span class="numeral">2</span> <span class="main">⋅</span> <span class="free">g</span> <span class="main">⋅</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">⋅</span> <span class="free">g</span> <span class="main">⋅</span> <span class="free">h</span> <span class="main">+</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span> <span class="main">⋅</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span><span class="main">)</span><span class="main">)</span>
 <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">≤</span> <span class="free">h</span><span class="main"><span class="hidden">❙</span><b>}</b></span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">hyb_hoare</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">s</span><span class="main">::</span>real<span class="main">^</span><span class="numeral">2</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">∧</span> <span class="numeral">2</span> <span class="main">⋅</span> <span class="free">g</span> <span class="main">⋅</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">⋅</span> <span class="free">g</span> <span class="main">⋅</span> <span class="free">h</span> <span class="main">+</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span> <span class="main">⋅</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> fball_invariant <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">bb_real_arith</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">poly_derivatives</span></span> <span class="dynamic"><span class="dynamic">diff_invariant_rules</span></span><span class="main">)</span>

<span class="comment1">― ‹Verified with annotated dynamics ›</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">bb_real_arith</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> invar<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">⋅</span> <span class="free">g</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">⋅</span> <span class="free">g</span> <span class="main">⋅</span> <span class="free">h</span> <span class="main">+</span> <span class="free">v</span> <span class="main">⋅</span> <span class="free">v</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> pos<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">⋅</span> <span class="free">τ</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">+</span> <span class="free">v</span> <span class="main">⋅</span> <span class="free">τ</span> <span class="main">+</span> <span class="main">(</span><span class="free">x</span><span class="main">::</span>real<span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">⋅</span> <span class="free">g</span> <span class="main">⋅</span> <span class="free">h</span> <span class="main">+</span> <span class="main">(</span><span class="main">-</span> <span class="main">(</span><span class="free">g</span> <span class="main">⋅</span> <span class="free">τ</span><span class="main">)</span> <span class="main">-</span> <span class="free">v</span><span class="main">)</span> <span class="main">⋅</span> <span class="main">(</span><span class="main">-</span> <span class="main">(</span><span class="free">g</span> <span class="main">⋅</span> <span class="free">τ</span><span class="main">)</span> <span class="main">-</span> <span class="free">v</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">⋅</span> <span class="free">g</span> <span class="main">⋅</span> <span class="free">h</span> <span class="main">+</span> <span class="main">(</span><span class="free">g</span> <span class="main">⋅</span> <span class="free">τ</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">g</span> <span class="main">⋅</span> <span class="free">τ</span> <span class="main">+</span> <span class="free">v</span><span class="main">)</span> <span class="main">+</span> <span class="free">v</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">g</span> <span class="main">⋅</span> <span class="free">τ</span> <span class="main">+</span> <span class="free">v</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> pos <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">⋅</span> <span class="free">τ</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span>  <span class="main">+</span> <span class="numeral">2</span> <span class="main">⋅</span> <span class="free">v</span> <span class="main">⋅</span> <span class="free">τ</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span>  <span class="main">⋅</span> <span class="free">τ</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span>  <span class="main">+</span> <span class="numeral">2</span> <span class="main">⋅</span> <span class="free">g</span> <span class="main">⋅</span> <span class="free">v</span> <span class="main">⋅</span> <span class="free">τ</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">⋅</span> <span class="free">g</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> Groups.mult_ac<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>3<span class="main"><span class="main">)</span></span> mult_zero_right
        monoid_mult_class.power2_eq_square semiring_class.distrib_left<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">⋅</span> <span class="free">τ</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">⋅</span> <span class="free">g</span> <span class="main">⋅</span> <span class="free">v</span> <span class="main">⋅</span> <span class="free">τ</span> <span class="main">+</span> <span class="free">v</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">⋅</span> <span class="free">g</span> <span class="main">⋅</span> <span class="free">h</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> invar <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> monoid_mult_class.power2_eq_square<span class="main">)</span> 
  <span class="keyword1"><span class="command">hence</span></span> obs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">g</span> <span class="main">⋅</span> <span class="free">τ</span> <span class="main">+</span> <span class="free">v</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">⋅</span> <span class="free">g</span> <span class="main">⋅</span> <span class="free">h</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> power2_sum<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> Groups.add_ac<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">,</span></span> 3<span class="main"><span class="main">)</span></span> 
        Groups.mult_ac<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">,</span></span> 3<span class="main"><span class="main">)</span></span> monoid_mult_class.power2_eq_square nat_distrib<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">⋅</span> <span class="free">g</span> <span class="main">⋅</span> <span class="free">h</span> <span class="main">+</span> <span class="main">(</span><span class="free">g</span> <span class="main">⋅</span> <span class="free">τ</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">g</span> <span class="main">⋅</span> <span class="free">τ</span> <span class="main">+</span> <span class="free">v</span><span class="main">)</span> <span class="main">+</span> <span class="free">v</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">g</span> <span class="main">⋅</span> <span class="free">τ</span> <span class="main">+</span> <span class="free">v</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> monoid_mult_class.power2_eq_square<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span>  <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">⋅</span> <span class="free">g</span> <span class="main">⋅</span> <span class="free">h</span> <span class="main">+</span> <span class="main">(</span><span class="main">-</span> <span class="main">(</span><span class="main">(</span><span class="free">g</span> <span class="main">⋅</span> <span class="free">τ</span><span class="main">)</span> <span class="main">+</span> <span class="free">v</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> obs <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Groups.add_ac<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> power2_minus<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">⋅</span> <span class="free">g</span> <span class="main">⋅</span> <span class="free">h</span> <span class="main">+</span> <span class="main">(</span><span class="main">-</span> <span class="main">(</span><span class="free">g</span> <span class="main">⋅</span> <span class="free">τ</span><span class="main">)</span> <span class="main">-</span> <span class="free">v</span><span class="main">)</span> <span class="main">⋅</span> <span class="main">(</span><span class="main">-</span> <span class="main">(</span><span class="free">g</span> <span class="main">⋅</span> <span class="free">τ</span><span class="main">)</span> <span class="main">-</span> <span class="free">v</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> monoid_mult_class.power2_eq_square<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">bb_real_arith</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> invar<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">⋅</span> <span class="free">g</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">⋅</span> <span class="free">g</span> <span class="main">⋅</span> <span class="free">h</span> <span class="main">+</span> <span class="free">v</span> <span class="main">⋅</span> <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">⋅</span> <span class="free">g</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">g</span> <span class="main">⋅</span> <span class="free">τ</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">+</span> <span class="free">v</span> <span class="main">⋅</span> <span class="free">τ</span> <span class="main">+</span> <span class="main">(</span><span class="free">x</span><span class="main">::</span>real<span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
  <span class="numeral">2</span> <span class="main">⋅</span> <span class="free">g</span> <span class="main">⋅</span> <span class="free">h</span> <span class="main">+</span> <span class="main">(</span><span class="free">g</span> <span class="main">⋅</span> <span class="free">τ</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">g</span> <span class="main">⋅</span> <span class="free">τ</span> <span class="main">+</span> <span class="free">v</span><span class="main">)</span> <span class="main">+</span> <span class="free">v</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">g</span> <span class="main">⋅</span> <span class="free">τ</span> <span class="main">+</span> <span class="free">v</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="free">g</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">⋅</span> <span class="free">τ</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">⋅</span> <span class="free">g</span> <span class="main">⋅</span> <span class="free">v</span> <span class="main">⋅</span> <span class="free">τ</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">⋅</span> <span class="free">g</span> <span class="main">⋅</span> <span class="free">x</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span> semiring_normalization_rules<span class="main"><span class="main">(</span></span>29<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="free">g</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">⋅</span> <span class="free">τ</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">⋅</span> <span class="free">g</span> <span class="main">⋅</span> <span class="free">v</span> <span class="main">⋅</span> <span class="free">τ</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">⋅</span> <span class="free">g</span> <span class="main">⋅</span> <span class="free">h</span> <span class="main">+</span> <span class="free">v</span> <span class="main">⋅</span> <span class="free">v</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="var">?middle</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">subst</span> invar<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?middle</span>"</span></span><span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> 
  <span class="keyword1"><span class="command">{</span></span><span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?rhs</span> <span class="main">=</span> <span class="free">g</span> <span class="main">⋅</span> <span class="free">g</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">τ</span> <span class="main">⋅</span> <span class="free">τ</span><span class="main">)</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">⋅</span> <span class="free">g</span> <span class="main">⋅</span> <span class="free">v</span> <span class="main">⋅</span> <span class="free">τ</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">⋅</span> <span class="free">g</span> <span class="main">⋅</span> <span class="free">h</span> <span class="main">+</span> <span class="free">v</span> <span class="main">⋅</span> <span class="free">v</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Groups.mult_ac<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">,</span></span>3<span class="main"><span class="main">)</span></span> semiring_class.distrib_left<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="var">?middle</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> semiring_normalization_rules<span class="main"><span class="main">(</span></span>29<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?rhs</span> <span class="main">=</span> <span class="var">?middle</span>"</span></span><span class="keyword1"><span class="command">.</span></span><span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> bouncing_ball_dyn<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free">h</span> <span class="main">≥</span> <span class="main">0</span> <span class="main">⟹</span>
  <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">=</span> <span class="free">h</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span> <span class="main">=</span> <span class="main">0</span><span class="main"><span class="hidden">❙</span><b>}</b></span>
  <span class="main">(</span><span class="keyword1">LOOP</span> 
      <span class="main">(</span><span class="main">(</span><span class="keyword1">EVOL</span> <span class="main">(</span><span class="keyword1">φ</span> <span class="free">g</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">≥</span> <span class="main">0</span><span class="main">)</span> <span class="free">T</span><span class="main">)</span><span class="main">;</span>
       <span class="main">(</span><span class="keyword1">IF</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="keyword1">THEN</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">::=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">-</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">ELSE</span> <span class="keyword1">skip</span><span class="main">)</span><span class="main">)</span> 
    <span class="keyword1">INV</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">∧</span> <span class="numeral">2</span> <span class="main">⋅</span> <span class="free">g</span> <span class="main">⋅</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">⋅</span> <span class="free">g</span> <span class="main">⋅</span> <span class="free">h</span> <span class="main">+</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span> <span class="main">⋅</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span><span class="main">)</span>
  <span class="main">)</span> <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">≤</span> <span class="free">h</span><span class="main"><span class="hidden">❙</span><b>}</b></span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">hyb_hoare</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">s</span><span class="main">::</span>real<span class="main">^</span><span class="numeral">2</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">∧</span> <span class="numeral">2</span> <span class="main">⋅</span> <span class="free">g</span> <span class="main">⋅</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">⋅</span> <span class="free">g</span> <span class="main">⋅</span> <span class="free">h</span> <span class="main">+</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span> <span class="main">⋅</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">bb_real_arith</span></span><span class="main">)</span>

<span class="comment1">― ‹Verified with the flow ›</span>

<span class="keyword1"><span class="command">lemma</span></span> local_flow_ball<span class="main">:</span> <span class="quoted"><span class="quoted">"local_flow <span class="main">(</span><span class="keyword1">f</span> <span class="free">g</span><span class="main">)</span> UNIV UNIV <span class="main">(</span><span class="keyword1">φ</span> <span class="free">g</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> local_lipschitz_def lipschitz_on_def vec_eq_iff<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">1</span><span class="main">/</span><span class="numeral">2</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="main">1</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dist_norm norm_vec_def L2_set_def UNIV_2<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> forall_2 <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">poly_derivatives</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> bouncing_ball_flow<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free">h</span> <span class="main">≥</span> <span class="main">0</span> <span class="main">⟹</span>
  <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">=</span> <span class="free">h</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span> <span class="main">=</span> <span class="main">0</span><span class="main"><span class="hidden">❙</span><b>}</b></span>
  <span class="main">(</span><span class="keyword1">LOOP</span> 
      <span class="main">(</span><span class="main">(</span><span class="keyword1">x´=</span> <span class="keyword1">f</span> <span class="free">g</span> <span class="main">&amp;</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">≥</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
       <span class="main">(</span><span class="keyword1">IF</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="keyword1">THEN</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">::=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">-</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">ELSE</span> <span class="keyword1">skip</span><span class="main">)</span><span class="main">)</span> 
    <span class="keyword1">INV</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">∧</span> <span class="numeral">2</span> <span class="main">⋅</span> <span class="free">g</span> <span class="main">⋅</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">⋅</span> <span class="free">g</span> <span class="main">⋅</span> <span class="free">h</span> <span class="main">+</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span> <span class="main">⋅</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span><span class="main">)</span>
  <span class="main">)</span> <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">≤</span> <span class="free">h</span><span class="main"><span class="hidden">❙</span><b>}</b></span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> H_loopI<span class="main"><span class="keyword3">;</span></span> <span class="main">(</span><span class="operator">rule</span> H_seq<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> R<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">∧</span> <span class="numeral">2</span> <span class="main">⋅</span> <span class="free">g</span> <span class="main">⋅</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">⋅</span> <span class="free">g</span> <span class="main">⋅</span> <span class="free">h</span> <span class="main">+</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span> <span class="main">⋅</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> local_flow.sH_g_ode_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> local_flow_ball<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">bb_real_arith</span></span><span class="main">)</span>

<span class="comment1">― ‹Refined with annotated dynamics ›</span>

<span class="keyword1"><span class="command">lemma</span></span> R_bb_assign<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">&lt;</span> <span class="main">(</span><span class="main">0</span><span class="main">::</span>real<span class="main">)</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">≤</span> <span class="free">h</span> <span class="main">⟹</span> 
  <span class="numeral">2</span> <span class="main">::=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">-</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span><span class="main">)</span> <span class="main">≤</span> rel_R 
    <span class="main">⌈</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> <span class="main">0</span> <span class="main">≤</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">∧</span> <span class="numeral">2</span> <span class="main">⋅</span> <span class="free">g</span> <span class="main">⋅</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">⋅</span> <span class="free">g</span> <span class="main">⋅</span> <span class="free">h</span> <span class="main">+</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span> <span class="main">⋅</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span><span class="main">⌉</span> 
    <span class="main">⌈</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">∧</span> <span class="numeral">2</span> <span class="main">⋅</span> <span class="free">g</span> <span class="main">⋅</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">⋅</span> <span class="free">g</span> <span class="main">⋅</span> <span class="free">h</span> <span class="main">+</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span> <span class="main">⋅</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span><span class="main">⌉</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> R_assign_law<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> R_bouncing_ball_dyn<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"rel_R <span class="main">⌈</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">=</span> <span class="free">h</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span> <span class="main">=</span> <span class="main">0</span><span class="main">⌉</span> <span class="main">⌈</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">≤</span> <span class="free">h</span><span class="main">⌉</span> <span class="main">≥</span> 
  <span class="main">(</span><span class="keyword1">LOOP</span> 
      <span class="main">(</span><span class="main">(</span><span class="keyword1">EVOL</span> <span class="main">(</span><span class="keyword1">φ</span> <span class="free">g</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">≥</span> <span class="main">0</span><span class="main">)</span> <span class="free">T</span><span class="main">)</span><span class="main">;</span>
       <span class="main">(</span><span class="keyword1">IF</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="keyword1">THEN</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">::=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">-</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">ELSE</span> <span class="keyword1">skip</span><span class="main">)</span><span class="main">)</span> 
    <span class="keyword1">INV</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">∧</span> <span class="numeral">2</span> <span class="main">⋅</span> <span class="free">g</span> <span class="main">⋅</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">⋅</span> <span class="free">g</span> <span class="main">⋅</span> <span class="free">h</span> <span class="main">+</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span> <span class="main">⋅</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">refinement</span><span class="main"><span class="keyword3">;</span></span> <span class="main">(</span><span class="operator">rule</span> R_bb_assign<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">bb_real_arith</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">no_notation</span></span> fball <span class="main">(</span><span class="quoted">"<span class="keyword1">f</span>"</span><span class="main">)</span>
        <span class="keyword2"><span class="keyword">and</span></span> ball_flow <span class="main">(</span><span class="quoted">"<span class="keyword1">φ</span>"</span><span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹ Thermostat ›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ A thermostat has a chronometer, a thermometer and a switch to turn on and off a heater. 
At most every <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"τ"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> minutes, it sets its chronometer to <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">0</span></span><span class="main"><span class="main">::</span></span>real"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, it registers 
the room temperature, and it turns the heater on (or off) based on this reading. The temperature 
follows the ODE <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"T' = - a * (T - U)"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> where <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"U = L ≥ 0"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> when the heater 
is on, and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"U = 0"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> when it is off. We use <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">1</span></span><span class="main"><span class="main">::</span></span><span class="numeral"><span class="numeral">4</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> to denote the room's temperature, 
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="numeral"><span class="numeral">2</span></span><span class="main"><span class="main">::</span></span><span class="numeral"><span class="numeral">4</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is time as measured by the thermostat's chronometer, and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="numeral"><span class="numeral">3</span></span><span class="main"><span class="main">::</span></span><span class="numeral"><span class="numeral">4</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is a variable
to save temperature measurements. Finally, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="numeral"><span class="numeral">4</span></span><span class="main"><span class="main">::</span></span><span class="numeral"><span class="numeral">5</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> states whether the heater is on 
(<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"s$4 = 1"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>) or off (<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"s$4 = 0"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>). We prove that the thermostat keeps the room's 
temperature between <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"Tmin"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"Tmax"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. ›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">therm_vec_field</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real <span class="main">⇒</span> real <span class="main">⇒</span> real<span class="main">^</span><span class="numeral">4</span> <span class="main">⇒</span> real<span class="main">^</span><span class="numeral">4</span>"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">f</span>"</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">f</span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="keyword1">χ</span> <span class="bound">i</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">i</span> <span class="main">=</span> <span class="numeral">2</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">i</span> <span class="main">=</span> <span class="main">1</span> <span class="keyword1">then</span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">*</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="main">1</span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">L</span></span></span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">therm_guard</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real <span class="main">⇒</span> real <span class="main">⇒</span> real <span class="main">⇒</span> real <span class="main">⇒</span> real<span class="main">^</span><span class="numeral">4</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">G</span>"</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">G</span></span> <span class="free"><span class="bound"><span class="entity">Tmin</span></span></span> <span class="free"><span class="bound"><span class="entity">Tmax</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="numeral">2</span> <span class="main">≤</span> <span class="main">-</span> <span class="main">(</span>ln <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">L</span></span></span><span class="main">-</span><span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">L</span></span></span><span class="main">=</span><span class="main">0</span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">Tmin</span></span></span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">Tmax</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">/</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">L</span></span></span><span class="main">-</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="numeral">3</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">/</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">therm_loop_inv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real <span class="main">⇒</span> real <span class="main">⇒</span> real<span class="main">^</span><span class="numeral">4</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">I</span>"</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">I</span></span> <span class="free"><span class="bound"><span class="entity">Tmin</span></span></span> <span class="free"><span class="bound"><span class="entity">Tmax</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">Tmin</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="main">1</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="main">1</span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">Tmax</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="numeral">4</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="numeral">4</span> <span class="main">=</span> <span class="main">1</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">therm_flow</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real <span class="main">⇒</span> real <span class="main">⇒</span> real <span class="main">⇒</span> real<span class="main">^</span><span class="numeral">4</span> <span class="main">⇒</span> real<span class="main">^</span><span class="numeral">4</span>"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">φ</span>"</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">φ</span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="keyword1">χ</span> <span class="bound">i</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">i</span> <span class="main">=</span> <span class="main">1</span> <span class="keyword1">then</span> <span class="main">-</span> exp<span class="main">(</span><span class="main">-</span><span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">*</span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="keyword1">else</span> 
  <span class="main">(</span><span class="keyword1">if</span> <span class="bound">i</span> <span class="main">=</span> <span class="numeral">2</span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="numeral">2</span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="comment1">― ‹Verified with the flow ›</span>

<span class="keyword1"><span class="command">lemma</span></span> norm_diff_therm_dyn<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">a</span> <span class="main">⟹</span> <span class="main">∥</span><span class="keyword1">f</span> <span class="free">a</span> <span class="free">L</span> <span class="free">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">-</span> <span class="keyword1">f</span> <span class="free">a</span> <span class="free">L</span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub></span><span class="main">∥</span> <span class="main">=</span> <span class="main">¦</span><span class="free">a</span><span class="main">¦</span> <span class="main">*</span> <span class="main">¦</span><span class="free">s<span class="hidden">⇩</span><sub>1</sub></span><span class="main">$</span><span class="main">1</span> <span class="main">-</span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub></span><span class="main">$</span><span class="main">1</span><span class="main">¦</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> norm_vec_def L2_set_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> UNIV_4<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> a1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> f2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">r</span> <span class="bound">ra</span><span class="main">.</span> <span class="main">¦</span><span class="main">(</span><span class="bound">r</span><span class="main">::</span>real<span class="main">)</span> <span class="main">+</span> <span class="main">-</span> <span class="bound">ra</span><span class="main">¦</span> <span class="main">=</span> <span class="main">¦</span><span class="bound">ra</span> <span class="main">+</span> <span class="main">-</span> <span class="bound">r</span><span class="main">¦</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> abs_minus_commute minus_real_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">r</span> <span class="bound">ra</span> <span class="bound">rb</span><span class="main">.</span> <span class="main">(</span><span class="bound">r</span><span class="main">::</span>real<span class="main">)</span> <span class="main">*</span> <span class="bound">ra</span> <span class="main">+</span> <span class="main">-</span> <span class="main">(</span><span class="bound">r</span> <span class="main">*</span> <span class="bound">rb</span><span class="main">)</span> <span class="main">=</span> <span class="bound">r</span> <span class="main">*</span> <span class="main">(</span><span class="bound">ra</span> <span class="main">+</span> <span class="main">-</span> <span class="bound">rb</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> minus_real_def right_diff_distrib<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="free">a</span> <span class="main">*</span> <span class="main">(</span><span class="free">s<span class="hidden">⇩</span><sub>1</sub></span><span class="main">$</span><span class="main">1</span> <span class="main">+</span> <span class="main">-</span> <span class="free">L</span><span class="main">)</span> <span class="main">+</span> <span class="main">-</span> <span class="main">(</span><span class="free">a</span> <span class="main">*</span> <span class="main">(</span><span class="free">s<span class="hidden">⇩</span><sub>2</sub></span><span class="main">$</span><span class="main">1</span> <span class="main">+</span> <span class="main">-</span> <span class="free">L</span><span class="main">)</span><span class="main">)</span><span class="main">¦</span> <span class="main">=</span> <span class="free">a</span> <span class="main">*</span> <span class="main">¦</span><span class="free">s<span class="hidden">⇩</span><sub>1</sub></span><span class="main">$</span><span class="main">1</span> <span class="main">+</span> <span class="main">-</span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub></span><span class="main">$</span><span class="main">1</span><span class="main">¦</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> a1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> abs_mult<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="free">a</span> <span class="main">*</span> <span class="main">(</span><span class="free">s<span class="hidden">⇩</span><sub>2</sub></span><span class="main">$</span><span class="main">1</span> <span class="main">-</span> <span class="free">L</span><span class="main">)</span> <span class="main">-</span> <span class="free">a</span> <span class="main">*</span> <span class="main">(</span><span class="free">s<span class="hidden">⇩</span><sub>1</sub></span><span class="main">$</span><span class="main">1</span> <span class="main">-</span> <span class="free">L</span><span class="main">)</span><span class="main">¦</span> <span class="main">=</span> <span class="free">a</span> <span class="main">*</span> <span class="main">¦</span><span class="free">s<span class="hidden">⇩</span><sub>1</sub></span><span class="main">$</span><span class="main">1</span> <span class="main">-</span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub></span><span class="main">$</span><span class="main">1</span><span class="main">¦</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> f2 minus_real_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> local_lipschitz_therm_dyn<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="main">(</span><span class="free">a</span><span class="main">::</span>real<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"local_lipschitz UNIV UNIV <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">::</span>real<span class="main">.</span> <span class="keyword1">f</span> <span class="free">a</span> <span class="free">L</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">unfold</span> local_lipschitz_def lipschitz_on_def dist_norm<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="main">1</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">a</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> norm_diff_therm_dyn<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> norm_vec_def L2_set_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> UNIV_4<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> real_sqrt_abs<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> real_le_lsqrt<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> local_flow_therm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟹</span> local_flow <span class="main">(</span><span class="keyword1">f</span> <span class="free">a</span> <span class="free">L</span><span class="main">)</span> UNIV UNIV <span class="main">(</span><span class="keyword1">φ</span> <span class="free">a</span> <span class="free">L</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">poly_derivatives</span></span> local_lipschitz_therm_dyn 
      <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> forall_4 vec_eq_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> therm_dyn_down_real_arith<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> Thyps<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">Tmin</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">Tmin</span> <span class="main">≤</span> <span class="free">T</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">T</span> <span class="main">≤</span> <span class="free">Tmax</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> thyps<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="main">(</span><span class="free">τ</span><span class="main">::</span>real<span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">τ</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">τ</span><span class="main">}</span><span class="main">.</span> <span class="bound">τ</span> <span class="main">≤</span> <span class="main">-</span> <span class="main">(</span>ln <span class="main">(</span><span class="free">Tmin</span> <span class="main">/</span> <span class="free">T</span><span class="main">)</span> <span class="main">/</span> <span class="free">a</span><span class="main">)</span> "</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Tmin</span> <span class="main">≤</span> exp <span class="main">(</span><span class="main">-</span><span class="free">a</span> <span class="main">*</span> <span class="free">τ</span><span class="main">)</span> <span class="main">*</span> <span class="free">T</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"exp <span class="main">(</span><span class="main">-</span><span class="free">a</span> <span class="main">*</span> <span class="free">τ</span><span class="main">)</span> <span class="main">*</span> <span class="free">T</span> <span class="main">≤</span> <span class="free">Tmax</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">τ</span> <span class="main">∧</span> <span class="free">τ</span> <span class="main">≤</span> <span class="main">-</span> <span class="main">(</span>ln <span class="main">(</span><span class="free">Tmin</span> <span class="main">/</span> <span class="free">T</span><span class="main">)</span> <span class="main">/</span> <span class="free">a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> thyps <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"ln <span class="main">(</span><span class="free">Tmin</span> <span class="main">/</span> <span class="free">T</span><span class="main">)</span> <span class="main">≤</span> <span class="main">-</span> <span class="free">a</span> <span class="main">*</span> <span class="free">τ</span> <span class="main">∧</span> <span class="main">-</span> <span class="free">a</span> <span class="main">*</span> <span class="free">τ</span> <span class="main">≤</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> divide_le_cancel <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Tmin</span> <span class="main">/</span> <span class="free">T</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Thyps <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> obs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Tmin</span> <span class="main">/</span> <span class="free">T</span> <span class="main">≤</span> exp <span class="main">(</span><span class="main">-</span><span class="free">a</span> <span class="main">*</span> <span class="free">τ</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"exp <span class="main">(</span><span class="main">-</span><span class="free">a</span> <span class="main">*</span> <span class="free">τ</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> exp_ln exp_le_one_iff <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> exp_less_cancel_iff not_less<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">Tmin</span> <span class="main">≤</span> exp <span class="main">(</span><span class="main">-</span><span class="free">a</span> <span class="main">*</span> <span class="free">τ</span><span class="main">)</span> <span class="main">*</span> <span class="free">T</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Thyps <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pos_divide_le_eq<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"exp <span class="main">(</span><span class="main">-</span><span class="free">a</span> <span class="main">*</span> <span class="free">τ</span><span class="main">)</span> <span class="main">*</span> <span class="free">T</span> <span class="main">≤</span> <span class="free">Tmax</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Thyps mult_left_le_one_le<span class="main">[</span><span class="operator">OF</span> _ exp_ge_zero obs<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">T</span></span><span class="main">]</span> 
      less_eq_real_def order_trans_rules<span class="main">(</span>23<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> therm_dyn_up_real_arith<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> Thyps<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Tmin</span> <span class="main">≤</span> <span class="free">T</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">T</span> <span class="main">≤</span> <span class="free">Tmax</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">Tmax</span> <span class="main">&lt;</span> <span class="main">(</span><span class="free">L</span><span class="main">::</span>real<span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> thyps<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">τ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">τ</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">τ</span><span class="main">}</span><span class="main">.</span> <span class="bound">τ</span> <span class="main">≤</span> <span class="main">-</span> <span class="main">(</span>ln <span class="main">(</span><span class="main">(</span><span class="free">L</span> <span class="main">-</span> <span class="free">Tmax</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="free">L</span> <span class="main">-</span> <span class="free">T</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> <span class="free">a</span><span class="main">)</span> "</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">L</span> <span class="main">-</span> <span class="free">Tmax</span> <span class="main">≤</span> exp <span class="main">(</span><span class="main">-</span><span class="main">(</span><span class="free">a</span> <span class="main">*</span> <span class="free">τ</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">L</span> <span class="main">-</span> <span class="free">T</span><span class="main">)</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">L</span> <span class="main">-</span> exp <span class="main">(</span><span class="main">-</span><span class="main">(</span><span class="free">a</span> <span class="main">*</span> <span class="free">τ</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">L</span> <span class="main">-</span> <span class="free">T</span><span class="main">)</span> <span class="main">≤</span> <span class="free">Tmax</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">Tmin</span> <span class="main">≤</span> <span class="free">L</span> <span class="main">-</span> exp <span class="main">(</span><span class="main">-</span><span class="main">(</span><span class="free">a</span> <span class="main">*</span> <span class="free">τ</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">L</span> <span class="main">-</span> <span class="free">T</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">τ</span> <span class="main">∧</span> <span class="free">τ</span> <span class="main">≤</span> <span class="main">-</span> <span class="main">(</span>ln <span class="main">(</span><span class="main">(</span><span class="free">L</span> <span class="main">-</span> <span class="free">Tmax</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="free">L</span> <span class="main">-</span> <span class="free">T</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> <span class="free">a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> thyps <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"ln <span class="main">(</span><span class="main">(</span><span class="free">L</span> <span class="main">-</span> <span class="free">Tmax</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="free">L</span> <span class="main">-</span> <span class="free">T</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="main">-</span> <span class="free">a</span> <span class="main">*</span> <span class="free">τ</span> <span class="main">∧</span> <span class="main">-</span> <span class="free">a</span> <span class="main">*</span> <span class="free">τ</span> <span class="main">≤</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> divide_le_cancel <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">L</span> <span class="main">-</span> <span class="free">Tmax</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="free">L</span> <span class="main">-</span> <span class="free">T</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Thyps <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">L</span> <span class="main">-</span> <span class="free">Tmax</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="free">L</span> <span class="main">-</span> <span class="free">T</span><span class="main">)</span> <span class="main">≤</span> exp <span class="main">(</span><span class="main">-</span><span class="free">a</span> <span class="main">*</span> <span class="free">τ</span><span class="main">)</span> <span class="main">∧</span> exp <span class="main">(</span><span class="main">-</span><span class="free">a</span> <span class="main">*</span> <span class="free">τ</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> exp_ln exp_le_one_iff <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> exp_less_cancel_iff not_less<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">L</span> <span class="main">-</span> <span class="free">T</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Thyps <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> obs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">L</span> <span class="main">-</span> <span class="free">Tmax</span><span class="main">)</span> <span class="main">≤</span> exp <span class="main">(</span><span class="main">-</span><span class="free">a</span> <span class="main">*</span> <span class="free">τ</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">L</span> <span class="main">-</span> <span class="free">T</span><span class="main">)</span> <span class="main">∧</span> exp <span class="main">(</span><span class="main">-</span><span class="free">a</span> <span class="main">*</span> <span class="free">τ</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">L</span> <span class="main">-</span> <span class="free">T</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="free">L</span> <span class="main">-</span> <span class="free">T</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pos_divide_le_eq<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">L</span> <span class="main">-</span> <span class="free">Tmax</span><span class="main">)</span> <span class="main">≤</span> exp <span class="main">(</span><span class="main">-</span><span class="main">(</span><span class="free">a</span> <span class="main">*</span> <span class="free">τ</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">L</span> <span class="main">-</span> <span class="free">T</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">L</span> <span class="main">-</span> exp <span class="main">(</span><span class="main">-</span><span class="main">(</span><span class="free">a</span> <span class="main">*</span> <span class="free">τ</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">L</span> <span class="main">-</span> <span class="free">T</span><span class="main">)</span> <span class="main">≤</span> <span class="free">Tmax</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">Tmin</span> <span class="main">≤</span> <span class="free">L</span> <span class="main">-</span> exp <span class="main">(</span><span class="main">-</span><span class="main">(</span><span class="free">a</span> <span class="main">*</span> <span class="free">τ</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">L</span> <span class="main">-</span> <span class="free">T</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Thyps <span class="keyword2"><span class="keyword">and</span></span> obs <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> H_g_ode_therm <span class="main">=</span> local_flow.sH_g_ode_ivl<span class="main">[</span><span class="operator">OF</span> local_flow_therm _ UNIV_I<span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> thermostat_flow<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">a</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">τ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">Tmin</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">Tmax</span> <span class="main">&lt;</span> <span class="free">L</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>{</b></span><span class="keyword1">I</span> <span class="free">Tmin</span> <span class="free">Tmax</span><span class="main"><span class="hidden">❙</span><b>}</b></span>
  <span class="main">(</span><span class="keyword1">LOOP</span> <span class="main">(</span>
    <span class="comment1">― ‹control›</span>
    <span class="main">(</span><span class="numeral">2</span> <span class="main">::=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
    <span class="main">(</span><span class="numeral">3</span> <span class="main">::=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
    <span class="main">(</span><span class="keyword1">IF</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">4</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">3</span> <span class="main">≤</span> <span class="free">Tmin</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">THEN</span> 
      <span class="main">(</span><span class="numeral">4</span> <span class="main">::=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> 
     <span class="keyword1">ELSE</span> <span class="keyword1">IF</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">4</span> <span class="main">=</span> <span class="main">1</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">3</span> <span class="main">≥</span> <span class="free">Tmax</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">THEN</span> 
      <span class="main">(</span><span class="numeral">4</span> <span class="main">::=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span><span class="main">0</span><span class="main">)</span><span class="main">)</span> 
     <span class="keyword1">ELSE</span> <span class="keyword1">skip</span><span class="main">)</span><span class="main">;</span>
    <span class="comment1">― ‹dynamics›</span>
    <span class="main">(</span><span class="keyword1">IF</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">4</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="keyword1">THEN</span> 
      <span class="main">(</span><span class="keyword1">x´=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="keyword1">f</span> <span class="free">a</span> <span class="main">0</span><span class="main">)</span> <span class="main">&amp;</span> <span class="keyword1">G</span> <span class="free">Tmin</span> <span class="free">Tmax</span> <span class="free">a</span> <span class="main">0</span> <span class="keyword1">on</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">τ</span><span class="main">}</span><span class="main">)</span> UNIV <span class="main">@</span> <span class="main">0</span><span class="main">)</span> 
    <span class="keyword1">ELSE</span> 
      <span class="main">(</span><span class="keyword1">x´=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="keyword1">f</span> <span class="free">a</span> <span class="free">L</span><span class="main">)</span> <span class="main">&amp;</span> <span class="keyword1">G</span> <span class="free">Tmin</span> <span class="free">Tmax</span> <span class="free">a</span> <span class="free">L</span> <span class="keyword1">on</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">τ</span><span class="main">}</span><span class="main">)</span> UNIV <span class="main">@</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>
  <span class="main">)</span> <span class="keyword1">INV</span> <span class="keyword1">I</span> <span class="free">Tmin</span> <span class="free">Tmax</span><span class="main">)</span>
   <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="keyword1">I</span> <span class="free">Tmin</span> <span class="free">Tmax</span><span class="main"><span class="hidden">❙</span><b>}</b></span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> H_loopI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="keyword1">I</span> <span class="free">Tmin</span> <span class="free">Tmax</span> <span class="bound">s</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span><span class="main">=</span><span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> H_seq<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="keyword1">I</span> <span class="free">Tmin</span> <span class="free">Tmax</span> <span class="bound">s</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span><span class="main">=</span><span class="main">0</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">=</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">3</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> H_seq<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="keyword1">I</span> <span class="free">Tmin</span> <span class="free">Tmax</span> <span class="bound">s</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span><span class="main">=</span><span class="main">0</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">=</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">3</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> H_seq<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> H_cond<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> H_g_ode_therm<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">,</span></span></span>2<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> therm_dyn_up_real_arith<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span>1<span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span> _ _ assms<span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span>4<span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">Tmin</span></span></span></span></span></span><span class="main">]</span>
    <span class="keyword2"><span class="keyword">and</span></span> therm_dyn_down_real_arith<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">,</span></span></span>3<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main">,</span> <span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">Tmax</span></span></span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="comment1">― ‹Refined with the flow ›</span>

<span class="keyword1"><span class="command">lemma</span></span> R_therm_dyn_down<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">τ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">Tmin</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">Tmax</span> <span class="main">&lt;</span> <span class="free">L</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"rel_R <span class="main">⌈</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">4</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> <span class="keyword1">I</span> <span class="free">Tmin</span> <span class="free">Tmax</span> <span class="bound">s</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">3</span> <span class="main">=</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span><span class="main">⌉</span> <span class="main">⌈</span><span class="keyword1">I</span> <span class="free">Tmin</span> <span class="free">Tmax</span><span class="main">⌉</span> <span class="main">≥</span> 
    <span class="main">(</span><span class="keyword1">x´=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="keyword1">f</span> <span class="free">a</span> <span class="main">0</span><span class="main">)</span> <span class="main">&amp;</span> <span class="keyword1">G</span> <span class="free">Tmin</span> <span class="free">Tmax</span> <span class="free">a</span> <span class="main">0</span> <span class="keyword1">on</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">τ</span><span class="main">}</span><span class="main">)</span> UNIV <span class="main">@</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> local_flow.R_g_ode_ivl<span class="main"><span class="main">[</span></span><span class="operator">OF</span> local_flow_therm<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> assms therm_dyn_down_real_arith<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">,</span></span></span>3<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main">,</span> <span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">Tmax</span></span></span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> R_therm_dyn_up<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">τ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">Tmin</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">Tmax</span> <span class="main">&lt;</span> <span class="free">L</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"rel_R <span class="main">⌈</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">4</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span> <span class="keyword1">I</span> <span class="free">Tmin</span> <span class="free">Tmax</span> <span class="bound">s</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">3</span> <span class="main">=</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span><span class="main">⌉</span> <span class="main">⌈</span><span class="keyword1">I</span> <span class="free">Tmin</span> <span class="free">Tmax</span><span class="main">⌉</span> <span class="main">≥</span> 
    <span class="main">(</span><span class="keyword1">x´=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="keyword1">f</span> <span class="free">a</span> <span class="free">L</span><span class="main">)</span> <span class="main">&amp;</span> <span class="keyword1">G</span> <span class="free">Tmin</span> <span class="free">Tmax</span> <span class="free">a</span> <span class="free">L</span> <span class="keyword1">on</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">τ</span><span class="main">}</span><span class="main">)</span> UNIV <span class="main">@</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> local_flow.R_g_ode_ivl<span class="main"><span class="main">[</span></span><span class="operator">OF</span> local_flow_therm<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> assms therm_dyn_up_real_arith<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span>1<span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span> _ _ assms<span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span>4<span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">Tmin</span></span></span></span></span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> R_therm_dyn<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">τ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">Tmin</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">Tmax</span> <span class="main">&lt;</span> <span class="free">L</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"rel_R <span class="main">⌈</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="keyword1">I</span> <span class="free">Tmin</span> <span class="free">Tmax</span> <span class="bound">s</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">3</span> <span class="main">=</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span><span class="main">⌉</span> <span class="main">⌈</span><span class="keyword1">I</span> <span class="free">Tmin</span> <span class="free">Tmax</span><span class="main">⌉</span> <span class="main">≥</span> 
  <span class="main">(</span><span class="keyword1">IF</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">4</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="keyword1">THEN</span> 
    <span class="main">(</span><span class="keyword1">x´=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="keyword1">f</span> <span class="free">a</span> <span class="main">0</span><span class="main">)</span> <span class="main">&amp;</span> <span class="keyword1">G</span> <span class="free">Tmin</span> <span class="free">Tmax</span> <span class="free">a</span> <span class="main">0</span> <span class="keyword1">on</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">τ</span><span class="main">}</span><span class="main">)</span> UNIV <span class="main">@</span> <span class="main">0</span><span class="main">)</span> 
  <span class="keyword1">ELSE</span> 
    <span class="main">(</span><span class="keyword1">x´=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="keyword1">f</span> <span class="free">a</span> <span class="free">L</span><span class="main">)</span> <span class="main">&amp;</span> <span class="keyword1">G</span> <span class="free">Tmin</span> <span class="free">Tmax</span> <span class="free">a</span> <span class="free">L</span> <span class="keyword1">on</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">τ</span><span class="main">}</span><span class="main">)</span> UNIV <span class="main">@</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> order_trans<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> R_cond_mono<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> R_therm_dyn_down<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> R_therm_dyn_down<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> R_therm_dyn_up<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> R_cond<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> R_therm_assign1<span class="main">:</span> <span class="quoted"><span class="quoted">"rel_R <span class="main">⌈</span><span class="keyword1">I</span> <span class="free">Tmin</span> <span class="free">Tmax</span><span class="main">⌉</span> <span class="main">⌈</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="keyword1">I</span> <span class="free">Tmin</span> <span class="free">Tmax</span> <span class="bound">s</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span> <span class="main">=</span> <span class="main">0</span><span class="main">⌉</span> <span class="main">≥</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">::=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> R_assign_law<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> R_therm_assign2<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"rel_R <span class="main">⌈</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="keyword1">I</span> <span class="free">Tmin</span> <span class="free">Tmax</span> <span class="bound">s</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span> <span class="main">=</span> <span class="main">0</span><span class="main">⌉</span> <span class="main">⌈</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="keyword1">I</span> <span class="free">Tmin</span> <span class="free">Tmax</span> <span class="bound">s</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">3</span> <span class="main">=</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span><span class="main">⌉</span> <span class="main">≥</span> <span class="main">(</span><span class="numeral">3</span> <span class="main">::=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> R_assign_law<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> R_therm_ctrl<span class="main">:</span>
  <span class="quoted"><span class="quoted">"rel_R <span class="main">⌈</span><span class="keyword1">I</span> <span class="free">Tmin</span> <span class="free">Tmax</span><span class="main">⌉</span> <span class="main">⌈</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="keyword1">I</span> <span class="free">Tmin</span> <span class="free">Tmax</span> <span class="bound">s</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">3</span> <span class="main">=</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span><span class="main">⌉</span> <span class="main">≥</span>
  <span class="main">(</span><span class="numeral">2</span> <span class="main">::=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
  <span class="main">(</span><span class="numeral">3</span> <span class="main">::=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
  <span class="main">(</span><span class="keyword1">IF</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">4</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">3</span> <span class="main">≤</span> <span class="free">Tmin</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">THEN</span> 
    <span class="main">(</span><span class="numeral">4</span> <span class="main">::=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> 
   <span class="keyword1">ELSE</span> <span class="keyword1">IF</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">4</span> <span class="main">=</span> <span class="main">1</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">3</span> <span class="main">≥</span> <span class="free">Tmax</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">THEN</span> 
    <span class="main">(</span><span class="numeral">4</span> <span class="main">::=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span><span class="main">0</span><span class="main">)</span><span class="main">)</span> 
   <span class="keyword1">ELSE</span> <span class="keyword1">skip</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">refinement</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> R_therm_assign1<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> R_therm_assign2<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> R_assign_law<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> R_therm_loop<span class="main">:</span> <span class="quoted"><span class="quoted">"rel_R <span class="main">⌈</span><span class="keyword1">I</span> <span class="free">Tmin</span> <span class="free">Tmax</span><span class="main">⌉</span> <span class="main">⌈</span><span class="keyword1">I</span> <span class="free">Tmin</span> <span class="free">Tmax</span><span class="main">⌉</span> <span class="main">≥</span> 
  <span class="main">(</span><span class="keyword1">LOOP</span> 
    rel_R <span class="main">⌈</span><span class="keyword1">I</span> <span class="free">Tmin</span> <span class="free">Tmax</span><span class="main">⌉</span> <span class="main">⌈</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="keyword1">I</span> <span class="free">Tmin</span> <span class="free">Tmax</span> <span class="bound">s</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">3</span> <span class="main">=</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span><span class="main">⌉</span><span class="main">;</span>
    rel_R <span class="main">⌈</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="keyword1">I</span> <span class="free">Tmin</span> <span class="free">Tmax</span> <span class="bound">s</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">3</span> <span class="main">=</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span><span class="main">⌉</span> <span class="main">⌈</span><span class="keyword1">I</span> <span class="free">Tmin</span> <span class="free">Tmax</span><span class="main">⌉</span>
  <span class="keyword1">INV</span> <span class="keyword1">I</span> <span class="free">Tmin</span> <span class="free">Tmax</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> R_loopI R_seq<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> R_thermostat_flow<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">τ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">Tmin</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">Tmax</span> <span class="main">&lt;</span> <span class="free">L</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"rel_R <span class="main">⌈</span><span class="keyword1">I</span> <span class="free">Tmin</span> <span class="free">Tmax</span><span class="main">⌉</span> <span class="main">⌈</span><span class="keyword1">I</span> <span class="free">Tmin</span> <span class="free">Tmax</span><span class="main">⌉</span> <span class="main">≥</span> 
  <span class="main">(</span><span class="keyword1">LOOP</span> <span class="main">(</span>
    <span class="comment1">― ‹control›</span>
    <span class="main">(</span><span class="numeral">2</span> <span class="main">::=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">;</span><span class="main">(</span><span class="numeral">3</span> <span class="main">::=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
    <span class="main">(</span><span class="keyword1">IF</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">4</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">3</span> <span class="main">≤</span> <span class="free">Tmin</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">THEN</span> 
      <span class="main">(</span><span class="numeral">4</span> <span class="main">::=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> 
     <span class="keyword1">ELSE</span> <span class="keyword1">IF</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">4</span> <span class="main">=</span> <span class="main">1</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">3</span> <span class="main">≥</span> <span class="free">Tmax</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">THEN</span> 
      <span class="main">(</span><span class="numeral">4</span> <span class="main">::=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span><span class="main">0</span><span class="main">)</span><span class="main">)</span> 
     <span class="keyword1">ELSE</span> <span class="keyword1">skip</span><span class="main">)</span><span class="main">;</span>
    <span class="comment1">― ‹dynamics›</span>
    <span class="main">(</span><span class="keyword1">IF</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">4</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="keyword1">THEN</span> 
      <span class="main">(</span><span class="keyword1">x´=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="keyword1">f</span> <span class="free">a</span> <span class="main">0</span><span class="main">)</span> <span class="main">&amp;</span> <span class="keyword1">G</span> <span class="free">Tmin</span> <span class="free">Tmax</span> <span class="free">a</span> <span class="main">0</span> <span class="keyword1">on</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">τ</span><span class="main">}</span><span class="main">)</span> UNIV <span class="main">@</span> <span class="main">0</span><span class="main">)</span> 
    <span class="keyword1">ELSE</span> 
      <span class="main">(</span><span class="keyword1">x´=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="keyword1">f</span> <span class="free">a</span> <span class="free">L</span><span class="main">)</span> <span class="main">&amp;</span> <span class="keyword1">G</span> <span class="free">Tmin</span> <span class="free">Tmax</span> <span class="free">a</span> <span class="free">L</span> <span class="keyword1">on</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">τ</span><span class="main">}</span><span class="main">)</span> UNIV <span class="main">@</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>
  <span class="main">)</span> <span class="keyword1">INV</span> <span class="keyword1">I</span> <span class="free">Tmin</span> <span class="free">Tmax</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">refinement</span><span class="main"><span class="keyword3">;</span></span> <span class="main">(</span><span class="operator">rule</span> R_therm_assign1<span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">rule</span> R_therm_assign2<span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main"><span class="keyword3">,</span></span>
      <span class="main">(</span><span class="operator">rule</span> R_therm_dyn_down<span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">rule</span> R_therm_dyn_up<span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">rule</span> R_assign_law<span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">no_notation</span></span> therm_vec_field <span class="main">(</span><span class="quoted">"<span class="keyword1">f</span>"</span><span class="main">)</span>
        <span class="keyword2"><span class="keyword">and</span></span> therm_flow <span class="main">(</span><span class="quoted">"<span class="keyword1">φ</span>"</span><span class="main">)</span>
        <span class="keyword2"><span class="keyword">and</span></span> therm_guard <span class="main">(</span><span class="quoted">"<span class="keyword1">G</span>"</span><span class="main">)</span>
        <span class="keyword2"><span class="keyword">and</span></span> therm_loop_inv <span class="main">(</span><span class="quoted">"<span class="keyword1">I</span>"</span><span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹ Water tank ›</span></span> <span class="comment1">― ‹ Variation of Hespanha and Alur's tank ›</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹ Tank ›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ A controller turns a water pump on and off to keep the level of water <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"h"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> in a tank
within an acceptable range <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"hmin ≤ h ≤ hmax"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. Just like in the previous example, after 
each intervention, the controller registers the current level of water and resets its chronometer,
then it changes the status of the water pump accordingly. The level of water grows linearly 
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"h' = k"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> at a rate of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"k = c<span class="hidden">⇩</span><sub>i</sub>-c<span class="hidden">⇩</span><sub>o</sub>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> if the pump is on, and at a rate of 
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"k = -c<span class="hidden">⇩</span><sub>o</sub>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> if the pump is off. We use <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">1</span></span><span class="main"><span class="main">::</span></span><span class="numeral"><span class="numeral">4</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> to denote the tank's level of water,
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="numeral"><span class="numeral">2</span></span><span class="main"><span class="main">::</span></span><span class="numeral"><span class="numeral">4</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is time as measured by the controller's chronometer, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="numeral"><span class="numeral">3</span></span><span class="main"><span class="main">::</span></span><span class="numeral"><span class="numeral">4</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is the
level of water measured by the chronometer, and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="numeral"><span class="numeral">4</span></span><span class="main"><span class="main">::</span></span><span class="numeral"><span class="numeral">4</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> states whether the pump is on
(<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"s$4 = 1"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>) or off (<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"s$4 = 0"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>). We prove that the controller keeps the level of
water between <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"hmin"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"hmax"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. ›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">tank_vec_field</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real <span class="main">⇒</span> real<span class="main">^</span><span class="numeral">4</span> <span class="main">⇒</span> real<span class="main">^</span><span class="numeral">4</span>"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">f</span>"</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">f</span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="keyword1">χ</span> <span class="bound">i</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">i</span> <span class="main">=</span> <span class="numeral">2</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">i</span> <span class="main">=</span> <span class="main">1</span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">tank_flow</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real <span class="main">⇒</span> real <span class="main">⇒</span> real<span class="main">^</span><span class="numeral">4</span> <span class="main">⇒</span> real<span class="main">^</span><span class="numeral">4</span>"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">φ</span>"</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">φ</span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="keyword1">χ</span> <span class="bound">i</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">i</span> <span class="main">=</span> <span class="main">1</span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">*</span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="main">1</span> <span class="keyword1">else</span> 
  <span class="main">(</span><span class="keyword1">if</span> <span class="bound">i</span> <span class="main">=</span> <span class="numeral">2</span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="numeral">2</span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">tank_guard</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real <span class="main">⇒</span> real <span class="main">⇒</span> real<span class="main">^</span><span class="numeral">4</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">G</span>"</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">G</span></span> <span class="free"><span class="bound"><span class="entity">Hm</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="numeral">2</span> <span class="main">≤</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Hm</span></span></span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="numeral">3</span><span class="main">)</span><span class="main">/</span><span class="free"><span class="bound"><span class="entity">k</span></span></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">tank_loop_inv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real <span class="main">⇒</span> real <span class="main">⇒</span> real<span class="main">^</span><span class="numeral">4</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">I</span>"</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">I</span></span> <span class="free"><span class="bound"><span class="entity">hmin</span></span></span> <span class="free"><span class="bound"><span class="entity">hmax</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">hmin</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="main">1</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="main">1</span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">hmax</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="numeral">4</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="numeral">4</span> <span class="main">=</span> <span class="main">1</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">tank_diff_inv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real <span class="main">⇒</span> real <span class="main">⇒</span> real <span class="main">⇒</span> real<span class="main">^</span><span class="numeral">4</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">dI</span>"</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">dI</span></span> <span class="free"><span class="bound"><span class="entity">hmin</span></span></span> <span class="free"><span class="bound"><span class="entity">hmax</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="main">1</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">⋅</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="numeral">2</span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="numeral">3</span> <span class="main">∧</span> <span class="main">0</span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="numeral">2</span> <span class="main">∧</span> 
    <span class="free"><span class="bound"><span class="entity">hmin</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="numeral">3</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="numeral">3</span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">hmax</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="numeral">4</span> <span class="main">=</span><span class="main">0</span> <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="numeral">4</span> <span class="main">=</span> <span class="main">1</span><span class="main">)</span>"</span></span>

<span class="comment1">― ‹Verified with the flow ›</span>

<span class="keyword1"><span class="command">lemma</span></span> local_flow_tank<span class="main">:</span> <span class="quoted"><span class="quoted">"local_flow <span class="main">(</span><span class="keyword1">f</span> <span class="free">k</span><span class="main">)</span> UNIV UNIV <span class="main">(</span><span class="keyword1">φ</span> <span class="free">k</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> local_lipschitz_def lipschitz_on_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">1</span><span class="main">/</span><span class="numeral">2</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="main">1</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dist_norm norm_vec_def L2_set_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> UNIV_4<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">poly_derivatives</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> vec_eq_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> tank_arith<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="main">(</span><span class="free">τ</span><span class="main">::</span>real<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">c<span class="hidden">⇩</span><sub>o</sub></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">c<span class="hidden">⇩</span><sub>o</sub></span> <span class="main">&lt;</span> <span class="free">c<span class="hidden">⇩</span><sub>i</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">τ</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">τ</span><span class="main">}</span><span class="main">.</span> <span class="bound">τ</span> <span class="main">≤</span> <span class="main">-</span> <span class="main">(</span><span class="main">(</span><span class="free">hmin</span> <span class="main">-</span> <span class="free">y</span><span class="main">)</span> <span class="main">/</span> <span class="free">c<span class="hidden">⇩</span><sub>o</sub></span><span class="main">)</span> <span class="main">⟹</span>  <span class="free">hmin</span> <span class="main">≤</span> <span class="free">y</span> <span class="main">-</span> <span class="free">c<span class="hidden">⇩</span><sub>o</sub></span> <span class="main">*</span> <span class="free">τ</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">τ</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">τ</span><span class="main">}</span><span class="main">.</span> <span class="bound">τ</span> <span class="main">≤</span> <span class="main">(</span><span class="free">hmax</span> <span class="main">-</span> <span class="free">y</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="free">c<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">-</span> <span class="free">c<span class="hidden">⇩</span><sub>o</sub></span><span class="main">)</span> <span class="main">⟹</span>  <span class="main">(</span><span class="free">c<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">-</span> <span class="free">c<span class="hidden">⇩</span><sub>o</sub></span><span class="main">)</span> <span class="main">*</span> <span class="free">τ</span> <span class="main">+</span> <span class="free">y</span> <span class="main">≤</span> <span class="free">hmax</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">hmin</span> <span class="main">≤</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">hmin</span> <span class="main">≤</span> <span class="main">(</span><span class="free">c<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">-</span> <span class="free">c<span class="hidden">⇩</span><sub>o</sub></span><span class="main">)</span> <span class="main">⋅</span> <span class="free">τ</span> <span class="main">+</span> <span class="free">y</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">≤</span> <span class="free">hmax</span> <span class="main">⟹</span> <span class="free">y</span> <span class="main">-</span> <span class="free">c<span class="hidden">⇩</span><sub>o</sub></span> <span class="main">⋅</span> <span class="free">τ</span> <span class="main">≤</span> <span class="free">hmax</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span> le_divide_eq assms<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">meson</span> add_mono less_eq_real_def mult_left_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> add_increasing2 less_eq_real_def mult_nonneg_nonneg<span class="main">)</span> 

<span class="keyword1"><span class="command">lemmas</span></span> H_g_ode_tank <span class="main">=</span> local_flow.sH_g_ode_ivl<span class="main">[</span><span class="operator">OF</span> local_flow_tank _ UNIV_I<span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> tank_flow<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">τ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">c<span class="hidden">⇩</span><sub>o</sub></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">c<span class="hidden">⇩</span><sub>o</sub></span> <span class="main">&lt;</span> <span class="free">c<span class="hidden">⇩</span><sub>i</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>{</b></span><span class="keyword1">I</span> <span class="free">hmin</span> <span class="free">hmax</span><span class="main"><span class="hidden">❙</span><b>}</b></span>
  <span class="main">(</span><span class="keyword1">LOOP</span> 
    <span class="comment1">― ‹control›</span>
    <span class="main">(</span><span class="main">(</span><span class="numeral">2</span> <span class="main">::=</span><span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span><span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">;</span><span class="main">(</span><span class="numeral">3</span> <span class="main">::=</span><span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
    <span class="main">(</span><span class="keyword1">IF</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">4</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">3</span> <span class="main">≤</span> <span class="free">hmin</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">THEN</span> <span class="main">(</span><span class="numeral">4</span> <span class="main">::=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">ELSE</span> 
    <span class="main">(</span><span class="keyword1">IF</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">4</span> <span class="main">=</span> <span class="main">1</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">3</span> <span class="main">≥</span> <span class="free">hmax</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">THEN</span> <span class="main">(</span><span class="numeral">4</span> <span class="main">::=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span><span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">ELSE</span> <span class="keyword1">skip</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
    <span class="comment1">― ‹dynamics›</span>
    <span class="main">(</span><span class="keyword1">IF</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">4</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="keyword1">THEN</span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="keyword1">f</span> <span class="main">(</span><span class="free">c<span class="hidden">⇩</span><sub>i</sub></span><span class="main">-</span><span class="free">c<span class="hidden">⇩</span><sub>o</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">&amp;</span> <span class="keyword1">G</span> <span class="free">hmax</span> <span class="main">(</span><span class="free">c<span class="hidden">⇩</span><sub>i</sub></span><span class="main">-</span><span class="free">c<span class="hidden">⇩</span><sub>o</sub></span><span class="main">)</span> <span class="keyword1">on</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">τ</span><span class="main">}</span><span class="main">)</span> UNIV <span class="main">@</span> <span class="main">0</span><span class="main">)</span> 
     <span class="keyword1">ELSE</span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="keyword1">f</span> <span class="main">(</span><span class="main">-</span><span class="free">c<span class="hidden">⇩</span><sub>o</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">&amp;</span> <span class="keyword1">G</span> <span class="free">hmin</span> <span class="main">(</span><span class="main">-</span><span class="free">c<span class="hidden">⇩</span><sub>o</sub></span><span class="main">)</span> <span class="keyword1">on</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">τ</span><span class="main">}</span><span class="main">)</span> UNIV <span class="main">@</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">)</span>
  <span class="keyword1">INV</span> <span class="keyword1">I</span> <span class="free">hmin</span> <span class="free">hmax</span><span class="main">)</span> 
  <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="keyword1">I</span> <span class="free">hmin</span> <span class="free">hmax</span><span class="main"><span class="hidden">❙</span><b>}</b></span>"</span></span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> H_loopI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="keyword1">I</span> <span class="free">hmin</span> <span class="free">hmax</span> <span class="bound">s</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span><span class="main">=</span><span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> H_seq<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="keyword1">I</span> <span class="free">hmin</span> <span class="free">hmax</span> <span class="bound">s</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span><span class="main">=</span><span class="main">0</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">3</span> <span class="main">=</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> H_seq<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="keyword1">I</span> <span class="free">hmin</span> <span class="free">hmax</span> <span class="bound">s</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span><span class="main">=</span><span class="main">0</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">3</span> <span class="main">=</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> H_seq<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> H_cond<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> H_g_ode_tank<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> assms tank_arith<span class="main">[</span><span class="operator">OF</span> _ assms<span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span>2<span class="main"><span class="main"><span class="main"><span class="main"><span class="main">,</span></span></span></span></span>3<span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="comment1">― ‹Verified with differential invariants ›</span>

<span class="keyword1"><span class="command">lemma</span></span> tank_diff_inv<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">τ</span> <span class="main">⟹</span> diff_invariant <span class="main">(</span><span class="keyword1">dI</span> <span class="free">hmin</span> <span class="free">hmax</span> <span class="free">k</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="keyword1">f</span> <span class="free">k</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">τ</span><span class="main">}</span><span class="main">)</span> UNIV <span class="main">0</span> <span class="free">Guard</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">intro</span> diff_invariant_conj_rule<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">poly_derivatives</span></span> <span class="dynamic"><span class="dynamic">diff_invariant_rules</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> ν'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> μ'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> diff_invariant_leq_rule<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">presburger</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> ν'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> μ'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> diff_invariant_leq_rule<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">poly_derivatives</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">poly_derivatives</span></span> <span class="dynamic"><span class="dynamic">diff_invariant_rules</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> tank_inv_arith1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="main">(</span><span class="free">τ</span><span class="main">::</span>real<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">c<span class="hidden">⇩</span><sub>o</sub></span> <span class="main">&lt;</span> <span class="free">c<span class="hidden">⇩</span><sub>i</sub></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">hmin</span> <span class="main">≤</span> <span class="free">y<span class="hidden">⇩</span><sub>0</sub></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> g<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">τ</span> <span class="main">≤</span> <span class="main">(</span><span class="free">hmax</span> <span class="main">-</span> <span class="free">y<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="free">c<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">-</span> <span class="free">c<span class="hidden">⇩</span><sub>o</sub></span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">hmin</span> <span class="main">≤</span> <span class="main">(</span><span class="free">c<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">-</span> <span class="free">c<span class="hidden">⇩</span><sub>o</sub></span><span class="main">)</span> <span class="main">⋅</span> <span class="free">τ</span> <span class="main">+</span> <span class="free">y<span class="hidden">⇩</span><sub>0</sub></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">c<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">-</span> <span class="free">c<span class="hidden">⇩</span><sub>o</sub></span><span class="main">)</span> <span class="main">⋅</span> <span class="free">τ</span> <span class="main">+</span> <span class="free">y<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">≤</span> <span class="free">hmax</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">c<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">-</span> <span class="free">c<span class="hidden">⇩</span><sub>o</sub></span><span class="main">)</span> <span class="main">⋅</span> <span class="free">τ</span> <span class="main">≤</span> <span class="main">(</span><span class="free">hmax</span> <span class="main">-</span> <span class="free">y<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> g assms<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> diff_gt_0_iff_gt mult.commute pos_le_divide_eq<span class="main">)</span> 
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">c<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">-</span> <span class="free">c<span class="hidden">⇩</span><sub>o</sub></span><span class="main">)</span> <span class="main">⋅</span> <span class="free">τ</span> <span class="main">+</span> <span class="free">y<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">≤</span> <span class="free">hmax</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">hmin</span> <span class="main">≤</span> <span class="main">(</span><span class="free">c<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">-</span> <span class="free">c<span class="hidden">⇩</span><sub>o</sub></span><span class="main">)</span> <span class="main">⋅</span> <span class="free">τ</span> <span class="main">+</span> <span class="free">y<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> b assms<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add.commute add_increasing2 diff_ge_0_iff_ge 
        less_eq_real_def mult_nonneg_nonneg<span class="main">)</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> tank_inv_arith2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="main">(</span><span class="free">τ</span><span class="main">::</span>real<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">c<span class="hidden">⇩</span><sub>o</sub></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">≤</span> <span class="free">hmax</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> g<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">τ</span> <span class="main">≤</span> <span class="main">-</span> <span class="main">(</span><span class="main">(</span><span class="free">hmin</span> <span class="main">-</span> <span class="free">y<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">/</span> <span class="free">c<span class="hidden">⇩</span><sub>o</sub></span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">hmin</span> <span class="main">≤</span> <span class="free">y<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">-</span> <span class="free">c<span class="hidden">⇩</span><sub>o</sub></span> <span class="main">⋅</span> <span class="free">τ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">y<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">-</span> <span class="free">c<span class="hidden">⇩</span><sub>o</sub></span> <span class="main">⋅</span> <span class="free">τ</span> <span class="main">≤</span> <span class="free">hmax</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">τ</span> <span class="main">⋅</span> <span class="free">c<span class="hidden">⇩</span><sub>o</sub></span> <span class="main">≤</span> <span class="free">y<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">-</span> <span class="free">hmin</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> g <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> <span class="free">c<span class="hidden">⇩</span><sub>o</sub></span>›</span></span> pos_le_minus_divide_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> 
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">hmin</span> <span class="main">≤</span> <span class="free">y<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">-</span> <span class="free">c<span class="hidden">⇩</span><sub>o</sub></span> <span class="main">⋅</span> <span class="free">τ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mult.commute<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">y<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">-</span> <span class="free">c<span class="hidden">⇩</span><sub>o</sub></span> <span class="main">⋅</span> <span class="free">τ</span> <span class="main">≤</span> <span class="free">hmax</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> b assms<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> mult_nonneg_nonneg<span class="main">)</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> tank_inv<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">τ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">c<span class="hidden">⇩</span><sub>o</sub></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">c<span class="hidden">⇩</span><sub>o</sub></span> <span class="main">&lt;</span> <span class="free">c<span class="hidden">⇩</span><sub>i</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>{</b></span><span class="keyword1">I</span> <span class="free">hmin</span> <span class="free">hmax</span><span class="main"><span class="hidden">❙</span><b>}</b></span>
  <span class="main">(</span><span class="keyword1">LOOP</span> 
    <span class="comment1">― ‹control›</span>
    <span class="main">(</span><span class="main">(</span><span class="numeral">2</span> <span class="main">::=</span><span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span><span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">;</span><span class="main">(</span><span class="numeral">3</span> <span class="main">::=</span><span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
    <span class="main">(</span><span class="keyword1">IF</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">4</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">3</span> <span class="main">≤</span> <span class="free">hmin</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">THEN</span> <span class="main">(</span><span class="numeral">4</span> <span class="main">::=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">ELSE</span> 
    <span class="main">(</span><span class="keyword1">IF</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">4</span> <span class="main">=</span> <span class="main">1</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">3</span> <span class="main">≥</span> <span class="free">hmax</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">THEN</span> <span class="main">(</span><span class="numeral">4</span> <span class="main">::=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span><span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">ELSE</span> <span class="keyword1">skip</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
    <span class="comment1">― ‹dynamics›</span>
    <span class="main">(</span><span class="keyword1">IF</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">4</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="keyword1">THEN</span> 
      <span class="main">(</span><span class="keyword1">x´=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="keyword1">f</span> <span class="main">(</span><span class="free">c<span class="hidden">⇩</span><sub>i</sub></span><span class="main">-</span><span class="free">c<span class="hidden">⇩</span><sub>o</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">&amp;</span> <span class="keyword1">G</span> <span class="free">hmax</span> <span class="main">(</span><span class="free">c<span class="hidden">⇩</span><sub>i</sub></span><span class="main">-</span><span class="free">c<span class="hidden">⇩</span><sub>o</sub></span><span class="main">)</span> <span class="keyword1">on</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">τ</span><span class="main">}</span><span class="main">)</span> UNIV <span class="main">@</span> <span class="main">0</span> <span class="keyword1">DINV</span> <span class="main">(</span><span class="keyword1">dI</span> <span class="free">hmin</span> <span class="free">hmax</span> <span class="main">(</span><span class="free">c<span class="hidden">⇩</span><sub>i</sub></span><span class="main">-</span><span class="free">c<span class="hidden">⇩</span><sub>o</sub></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> 
     <span class="keyword1">ELSE</span> 
      <span class="main">(</span><span class="keyword1">x´=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="keyword1">f</span> <span class="main">(</span><span class="main">-</span><span class="free">c<span class="hidden">⇩</span><sub>o</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">&amp;</span> <span class="keyword1">G</span> <span class="free">hmin</span> <span class="main">(</span><span class="main">-</span><span class="free">c<span class="hidden">⇩</span><sub>o</sub></span><span class="main">)</span> <span class="keyword1">on</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">τ</span><span class="main">}</span><span class="main">)</span> UNIV <span class="main">@</span> <span class="main">0</span> <span class="keyword1">DINV</span> <span class="main">(</span><span class="keyword1">dI</span> <span class="free">hmin</span> <span class="free">hmax</span> <span class="main">(</span><span class="main">-</span><span class="free">c<span class="hidden">⇩</span><sub>o</sub></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">)</span>
  <span class="keyword1">INV</span> <span class="keyword1">I</span> <span class="free">hmin</span> <span class="free">hmax</span><span class="main">)</span>
  <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="keyword1">I</span> <span class="free">hmin</span> <span class="free">hmax</span><span class="main"><span class="hidden">❙</span><b>}</b></span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> H_loopI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="keyword1">I</span> <span class="free">hmin</span> <span class="free">hmax</span> <span class="bound">s</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span><span class="main">=</span><span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> H_seq<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="keyword1">I</span> <span class="free">hmin</span> <span class="free">hmax</span> <span class="bound">s</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span><span class="main">=</span><span class="main">0</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">3</span> <span class="main">=</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> H_seq<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="keyword1">I</span> <span class="free">hmin</span> <span class="free">hmax</span> <span class="bound">s</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span><span class="main">=</span><span class="main">0</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">3</span> <span class="main">=</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> H_seq<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> H_cond<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> H_g_ode_inv<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tank_diff_inv<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> assms tank_inv_arith1 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> H_g_ode_inv<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> sH_diff_inv<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> tank_diff_inv<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> assms tank_inv_arith2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="comment1">― ‹Refined with differential invariants ›</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">tank_ctrl</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real <span class="main">⇒</span> real <span class="main">⇒</span> <span class="main">(</span>real<span class="main">^</span><span class="numeral">4</span><span class="main">)</span> rel"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">ctrl</span>"</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">ctrl</span></span> <span class="free"><span class="bound"><span class="entity">hmin</span></span></span> <span class="free"><span class="bound"><span class="entity">hmax</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">(</span><span class="numeral">2</span> <span class="main">::=</span><span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span><span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">;</span><span class="main">(</span><span class="numeral">3</span> <span class="main">::=</span><span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
    <span class="main">(</span><span class="keyword1">IF</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">4</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">3</span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">hmin</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">THEN</span> <span class="main">(</span><span class="numeral">4</span> <span class="main">::=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">ELSE</span> 
    <span class="main">(</span><span class="keyword1">IF</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">4</span> <span class="main">=</span> <span class="main">1</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">3</span> <span class="main">≥</span> <span class="free"><span class="bound"><span class="entity">hmax</span></span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">THEN</span> <span class="main">(</span><span class="numeral">4</span> <span class="main">::=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span><span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">ELSE</span> <span class="keyword1">skip</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">tank_dyn_dinv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real <span class="main">⇒</span> real <span class="main">⇒</span> real <span class="main">⇒</span> real <span class="main">⇒</span> real <span class="main">⇒</span> <span class="main">(</span>real<span class="main">^</span><span class="numeral">4</span><span class="main">)</span> rel"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">dyn</span>"</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">dyn</span></span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>i</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>o</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">hmin</span></span></span> <span class="free"><span class="bound"><span class="entity">hmax</span></span></span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="keyword1">IF</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">4</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="keyword1">THEN</span> 
      <span class="main">(</span><span class="keyword1">x´=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="keyword1">f</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>i</sub></span></span></span><span class="main">-</span><span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>o</sub></span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">&amp;</span> <span class="keyword1">G</span> <span class="free"><span class="bound"><span class="entity">hmax</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>i</sub></span></span></span><span class="main">-</span><span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>o</sub></span></span></span><span class="main">)</span> <span class="keyword1">on</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free"><span class="bound"><span class="entity">τ</span></span></span><span class="main">}</span><span class="main">)</span> UNIV <span class="main">@</span> <span class="main">0</span> <span class="keyword1">DINV</span> <span class="main">(</span><span class="keyword1">dI</span> <span class="free"><span class="bound"><span class="entity">hmin</span></span></span> <span class="free"><span class="bound"><span class="entity">hmax</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>i</sub></span></span></span><span class="main">-</span><span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>o</sub></span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> 
     <span class="keyword1">ELSE</span> 
      <span class="main">(</span><span class="keyword1">x´=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="keyword1">f</span> <span class="main">(</span><span class="main">-</span><span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>o</sub></span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">&amp;</span> <span class="keyword1">G</span> <span class="free"><span class="bound"><span class="entity">hmin</span></span></span> <span class="main">(</span><span class="main">-</span><span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>o</sub></span></span></span><span class="main">)</span> <span class="keyword1">on</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free"><span class="bound"><span class="entity">τ</span></span></span><span class="main">}</span><span class="main">)</span> UNIV <span class="main">@</span> <span class="main">0</span> <span class="keyword1">DINV</span> <span class="main">(</span><span class="keyword1">dI</span> <span class="free"><span class="bound"><span class="entity">hmin</span></span></span> <span class="free"><span class="bound"><span class="entity">hmax</span></span></span> <span class="main">(</span><span class="main">-</span><span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>o</sub></span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">tank_dinv</span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>i</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>o</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">hmin</span></span></span> <span class="free"><span class="bound"><span class="entity">hmax</span></span></span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span> <span class="main">≡</span> 
  <span class="keyword1">LOOP</span> <span class="main">(</span><span class="keyword1">ctrl</span> <span class="free"><span class="bound"><span class="entity">hmin</span></span></span> <span class="free"><span class="bound"><span class="entity">hmax</span></span></span> <span class="main">;</span> <span class="keyword1">dyn</span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>i</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>o</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">hmin</span></span></span> <span class="free"><span class="bound"><span class="entity">hmax</span></span></span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span><span class="main">)</span> <span class="keyword1">INV</span> <span class="main">(</span><span class="keyword1">I</span> <span class="free"><span class="bound"><span class="entity">hmin</span></span></span> <span class="free"><span class="bound"><span class="entity">hmax</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> R_tank_inv<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">τ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">c<span class="hidden">⇩</span><sub>o</sub></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">c<span class="hidden">⇩</span><sub>o</sub></span> <span class="main">&lt;</span> <span class="free">c<span class="hidden">⇩</span><sub>i</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"rel_R <span class="main">⌈</span><span class="keyword1">I</span> <span class="free">hmin</span> <span class="free">hmax</span><span class="main">⌉</span> <span class="main">⌈</span><span class="keyword1">I</span> <span class="free">hmin</span> <span class="free">hmax</span><span class="main">⌉</span> <span class="main">≥</span> 
  <span class="main">(</span><span class="keyword1">LOOP</span> 
    <span class="comment1">― ‹control›</span>
    <span class="main">(</span><span class="main">(</span><span class="numeral">2</span> <span class="main">::=</span><span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span><span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">;</span><span class="main">(</span><span class="numeral">3</span> <span class="main">::=</span><span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
    <span class="main">(</span><span class="keyword1">IF</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">4</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">3</span> <span class="main">≤</span> <span class="free">hmin</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">THEN</span> <span class="main">(</span><span class="numeral">4</span> <span class="main">::=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">ELSE</span> 
    <span class="main">(</span><span class="keyword1">IF</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">4</span> <span class="main">=</span> <span class="main">1</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">3</span> <span class="main">≥</span> <span class="free">hmax</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">THEN</span> <span class="main">(</span><span class="numeral">4</span> <span class="main">::=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span><span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">ELSE</span> <span class="keyword1">skip</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
    <span class="comment1">― ‹dynamics›</span>
    <span class="main">(</span><span class="keyword1">IF</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">4</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="keyword1">THEN</span> 
      <span class="main">(</span><span class="keyword1">x´=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="keyword1">f</span> <span class="main">(</span><span class="free">c<span class="hidden">⇩</span><sub>i</sub></span><span class="main">-</span><span class="free">c<span class="hidden">⇩</span><sub>o</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">&amp;</span> <span class="keyword1">G</span> <span class="free">hmax</span> <span class="main">(</span><span class="free">c<span class="hidden">⇩</span><sub>i</sub></span><span class="main">-</span><span class="free">c<span class="hidden">⇩</span><sub>o</sub></span><span class="main">)</span> <span class="keyword1">on</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">τ</span><span class="main">}</span><span class="main">)</span> UNIV <span class="main">@</span> <span class="main">0</span> <span class="keyword1">DINV</span> <span class="main">(</span><span class="keyword1">dI</span> <span class="free">hmin</span> <span class="free">hmax</span> <span class="main">(</span><span class="free">c<span class="hidden">⇩</span><sub>i</sub></span><span class="main">-</span><span class="free">c<span class="hidden">⇩</span><sub>o</sub></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> 
     <span class="keyword1">ELSE</span> 
      <span class="main">(</span><span class="keyword1">x´=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="keyword1">f</span> <span class="main">(</span><span class="main">-</span><span class="free">c<span class="hidden">⇩</span><sub>o</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">&amp;</span> <span class="keyword1">G</span> <span class="free">hmin</span> <span class="main">(</span><span class="main">-</span><span class="free">c<span class="hidden">⇩</span><sub>o</sub></span><span class="main">)</span> <span class="keyword1">on</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">τ</span><span class="main">}</span><span class="main">)</span> UNIV <span class="main">@</span> <span class="main">0</span> <span class="keyword1">DINV</span> <span class="main">(</span><span class="keyword1">dI</span> <span class="free">hmin</span> <span class="free">hmax</span> <span class="main">(</span><span class="main">-</span><span class="free">c<span class="hidden">⇩</span><sub>o</sub></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">)</span>
  <span class="keyword1">INV</span> <span class="keyword1">I</span> <span class="free">hmin</span> <span class="free">hmax</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rel_R <span class="main">⌈</span><span class="keyword1">I</span> <span class="free">hmin</span> <span class="free">hmax</span><span class="main">⌉</span> <span class="main">⌈</span><span class="keyword1">I</span> <span class="free">hmin</span> <span class="free">hmax</span><span class="main">⌉</span> <span class="main">≥</span> 
    <span class="keyword1">LOOP</span> <span class="main">(</span>
      <span class="main">(</span><span class="numeral">2</span> <span class="main">::=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">;</span> <span class="main">(</span>rel_R <span class="main">⌈</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="keyword1">I</span> <span class="free">hmin</span> <span class="free">hmax</span> <span class="bound">s</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span> <span class="main">=</span> <span class="main">0</span><span class="main">⌉</span> <span class="main">⌈</span><span class="keyword1">I</span> <span class="free">hmin</span> <span class="free">hmax</span><span class="main">⌉</span><span class="main">)</span>
    <span class="main">)</span> <span class="keyword1">INV</span> <span class="keyword1">I</span> <span class="free">hmin</span> <span class="free">hmax</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">≥</span> <span class="var">?R</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">refinement</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> 
    <span class="quoted"><span class="quoted">"<span class="var">?R</span> <span class="main">≥</span> <span class="keyword1">LOOP</span> <span class="main">(</span>
      <span class="main">(</span><span class="numeral">2</span> <span class="main">::=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">;</span><span class="main">(</span><span class="numeral">3</span> <span class="main">::=</span><span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
      <span class="main">(</span>rel_R <span class="main">⌈</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="keyword1">I</span> <span class="free">hmin</span> <span class="free">hmax</span> <span class="bound">s</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">3</span><span class="main">=</span><span class="bound">s</span><span class="main">$</span><span class="main">1</span><span class="main">⌉</span> <span class="main">⌈</span><span class="keyword1">I</span> <span class="free">hmin</span> <span class="free">hmax</span><span class="main">⌉</span><span class="main">)</span>
    <span class="main">)</span> <span class="keyword1">INV</span> <span class="keyword1">I</span> <span class="free">hmin</span> <span class="free">hmax</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">≥</span> <span class="var">?R</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">refinement</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> 
    <span class="quoted"><span class="quoted">"<span class="var">?R</span> <span class="main">≥</span> <span class="keyword1">LOOP</span> <span class="main">(</span>
      <span class="keyword1">ctrl</span> <span class="free">hmin</span> <span class="free">hmax</span><span class="main">;</span>
      <span class="main">(</span>rel_R <span class="main">⌈</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="keyword1">I</span> <span class="free">hmin</span> <span class="free">hmax</span> <span class="bound">s</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">3</span><span class="main">=</span><span class="bound">s</span><span class="main">$</span><span class="main">1</span><span class="main">⌉</span> <span class="main">⌈</span><span class="keyword1">I</span> <span class="free">hmin</span> <span class="free">hmax</span><span class="main">⌉</span><span class="main">)</span>
    <span class="main">)</span> <span class="keyword1">INV</span> <span class="keyword1">I</span> <span class="free">hmin</span> <span class="free">hmax</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">≥</span> <span class="var">?R</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> O_assoc<span class="main"><span class="keyword3">,</span></span> <span class="operator">refinement</span><span class="main"><span class="keyword3">;</span></span> <span class="main">(</span><span class="operator">force</span><span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">rule</span> R_assign_law<span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> 
    <span class="quoted"><span class="quoted">"<span class="var">?R</span> <span class="main">≥</span> <span class="keyword1">LOOP</span> <span class="main">(</span><span class="keyword1">ctrl</span> <span class="free">hmin</span> <span class="free">hmax</span><span class="main">;</span> <span class="keyword1">dyn</span> <span class="free">c<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">c<span class="hidden">⇩</span><sub>o</sub></span> <span class="free">hmin</span> <span class="free">hmax</span> <span class="free">τ</span><span class="main">)</span> <span class="keyword1">INV</span> <span class="keyword1">I</span> <span class="free">hmin</span> <span class="free">hmax</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> O_assoc<span class="main"><span class="keyword3">,</span></span> <span class="operator">refinement</span><span class="main"><span class="keyword3">;</span></span> <span class="main">(</span><span class="main">(</span><span class="operator">rule</span> tank_diff_inv<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">?</span></span> <span class="main"><span class="keyword3">|</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main">)</span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> tank_inv_arith1 tank_inv_arith2 assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> O_assoc<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">no_notation</span></span> tank_vec_field <span class="main">(</span><span class="quoted">"<span class="keyword1">f</span>"</span><span class="main">)</span>
        <span class="keyword2"><span class="keyword">and</span></span> tank_flow <span class="main">(</span><span class="quoted">"<span class="keyword1">φ</span>"</span><span class="main">)</span>
        <span class="keyword2"><span class="keyword">and</span></span> tank_guard <span class="main">(</span><span class="quoted">"<span class="keyword1">G</span>"</span><span class="main">)</span>
        <span class="keyword2"><span class="keyword">and</span></span> tank_loop_inv <span class="main">(</span><span class="quoted">"<span class="keyword1">I</span>"</span><span class="main">)</span>
        <span class="keyword2"><span class="keyword">and</span></span> tank_diff_inv <span class="main">(</span><span class="quoted">"<span class="keyword1">dI</span>"</span><span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="HS_VC_KAT_ndfun">
<div class="head">
<h1>Theory HS_VC_KAT_ndfun</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:       Verification and refinement of hybrid systems in the relational KAT
    Author:      Jonathan Julián Huerta y Munive, 2020
    Maintainer:  Jonathan Julián Huerta y Munive &lt;jonjulian23@gmail.com&gt;
*)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Verification of hybrid programs›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ We use our state transformers model to obtain verification and refinement components for 
hybrid programs. We retake the three methods for reasoning with evolution commands and their 
continuous dynamics: providing flows, solutions or invariants. ›</span></span>

<span class="keyword1"><span class="command">theory</span></span> HS_VC_KAT_ndfun
  <span class="keyword2"><span class="keyword">imports</span></span> 
    <span class="quoted">"<a href="HS_ODEs.html">../HS_ODEs</a>"</span>
    <span class="quoted">"<a href="HS_VC_KAT.html">HS_VC_KAT</a>"</span>
    <span class="quoted">"<a href="HS_VC_KA_ndfun.html">../HS_VC_KA_ndfun</a>"</span>

<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> nd_fun <span class="main">::</span> <span class="main">(</span><span class="quoted">type</span><span class="main">)</span> <span class="quoted">kat</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">n</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main"><span class="hidden">⇩</span><sub>∙</sub></span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">{}</span><span class="main">)</span> <span class="keyword1">then</span> <span class="main">{</span><span class="bound">x</span><span class="main">}</span> <span class="keyword1">else</span> <span class="main">{}</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>∙</sup></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> nd_fun_n_op_one<span class="main">[</span><span class="operator">nd_fun_ka</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">n</span> <span class="main">(</span><span class="keyword1">n</span> <span class="main">(</span><span class="main">1</span><span class="main">::</span><span class="tfree">'a</span> nd_fun<span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> nd_fun_n_op_mult<span class="main">[</span><span class="operator">nd_fun_ka</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">n</span> <span class="main">(</span><span class="keyword1">n</span> <span class="main">(</span><span class="keyword1">n</span> <span class="free">x</span> <span class="main">⋅</span> <span class="keyword1">n</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">n</span> <span class="free">x</span> <span class="main">⋅</span> <span class="keyword1">n</span> <span class="free">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> nd_fun_n_op_mult_comp<span class="main">[</span><span class="operator">nd_fun_ka</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">n</span> <span class="free">x</span> <span class="main">⋅</span> <span class="keyword1">n</span> <span class="main">(</span><span class="keyword1">n</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> nd_fun_n_op_de_morgan<span class="main">[</span><span class="operator">nd_fun_ka</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">n</span> <span class="main">(</span><span class="keyword1">n</span> <span class="main">(</span><span class="keyword1">n</span> <span class="free">x</span><span class="main">)</span> <span class="main">⋅</span> <span class="keyword1">n</span> <span class="main">(</span><span class="keyword1">n</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">n</span> <span class="free">x</span> <span class="main">+</span> <span class="keyword1">n</span> <span class="free">y</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">x</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> nd_fun"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> n_op_nd_fun_def one_nd_fun_def times_nd_fun_def plus_nd_fun_def zero_nd_fun_def 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nd_fun_eq_iff kcomp_def<span class="main">)</span>

<span class="keyword1"><span class="command">instance</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro_classes</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">nd_fun_ka</span></span><span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> nd_fun <span class="main">::</span> <span class="main">(</span><span class="quoted">type</span><span class="main">)</span> <span class="quoted">rkat</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="class_parameter">Ref_nd_fun</span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">⋃</span><span class="main">{</span><span class="main">(</span><span class="bound">f</span><span class="main"><span class="hidden">⇩</span><sub>∙</sub></span><span class="main">)</span> <span class="bound">s</span><span class="main">|</span><span class="bound">f</span><span class="main">.</span> Hoare <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">f</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main">}</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>∙</sup></span>"</span></span>

<span class="keyword1"><span class="command">instance</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">intro_classes</span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> Hoare_def n_op_nd_fun_def Ref_nd_fun_def times_nd_fun_def<span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> kcomp_def le_fun_def less_eq_nd_fun_def<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹ Regular programs›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ Lemmas for manipulation of predicates in the relational model ›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'a</span> pred <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span>

<span class="keyword1"><span class="command">no_notation</span></span> Archimedean_Field.ceiling <span class="main">(</span><span class="quoted">"<span class="keyword1">⌈</span>_<span class="keyword1">⌉</span>"</span><span class="main">)</span>
        <span class="keyword2"><span class="keyword">and</span></span> Archimedean_Field.floor_ceiling_class.floor <span class="main">(</span><span class="quoted">"<span class="keyword1">⌊</span>_<span class="keyword1">⌋</span>"</span><span class="main">)</span>
        <span class="keyword2"><span class="keyword">and</span></span> tau <span class="main">(</span><span class="quoted">"<span class="keyword1">τ</span>"</span><span class="main">)</span>
        <span class="keyword2"><span class="keyword">and</span></span> Relation.relcomp <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">;</span>"</span> 75<span class="main">)</span>
        <span class="keyword2"><span class="keyword">and</span></span> proto_near_quantale_class.bres <span class="main">(</span><span class="keyword2"><span class="keyword">infixr</span></span> <span class="quoted">"<span class="keyword1">→</span>"</span> 60<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">p2ndf</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> pred <span class="main">⇒</span> <span class="tfree">'a</span> nd_fun"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword3">(1</span><span class="keyword1">⌈</span>_<span class="keyword1">⌉</span><span class="keyword3">)</span>"</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="free">⌈</span></span><span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main"><span class="free">⌉</span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">::</span><span class="tfree">'a</span><span class="main">.</span> <span class="main">{</span><span class="bound">s</span><span class="main">::</span><span class="tfree">'a</span><span class="main">.</span> <span class="bound">s</span> <span class="main">=</span> <span class="bound">x</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="bound">s</span><span class="main">}</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>∙</sup></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> p2ndf_simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">≤</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">⟶</span> <span class="free">Q</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">=</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">=</span> <span class="free">Q</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">⋅</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span><span class="main">)</span> <span class="main">=</span> <span class="main">⌈</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">∧</span> <span class="free">Q</span> <span class="bound">s</span><span class="main">⌉</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">+</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span><span class="main">)</span> <span class="main">=</span> <span class="main">⌈</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">∨</span> <span class="free">Q</span> <span class="bound">s</span><span class="main">⌉</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1">𝔱𝔱</span> <span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">=</span> <span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1">n</span> <span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">=</span> <span class="main">⌈</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">¬</span> <span class="free">P</span> <span class="bound">s</span><span class="main">⌉</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> p2ndf_def one_nd_fun_def less_eq_nd_fun_def times_nd_fun_def plus_nd_fun_def 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nd_fun_eq_iff kcomp_def le_fun_def n_op_nd_fun_def<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ Lemmas for verification condition generation ›</span></span>

<span class="comment1">― ‹ Hoare Triples ›</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">ndfunHoare</span> <span class="main">(</span><span class="quoted">"<span class="keyword1"><span class="hidden">❙</span><b>{</b></span>_<span class="keyword1"><span class="hidden">❙</span><b>}</b></span>_<span class="keyword1"><span class="hidden">❙</span><b>{</b></span>_<span class="keyword1"><span class="hidden">❙</span><b>}</b></span>"</span><span class="main">)</span> 
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="free"><span class="hidden">❙</span><b>{</b></span></span><span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main"><span class="free"><span class="hidden">❙</span><b>}</b></span></span><span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main"><span class="free"><span class="hidden">❙</span><b>{</b></span></span><span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main"><span class="free"><span class="hidden">❙</span><b>}</b></span></span> <span class="main">≡</span> Hoare <span class="main">⌈</span><span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">⌉</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">⌈</span><span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main">⌉</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ndfun_kat_H<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">P</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="free">X</span> <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">Q</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">s</span> <span class="bound">s'</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">⟶</span> <span class="bound">s'</span> <span class="main">∈</span> <span class="main">(</span><span class="free">X</span><span class="main"><span class="hidden">⇩</span><sub>∙</sub></span><span class="main">)</span> <span class="bound">s</span> <span class="main">⟶</span> <span class="free">Q</span> <span class="bound">s'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Hoare_def p2ndf_def less_eq_nd_fun_def times_nd_fun_def kcomp_def 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> le_fun_def n_op_nd_fun_def<span class="main">)</span>

<span class="comment1">― ‹ Skip ›</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">skip</span> <span class="main">≡</span> <span class="main">(</span><span class="main">1</span><span class="main">::</span><span class="tfree">'a</span> nd_fun<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sH_skip<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">P</span><span class="main"><span class="hidden">❙</span><b>}</b></span> skip <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">Q</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="main">⟷</span> <span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">≤</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> ndfun_kat_H <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> one_nd_fun_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> H_skip<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">P</span><span class="main"><span class="hidden">❙</span><b>}</b></span> skip <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">P</span><span class="main"><span class="hidden">❙</span><b>}</b></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="comment1">― ‹ Tests ›</span>

<span class="keyword1"><span class="command">lemma</span></span> sH_test<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">P</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="main">⌈</span><span class="free">R</span><span class="main">⌉</span> <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">Q</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">⟶</span> <span class="free">R</span> <span class="bound">s</span> <span class="main">⟶</span> <span class="free">Q</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> ndfun_kat_H<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> p2ndf_def<span class="main">)</span>

<span class="comment1">― ‹ Abort ›</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">abort</span> <span class="main">≡</span> <span class="main">(</span><span class="main">0</span><span class="main">::</span><span class="tfree">'a</span> nd_fun<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sH_abort<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">P</span><span class="main"><span class="hidden">❙</span><b>}</b></span> abort <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">Q</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="main">⟷</span> True"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> ndfun_kat_H <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zero_nd_fun_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> H_abort<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">P</span><span class="main"><span class="hidden">❙</span><b>}</b></span> abort <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">Q</span><span class="main"><span class="hidden">❙</span><b>}</b></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="comment1">― ‹ Assignments ›</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">assign</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">^</span><span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">^</span><span class="tfree">'b</span><span class="main">)</span> nd_fun"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword3">(2</span>_ <span class="keyword1">::=</span> _<span class="keyword3">)</span>"</span> <span class="main">[</span>70<span class="main">,</span> 65<span class="main">]</span> 61<span class="main">)</span> 
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main"><span class="free">::=</span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">{</span>vec_upd <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="bound">s</span><span class="main">)</span><span class="main">}</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>∙</sup></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sH_assign<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">P</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="main">(</span><span class="free">x</span> <span class="main">::=</span> <span class="free">e</span><span class="main">)</span> <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">Q</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">⟶</span> <span class="free">Q</span> <span class="main">(</span><span class="keyword1">χ</span> <span class="bound">j</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="main">($)</span> <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="main">(</span><span class="free">e</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> ndfun_kat_H vec_upd_def assign_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fun_upd_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> H_assign<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">Q</span> <span class="main">(</span><span class="keyword1">χ</span> <span class="bound">j</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="main">($)</span> <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="main">(</span><span class="free">e</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">P</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="main">(</span><span class="free">x</span> <span class="main">::=</span> <span class="free">e</span><span class="main">)</span> <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">Q</span><span class="main"><span class="hidden">❙</span><b>}</b></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="comment1">― ‹ Nondeterministic assignments ›</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">nondet_assign</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">^</span><span class="tfree">'b</span><span class="main">)</span> nd_fun"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword3">(2</span>_ <span class="keyword1">::=</span> <span class="keyword1">?</span> <span class="keyword3">)</span>"</span> <span class="main">[</span>70<span class="main">]</span> 61<span class="main">)</span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main"><span class="free">::=</span></span> <span class="main"><span class="free">?</span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">{</span>vec_upd <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="bound">k</span><span class="main">|</span><span class="bound">k</span><span class="main">.</span> True<span class="main">}</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>∙</sup></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sH_nondet_assign<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">P</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="main">(</span><span class="free">x</span> <span class="main">::=</span> <span class="main">?</span><span class="main">)</span> <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">Q</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="free">Q</span> <span class="main">(</span><span class="keyword1">χ</span> <span class="bound">j</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="main">($)</span> <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> ndfun_kat_H vec_upd_def nondet_assign_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fun_upd_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> H_nondet_assign<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>{</b></span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="keyword1">χ</span> <span class="bound">j</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="main">($)</span> <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="bound">j</span><span class="main">)</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="main">(</span><span class="free">x</span> <span class="main">::=</span> <span class="main">?</span><span class="main">)</span> <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">P</span><span class="main"><span class="hidden">❙</span><b>}</b></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="comment1">― ‹ Sequential Composition ›</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">seq_seq</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> nd_fun <span class="main">⇒</span> <span class="tfree">'a</span> nd_fun <span class="main">⇒</span> <span class="tfree">'a</span> nd_fun"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">;</span>"</span> 75<span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main"><span class="free">;</span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">⋅</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> H_seq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">P</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="free">X</span> <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">R</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="main">⟹</span> <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">R</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="free">Y</span> <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">Q</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="main">⟹</span> <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">P</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="free">X</span><span class="main">;</span><span class="free">Y</span> <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">Q</span><span class="main"><span class="hidden">❙</span><b>}</b></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> H_seq<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sH_seq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">P</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="free">X</span><span class="main">;</span><span class="free">Y</span> <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">Q</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="main">=</span> <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">P</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="free">X</span> <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">s'</span><span class="main">.</span> <span class="bound">s'</span> <span class="main">∈</span> <span class="main">(</span><span class="free">Y</span><span class="main"><span class="hidden">⇩</span><sub>∙</sub></span><span class="main">)</span> <span class="bound">s</span> <span class="main">⟶</span> <span class="free">Q</span> <span class="bound">s'</span><span class="main"><span class="hidden">❙</span><b>}</b></span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> ndfun_kat_H <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> times_nd_fun_def kcomp_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> H_assignl<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">K</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="free">X</span> <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">Q</span><span class="main"><span class="hidden">❙</span><b>}</b></span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">⟶</span> <span class="free">K</span> <span class="main">(</span>vec_lambda <span class="main">(</span><span class="main">(</span><span class="main">($)</span> <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="free">e</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">P</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="main">(</span><span class="free">x</span> <span class="main">::=</span> <span class="free">e</span><span class="main">)</span><span class="main">;</span><span class="free">X</span> <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">Q</span><span class="main"><span class="hidden">❙</span><b>}</b></span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> H_seq<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> sH_assign<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="comment1">― ‹ Nondeterministic Choice ›</span>

<span class="keyword1"><span class="command">lemma</span></span> sH_choice<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">P</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="free">X</span> <span class="main">+</span> <span class="free">Y</span> <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">Q</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="main">⟷</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">P</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="free">X</span> <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">Q</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="main">∧</span> <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">P</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="free">Y</span> <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">Q</span><span class="main"><span class="hidden">❙</span><b>}</b></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> ndfun_kat_H <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> plus_nd_fun_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> H_choice<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">P</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="free">X</span> <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">Q</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="main">⟹</span> <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">P</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="free">Y</span> <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">Q</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="main">⟹</span> <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">P</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="free">X</span> <span class="main">+</span> <span class="free">Y</span> <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">Q</span><span class="main"><span class="hidden">❙</span><b>}</b></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> H_choice <span class="keyword1"><span class="command">.</span></span>

<span class="comment1">― ‹ Conditional Statement ›</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">cond_sugar</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> pred <span class="main">⇒</span> <span class="tfree">'a</span> nd_fun <span class="main">⇒</span> <span class="tfree">'a</span> nd_fun <span class="main">⇒</span> <span class="tfree">'a</span> nd_fun"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">IF</span> _ <span class="keyword1">THEN</span> _ <span class="keyword1">ELSE</span> _"</span> <span class="main">[</span>64<span class="main">,</span>64<span class="main">]</span> 63<span class="main">)</span> 
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">IF</span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="keyword1"><span class="free">THEN</span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="keyword1"><span class="free">ELSE</span></span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span> <span class="main">≡</span> kat_cond <span class="main">⌈</span><span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">⌉</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sH_cond<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">P</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="main">(</span><span class="keyword1">IF</span> <span class="free">B</span> <span class="keyword1">THEN</span> <span class="free">X</span> <span class="keyword1">ELSE</span> <span class="free">Y</span><span class="main">)</span> <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">Q</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="main">⟷</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>{</b></span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">∧</span> <span class="free">B</span> <span class="bound">s</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="free">X</span> <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">Q</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="main">∧</span> <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">∧</span> <span class="main">¬</span> <span class="free">B</span> <span class="bound">s</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="free">Y</span> <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">Q</span><span class="main"><span class="hidden">❙</span><b>}</b></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> H_cond_iff ndfun_kat_H<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> H_cond<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>{</b></span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">∧</span> <span class="free">B</span> <span class="bound">s</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="free">X</span> <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">Q</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="main">⟹</span> <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">∧</span> <span class="main">¬</span> <span class="free">B</span> <span class="bound">s</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="free">Y</span> <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">Q</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="main">⟹</span> <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">P</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="main">(</span><span class="keyword1">IF</span> <span class="free">B</span> <span class="keyword1">THEN</span> <span class="free">X</span> <span class="keyword1">ELSE</span> <span class="free">Y</span><span class="main">)</span> <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">Q</span><span class="main"><span class="hidden">❙</span><b>}</b></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="comment1">― ‹ While Loop ›</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">while_inv_sugar</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> pred <span class="main">⇒</span> <span class="tfree">'a</span> pred <span class="main">⇒</span> <span class="tfree">'a</span> nd_fun <span class="main">⇒</span> <span class="tfree">'a</span> nd_fun"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">WHILE</span> _ <span class="keyword1">INV</span> _ <span class="keyword1">DO</span> _"</span> <span class="main">[</span>64<span class="main">,</span>64<span class="main">,</span>64<span class="main">]</span> 63<span class="main">)</span> 
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">WHILE</span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="keyword1"><span class="free">INV</span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="keyword1"><span class="free">DO</span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">≡</span> kat_while_inv <span class="main">⌈</span><span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">⌉</span> <span class="main">⌈</span><span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">⌉</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sH_whileI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">⟶</span> <span class="free">I</span> <span class="bound">s</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">s</span><span class="main">.</span> <span class="free">I</span> <span class="bound">s</span> <span class="main">∧</span> <span class="main">¬</span> <span class="free">B</span> <span class="bound">s</span> <span class="main">⟶</span> <span class="free">Q</span> <span class="bound">s</span> <span class="main">⟹</span> <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">I</span> <span class="bound">s</span> <span class="main">∧</span> <span class="free">B</span> <span class="bound">s</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="free">X</span> <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">I</span><span class="main"><span class="hidden">❙</span><b>}</b></span> 
  <span class="main">⟹</span> <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">P</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="main">(</span><span class="keyword1">WHILE</span> <span class="free">B</span> <span class="keyword1">INV</span> <span class="free">I</span> <span class="keyword1">DO</span> <span class="free">X</span><span class="main">)</span> <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">Q</span><span class="main"><span class="hidden">❙</span><b>}</b></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> H_while_inv<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ndfun_kat_H<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>{</b></span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">∧</span> <span class="free">B</span> <span class="bound">s</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="free">X</span> <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="main">⟹</span> <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">P</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="main">(</span><span class="keyword1">WHILE</span> <span class="free">B</span> <span class="keyword1">INV</span> <span class="free">I</span> <span class="keyword1">DO</span> <span class="free">X</span><span class="main">)</span> <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">∧</span> <span class="main">¬</span> <span class="free">B</span> <span class="bound">s</span><span class="main"><span class="hidden">❙</span><b>}</b></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> H_while<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⌈</span><span class="free">B</span><span class="main">⌉</span>"</span></span> <span class="quoted"><span class="free">X</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">unfolding</span></span> kat_while_inv_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="comment1">― ‹ Finite Iteration ›</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">loopi_sugar</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> nd_fun <span class="main">⇒</span> <span class="tfree">'a</span> pred <span class="main">⇒</span> <span class="tfree">'a</span> nd_fun"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">LOOP</span> _ <span class="keyword1">INV</span> _ "</span> <span class="main">[</span>64<span class="main">,</span>64<span class="main">]</span> 63<span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">LOOP</span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="keyword1"><span class="free">INV</span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">≡</span> kat_loop_inv <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">⌈</span><span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">⌉</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> H_loop<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">P</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="free">X</span> <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">P</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="main">⟹</span> <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">P</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="main">(</span><span class="keyword1">LOOP</span> <span class="free">X</span> <span class="keyword1">INV</span> <span class="free">I</span><span class="main">)</span> <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">P</span><span class="main"><span class="hidden">❙</span><b>}</b></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> H_loop<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> H_loopI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">I</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="free">X</span> <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">I</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="main">⟹</span> <span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">≤</span> <span class="main">⌈</span><span class="free">I</span><span class="main">⌉</span> <span class="main">⟹</span> <span class="main">⌈</span><span class="free">I</span><span class="main">⌉</span> <span class="main">≤</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span> <span class="main">⟹</span> <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">P</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="main">(</span><span class="keyword1">LOOP</span> <span class="free">X</span> <span class="keyword1">INV</span> <span class="free">I</span><span class="main">)</span> <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">Q</span><span class="main"><span class="hidden">❙</span><b>}</b></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> H_loop_inv<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⌈</span><span class="free">I</span><span class="main">⌉</span>"</span></span> <span class="quoted"><span class="free">X</span></span> <span class="quoted"><span class="quoted">"<span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹ Evolution commands ›</span></span>

<span class="comment1">― ‹Verification by providing evolution›</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">g_evol</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>ord<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'b</span> pred <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'a</span> set<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'b</span> nd_fun"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">EVOL</span>"</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">EVOL</span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> g_orbit <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="bound">t</span> <span class="bound">s</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>∙</sup></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sH_g_evol<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>  
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">φ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>preorder<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">P</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="main">(</span><span class="keyword1">EVOL</span> <span class="free">φ</span> <span class="free">G</span> <span class="free">U</span><span class="main">)</span> <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">Q</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">t</span><span class="main">∈</span><span class="free">U</span> <span class="bound">s</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">τ</span><span class="main">∈</span>down <span class="main">(</span><span class="free">U</span> <span class="bound">s</span><span class="main">)</span> <span class="bound">t</span><span class="main">.</span> <span class="free">G</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">τ</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">Q</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">t</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> ndfun_kat_H g_evol_def g_orbit_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> H_g_evol<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">φ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>preorder<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'b</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">t</span><span class="main">∈</span><span class="free">U</span> <span class="bound">s</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">τ</span><span class="main">∈</span>down <span class="main">(</span><span class="free">U</span> <span class="bound">s</span><span class="main">)</span> <span class="bound">t</span><span class="main">.</span> <span class="free">G</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">τ</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">Q</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">t</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">P</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="main">(</span><span class="keyword1">EVOL</span> <span class="free">φ</span> <span class="free">G</span> <span class="free">U</span><span class="main">)</span> <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">Q</span><span class="main"><span class="hidden">❙</span><b>}</b></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main">)</span>

<span class="comment1">― ‹Verification by providing solutions›</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">g_ode</span> <span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">(</span>real <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>banach<span class="main">)</span><span class="main">⇒</span><span class="tfree">'a</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> pred <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> real set<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> set <span class="main">⇒</span> 
  real <span class="main">⇒</span> <span class="tfree">'a</span> nd_fun"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword3">(1</span><span class="keyword1">x´=</span> _ <span class="keyword1">&amp;</span> _ <span class="keyword1">on</span> _ _ <span class="keyword1">@</span> _<span class="keyword3">)</span>"</span><span class="main">)</span> 
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1"><span class="free">x´=</span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main"><span class="free">&amp;</span></span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="keyword1"><span class="free">on</span></span> <span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main"><span class="free">@</span></span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">)</span> <span class="main">≡</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">s</span><span class="main">.</span> g_orbital <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="bound">s</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>∙</sup></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> H_g_orbital<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">X</span><span class="main">∈</span>ivp_sols <span class="free">f</span> <span class="free">U</span> <span class="free">S</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">t</span><span class="main">∈</span><span class="free">U</span> <span class="bound">s</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">τ</span><span class="main">∈</span>down <span class="main">(</span><span class="free">U</span> <span class="bound">s</span><span class="main">)</span> <span class="bound">t</span><span class="main">.</span> <span class="free">G</span> <span class="main">(</span><span class="bound">X</span> <span class="bound">τ</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">Q</span> <span class="main">(</span><span class="bound">X</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> 
  <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">P</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="free">f</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">Q</span><span class="main"><span class="hidden">❙</span><b>}</b></span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> ndfun_kat_H g_ode_def g_orbital_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">clarsimp</span>

<span class="keyword1"><span class="command">lemma</span></span> sH_g_orbital<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">P</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="free">f</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">Q</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="main">=</span> 
  <span class="main">(</span><span class="main">∀</span><span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">X</span><span class="main">∈</span>ivp_sols <span class="free">f</span> <span class="free">U</span> <span class="free">S</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">t</span><span class="main">∈</span><span class="free">U</span> <span class="bound">s</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">τ</span><span class="main">∈</span>down <span class="main">(</span><span class="free">U</span> <span class="bound">s</span><span class="main">)</span> <span class="bound">t</span><span class="main">.</span> <span class="free">G</span> <span class="main">(</span><span class="bound">X</span> <span class="bound">τ</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">Q</span> <span class="main">(</span><span class="bound">X</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> g_orbital_eq g_ode_def ndfun_kat_H <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">context</span></span> local_flow
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sH_g_ode_subset<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">∈</span> <span class="free">U</span> <span class="bound">s</span> <span class="main">∧</span> is_interval <span class="main">(</span><span class="free">U</span> <span class="bound">s</span><span class="main">)</span> <span class="main">∧</span> <span class="free">U</span> <span class="bound">s</span> <span class="main">⊆</span> <span class="free">T</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">P</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">f</span><span class="main">)</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="main">0</span><span class="main">)</span> <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">Q</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="main">=</span> 
  <span class="main">(</span><span class="main">∀</span><span class="bound">s</span><span class="main">∈</span><span class="free">S</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">t</span><span class="main">∈</span><span class="free">U</span> <span class="bound">s</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">τ</span><span class="main">∈</span>down <span class="main">(</span><span class="free">U</span> <span class="bound">s</span><span class="main">)</span> <span class="bound">t</span><span class="main">.</span> <span class="free">G</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">τ</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">Q</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">t</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">unfold</span> sH_g_orbital<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="skolem">t</span>
  <span class="keyword3"><span class="command">assume</span></span> hyps<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> <span class="free">U</span> <span class="skolem">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">τ</span><span class="main">.</span> <span class="bound">τ</span> <span class="main">∈</span> <span class="free">U</span> <span class="skolem">s</span> <span class="main">∧</span> <span class="bound">τ</span> <span class="main">≤</span> <span class="skolem">t</span> <span class="main">⟶</span> <span class="free">G</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">τ</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> main<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">X</span><span class="main">∈</span><span class="keyword1">Sols</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">f</span><span class="main">)</span> <span class="free">U</span> <span class="free">S</span> <span class="main">0</span> <span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">t</span><span class="main">∈</span><span class="free">U</span> <span class="bound">s</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">τ</span><span class="main">.</span> <span class="bound">τ</span> <span class="main">∈</span> <span class="free">U</span> <span class="bound">s</span> <span class="main">∧</span> <span class="bound">τ</span> <span class="main">≤</span> <span class="bound">t</span> <span class="main">⟶</span> <span class="free">G</span> <span class="main">(</span><span class="bound">X</span> <span class="bound">τ</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">Q</span> <span class="main">(</span><span class="bound">X</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">φ</span> <span class="bound">t</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1">Sols</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">f</span><span class="main">)</span> <span class="free">U</span> <span class="free">S</span> <span class="main">0</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> in_ivp_sols assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="main">(</span><span class="free">φ</span> <span class="skolem">t</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> main hyps <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="skolem">X</span> <span class="skolem">t</span>
  <span class="keyword3"><span class="command">assume</span></span> hyps<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> <span class="keyword1">Sols</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">f</span><span class="main">)</span> <span class="free">U</span> <span class="free">S</span> <span class="main">0</span> <span class="skolem">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> <span class="free">U</span> <span class="skolem">s</span>"</span></span>  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">τ</span><span class="main">.</span> <span class="bound">τ</span> <span class="main">∈</span> <span class="free">U</span> <span class="skolem">s</span> <span class="main">∧</span> <span class="bound">τ</span> <span class="main">≤</span> <span class="skolem">t</span> <span class="main">⟶</span> <span class="free">G</span> <span class="main">(</span><span class="skolem">X</span> <span class="bound">τ</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> main<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s</span><span class="main">∈</span><span class="free">S</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">t</span><span class="main">∈</span><span class="free">U</span> <span class="bound">s</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">τ</span><span class="main">.</span> <span class="bound">τ</span> <span class="main">∈</span> <span class="free">U</span> <span class="bound">s</span> <span class="main">∧</span> <span class="bound">τ</span> <span class="main">≤</span> <span class="bound">t</span> <span class="main">⟶</span> <span class="free">G</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">τ</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">Q</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">t</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> obs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> <span class="free">S</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ivp_sols_def<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">f</span>"</span></span><span class="main">]</span> init_time <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">τ</span><span class="main">∈</span>down <span class="main">(</span><span class="free">U</span> <span class="skolem">s</span><span class="main">)</span> <span class="skolem">t</span><span class="main">.</span> <span class="skolem">X</span> <span class="bound">τ</span> <span class="main">=</span> <span class="free">φ</span> <span class="bound">τ</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> eq_solution hyps assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="main">(</span><span class="skolem">X</span> <span class="skolem">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> hyps main obs <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> H_g_ode_subset<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">∈</span> <span class="free">U</span> <span class="bound">s</span> <span class="main">∧</span> is_interval <span class="main">(</span><span class="free">U</span> <span class="bound">s</span><span class="main">)</span> <span class="main">∧</span> <span class="free">U</span> <span class="bound">s</span> <span class="main">⊆</span> <span class="free">T</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">t</span><span class="main">∈</span><span class="free">U</span> <span class="bound">s</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">τ</span><span class="main">∈</span>down <span class="main">(</span><span class="free">U</span> <span class="bound">s</span><span class="main">)</span> <span class="bound">t</span><span class="main">.</span> <span class="free">G</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">τ</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">Q</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">t</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">P</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">f</span><span class="main">)</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="main">0</span><span class="main">)</span> <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">Q</span><span class="main"><span class="hidden">❙</span><b>}</b></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> sH_g_ode_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> sH_g_ode<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">P</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">f</span><span class="main">)</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">T</span><span class="main">)</span> <span class="free">S</span> <span class="main">@</span> <span class="main">0</span><span class="main">)</span> <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">Q</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="main">=</span> 
  <span class="main">(</span><span class="main">∀</span><span class="bound">s</span><span class="main">∈</span><span class="free">S</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">t</span><span class="main">∈</span><span class="free">T</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">τ</span><span class="main">∈</span>down <span class="free">T</span> <span class="bound">t</span><span class="main">.</span> <span class="free">G</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">τ</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">Q</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">t</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sH_g_ode_subset<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> init_time interval_time<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sH_g_ode_ivl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">≥</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free">t</span> <span class="main">∈</span> <span class="free">T</span> <span class="main">⟹</span> <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">P</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">f</span><span class="main">)</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">t</span><span class="main">}</span><span class="main">)</span> <span class="free">S</span> <span class="main">@</span> <span class="main">0</span><span class="main">)</span> <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">Q</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="main">=</span> 
  <span class="main">(</span><span class="main">∀</span><span class="bound">s</span><span class="main">∈</span><span class="free">S</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">t</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">t</span><span class="main">}</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">τ</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="bound">t</span><span class="main">}</span><span class="main">.</span> <span class="free">G</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">τ</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">Q</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">t</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> sH_g_ode_subset<span class="main"><span class="keyword3">;</span></span> <span class="operator">clarsimp</span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">force</span><span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> init_time interval_time mem_is_interval_1_I <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> sH_orbit<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">P</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="keyword1">γ<span class="hidden">⇧</span><sup>φ</sup></span><span class="main"><span class="hidden">⇧</span><sup>∙</sup></span> <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">Q</span><span class="main"><span class="hidden">❙</span><b>}</b></span>  <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">s</span> <span class="main">∈</span> <span class="free">S</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">t</span> <span class="main">∈</span> <span class="free">T</span><span class="main">.</span> <span class="free">Q</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">t</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> sH_g_ode <span class="keyword1"><span class="command">unfolding</span></span> orbit_def g_ode_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="comment1">― ‹ Verification with differential invariants ›</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">g_ode_inv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>real <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>banach<span class="main">)</span><span class="main">⇒</span><span class="tfree">'a</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> pred <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> real set<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> set <span class="main">⇒</span> 
  real <span class="main">⇒</span> <span class="tfree">'a</span> pred <span class="main">⇒</span> <span class="tfree">'a</span> nd_fun"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword3">(1</span><span class="keyword1">x´=</span>_ <span class="keyword1">&amp;</span> _ <span class="keyword1">on</span> _ _ <span class="keyword1">@</span> _ <span class="keyword1">DINV</span> _ <span class="keyword3">)</span>"</span><span class="main">)</span> 
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1"><span class="free">x´=</span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main"><span class="free">&amp;</span></span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="keyword1"><span class="free">on</span></span> <span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main"><span class="free">@</span></span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="keyword1"><span class="free">DINV</span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">&amp;</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="keyword1">on</span> <span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">@</span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sH_g_orbital_guard<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">G</span> <span class="bound">s</span> <span class="main">∧</span> <span class="free">Q</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">P</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="free">f</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">Q</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="main">=</span> <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">P</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="free">f</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">R</span><span class="main"><span class="hidden">❙</span><b>}</b></span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> g_orbital_eq ndfun_kat_H ivp_sols_def g_ode_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> sH_g_orbital_inv<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">≤</span> <span class="main">⌈</span><span class="free">I</span><span class="main">⌉</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">I</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="free">f</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">I</span><span class="main"><span class="hidden">❙</span><b>}</b></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⌈</span><span class="free">I</span><span class="main">⌉</span> <span class="main">≤</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">" <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">P</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="free">f</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">Q</span><span class="main"><span class="hidden">❙</span><b>}</b></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> p'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">⌈</span><span class="free">I</span><span class="main">⌉</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> H_consl<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> q'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">⌈</span><span class="free">I</span><span class="main">⌉</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> H_consr<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> sH_diff_inv<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">I</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="free">f</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">I</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="main">=</span> diff_invariant <span class="free">I</span> <span class="free">f</span> <span class="free">U</span> <span class="free">S</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">G</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> diff_invariant_eq ndfun_kat_H g_orbital_eq g_ode_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> H_g_ode_inv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">I</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="free">f</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">I</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="main">⟹</span> <span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">≤</span> <span class="main">⌈</span><span class="free">I</span><span class="main">⌉</span> <span class="main">⟹</span> 
  <span class="main">⌈</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">I</span> <span class="bound">s</span> <span class="main">∧</span> <span class="free">G</span> <span class="bound">s</span><span class="main">⌉</span> <span class="main">≤</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span> <span class="main">⟹</span> <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">P</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="free">f</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="keyword1">DINV</span> <span class="free">I</span><span class="main">)</span> <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">Q</span><span class="main"><span class="hidden">❙</span><b>}</b></span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> g_ode_inv_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> q'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">⌈</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">I</span> <span class="bound">s</span> <span class="main">∧</span> <span class="free">G</span> <span class="bound">s</span><span class="main">⌉</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> H_consr<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> sH_g_orbital_guard<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> I<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">I</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> sH_g_orbital_inv<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹ Refinement Components ›</span></span>

<span class="comment1">― ‹ Skip ›</span>

<span class="keyword1"><span class="command">lemma</span></span> R_skip<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">⟶</span> <span class="free">Q</span> <span class="bound">s</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">1</span> <span class="main">≤</span> Ref <span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> spec_def ndfun_kat_H one_nd_fun_def<span class="main">)</span>

<span class="comment1">― ‹ Abort ›</span>

<span class="keyword1"><span class="command">lemma</span></span> R_abort<span class="main">:</span> <span class="quoted"><span class="quoted">"abort <span class="main">≤</span> Ref <span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> R2<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="comment1">― ‹ Sequential Composition ›</span>

<span class="keyword1"><span class="command">lemma</span></span> R_seq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Ref <span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">⌈</span><span class="free">R</span><span class="main">⌉</span><span class="main">)</span> <span class="main">;</span> <span class="main">(</span>Ref <span class="main">⌈</span><span class="free">R</span><span class="main">⌉</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span><span class="main">)</span> <span class="main">≤</span> Ref <span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> R_seq <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> R_seq_law<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">≤</span> Ref <span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">⌈</span><span class="free">R</span><span class="main">⌉</span> <span class="main">⟹</span> <span class="free">Y</span> <span class="main">≤</span> Ref <span class="main">⌈</span><span class="free">R</span><span class="main">⌉</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span> <span class="main">⟹</span> <span class="free">X</span><span class="main">;</span> <span class="free">Y</span> <span class="main">≤</span> Ref <span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> spec_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> H_seq<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> R_seq_mono <span class="main">=</span> mult_isol_var

<span class="comment1">― ‹ Nondeterministic Choice ›</span>

<span class="keyword1"><span class="command">lemma</span></span> R_choice<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Ref <span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span>Ref <span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span><span class="main">)</span> <span class="main">≤</span> Ref <span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> R_choice<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lemma</span></span> R_choice_law<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">≤</span> Ref <span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span> <span class="main">⟹</span> <span class="free">Y</span> <span class="main">≤</span> Ref <span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span> <span class="main">⟹</span> <span class="free">X</span> <span class="main">+</span> <span class="free">Y</span> <span class="main">≤</span> Ref <span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> join.le_supI <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lemma</span></span> R_choice_mono<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P'</span> <span class="main">≤</span> <span class="free">P</span> <span class="main">⟹</span> <span class="free">Q'</span> <span class="main">≤</span> <span class="free">Q</span> <span class="main">⟹</span> <span class="free">P'</span> <span class="main">+</span> <span class="free">Q'</span> <span class="main">⊆</span> <span class="free">P</span> <span class="main">+</span> <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> set_plus_mono2 <span class="keyword1"><span class="command">.</span></span>

<span class="comment1">― ‹ Assignment ›</span>

<span class="keyword1"><span class="command">lemma</span></span> R_assign<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">::=</span> <span class="free">e</span><span class="main">)</span> <span class="main">≤</span> Ref <span class="main">⌈</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="keyword1">χ</span> <span class="bound">j</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="main">($)</span> <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="free">e</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="bound">j</span><span class="main">)</span><span class="main">⌉</span> <span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> spec_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> H_assign<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fun_eq_iff fun_upd_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> R_assign_law<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">⟶</span> <span class="free">Q</span> <span class="main">(</span><span class="keyword1">χ</span> <span class="bound">j</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="main">($)</span> <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="main">(</span><span class="free">e</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">x</span> <span class="main">::=</span> <span class="free">e</span><span class="main">)</span> <span class="main">≤</span> Ref <span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> sH_assign<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> spec_def <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lemma</span></span> R_assignl<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">R</span> <span class="main">(</span><span class="keyword1">χ</span> <span class="bound">j</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="main">($)</span> <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="free">e</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">x</span> <span class="main">::=</span> <span class="free">e</span><span class="main">)</span> <span class="main">;</span> Ref <span class="main">⌈</span><span class="free">R</span><span class="main">⌉</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span> <span class="main">≤</span> Ref <span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> R_seq_law<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> R_assign_law<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> R_assignr<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">Q</span> <span class="main">(</span><span class="keyword1">χ</span> <span class="bound">j</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="main">($)</span> <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="free">e</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> Ref <span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">⌈</span><span class="free">R</span><span class="main">⌉</span><span class="main">;</span> <span class="main">(</span><span class="free">x</span> <span class="main">::=</span> <span class="free">e</span><span class="main">)</span> <span class="main">≤</span> Ref <span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> R_seq_law<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> R_assign_law<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">::=</span> <span class="free">e</span><span class="main">)</span> <span class="main">;</span> Ref <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span> <span class="main">≤</span> Ref <span class="main">⌈</span><span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">Q</span> <span class="main">(</span><span class="keyword1">χ</span> <span class="bound">j</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="main">($)</span> <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="free">e</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span><span class="main">⌉</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> R_assignl<span class="main">)</span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"Ref <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span> <span class="main">⌈</span><span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">Q</span> <span class="main">(</span><span class="keyword1">χ</span> <span class="bound">j</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="main">($)</span> <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="free">e</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span><span class="main">⌉</span><span class="main">;</span> <span class="main">(</span><span class="free">x</span> <span class="main">::=</span> <span class="free">e</span><span class="main">)</span> <span class="main">≤</span> Ref <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> R_assignr<span class="main">)</span> <span class="operator">simp</span>

<span class="comment1">― ‹ Nondeterministic Assignment ›</span>

<span class="keyword1"><span class="command">lemma</span></span> R_nondet_assign<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">::=</span> <span class="main">?</span><span class="main">)</span> <span class="main">≤</span> Ref <span class="main">⌈</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="keyword1">χ</span> <span class="bound">j</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="main">($)</span> <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="bound">j</span><span class="main">)</span><span class="main">⌉</span> <span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> spec_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> H_nondet_assign<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> R_nondet_assign_law<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="free">Q</span> <span class="main">(</span><span class="keyword1">χ</span> <span class="bound">j</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="main">($)</span> <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">x</span> <span class="main">::=</span> <span class="main">?</span><span class="main">)</span> <span class="main">≤</span> Ref <span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> sH_nondet_assign<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> R2<span class="main">)</span>

<span class="comment1">― ‹ Conditional Statement ›</span>

<span class="keyword1"><span class="command">lemma</span></span> R_cond<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">IF</span> <span class="free">B</span> <span class="keyword1">THEN</span> Ref <span class="main">⌈</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">B</span> <span class="bound">s</span> <span class="main">∧</span> <span class="free">P</span> <span class="bound">s</span><span class="main">⌉</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span> <span class="keyword1">ELSE</span> Ref <span class="main">⌈</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">¬</span> <span class="free">B</span> <span class="bound">s</span> <span class="main">∧</span> <span class="free">P</span> <span class="bound">s</span><span class="main">⌉</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span><span class="main">)</span> <span class="main">≤</span> Ref <span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> R_cond<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">⌈</span><span class="free">B</span><span class="main">⌉</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> R_cond_mono<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">≤</span> <span class="free">X'</span> <span class="main">⟹</span> <span class="free">Y</span> <span class="main">≤</span> <span class="free">Y'</span> <span class="main">⟹</span> <span class="main">(</span><span class="keyword1">IF</span> <span class="free">P</span> <span class="keyword1">THEN</span> <span class="free">X</span> <span class="keyword1">ELSE</span> <span class="free">Y</span><span class="main">)</span> <span class="main">≤</span> <span class="keyword1">IF</span> <span class="free">P</span> <span class="keyword1">THEN</span> <span class="free">X'</span> <span class="keyword1">ELSE</span> <span class="free">Y'</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> kat_cond_def times_nd_fun_def plus_nd_fun_def n_op_nd_fun_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> kcomp_def less_eq_nd_fun_def p2ndf_def le_fun_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> R_cond_law<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">≤</span> Ref <span class="main">⌈</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">B</span> <span class="bound">s</span> <span class="main">∧</span> <span class="free">P</span> <span class="bound">s</span><span class="main">⌉</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span> <span class="main">⟹</span> <span class="free">Y</span> <span class="main">≤</span> Ref <span class="main">⌈</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">¬</span> <span class="free">B</span> <span class="bound">s</span> <span class="main">∧</span> <span class="free">P</span> <span class="bound">s</span><span class="main">⌉</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span> <span class="main">⟹</span> 
  <span class="main">(</span><span class="keyword1">IF</span> <span class="free">B</span> <span class="keyword1">THEN</span> <span class="free">X</span> <span class="keyword1">ELSE</span> <span class="free">Y</span><span class="main">)</span> <span class="main">≤</span> Ref <span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> order_trans<span class="main"><span class="keyword3">;</span></span> <span class="main">(</span><span class="operator">rule</span> R_cond_mono<span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">rule</span> R_cond<span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="comment1">― ‹ While loop ›</span>

<span class="keyword1"><span class="command">lemma</span></span> R_while<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">K</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">∧</span> <span class="main">¬</span> <span class="free">B</span> <span class="bound">s</span><span class="main">)</span> <span class="main">⟹</span>
  <span class="keyword1">WHILE</span> <span class="free">B</span> <span class="keyword1">INV</span> <span class="free">I</span> <span class="keyword1">DO</span> <span class="main">(</span>Ref <span class="main">⌈</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">∧</span> <span class="free">B</span> <span class="bound">s</span><span class="main">⌉</span> <span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span><span class="main">)</span> <span class="main">≤</span> Ref <span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">⌈</span><span class="free">K</span><span class="main">⌉</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> kat_while_inv_def <span class="keyword1"><span class="command">using</span></span> R_while<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">⌈</span><span class="free">B</span><span class="main">⌉</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> R_whileI<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">≤</span> Ref <span class="main">⌈</span><span class="free">I</span><span class="main">⌉</span> <span class="main">⌈</span><span class="free">I</span><span class="main">⌉</span> <span class="main">⟹</span> <span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">≤</span> <span class="main">⌈</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">I</span> <span class="bound">s</span> <span class="main">∧</span> <span class="free">B</span> <span class="bound">s</span><span class="main">⌉</span> <span class="main">⟹</span> <span class="main">⌈</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">I</span> <span class="bound">s</span> <span class="main">∧</span> <span class="main">¬</span> <span class="free">B</span> <span class="bound">s</span><span class="main">⌉</span> <span class="main">≤</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span> <span class="main">⟹</span> 
  <span class="keyword1">WHILE</span> <span class="free">B</span> <span class="keyword1">INV</span> <span class="free">I</span> <span class="keyword1">DO</span> <span class="free">X</span> <span class="main">≤</span> Ref <span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> R2<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> H_while_inv<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ndfun_kat_H spec_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> R_while_mono<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">≤</span> <span class="free">X'</span> <span class="main">⟹</span> <span class="main">(</span><span class="keyword1">WHILE</span> <span class="free">P</span> <span class="keyword1">INV</span> <span class="free">I</span> <span class="keyword1">DO</span> <span class="free">X</span><span class="main">)</span> <span class="main">≤</span> <span class="keyword1">WHILE</span> <span class="free">P</span> <span class="keyword1">INV</span> <span class="free">I</span> <span class="keyword1">DO</span> <span class="free">X'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> kat_while_inv_def kat_while_def mult_isol mult_isor star_iso<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> R_while_law<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">≤</span> Ref <span class="main">⌈</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">∧</span> <span class="free">B</span> <span class="bound">s</span><span class="main">⌉</span> <span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">∧</span> <span class="main">¬</span> <span class="free">B</span> <span class="bound">s</span><span class="main">)</span> <span class="main">⟹</span> 
  <span class="main">(</span><span class="keyword1">WHILE</span> <span class="free">B</span> <span class="keyword1">INV</span> <span class="free">I</span> <span class="keyword1">DO</span> <span class="free">X</span><span class="main">)</span> <span class="main">≤</span> Ref <span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> order_trans<span class="main"><span class="keyword3">;</span></span> <span class="main">(</span><span class="operator">rule</span> R_while_mono<span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">rule</span> R_while<span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main">)</span>

<span class="comment1">― ‹ Finite Iteration ›</span>

<span class="keyword1"><span class="command">lemma</span></span> R_loop<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">≤</span> Ref <span class="main">⌈</span><span class="free">I</span><span class="main">⌉</span> <span class="main">⌈</span><span class="free">I</span><span class="main">⌉</span> <span class="main">⟹</span> <span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">≤</span> <span class="main">⌈</span><span class="free">I</span><span class="main">⌉</span> <span class="main">⟹</span> <span class="main">⌈</span><span class="free">I</span><span class="main">⌉</span> <span class="main">≤</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span> <span class="main">⟹</span> <span class="keyword1">LOOP</span> <span class="free">X</span> <span class="keyword1">INV</span> <span class="free">I</span> <span class="main">≤</span> Ref <span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> spec_def <span class="keyword1"><span class="command">using</span></span> H_loopI <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> R_loopI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">≤</span> Ref <span class="main">⌈</span><span class="free">I</span><span class="main">⌉</span> <span class="main">⌈</span><span class="free">I</span><span class="main">⌉</span> <span class="main">⟹</span> <span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">≤</span> <span class="main">⌈</span><span class="free">I</span><span class="main">⌉</span> <span class="main">⟹</span> <span class="main">⌈</span><span class="free">I</span><span class="main">⌉</span> <span class="main">≤</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span> <span class="main">⟹</span> <span class="keyword1">LOOP</span> <span class="free">X</span> <span class="keyword1">INV</span> <span class="free">I</span> <span class="main">≤</span> Ref <span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> spec_def <span class="keyword1"><span class="command">using</span></span> H_loopI <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> R_loop_mono<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">≤</span> <span class="free">X'</span> <span class="main">⟹</span> <span class="keyword1">LOOP</span> <span class="free">X</span> <span class="keyword1">INV</span> <span class="free">I</span> <span class="main">≤</span> <span class="keyword1">LOOP</span> <span class="free">X'</span> <span class="keyword1">INV</span> <span class="free">I</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> kat_loop_inv_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> star_iso<span class="main">)</span>

<span class="comment1">― ‹ Evolution command (flow) ›</span>

<span class="keyword1"><span class="command">lemma</span></span> R_g_evol<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">φ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>preorder<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">EVOL</span> <span class="free">φ</span> <span class="free">G</span> <span class="free">U</span><span class="main">)</span> <span class="main">≤</span> Ref <span class="main">⌈</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">t</span><span class="main">∈</span><span class="free">U</span> <span class="bound">s</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">τ</span><span class="main">∈</span>down <span class="main">(</span><span class="free">U</span> <span class="bound">s</span><span class="main">)</span> <span class="bound">t</span><span class="main">.</span> <span class="free">G</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">τ</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">P</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">t</span> <span class="bound">s</span><span class="main">)</span><span class="main">⌉</span> <span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> spec_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> H_g_evol<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> R_g_evol_law<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">φ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>preorder<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">t</span><span class="main">∈</span><span class="free">U</span> <span class="bound">s</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">τ</span><span class="main">∈</span>down <span class="main">(</span><span class="free">U</span> <span class="bound">s</span><span class="main">)</span> <span class="bound">t</span><span class="main">.</span> <span class="free">G</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">τ</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">Q</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">t</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> 
  <span class="main">(</span><span class="keyword1">EVOL</span> <span class="free">φ</span> <span class="free">G</span> <span class="free">U</span><span class="main">)</span> <span class="main">≤</span> Ref <span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> sH_g_evol<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> spec_def <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lemma</span></span> R_g_evoll<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">φ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>preorder<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">t</span><span class="main">∈</span><span class="free">U</span> <span class="bound">s</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">τ</span><span class="main">∈</span>down <span class="main">(</span><span class="free">U</span> <span class="bound">s</span><span class="main">)</span> <span class="bound">t</span><span class="main">.</span> <span class="free">G</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">τ</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">R</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">t</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> 
  <span class="main">(</span><span class="keyword1">EVOL</span> <span class="free">φ</span> <span class="free">G</span> <span class="free">U</span><span class="main">)</span> <span class="main">;</span> Ref <span class="main">⌈</span><span class="free">R</span><span class="main">⌉</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span> <span class="main">≤</span> Ref <span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> R_seq_law<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> R_g_evol_law<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> R_g_evolr<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">φ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>preorder<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">t</span><span class="main">∈</span><span class="free">U</span> <span class="bound">s</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">τ</span><span class="main">∈</span>down <span class="main">(</span><span class="free">U</span> <span class="bound">s</span><span class="main">)</span> <span class="bound">t</span><span class="main">.</span> <span class="free">G</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">τ</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">Q</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">t</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> 
  Ref <span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">⌈</span><span class="free">R</span><span class="main">⌉</span><span class="main">;</span> <span class="main">(</span><span class="keyword1">EVOL</span> <span class="free">φ</span> <span class="free">G</span> <span class="free">U</span><span class="main">)</span> <span class="main">≤</span> Ref <span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> R_seq_law<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> R_g_evol_law<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">φ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>preorder<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">EVOL</span> <span class="free">φ</span> <span class="free">G</span> <span class="free">U</span> <span class="main">;</span> Ref <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span> <span class="main">≤</span> 
  Ref <span class="main">⌈</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">t</span><span class="main">∈</span><span class="free">U</span> <span class="bound">s</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">τ</span><span class="main">∈</span>down <span class="main">(</span><span class="free">U</span> <span class="bound">s</span><span class="main">)</span> <span class="bound">t</span><span class="main">.</span> <span class="free">G</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">τ</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">Q</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">t</span> <span class="bound">s</span><span class="main">)</span><span class="main">⌉</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> R_g_evoll<span class="main">)</span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">φ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>preorder<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Ref <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span> <span class="main">⌈</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">t</span><span class="main">∈</span><span class="free">U</span> <span class="bound">s</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">τ</span><span class="main">∈</span>down <span class="main">(</span><span class="free">U</span> <span class="bound">s</span><span class="main">)</span> <span class="bound">t</span><span class="main">.</span> <span class="free">G</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">τ</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">Q</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">t</span> <span class="bound">s</span><span class="main">)</span><span class="main">⌉</span><span class="main">;</span> <span class="keyword1">EVOL</span> <span class="free">φ</span> <span class="free">G</span> <span class="free">U</span> <span class="main">≤</span> Ref <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> R_g_evolr<span class="main">)</span> <span class="operator">simp</span>

<span class="comment1">― ‹ Evolution command (ode) ›</span>

<span class="keyword1"><span class="command">context</span></span> local_flow
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> R_g_ode_subset<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">∈</span> <span class="free">U</span> <span class="bound">s</span> <span class="main">∧</span> is_interval <span class="main">(</span><span class="free">U</span> <span class="bound">s</span><span class="main">)</span> <span class="main">∧</span> <span class="free">U</span> <span class="bound">s</span> <span class="main">⊆</span> <span class="free">T</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">x´=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">f</span><span class="main">)</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="main">0</span><span class="main">)</span> <span class="main">≤</span> 
  Ref <span class="main">⌈</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">∈</span><span class="free">S</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">t</span><span class="main">∈</span><span class="free">U</span> <span class="bound">s</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">τ</span><span class="main">∈</span>down <span class="main">(</span><span class="free">U</span> <span class="bound">s</span><span class="main">)</span> <span class="bound">t</span><span class="main">.</span> <span class="free">G</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">τ</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">P</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">t</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">⌉</span> <span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> spec_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> H_g_ode_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> R_g_ode_rule_subset<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">∈</span> <span class="free">U</span> <span class="bound">s</span> <span class="main">∧</span> is_interval <span class="main">(</span><span class="free">U</span> <span class="bound">s</span><span class="main">)</span> <span class="main">∧</span> <span class="free">U</span> <span class="bound">s</span> <span class="main">⊆</span> <span class="free">T</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">s</span><span class="main">∈</span><span class="free">S</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">t</span><span class="main">∈</span><span class="free">U</span> <span class="bound">s</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">τ</span><span class="main">∈</span>down <span class="main">(</span><span class="free">U</span> <span class="bound">s</span><span class="main">)</span> <span class="bound">t</span><span class="main">.</span> <span class="free">G</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">τ</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">Q</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">t</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> 
  <span class="main">(</span><span class="keyword1">x´=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">f</span><span class="main">)</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="main">0</span><span class="main">)</span> <span class="main">≤</span> Ref <span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> spec_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sH_g_ode_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> R_g_odel_subset<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">∈</span> <span class="free">U</span> <span class="bound">s</span> <span class="main">∧</span> is_interval <span class="main">(</span><span class="free">U</span> <span class="bound">s</span><span class="main">)</span> <span class="main">∧</span> <span class="free">U</span> <span class="bound">s</span> <span class="main">⊆</span> <span class="free">T</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">t</span><span class="main">∈</span><span class="free">U</span> <span class="bound">s</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">τ</span><span class="main">∈</span>down <span class="main">(</span><span class="free">U</span> <span class="bound">s</span><span class="main">)</span> <span class="bound">t</span><span class="main">.</span> <span class="free">G</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">τ</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">R</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">t</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">x´=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">f</span><span class="main">)</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="main">0</span><span class="main">)</span> <span class="main">;</span> Ref <span class="main">⌈</span><span class="free">R</span><span class="main">⌉</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span> <span class="main">≤</span> Ref <span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> R_seq_law<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> R_g_ode_rule_subset<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> R_g_oder_subset<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">∈</span> <span class="free">U</span> <span class="bound">s</span> <span class="main">∧</span> is_interval <span class="main">(</span><span class="free">U</span> <span class="bound">s</span><span class="main">)</span> <span class="main">∧</span> <span class="free">U</span> <span class="bound">s</span> <span class="main">⊆</span> <span class="free">T</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">t</span><span class="main">∈</span><span class="free">U</span> <span class="bound">s</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">τ</span><span class="main">∈</span>down <span class="main">(</span><span class="free">U</span> <span class="bound">s</span><span class="main">)</span> <span class="bound">t</span><span class="main">.</span> <span class="free">G</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">τ</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">Q</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">t</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Ref <span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">⌈</span><span class="free">R</span><span class="main">⌉</span><span class="main">;</span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">f</span><span class="main">)</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="main">0</span><span class="main">)</span> <span class="main">≤</span> Ref <span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> R_seq_law<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> R_g_ode_rule_subset<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> R_g_ode<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">x´=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">f</span><span class="main">)</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">T</span><span class="main">)</span> <span class="free">S</span> <span class="main">@</span> <span class="main">0</span><span class="main">)</span> <span class="main">≤</span> 
  Ref <span class="main">⌈</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">∈</span><span class="free">S</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">t</span><span class="main">∈</span><span class="free">T</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">τ</span><span class="main">∈</span>down <span class="free">T</span> <span class="bound">t</span><span class="main">.</span> <span class="free">G</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">τ</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">P</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">t</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">⌉</span> <span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> R_g_ode_subset<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> init_time interval_time<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> R_g_ode_law<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">s</span><span class="main">∈</span><span class="free">S</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">t</span><span class="main">∈</span><span class="free">T</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">τ</span><span class="main">∈</span>down <span class="free">T</span> <span class="bound">t</span><span class="main">.</span> <span class="free">G</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">τ</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">Q</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">t</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> 
  <span class="main">(</span><span class="keyword1">x´=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">f</span><span class="main">)</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">T</span><span class="main">)</span> <span class="free">S</span> <span class="main">@</span> <span class="main">0</span><span class="main">)</span> <span class="main">≤</span> Ref <span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> sH_g_ode<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> R2<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> R_g_odel<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">t</span><span class="main">∈</span><span class="free">T</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">τ</span><span class="main">∈</span>down <span class="free">T</span> <span class="bound">t</span><span class="main">.</span> <span class="free">G</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">τ</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">R</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">t</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> 
  <span class="main">(</span><span class="keyword1">x´=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">f</span><span class="main">)</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">T</span><span class="main">)</span> <span class="free">S</span> <span class="main">@</span> <span class="main">0</span><span class="main">)</span> <span class="main">;</span> Ref <span class="main">⌈</span><span class="free">R</span><span class="main">⌉</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span> <span class="main">≤</span> Ref <span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> R_g_odel_subset<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> init_time interval_time<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> R_g_oder<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">t</span><span class="main">∈</span><span class="free">T</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">τ</span><span class="main">∈</span>down <span class="free">T</span> <span class="bound">t</span><span class="main">.</span> <span class="free">G</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">τ</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">Q</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">t</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> 
  Ref <span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">⌈</span><span class="free">R</span><span class="main">⌉</span><span class="main">;</span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">f</span><span class="main">)</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">T</span><span class="main">)</span> <span class="free">S</span> <span class="main">@</span> <span class="main">0</span><span class="main">)</span> <span class="main">≤</span> Ref <span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> R_g_oder_subset<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> init_time interval_time<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> R_g_ode_ivl<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">≥</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free">t</span> <span class="main">∈</span> <span class="free">T</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">∀</span><span class="bound">s</span><span class="main">∈</span><span class="free">S</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">t</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">t</span><span class="main">}</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">τ</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="bound">t</span><span class="main">}</span><span class="main">.</span> <span class="free">G</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">τ</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">Q</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">t</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> 
  <span class="main">(</span><span class="keyword1">x´=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">f</span><span class="main">)</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">t</span><span class="main">}</span><span class="main">)</span> <span class="free">S</span> <span class="main">@</span> <span class="main">0</span><span class="main">)</span> <span class="main">≤</span> Ref <span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> sH_g_ode_ivl<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> R2<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="comment1">― ‹ Evolution command (invariants) ›</span>

<span class="keyword1"><span class="command">lemma</span></span> R_g_ode_inv<span class="main">:</span> <span class="quoted"><span class="quoted">"diff_invariant <span class="free">I</span> <span class="free">f</span> <span class="free">T</span> <span class="free">S</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">G</span> <span class="main">⟹</span> <span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">≤</span> <span class="main">⌈</span><span class="free">I</span><span class="main">⌉</span> <span class="main">⟹</span> <span class="main">⌈</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">I</span> <span class="bound">s</span> <span class="main">∧</span> <span class="free">G</span> <span class="bound">s</span><span class="main">⌉</span> <span class="main">≤</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span> <span class="main">⟹</span> 
  <span class="main">(</span><span class="keyword1">x´=</span><span class="free">f</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="free">T</span> <span class="free">S</span> <span class="main">@</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="keyword1">DINV</span> <span class="free">I</span><span class="main">)</span> <span class="main">≤</span> Ref <span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> spec_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> H_g_ode_inv<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹ Derivation of the rules of dL ›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ We derive rules of differential dynamic logic (dL). This allows the components to reason 
in the style of that logic. ›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">g_dl_ode</span> <span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>banach<span class="main">)</span><span class="main">⇒</span><span class="tfree">'a</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> pred <span class="main">⇒</span> <span class="tfree">'a</span> nd_fun"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword3">(1</span><span class="keyword1">x´=</span>_ <span class="keyword1">&amp;</span> _<span class="keyword3">)</span>"</span><span class="main">)</span> 
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1"><span class="free">x´=</span></span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main"><span class="free">&amp;</span></span> <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span> <span class="main">≡</span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="main">&amp;</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="keyword1">on</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">{</span><span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">≥</span> <span class="main">0</span><span class="main">}</span><span class="main">)</span> UNIV <span class="main">@</span> <span class="main">0</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">g_dl_ode_inv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>banach<span class="main">)</span><span class="main">⇒</span><span class="tfree">'a</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> pred <span class="main">⇒</span> <span class="tfree">'a</span> pred <span class="main">⇒</span> <span class="tfree">'a</span> nd_fun"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword3">(1</span><span class="keyword1">x´=</span>_ <span class="keyword1">&amp;</span> _ <span class="keyword1">DINV</span> _<span class="keyword3">)</span>"</span><span class="main">)</span> 
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1"><span class="free">x´=</span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main"><span class="free">&amp;</span></span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="keyword1"><span class="free">DINV</span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">)</span> <span class="main">≡</span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="main">&amp;</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="keyword1">on</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">{</span><span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">≥</span> <span class="main">0</span><span class="main">}</span><span class="main">)</span> UNIV <span class="main">@</span> <span class="main">0</span> <span class="keyword1">DINV</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> diff_solve_rule1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"local_flow <span class="free">f</span> UNIV UNIV <span class="free">φ</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">t</span></span><span class="main">≥</span><span class="main">0</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">τ</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="bound">t</span><span class="main">}</span><span class="main">.</span> <span class="free">G</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">τ</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">Q</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">t</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">P</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="free">f</span> <span class="main">&amp;</span> <span class="free">G</span><span class="main">)</span> <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">Q</span><span class="main"><span class="hidden">❙</span><b>}</b></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">subst</span> local_flow.sH_g_ode_subset<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> diff_solve_rule2<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">c</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>heine_borel<span class="main">,</span> banach<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">t</span></span><span class="main">≥</span><span class="main">0</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">τ</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="bound">t</span><span class="main">}</span><span class="main">.</span> <span class="free">G</span> <span class="main">(</span><span class="bound">s</span> <span class="main">+</span> <span class="bound">τ</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">c</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">Q</span> <span class="main">(</span><span class="bound">s</span> <span class="main">+</span> <span class="bound">t</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">c</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">P</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="main">(</span><span class="keyword1">x´=</span><span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">c</span><span class="main">)</span> <span class="main">&amp;</span> <span class="free">G</span><span class="main">)</span> <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">Q</span><span class="main"><span class="hidden">❙</span><b>}</b></span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> local_flow.sH_g_ode_subset<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> T<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">UNIV</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> φ<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="main"><span class="main">λ</span></span> <span class="bound"><span class="bound">t</span></span> <span class="bound"><span class="bound">x</span></span><span class="main"><span class="main">.</span></span> <span class="bound"><span class="bound">x</span></span> <span class="main"><span class="main">+</span></span> <span class="bound"><span class="bound">t</span></span> <span class="keyword1"><span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span></span> <span class="free"><span class="free">c</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> line_is_local_flow assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> diff_weak_rule<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⌈</span><span class="free">G</span><span class="main">⌉</span> <span class="main">≤</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">P</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="free">f</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">Q</span><span class="main"><span class="hidden">❙</span><b>}</b></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> g_orbital_eq ndfun_kat_H ivp_sols_def g_ode_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> diff_cut_rule<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> wp_C<span class="main">:</span><span class="quoted"><span class="quoted">"Hoare <span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="free">f</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">⌈</span><span class="free">C</span><span class="main">⌉</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> wp_Q<span class="main">:</span><span class="quoted"><span class="quoted">"Hoare <span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="free">f</span> <span class="main">&amp;</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">s</span><span class="main">.</span> <span class="free">G</span> <span class="bound">s</span> <span class="main">∧</span> <span class="free">C</span> <span class="bound">s</span><span class="main">)</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">P</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="free">f</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">Q</span><span class="main"><span class="hidden">❙</span><b>}</b></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">subst</span> ndfun_kat_H<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> g_orbital_eq p2ndf_def g_ode_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span><span class="main">::</span><span class="quoted">real</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">X</span><span class="main">::</span><span class="quoted"><span class="quoted">"real <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">s</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> <span class="free">U</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> x_ivp<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> ivp_sols <span class="free">f</span> <span class="free">U</span> <span class="free">S</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">s</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> guard_x<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">U</span> <span class="skolem">s</span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">≤</span> <span class="skolem">t</span> <span class="main">⟶</span> <span class="free">G</span> <span class="main">(</span><span class="skolem">X</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t</span><span class="main">∈</span><span class="main">(</span>down <span class="main">(</span><span class="free">U</span> <span class="skolem">s</span><span class="main">)</span> <span class="skolem">t</span><span class="main">)</span><span class="main">.</span> <span class="skolem">X</span> <span class="bound">t</span> <span class="main">∈</span> g_orbital <span class="free">f</span> <span class="free">G</span> <span class="free">U</span> <span class="free">S</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> g_orbitalI<span class="main">[</span><span class="operator">OF</span> x_ivp<span class="main">]</span> guard_x <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t</span><span class="main">∈</span><span class="main">(</span>down <span class="main">(</span><span class="free">U</span> <span class="skolem">s</span><span class="main">)</span> <span class="skolem">t</span><span class="main">)</span><span class="main">.</span> <span class="free">C</span> <span class="main">(</span><span class="skolem">X</span> <span class="bound">t</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> wp_C <span class="quoted"><span class="quoted">‹<span class="free">P</span> <span class="skolem">s</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> ndfun_kat_H<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> g_ode_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="skolem">t</span> <span class="main">∈</span> g_orbital <span class="free">f</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">G</span> <span class="bound">s</span> <span class="main">∧</span> <span class="free">C</span> <span class="bound">s</span><span class="main">)</span> <span class="free">U</span> <span class="free">S</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> guard_x <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="main">∈</span> <span class="free">U</span> <span class="skolem">s</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> g_orbitalI x_ivp<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="main">(</span><span class="skolem">X</span> <span class="skolem">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">P</span> <span class="skolem">s</span>›</span></span> wp_Q <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> ndfun_kat_H<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> g_ode_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> diff_inv_rule<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⌈</span><span class="free">P</span><span class="main">⌉</span> <span class="main">≤</span> <span class="main">⌈</span><span class="free">I</span><span class="main">⌉</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"diff_invariant <span class="free">I</span> <span class="free">f</span> <span class="free">U</span> <span class="free">S</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">G</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⌈</span><span class="free">I</span><span class="main">⌉</span> <span class="main">≤</span> <span class="main">⌈</span><span class="free">Q</span><span class="main">⌉</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">P</span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="free">f</span> <span class="main">&amp;</span> <span class="free">G</span> <span class="keyword1">on</span> <span class="free">U</span> <span class="free">S</span> <span class="main">@</span> <span class="free">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="free">Q</span><span class="main"><span class="hidden">❙</span><b>}</b></span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> g_ode_inv_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">,</span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> I<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free">I</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> H_g_ode_inv<span class="main">)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> sH_diff_inv <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="HS_VC_KAT_Examples_ndfun">
<div class="head">
<h1>Theory HS_VC_KAT_Examples_ndfun</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:       Examples of hybrid systems verifications
    Author:      Jonathan Julián Huerta y Munive, 2020
    Maintainer:  Jonathan Julián Huerta y Munive &lt;jonjulian23@gmail.com&gt;
*)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹ Examples ›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ We prove partial correctness specifications of some hybrid systems with our 
refinement and verification components.›</span></span>

<span class="keyword1"><span class="command">theory</span></span> HS_VC_KAT_Examples_ndfun
  <span class="keyword2"><span class="keyword">imports</span></span> 
    <a href="HS_VC_KAT_ndfun.html">HS_VC_KAT_ndfun</a>
    <span class="quoted">"<a href="../../HOL/HOL-Eisbach/Eisbach.html">HOL-Eisbach.Eisbach</a>"</span>

<span class="keyword2"><span class="keyword">begin</span></span>

<span class="comment1">― ‹A tactic for verification of hybrid programs ›</span>

<span class="keyword1"><span class="command">named_theorems</span></span> hoare_intros

<span class="keyword1"><span class="command">declare</span></span> H_assignl <span class="main">[</span><span class="operator">hoare_intros</span><span class="main">]</span>
    <span class="keyword2"><span class="keyword">and</span></span> H_cond <span class="main">[</span><span class="operator">hoare_intros</span><span class="main">]</span>
    <span class="keyword2"><span class="keyword">and</span></span> local_flow.H_g_ode_subset <span class="main">[</span><span class="operator">hoare_intros</span><span class="main">]</span>
    <span class="keyword2"><span class="keyword">and</span></span> H_g_ode_inv <span class="main">[</span><span class="operator">hoare_intros</span><span class="main">]</span>

<span class="keyword1"><span class="command">method</span></span> body_hoare 
  <span class="main">=</span> <span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">hoare_intros</span></span><span class="main"><span class="keyword3">,</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">body_hoare</span><span class="main"><span class="keyword3">?</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">method</span></span> hyb_hoare <span class="keyword2"><span class="keyword">for</span></span> <span class="free">P</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> pred"</span></span> 
  <span class="main">=</span> <span class="main">(</span><span class="operator">rule</span> H_loopI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> H_seq<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> R<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">P</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">body_hoare</span><span class="main"><span class="keyword3">?</span></span><span class="main">)</span>

<span class="comment1">― ‹A tactic for refinement of hybrid programs ›</span>

<span class="keyword1"><span class="command">named_theorems</span></span> refine_intros <span class="quoted">"selected refinement lemmas"</span>

<span class="keyword1"><span class="command">declare</span></span> R_loopI <span class="main">[</span><span class="operator">refine_intros</span><span class="main">]</span>
    <span class="keyword2"><span class="keyword">and</span></span> R_loop_mono <span class="main">[</span><span class="operator">refine_intros</span><span class="main">]</span>
    <span class="keyword2"><span class="keyword">and</span></span> R_cond_law <span class="main">[</span><span class="operator">refine_intros</span><span class="main">]</span>
    <span class="keyword2"><span class="keyword">and</span></span> R_cond_mono <span class="main">[</span><span class="operator">refine_intros</span><span class="main">]</span>
    <span class="keyword2"><span class="keyword">and</span></span> R_while_law <span class="main">[</span><span class="operator">refine_intros</span><span class="main">]</span>
    <span class="keyword2"><span class="keyword">and</span></span> R_assignl <span class="main">[</span><span class="operator">refine_intros</span><span class="main">]</span>
    <span class="keyword2"><span class="keyword">and</span></span> R_seq_law <span class="main">[</span><span class="operator">refine_intros</span><span class="main">]</span>
    <span class="keyword2"><span class="keyword">and</span></span> R_seq_mono <span class="main">[</span><span class="operator">refine_intros</span><span class="main">]</span>
    <span class="keyword2"><span class="keyword">and</span></span> R_g_evol_law <span class="main">[</span><span class="operator">refine_intros</span><span class="main">]</span>
    <span class="keyword2"><span class="keyword">and</span></span> R_skip <span class="main">[</span><span class="operator">refine_intros</span><span class="main">]</span>
    <span class="keyword2"><span class="keyword">and</span></span> R_g_ode_inv <span class="main">[</span><span class="operator">refine_intros</span><span class="main">]</span>

<span class="keyword1"><span class="command">method</span></span> refinement
  <span class="main">=</span> <span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">refine_intros</span></span><span class="main"><span class="keyword3">;</span></span> <span class="main">(</span><span class="operator">refinement</span><span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Pendulum›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ The ODEs <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"x' t = y t"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and {text "y' t = - x t"} describe the circular motion of 
a mass attached to a string looked from above. We use <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"s$1"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> to represent the x-coordinate
and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"s$2"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> for the y-coordinate. We prove that this motion remains circular. ›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">fpend</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real<span class="main">^</span><span class="numeral">2</span> <span class="main">⇒</span> real<span class="main">^</span><span class="numeral">2</span>"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">f</span>"</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">f</span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="keyword1">χ</span> <span class="bound">i</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">i</span><span class="main">=</span><span class="main">1</span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="numeral">2</span> <span class="keyword1">else</span> <span class="main">-</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="main">1</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">pend_flow</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real <span class="main">⇒</span> real<span class="main">^</span><span class="numeral">2</span> <span class="main">⇒</span> real<span class="main">^</span><span class="numeral">2</span>"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">φ</span>"</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">φ</span></span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="keyword1">χ</span> <span class="bound">i</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">i</span> <span class="main">=</span> <span class="main">1</span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="main">1</span> <span class="main">⋅</span> cos <span class="free"><span class="bound"><span class="entity">τ</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="numeral">2</span> <span class="main">⋅</span> sin <span class="free"><span class="bound"><span class="entity">τ</span></span></span> 
  <span class="keyword1">else</span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="main">1</span> <span class="main">⋅</span> sin <span class="free"><span class="bound"><span class="entity">τ</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="numeral">2</span> <span class="main">⋅</span> cos <span class="free"><span class="bound"><span class="entity">τ</span></span></span><span class="main">)</span>"</span></span>

<span class="comment1">― ‹Verified with annotated dynamics ›</span>

<span class="keyword1"><span class="command">lemma</span></span> pendulum_dyn<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>{</b></span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">=</span> <span class="main">(</span><span class="bound">s</span> <span class="main">$</span> <span class="main">1</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">+</span> <span class="main">(</span><span class="bound">s</span> <span class="main">$</span> <span class="numeral">2</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="keyword1">EVOL</span> <span class="keyword1">φ</span> <span class="free">G</span> <span class="free">T</span> <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">=</span> <span class="main">(</span><span class="bound">s</span> <span class="main">$</span> <span class="main">1</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">+</span> <span class="main">(</span><span class="bound">s</span> <span class="main">$</span> <span class="numeral">2</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main"><span class="hidden">❙</span><b>}</b></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="comment1">― ‹Verified with differential invariants ›</span>

<span class="keyword1"><span class="command">lemma</span></span> pendulum_inv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>{</b></span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">=</span> <span class="main">(</span><span class="bound">s</span> <span class="main">$</span> <span class="main">1</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">+</span> <span class="main">(</span><span class="bound">s</span> <span class="main">$</span> <span class="numeral">2</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="main">(</span><span class="keyword1">x´=</span><span class="keyword1">f</span> <span class="main">&amp;</span> <span class="free">G</span><span class="main">)</span> <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">=</span> <span class="main">(</span><span class="bound">s</span> <span class="main">$</span> <span class="main">1</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">+</span> <span class="main">(</span><span class="bound">s</span> <span class="main">$</span> <span class="numeral">2</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main"><span class="hidden">❙</span><b>}</b></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">diff_invariant_rules</span></span> <span class="dynamic"><span class="dynamic">poly_derivatives</span></span><span class="main">)</span>

<span class="comment1">― ‹Verified with the flow ›</span>

<span class="keyword1"><span class="command">lemma</span></span> local_flow_pend<span class="main">:</span> <span class="quoted"><span class="quoted">"local_flow <span class="keyword1">f</span> UNIV UNIV <span class="keyword1">φ</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> local_lipschitz_def lipschitz_on_def vec_eq_iff<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="main">1</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dist_norm norm_vec_def L2_set_def power2_commute UNIV_2<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> forall_2 <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">poly_derivatives</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> pendulum_flow<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>{</b></span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">=</span> <span class="main">(</span><span class="bound">s</span> <span class="main">$</span> <span class="main">1</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">+</span> <span class="main">(</span><span class="bound">s</span> <span class="main">$</span> <span class="numeral">2</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main"><span class="hidden">❙</span><b>}</b></span> <span class="main">(</span><span class="keyword1">x´=</span><span class="keyword1">f</span> <span class="main">&amp;</span> <span class="free">G</span><span class="main">)</span> <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">=</span> <span class="main">(</span><span class="bound">s</span> <span class="main">$</span> <span class="main">1</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">+</span> <span class="main">(</span><span class="bound">s</span> <span class="main">$</span> <span class="numeral">2</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main"><span class="hidden">❙</span><b>}</b></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> local_flow.sH_g_ode_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> local_flow_pend<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>

<span class="keyword1"><span class="command">no_notation</span></span> fpend <span class="main">(</span><span class="quoted">"<span class="keyword1">f</span>"</span><span class="main">)</span>
        <span class="keyword2"><span class="keyword">and</span></span> pend_flow <span class="main">(</span><span class="quoted">"<span class="keyword1">φ</span>"</span><span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹ Bouncing Ball ›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ A ball is dropped from rest at an initial height <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"h"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. The motion is described with
the free-fall equations <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"x' t = v t"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"v' t = g"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> where <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"g"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is the
constant acceleration due to gravity. The bounce is modelled with a variable assignment that
flips the velocity. That is, we model it as a completely elastic collision with the ground. We use 
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"s$1"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> to represent the ball's height and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"s$2"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> for its velocity. We prove that the 
ball remains above ground and below its initial resting position. ›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">fball</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real <span class="main">⇒</span> real<span class="main">^</span><span class="numeral">2</span> <span class="main">⇒</span> real<span class="main">^</span><span class="numeral">2</span>"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">f</span>"</span><span class="main">)</span> 
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">f</span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="keyword1">χ</span> <span class="bound">i</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">i</span><span class="main">=</span><span class="main">1</span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="numeral">2</span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">ball_flow</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real <span class="main">⇒</span> real <span class="main">⇒</span> real<span class="main">^</span><span class="numeral">2</span> <span class="main">⇒</span> real<span class="main">^</span><span class="numeral">2</span>"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">φ</span>"</span><span class="main">)</span> 
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">φ</span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="keyword1">χ</span> <span class="bound">i</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">i</span><span class="main">=</span><span class="main">1</span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">⋅</span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span> <span class="main">^</span> <span class="numeral">2</span><span class="main">/</span><span class="numeral">2</span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="numeral">2</span> <span class="main">⋅</span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="main">1</span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">⋅</span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="numeral">2</span><span class="main">)</span>"</span></span>

<span class="comment1">― ‹Verified with differential invariants ›</span>

<span class="keyword1"><span class="command">named_theorems</span></span> bb_real_arith <span class="quoted">"real arithmetic properties for the bouncing ball."</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">bb_real_arith</span><span class="main">]</span><span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&gt;</span> <span class="free">g</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">⋅</span> <span class="free">g</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">-</span> <span class="numeral">2</span> <span class="main">⋅</span> <span class="free">g</span> <span class="main">⋅</span> <span class="free">h</span> <span class="main">=</span> <span class="free">v</span> <span class="main">⋅</span> <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">::</span>real<span class="main">)</span> <span class="main">≤</span> <span class="free">h</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">⋅</span> <span class="free">v</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">⋅</span> <span class="free">g</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">-</span> <span class="numeral">2</span> <span class="main">⋅</span> <span class="free">g</span> <span class="main">⋅</span> <span class="free">h</span> <span class="main">∧</span> <span class="main">0</span> <span class="main">&gt;</span> <span class="free">g</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> inv <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&gt;</span> <span class="free">g</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> obs<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">⋅</span> <span class="free">v</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">⋅</span> <span class="free">g</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">x</span> <span class="main">-</span> <span class="free">h</span><span class="main">)</span> <span class="main">∧</span> <span class="main">0</span> <span class="main">&gt;</span> <span class="free">g</span> <span class="main">∧</span> <span class="free">v</span> <span class="main">⋅</span> <span class="free">v</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> left_diff_distrib mult.commute <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> zero_le_square<span class="main">)</span> 
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">v</span> <span class="main">⋅</span> <span class="free">v</span><span class="main">)</span><span class="main">/</span><span class="main">(</span><span class="numeral">2</span> <span class="main">⋅</span> <span class="free">g</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span> <span class="main">-</span> <span class="free">h</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> obs <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">v</span> <span class="main">⋅</span> <span class="free">v</span><span class="main">)</span><span class="main">/</span><span class="main">(</span><span class="numeral">2</span> <span class="main">⋅</span> <span class="free">g</span><span class="main">)</span> <span class="main">≤</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> divide_nonneg_neg <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> 
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">-</span> <span class="free">x</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> fball_invariant<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">g</span> <span class="free">h</span> <span class="main">::</span> <span class="quoted">real</span>
  <span class="keyword2"><span class="keyword">defines</span></span> dinv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">≡</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="numeral">2</span> <span class="main">⋅</span> <span class="free">g</span> <span class="main">⋅</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">-</span> <span class="numeral">2</span> <span class="main">⋅</span> <span class="free">g</span> <span class="main">⋅</span> <span class="free">h</span> <span class="main">-</span> <span class="main">(</span><span class="bound">s</span><span class="main">$</span><span class="numeral">2</span> <span class="main">⋅</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"diff_invariant <span class="free">I</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="keyword1">f</span> <span class="free">g</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> UNIV<span class="main">)</span> UNIV <span class="main">0</span> <span class="free">G</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> dinv <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">diff_invariant_rules</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">poly_derivatives</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> bouncing_ball_inv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free">h</span> <span class="main">≥</span> <span class="main">0</span> <span class="main">⟹</span> 
  <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">=</span> <span class="free">h</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span> <span class="main">=</span> <span class="main">0</span><span class="main"><span class="hidden">❙</span><b>}</b></span>
  <span class="main">(</span><span class="keyword1">LOOP</span> 
      <span class="main">(</span><span class="main">(</span><span class="keyword1">x´=</span> <span class="keyword1">f</span> <span class="free">g</span> <span class="main">&amp;</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">≥</span> <span class="main">0</span><span class="main">)</span> <span class="keyword1">DINV</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="numeral">2</span> <span class="main">⋅</span> <span class="free">g</span> <span class="main">⋅</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">-</span> <span class="numeral">2</span> <span class="main">⋅</span> <span class="free">g</span> <span class="main">⋅</span> <span class="free">h</span> <span class="main">-</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span> <span class="main">⋅</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
       <span class="main">(</span><span class="keyword1">IF</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="keyword1">THEN</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">::=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">-</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">ELSE</span> skip<span class="main">)</span><span class="main">)</span> 
    <span class="keyword1">INV</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">∧</span> <span class="numeral">2</span> <span class="main">⋅</span> <span class="free">g</span> <span class="main">⋅</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">⋅</span> <span class="free">g</span> <span class="main">⋅</span> <span class="free">h</span> <span class="main">+</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span> <span class="main">⋅</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span><span class="main">)</span>
  <span class="main">)</span> <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">≤</span> <span class="free">h</span><span class="main"><span class="hidden">❙</span><b>}</b></span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">hyb_hoare</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">s</span><span class="main">::</span>real<span class="main">^</span><span class="numeral">2</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">∧</span> <span class="numeral">2</span> <span class="main">⋅</span> <span class="free">g</span> <span class="main">⋅</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">⋅</span> <span class="free">g</span> <span class="main">⋅</span> <span class="free">h</span> <span class="main">+</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span> <span class="main">⋅</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> fball_invariant <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">bb_real_arith</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">poly_derivatives</span></span> <span class="dynamic"><span class="dynamic">diff_invariant_rules</span></span><span class="main">)</span>

<span class="comment1">― ‹Verified with annotated dynamics ›</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">bb_real_arith</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> invar<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">⋅</span> <span class="free">g</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">⋅</span> <span class="free">g</span> <span class="main">⋅</span> <span class="free">h</span> <span class="main">+</span> <span class="free">v</span> <span class="main">⋅</span> <span class="free">v</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> pos<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">⋅</span> <span class="free">τ</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">+</span> <span class="free">v</span> <span class="main">⋅</span> <span class="free">τ</span> <span class="main">+</span> <span class="main">(</span><span class="free">x</span><span class="main">::</span>real<span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">⋅</span> <span class="free">g</span> <span class="main">⋅</span> <span class="free">h</span> <span class="main">+</span> <span class="main">(</span><span class="main">-</span> <span class="main">(</span><span class="free">g</span> <span class="main">⋅</span> <span class="free">τ</span><span class="main">)</span> <span class="main">-</span> <span class="free">v</span><span class="main">)</span> <span class="main">⋅</span> <span class="main">(</span><span class="main">-</span> <span class="main">(</span><span class="free">g</span> <span class="main">⋅</span> <span class="free">τ</span><span class="main">)</span> <span class="main">-</span> <span class="free">v</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">⋅</span> <span class="free">g</span> <span class="main">⋅</span> <span class="free">h</span> <span class="main">+</span> <span class="main">(</span><span class="free">g</span> <span class="main">⋅</span> <span class="free">τ</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">g</span> <span class="main">⋅</span> <span class="free">τ</span> <span class="main">+</span> <span class="free">v</span><span class="main">)</span> <span class="main">+</span> <span class="free">v</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">g</span> <span class="main">⋅</span> <span class="free">τ</span> <span class="main">+</span> <span class="free">v</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> pos <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">⋅</span> <span class="free">τ</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span>  <span class="main">+</span> <span class="numeral">2</span> <span class="main">⋅</span> <span class="free">v</span> <span class="main">⋅</span> <span class="free">τ</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span>  <span class="main">⋅</span> <span class="free">τ</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span>  <span class="main">+</span> <span class="numeral">2</span> <span class="main">⋅</span> <span class="free">g</span> <span class="main">⋅</span> <span class="free">v</span> <span class="main">⋅</span> <span class="free">τ</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">⋅</span> <span class="free">g</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> Groups.mult_ac<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>3<span class="main"><span class="main">)</span></span> mult_zero_right
        monoid_mult_class.power2_eq_square semiring_class.distrib_left<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">⋅</span> <span class="free">τ</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">⋅</span> <span class="free">g</span> <span class="main">⋅</span> <span class="free">v</span> <span class="main">⋅</span> <span class="free">τ</span> <span class="main">+</span> <span class="free">v</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">⋅</span> <span class="free">g</span> <span class="main">⋅</span> <span class="free">h</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> invar <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> monoid_mult_class.power2_eq_square<span class="main">)</span> 
  <span class="keyword1"><span class="command">hence</span></span> obs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">g</span> <span class="main">⋅</span> <span class="free">τ</span> <span class="main">+</span> <span class="free">v</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">⋅</span> <span class="free">g</span> <span class="main">⋅</span> <span class="free">h</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> power2_sum<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> Groups.add_ac<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">,</span></span> 3<span class="main"><span class="main">)</span></span> 
        Groups.mult_ac<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">,</span></span> 3<span class="main"><span class="main">)</span></span> monoid_mult_class.power2_eq_square nat_distrib<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">⋅</span> <span class="free">g</span> <span class="main">⋅</span> <span class="free">h</span> <span class="main">+</span> <span class="main">(</span><span class="free">g</span> <span class="main">⋅</span> <span class="free">τ</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">g</span> <span class="main">⋅</span> <span class="free">τ</span> <span class="main">+</span> <span class="free">v</span><span class="main">)</span> <span class="main">+</span> <span class="free">v</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">g</span> <span class="main">⋅</span> <span class="free">τ</span> <span class="main">+</span> <span class="free">v</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> monoid_mult_class.power2_eq_square<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span>  <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">⋅</span> <span class="free">g</span> <span class="main">⋅</span> <span class="free">h</span> <span class="main">+</span> <span class="main">(</span><span class="main">-</span> <span class="main">(</span><span class="main">(</span><span class="free">g</span> <span class="main">⋅</span> <span class="free">τ</span><span class="main">)</span> <span class="main">+</span> <span class="free">v</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> obs <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Groups.add_ac<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> power2_minus<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">⋅</span> <span class="free">g</span> <span class="main">⋅</span> <span class="free">h</span> <span class="main">+</span> <span class="main">(</span><span class="main">-</span> <span class="main">(</span><span class="free">g</span> <span class="main">⋅</span> <span class="free">τ</span><span class="main">)</span> <span class="main">-</span> <span class="free">v</span><span class="main">)</span> <span class="main">⋅</span> <span class="main">(</span><span class="main">-</span> <span class="main">(</span><span class="free">g</span> <span class="main">⋅</span> <span class="free">τ</span><span class="main">)</span> <span class="main">-</span> <span class="free">v</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> monoid_mult_class.power2_eq_square<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">bb_real_arith</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> invar<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">⋅</span> <span class="free">g</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">⋅</span> <span class="free">g</span> <span class="main">⋅</span> <span class="free">h</span> <span class="main">+</span> <span class="free">v</span> <span class="main">⋅</span> <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">⋅</span> <span class="free">g</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">g</span> <span class="main">⋅</span> <span class="free">τ</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">+</span> <span class="free">v</span> <span class="main">⋅</span> <span class="free">τ</span> <span class="main">+</span> <span class="main">(</span><span class="free">x</span><span class="main">::</span>real<span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
  <span class="numeral">2</span> <span class="main">⋅</span> <span class="free">g</span> <span class="main">⋅</span> <span class="free">h</span> <span class="main">+</span> <span class="main">(</span><span class="free">g</span> <span class="main">⋅</span> <span class="free">τ</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">g</span> <span class="main">⋅</span> <span class="free">τ</span> <span class="main">+</span> <span class="free">v</span><span class="main">)</span> <span class="main">+</span> <span class="free">v</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">g</span> <span class="main">⋅</span> <span class="free">τ</span> <span class="main">+</span> <span class="free">v</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="free">g</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">⋅</span> <span class="free">τ</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">⋅</span> <span class="free">g</span> <span class="main">⋅</span> <span class="free">v</span> <span class="main">⋅</span> <span class="free">τ</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">⋅</span> <span class="free">g</span> <span class="main">⋅</span> <span class="free">x</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span> semiring_normalization_rules<span class="main"><span class="main">(</span></span>29<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="free">g</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">⋅</span> <span class="free">τ</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">⋅</span> <span class="free">g</span> <span class="main">⋅</span> <span class="free">v</span> <span class="main">⋅</span> <span class="free">τ</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">⋅</span> <span class="free">g</span> <span class="main">⋅</span> <span class="free">h</span> <span class="main">+</span> <span class="free">v</span> <span class="main">⋅</span> <span class="free">v</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="var">?middle</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">subst</span> invar<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?middle</span>"</span></span><span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> 
  <span class="keyword1"><span class="command">{</span></span><span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?rhs</span> <span class="main">=</span> <span class="free">g</span> <span class="main">⋅</span> <span class="free">g</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">τ</span> <span class="main">⋅</span> <span class="free">τ</span><span class="main">)</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">⋅</span> <span class="free">g</span> <span class="main">⋅</span> <span class="free">v</span> <span class="main">⋅</span> <span class="free">τ</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">⋅</span> <span class="free">g</span> <span class="main">⋅</span> <span class="free">h</span> <span class="main">+</span> <span class="free">v</span> <span class="main">⋅</span> <span class="free">v</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Groups.mult_ac<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">,</span></span>3<span class="main"><span class="main">)</span></span> semiring_class.distrib_left<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="var">?middle</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> semiring_normalization_rules<span class="main"><span class="main">(</span></span>29<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?rhs</span> <span class="main">=</span> <span class="var">?middle</span>"</span></span><span class="keyword1"><span class="command">.</span></span><span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> bouncing_ball_dyn<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free">h</span> <span class="main">≥</span> <span class="main">0</span> <span class="main">⟹</span>
  <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">=</span> <span class="free">h</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span> <span class="main">=</span> <span class="main">0</span><span class="main"><span class="hidden">❙</span><b>}</b></span>
  <span class="main">(</span><span class="keyword1">LOOP</span> 
      <span class="main">(</span><span class="main">(</span><span class="keyword1">EVOL</span> <span class="main">(</span><span class="keyword1">φ</span> <span class="free">g</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">≥</span> <span class="main">0</span><span class="main">)</span> <span class="free">T</span><span class="main">)</span><span class="main">;</span>
       <span class="main">(</span><span class="keyword1">IF</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="keyword1">THEN</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">::=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">-</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">ELSE</span> skip<span class="main">)</span><span class="main">)</span> 
    <span class="keyword1">INV</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">∧</span> <span class="numeral">2</span> <span class="main">⋅</span> <span class="free">g</span> <span class="main">⋅</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">⋅</span> <span class="free">g</span> <span class="main">⋅</span> <span class="free">h</span> <span class="main">+</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span> <span class="main">⋅</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span><span class="main">)</span>
  <span class="main">)</span> <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">≤</span> <span class="free">h</span><span class="main"><span class="hidden">❙</span><b>}</b></span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">hyb_hoare</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">s</span><span class="main">::</span>real<span class="main">^</span><span class="numeral">2</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">∧</span> <span class="numeral">2</span> <span class="main">⋅</span> <span class="free">g</span> <span class="main">⋅</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">⋅</span> <span class="free">g</span> <span class="main">⋅</span> <span class="free">h</span> <span class="main">+</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span> <span class="main">⋅</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">bb_real_arith</span></span><span class="main">)</span>

<span class="comment1">― ‹Verified with the flow ›</span>

<span class="keyword1"><span class="command">lemma</span></span> local_flow_ball<span class="main">:</span> <span class="quoted"><span class="quoted">"local_flow <span class="main">(</span><span class="keyword1">f</span> <span class="free">g</span><span class="main">)</span> UNIV UNIV <span class="main">(</span><span class="keyword1">φ</span> <span class="free">g</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> local_lipschitz_def lipschitz_on_def vec_eq_iff<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">1</span><span class="main">/</span><span class="numeral">2</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="main">1</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dist_norm norm_vec_def L2_set_def UNIV_2<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> forall_2 <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">poly_derivatives</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> bouncing_ball_flow<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free">h</span> <span class="main">≥</span> <span class="main">0</span> <span class="main">⟹</span>
  <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">=</span> <span class="free">h</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span> <span class="main">=</span> <span class="main">0</span><span class="main"><span class="hidden">❙</span><b>}</b></span>
  <span class="main">(</span><span class="keyword1">LOOP</span> 
      <span class="main">(</span><span class="main">(</span><span class="keyword1">x´=</span> <span class="keyword1">f</span> <span class="free">g</span> <span class="main">&amp;</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">≥</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
       <span class="main">(</span><span class="keyword1">IF</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="keyword1">THEN</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">::=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">-</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">ELSE</span> skip<span class="main">)</span><span class="main">)</span> 
    <span class="keyword1">INV</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">∧</span> <span class="numeral">2</span> <span class="main">⋅</span> <span class="free">g</span> <span class="main">⋅</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">⋅</span> <span class="free">g</span> <span class="main">⋅</span> <span class="free">h</span> <span class="main">+</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span> <span class="main">⋅</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span><span class="main">)</span>
  <span class="main">)</span> <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">≤</span> <span class="free">h</span><span class="main"><span class="hidden">❙</span><b>}</b></span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> H_loopI<span class="main"><span class="keyword3">;</span></span> <span class="main">(</span><span class="operator">rule</span> H_seq<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> R<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">∧</span> <span class="numeral">2</span> <span class="main">⋅</span> <span class="free">g</span> <span class="main">⋅</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">⋅</span> <span class="free">g</span> <span class="main">⋅</span> <span class="free">h</span> <span class="main">+</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span> <span class="main">⋅</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> local_flow.sH_g_ode_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> local_flow_ball<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">bb_real_arith</span></span><span class="main">)</span>

<span class="comment1">― ‹Refined with annotated dynamics ›</span>

<span class="keyword1"><span class="command">lemma</span></span> R_bb_assign<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">&lt;</span> <span class="main">(</span><span class="main">0</span><span class="main">::</span>real<span class="main">)</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">≤</span> <span class="free">h</span> <span class="main">⟹</span> 
  <span class="numeral">2</span> <span class="main">::=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">-</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span><span class="main">)</span> <span class="main">≤</span> Ref 
    <span class="main">⌈</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> <span class="main">0</span> <span class="main">≤</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">∧</span> <span class="numeral">2</span> <span class="main">⋅</span> <span class="free">g</span> <span class="main">⋅</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">⋅</span> <span class="free">g</span> <span class="main">⋅</span> <span class="free">h</span> <span class="main">+</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span> <span class="main">⋅</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span><span class="main">⌉</span> 
    <span class="main">⌈</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">∧</span> <span class="numeral">2</span> <span class="main">⋅</span> <span class="free">g</span> <span class="main">⋅</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">⋅</span> <span class="free">g</span> <span class="main">⋅</span> <span class="free">h</span> <span class="main">+</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span> <span class="main">⋅</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span><span class="main">⌉</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> R_assign_law<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> R_bouncing_ball_dyn<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Ref <span class="main">⌈</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">=</span> <span class="free">h</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span> <span class="main">=</span> <span class="main">0</span><span class="main">⌉</span> <span class="main">⌈</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">≤</span> <span class="free">h</span><span class="main">⌉</span> <span class="main">≥</span> 
  <span class="main">(</span><span class="keyword1">LOOP</span> 
      <span class="main">(</span><span class="main">(</span><span class="keyword1">EVOL</span> <span class="main">(</span><span class="keyword1">φ</span> <span class="free">g</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">≥</span> <span class="main">0</span><span class="main">)</span> <span class="free">T</span><span class="main">)</span><span class="main">;</span>
       <span class="main">(</span><span class="keyword1">IF</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="keyword1">THEN</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">::=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">-</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">ELSE</span> skip<span class="main">)</span><span class="main">)</span> 
    <span class="keyword1">INV</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">∧</span> <span class="numeral">2</span> <span class="main">⋅</span> <span class="free">g</span> <span class="main">⋅</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">⋅</span> <span class="free">g</span> <span class="main">⋅</span> <span class="free">h</span> <span class="main">+</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span> <span class="main">⋅</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">refinement</span><span class="main"><span class="keyword3">;</span></span> <span class="main">(</span><span class="operator">rule</span> R_bb_assign<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">bb_real_arith</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">no_notation</span></span> fball <span class="main">(</span><span class="quoted">"<span class="keyword1">f</span>"</span><span class="main">)</span>
        <span class="keyword2"><span class="keyword">and</span></span> ball_flow <span class="main">(</span><span class="quoted">"<span class="keyword1">φ</span>"</span><span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹ Thermostat ›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ A thermostat has a chronometer, a thermometer and a switch to turn on and off a heater.
At most every <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"t"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> minutes, it sets its chronometer to <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">0</span></span><span class="main"><span class="main">::</span></span>real"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, it registers
the room temperature, and it turns the heater on (or off) based on this reading. The temperature
follows the ODE <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"T' = - a * (T - U)"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> where <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"U"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"L ≥ 0"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> when the heater
is on, and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"0"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> when it is off. We use <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">1</span></span><span class="main"><span class="main">::</span></span><span class="numeral"><span class="numeral">4</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> to denote the room's temperature,
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="numeral"><span class="numeral">2</span></span><span class="main"><span class="main">::</span></span><span class="numeral"><span class="numeral">4</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is time as measured by the thermostat's chronometer, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="numeral"><span class="numeral">3</span></span><span class="main"><span class="main">::</span></span><span class="numeral"><span class="numeral">4</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is the
temperature detected by the thermometer, and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="numeral"><span class="numeral">4</span></span><span class="main"><span class="main">::</span></span><span class="numeral"><span class="numeral">4</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> states whether the heater is on
(<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"s$4 = 1"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>) or off (<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"s$4 = 0"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>). We prove that the thermostat keeps the room's
temperature between <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"Tmin"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"Tmax"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. ›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">therm_vec_field</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real <span class="main">⇒</span> real <span class="main">⇒</span> real<span class="main">^</span><span class="numeral">4</span> <span class="main">⇒</span> real<span class="main">^</span><span class="numeral">4</span>"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">f</span>"</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">f</span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="keyword1">χ</span> <span class="bound">i</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">i</span> <span class="main">=</span> <span class="numeral">2</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">i</span> <span class="main">=</span> <span class="main">1</span> <span class="keyword1">then</span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">*</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="main">1</span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">L</span></span></span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">therm_guard</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real <span class="main">⇒</span> real <span class="main">⇒</span> real <span class="main">⇒</span> real <span class="main">⇒</span> real<span class="main">^</span><span class="numeral">4</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">G</span>"</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">G</span></span> <span class="free"><span class="bound"><span class="entity">Tmin</span></span></span> <span class="free"><span class="bound"><span class="entity">Tmax</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="numeral">2</span> <span class="main">≤</span> <span class="main">-</span> <span class="main">(</span>ln <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">L</span></span></span><span class="main">-</span><span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">L</span></span></span><span class="main">=</span><span class="main">0</span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">Tmin</span></span></span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">Tmax</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">/</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">L</span></span></span><span class="main">-</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="numeral">3</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">/</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">therm_loop_inv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real <span class="main">⇒</span> real <span class="main">⇒</span> real<span class="main">^</span><span class="numeral">4</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">I</span>"</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">I</span></span> <span class="free"><span class="bound"><span class="entity">Tmin</span></span></span> <span class="free"><span class="bound"><span class="entity">Tmax</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">Tmin</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="main">1</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="main">1</span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">Tmax</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="numeral">4</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="numeral">4</span> <span class="main">=</span> <span class="main">1</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">therm_flow</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real <span class="main">⇒</span> real <span class="main">⇒</span> real <span class="main">⇒</span> real<span class="main">^</span><span class="numeral">4</span> <span class="main">⇒</span> real<span class="main">^</span><span class="numeral">4</span>"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">φ</span>"</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">φ</span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="keyword1">χ</span> <span class="bound">i</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">i</span> <span class="main">=</span> <span class="main">1</span> <span class="keyword1">then</span> <span class="main">-</span> exp<span class="main">(</span><span class="main">-</span><span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">*</span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="keyword1">else</span> 
  <span class="main">(</span><span class="keyword1">if</span> <span class="bound">i</span> <span class="main">=</span> <span class="numeral">2</span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="numeral">2</span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="comment1">― ‹Verified with the flow ›</span>

<span class="keyword1"><span class="command">lemma</span></span> norm_diff_therm_dyn<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">a</span> <span class="main">⟹</span> <span class="main">∥</span><span class="keyword1">f</span> <span class="free">a</span> <span class="free">L</span> <span class="free">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">-</span> <span class="keyword1">f</span> <span class="free">a</span> <span class="free">L</span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub></span><span class="main">∥</span> <span class="main">=</span> <span class="main">¦</span><span class="free">a</span><span class="main">¦</span> <span class="main">*</span> <span class="main">¦</span><span class="free">s<span class="hidden">⇩</span><sub>1</sub></span><span class="main">$</span><span class="main">1</span> <span class="main">-</span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub></span><span class="main">$</span><span class="main">1</span><span class="main">¦</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> norm_vec_def L2_set_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> UNIV_4<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> a1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> f2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">r</span> <span class="bound">ra</span><span class="main">.</span> <span class="main">¦</span><span class="main">(</span><span class="bound">r</span><span class="main">::</span>real<span class="main">)</span> <span class="main">+</span> <span class="main">-</span> <span class="bound">ra</span><span class="main">¦</span> <span class="main">=</span> <span class="main">¦</span><span class="bound">ra</span> <span class="main">+</span> <span class="main">-</span> <span class="bound">r</span><span class="main">¦</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> abs_minus_commute minus_real_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">r</span> <span class="bound">ra</span> <span class="bound">rb</span><span class="main">.</span> <span class="main">(</span><span class="bound">r</span><span class="main">::</span>real<span class="main">)</span> <span class="main">*</span> <span class="bound">ra</span> <span class="main">+</span> <span class="main">-</span> <span class="main">(</span><span class="bound">r</span> <span class="main">*</span> <span class="bound">rb</span><span class="main">)</span> <span class="main">=</span> <span class="bound">r</span> <span class="main">*</span> <span class="main">(</span><span class="bound">ra</span> <span class="main">+</span> <span class="main">-</span> <span class="bound">rb</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> minus_real_def right_diff_distrib<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="free">a</span> <span class="main">*</span> <span class="main">(</span><span class="free">s<span class="hidden">⇩</span><sub>1</sub></span><span class="main">$</span><span class="main">1</span> <span class="main">+</span> <span class="main">-</span> <span class="free">L</span><span class="main">)</span> <span class="main">+</span> <span class="main">-</span> <span class="main">(</span><span class="free">a</span> <span class="main">*</span> <span class="main">(</span><span class="free">s<span class="hidden">⇩</span><sub>2</sub></span><span class="main">$</span><span class="main">1</span> <span class="main">+</span> <span class="main">-</span> <span class="free">L</span><span class="main">)</span><span class="main">)</span><span class="main">¦</span> <span class="main">=</span> <span class="free">a</span> <span class="main">*</span> <span class="main">¦</span><span class="free">s<span class="hidden">⇩</span><sub>1</sub></span><span class="main">$</span><span class="main">1</span> <span class="main">+</span> <span class="main">-</span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub></span><span class="main">$</span><span class="main">1</span><span class="main">¦</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> a1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> abs_mult<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="free">a</span> <span class="main">*</span> <span class="main">(</span><span class="free">s<span class="hidden">⇩</span><sub>2</sub></span><span class="main">$</span><span class="main">1</span> <span class="main">-</span> <span class="free">L</span><span class="main">)</span> <span class="main">-</span> <span class="free">a</span> <span class="main">*</span> <span class="main">(</span><span class="free">s<span class="hidden">⇩</span><sub>1</sub></span><span class="main">$</span><span class="main">1</span> <span class="main">-</span> <span class="free">L</span><span class="main">)</span><span class="main">¦</span> <span class="main">=</span> <span class="free">a</span> <span class="main">*</span> <span class="main">¦</span><span class="free">s<span class="hidden">⇩</span><sub>1</sub></span><span class="main">$</span><span class="main">1</span> <span class="main">-</span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub></span><span class="main">$</span><span class="main">1</span><span class="main">¦</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> f2 minus_real_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> local_lipschitz_therm_dyn<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="main">(</span><span class="free">a</span><span class="main">::</span>real<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"local_lipschitz UNIV UNIV <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">::</span>real<span class="main">.</span> <span class="keyword1">f</span> <span class="free">a</span> <span class="free">L</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">unfold</span> local_lipschitz_def lipschitz_on_def dist_norm<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="main">1</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">a</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> norm_diff_therm_dyn<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> norm_vec_def L2_set_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> UNIV_4<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> real_sqrt_abs<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> real_le_lsqrt<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> local_flow_therm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟹</span> local_flow <span class="main">(</span><span class="keyword1">f</span> <span class="free">a</span> <span class="free">L</span><span class="main">)</span> UNIV UNIV <span class="main">(</span><span class="keyword1">φ</span> <span class="free">a</span> <span class="free">L</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">poly_derivatives</span></span> local_lipschitz_therm_dyn 
      <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> forall_4 vec_eq_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> therm_dyn_down_real_arith<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> Thyps<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">Tmin</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">Tmin</span> <span class="main">≤</span> <span class="free">T</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">T</span> <span class="main">≤</span> <span class="free">Tmax</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> thyps<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="main">(</span><span class="free">τ</span><span class="main">::</span>real<span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">τ</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">τ</span><span class="main">}</span><span class="main">.</span> <span class="bound">τ</span> <span class="main">≤</span> <span class="main">-</span> <span class="main">(</span>ln <span class="main">(</span><span class="free">Tmin</span> <span class="main">/</span> <span class="free">T</span><span class="main">)</span> <span class="main">/</span> <span class="free">a</span><span class="main">)</span> "</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Tmin</span> <span class="main">≤</span> exp <span class="main">(</span><span class="main">-</span><span class="free">a</span> <span class="main">*</span> <span class="free">τ</span><span class="main">)</span> <span class="main">*</span> <span class="free">T</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"exp <span class="main">(</span><span class="main">-</span><span class="free">a</span> <span class="main">*</span> <span class="free">τ</span><span class="main">)</span> <span class="main">*</span> <span class="free">T</span> <span class="main">≤</span> <span class="free">Tmax</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">τ</span> <span class="main">∧</span> <span class="free">τ</span> <span class="main">≤</span> <span class="main">-</span> <span class="main">(</span>ln <span class="main">(</span><span class="free">Tmin</span> <span class="main">/</span> <span class="free">T</span><span class="main">)</span> <span class="main">/</span> <span class="free">a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> thyps <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"ln <span class="main">(</span><span class="free">Tmin</span> <span class="main">/</span> <span class="free">T</span><span class="main">)</span> <span class="main">≤</span> <span class="main">-</span> <span class="free">a</span> <span class="main">*</span> <span class="free">τ</span> <span class="main">∧</span> <span class="main">-</span> <span class="free">a</span> <span class="main">*</span> <span class="free">τ</span> <span class="main">≤</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> divide_le_cancel <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Tmin</span> <span class="main">/</span> <span class="free">T</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Thyps <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> obs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Tmin</span> <span class="main">/</span> <span class="free">T</span> <span class="main">≤</span> exp <span class="main">(</span><span class="main">-</span><span class="free">a</span> <span class="main">*</span> <span class="free">τ</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"exp <span class="main">(</span><span class="main">-</span><span class="free">a</span> <span class="main">*</span> <span class="free">τ</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> exp_ln exp_le_one_iff <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> exp_less_cancel_iff not_less<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">Tmin</span> <span class="main">≤</span> exp <span class="main">(</span><span class="main">-</span><span class="free">a</span> <span class="main">*</span> <span class="free">τ</span><span class="main">)</span> <span class="main">*</span> <span class="free">T</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Thyps <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pos_divide_le_eq<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"exp <span class="main">(</span><span class="main">-</span><span class="free">a</span> <span class="main">*</span> <span class="free">τ</span><span class="main">)</span> <span class="main">*</span> <span class="free">T</span> <span class="main">≤</span> <span class="free">Tmax</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Thyps mult_left_le_one_le<span class="main">[</span><span class="operator">OF</span> _ exp_ge_zero obs<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">T</span></span><span class="main">]</span> 
      less_eq_real_def order_trans_rules<span class="main">(</span>23<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> therm_dyn_up_real_arith<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> Thyps<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Tmin</span> <span class="main">≤</span> <span class="free">T</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">T</span> <span class="main">≤</span> <span class="free">Tmax</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">Tmax</span> <span class="main">&lt;</span> <span class="main">(</span><span class="free">L</span><span class="main">::</span>real<span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> thyps<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">τ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">τ</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">τ</span><span class="main">}</span><span class="main">.</span> <span class="bound">τ</span> <span class="main">≤</span> <span class="main">-</span> <span class="main">(</span>ln <span class="main">(</span><span class="main">(</span><span class="free">L</span> <span class="main">-</span> <span class="free">Tmax</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="free">L</span> <span class="main">-</span> <span class="free">T</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> <span class="free">a</span><span class="main">)</span> "</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">L</span> <span class="main">-</span> <span class="free">Tmax</span> <span class="main">≤</span> exp <span class="main">(</span><span class="main">-</span><span class="main">(</span><span class="free">a</span> <span class="main">*</span> <span class="free">τ</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">L</span> <span class="main">-</span> <span class="free">T</span><span class="main">)</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">L</span> <span class="main">-</span> exp <span class="main">(</span><span class="main">-</span><span class="main">(</span><span class="free">a</span> <span class="main">*</span> <span class="free">τ</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">L</span> <span class="main">-</span> <span class="free">T</span><span class="main">)</span> <span class="main">≤</span> <span class="free">Tmax</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">Tmin</span> <span class="main">≤</span> <span class="free">L</span> <span class="main">-</span> exp <span class="main">(</span><span class="main">-</span><span class="main">(</span><span class="free">a</span> <span class="main">*</span> <span class="free">τ</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">L</span> <span class="main">-</span> <span class="free">T</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">τ</span> <span class="main">∧</span> <span class="free">τ</span> <span class="main">≤</span> <span class="main">-</span> <span class="main">(</span>ln <span class="main">(</span><span class="main">(</span><span class="free">L</span> <span class="main">-</span> <span class="free">Tmax</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="free">L</span> <span class="main">-</span> <span class="free">T</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> <span class="free">a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> thyps <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"ln <span class="main">(</span><span class="main">(</span><span class="free">L</span> <span class="main">-</span> <span class="free">Tmax</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="free">L</span> <span class="main">-</span> <span class="free">T</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="main">-</span> <span class="free">a</span> <span class="main">*</span> <span class="free">τ</span> <span class="main">∧</span> <span class="main">-</span> <span class="free">a</span> <span class="main">*</span> <span class="free">τ</span> <span class="main">≤</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> divide_le_cancel <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">L</span> <span class="main">-</span> <span class="free">Tmax</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="free">L</span> <span class="main">-</span> <span class="free">T</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Thyps <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">L</span> <span class="main">-</span> <span class="free">Tmax</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="free">L</span> <span class="main">-</span> <span class="free">T</span><span class="main">)</span> <span class="main">≤</span> exp <span class="main">(</span><span class="main">-</span><span class="free">a</span> <span class="main">*</span> <span class="free">τ</span><span class="main">)</span> <span class="main">∧</span> exp <span class="main">(</span><span class="main">-</span><span class="free">a</span> <span class="main">*</span> <span class="free">τ</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> exp_ln exp_le_one_iff <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> exp_less_cancel_iff not_less<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">L</span> <span class="main">-</span> <span class="free">T</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Thyps <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> obs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">L</span> <span class="main">-</span> <span class="free">Tmax</span><span class="main">)</span> <span class="main">≤</span> exp <span class="main">(</span><span class="main">-</span><span class="free">a</span> <span class="main">*</span> <span class="free">τ</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">L</span> <span class="main">-</span> <span class="free">T</span><span class="main">)</span> <span class="main">∧</span> exp <span class="main">(</span><span class="main">-</span><span class="free">a</span> <span class="main">*</span> <span class="free">τ</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">L</span> <span class="main">-</span> <span class="free">T</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="free">L</span> <span class="main">-</span> <span class="free">T</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pos_divide_le_eq<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">L</span> <span class="main">-</span> <span class="free">Tmax</span><span class="main">)</span> <span class="main">≤</span> exp <span class="main">(</span><span class="main">-</span><span class="main">(</span><span class="free">a</span> <span class="main">*</span> <span class="free">τ</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">L</span> <span class="main">-</span> <span class="free">T</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">L</span> <span class="main">-</span> exp <span class="main">(</span><span class="main">-</span><span class="main">(</span><span class="free">a</span> <span class="main">*</span> <span class="free">τ</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">L</span> <span class="main">-</span> <span class="free">T</span><span class="main">)</span> <span class="main">≤</span> <span class="free">Tmax</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">Tmin</span> <span class="main">≤</span> <span class="free">L</span> <span class="main">-</span> exp <span class="main">(</span><span class="main">-</span><span class="main">(</span><span class="free">a</span> <span class="main">*</span> <span class="free">τ</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">L</span> <span class="main">-</span> <span class="free">T</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Thyps <span class="keyword2"><span class="keyword">and</span></span> obs <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> H_g_ode_therm <span class="main">=</span> local_flow.sH_g_ode_ivl<span class="main">[</span><span class="operator">OF</span> local_flow_therm _ UNIV_I<span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> thermostat_flow<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">a</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">τ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">Tmin</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">Tmax</span> <span class="main">&lt;</span> <span class="free">L</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>{</b></span><span class="keyword1">I</span> <span class="free">Tmin</span> <span class="free">Tmax</span><span class="main"><span class="hidden">❙</span><b>}</b></span>
  <span class="main">(</span><span class="keyword1">LOOP</span> <span class="main">(</span>
    <span class="comment1">― ‹control›</span>
    <span class="main">(</span><span class="numeral">2</span> <span class="main">::=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
    <span class="main">(</span><span class="numeral">3</span> <span class="main">::=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
    <span class="main">(</span><span class="keyword1">IF</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">4</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">3</span> <span class="main">≤</span> <span class="free">Tmin</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">THEN</span> 
      <span class="main">(</span><span class="numeral">4</span> <span class="main">::=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> 
     <span class="keyword1">ELSE</span> <span class="keyword1">IF</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">4</span> <span class="main">=</span> <span class="main">1</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">3</span> <span class="main">≥</span> <span class="free">Tmax</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">THEN</span> 
      <span class="main">(</span><span class="numeral">4</span> <span class="main">::=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span><span class="main">0</span><span class="main">)</span><span class="main">)</span> 
     <span class="keyword1">ELSE</span> skip<span class="main">)</span><span class="main">;</span>
    <span class="comment1">― ‹dynamics›</span>
    <span class="main">(</span><span class="keyword1">IF</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">4</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="keyword1">THEN</span> 
      <span class="main">(</span><span class="keyword1">x´=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="keyword1">f</span> <span class="free">a</span> <span class="main">0</span><span class="main">)</span> <span class="main">&amp;</span> <span class="keyword1">G</span> <span class="free">Tmin</span> <span class="free">Tmax</span> <span class="free">a</span> <span class="main">0</span> <span class="keyword1">on</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">τ</span><span class="main">}</span><span class="main">)</span> UNIV <span class="main">@</span> <span class="main">0</span><span class="main">)</span> 
    <span class="keyword1">ELSE</span> 
      <span class="main">(</span><span class="keyword1">x´=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="keyword1">f</span> <span class="free">a</span> <span class="free">L</span><span class="main">)</span> <span class="main">&amp;</span> <span class="keyword1">G</span> <span class="free">Tmin</span> <span class="free">Tmax</span> <span class="free">a</span> <span class="free">L</span> <span class="keyword1">on</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">τ</span><span class="main">}</span><span class="main">)</span> UNIV <span class="main">@</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>
  <span class="main">)</span> <span class="keyword1">INV</span> <span class="keyword1">I</span> <span class="free">Tmin</span> <span class="free">Tmax</span><span class="main">)</span>
   <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="keyword1">I</span> <span class="free">Tmin</span> <span class="free">Tmax</span><span class="main"><span class="hidden">❙</span><b>}</b></span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> H_loopI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="keyword1">I</span> <span class="free">Tmin</span> <span class="free">Tmax</span> <span class="bound">s</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span><span class="main">=</span><span class="main">0</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">3</span> <span class="main">=</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> H_seq<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="keyword1">I</span> <span class="free">Tmin</span> <span class="free">Tmax</span> <span class="bound">s</span><span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span><span class="main">=</span><span class="main">0</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">3</span> <span class="main">=</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> H_seq<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="keyword1">I</span> <span class="free">Tmin</span> <span class="free">Tmax</span> <span class="bound">s</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> H_seq<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> H_cond<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> H_g_ode_therm<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">,</span></span></span>2<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">using</span></span> therm_dyn_up_real_arith<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span>1<span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span> _ _ assms<span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span>4<span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">Tmin</span></span></span></span></span></span><span class="main">]</span>
    <span class="keyword2"><span class="keyword">and</span></span> therm_dyn_down_real_arith<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">,</span></span></span>3<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main">,</span> <span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">Tmax</span></span></span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="comment1">― ‹Refined with the flow ›</span>

<span class="keyword1"><span class="command">lemma</span></span> R_therm_dyn_down<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">τ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">Tmin</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">Tmax</span> <span class="main">&lt;</span> <span class="free">L</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Ref <span class="main">⌈</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">4</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> <span class="keyword1">I</span> <span class="free">Tmin</span> <span class="free">Tmax</span> <span class="bound">s</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">3</span> <span class="main">=</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span><span class="main">⌉</span> <span class="main">⌈</span><span class="keyword1">I</span> <span class="free">Tmin</span> <span class="free">Tmax</span><span class="main">⌉</span> <span class="main">≥</span> 
    <span class="main">(</span><span class="keyword1">x´=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="keyword1">f</span> <span class="free">a</span> <span class="main">0</span><span class="main">)</span> <span class="main">&amp;</span> <span class="keyword1">G</span> <span class="free">Tmin</span> <span class="free">Tmax</span> <span class="free">a</span> <span class="main">0</span> <span class="keyword1">on</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">τ</span><span class="main">}</span><span class="main">)</span> UNIV <span class="main">@</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> local_flow.R_g_ode_ivl<span class="main"><span class="main">[</span></span><span class="operator">OF</span> local_flow_therm<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> assms therm_dyn_down_real_arith<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">,</span></span></span>3<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main">,</span> <span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">Tmax</span></span></span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> R_therm_dyn_up<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">τ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">Tmin</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">Tmax</span> <span class="main">&lt;</span> <span class="free">L</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Ref <span class="main">⌈</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">4</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span> <span class="keyword1">I</span> <span class="free">Tmin</span> <span class="free">Tmax</span> <span class="bound">s</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">3</span> <span class="main">=</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span><span class="main">⌉</span> <span class="main">⌈</span><span class="keyword1">I</span> <span class="free">Tmin</span> <span class="free">Tmax</span><span class="main">⌉</span> <span class="main">≥</span> 
    <span class="main">(</span><span class="keyword1">x´=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="keyword1">f</span> <span class="free">a</span> <span class="free">L</span><span class="main">)</span> <span class="main">&amp;</span> <span class="keyword1">G</span> <span class="free">Tmin</span> <span class="free">Tmax</span> <span class="free">a</span> <span class="free">L</span> <span class="keyword1">on</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">τ</span><span class="main">}</span><span class="main">)</span> UNIV <span class="main">@</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> local_flow.R_g_ode_ivl<span class="main"><span class="main">[</span></span><span class="operator">OF</span> local_flow_therm<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> assms therm_dyn_up_real_arith<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span>1<span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span> _ _ assms<span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span>4<span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">Tmin</span></span></span></span></span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> R_therm_dyn<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">τ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">Tmin</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">Tmax</span> <span class="main">&lt;</span> <span class="free">L</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Ref <span class="main">⌈</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="keyword1">I</span> <span class="free">Tmin</span> <span class="free">Tmax</span> <span class="bound">s</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">3</span> <span class="main">=</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span><span class="main">⌉</span> <span class="main">⌈</span><span class="keyword1">I</span> <span class="free">Tmin</span> <span class="free">Tmax</span><span class="main">⌉</span> <span class="main">≥</span> 
  <span class="main">(</span><span class="keyword1">IF</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">4</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="keyword1">THEN</span> 
    <span class="main">(</span><span class="keyword1">x´=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="keyword1">f</span> <span class="free">a</span> <span class="main">0</span><span class="main">)</span> <span class="main">&amp;</span> <span class="keyword1">G</span> <span class="free">Tmin</span> <span class="free">Tmax</span> <span class="free">a</span> <span class="main">0</span> <span class="keyword1">on</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">τ</span><span class="main">}</span><span class="main">)</span> UNIV <span class="main">@</span> <span class="main">0</span><span class="main">)</span> 
  <span class="keyword1">ELSE</span> 
    <span class="main">(</span><span class="keyword1">x´=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="keyword1">f</span> <span class="free">a</span> <span class="free">L</span><span class="main">)</span> <span class="main">&amp;</span> <span class="keyword1">G</span> <span class="free">Tmin</span> <span class="free">Tmax</span> <span class="free">a</span> <span class="free">L</span> <span class="keyword1">on</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">τ</span><span class="main">}</span><span class="main">)</span> UNIV <span class="main">@</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> order_trans<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> R_cond_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> R_therm_dyn_down<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> R_therm_dyn_up<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> R_cond<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> R_therm_assign1<span class="main">:</span> <span class="quoted"><span class="quoted">"Ref <span class="main">⌈</span><span class="keyword1">I</span> <span class="free">Tmin</span> <span class="free">Tmax</span><span class="main">⌉</span> <span class="main">⌈</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="keyword1">I</span> <span class="free">Tmin</span> <span class="free">Tmax</span> <span class="bound">s</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span> <span class="main">=</span> <span class="main">0</span><span class="main">⌉</span> <span class="main">≥</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">::=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> R_assign_law<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> R_therm_assign2<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"Ref <span class="main">⌈</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="keyword1">I</span> <span class="free">Tmin</span> <span class="free">Tmax</span> <span class="bound">s</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span> <span class="main">=</span> <span class="main">0</span><span class="main">⌉</span> <span class="main">⌈</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="keyword1">I</span> <span class="free">Tmin</span> <span class="free">Tmax</span> <span class="bound">s</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">3</span> <span class="main">=</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span><span class="main">⌉</span> <span class="main">≥</span> <span class="main">(</span><span class="numeral">3</span> <span class="main">::=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> R_assign_law<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> R_therm_ctrl<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Ref <span class="main">⌈</span><span class="keyword1">I</span> <span class="free">Tmin</span> <span class="free">Tmax</span><span class="main">⌉</span> <span class="main">⌈</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="keyword1">I</span> <span class="free">Tmin</span> <span class="free">Tmax</span> <span class="bound">s</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">3</span> <span class="main">=</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span><span class="main">⌉</span> <span class="main">≥</span>
  <span class="main">(</span><span class="numeral">2</span> <span class="main">::=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
  <span class="main">(</span><span class="numeral">3</span> <span class="main">::=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
  <span class="main">(</span><span class="keyword1">IF</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">4</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">3</span> <span class="main">≤</span> <span class="free">Tmin</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">THEN</span> 
    <span class="main">(</span><span class="numeral">4</span> <span class="main">::=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> 
   <span class="keyword1">ELSE</span> <span class="keyword1">IF</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">4</span> <span class="main">=</span> <span class="main">1</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">3</span> <span class="main">≥</span> <span class="free">Tmax</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">THEN</span> 
    <span class="main">(</span><span class="numeral">4</span> <span class="main">::=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span><span class="main">0</span><span class="main">)</span><span class="main">)</span> 
   <span class="keyword1">ELSE</span> skip<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">refinement</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> R_therm_assign1<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> R_therm_assign2<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> R_assign_law<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> R_therm_loop<span class="main">:</span> <span class="quoted"><span class="quoted">"Ref <span class="main">⌈</span><span class="keyword1">I</span> <span class="free">Tmin</span> <span class="free">Tmax</span><span class="main">⌉</span> <span class="main">⌈</span><span class="keyword1">I</span> <span class="free">Tmin</span> <span class="free">Tmax</span><span class="main">⌉</span> <span class="main">≥</span> 
  <span class="main">(</span><span class="keyword1">LOOP</span> 
    Ref <span class="main">⌈</span><span class="keyword1">I</span> <span class="free">Tmin</span> <span class="free">Tmax</span><span class="main">⌉</span> <span class="main">⌈</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="keyword1">I</span> <span class="free">Tmin</span> <span class="free">Tmax</span> <span class="bound">s</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">3</span> <span class="main">=</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span><span class="main">⌉</span><span class="main">;</span>
    Ref <span class="main">⌈</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="keyword1">I</span> <span class="free">Tmin</span> <span class="free">Tmax</span> <span class="bound">s</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">3</span> <span class="main">=</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span><span class="main">⌉</span> <span class="main">⌈</span><span class="keyword1">I</span> <span class="free">Tmin</span> <span class="free">Tmax</span><span class="main">⌉</span>
  <span class="keyword1">INV</span> <span class="keyword1">I</span> <span class="free">Tmin</span> <span class="free">Tmax</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> R_loop R_seq<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> R_thermostat_flow<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">τ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">Tmin</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">Tmax</span> <span class="main">&lt;</span> <span class="free">L</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Ref <span class="main">⌈</span><span class="keyword1">I</span> <span class="free">Tmin</span> <span class="free">Tmax</span><span class="main">⌉</span> <span class="main">⌈</span><span class="keyword1">I</span> <span class="free">Tmin</span> <span class="free">Tmax</span><span class="main">⌉</span> <span class="main">≥</span> 
  <span class="main">(</span><span class="keyword1">LOOP</span> <span class="main">(</span>
    <span class="comment1">― ‹control›</span>
    <span class="main">(</span><span class="numeral">2</span> <span class="main">::=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">;</span><span class="main">(</span><span class="numeral">3</span> <span class="main">::=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
    <span class="main">(</span><span class="keyword1">IF</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">4</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">3</span> <span class="main">≤</span> <span class="free">Tmin</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">THEN</span> 
      <span class="main">(</span><span class="numeral">4</span> <span class="main">::=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> 
     <span class="keyword1">ELSE</span> <span class="keyword1">IF</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">4</span> <span class="main">=</span> <span class="main">1</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">3</span> <span class="main">≥</span> <span class="free">Tmax</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">THEN</span> 
      <span class="main">(</span><span class="numeral">4</span> <span class="main">::=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span><span class="main">0</span><span class="main">)</span><span class="main">)</span> 
     <span class="keyword1">ELSE</span> skip<span class="main">)</span><span class="main">;</span>
    <span class="comment1">― ‹dynamics›</span>
    <span class="main">(</span><span class="keyword1">IF</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">4</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="keyword1">THEN</span> 
      <span class="main">(</span><span class="keyword1">x´=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="keyword1">f</span> <span class="free">a</span> <span class="main">0</span><span class="main">)</span> <span class="main">&amp;</span> <span class="keyword1">G</span> <span class="free">Tmin</span> <span class="free">Tmax</span> <span class="free">a</span> <span class="main">0</span> <span class="keyword1">on</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">τ</span><span class="main">}</span><span class="main">)</span> UNIV <span class="main">@</span> <span class="main">0</span><span class="main">)</span> 
    <span class="keyword1">ELSE</span> 
      <span class="main">(</span><span class="keyword1">x´=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="keyword1">f</span> <span class="free">a</span> <span class="free">L</span><span class="main">)</span> <span class="main">&amp;</span> <span class="keyword1">G</span> <span class="free">Tmin</span> <span class="free">Tmax</span> <span class="free">a</span> <span class="free">L</span> <span class="keyword1">on</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">τ</span><span class="main">}</span><span class="main">)</span> UNIV <span class="main">@</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>
  <span class="main">)</span> <span class="keyword1">INV</span> <span class="keyword1">I</span> <span class="free">Tmin</span> <span class="free">Tmax</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> order_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ R_therm_loop<span class="main"><span class="main">]</span></span> R_loop_mono 
      R_seq_mono R_therm_ctrl R_therm_dyn<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">no_notation</span></span> therm_vec_field <span class="main">(</span><span class="quoted">"<span class="keyword1">f</span>"</span><span class="main">)</span>
        <span class="keyword2"><span class="keyword">and</span></span> therm_flow <span class="main">(</span><span class="quoted">"<span class="keyword1">φ</span>"</span><span class="main">)</span>
        <span class="keyword2"><span class="keyword">and</span></span> therm_guard <span class="main">(</span><span class="quoted">"<span class="keyword1">G</span>"</span><span class="main">)</span>
        <span class="keyword2"><span class="keyword">and</span></span> therm_loop_inv <span class="main">(</span><span class="quoted">"<span class="keyword1">I</span>"</span><span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹ Water tank ›</span></span> <span class="comment1">― ‹ Variation of Hespanha and Alur's tank ›</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹ Tank ›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ A controller turns a water pump on and off to keep the level of water <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"h"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> in a tank
within an acceptable range <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"hmin ≤ h ≤ hmax"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. Just like in the previous example, after 
each intervention, the controller registers the current level of water and resets its chronometer,
then it changes the status of the water pump accordingly. The level of water grows linearly 
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"h' = k"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> at a rate of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"k = c<span class="hidden">⇩</span><sub>i</sub>-c<span class="hidden">⇩</span><sub>o</sub>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> if the pump is on, and at a rate of 
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"k = -c<span class="hidden">⇩</span><sub>o</sub>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> if the pump is off. We use <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">1</span></span><span class="main"><span class="main">::</span></span><span class="numeral"><span class="numeral">4</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> to denote the tank's level of water,
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="numeral"><span class="numeral">2</span></span><span class="main"><span class="main">::</span></span><span class="numeral"><span class="numeral">4</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is time as measured by the controller's chronometer, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="numeral"><span class="numeral">3</span></span><span class="main"><span class="main">::</span></span><span class="numeral"><span class="numeral">4</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is the
level of water measured by the chronometer, and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="numeral"><span class="numeral">4</span></span><span class="main"><span class="main">::</span></span><span class="numeral"><span class="numeral">4</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> states whether the pump is on
(<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"s$4 = 1"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>) or off (<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"s$4 = 0"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>). We prove that the controller keeps the level of
water between <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"hmin"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"hmax"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. ›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">tank_vec_field</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real <span class="main">⇒</span> real<span class="main">^</span><span class="numeral">4</span> <span class="main">⇒</span> real<span class="main">^</span><span class="numeral">4</span>"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">f</span>"</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">f</span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="keyword1">χ</span> <span class="bound">i</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">i</span> <span class="main">=</span> <span class="numeral">2</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">i</span> <span class="main">=</span> <span class="main">1</span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">tank_flow</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real <span class="main">⇒</span> real <span class="main">⇒</span> real<span class="main">^</span><span class="numeral">4</span> <span class="main">⇒</span> real<span class="main">^</span><span class="numeral">4</span>"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">φ</span>"</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">φ</span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="keyword1">χ</span> <span class="bound">i</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">i</span> <span class="main">=</span> <span class="main">1</span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">*</span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="main">1</span> <span class="keyword1">else</span> 
  <span class="main">(</span><span class="keyword1">if</span> <span class="bound">i</span> <span class="main">=</span> <span class="numeral">2</span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="numeral">2</span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">tank_guard</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real <span class="main">⇒</span> real <span class="main">⇒</span> real<span class="main">^</span><span class="numeral">4</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">G</span>"</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">G</span></span> <span class="free"><span class="bound"><span class="entity">Hm</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="numeral">2</span> <span class="main">≤</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Hm</span></span></span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="numeral">3</span><span class="main">)</span><span class="main">/</span><span class="free"><span class="bound"><span class="entity">k</span></span></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">tank_loop_inv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real <span class="main">⇒</span> real <span class="main">⇒</span> real<span class="main">^</span><span class="numeral">4</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">I</span>"</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">I</span></span> <span class="free"><span class="bound"><span class="entity">hmin</span></span></span> <span class="free"><span class="bound"><span class="entity">hmax</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">hmin</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="main">1</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="main">1</span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">hmax</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="numeral">4</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="numeral">4</span> <span class="main">=</span> <span class="main">1</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">tank_diff_inv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real <span class="main">⇒</span> real <span class="main">⇒</span> real <span class="main">⇒</span> real<span class="main">^</span><span class="numeral">4</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">dI</span>"</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">dI</span></span> <span class="free"><span class="bound"><span class="entity">hmin</span></span></span> <span class="free"><span class="bound"><span class="entity">hmax</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="main">1</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">⋅</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="numeral">2</span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="numeral">3</span> <span class="main">∧</span> <span class="main">0</span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="numeral">2</span> <span class="main">∧</span> 
    <span class="free"><span class="bound"><span class="entity">hmin</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="numeral">3</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="numeral">3</span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">hmax</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="numeral">4</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="numeral">4</span> <span class="main">=</span> <span class="main">1</span><span class="main">)</span>"</span></span>

<span class="comment1">― ‹Verified with the flow ›</span>

<span class="keyword1"><span class="command">lemma</span></span> local_flow_tank<span class="main">:</span> <span class="quoted"><span class="quoted">"local_flow <span class="main">(</span><span class="keyword1">f</span> <span class="free">k</span><span class="main">)</span> UNIV UNIV <span class="main">(</span><span class="keyword1">φ</span> <span class="free">k</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> local_lipschitz_def lipschitz_on_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">1</span><span class="main">/</span><span class="numeral">2</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="main">1</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dist_norm norm_vec_def L2_set_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> UNIV_4<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">poly_derivatives</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> vec_eq_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> tank_arith<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="main">(</span><span class="free">τ</span><span class="main">::</span>real<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">c<span class="hidden">⇩</span><sub>o</sub></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">c<span class="hidden">⇩</span><sub>o</sub></span> <span class="main">&lt;</span> <span class="free">c<span class="hidden">⇩</span><sub>i</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">τ</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">τ</span><span class="main">}</span><span class="main">.</span> <span class="bound">τ</span> <span class="main">≤</span> <span class="main">-</span> <span class="main">(</span><span class="main">(</span><span class="free">hmin</span> <span class="main">-</span> <span class="free">y</span><span class="main">)</span> <span class="main">/</span> <span class="free">c<span class="hidden">⇩</span><sub>o</sub></span><span class="main">)</span> <span class="main">⟹</span>  <span class="free">hmin</span> <span class="main">≤</span> <span class="free">y</span> <span class="main">-</span> <span class="free">c<span class="hidden">⇩</span><sub>o</sub></span> <span class="main">*</span> <span class="free">τ</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">τ</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">τ</span><span class="main">}</span><span class="main">.</span> <span class="bound">τ</span> <span class="main">≤</span> <span class="main">(</span><span class="free">hmax</span> <span class="main">-</span> <span class="free">y</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="free">c<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">-</span> <span class="free">c<span class="hidden">⇩</span><sub>o</sub></span><span class="main">)</span> <span class="main">⟹</span>  <span class="main">(</span><span class="free">c<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">-</span> <span class="free">c<span class="hidden">⇩</span><sub>o</sub></span><span class="main">)</span> <span class="main">*</span> <span class="free">τ</span> <span class="main">+</span> <span class="free">y</span> <span class="main">≤</span> <span class="free">hmax</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">hmin</span> <span class="main">≤</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">hmin</span> <span class="main">≤</span> <span class="main">(</span><span class="free">c<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">-</span> <span class="free">c<span class="hidden">⇩</span><sub>o</sub></span><span class="main">)</span> <span class="main">⋅</span> <span class="free">τ</span> <span class="main">+</span> <span class="free">y</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">≤</span> <span class="free">hmax</span> <span class="main">⟹</span> <span class="free">y</span> <span class="main">-</span> <span class="free">c<span class="hidden">⇩</span><sub>o</sub></span> <span class="main">⋅</span> <span class="free">τ</span> <span class="main">≤</span> <span class="free">hmax</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span> le_divide_eq assms<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">meson</span> add_mono less_eq_real_def mult_left_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> add_increasing2 less_eq_real_def mult_nonneg_nonneg<span class="main">)</span> 

<span class="keyword1"><span class="command">lemmas</span></span> H_g_ode_tank <span class="main">=</span> local_flow.sH_g_ode_ivl<span class="main">[</span><span class="operator">OF</span> local_flow_tank _ UNIV_I<span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> tank_flow<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">τ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">c<span class="hidden">⇩</span><sub>o</sub></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">c<span class="hidden">⇩</span><sub>o</sub></span> <span class="main">&lt;</span> <span class="free">c<span class="hidden">⇩</span><sub>i</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>{</b></span><span class="keyword1">I</span> <span class="free">hmin</span> <span class="free">hmax</span><span class="main"><span class="hidden">❙</span><b>}</b></span>
  <span class="main">(</span><span class="keyword1">LOOP</span> 
    <span class="comment1">― ‹control›</span>
    <span class="main">(</span><span class="main">(</span><span class="numeral">2</span> <span class="main">::=</span><span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span><span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">;</span><span class="main">(</span><span class="numeral">3</span> <span class="main">::=</span><span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
    <span class="main">(</span><span class="keyword1">IF</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">4</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">3</span> <span class="main">≤</span> <span class="free">hmin</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">THEN</span> <span class="main">(</span><span class="numeral">4</span> <span class="main">::=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">ELSE</span> 
    <span class="main">(</span><span class="keyword1">IF</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">4</span> <span class="main">=</span> <span class="main">1</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">3</span> <span class="main">≥</span> <span class="free">hmax</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">THEN</span> <span class="main">(</span><span class="numeral">4</span> <span class="main">::=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span><span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">ELSE</span> skip<span class="main">)</span><span class="main">)</span><span class="main">;</span>
    <span class="comment1">― ‹dynamics›</span>
    <span class="main">(</span><span class="keyword1">IF</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">4</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="keyword1">THEN</span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="keyword1">f</span> <span class="main">(</span><span class="free">c<span class="hidden">⇩</span><sub>i</sub></span><span class="main">-</span><span class="free">c<span class="hidden">⇩</span><sub>o</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">&amp;</span> <span class="keyword1">G</span> <span class="free">hmax</span> <span class="main">(</span><span class="free">c<span class="hidden">⇩</span><sub>i</sub></span><span class="main">-</span><span class="free">c<span class="hidden">⇩</span><sub>o</sub></span><span class="main">)</span> <span class="keyword1">on</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">τ</span><span class="main">}</span><span class="main">)</span> UNIV <span class="main">@</span> <span class="main">0</span><span class="main">)</span> 
     <span class="keyword1">ELSE</span> <span class="main">(</span><span class="keyword1">x´=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="keyword1">f</span> <span class="main">(</span><span class="main">-</span><span class="free">c<span class="hidden">⇩</span><sub>o</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">&amp;</span> <span class="keyword1">G</span> <span class="free">hmin</span> <span class="main">(</span><span class="main">-</span><span class="free">c<span class="hidden">⇩</span><sub>o</sub></span><span class="main">)</span> <span class="keyword1">on</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">τ</span><span class="main">}</span><span class="main">)</span> UNIV <span class="main">@</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">)</span>
  <span class="keyword1">INV</span> <span class="keyword1">I</span> <span class="free">hmin</span> <span class="free">hmax</span><span class="main">)</span> 
  <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="keyword1">I</span> <span class="free">hmin</span> <span class="free">hmax</span><span class="main"><span class="hidden">❙</span><b>}</b></span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> H_loopI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="keyword1">I</span> <span class="free">hmin</span> <span class="free">hmax</span> <span class="bound">s</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span><span class="main">=</span><span class="main">0</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">3</span> <span class="main">=</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> H_seq<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="keyword1">I</span> <span class="free">hmin</span> <span class="free">hmax</span> <span class="bound">s</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span><span class="main">=</span><span class="main">0</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">3</span> <span class="main">=</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> H_seq<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="keyword1">I</span> <span class="free">hmin</span> <span class="free">hmax</span> <span class="bound">s</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span><span class="main">=</span><span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> H_seq<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> H_cond<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> H_g_ode_tank<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> assms tank_arith<span class="main">[</span><span class="operator">OF</span> _ assms<span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span>2<span class="main"><span class="main"><span class="main"><span class="main"><span class="main">,</span></span></span></span></span>3<span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="comment1">― ‹Verified with differential invariants ›</span>

<span class="keyword1"><span class="command">lemma</span></span> tank_diff_inv<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">τ</span> <span class="main">⟹</span> diff_invariant <span class="main">(</span><span class="keyword1">dI</span> <span class="free">hmin</span> <span class="free">hmax</span> <span class="free">k</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="keyword1">f</span> <span class="free">k</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">τ</span><span class="main">}</span><span class="main">)</span> UNIV <span class="main">0</span> <span class="free">Guard</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">intro</span> diff_invariant_conj_rule<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">poly_derivatives</span></span> <span class="dynamic"><span class="dynamic">diff_invariant_rules</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> ν'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> μ'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> diff_invariant_leq_rule<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">presburger</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> ν'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> μ'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> diff_invariant_leq_rule<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">poly_derivatives</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">poly_derivatives</span></span> <span class="dynamic"><span class="dynamic">diff_invariant_rules</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> tank_inv_arith1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="main">(</span><span class="free">τ</span><span class="main">::</span>real<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">c<span class="hidden">⇩</span><sub>o</sub></span> <span class="main">&lt;</span> <span class="free">c<span class="hidden">⇩</span><sub>i</sub></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">hmin</span> <span class="main">≤</span> <span class="free">y<span class="hidden">⇩</span><sub>0</sub></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> g<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">τ</span> <span class="main">≤</span> <span class="main">(</span><span class="free">hmax</span> <span class="main">-</span> <span class="free">y<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="free">c<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">-</span> <span class="free">c<span class="hidden">⇩</span><sub>o</sub></span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">hmin</span> <span class="main">≤</span> <span class="main">(</span><span class="free">c<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">-</span> <span class="free">c<span class="hidden">⇩</span><sub>o</sub></span><span class="main">)</span> <span class="main">⋅</span> <span class="free">τ</span> <span class="main">+</span> <span class="free">y<span class="hidden">⇩</span><sub>0</sub></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">c<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">-</span> <span class="free">c<span class="hidden">⇩</span><sub>o</sub></span><span class="main">)</span> <span class="main">⋅</span> <span class="free">τ</span> <span class="main">+</span> <span class="free">y<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">≤</span> <span class="free">hmax</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">c<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">-</span> <span class="free">c<span class="hidden">⇩</span><sub>o</sub></span><span class="main">)</span> <span class="main">⋅</span> <span class="free">τ</span> <span class="main">≤</span> <span class="main">(</span><span class="free">hmax</span> <span class="main">-</span> <span class="free">y<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> g assms<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> diff_gt_0_iff_gt mult.commute pos_le_divide_eq<span class="main">)</span> 
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">c<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">-</span> <span class="free">c<span class="hidden">⇩</span><sub>o</sub></span><span class="main">)</span> <span class="main">⋅</span> <span class="free">τ</span> <span class="main">+</span> <span class="free">y<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">≤</span> <span class="free">hmax</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">hmin</span> <span class="main">≤</span> <span class="main">(</span><span class="free">c<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">-</span> <span class="free">c<span class="hidden">⇩</span><sub>o</sub></span><span class="main">)</span> <span class="main">⋅</span> <span class="free">τ</span> <span class="main">+</span> <span class="free">y<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> b assms<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add.commute add_increasing2 diff_ge_0_iff_ge 
        less_eq_real_def mult_nonneg_nonneg<span class="main">)</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> tank_inv_arith2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="main">(</span><span class="free">τ</span><span class="main">::</span>real<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">c<span class="hidden">⇩</span><sub>o</sub></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">≤</span> <span class="free">hmax</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> g<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">τ</span> <span class="main">≤</span> <span class="main">-</span> <span class="main">(</span><span class="main">(</span><span class="free">hmin</span> <span class="main">-</span> <span class="free">y<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">/</span> <span class="free">c<span class="hidden">⇩</span><sub>o</sub></span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">hmin</span> <span class="main">≤</span> <span class="free">y<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">-</span> <span class="free">c<span class="hidden">⇩</span><sub>o</sub></span> <span class="main">⋅</span> <span class="free">τ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">y<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">-</span> <span class="free">c<span class="hidden">⇩</span><sub>o</sub></span> <span class="main">⋅</span> <span class="free">τ</span> <span class="main">≤</span> <span class="free">hmax</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">τ</span> <span class="main">⋅</span> <span class="free">c<span class="hidden">⇩</span><sub>o</sub></span> <span class="main">≤</span> <span class="free">y<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">-</span> <span class="free">hmin</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> g <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> <span class="free">c<span class="hidden">⇩</span><sub>o</sub></span>›</span></span> pos_le_minus_divide_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> 
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">hmin</span> <span class="main">≤</span> <span class="free">y<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">-</span> <span class="free">c<span class="hidden">⇩</span><sub>o</sub></span> <span class="main">⋅</span> <span class="free">τ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mult.commute<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">y<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">-</span> <span class="free">c<span class="hidden">⇩</span><sub>o</sub></span> <span class="main">⋅</span> <span class="free">τ</span> <span class="main">≤</span> <span class="free">hmax</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> b assms<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> mult_nonneg_nonneg<span class="main">)</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> tank_inv<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">τ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">c<span class="hidden">⇩</span><sub>o</sub></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">c<span class="hidden">⇩</span><sub>o</sub></span> <span class="main">&lt;</span> <span class="free">c<span class="hidden">⇩</span><sub>i</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>{</b></span><span class="keyword1">I</span> <span class="free">hmin</span> <span class="free">hmax</span><span class="main"><span class="hidden">❙</span><b>}</b></span>
  <span class="main">(</span><span class="keyword1">LOOP</span> 
    <span class="comment1">― ‹control›</span>
    <span class="main">(</span><span class="main">(</span><span class="numeral">2</span> <span class="main">::=</span><span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span><span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">;</span><span class="main">(</span><span class="numeral">3</span> <span class="main">::=</span><span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
    <span class="main">(</span><span class="keyword1">IF</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">4</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">3</span> <span class="main">≤</span> <span class="free">hmin</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">THEN</span> <span class="main">(</span><span class="numeral">4</span> <span class="main">::=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">ELSE</span> 
    <span class="main">(</span><span class="keyword1">IF</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">4</span> <span class="main">=</span> <span class="main">1</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">3</span> <span class="main">≥</span> <span class="free">hmax</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">THEN</span> <span class="main">(</span><span class="numeral">4</span> <span class="main">::=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span><span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">ELSE</span> skip<span class="main">)</span><span class="main">)</span><span class="main">;</span>
    <span class="comment1">― ‹dynamics›</span>
    <span class="main">(</span><span class="keyword1">IF</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">4</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="keyword1">THEN</span> 
      <span class="main">(</span><span class="keyword1">x´=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="keyword1">f</span> <span class="main">(</span><span class="free">c<span class="hidden">⇩</span><sub>i</sub></span><span class="main">-</span><span class="free">c<span class="hidden">⇩</span><sub>o</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">&amp;</span> <span class="keyword1">G</span> <span class="free">hmax</span> <span class="main">(</span><span class="free">c<span class="hidden">⇩</span><sub>i</sub></span><span class="main">-</span><span class="free">c<span class="hidden">⇩</span><sub>o</sub></span><span class="main">)</span> <span class="keyword1">on</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">τ</span><span class="main">}</span><span class="main">)</span> UNIV <span class="main">@</span> <span class="main">0</span> <span class="keyword1">DINV</span> <span class="main">(</span><span class="keyword1">dI</span> <span class="free">hmin</span> <span class="free">hmax</span> <span class="main">(</span><span class="free">c<span class="hidden">⇩</span><sub>i</sub></span><span class="main">-</span><span class="free">c<span class="hidden">⇩</span><sub>o</sub></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> 
     <span class="keyword1">ELSE</span> 
      <span class="main">(</span><span class="keyword1">x´=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="keyword1">f</span> <span class="main">(</span><span class="main">-</span><span class="free">c<span class="hidden">⇩</span><sub>o</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">&amp;</span> <span class="keyword1">G</span> <span class="free">hmin</span> <span class="main">(</span><span class="main">-</span><span class="free">c<span class="hidden">⇩</span><sub>o</sub></span><span class="main">)</span> <span class="keyword1">on</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">τ</span><span class="main">}</span><span class="main">)</span> UNIV <span class="main">@</span> <span class="main">0</span> <span class="keyword1">DINV</span> <span class="main">(</span><span class="keyword1">dI</span> <span class="free">hmin</span> <span class="free">hmax</span> <span class="main">(</span><span class="main">-</span><span class="free">c<span class="hidden">⇩</span><sub>o</sub></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">)</span>
  <span class="keyword1">INV</span> <span class="keyword1">I</span> <span class="free">hmin</span> <span class="free">hmax</span><span class="main">)</span>
  <span class="main"><span class="hidden">❙</span><b>{</b></span><span class="keyword1">I</span> <span class="free">hmin</span> <span class="free">hmax</span><span class="main"><span class="hidden">❙</span><b>}</b></span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> H_loopI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="keyword1">I</span> <span class="free">hmin</span> <span class="free">hmax</span> <span class="bound">s</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span><span class="main">=</span><span class="main">0</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">3</span> <span class="main">=</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> H_seq<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="keyword1">I</span> <span class="free">hmin</span> <span class="free">hmax</span> <span class="bound">s</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span><span class="main">=</span><span class="main">0</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">3</span> <span class="main">=</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> H_seq<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="keyword1">I</span> <span class="free">hmin</span> <span class="free">hmax</span> <span class="bound">s</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span><span class="main">=</span><span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> H_seq<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> H_cond<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> H_cond<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> H_g_ode_inv<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> assms tank_inv_arith1 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> tank_diff_inv<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> H_g_ode_inv<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> assms tank_diff_inv<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="free">c<span class="hidden">⇩</span><sub>o</sub></span>"</span></span> <span class="quoted"><span class="free">hmin</span></span> <span class="quoted"><span class="free">hmax</span></span><span class="main">]</span> tank_inv_arith2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="comment1">― ‹Refined with differential invariants ›</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">tank_ctrl</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real <span class="main">⇒</span> real <span class="main">⇒</span> <span class="main">(</span>real<span class="main">^</span><span class="numeral">4</span><span class="main">)</span> nd_fun"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">ctrl</span>"</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">ctrl</span></span> <span class="free"><span class="bound"><span class="entity">hmin</span></span></span> <span class="free"><span class="bound"><span class="entity">hmax</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">(</span><span class="numeral">2</span> <span class="main">::=</span><span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span><span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">;</span><span class="main">(</span><span class="numeral">3</span> <span class="main">::=</span><span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
    <span class="main">(</span><span class="keyword1">IF</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">4</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">3</span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">hmin</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">THEN</span> <span class="main">(</span><span class="numeral">4</span> <span class="main">::=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">ELSE</span> 
    <span class="main">(</span><span class="keyword1">IF</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">4</span> <span class="main">=</span> <span class="main">1</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">3</span> <span class="main">≥</span> <span class="free"><span class="bound"><span class="entity">hmax</span></span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">THEN</span> <span class="main">(</span><span class="numeral">4</span> <span class="main">::=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span><span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">ELSE</span> skip<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">tank_dyn_dinv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real <span class="main">⇒</span> real <span class="main">⇒</span> real <span class="main">⇒</span> real <span class="main">⇒</span> real <span class="main">⇒</span> <span class="main">(</span>real<span class="main">^</span><span class="numeral">4</span><span class="main">)</span> nd_fun"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">dyn</span>"</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">dyn</span></span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>i</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>o</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">hmin</span></span></span> <span class="free"><span class="bound"><span class="entity">hmax</span></span></span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="keyword1">IF</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">4</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="keyword1">THEN</span> 
      <span class="main">(</span><span class="keyword1">x´=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="keyword1">f</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>i</sub></span></span></span><span class="main">-</span><span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>o</sub></span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">&amp;</span> <span class="keyword1">G</span> <span class="free"><span class="bound"><span class="entity">hmax</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>i</sub></span></span></span><span class="main">-</span><span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>o</sub></span></span></span><span class="main">)</span> <span class="keyword1">on</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free"><span class="bound"><span class="entity">τ</span></span></span><span class="main">}</span><span class="main">)</span> UNIV <span class="main">@</span> <span class="main">0</span> <span class="keyword1">DINV</span> <span class="main">(</span><span class="keyword1">dI</span> <span class="free"><span class="bound"><span class="entity">hmin</span></span></span> <span class="free"><span class="bound"><span class="entity">hmax</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>i</sub></span></span></span><span class="main">-</span><span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>o</sub></span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> 
     <span class="keyword1">ELSE</span> 
      <span class="main">(</span><span class="keyword1">x´=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="keyword1">f</span> <span class="main">(</span><span class="main">-</span><span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>o</sub></span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">&amp;</span> <span class="keyword1">G</span> <span class="free"><span class="bound"><span class="entity">hmin</span></span></span> <span class="main">(</span><span class="main">-</span><span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>o</sub></span></span></span><span class="main">)</span> <span class="keyword1">on</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free"><span class="bound"><span class="entity">τ</span></span></span><span class="main">}</span><span class="main">)</span> UNIV <span class="main">@</span> <span class="main">0</span> <span class="keyword1">DINV</span> <span class="main">(</span><span class="keyword1">dI</span> <span class="free"><span class="bound"><span class="entity">hmin</span></span></span> <span class="free"><span class="bound"><span class="entity">hmax</span></span></span> <span class="main">(</span><span class="main">-</span><span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>o</sub></span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">tank_dinv</span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>i</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>o</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">hmin</span></span></span> <span class="free"><span class="bound"><span class="entity">hmax</span></span></span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span> <span class="main">≡</span> <span class="keyword1">LOOP</span> <span class="main">(</span><span class="keyword1">ctrl</span> <span class="free"><span class="bound"><span class="entity">hmin</span></span></span> <span class="free"><span class="bound"><span class="entity">hmax</span></span></span> <span class="main">;</span> <span class="keyword1">dyn</span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>i</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>o</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">hmin</span></span></span> <span class="free"><span class="bound"><span class="entity">hmax</span></span></span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span><span class="main">)</span> <span class="keyword1">INV</span> <span class="main">(</span><span class="keyword1">I</span> <span class="free"><span class="bound"><span class="entity">hmin</span></span></span> <span class="free"><span class="bound"><span class="entity">hmax</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> R_tank_inv<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">τ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">c<span class="hidden">⇩</span><sub>o</sub></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">c<span class="hidden">⇩</span><sub>o</sub></span> <span class="main">&lt;</span> <span class="free">c<span class="hidden">⇩</span><sub>i</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Ref <span class="main">⌈</span><span class="keyword1">I</span> <span class="free">hmin</span> <span class="free">hmax</span><span class="main">⌉</span> <span class="main">⌈</span><span class="keyword1">I</span> <span class="free">hmin</span> <span class="free">hmax</span><span class="main">⌉</span> <span class="main">≥</span> 
  <span class="main">(</span><span class="keyword1">LOOP</span> 
    <span class="comment1">― ‹control›</span>
    <span class="main">(</span><span class="main">(</span><span class="numeral">2</span> <span class="main">::=</span><span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span><span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">;</span><span class="main">(</span><span class="numeral">3</span> <span class="main">::=</span><span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
    <span class="main">(</span><span class="keyword1">IF</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">4</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">3</span> <span class="main">≤</span> <span class="free">hmin</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">THEN</span> <span class="main">(</span><span class="numeral">4</span> <span class="main">::=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">ELSE</span> 
    <span class="main">(</span><span class="keyword1">IF</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">4</span> <span class="main">=</span> <span class="main">1</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">3</span> <span class="main">≥</span> <span class="free">hmax</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">THEN</span> <span class="main">(</span><span class="numeral">4</span> <span class="main">::=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span><span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">ELSE</span> skip<span class="main">)</span><span class="main">)</span><span class="main">;</span>
    <span class="comment1">― ‹dynamics›</span>
    <span class="main">(</span><span class="keyword1">IF</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">4</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="keyword1">THEN</span> 
      <span class="main">(</span><span class="keyword1">x´=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="keyword1">f</span> <span class="main">(</span><span class="free">c<span class="hidden">⇩</span><sub>i</sub></span><span class="main">-</span><span class="free">c<span class="hidden">⇩</span><sub>o</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">&amp;</span> <span class="keyword1">G</span> <span class="free">hmax</span> <span class="main">(</span><span class="free">c<span class="hidden">⇩</span><sub>i</sub></span><span class="main">-</span><span class="free">c<span class="hidden">⇩</span><sub>o</sub></span><span class="main">)</span> <span class="keyword1">on</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">τ</span><span class="main">}</span><span class="main">)</span> UNIV <span class="main">@</span> <span class="main">0</span> <span class="keyword1">DINV</span> <span class="main">(</span><span class="keyword1">dI</span> <span class="free">hmin</span> <span class="free">hmax</span> <span class="main">(</span><span class="free">c<span class="hidden">⇩</span><sub>i</sub></span><span class="main">-</span><span class="free">c<span class="hidden">⇩</span><sub>o</sub></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> 
     <span class="keyword1">ELSE</span> 
      <span class="main">(</span><span class="keyword1">x´=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="keyword1">f</span> <span class="main">(</span><span class="main">-</span><span class="free">c<span class="hidden">⇩</span><sub>o</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">&amp;</span> <span class="keyword1">G</span> <span class="free">hmin</span> <span class="main">(</span><span class="main">-</span><span class="free">c<span class="hidden">⇩</span><sub>o</sub></span><span class="main">)</span> <span class="keyword1">on</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">τ</span><span class="main">}</span><span class="main">)</span> UNIV <span class="main">@</span> <span class="main">0</span> <span class="keyword1">DINV</span> <span class="main">(</span><span class="keyword1">dI</span> <span class="free">hmin</span> <span class="free">hmax</span> <span class="main">(</span><span class="main">-</span><span class="free">c<span class="hidden">⇩</span><sub>o</sub></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">)</span>
  <span class="keyword1">INV</span> <span class="keyword1">I</span> <span class="free">hmin</span> <span class="free">hmax</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Ref <span class="main">⌈</span><span class="keyword1">I</span> <span class="free">hmin</span> <span class="free">hmax</span><span class="main">⌉</span> <span class="main">⌈</span><span class="keyword1">I</span> <span class="free">hmin</span> <span class="free">hmax</span><span class="main">⌉</span> <span class="main">≥</span> 
    <span class="keyword1">LOOP</span> <span class="main">(</span>
      <span class="main">(</span><span class="numeral">2</span> <span class="main">::=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">;</span> <span class="main">(</span>Ref <span class="main">⌈</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="keyword1">I</span> <span class="free">hmin</span> <span class="free">hmax</span> <span class="bound">s</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span> <span class="main">=</span> <span class="main">0</span><span class="main">⌉</span> <span class="main">⌈</span><span class="keyword1">I</span> <span class="free">hmin</span> <span class="free">hmax</span><span class="main">⌉</span><span class="main">)</span>
    <span class="main">)</span> <span class="keyword1">INV</span> <span class="keyword1">I</span> <span class="free">hmin</span> <span class="free">hmax</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">≥</span> <span class="var">?R</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">refinement</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> 
    <span class="quoted"><span class="quoted">"<span class="var">?R</span> <span class="main">≥</span> <span class="keyword1">LOOP</span> <span class="main">(</span>
      <span class="main">(</span><span class="numeral">2</span> <span class="main">::=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">;</span><span class="main">(</span><span class="numeral">3</span> <span class="main">::=</span><span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">$</span><span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
      <span class="main">(</span>Ref <span class="main">⌈</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="keyword1">I</span> <span class="free">hmin</span> <span class="free">hmax</span> <span class="bound">s</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">3</span><span class="main">=</span><span class="bound">s</span><span class="main">$</span><span class="main">1</span><span class="main">⌉</span> <span class="main">⌈</span><span class="keyword1">I</span> <span class="free">hmin</span> <span class="free">hmax</span><span class="main">⌉</span><span class="main">)</span>
    <span class="main">)</span> <span class="keyword1">INV</span> <span class="keyword1">I</span> <span class="free">hmin</span> <span class="free">hmax</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">≥</span> <span class="var">?R</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> mult.assoc<span class="main"><span class="keyword3">,</span></span> <span class="operator">refinement</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> 
    <span class="quoted"><span class="quoted">"<span class="var">?R</span> <span class="main">≥</span> <span class="keyword1">LOOP</span> <span class="main">(</span>
      <span class="keyword1">ctrl</span> <span class="free">hmin</span> <span class="free">hmax</span><span class="main">;</span>
      <span class="main">(</span>Ref <span class="main">⌈</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="keyword1">I</span> <span class="free">hmin</span> <span class="free">hmax</span> <span class="bound">s</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">2</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">$</span><span class="numeral">3</span><span class="main">=</span><span class="bound">s</span><span class="main">$</span><span class="main">1</span><span class="main">⌉</span> <span class="main">⌈</span><span class="keyword1">I</span> <span class="free">hmin</span> <span class="free">hmax</span><span class="main">⌉</span><span class="main">)</span>
    <span class="main">)</span> <span class="keyword1">INV</span> <span class="keyword1">I</span> <span class="free">hmin</span> <span class="free">hmax</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">≥</span> <span class="var">?R</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> mult.assoc<span class="main"><span class="keyword3">,</span></span> <span class="operator">refinement</span><span class="main"><span class="keyword3">;</span></span> <span class="main">(</span><span class="operator">force</span><span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">rule</span> R_assign_law<span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> 
    <span class="quoted"><span class="quoted">"<span class="var">?R</span> <span class="main">≥</span> <span class="keyword1">LOOP</span> <span class="main">(</span><span class="keyword1">ctrl</span> <span class="free">hmin</span> <span class="free">hmax</span><span class="main">;</span> <span class="keyword1">dyn</span> <span class="free">c<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">c<span class="hidden">⇩</span><sub>o</sub></span> <span class="free">hmin</span> <span class="free">hmax</span> <span class="free">τ</span><span class="main">)</span> <span class="keyword1">INV</span> <span class="keyword1">I</span> <span class="free">hmin</span> <span class="free">hmax</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> mult.assoc<span class="main"><span class="keyword3">,</span></span> <span class="operator">refinement</span><span class="main"><span class="keyword3">;</span></span> <span class="main">(</span><span class="main">(</span><span class="operator">rule</span> tank_diff_inv<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">?</span></span> <span class="main"><span class="keyword3">|</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main">)</span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> tank_inv_arith1 tank_inv_arith2 assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">no_notation</span></span> tank_vec_field <span class="main">(</span><span class="quoted">"<span class="keyword1">f</span>"</span><span class="main">)</span>
        <span class="keyword2"><span class="keyword">and</span></span> tank_flow <span class="main">(</span><span class="quoted">"<span class="keyword1">φ</span>"</span><span class="main">)</span>
        <span class="keyword2"><span class="keyword">and</span></span> tank_guard <span class="main">(</span><span class="quoted">"<span class="keyword1">G</span>"</span><span class="main">)</span>
        <span class="keyword2"><span class="keyword">and</span></span> tank_loop_inv <span class="main">(</span><span class="quoted">"<span class="keyword1">I</span>"</span><span class="main">)</span>
        <span class="keyword2"><span class="keyword">and</span></span> tank_diff_inv <span class="main">(</span><span class="quoted">"<span class="keyword1">dI</span>"</span><span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div>