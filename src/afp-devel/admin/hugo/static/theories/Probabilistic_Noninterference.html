<div id="Interface">
<div class="head">
<h1>Theory Interface</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Interface 
<span class="keyword2"><span class="keyword">imports</span></span>
  <span class="quoted">"<a href="../../HOL/HOL-Library/Prefix_Order.html">HOL-Library.Prefix_Order</a>"</span>
  <a href="../Markov_Models/Discrete_Time_Markov_Chain.html">Markov_Models.Discrete_Time_Markov_Chain</a>
<span class="keyword2"><span class="keyword">begin</span></span>


<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Language_Semantics">
<div class="head">
<h1>Theory Language_Semantics</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Simple While Language with probabilistic choice and parallel execution›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Language_Semantics
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Interface.html">Interface</a>
<span class="keyword2"><span class="keyword">begin</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Preliminaries›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Trivia›</span></span>

<span class="keyword1"><span class="command">declare</span></span> zero_le_mult_iff<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> split_mult_pos_le<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> zero_le_divide_iff<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>

<span class="keyword1" id="Language_Semantics-in_minus_Un"><span class="command">lemma</span></span> in_minus_Un<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> <span class="free">I</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">-</span> <span class="main">{</span><span class="free">i</span><span class="main">}</span> <span class="keyword1">Un</span> <span class="main">{</span><span class="free">i</span><span class="main">}</span> <span class="main">=</span> <span class="free">I</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">i</span><span class="main">}</span> <span class="keyword1">Un</span> <span class="main">(</span><span class="free">I</span> <span class="main">-</span> <span class="main">{</span><span class="free">i</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="free">I</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">metis</span> Un_commute assms insert_Diff_single insert_absorb insert_is_Un<span class="main">)</span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms insert_Diff_single insert_absorb insert_is_Un<span class="main">)</span>

<span class="keyword1" id="Language_Semantics-less_plus_cases"><span class="command">lemma</span></span> less_plus_cases<span class="main">[</span><span class="operator">case_names</span> Left Right<span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span>
*<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">i</span><span class="main">::</span>nat<span class="main">)</span> <span class="main">&lt;</span> <span class="free">n1</span> <span class="main">⟹</span> <span class="free">phi</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
**<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">i2</span><span class="main">.</span> <span class="free">i</span> <span class="main">=</span> <span class="free">n1</span> <span class="main">+</span> <span class="bound">i2</span> <span class="main">⟹</span> <span class="free">phi</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="free">phi</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">n1</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">n1</span> <span class="main">≤</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">=</span> <span class="free">n1</span> <span class="main">+</span> <span class="skolem">i2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> le_iff_add<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> ** <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Language_Semantics-less_plus_elim"><span class="command">lemma</span></span> less_plus_elim<span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">,</span> <span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">case_names</span> Left Right<span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">i</span><span class="main">::</span> nat<span class="main">)</span> <span class="main">&lt;</span> <span class="free">n1</span> <span class="main">+</span> <span class="free">n2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
*<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">n1</span> <span class="main">⟹</span> <span class="free">phi</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
**<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">i2</span><span class="main">.</span> <span class="main">⟦</span><span class="bound">i2</span> <span class="main">&lt;</span> <span class="free">n2</span><span class="main">;</span> <span class="free">i</span> <span class="main">=</span> <span class="free">n1</span> <span class="main">+</span> <span class="bound">i2</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">phi</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="free">phi</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> less_plus_cases<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">i</span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">n1</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Language_Semantics-nth_append_singl"><span class="command">lemma</span></span> nth_append_singl<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">al</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">al</span> <span class="main">@</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main">)</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> <span class="free">al</span> <span class="main">!</span> <span class="free">i</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nth_append<span class="main">)</span>

<span class="keyword1" id="Language_Semantics-take_append_singl"><span class="command">lemma</span></span> take_append_singl<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&lt;</span> length <span class="free">al</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"take <span class="free">n</span> <span class="main">(</span><span class="free">al</span> <span class="main">@</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> take <span class="free">n</span> <span class="free">al</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">al</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Language_Semantics-length_unique_prefix"><span class="command">lemma</span></span> length_unique_prefix<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">al1</span> <span class="main">≤</span> <span class="free">al</span> <span class="main">⟹</span> <span class="free">al2</span> <span class="main">≤</span> <span class="free">al</span> <span class="main">⟹</span> length <span class="free">al1</span> <span class="main">=</span> length <span class="free">al2</span> <span class="main">⟹</span> <span class="free">al1</span> <span class="main">=</span> <span class="free">al2</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> not_equal_is_parallel parallelE prefix_same_cases less_eq_list_def<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹take:›</span></span>

<span class="keyword1" id="Language_Semantics-take_length"><span class="command">lemma</span></span> take_length<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="quoted"><span class="quoted">"take <span class="main">(</span>length <span class="free">al</span><span class="main">)</span> <span class="free">al</span> <span class="main">=</span> <span class="free">al</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> take_all <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Language_Semantics-take_le"><span class="command">lemma</span></span> take_le<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&lt;</span> length <span class="free">al</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"take <span class="free">n</span> <span class="free">al</span> <span class="main">@</span> <span class="main">[</span><span class="free">al</span> <span class="main">!</span> <span class="free">n</span><span class="main">]</span> <span class="main">≤</span> <span class="free">al</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms take_Suc_conv_app_nth take_is_prefix less_eq_list_def<span class="main">)</span>

<span class="keyword1" id="Language_Semantics-list_less_iff_prefix"><span class="command">lemma</span></span> list_less_iff_prefix<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">&lt;</span> <span class="free">b</span> <span class="main">⟷</span> strict_prefix <span class="free">a</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> le_less less_eq_list_def less_irrefl prefix_order.le_less prefix_order.less_irrefl<span class="main">)</span>

<span class="keyword1" id="Language_Semantics-take_lt"><span class="command">lemma</span></span> take_lt<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&lt;</span> length <span class="free">al</span> <span class="main">⟹</span> take <span class="free">n</span> <span class="free">al</span> <span class="main">&lt;</span> <span class="free">al</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> list_less_iff_prefix
  <span class="keyword1"><span class="command">using</span></span> prefix_order.le_less<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"take <span class="free">n</span> <span class="free">al</span>"</span></span> <span class="quoted"><span class="free">al</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> take_is_prefix<span class="main">)</span>

<span class="keyword1" id="Language_Semantics-le_take"><span class="command">lemma</span></span> le_take<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">n1</span> <span class="main">≤</span> <span class="free">n2</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"take <span class="free">n1</span> <span class="free">al</span> <span class="main">≤</span> take <span class="free">n2</span> <span class="free">al</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">al</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n1</span></span> <span class="quoted"><span class="free">n2</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">al</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">n1</span></span> <span class="quoted"><span class="skolem">n2</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> nat.exhaust<span class="main"><span class="main">[</span></span><span class="operator">case_product</span> nat.exhaust<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Language_Semantics-inj_take"><span class="command">lemma</span></span> inj_take<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">n1</span> <span class="main">≤</span> length <span class="free">al</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">n2</span> <span class="main">≤</span> length <span class="free">al</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"take <span class="free">n1</span> <span class="free">al</span> <span class="main">=</span> take <span class="free">n2</span> <span class="free">al</span> <span class="main">⟷</span> <span class="free">n1</span> <span class="main">=</span> <span class="free">n2</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"take <span class="free">n1</span> <span class="free">al</span> <span class="main">=</span> take <span class="free">n2</span> <span class="free">al</span>"</span></span>
   <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">n1</span> <span class="main">=</span> <span class="free">n2</span>"</span></span>
   <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">al</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n1</span></span> <span class="quoted"><span class="free">n2</span></span><span class="main">)</span>
     <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">al</span><span class="main">)</span>
     <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">n1</span></span> <span class="quoted"><span class="skolem">n2</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> nat.exhaust<span class="main"><span class="main">[</span></span><span class="operator">case_product</span> nat.exhaust<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
   <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Language_Semantics-lt_take"><span class="command">lemma</span></span> lt_take<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n1</span> <span class="main">&lt;</span> <span class="free">n2</span> <span class="main">⟹</span> <span class="free">n2</span> <span class="main">≤</span> length <span class="free">al</span> <span class="main">⟹</span> take <span class="free">n1</span> <span class="free">al</span> <span class="main">&lt;</span> take <span class="free">n2</span> <span class="free">al</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> inj_take le_less_trans le_take not_less_iff_gr_or_eq order.not_eq_order_implies_strict order.strict_implies_order<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹lsum:›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">lsum</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> nat<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">lsum</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">al</span></span></span> <span class="main">≡</span> sum_list <span class="main">(</span>map <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">al</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Language_Semantics-lsum_simps"><span class="command">lemma</span></span> lsum_simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
 <span class="quoted"><span class="quoted">"lsum <span class="free">f</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
 <span class="quoted"><span class="quoted">"lsum <span class="free">f</span> <span class="main">(</span><span class="free">al</span> <span class="main">@</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> lsum <span class="free">f</span> <span class="free">al</span> <span class="main">+</span> <span class="free">f</span> <span class="free">a</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> lsum_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Language_Semantics-lsum_append"><span class="command">lemma</span></span> lsum_append<span class="main">:</span>
<span class="quoted"><span class="quoted">"lsum <span class="free">f</span> <span class="main">(</span><span class="free">al</span> <span class="main">@</span> <span class="free">bl</span><span class="main">)</span> <span class="main">=</span> lsum <span class="free">f</span> <span class="free">al</span> <span class="main">+</span> lsum <span class="free">f</span> <span class="free">bl</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> lsum_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Language_Semantics-lsum_cong"><span class="command">lemma</span></span> lsum_cong<span class="main">[</span><span class="operator">fundef_cong</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> set <span class="free">al</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">a</span> <span class="main">=</span> <span class="free">g</span> <span class="bound">a</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lsum <span class="free">f</span> <span class="free">al</span> <span class="main">=</span> lsum <span class="free">g</span> <span class="free">al</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> lsum_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> map_eq_conv<span class="main">)</span>

<span class="keyword1" id="Language_Semantics-lsum_gt_0"><span class="command">lemma</span></span> lsum_gt_0<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">al</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> set <span class="free">al</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="free">f</span> <span class="bound">a</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> lsum <span class="free">f</span> <span class="free">al</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Language_Semantics-lsum_mono"><span class="command">lemma</span></span> lsum_mono<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">al</span> <span class="main">≤</span> <span class="free">bl</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lsum <span class="free">f</span> <span class="free">al</span> <span class="main">≤</span> lsum <span class="free">f</span> <span class="free">bl</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">cl</span></span> <span class="keyword2"><span class="keyword">where</span></span> bl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">bl</span> <span class="main">=</span> <span class="free">al</span> <span class="main">@</span> <span class="skolem">cl</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> prefix_def less_eq_list_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> bl lsum_append <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Language_Semantics-lsum_mono2"><span class="command">lemma</span></span> lsum_mono2<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">b</span><span class="main">.</span> <span class="bound">b</span> <span class="main">∈</span> set <span class="free">bl</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">b</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> le<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">al</span> <span class="main">&lt;</span> <span class="free">bl</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lsum <span class="free">f</span> <span class="free">al</span> <span class="main">&lt;</span> lsum <span class="free">f</span> <span class="free">bl</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">cl</span></span> <span class="keyword2"><span class="keyword">where</span></span> bl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">bl</span> <span class="main">=</span> <span class="free">al</span> <span class="main">@</span> <span class="skolem">cl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> cl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">cl</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> list_less_iff_prefix prefix_def strict_prefix_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lsum <span class="free">f</span> <span class="free">al</span> <span class="main">&lt;</span> lsum <span class="free">f</span> <span class="free">al</span> <span class="main">+</span> lsum <span class="free">f</span> <span class="skolem">cl</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> f cl <span class="keyword1"><span class="command">unfolding</span></span> bl <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> lsum <span class="free">f</span> <span class="free">bl</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> bl lsum_append <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Language_Semantics-lsum_take"><span class="command">lemma</span></span> lsum_take<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="quoted"><span class="quoted">"lsum <span class="free">f</span> <span class="main">(</span>take <span class="free">n</span> <span class="free">al</span><span class="main">)</span> <span class="main">≤</span> lsum <span class="free">f</span> <span class="free">al</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> lsum_mono take_is_prefix less_eq_list_def<span class="main">)</span>

<span class="keyword1" id="Language_Semantics-less_lsum_nchotomy"><span class="command">lemma</span></span> less_lsum_nchotomy<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> set <span class="free">al</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="free">f</span> <span class="bound">a</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">i</span><span class="main">::</span>nat<span class="main">)</span> <span class="main">&lt;</span> lsum <span class="free">f</span> <span class="free">al</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">n</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> length <span class="free">al</span> <span class="main">∧</span> <span class="bound">j</span> <span class="main">&lt;</span> <span class="free">f</span> <span class="main">(</span><span class="free">al</span> <span class="main">!</span> <span class="bound">n</span><span class="main">)</span> <span class="main">∧</span> <span class="free">i</span> <span class="main">=</span> lsum <span class="free">f</span> <span class="main">(</span>take <span class="bound">n</span> <span class="free">al</span><span class="main">)</span> <span class="main">+</span> <span class="bound">j</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">a</span> <span class="skolem">al</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> lsum <span class="free">f</span> <span class="skolem">al</span> <span class="main">+</span> <span class="free">f</span> <span class="skolem">a</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  pos<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">f</span> <span class="skolem">a</span>"</span></span>  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a'</span><span class="main">.</span> <span class="bound">a'</span> <span class="main">∈</span> set <span class="skolem">al</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="free">f</span> <span class="bound">a'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> i <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> less_plus_elim<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Left
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">&lt;</span> length <span class="skolem">al</span> <span class="main">∧</span> <span class="skolem">j</span> <span class="main">&lt;</span> <span class="free">f</span> <span class="main">(</span><span class="skolem">al</span> <span class="main">!</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">∧</span> <span class="free">i</span> <span class="main">=</span> lsum <span class="free">f</span> <span class="main">(</span>take <span class="skolem">n</span> <span class="skolem">al</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">j</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> pos snoc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">n</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">j</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Right <span class="skolem">j</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"length <span class="skolem"><span class="skolem">al</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">j</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Language_Semantics-less_lsum_unique"><span class="command">lemma</span></span> less_lsum_unique<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> set <span class="free">al</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">0</span><span class="main">::</span>nat<span class="main">)</span> <span class="main">&lt;</span> <span class="free">f</span> <span class="bound">a</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">n1</span> <span class="main">&lt;</span> length <span class="free">al</span> <span class="main">∧</span> <span class="free">j1</span> <span class="main">&lt;</span> <span class="free">f</span> <span class="main">(</span><span class="free">al</span> <span class="main">!</span> <span class="free">n1</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">n2</span> <span class="main">&lt;</span> length <span class="free">al</span> <span class="main">∧</span> <span class="free">j2</span> <span class="main">&lt;</span> <span class="free">f</span> <span class="main">(</span><span class="free">al</span> <span class="main">!</span> <span class="free">n2</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"lsum <span class="free">f</span> <span class="main">(</span>take <span class="free">n1</span> <span class="free">al</span><span class="main">)</span> <span class="main">+</span> <span class="free">j1</span> <span class="main">=</span> lsum <span class="free">f</span> <span class="main">(</span>take <span class="free">n2</span> <span class="free">al</span><span class="main">)</span> <span class="main">+</span> <span class="free">j2</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">n1</span> <span class="main">=</span> <span class="free">n2</span> <span class="main">∧</span> <span class="free">j1</span> <span class="main">=</span> <span class="free">j2</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">al</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n1</span></span> <span class="quoted"><span class="free">n2</span></span> <span class="quoted"><span class="free">j1</span></span> <span class="quoted"><span class="free">j2</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">a</span> <span class="skolem">al</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> pos<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">f</span> <span class="skolem">a</span>"</span></span>   <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">a'</span><span class="main">.</span> <span class="bound">a'</span> <span class="main">∈</span> set <span class="skolem">al</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="free">f</span> <span class="bound">a'</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> n1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n1</span> <span class="main">&lt;</span> length <span class="skolem">al</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> n2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n2</span> <span class="main">&lt;</span> length <span class="skolem">al</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> n1 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> less_plus_elim<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Left <span class="keyword1"><span class="command">note</span></span> n1 <span class="main">=</span> Left
    <span class="keyword1"><span class="command">hence</span></span> j1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j1</span> <span class="main">&lt;</span> <span class="free">f</span> <span class="main">(</span><span class="skolem">al</span> <span class="main">!</span> <span class="skolem">n1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> snoc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">al'</span></span> <span class="keyword2"><span class="keyword">where</span></span> al<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">al</span> <span class="main">=</span> <span class="main">(</span>take <span class="skolem">n1</span> <span class="skolem">al</span><span class="main">)</span> <span class="main">@</span> <span class="main">(</span><span class="main">(</span><span class="skolem">al</span> <span class="main">!</span> <span class="skolem">n1</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">al'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> n1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_take_drop_id Cons_nth_drop_Suc<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j1</span> <span class="main">&lt;</span> lsum <span class="free">f</span> <span class="main">(</span><span class="main">(</span><span class="skolem">al</span> <span class="main">!</span> <span class="skolem">n1</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">al'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> pos j1 <span class="keyword1"><span class="command">unfolding</span></span> lsum_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"lsum <span class="free">f</span> <span class="main">(</span>take <span class="skolem">n1</span> <span class="skolem">al</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">j1</span> <span class="main">&lt;</span> lsum <span class="free">f</span> <span class="main">(</span>take <span class="skolem">n1</span> <span class="skolem">al</span><span class="main">)</span> <span class="main">+</span> lsum <span class="free">f</span> <span class="main">(</span><span class="main">(</span><span class="skolem">al</span> <span class="main">!</span> <span class="skolem">n1</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">al'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> lsum <span class="free">f</span> <span class="skolem">al</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> lsum_append<span class="main">[</span><span class="operator">THEN</span> sym<span class="main">]</span> <span class="keyword1"><span class="command">using</span></span> al <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> lsum1<span class="main">:</span> <span class="quoted"><span class="quoted">"lsum <span class="free">f</span> <span class="main">(</span>take <span class="skolem">n1</span> <span class="skolem">al</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">j1</span> <span class="main">&lt;</span> lsum <span class="free">f</span> <span class="skolem">al</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">from</span></span> n2 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> less_plus_elim<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> Left <span class="keyword1"><span class="command">note</span></span> n2 <span class="main">=</span> Left
      <span class="keyword1"><span class="command">hence</span></span> j2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j2</span> <span class="main">&lt;</span> <span class="free">f</span> <span class="main">(</span><span class="skolem">al</span> <span class="main">!</span> <span class="skolem">n2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> snoc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> snoc<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> snoc <span class="keyword1"><span class="command">using</span></span> pos n1 j1 n2 j2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> Right
      <span class="keyword1"><span class="command">hence</span></span> n2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n2</span> <span class="main">=</span> length <span class="skolem">al</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">hence</span></span> j2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j2</span> <span class="main">&lt;</span> <span class="free">f</span> <span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> snoc <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lsum <span class="free">f</span> <span class="main">(</span>take <span class="skolem">n1</span> <span class="skolem">al</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">j1</span> <span class="main">=</span> lsum <span class="free">f</span> <span class="skolem">al</span> <span class="main">+</span> <span class="skolem">j2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> n1 n2 snoc <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> lsum1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> Right
    <span class="keyword1"><span class="command">hence</span></span> n1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n1</span> <span class="main">=</span> length <span class="skolem">al</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> j1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j1</span> <span class="main">&lt;</span> <span class="free">f</span> <span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> snoc <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> n2 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> less_plus_elim<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> Left <span class="keyword1"><span class="command">note</span></span> n2 <span class="main">=</span> Left
      <span class="keyword1"><span class="command">hence</span></span> j2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j2</span> <span class="main">&lt;</span> <span class="free">f</span> <span class="main">(</span><span class="skolem">al</span> <span class="main">!</span> <span class="skolem">n2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> snoc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">al'</span></span> <span class="keyword2"><span class="keyword">where</span></span> al<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">al</span> <span class="main">=</span> <span class="main">(</span>take <span class="skolem">n2</span> <span class="skolem">al</span><span class="main">)</span> <span class="main">@</span> <span class="main">(</span><span class="main">(</span><span class="skolem">al</span> <span class="main">!</span> <span class="skolem">n2</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">al'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> n2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_take_drop_id Cons_nth_drop_Suc<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j2</span> <span class="main">&lt;</span> lsum <span class="free">f</span> <span class="main">(</span><span class="main">(</span><span class="skolem">al</span> <span class="main">!</span> <span class="skolem">n2</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">al'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> pos j2 <span class="keyword1"><span class="command">unfolding</span></span> lsum_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"lsum <span class="free">f</span> <span class="main">(</span>take <span class="skolem">n2</span> <span class="skolem">al</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">j2</span> <span class="main">&lt;</span> lsum <span class="free">f</span> <span class="main">(</span>take <span class="skolem">n2</span> <span class="skolem">al</span><span class="main">)</span> <span class="main">+</span> lsum <span class="free">f</span> <span class="main">(</span><span class="main">(</span><span class="skolem">al</span> <span class="main">!</span> <span class="skolem">n2</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">al'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> lsum <span class="free">f</span> <span class="skolem">al</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> lsum_append<span class="main">[</span><span class="operator">THEN</span> sym<span class="main">]</span> <span class="keyword1"><span class="command">using</span></span> al <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> lsum2<span class="main">:</span> <span class="quoted"><span class="quoted">"lsum <span class="free">f</span> <span class="main">(</span>take <span class="skolem">n2</span> <span class="skolem">al</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">j2</span> <span class="main">&lt;</span> lsum <span class="free">f</span> <span class="skolem">al</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lsum <span class="free">f</span> <span class="skolem">al</span> <span class="main">+</span> <span class="skolem">j1</span> <span class="main">=</span> lsum <span class="free">f</span> <span class="main">(</span>take <span class="skolem">n2</span> <span class="skolem">al</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">j2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> n1 n2 snoc <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> lsum2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> Right
      <span class="keyword1"><span class="command">hence</span></span> n2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n2</span> <span class="main">=</span> length <span class="skolem">al</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j1</span> <span class="main">=</span> <span class="skolem">j2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> n1 n2 snoc <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> n1 n2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">locate_pred</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">locate_pred</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">al</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">::</span>nat<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">n_j</span></span></span> <span class="main">≡</span>
 fst <span class="free"><span class="bound"><span class="entity">n_j</span></span></span> <span class="main">&lt;</span> length <span class="free"><span class="bound"><span class="entity">al</span></span></span> <span class="main">∧</span>
 snd <span class="free"><span class="bound"><span class="entity">n_j</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">al</span></span></span> <span class="main">!</span> <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">n_j</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
 <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> lsum <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>take <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">n_j</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">al</span></span></span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">n_j</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">locate</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">locate</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">al</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">≡</span> <span class="keyword1">SOME</span> <span class="bound">n_j</span><span class="main">.</span> locate_pred <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">al</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="bound">n_j</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">locate1</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">locate1</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">al</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">≡</span> fst <span class="main">(</span>locate <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">al</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">locate2</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">locate2</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">al</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">≡</span> snd <span class="main">(</span>locate <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">al</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Language_Semantics-locate_pred_ex"><span class="command">lemma</span></span> locate_pred_ex<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> set <span class="free">al</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="free">f</span> <span class="bound">a</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> lsum <span class="free">f</span> <span class="free">al</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">n_j</span><span class="main">.</span> locate_pred <span class="free">f</span> <span class="free">al</span> <span class="free">i</span> <span class="bound">n_j</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms less_lsum_nchotomy <span class="keyword1"><span class="command">unfolding</span></span> locate_pred_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1" id="Language_Semantics-locate_pred_unique"><span class="command">lemma</span></span> locate_pred_unique<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> set <span class="free">al</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="free">f</span> <span class="bound">a</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"locate_pred <span class="free">f</span> <span class="free">al</span> <span class="free">i</span> <span class="free">n1_j1</span>"</span></span> <span class="quoted"><span class="quoted">"locate_pred <span class="free">f</span> <span class="free">al</span> <span class="free">i</span> <span class="free">n2_j2</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">n1_j1</span> <span class="main">=</span> <span class="free">n2_j2</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms less_lsum_unique <span class="keyword1"><span class="command">unfolding</span></span> locate_pred_def
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">n1_j1</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">n2_j2</span></span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Language_Semantics-locate_locate_pred"><span class="command">lemma</span></span> locate_locate_pred<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> set <span class="free">al</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">0</span><span class="main">::</span>nat<span class="main">)</span> <span class="main">&lt;</span> <span class="free">f</span> <span class="bound">a</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> lsum <span class="free">f</span> <span class="free">al</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"locate_pred <span class="free">f</span> <span class="free">al</span> <span class="free">i</span> <span class="main">(</span>locate <span class="free">f</span> <span class="free">al</span> <span class="free">i</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n_j</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"locate_pred <span class="free">f</span> <span class="free">al</span> <span class="free">i</span> <span class="skolem">n_j</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms locate_pred_ex<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">al</span></span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">i</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> locate_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">intro</span> someI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"locate_pred <span class="free"><span class="free">f</span></span> <span class="free"><span class="free">al</span></span> <span class="free"><span class="free">i</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Language_Semantics-locate_locate_pred_unique"><span class="command">lemma</span></span> locate_locate_pred_unique<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> set <span class="free">al</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">0</span><span class="main">::</span>nat<span class="main">)</span> <span class="main">&lt;</span> <span class="free">f</span> <span class="bound">a</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"locate_pred <span class="free">f</span> <span class="free">al</span> <span class="free">i</span> <span class="free">n_j</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">n_j</span> <span class="main">=</span> locate <span class="free">f</span> <span class="free">al</span> <span class="free">i</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> locate_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> sym<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> some_equality<span class="main">)</span>
<span class="keyword1"><span class="command">using</span></span> assms locate_locate_pred <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">using</span></span> assms locate_pred_unique <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Language_Semantics-locate"><span class="command">lemma</span></span> locate<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> set <span class="free">al</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="free">f</span> <span class="bound">a</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> lsum <span class="free">f</span> <span class="free">al</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"locate1 <span class="free">f</span> <span class="free">al</span> <span class="free">i</span> <span class="main">&lt;</span> length <span class="free">al</span> <span class="main">∧</span>
 locate2 <span class="free">f</span> <span class="free">al</span> <span class="free">i</span> <span class="main">&lt;</span> <span class="free">f</span> <span class="main">(</span><span class="free">al</span> <span class="main">!</span> <span class="main">(</span>locate1 <span class="free">f</span> <span class="free">al</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
 <span class="free">i</span> <span class="main">=</span> lsum <span class="free">f</span> <span class="main">(</span>take <span class="main">(</span>locate1 <span class="free">f</span> <span class="free">al</span> <span class="free">i</span><span class="main">)</span> <span class="free">al</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span>locate2 <span class="free">f</span> <span class="free">al</span> <span class="free">i</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms locate_locate_pred
<span class="keyword1"><span class="command">unfolding</span></span> locate1_def locate2_def locate_pred_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Language_Semantics-locate_unique"><span class="command">lemma</span></span> locate_unique<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> set <span class="free">al</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="free">f</span> <span class="bound">a</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&lt;</span> length <span class="free">al</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> <span class="free">f</span> <span class="main">(</span><span class="free">al</span> <span class="main">!</span> <span class="free">n</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">=</span> lsum <span class="free">f</span> <span class="main">(</span>take <span class="free">n</span> <span class="free">al</span><span class="main">)</span> <span class="main">+</span> <span class="free">j</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> locate1 <span class="free">f</span> <span class="free">al</span> <span class="free">i</span> <span class="main">∧</span> <span class="free">j</span> <span class="main">=</span> locate2 <span class="free">f</span> <span class="free">al</span> <span class="free">i</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">n_j</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n_j</span> <span class="main">=</span> <span class="main">(</span><span class="free">n</span><span class="main">,</span><span class="free">j</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"locate_pred <span class="free">f</span> <span class="free">al</span> <span class="free">i</span> <span class="skolem">n_j</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> n_j_def locate_pred_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n_j</span> <span class="main">=</span> locate <span class="free">f</span> <span class="free">al</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms locate_locate_pred_unique <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> n_j_def locate1_def locate2_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fst_conv n_j_def snd_conv<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹sum:›</span></span>

<span class="keyword1" id="Language_Semantics-sum_2"><span class="command">lemma</span></span> sum_2<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="quoted"><span class="quoted">"sum <span class="free">f</span> <span class="main">{..&lt;</span> <span class="numeral">2</span><span class="main">}</span> <span class="main">=</span> <span class="free">f</span> <span class="main">0</span> <span class="main">+</span> <span class="free">f</span> <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{..&lt;</span> <span class="numeral">2</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="main">0</span><span class="main">,</span> Suc <span class="main">0</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Language_Semantics-inj_Plus"><span class="command">lemma</span></span> inj_Plus<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="quoted"><span class="quoted">"inj <span class="main">(</span><span class="main">(+)</span> <span class="main">(</span><span class="free">a</span><span class="main">::</span>nat<span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> inj_on_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Language_Semantics-inj_on_Plus"><span class="command">lemma</span></span> inj_on_Plus<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="quoted"><span class="quoted">"inj_on <span class="main">(</span><span class="main">(+)</span> <span class="main">(</span><span class="free">a</span><span class="main">::</span>nat<span class="main">)</span><span class="main">)</span> <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> inj_on_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Language_Semantics-Plus_int"><span class="command">lemma</span></span> Plus_int<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span> <span class="main">::</span> <span class="quoted">nat</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(+)</span> <span class="free">b</span> <span class="main">`</span> <span class="main">{..&lt;</span> <span class="free">a</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="free">b</span> <span class="main">..&lt;</span> <span class="free">b</span> <span class="main">+</span> <span class="free">a</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span><span class="main">::</span><span class="quoted">nat</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span><span class="free">b</span><span class="main">..&lt;</span> <span class="free">b</span> <span class="main">+</span> <span class="free">a</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">≤</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&lt;</span> <span class="free">a</span> <span class="main">+</span> <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> xb<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="free">b</span> <span class="main">+</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> le_iff_add<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">&lt;</span> <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> x <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">(+)</span> <span class="free">b</span> <span class="main">`</span> <span class="main">{..&lt;</span><span class="free">a</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> xb <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Language_Semantics-sum_minus"><span class="command">lemma</span></span> sum_minus<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span> <span class="main">::</span> <span class="quoted">nat</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sum <span class="free">f</span> <span class="main">{</span><span class="free">a</span> <span class="main">..&lt;</span> <span class="free">a</span> <span class="main">+</span> <span class="free">b</span><span class="main">}</span> <span class="main">=</span> sum <span class="main">(</span><span class="main">%</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="free">a</span> <span class="main">+</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">{..&lt;</span> <span class="free">b</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> sum.reindex<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(+)</span> <span class="free">a</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">{..&lt;</span> <span class="free">b</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="free">f</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Language_Semantics-sum_Un_introL"><span class="command">lemma</span></span> sum_Un_introL<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A1</span> <span class="main">=</span> <span class="free">B1</span> <span class="keyword1">Un</span> <span class="free">C1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="free">x1</span> <span class="main">+</span> <span class="free">x2</span>"</span></span>
<span class="quoted"><span class="quoted">"finite <span class="free">A1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
<span class="quoted"><span class="quoted">"<span class="free">B1</span> <span class="keyword1">Int</span> <span class="free">C1</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
<span class="quoted"><span class="quoted">"sum <span class="free">f1</span> <span class="free">B1</span> <span class="main">=</span> <span class="free">x1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"sum <span class="free">f1</span> <span class="free">C1</span> <span class="main">=</span> <span class="free">x2</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sum <span class="free">f1</span> <span class="free">A1</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms finite_Un sum.union_disjoint<span class="main">)</span>

<span class="keyword1" id="Language_Semantics-sum_Un_intro"><span class="command">lemma</span></span> sum_Un_intro<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A1</span> <span class="main">=</span> <span class="free">B1</span> <span class="keyword1">Un</span> <span class="free">C1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">A2</span> <span class="main">=</span> <span class="free">B2</span> <span class="keyword1">Un</span> <span class="free">C2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
<span class="quoted"><span class="quoted">"finite <span class="free">A1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
<span class="quoted"><span class="quoted">"<span class="free">B1</span> <span class="keyword1">Int</span> <span class="free">C1</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">B2</span> <span class="keyword1">Int</span> <span class="free">C2</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
<span class="quoted"><span class="quoted">"sum <span class="free">f1</span> <span class="free">B1</span> <span class="main">=</span> sum <span class="free">f2</span> <span class="free">B2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"sum <span class="free">f1</span> <span class="free">C1</span> <span class="main">=</span> sum <span class="free">f2</span> <span class="free">C2</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sum <span class="free">f1</span> <span class="free">A1</span> <span class="main">=</span> sum <span class="free">f2</span> <span class="free">A2</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms finite_Un sum.union_disjoint<span class="main">)</span>

<span class="keyword1" id="Language_Semantics-sum_UN_introL"><span class="command">lemma</span></span> sum_UN_introL<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> A1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A1</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">UN</span> <span class="bound">n</span> <span class="main">:</span> <span class="free">N</span><span class="main">.</span> <span class="free">B1</span> <span class="bound">n</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> a2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a2</span> <span class="main">=</span> sum <span class="free">b2</span> <span class="free">N</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
fin<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">N</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">∈</span> <span class="free">N</span> <span class="main">⟹</span> finite <span class="main">(</span><span class="free">B1</span> <span class="bound">n</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
int<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">m</span> <span class="bound">n</span><span class="main">.</span> <span class="main">{</span><span class="bound">m</span><span class="main">,</span> <span class="bound">n</span><span class="main">}</span> <span class="main">⊆</span> <span class="free">N</span> <span class="main">∧</span> <span class="bound">m</span> <span class="main">≠</span> <span class="bound">n</span> <span class="main">⟹</span> <span class="free">B1</span> <span class="bound">m</span> <span class="main">∩</span> <span class="free">B1</span> <span class="bound">n</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
ss<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">∈</span> <span class="free">N</span> <span class="main">⟹</span> sum <span class="free">f1</span> <span class="main">(</span><span class="free">B1</span> <span class="bound">n</span><span class="main">)</span> <span class="main">=</span> <span class="free">b2</span> <span class="bound">n</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sum <span class="free">f1</span> <span class="free">A1</span> <span class="main">=</span> <span class="free">a2</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">=</span> <span class="free">a2</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">=</span> sum <span class="main">(</span><span class="main">%</span><span class="bound">n</span><span class="main">.</span> sum <span class="free">f1</span> <span class="main">(</span><span class="free">B1</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span> <span class="free">N</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> A1 <span class="keyword1"><span class="command">using</span></span> sum.UNION_disjoint<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">N</span></span> <span class="quoted"><span class="free">B1</span></span> <span class="quoted"><span class="free">f1</span></span><span class="main">]</span> fin int <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> sum <span class="free">b2</span> <span class="free">N</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ss fin <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="free">a2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> a2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Language_Semantics-sum_UN_intro"><span class="command">lemma</span></span> sum_UN_intro<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> A1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A1</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">UN</span> <span class="bound">n</span> <span class="main">:</span> <span class="free">N</span><span class="main">.</span> <span class="free">B1</span> <span class="bound">n</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> A2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A2</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">UN</span> <span class="bound">n</span> <span class="main">:</span> <span class="free">N</span><span class="main">.</span> <span class="free">B2</span> <span class="bound">n</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
fin<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">N</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">∈</span> <span class="free">N</span> <span class="main">⟹</span> finite <span class="main">(</span><span class="free">B1</span> <span class="bound">n</span><span class="main">)</span> <span class="main">∧</span> finite <span class="main">(</span><span class="free">B2</span> <span class="bound">n</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
int<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">m</span> <span class="bound">n</span><span class="main">.</span> <span class="main">{</span><span class="bound">m</span><span class="main">,</span> <span class="bound">n</span><span class="main">}</span> <span class="main">⊆</span> <span class="free">N</span> <span class="main">∧</span> <span class="bound">m</span> <span class="main">≠</span> <span class="bound">n</span> <span class="main">⟹</span> <span class="free">B1</span> <span class="bound">m</span> <span class="main">∩</span> <span class="free">B1</span> <span class="bound">n</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">m</span> <span class="bound">n</span><span class="main">.</span> <span class="main">{</span><span class="bound">m</span><span class="main">,</span> <span class="bound">n</span><span class="main">}</span> <span class="main">⊆</span> <span class="free">N</span> <span class="main">⟹</span> <span class="free">B2</span> <span class="bound">m</span> <span class="main">∩</span> <span class="free">B2</span> <span class="bound">n</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
ss<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">∈</span> <span class="free">N</span> <span class="main">⟹</span> sum <span class="free">f1</span> <span class="main">(</span><span class="free">B1</span> <span class="bound">n</span><span class="main">)</span> <span class="main">=</span> sum <span class="free">f2</span> <span class="main">(</span><span class="free">B2</span> <span class="bound">n</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sum <span class="free">f1</span> <span class="free">A1</span> <span class="main">=</span> sum <span class="free">f2</span> <span class="free">A2</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">=</span> <span class="var">?R</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">=</span> sum <span class="main">(</span><span class="main">%</span><span class="bound">n</span><span class="main">.</span> sum <span class="free">f1</span> <span class="main">(</span><span class="free">B1</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span> <span class="free">N</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> A1 <span class="keyword1"><span class="command">using</span></span> sum.UNION_disjoint<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">N</span></span> <span class="quoted"><span class="free">B1</span></span> <span class="quoted"><span class="free">f1</span></span><span class="main">]</span> fin int <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> sum <span class="main">(</span><span class="main">%</span><span class="bound">n</span><span class="main">.</span> sum <span class="free">f2</span> <span class="main">(</span><span class="free">B2</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span> <span class="free">N</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ss fin sum.mono_neutral_left <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="var">?R</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> A2 <span class="keyword1"><span class="command">using</span></span> sum.UNION_disjoint<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">N</span></span> <span class="quoted"><span class="free">B2</span></span> <span class="quoted"><span class="free">f2</span></span><span class="main">]</span> fin int <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Language_Semantics-sum_Minus_intro"><span class="command">lemma</span></span> sum_Minus_intro<span class="main">:</span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a1</span> <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">f2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a2</span> <span class="main">⇒</span> real"</span></span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">B1</span> <span class="main">=</span> <span class="free">A1</span> <span class="main">-</span> <span class="main">{</span><span class="free">a1</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">B2</span> <span class="main">=</span> <span class="free">A2</span> <span class="main">-</span> <span class="main">{</span><span class="free">a2</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
<span class="quoted"><span class="quoted">"<span class="free">a1</span> <span class="main">:</span> <span class="free">A1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">a2</span> <span class="main">:</span> <span class="free">A2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A2</span>"</span></span>
<span class="quoted"><span class="quoted">"sum <span class="free">f1</span> <span class="free">A1</span> <span class="main">=</span> sum <span class="free">f2</span> <span class="free">A2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">f1</span> <span class="free">a1</span> <span class="main">=</span> <span class="free">f2</span> <span class="free">a2</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sum <span class="free">f1</span> <span class="free">B1</span> <span class="main">=</span> sum <span class="free">f2</span> <span class="free">B2</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A1</span> <span class="main">=</span> <span class="free">B1</span> <span class="keyword1">Un</span> <span class="main">{</span><span class="free">a1</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A2</span> <span class="main">=</span> <span class="free">B2</span> <span class="keyword1">Un</span> <span class="main">{</span><span class="free">a2</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">a1</span> <span class="main">∉</span> <span class="free">B1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> 1 <span class="quoted"><span class="quoted">‹finite <span class="free">A1</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum <span class="free">f1</span> <span class="free">A1</span> <span class="main">=</span> sum <span class="free">f1</span> <span class="free">B1</span> <span class="main">+</span> <span class="free">f1</span> <span class="free">a1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"sum <span class="free">f1</span> <span class="free">B1</span> <span class="main">=</span> sum <span class="free">f1</span> <span class="free">A1</span> <span class="main">-</span> <span class="free">f1</span> <span class="free">a1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">a2</span> <span class="main">∉</span> <span class="free">B2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> 2 <span class="quoted"><span class="quoted">‹finite <span class="free">A2</span> ›</span></span><span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum <span class="free">f2</span> <span class="free">A2</span> <span class="main">=</span> sum <span class="free">f2</span> <span class="free">B2</span> <span class="main">+</span> <span class="free">f2</span> <span class="free">a2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"sum <span class="free">f2</span> <span class="free">B2</span> <span class="main">=</span> sum <span class="free">f2</span> <span class="free">A2</span> <span class="main">-</span> <span class="free">f2</span> <span class="free">a2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 3 assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Language_Semantics-sum_singl_intro"><span class="command">lemma</span></span> sum_singl_intro<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">=</span> <span class="free">f</span> <span class="free">a</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">a'</span><span class="main">.</span> <span class="main">⟦</span><span class="bound">a'</span> <span class="main">∈</span> <span class="free">A</span><span class="main">;</span> <span class="bound">a'</span> <span class="main">≠</span> <span class="free">a</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">a'</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sum <span class="free">f</span> <span class="free">A</span> <span class="main">=</span> <span class="free">b</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">B</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">=</span> <span class="free">A</span> <span class="main">-</span> <span class="main">{</span><span class="free">a</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">=</span> <span class="skolem">B</span> <span class="keyword1">Un</span> <span class="main">{</span><span class="free">a</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> B_def <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="keyword1">Int</span> <span class="main">{</span><span class="free">a</span><span class="main">}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> B_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum <span class="free">f</span> <span class="free">A</span> <span class="main">=</span> sum <span class="free">f</span> <span class="skolem">B</span> <span class="main">+</span> sum <span class="free">f</span> <span class="main">{</span><span class="free">a</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms sum.union_disjoint <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">b</span> <span class="main">∈</span> <span class="skolem">B</span><span class="main">.</span> <span class="free">f</span> <span class="bound">b</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> B_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Language_Semantics-sum_all0_intro"><span class="command">lemma</span></span> sum_all0_intro<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">a</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sum <span class="free">f</span> <span class="free">A</span> <span class="main">=</span> <span class="free">b</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">metis</span> assms sum.neutral sum.infinite<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="Language_Semantics-sum_1"><span class="command">lemma</span></span> sum_1<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">I</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ss<span class="main">:</span> <span class="quoted"><span class="quoted">"sum <span class="free">f</span> <span class="free">I</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> <span class="free">I</span> <span class="main">-</span> <span class="free">I1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> I1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I1</span> <span class="main">⊆</span> <span class="free">I</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">I</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">0</span><span class="main">::</span>real<span class="main">)</span> <span class="main">≤</span> <span class="free">f</span> <span class="bound">i</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">i</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">-</span> sum <span class="free">f</span> <span class="free">I1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum <span class="free">f</span> <span class="free">I</span> <span class="main">=</span> sum <span class="free">f</span> <span class="main">(</span><span class="main">{</span><span class="free">i</span><span class="main">}</span> <span class="keyword1">Un</span> <span class="main">(</span><span class="free">I</span> <span class="main">-</span> <span class="main">{</span><span class="free">i</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> i
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> DiffE insert_Diff_single insert_absorb insert_is_Un<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> sum <span class="free">f</span> <span class="main">{</span><span class="free">i</span><span class="main">}</span> <span class="main">+</span> sum <span class="free">f</span> <span class="main">(</span><span class="free">I</span> <span class="main">-</span> <span class="main">{</span><span class="free">i</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> sum.union_disjoint<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> I <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">=</span> <span class="free">f</span> <span class="free">i</span> <span class="main">+</span> sum <span class="free">f</span> <span class="main">(</span><span class="free">I</span> <span class="main">-</span> <span class="main">{</span><span class="free">i</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> ss<span class="main">[</span><span class="operator">THEN</span> sym<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum <span class="free">f</span> <span class="main">(</span><span class="free">I</span> <span class="main">-</span> <span class="main">{</span><span class="free">i</span><span class="main">}</span><span class="main">)</span> <span class="main">≥</span> sum <span class="free">f</span> <span class="free">I1</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> sum_mono2<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">≥</span> <span class="free">f</span> <span class="free">i</span> <span class="main">+</span> sum <span class="free">f</span> <span class="free">I1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Syntax›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="main">(</span><span class="tfree">'test</span><span class="main">,</span> <span class="tfree">'atom</span><span class="main">,</span> <span class="tfree">'choice</span><span class="main">)</span> cmd <span class="main">=</span>
  Done
<span class="main">|</span> Atm <span class="quoted"><span class="quoted">"<span class="tfree">'atom</span>"</span></span>
<span class="main">|</span> Seq <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'test</span><span class="main">,</span> <span class="tfree">'atom</span><span class="main">,</span> <span class="tfree">'choice</span><span class="main">)</span> cmd"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'test</span><span class="main">,</span> <span class="tfree">'atom</span><span class="main">,</span> <span class="tfree">'choice</span><span class="main">)</span> cmd"</span></span> <span class="main">(</span><span class="quoted">"_ <span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">;;</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> _"</span>  <span class="main">[</span>60<span class="main">,</span> 61<span class="main">]</span> 60<span class="main">)</span>
<span class="main">|</span> While <span class="quoted"><span class="quoted">"<span class="tfree">'test</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'test</span><span class="main">,</span> <span class="tfree">'atom</span><span class="main">,</span> <span class="tfree">'choice</span><span class="main">)</span> cmd"</span></span>
<span class="main">|</span> Ch <span class="tfree"><span class="quoted"><span class="tfree">'choice</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'test</span><span class="main">,</span> <span class="tfree">'atom</span><span class="main">,</span> <span class="tfree">'choice</span><span class="main">)</span> cmd"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'test</span><span class="main">,</span> <span class="tfree">'atom</span><span class="main">,</span> <span class="tfree">'choice</span><span class="main">)</span> cmd"</span></span>
<span class="main">|</span> Par <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'test</span><span class="main">,</span> <span class="tfree">'atom</span><span class="main">,</span> <span class="tfree">'choice</span><span class="main">)</span> cmd list"</span></span>
<span class="main">|</span> ParT <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'test</span><span class="main">,</span> <span class="tfree">'atom</span><span class="main">,</span> <span class="tfree">'choice</span><span class="main">)</span> cmd list"</span></span>

<span class="comment1">(* Commands containing no while loops: *)</span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">noWhile</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">noWhile</span> Done <span class="main">⟷</span> True"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">noWhile</span> <span class="main">(</span>Atm <span class="free"><span class="bound"><span class="entity">atm</span></span></span><span class="main">)</span> <span class="main">⟷</span> True"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">noWhile</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="main">;;</span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span><span class="main">)</span> <span class="main">⟷</span> <span class="free">noWhile</span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="main">∧</span> <span class="free">noWhile</span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">noWhile</span> <span class="main">(</span>While <span class="free"><span class="bound"><span class="entity">tst</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="main">⟷</span> False"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">noWhile</span> <span class="main">(</span>Ch <span class="free"><span class="bound"><span class="entity">ch</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span><span class="main">)</span> <span class="main">⟷</span> <span class="free">noWhile</span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="main">∧</span> <span class="free">noWhile</span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">noWhile</span> <span class="main">(</span>Par <span class="free"><span class="bound"><span class="entity">cl</span></span></span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">c</span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">cl</span></span></span><span class="main">.</span> <span class="free">noWhile</span> <span class="bound">c</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">noWhile</span> <span class="main">(</span>ParT <span class="free"><span class="bound"><span class="entity">cl</span></span></span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">c</span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">cl</span></span></span><span class="main">.</span> <span class="free">noWhile</span> <span class="bound">c</span><span class="main">)</span>"</span></span>

<span class="comment1">(* ``Finished" commands: *)</span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">finished</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">finished</span> Done <span class="main">⟷</span> True"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">finished</span> <span class="main">(</span>Atm <span class="free"><span class="bound"><span class="entity">atm</span></span></span><span class="main">)</span> <span class="main">⟷</span> False"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">finished</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="main">;;</span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span><span class="main">)</span> <span class="main">⟷</span> False"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">finished</span> <span class="main">(</span>While <span class="free"><span class="bound"><span class="entity">tst</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="main">⟷</span> False"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">finished</span> <span class="main">(</span>Ch <span class="free"><span class="bound"><span class="entity">ch</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span><span class="main">)</span> <span class="main">⟷</span> False"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">finished</span> <span class="main">(</span>Par <span class="free"><span class="bound"><span class="entity">cl</span></span></span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">c</span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">cl</span></span></span><span class="main">.</span> <span class="free">finished</span> <span class="bound">c</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">finished</span> <span class="main">(</span>ParT <span class="free"><span class="bound"><span class="entity">cl</span></span></span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">c</span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">cl</span></span></span><span class="main">.</span> <span class="free">finished</span> <span class="bound">c</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">noWhileL</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">noWhileL</span> <span class="free"><span class="bound"><span class="entity">cl</span></span></span> <span class="main">≡</span> <span class="main">∀</span> <span class="bound">c</span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">cl</span></span></span><span class="main">.</span> noWhile <span class="bound">c</span>"</span></span>

<span class="keyword1" id="Language_Semantics-fin_Par_noWhileL"><span class="command">lemma</span></span> fin_Par_noWhileL<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="quoted"><span class="quoted">"noWhile <span class="main">(</span>Par <span class="free">cl</span><span class="main">)</span> <span class="main">⟷</span> noWhileL <span class="free">cl</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> noWhileL_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Language_Semantics-fin_ParT_noWhileL"><span class="command">lemma</span></span> fin_ParT_noWhileL<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="quoted"><span class="quoted">"noWhile <span class="main">(</span>ParT <span class="free">cl</span><span class="main">)</span> <span class="main">⟷</span> noWhileL <span class="free">cl</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> noWhileL_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">declare</span></span> noWhile.simps<span class="main">(</span>6<span class="main">)</span> <span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> noWhile.simps<span class="main">(</span>7<span class="main">)</span> <span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>

<span class="keyword1" id="Language_Semantics-noWhileL_intro"><span class="command">lemma</span></span> noWhileL_intro<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">c</span><span class="main">.</span> <span class="bound">c</span> <span class="main">∈</span> set <span class="free">cl</span> <span class="main">⟹</span> noWhile <span class="bound">c</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"noWhileL <span class="free">cl</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> noWhileL_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Language_Semantics-noWhileL_fin"><span class="command">lemma</span></span> noWhileL_fin<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"noWhileL <span class="free">cl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">∈</span> set <span class="free">cl</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"noWhile <span class="free">c</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> noWhileL_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Language_Semantics-noWhileL_update"><span class="command">lemma</span></span> noWhileL_update<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> cl<span class="main">:</span> <span class="quoted"><span class="quoted">"noWhileL <span class="free">cl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> c'<span class="main">:</span> <span class="quoted"><span class="quoted">"noWhile <span class="free">c'</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"noWhileL <span class="main">(</span><span class="free">cl</span><span class="main">[</span><span class="free">n</span> <span class="main">:=</span> <span class="free">c'</span><span class="main">]</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&lt;</span> length <span class="free">cl</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> noWhileL_def <span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">c</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">cl</span><span class="main">[</span><span class="free">n</span> <span class="main">:=</span> <span class="free">c'</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">∈</span> insert <span class="free">c'</span> <span class="main">(</span>set <span class="free">cl</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> set_update_subset_insert <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"noWhile <span class="skolem">c</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">=</span> <span class="free">c'</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> cl<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">finishedL</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">finishedL</span> <span class="free"><span class="bound"><span class="entity">cl</span></span></span> <span class="main">≡</span> <span class="main">∀</span> <span class="bound">c</span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">cl</span></span></span><span class="main">.</span> finished <span class="bound">c</span>"</span></span>

<span class="keyword1" id="Language_Semantics-finished_Par_finishedL"><span class="command">lemma</span></span> finished_Par_finishedL<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="quoted"><span class="quoted">"finished <span class="main">(</span>Par <span class="free">cl</span><span class="main">)</span> <span class="main">⟷</span> finishedL <span class="free">cl</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> finishedL_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Language_Semantics-finished_ParT_finishedL"><span class="command">lemma</span></span> finished_ParT_finishedL<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="quoted"><span class="quoted">"finished <span class="main">(</span>ParT <span class="free">cl</span><span class="main">)</span> <span class="main">⟷</span> finishedL <span class="free">cl</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> finishedL_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">declare</span></span> finished.simps<span class="main">(</span>6<span class="main">)</span> <span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> finished.simps<span class="main">(</span>7<span class="main">)</span> <span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>

<span class="keyword1" id="Language_Semantics-finishedL_intro"><span class="command">lemma</span></span> finishedL_intro<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">c</span><span class="main">.</span> <span class="bound">c</span> <span class="main">∈</span> set <span class="free">cl</span> <span class="main">⟹</span> finished <span class="bound">c</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finishedL <span class="free">cl</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> finishedL_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Language_Semantics-finishedL_finished"><span class="command">lemma</span></span> finishedL_finished<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finishedL <span class="free">cl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">∈</span> set <span class="free">cl</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finished <span class="free">c</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> finishedL_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Language_Semantics-finishedL_update"><span class="command">lemma</span></span> finishedL_update<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> cl<span class="main">:</span> <span class="quoted"><span class="quoted">"finishedL <span class="free">cl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> c'<span class="main">:</span> <span class="quoted"><span class="quoted">"finished <span class="free">c'</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finishedL <span class="main">(</span><span class="free">cl</span><span class="main">[</span><span class="free">n</span> <span class="main">:=</span> <span class="free">c'</span><span class="main">]</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&lt;</span> length <span class="free">cl</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> finishedL_def <span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">c</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">cl</span><span class="main">[</span><span class="free">n</span> <span class="main">:=</span> <span class="free">c'</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">∈</span> insert <span class="free">c'</span> <span class="main">(</span>set <span class="free">cl</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> set_update_subset_insert <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"finished <span class="skolem">c</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">=</span> <span class="free">c'</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> cl<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Language_Semantics-finished_fin"><span class="command">lemma</span></span> finished_fin<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="quoted"><span class="quoted">"finished <span class="free">c</span> <span class="main">⟹</span> noWhile <span class="free">c</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">c</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Language_Semantics-finishedL_noWhileL"><span class="command">lemma</span></span> finishedL_noWhileL<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="quoted"><span class="quoted">"finishedL <span class="free">cl</span> <span class="main">⟹</span> noWhileL <span class="free">cl</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> finishedL_def noWhileL_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">locale</span></span> PL <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span>
    <span class="free">aval</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'atom</span> <span class="main">⇒</span> <span class="tfree">'state</span> <span class="main">⇒</span> <span class="tfree">'state</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">tval</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'test</span> <span class="main">⇒</span> <span class="tfree">'state</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">cval</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'choice</span> <span class="main">⇒</span> <span class="tfree">'state</span> <span class="main">⇒</span> real"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    properCh<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">ch</span> <span class="bound">s</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="free">cval</span> <span class="bound">ch</span> <span class="bound">s</span> <span class="main">∧</span> <span class="free">cval</span> <span class="bound">ch</span> <span class="bound">s</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">n</span><span class="main">::</span>nat<span class="main">)</span> <span class="main">&lt;</span> <span class="free">N</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">/</span> <span class="free">N</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">n</span><span class="main">::</span>nat<span class="main">)</span> <span class="main">&lt;</span> <span class="free">N</span> <span class="main">⟹</span> <span class="main">1</span> <span class="main">/</span> <span class="free">N</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">n</span><span class="main">::</span>nat<span class="main">)</span> <span class="main">&lt;</span> <span class="free">N</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">-</span> <span class="main">1</span> <span class="main">/</span> <span class="free">N</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">divide_simps</span></span><span class="main">)</span>

<span class="keyword1" id="Language_Semantics-sum_equal"><span class="command">lemma</span></span> sum_equal<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="main">(</span><span class="free">N</span><span class="main">::</span>nat<span class="main">)</span> <span class="main">⟹</span> sum <span class="main">(</span><span class="main">λ</span> <span class="bound">n</span><span class="main">.</span> <span class="main">1</span><span class="main">/</span><span class="free">N</span><span class="main">)</span> <span class="main">{..&lt;</span> <span class="free">N</span><span class="main">}</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> sum_constant <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">proper</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">proper</span> Done <span class="main">⟷</span> True"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">proper</span> <span class="main">(</span>Atm <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">⟷</span> True"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">proper</span> <span class="main">(</span>Seq <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span><span class="main">)</span> <span class="main">⟷</span> <span class="free">proper</span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="main">∧</span> <span class="free">proper</span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">proper</span> <span class="main">(</span>While <span class="free"><span class="bound"><span class="entity">tst</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="main">⟷</span> <span class="free">proper</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">proper</span> <span class="main">(</span>Ch <span class="free"><span class="bound"><span class="entity">ch</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span><span class="main">)</span> <span class="main">⟷</span> <span class="free">proper</span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="main">∧</span> <span class="free">proper</span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">proper</span> <span class="main">(</span>Par <span class="free"><span class="bound"><span class="entity">cl</span></span></span><span class="main">)</span> <span class="main">⟷</span> <span class="free"><span class="bound"><span class="entity">cl</span></span></span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">c</span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">cl</span></span></span><span class="main">.</span> <span class="free">proper</span> <span class="bound">c</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">proper</span> <span class="main">(</span>ParT <span class="free"><span class="bound"><span class="entity">cl</span></span></span><span class="main">)</span> <span class="main">⟷</span> <span class="free"><span class="bound"><span class="entity">cl</span></span></span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">c</span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">cl</span></span></span><span class="main">.</span> <span class="free">proper</span> <span class="bound">c</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">properL</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">properL</span> <span class="free"><span class="bound"><span class="entity">cl</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">cl</span></span></span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">c</span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">cl</span></span></span><span class="main">.</span> proper <span class="bound">c</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Language_Semantics-proper_Par_properL"><span class="command">lemma</span></span> proper_Par_properL<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="quoted"><span class="quoted">"proper <span class="main">(</span>Par <span class="free">cl</span><span class="main">)</span> <span class="main">⟷</span> properL <span class="free">cl</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> properL_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Language_Semantics-proper_ParT_properL"><span class="command">lemma</span></span> proper_ParT_properL<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="quoted"><span class="quoted">"proper <span class="main">(</span>ParT <span class="free">cl</span><span class="main">)</span> <span class="main">⟷</span> properL <span class="free">cl</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> properL_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">declare</span></span> proper.simps<span class="main">(</span>6<span class="main">)</span> <span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> proper.simps<span class="main">(</span>7<span class="main">)</span> <span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>

<span class="keyword1" id="Language_Semantics-properL_intro"><span class="command">lemma</span></span> properL_intro<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">cl</span> <span class="main">≠</span> <span class="main">[]</span><span class="main">;</span> <span class="main">⋀</span> <span class="bound">c</span><span class="main">.</span> <span class="bound">c</span> <span class="main">∈</span> set <span class="free">cl</span> <span class="main">⟹</span> proper <span class="bound">c</span><span class="main">⟧</span> <span class="main">⟹</span> properL <span class="free">cl</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> properL_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Language_Semantics-properL_notEmp"><span class="command">lemma</span></span> properL_notEmp<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"properL <span class="free">cl</span> <span class="main">⟹</span> <span class="free">cl</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> properL_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Language_Semantics-properL_proper"><span class="command">lemma</span></span> properL_proper<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="main">⟦</span>properL <span class="free">cl</span><span class="main">;</span> <span class="free">c</span> <span class="main">∈</span> set <span class="free">cl</span><span class="main">⟧</span> <span class="main">⟹</span> proper <span class="free">c</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> properL_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Language_Semantics-properL_update"><span class="command">lemma</span></span> properL_update<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> cl<span class="main">:</span> <span class="quoted"><span class="quoted">"properL <span class="free">cl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> c'<span class="main">:</span> <span class="quoted"><span class="quoted">"proper <span class="free">c'</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"properL <span class="main">(</span><span class="free">cl</span><span class="main">[</span><span class="free">n</span> <span class="main">:=</span> <span class="free">c'</span><span class="main">]</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&lt;</span> length <span class="free">cl</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> properL_def <span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">c</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">cl</span><span class="main">[</span><span class="free">n</span> <span class="main">:=</span> <span class="free">c'</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">∈</span> insert <span class="free">c'</span> <span class="main">(</span>set <span class="free">cl</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> set_update_subset_insert <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"proper <span class="skolem">c</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">=</span> <span class="free">c'</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> cl<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> cl<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Language_Semantics-proper_induct"><span class="command">lemma</span></span> proper_induct<span class="main">[</span><span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">case_names</span> Done Atm Seq While Ch Par ParT<span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"proper <span class="free">c</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> Done<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">phi</span> Done"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> Atm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">atm</span><span class="main">.</span> <span class="free">phi</span> <span class="main">(</span>Atm <span class="bound">atm</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> Seq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">c1</span> <span class="bound">c2</span><span class="main">.</span> <span class="main">⟦</span><span class="free">phi</span> <span class="bound">c1</span><span class="main">;</span> <span class="free">phi</span> <span class="bound">c2</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">phi</span> <span class="main">(</span><span class="bound">c1</span> <span class="main">;;</span> <span class="bound">c2</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> While<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">tst</span> <span class="bound">c</span><span class="main">.</span> <span class="free">phi</span> <span class="bound">c</span> <span class="main">⟹</span> <span class="free">phi</span> <span class="main">(</span>While <span class="bound">tst</span> <span class="bound">c</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> Ch<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">ch</span> <span class="bound">c1</span> <span class="bound">c2</span><span class="main">.</span> <span class="main">⟦</span><span class="free">phi</span> <span class="bound">c1</span><span class="main">;</span> <span class="free">phi</span> <span class="bound">c2</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">phi</span> <span class="main">(</span>Ch <span class="bound">ch</span> <span class="bound">c1</span> <span class="bound">c2</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> Par<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">cl</span><span class="main">.</span> <span class="main">⟦</span>properL <span class="bound">cl</span><span class="main">;</span> <span class="main">⋀</span> <span class="bound">c</span><span class="main">.</span> <span class="bound">c</span> <span class="main">∈</span> set <span class="bound">cl</span> <span class="main">⟹</span> <span class="free">phi</span> <span class="bound">c</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">phi</span> <span class="main">(</span>Par <span class="bound">cl</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> ParT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">cl</span><span class="main">.</span> <span class="main">⟦</span>properL <span class="bound">cl</span><span class="main">;</span> <span class="main">⋀</span> <span class="bound">c</span><span class="main">.</span> <span class="bound">c</span> <span class="main">∈</span> set <span class="bound">cl</span> <span class="main">⟹</span> <span class="free">phi</span> <span class="bound">c</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">phi</span> <span class="main">(</span>ParT <span class="bound">cl</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">phi</span> <span class="free">c</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">c</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> properL_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Operational Small-Step Semantics›</span></span>

<span class="comment1">(* "The Finished Threads": The sublist of finished threads from a list of threads  *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">theFT</span> <span class="free"><span class="bound"><span class="entity">cl</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> length <span class="free"><span class="bound"><span class="entity">cl</span></span></span> <span class="main">∧</span> finished <span class="main">(</span><span class="free"><span class="bound"><span class="entity">cl</span></span></span><span class="main">!</span><span class="bound">n</span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="comment1">(* "The NopnFinished Threads": *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">theNFT</span> <span class="free"><span class="bound"><span class="entity">cl</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> length <span class="free"><span class="bound"><span class="entity">cl</span></span></span> <span class="main">∧</span> <span class="main">¬</span> finished <span class="main">(</span><span class="free"><span class="bound"><span class="entity">cl</span></span></span><span class="main">!</span><span class="bound">n</span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1" id="Language_Semantics-finite_theFT"><span class="command">lemma</span></span> finite_theFT<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>theFT <span class="free">cl</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> theFT_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Language_Semantics-theFT_length"><span class="command">lemma</span></span> theFT_length<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">∈</span> theFT <span class="free">cl</span> <span class="main">⟹</span> <span class="free">n</span> <span class="main">&lt;</span> length <span class="free">cl</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> theFT_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Language_Semantics-theFT_finished"><span class="command">lemma</span></span> theFT_finished<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">∈</span> theFT <span class="free">cl</span> <span class="main">⟹</span> finished <span class="main">(</span><span class="free">cl</span><span class="main">!</span><span class="free">n</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> theFT_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Language_Semantics-finite_theNFT"><span class="command">lemma</span></span> finite_theNFT<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>theNFT <span class="free">cl</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> theNFT_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Language_Semantics-theNFT_length"><span class="command">lemma</span></span> theNFT_length<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">∈</span> theNFT <span class="free">cl</span> <span class="main">⟹</span> <span class="free">n</span> <span class="main">&lt;</span> length <span class="free">cl</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> theNFT_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Language_Semantics-theNFT_notFinished"><span class="command">lemma</span></span> theNFT_notFinished<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">∈</span> theNFT <span class="free">cl</span> <span class="main">⟹</span> <span class="main">¬</span> finished <span class="main">(</span><span class="free">cl</span><span class="main">!</span><span class="free">n</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> theNFT_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Language_Semantics-theFT_Int_theNFT"><span class="command">lemma</span></span> theFT_Int_theNFT<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="quoted"><span class="quoted">"theFT <span class="free">cl</span> <span class="keyword1">Int</span> theNFT <span class="free">cl</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"theNFT <span class="free">cl</span> <span class="keyword1">Int</span> theFT <span class="free">cl</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> theFT_def theNFT_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Language_Semantics-theFT_Un_theNFT"><span class="command">lemma</span></span> theFT_Un_theNFT<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="quoted"><span class="quoted">"theFT <span class="free">cl</span> <span class="keyword1">Un</span> theNFT <span class="free">cl</span> <span class="main">=</span> <span class="main">{..&lt;</span> length <span class="free">cl</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
<span class="quoted"><span class="quoted">"theNFT <span class="free">cl</span> <span class="keyword1">Un</span> theFT <span class="free">cl</span> <span class="main">=</span> <span class="main">{..&lt;</span> length <span class="free">cl</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> theFT_def theNFT_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Language_Semantics-in_theFT_theNFT"><span class="command">lemma</span></span> in_theFT_theNFT<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">n1</span> <span class="main">∈</span> theFT <span class="free">cl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">n2</span> <span class="main">∈</span> theNFT <span class="free">cl</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">n1</span> <span class="main">≠</span> <span class="free">n2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">n2</span> <span class="main">≠</span> <span class="free">n1</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms theFT_Int_theNFT <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>

<span class="comment1">(* The cumulated weight of the finished threads: *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">WtFT</span> <span class="free"><span class="bound"><span class="entity">cl</span></span></span> <span class="main">≡</span> sum <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">n</span><span class="main">::</span>nat<span class="main">)</span><span class="main">.</span> <span class="main">1</span><span class="main">/</span><span class="main">(</span>length <span class="free"><span class="bound"><span class="entity">cl</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>theFT <span class="free"><span class="bound"><span class="entity">cl</span></span></span><span class="main">)</span>"</span></span>

<span class="comment1">(* The cumulated weight of the non-finished threads: *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">WtNFT</span> <span class="free"><span class="bound"><span class="entity">cl</span></span></span> <span class="main">≡</span> sum <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">n</span><span class="main">::</span>nat<span class="main">)</span><span class="main">.</span> <span class="main">1</span><span class="main">/</span><span class="main">(</span>length <span class="free"><span class="bound"><span class="entity">cl</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>theNFT <span class="free"><span class="bound"><span class="entity">cl</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Language_Semantics-WtFT_WtNFT"><span class="command">lemma</span></span> WtFT_WtNFT<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> length <span class="free">cl</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"WtFT <span class="free">cl</span> <span class="main">+</span> WtNFT <span class="free">cl</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?A</span> <span class="main">=</span> <span class="main">1</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?w</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">n</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> length <span class="free">cl</span>"</span></span> <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?L</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"theFT <span class="free">cl</span>"</span></span> <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Lnot</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"theNFT <span class="free">cl</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{..&lt;</span> length <span class="free">cl</span><span class="main">}</span> <span class="main">=</span> <span class="var">?L</span> <span class="keyword1">Un</span> <span class="var">?Lnot</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?A</span> <span class="main">=</span> sum <span class="var">?w</span> <span class="var">?L</span> <span class="main">+</span> sum <span class="var">?w</span> <span class="var">?Lnot</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> WtFT_def WtNFT_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> sum <span class="var">?w</span> <span class="main">{..&lt;</span> length <span class="free">cl</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> 1
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> sum.union_disjoint<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> sym<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> sum_equal<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Language_Semantics-WtNFT_1_WtFT"><span class="command">lemma</span></span> WtNFT_1_WtFT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> length <span class="free">cl</span> <span class="main">⟹</span> WtNFT <span class="free">cl</span> <span class="main">=</span> <span class="main">1</span> <span class="main">-</span> WtFT <span class="free">cl</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>

<span class="keyword1" id="Language_Semantics-WtNFT_WtFT_1"><span class="command">lemma</span></span> WtNFT_WtFT_1<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> length <span class="free">cl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"WtFT <span class="free">cl</span> <span class="main">≠</span> <span class="main">1</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"WtNFT <span class="free">cl</span> <span class="main">/</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> WtFT <span class="free">cl</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?A</span> <span class="main">/</span> <span class="var">?B</span> <span class="main">=</span> <span class="main">1</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?A</span> <span class="main">=</span> <span class="var">?B</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms WtNFT_1_WtFT <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> A <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Language_Semantics-WtFT_ge_0"><span class="command">lemma</span></span> WtFT_ge_0<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"WtFT <span class="free">cl</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> WtFT_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum_nonneg<span class="main">)</span> <span class="operator">simp</span>

<span class="keyword1" id="Language_Semantics-WtFT_le_1"><span class="command">lemma</span></span> WtFT_le_1<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"WtFT <span class="free">cl</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">≤</span> <span class="main">1</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?N</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"length <span class="free">cl</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">≤</span> sum <span class="main">(</span><span class="main">λ</span> <span class="bound">n</span><span class="main">::</span>nat<span class="main">.</span> <span class="main">1</span><span class="main">/</span><span class="var">?N</span><span class="main">)</span> <span class="main">{..&lt;</span> <span class="var">?N</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> WtFT_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> sum_mono2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> div_by_0 le_cases neq0_conv not_one_le_zero of_nat_0 sum.neutral sum_equal<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Language_Semantics-le_1_WtFT"><span class="command">lemma</span></span> le_1_WtFT<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">-</span> WtFT <span class="free">cl</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="var">?R</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="main">1</span> <span class="main">≤</span> <span class="main">-</span> WtFT <span class="free">cl</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">0</span> <span class="main">::</span> real<span class="main">)</span> <span class="main">=</span> <span class="main">1</span> <span class="main">+</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">+</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">+</span> <span class="main">(</span><span class="main">-</span> WtFT <span class="free">cl</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> a <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="var">?R</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Language_Semantics-WtFT_lt_1"><span class="command">lemma</span></span> WtFT_lt_1<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"WtFT <span class="free">cl</span> <span class="main">≠</span> <span class="main">1</span> <span class="main">⟹</span> WtFT <span class="free">cl</span> <span class="main">&lt;</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> WtFT_le_1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> le_less<span class="main">)</span>

<span class="keyword1" id="Language_Semantics-lt_1_WtFT"><span class="command">lemma</span></span> lt_1_WtFT<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"WtFT <span class="free">cl</span> <span class="main">≠</span> <span class="main">1</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="main">1</span> <span class="main">-</span> WtFT <span class="free">cl</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> le_1_WtFT <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> le_1_WtFT eq_iff_diff_eq_0 less_eq_real_def<span class="main">)</span>

<span class="keyword1" id="Language_Semantics-notFinished_WtFT"><span class="command">lemma</span></span> notFinished_WtFT<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&lt;</span> length <span class="free">cl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> finished <span class="main">(</span><span class="free">cl</span> <span class="main">!</span> <span class="free">n</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">/</span> length <span class="free">cl</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">-</span> WtFT <span class="free">cl</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> length <span class="free">cl</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> WtFT_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">intro</span> sum_1<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">{..&lt;</span></span> length <span class="free"><span class="free">cl</span></span><span class="main"><span class="main">}</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* The branching of a command: *)</span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">brn</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'test</span><span class="main">,</span> <span class="tfree">'atom</span><span class="main">,</span> <span class="tfree">'choice</span><span class="main">)</span> cmd <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">brn</span> Done <span class="main">=</span> <span class="main">1</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">brn</span> <span class="main">(</span>Atm <span class="free"><span class="bound"><span class="entity">atm</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">brn</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="main">;;</span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">brn</span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">brn</span> <span class="main">(</span>While <span class="free"><span class="bound"><span class="entity">tst</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">brn</span> <span class="main">(</span>Ch <span class="free"><span class="bound"><span class="entity">ch</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">brn</span> <span class="main">(</span>Par <span class="free"><span class="bound"><span class="entity">cl</span></span></span><span class="main">)</span> <span class="main">=</span> lsum <span class="free">brn</span> <span class="free"><span class="bound"><span class="entity">cl</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">brn</span> <span class="main">(</span>ParT <span class="free"><span class="bound"><span class="entity">cl</span></span></span><span class="main">)</span> <span class="main">=</span> lsum <span class="free">brn</span> <span class="free"><span class="bound"><span class="entity">cl</span></span></span>"</span></span>

<span class="keyword1" id="Language_Semantics-brn_gt_0"><span class="command">lemma</span></span> brn_gt_0<span class="main">:</span> <span class="quoted"><span class="quoted">"proper <span class="free">c</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">&lt;</span> brn <span class="free">c</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> proper_induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Language_Semantics-brn_gt_0_L"><span class="command">lemma</span></span> brn_gt_0_L<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>properL <span class="free">cl</span><span class="main">;</span> <span class="free">c</span> <span class="main">∈</span> set <span class="free">cl</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">&lt;</span> brn <span class="free">c</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> brn_gt_0 properL_def<span class="main">)</span>

<span class="comment1">(* The locate-thread and locate-index operators.
   Given a thread list cl with n = length cl and i &lt; (∑ l &lt; length cl . brn cl),
   (locateT cl i, locateI cl i) are (k, j) from the paper's Figure 1.
*)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">locateT</span> <span class="main">≡</span> locate1 brn"</span></span>   <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">locateI</span> <span class="main">≡</span> locate2 brn"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">brnL</span> <span class="free"><span class="bound"><span class="entity">cl</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">≡</span> lsum brn <span class="main">(</span>take <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">cl</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Language_Semantics-brnL_lsum"><span class="command">lemma</span></span> brnL_lsum<span class="main">:</span> <span class="quoted"><span class="quoted">"brnL <span class="free">cl</span> <span class="main">(</span>length <span class="free">cl</span><span class="main">)</span> <span class="main">=</span> lsum brn <span class="free">cl</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> brnL_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Language_Semantics-brnL_unique"><span class="command">lemma</span></span> brnL_unique<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"properL <span class="free">cl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">n1</span> <span class="main">&lt;</span> length <span class="free">cl</span> <span class="main">∧</span> <span class="free">j1</span> <span class="main">&lt;</span> brn <span class="main">(</span><span class="free">cl</span> <span class="main">!</span> <span class="free">n1</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">n2</span> <span class="main">&lt;</span> length <span class="free">cl</span> <span class="main">∧</span> <span class="free">j2</span> <span class="main">&lt;</span> brn <span class="main">(</span><span class="free">cl</span> <span class="main">!</span> <span class="free">n2</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"brnL <span class="free">cl</span> <span class="free">n1</span> <span class="main">+</span> <span class="free">j1</span> <span class="main">=</span> brnL <span class="free">cl</span> <span class="free">n2</span> <span class="main">+</span> <span class="free">j2</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">n1</span> <span class="main">=</span> <span class="free">n2</span> <span class="main">∧</span> <span class="free">j1</span> <span class="main">=</span> <span class="free">j2</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> less_lsum_unique<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> assms brn_gt_0 <span class="keyword1"><span class="command">unfolding</span></span> brnL_def properL_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Language_Semantics-brn_Par_simp"><span class="command">lemma</span></span> brn_Par_simp<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"brn <span class="main">(</span>Par <span class="free">cl</span><span class="main">)</span> <span class="main">=</span> brnL <span class="free">cl</span> <span class="main">(</span>length <span class="free">cl</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> brnL_lsum <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Language_Semantics-brn_ParT_simp"><span class="command">lemma</span></span> brn_ParT_simp<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"brn <span class="main">(</span>ParT <span class="free">cl</span><span class="main">)</span> <span class="main">=</span> brnL <span class="free">cl</span> <span class="main">(</span>length <span class="free">cl</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> brnL_lsum <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">declare</span></span> brn.simps<span class="main">(</span>6<span class="main">)</span><span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>   <span class="keyword1"><span class="command">declare</span></span> brn.simps<span class="main">(</span>7<span class="main">)</span><span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>

<span class="keyword1" id="Language_Semantics-brnL_0"><span class="command">lemma</span></span> brnL_0<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"brnL <span class="free">cl</span> <span class="main">0</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> brnL_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Language_Semantics-brnL_Suc"><span class="command">lemma</span></span> brnL_Suc<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&lt;</span> length <span class="free">cl</span> <span class="main">⟹</span> brnL <span class="free">cl</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">=</span> brnL <span class="free">cl</span> <span class="free">n</span> <span class="main">+</span> brn <span class="main">(</span><span class="free">cl</span> <span class="main">!</span> <span class="free">n</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> brnL_def <span class="keyword1"><span class="command">using</span></span> take_Suc_conv_app_nth<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">cl</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Language_Semantics-brnL_mono"><span class="command">lemma</span></span> brnL_mono<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n1</span> <span class="main">≤</span> <span class="free">n2</span> <span class="main">⟹</span> brnL <span class="free">cl</span> <span class="free">n1</span> <span class="main">≤</span> brnL <span class="free">cl</span> <span class="free">n2</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> le_take<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n1</span></span> <span class="quoted"><span class="free">n2</span></span> <span class="quoted"><span class="free">cl</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> brnL_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Language_Semantics-brnL_mono2"><span class="command">lemma</span></span> brnL_mono2<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"properL <span class="free">cl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n1</span> <span class="main">&lt;</span> <span class="free">n2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> l<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n2</span> <span class="main">≤</span> length <span class="free">cl</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"brnL <span class="free">cl</span> <span class="free">n1</span> <span class="main">&lt;</span> brnL <span class="free">cl</span> <span class="free">n2</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">&lt;</span> <span class="var">?R</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">c</span><span class="main">.</span> <span class="bound">c</span> <span class="main">∈</span> set <span class="main">(</span>take <span class="free">n2</span> <span class="free">cl</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">&lt;</span> brn <span class="bound">c</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> p <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> brn_gt_0 in_set_takeD properL_proper<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"take <span class="free">n1</span> <span class="free">cl</span> <span class="main">&lt;</span> take <span class="free">n2</span> <span class="free">cl</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> n l lt_take <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"lsum brn <span class="main">(</span>take <span class="free">n1</span> <span class="free">cl</span><span class="main">)</span> <span class="main">&lt;</span> lsum brn <span class="main">(</span>take <span class="free">n2</span> <span class="free">cl</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> lsum_mono2<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"take <span class="free">n2</span> <span class="free">cl</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">%</span><span class="bound">c</span><span class="main">.</span> brn <span class="bound">c</span>"</span></span> <span class="quoted"><span class="quoted">"take <span class="free">n1</span> <span class="free">cl</span>"</span></span><span class="main">]</span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> brnL_def <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Language_Semantics-brn_index"><span class="command">lemma</span></span> brn_index<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&lt;</span> length <span class="free">cl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> brn <span class="main">(</span><span class="free">cl</span> <span class="main">!</span> <span class="free">n</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"brnL <span class="free">cl</span> <span class="free">n</span> <span class="main">+</span> <span class="free">i</span> <span class="main">&lt;</span> brnL <span class="free">cl</span> <span class="main">(</span>length <span class="free">cl</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">&lt;</span> <span class="var">?R</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">&lt;</span> brnL <span class="free">cl</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> <span class="var">?R</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> n brnL_mono<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Suc <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="free">cl</span>"</span></span> <span class="quoted"><span class="free">cl</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Language_Semantics-brnL_gt_0"><span class="command">lemma</span></span> brnL_gt_0<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>properL <span class="free">cl</span><span class="main">;</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="free">n</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">&lt;</span> brnL <span class="free">cl</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> properL_def brnL_mono brnL_mono2 le_0_eq length_greater_0_conv nat_le_linear neq0_conv<span class="main">)</span>

<span class="keyword1" id="Language_Semantics-locateTI"><span class="command">lemma</span></span> locateTI<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"properL <span class="free">cl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">ii</span> <span class="main">&lt;</span> brn <span class="main">(</span>Par <span class="free">cl</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span>
<span class="quoted"><span class="quoted">"locateT <span class="free">cl</span> <span class="free">ii</span> <span class="main">&lt;</span> length <span class="free">cl</span> <span class="main">∧</span>
 locateI <span class="free">cl</span> <span class="free">ii</span> <span class="main">&lt;</span> brn <span class="main">(</span><span class="free">cl</span> <span class="main">!</span> <span class="main">(</span>locateT <span class="free">cl</span> <span class="free">ii</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
 <span class="free">ii</span> <span class="main">=</span> brnL <span class="free">cl</span> <span class="main">(</span>locateT <span class="free">cl</span> <span class="free">ii</span><span class="main">)</span> <span class="main">+</span> locateI <span class="free">cl</span> <span class="free">ii</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms locate<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">cl</span></span> <span class="quoted">brn</span><span class="main">]</span> brn_gt_0
<span class="keyword1"><span class="command">unfolding</span></span> locateT_def locateI_def brnL_def
<span class="keyword1"><span class="command">unfolding</span></span> brnL_lsum<span class="main">[</span><span class="operator">THEN</span> sym<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Language_Semantics-locateTI_unique"><span class="command">lemma</span></span> locateTI_unique<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"properL <span class="free">cl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&lt;</span> length <span class="free">cl</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> brn <span class="main">(</span><span class="free">cl</span> <span class="main">!</span> <span class="free">n</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">ii</span> <span class="main">=</span> brnL <span class="free">cl</span> <span class="free">n</span> <span class="main">+</span> <span class="free">i</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> locateT <span class="free">cl</span> <span class="free">ii</span> <span class="main">∧</span> <span class="free">i</span> <span class="main">=</span> locateI <span class="free">cl</span> <span class="free">ii</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms locate_unique<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">cl</span></span> <span class="quoted">brn</span><span class="main">]</span> brn_gt_0
<span class="keyword1"><span class="command">unfolding</span></span> locateT_def locateI_def brnL_def
<span class="keyword1"><span class="command">unfolding</span></span> brnL_lsum<span class="main">[</span><span class="operator">THEN</span> sym<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="comment1">(*  pickFT picks a finished thread (if there is any).
    It will be used to perform a dummy transition in case the cumulated weight of the
    finished threads is 0; specifically, one will assign probability 1 to that picked fresh.
    (Obviously, the particular choice does not matter.)   *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">pickFT_pred</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">pickFT_pred</span> <span class="free"><span class="bound"><span class="entity">cl</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">&lt;</span> length <span class="free"><span class="bound"><span class="entity">cl</span></span></span> <span class="main">∧</span> finished <span class="main">(</span><span class="free"><span class="bound"><span class="entity">cl</span></span></span><span class="main">!</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">pickFT</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">pickFT</span> <span class="free"><span class="bound"><span class="entity">cl</span></span></span> <span class="main">≡</span> <span class="keyword1">SOME</span> <span class="bound">n</span><span class="main">.</span> pickFT_pred <span class="free"><span class="bound"><span class="entity">cl</span></span></span> <span class="bound">n</span>"</span></span>

<span class="keyword1" id="Language_Semantics-pickFT_pred"><span class="command">lemma</span></span> pickFT_pred<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"WtFT <span class="free">cl</span> <span class="main">=</span> <span class="main">1</span>"</span></span>  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">n</span><span class="main">.</span> pickFT_pred <span class="free">cl</span> <span class="bound">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> ccontr<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> not_ex<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">n</span><span class="main">.</span> <span class="main">¬</span> pickFT_pred <span class="free">cl</span> <span class="bound">n</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> length <span class="free">cl</span> <span class="main">⟹</span> <span class="main">¬</span> finished <span class="main">(</span><span class="free">cl</span><span class="main">!</span><span class="bound">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> pickFT_pred_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"theFT <span class="free">cl</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> theFT_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"WtFT <span class="free">cl</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> WtFT_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Language_Semantics-pickFT_pred_pickFT"><span class="command">lemma</span></span> pickFT_pred_pickFT<span class="main">:</span> <span class="quoted"><span class="quoted">"WtFT <span class="free">cl</span> <span class="main">=</span> <span class="main">1</span> <span class="main">⟹</span> pickFT_pred <span class="free">cl</span> <span class="main">(</span>pickFT <span class="free">cl</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> pickFT_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> someI_ex pickFT_pred<span class="main">)</span>

<span class="keyword1" id="Language_Semantics-pickFT_length"><span class="command">lemma</span></span> pickFT_length<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"WtFT <span class="free">cl</span> <span class="main">=</span> <span class="main">1</span> <span class="main">⟹</span> pickFT <span class="free">cl</span> <span class="main">&lt;</span> length <span class="free">cl</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> pickFT_pred_pickFT <span class="keyword1"><span class="command">unfolding</span></span> pickFT_pred_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Language_Semantics-pickFT_finished"><span class="command">lemma</span></span> pickFT_finished<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"WtFT <span class="free">cl</span> <span class="main">=</span> <span class="main">1</span> <span class="main">⟹</span> finished <span class="main">(</span><span class="free">cl</span> <span class="main">!</span> <span class="main">(</span>pickFT <span class="free">cl</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> pickFT_pred_pickFT <span class="keyword1"><span class="command">unfolding</span></span> pickFT_pred_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Language_Semantics-pickFT_theFT"><span class="command">lemma</span></span> pickFT_theFT<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"WtFT <span class="free">cl</span> <span class="main">=</span> <span class="main">1</span> <span class="main">⟹</span> pickFT <span class="free">cl</span> <span class="main">∈</span> theFT <span class="free">cl</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> theFT_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="comment1">(* The weight, continuation and effect defined as a single operator: *)</span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">wt_cont_eff</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">wt_cont_eff</span> Done <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">1</span><span class="main">,</span> Done<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">wt_cont_eff</span> <span class="main">(</span>Atm <span class="free"><span class="bound"><span class="entity">atm</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">1</span><span class="main">,</span> Done<span class="main">,</span> <span class="free">aval</span> <span class="free"><span class="bound"><span class="entity">atm</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">wt_cont_eff</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="main">;;</span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span>
 <span class="main">(</span><span class="keyword1">case</span> <span class="free">wt_cont_eff</span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="keyword1">of</span>
    <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">c1'</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">⇒</span>
      <span class="keyword1">if</span> finished <span class="bound">c1'</span> <span class="keyword1">then</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">c1'</span> <span class="main">;;</span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">wt_cont_eff</span> <span class="main">(</span>While <span class="free"><span class="bound"><span class="entity">tst</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span>
<span class="main">(</span><span class="keyword1">if</span> <span class="free">tval</span> <span class="free"><span class="bound"><span class="entity">tst</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>
   <span class="keyword1">then</span> <span class="main">(</span><span class="main">1</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">;;</span> <span class="main">(</span>While <span class="free"><span class="bound"><span class="entity">tst</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>
   <span class="keyword1">else</span> <span class="main">(</span><span class="main">1</span><span class="main">,</span> Done<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">wt_cont_eff</span> <span class="main">(</span>Ch <span class="free"><span class="bound"><span class="entity">ch</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span>
 <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="free">cval</span> <span class="free"><span class="bound"><span class="entity">ch</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">else</span> <span class="main">1</span> <span class="main">-</span> <span class="free">cval</span> <span class="free"><span class="bound"><span class="entity">ch</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span>
  <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span><span class="main">,</span>
  <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">wt_cont_eff</span> <span class="main">(</span>Par <span class="free"><span class="bound"><span class="entity">cl</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">ii</span></span></span> <span class="main">=</span>
 <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">cl</span></span></span> <span class="main">!</span> <span class="main">(</span>locateT <span class="free"><span class="bound"><span class="entity">cl</span></span></span> <span class="free"><span class="bound"><span class="entity">ii</span></span></span><span class="main">)</span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">cl</span></span></span> <span class="keyword1">then</span>
 <span class="main">(</span><span class="keyword1">case</span> <span class="free">wt_cont_eff</span>
         <span class="main">(</span><span class="free"><span class="bound"><span class="entity">cl</span></span></span> <span class="main">!</span> <span class="main">(</span>locateT <span class="free"><span class="bound"><span class="entity">cl</span></span></span> <span class="free"><span class="bound"><span class="entity">ii</span></span></span><span class="main">)</span><span class="main">)</span>
         <span class="free"><span class="bound"><span class="entity">s</span></span></span>
         <span class="main">(</span>locateI <span class="free"><span class="bound"><span class="entity">cl</span></span></span> <span class="free"><span class="bound"><span class="entity">ii</span></span></span><span class="main">)</span> <span class="keyword1">of</span>
    <span class="main">(</span><span class="bound">w</span><span class="main">,</span> <span class="bound">c'</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">⇒</span>
      <span class="main">(</span><span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="main">(</span>length <span class="free"><span class="bound"><span class="entity">cl</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="bound">w</span><span class="main">,</span>
       Par <span class="main">(</span><span class="free"><span class="bound"><span class="entity">cl</span></span></span> <span class="main">[</span><span class="main">(</span>locateT <span class="free"><span class="bound"><span class="entity">cl</span></span></span> <span class="free"><span class="bound"><span class="entity">ii</span></span></span><span class="main">)</span> <span class="main">:=</span> <span class="bound">c'</span><span class="main">]</span><span class="main">)</span><span class="main">,</span>
       <span class="bound">s'</span><span class="main">)</span><span class="main">)</span>
  <span class="keyword1">else</span> undefined<span class="main">)</span>"</span></span>
<span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">wt_cont_eff</span> <span class="main">(</span>ParT <span class="free"><span class="bound"><span class="entity">cl</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">ii</span></span></span> <span class="main">=</span>
 <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">cl</span></span></span> <span class="main">!</span> <span class="main">(</span>locateT <span class="free"><span class="bound"><span class="entity">cl</span></span></span> <span class="free"><span class="bound"><span class="entity">ii</span></span></span><span class="main">)</span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">cl</span></span></span>
   <span class="keyword1">then</span>
     <span class="main">(</span><span class="keyword1">case</span> <span class="free">wt_cont_eff</span>
             <span class="main">(</span><span class="free"><span class="bound"><span class="entity">cl</span></span></span> <span class="main">!</span> <span class="main">(</span>locateT <span class="free"><span class="bound"><span class="entity">cl</span></span></span> <span class="free"><span class="bound"><span class="entity">ii</span></span></span><span class="main">)</span><span class="main">)</span>
             <span class="free"><span class="bound"><span class="entity">s</span></span></span>
             <span class="main">(</span>locateI <span class="free"><span class="bound"><span class="entity">cl</span></span></span> <span class="free"><span class="bound"><span class="entity">ii</span></span></span><span class="main">)</span> <span class="keyword1">of</span>
        <span class="main">(</span><span class="bound">w</span><span class="main">,</span> <span class="bound">c'</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">⇒</span>
           <span class="main">(</span><span class="keyword1">if</span> WtFT <span class="free"><span class="bound"><span class="entity">cl</span></span></span> <span class="main">=</span> <span class="main">1</span>
            <span class="keyword1">then</span> <span class="main">(</span><span class="keyword1">if</span> locateT <span class="free"><span class="bound"><span class="entity">cl</span></span></span> <span class="free"><span class="bound"><span class="entity">ii</span></span></span> <span class="main">=</span> pickFT <span class="free"><span class="bound"><span class="entity">cl</span></span></span> <span class="main">∧</span> locateI <span class="free"><span class="bound"><span class="entity">cl</span></span></span> <span class="free"><span class="bound"><span class="entity">ii</span></span></span> <span class="main">=</span> <span class="main">0</span>
                    <span class="keyword1">then</span> <span class="main">1</span>
                    <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>
            <span class="keyword1">else</span> <span class="keyword1">if</span> finished <span class="main">(</span><span class="free"><span class="bound"><span class="entity">cl</span></span></span> <span class="main">!</span> <span class="main">(</span>locateT <span class="free"><span class="bound"><span class="entity">cl</span></span></span> <span class="free"><span class="bound"><span class="entity">ii</span></span></span><span class="main">)</span><span class="main">)</span>
              <span class="keyword1">then</span> <span class="main">0</span>
              <span class="keyword1">else</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="main">(</span>length <span class="free"><span class="bound"><span class="entity">cl</span></span></span><span class="main">)</span><span class="main">)</span>
                   <span class="main">/</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> WtFT <span class="free"><span class="bound"><span class="entity">cl</span></span></span><span class="main">)</span>
                   <span class="main">*</span> <span class="bound">w</span><span class="main">,</span>
            ParT <span class="main">(</span><span class="free"><span class="bound"><span class="entity">cl</span></span></span> <span class="main">[</span><span class="main">(</span>locateT <span class="free"><span class="bound"><span class="entity">cl</span></span></span> <span class="free"><span class="bound"><span class="entity">ii</span></span></span><span class="main">)</span> <span class="main">:=</span> <span class="bound">c'</span><span class="main">]</span><span class="main">)</span><span class="main">,</span>
            <span class="bound">s'</span><span class="main">)</span><span class="main">)</span>
   <span class="keyword1">else</span> undefined<span class="main">)</span>"</span></span>

<span class="comment1">(* weight, cont (transition) and effect: *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">wt</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">wt</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> fst <span class="main">(</span>wt_cont_eff <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">cont</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">cont</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> fst <span class="main">(</span>snd <span class="main">(</span>wt_cont_eff <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">eff</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">eff</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> snd <span class="main">(</span>snd <span class="main">(</span>wt_cont_eff <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="comment1">(* Their individual equations (corresponding to the paper's Figure 1):  *)</span>
<span class="keyword1" id="Language_Semantics-wt_Done"><span class="command">lemma</span></span> wt_Done<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"wt Done <span class="free">s</span> <span class="free">i</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> wt_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Language_Semantics-wt_Atm"><span class="command">lemma</span></span> wt_Atm<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"wt <span class="main">(</span>Atm <span class="free">atm</span><span class="main">)</span> <span class="free">s</span> <span class="free">i</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> wt_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Language_Semantics-wt_Seq"><span class="command">lemma</span></span> wt_Seq<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="quoted"><span class="quoted">"wt <span class="main">(</span><span class="free">c1</span> <span class="main">;;</span> <span class="free">c2</span><span class="main">)</span> <span class="free">s</span> <span class="main">=</span> wt <span class="free">c1</span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wt <span class="main">(</span><span class="free">c1</span> <span class="main">;;</span> <span class="free">c2</span><span class="main">)</span> <span class="free">s</span> <span class="skolem">i</span> <span class="main">=</span> wt <span class="free">c1</span> <span class="free">s</span> <span class="skolem">i</span>"</span></span>
   <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"wt_cont_eff <span class="free">c1</span> <span class="free">s</span> <span class="skolem">i</span>"</span></span><span class="main">)</span>
     <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>fields _ <span class="skolem">c1'</span> _<span class="main">)</span>
     <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> wt_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">c1'</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
   <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Language_Semantics-wt_While"><span class="command">lemma</span></span> wt_While<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"wt <span class="main">(</span>While <span class="free">tst</span> <span class="free">c</span><span class="main">)</span> <span class="free">s</span> <span class="free">i</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> wt_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Language_Semantics-wt_Ch_L"><span class="command">lemma</span></span> wt_Ch_L<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"wt <span class="main">(</span>Ch <span class="free">ch</span> <span class="free">c1</span> <span class="free">c2</span><span class="main">)</span> <span class="free">s</span> <span class="main">0</span> <span class="main">=</span> <span class="free">cval</span> <span class="free">ch</span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> wt_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Language_Semantics-wt_Ch_R"><span class="command">lemma</span></span> wt_Ch_R<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"wt <span class="main">(</span>Ch <span class="free">ch</span> <span class="free">c1</span> <span class="free">c2</span><span class="main">)</span> <span class="free">s</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span> <span class="main">-</span> <span class="free">cval</span> <span class="free">ch</span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> wt_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="comment1">(*  *)</span>
<span class="keyword1" id="Language_Semantics-cont_Done"><span class="command">lemma</span></span> cont_Done<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"cont Done <span class="free">s</span> <span class="free">i</span> <span class="main">=</span> Done"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> cont_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Language_Semantics-cont_Atm"><span class="command">lemma</span></span> cont_Atm<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"cont <span class="main">(</span>Atm <span class="free">atm</span><span class="main">)</span> <span class="free">s</span> <span class="free">i</span> <span class="main">=</span> Done"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> cont_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Language_Semantics-cont_Seq_finished"><span class="command">lemma</span></span> cont_Seq_finished<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finished <span class="main">(</span>cont <span class="free">c1</span> <span class="free">s</span> <span class="free">i</span><span class="main">)</span> <span class="main">⟹</span> cont <span class="main">(</span><span class="free">c1</span> <span class="main">;;</span> <span class="free">c2</span><span class="main">)</span> <span class="free">s</span> <span class="free">i</span> <span class="main">=</span> <span class="free">c2</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> cont_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"wt_cont_eff <span class="free">c1</span> <span class="free">s</span> <span class="free">i</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Language_Semantics-cont_Seq_notFinished"><span class="command">lemma</span></span> cont_Seq_notFinished<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> finished <span class="main">(</span>cont <span class="free">c1</span> <span class="free">s</span> <span class="free">i</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"cont <span class="main">(</span><span class="free">c1</span> <span class="main">;;</span> <span class="free">c2</span><span class="main">)</span> <span class="free">s</span> <span class="free">i</span> <span class="main">=</span> <span class="main">(</span>cont <span class="free">c1</span> <span class="free">s</span> <span class="free">i</span><span class="main">)</span> <span class="main">;;</span> <span class="free">c2</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"wt_cont_eff <span class="free">c1</span> <span class="free">s</span> <span class="free">i</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>fields _ <span class="skolem">c1'</span> _<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> cont_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">c1'</span></span><span class="main">)</span>  <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Language_Semantics-cont_Seq_not_eq_finished"><span class="command">lemma</span></span> cont_Seq_not_eq_finished<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> finished <span class="free">c2</span> <span class="main">⟹</span> <span class="main">¬</span> finished <span class="main">(</span>cont <span class="main">(</span>Seq <span class="free">c1</span> <span class="free">c2</span><span class="main">)</span> <span class="free">s</span> <span class="free">i</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"finished <span class="main">(</span>cont <span class="free">c1</span> <span class="free">s</span> <span class="free">i</span><span class="main">)</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Language_Semantics-cont_While_False"><span class="command">lemma</span></span> cont_While_False<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">tval</span> <span class="free">tst</span> <span class="free">s</span> <span class="main">=</span> False <span class="main">⟹</span> cont <span class="main">(</span>While <span class="free">tst</span> <span class="free">c</span><span class="main">)</span> <span class="free">s</span> <span class="free">i</span> <span class="main">=</span> Done"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> cont_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Language_Semantics-cont_While_True"><span class="command">lemma</span></span> cont_While_True<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">tval</span> <span class="free">tst</span> <span class="free">s</span> <span class="main">=</span> True <span class="main">⟹</span> cont <span class="main">(</span>While <span class="free">tst</span> <span class="free">c</span><span class="main">)</span> <span class="free">s</span> <span class="free">i</span> <span class="main">=</span> <span class="free">c</span> <span class="main">;;</span> <span class="main">(</span>While <span class="free">tst</span> <span class="free">c</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> cont_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Language_Semantics-cont_Ch_L"><span class="command">lemma</span></span> cont_Ch_L<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"cont <span class="main">(</span>Ch <span class="free">ch</span> <span class="free">c1</span> <span class="free">c2</span><span class="main">)</span> <span class="free">s</span> <span class="main">0</span> <span class="main">=</span> <span class="free">c1</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> cont_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Language_Semantics-cont_Ch_R"><span class="command">lemma</span></span> cont_Ch_R<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"cont <span class="main">(</span>Ch <span class="free">ch</span> <span class="free">c1</span> <span class="free">c2</span><span class="main">)</span> <span class="free">s</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="free">c2</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> cont_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="comment1">(*  *)</span>

<span class="keyword1" id="Language_Semantics-eff_Done"><span class="command">lemma</span></span> eff_Done<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"eff Done <span class="free">s</span> <span class="free">i</span> <span class="main">=</span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> eff_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Language_Semantics-eff_Atm"><span class="command">lemma</span></span> eff_Atm<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"eff <span class="main">(</span>Atm <span class="free">atm</span><span class="main">)</span> <span class="free">s</span> <span class="free">i</span> <span class="main">=</span> <span class="free">aval</span> <span class="free">atm</span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> eff_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Language_Semantics-eff_Seq"><span class="command">lemma</span></span> eff_Seq<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"eff <span class="main">(</span><span class="free">c1</span> <span class="main">;;</span> <span class="free">c2</span><span class="main">)</span> <span class="free">s</span> <span class="main">=</span> eff <span class="free">c1</span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eff <span class="main">(</span><span class="free">c1</span> <span class="main">;;</span> <span class="free">c2</span><span class="main">)</span> <span class="free">s</span> <span class="skolem">i</span> <span class="main">=</span> eff <span class="free">c1</span> <span class="free">s</span> <span class="skolem">i</span>"</span></span>
   <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"wt_cont_eff <span class="free">c1</span> <span class="free">s</span> <span class="skolem">i</span>"</span></span><span class="main">)</span>
     <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>fields _ <span class="skolem">c1'</span> _<span class="main">)</span>
     <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
     <span class="keyword1"><span class="command">unfolding</span></span> eff_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">c1'</span></span><span class="main">)</span> <span class="operator">auto</span>
   <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Language_Semantics-eff_While"><span class="command">lemma</span></span> eff_While<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"eff <span class="main">(</span>While <span class="free">tst</span> <span class="free">c</span><span class="main">)</span> <span class="free">s</span> <span class="free">i</span> <span class="main">=</span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> eff_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Language_Semantics-eff_Ch"><span class="command">lemma</span></span> eff_Ch<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"eff <span class="main">(</span>Ch <span class="free">ch</span> <span class="free">c1</span> <span class="free">c2</span><span class="main">)</span> <span class="free">s</span> <span class="free">i</span> <span class="main">=</span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> eff_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="comment1">(* wt-cont-eff simps for parallel composition *)</span>
<span class="keyword1" id="Language_Semantics-brnL_nchotomy"><span class="command">lemma</span></span> brnL_nchotomy<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"properL <span class="free">cl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">ii</span> <span class="main">&lt;</span> brnL <span class="free">cl</span> <span class="main">(</span>length <span class="free">cl</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">n</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> length <span class="free">cl</span> <span class="main">∧</span> <span class="bound">i</span> <span class="main">&lt;</span> brn <span class="main">(</span><span class="free">cl</span> <span class="main">!</span> <span class="bound">n</span><span class="main">)</span> <span class="main">∧</span> <span class="free">ii</span> <span class="main">=</span> brnL <span class="free">cl</span> <span class="bound">n</span> <span class="main">+</span> <span class="bound">i</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> brnL_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> less_lsum_nchotomy<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> assms brn_gt_0
<span class="keyword1"><span class="command">unfolding</span></span> brnL_lsum<span class="main">[</span><span class="operator">THEN</span> sym<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">corollary</span></span> brnL_cases<span class="main">[</span><span class="operator">consumes</span> 2<span class="main">,</span> <span class="operator">case_names</span> Local<span class="main">,</span> <span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"properL <span class="free">cl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">ii</span> <span class="main">&lt;</span> brnL <span class="free">cl</span> <span class="main">(</span>length <span class="free">cl</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
<span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">n</span> <span class="bound">i</span><span class="main">.</span> <span class="main">⟦</span><span class="bound">n</span> <span class="main">&lt;</span> length <span class="free">cl</span><span class="main">;</span> <span class="bound">i</span> <span class="main">&lt;</span> brn <span class="main">(</span><span class="free">cl</span> <span class="main">!</span> <span class="bound">n</span><span class="main">)</span><span class="main">;</span> <span class="free">ii</span> <span class="main">=</span> brnL <span class="free">cl</span> <span class="bound">n</span> <span class="main">+</span> <span class="bound">i</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">phi</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="free">phi</span></span>
<span class="keyword1"><span class="command">using</span></span> assms brnL_nchotomy <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Language_Semantics-wt_cont_eff_Par"><span class="command">lemma</span></span> wt_cont_eff_Par<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"properL <span class="free">cl</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&lt;</span> length <span class="free">cl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> brn <span class="main">(</span><span class="free">cl</span> <span class="main">!</span> <span class="free">n</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span>
<span class="quoted"><span class="quoted">"wt <span class="main">(</span>Par <span class="free">cl</span><span class="main">)</span> <span class="free">s</span> <span class="main">(</span>brnL <span class="free">cl</span> <span class="free">n</span> <span class="main">+</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span>
 <span class="main">1</span> <span class="main">/</span> <span class="main">(</span>length <span class="free">cl</span><span class="main">)</span> <span class="main">*</span> wt <span class="main">(</span><span class="free">cl</span> <span class="main">!</span> <span class="free">n</span><span class="main">)</span> <span class="free">s</span> <span class="free">i</span>"</span></span>
<span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?wL</span> <span class="main">=</span> <span class="var">?wR</span>"</span></span><span class="main">)</span>
<span class="comment1">(*  *)</span>
<span class="quoted"><span class="quoted">"cont <span class="main">(</span>Par <span class="free">cl</span><span class="main">)</span> <span class="free">s</span> <span class="main">(</span>brnL <span class="free">cl</span> <span class="free">n</span> <span class="main">+</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span>
 Par <span class="main">(</span><span class="free">cl</span> <span class="main">[</span><span class="free">n</span> <span class="main">:=</span> cont <span class="main">(</span><span class="free">cl</span> <span class="main">!</span> <span class="free">n</span><span class="main">)</span> <span class="free">s</span> <span class="free">i</span><span class="main">]</span><span class="main">)</span>"</span></span>
<span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?mL</span> <span class="main">=</span> <span class="var">?mR</span>"</span></span><span class="main">)</span>
<span class="comment1">(*  *)</span>
<span class="quoted"><span class="quoted">"eff <span class="main">(</span>Par <span class="free">cl</span><span class="main">)</span> <span class="free">s</span> <span class="main">(</span>brnL <span class="free">cl</span> <span class="free">n</span> <span class="main">+</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span>
 eff <span class="main">(</span><span class="free">cl</span> <span class="main">!</span> <span class="free">n</span><span class="main">)</span> <span class="free">s</span> <span class="free">i</span>"</span></span>
<span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?eL</span> <span class="main">=</span> <span class="var">?eR</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">ii</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ii</span> <span class="main">=</span> brnL <span class="free">cl</span> <span class="free">n</span> <span class="main">+</span> <span class="free">i</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">n1</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n1</span> <span class="main">=</span> locateT <span class="free">cl</span> <span class="skolem">ii</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">i1</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i1</span> <span class="main">=</span> locateI <span class="free">cl</span> <span class="skolem">ii</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> n_i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> <span class="skolem">n1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">=</span> <span class="skolem">i1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> p <span class="keyword1"><span class="command">unfolding</span></span> n1_def i1_def
  <span class="keyword1"><span class="command">using</span></span> ii_def locateTI_unique n i <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> lsum1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ii</span> <span class="main">&lt;</span> brnL <span class="free">cl</span> <span class="main">(</span>length <span class="free">cl</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> ii_def <span class="keyword1"><span class="command">using</span></span> n i <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n1</span> <span class="main">&lt;</span> length <span class="free">cl</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> n1_def <span class="keyword1"><span class="command">using</span></span> i p locateTI<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">cl</span></span> <span class="quoted"><span class="skolem">ii</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> set<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">cl</span> <span class="main">!</span> <span class="skolem">n1</span> <span class="main">∈</span> set <span class="free">cl</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="comment1">(*  *)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?wL</span> <span class="main">=</span> <span class="main">1</span> <span class="main">/</span> <span class="main">(</span>length <span class="free">cl</span><span class="main">)</span><span class="main">*</span> wt <span class="main">(</span><span class="free">cl</span> <span class="main">!</span> <span class="skolem">n1</span><span class="main">)</span> <span class="free">s</span> <span class="skolem">i1</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> ii_def<span class="main">[</span><span class="operator">THEN</span> sym<span class="main">]</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"wt_cont_eff <span class="main">(</span><span class="free">cl</span> <span class="main">!</span> <span class="skolem">n1</span><span class="main">)</span> <span class="free">s</span> <span class="skolem">i1</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> set <span class="keyword1"><span class="command">unfolding</span></span> n1_def i1_def <span class="keyword1"><span class="command">unfolding</span></span> wt_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="var">?wR</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> n_i <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?wL</span> <span class="main">=</span> <span class="var">?wR</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="comment1">(*  *)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?mL</span> <span class="main">=</span> Par <span class="main">(</span><span class="free">cl</span> <span class="main">[</span><span class="skolem">n1</span> <span class="main">:=</span> cont <span class="main">(</span><span class="free">cl</span> <span class="main">!</span> <span class="skolem">n1</span><span class="main">)</span> <span class="free">s</span> <span class="skolem">i1</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> ii_def<span class="main">[</span><span class="operator">THEN</span> sym<span class="main">]</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"wt_cont_eff <span class="main">(</span><span class="free">cl</span> <span class="main">!</span> <span class="skolem">n1</span><span class="main">)</span> <span class="free">s</span> <span class="skolem">i1</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> set <span class="keyword1"><span class="command">unfolding</span></span> n1_def i1_def <span class="keyword1"><span class="command">unfolding</span></span> cont_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="var">?mR</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> n_i <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?mL</span> <span class="main">=</span> <span class="var">?mR</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="comment1">(*  *)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?eL</span> <span class="main">=</span> eff <span class="main">(</span><span class="free">cl</span> <span class="main">!</span> <span class="skolem">n1</span><span class="main">)</span> <span class="free">s</span> <span class="skolem">i1</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> ii_def<span class="main">[</span><span class="operator">THEN</span> sym<span class="main">]</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"wt_cont_eff <span class="main">(</span><span class="free">cl</span> <span class="main">!</span> <span class="skolem">n1</span><span class="main">)</span> <span class="free">s</span> <span class="skolem">i1</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> set <span class="keyword1"><span class="command">unfolding</span></span> n1_def i1_def <span class="keyword1"><span class="command">unfolding</span></span> eff_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eff <span class="main">(</span><span class="free">cl</span> <span class="main">!</span> <span class="skolem">n1</span><span class="main">)</span> <span class="free">s</span> <span class="skolem">i1</span> <span class="main">=</span> <span class="var">?eR</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> n_i <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?eL</span> <span class="main">=</span> <span class="var">?eR</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Language_Semantics-cont_eff_ParT"><span class="command">lemma</span></span> cont_eff_ParT<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"properL <span class="free">cl</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&lt;</span> length <span class="free">cl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> brn <span class="main">(</span><span class="free">cl</span> <span class="main">!</span> <span class="free">n</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span>
<span class="quoted"><span class="quoted">"cont <span class="main">(</span>ParT <span class="free">cl</span><span class="main">)</span> <span class="free">s</span> <span class="main">(</span>brnL <span class="free">cl</span> <span class="free">n</span> <span class="main">+</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span>
 ParT <span class="main">(</span><span class="free">cl</span> <span class="main">[</span><span class="free">n</span> <span class="main">:=</span> cont <span class="main">(</span><span class="free">cl</span> <span class="main">!</span> <span class="free">n</span><span class="main">)</span> <span class="free">s</span> <span class="free">i</span><span class="main">]</span><span class="main">)</span>"</span></span>
<span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?mL</span> <span class="main">=</span> <span class="var">?mR</span>"</span></span><span class="main">)</span>
<span class="comment1">(*  *)</span>
<span class="quoted"><span class="quoted">"eff <span class="main">(</span>ParT <span class="free">cl</span><span class="main">)</span> <span class="free">s</span> <span class="main">(</span>brnL <span class="free">cl</span> <span class="free">n</span> <span class="main">+</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span>
 eff <span class="main">(</span><span class="free">cl</span> <span class="main">!</span> <span class="free">n</span><span class="main">)</span> <span class="free">s</span> <span class="free">i</span>"</span></span>
<span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?eL</span> <span class="main">=</span> <span class="var">?eR</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">ii</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ii</span> <span class="main">=</span> brnL <span class="free">cl</span> <span class="free">n</span> <span class="main">+</span> <span class="free">i</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">n1</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n1</span> <span class="main">=</span> locateT <span class="free">cl</span> <span class="skolem">ii</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">i1</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i1</span> <span class="main">=</span> locateI <span class="free">cl</span> <span class="skolem">ii</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> n_i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> <span class="skolem">n1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">=</span> <span class="skolem">i1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> p <span class="keyword1"><span class="command">unfolding</span></span> n1_def i1_def
  <span class="keyword1"><span class="command">using</span></span> ii_def locateTI_unique n i <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> lsum1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ii</span> <span class="main">&lt;</span> brnL <span class="free">cl</span> <span class="main">(</span>length <span class="free">cl</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> ii_def <span class="keyword1"><span class="command">using</span></span> n i <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n1</span> <span class="main">&lt;</span> length <span class="free">cl</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> n1_def <span class="keyword1"><span class="command">using</span></span> i p locateTI<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">cl</span></span> <span class="quoted"><span class="skolem">ii</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> set<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">cl</span> <span class="main">!</span> <span class="skolem">n1</span> <span class="main">∈</span> set <span class="free">cl</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="comment1">(*  *)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?mL</span> <span class="main">=</span> ParT <span class="main">(</span><span class="free">cl</span> <span class="main">[</span><span class="skolem">n1</span> <span class="main">:=</span> cont <span class="main">(</span><span class="free">cl</span> <span class="main">!</span> <span class="skolem">n1</span><span class="main">)</span> <span class="free">s</span> <span class="skolem">i1</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> ii_def<span class="main">[</span><span class="operator">THEN</span> sym<span class="main">]</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"wt_cont_eff <span class="main">(</span><span class="free">cl</span> <span class="main">!</span> <span class="skolem">n1</span><span class="main">)</span> <span class="free">s</span> <span class="skolem">i1</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> set <span class="keyword1"><span class="command">unfolding</span></span> n1_def i1_def <span class="keyword1"><span class="command">unfolding</span></span> cont_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="var">?mR</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> n_i <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?mL</span> <span class="main">=</span> <span class="var">?mR</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="comment1">(*  *)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?eL</span> <span class="main">=</span> eff <span class="main">(</span><span class="free">cl</span> <span class="main">!</span> <span class="skolem">n1</span><span class="main">)</span> <span class="free">s</span> <span class="skolem">i1</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> ii_def<span class="main">[</span><span class="operator">THEN</span> sym<span class="main">]</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"wt_cont_eff <span class="main">(</span><span class="free">cl</span> <span class="main">!</span> <span class="skolem">n1</span><span class="main">)</span> <span class="free">s</span> <span class="skolem">i1</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> set <span class="keyword1"><span class="command">unfolding</span></span> n1_def i1_def <span class="keyword1"><span class="command">unfolding</span></span> eff_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eff <span class="main">(</span><span class="free">cl</span> <span class="main">!</span> <span class="skolem">n1</span><span class="main">)</span> <span class="free">s</span> <span class="skolem">i1</span> <span class="main">=</span> <span class="var">?eR</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> n_i <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?eL</span> <span class="main">=</span> <span class="var">?eR</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Language_Semantics-wt_ParT_WtFT_pickFT_0"><span class="command">lemma</span></span> wt_ParT_WtFT_pickFT_0<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"properL <span class="free">cl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> WtFT<span class="main">:</span> <span class="quoted"><span class="quoted">"WtFT <span class="free">cl</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wt <span class="main">(</span>ParT <span class="free">cl</span><span class="main">)</span> <span class="free">s</span> <span class="main">(</span>brnL <span class="free">cl</span> <span class="main">(</span>pickFT <span class="free">cl</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
<span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?wL</span> <span class="main">=</span> <span class="main">1</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">ii</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ii</span> <span class="main">=</span> brnL <span class="free">cl</span> <span class="main">(</span>pickFT <span class="free">cl</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">n1</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n1</span> <span class="main">=</span> locateT <span class="free">cl</span> <span class="skolem">ii</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">i1</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i1</span> <span class="main">=</span> locateI <span class="free">cl</span> <span class="skolem">ii</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> ni<span class="main">:</span> <span class="quoted"><span class="quoted">"pickFT <span class="free">cl</span> <span class="main">&lt;</span> length <span class="free">cl</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> brn <span class="main">(</span><span class="free">cl</span><span class="main">!</span> <span class="main">(</span>pickFT <span class="free">cl</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> WtFT p brn_gt_0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> n_i<span class="main">:</span> <span class="quoted"><span class="quoted">"pickFT <span class="free">cl</span> <span class="main">=</span> <span class="skolem">n1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">=</span> <span class="skolem">i1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> p <span class="keyword1"><span class="command">unfolding</span></span> n1_def i1_def
  <span class="keyword1"><span class="command">using</span></span> ii_def locateTI_unique<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">cl</span></span> <span class="quoted"><span class="quoted">"pickFT <span class="free">cl</span>"</span></span> <span class="quoted"><span class="main">0</span></span> <span class="quoted"><span class="skolem">ii</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> lsum1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ii</span> <span class="main">&lt;</span> brnL <span class="free">cl</span> <span class="main">(</span>length <span class="free">cl</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> ii_def <span class="keyword1"><span class="command">using</span></span> ni
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add.comm_neutral brn_index<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n1</span> <span class="main">&lt;</span> length <span class="free">cl</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> n1_def <span class="keyword1"><span class="command">using</span></span> ni p locateTI<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">cl</span></span> <span class="quoted"><span class="skolem">ii</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> set<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">cl</span> <span class="main">!</span> <span class="skolem">n1</span> <span class="main">∈</span> set <span class="free">cl</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="comment1">(*  *)</span>
  <span class="keyword1"><span class="command">have</span></span> n1i1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n1</span> <span class="main">=</span> pickFT <span class="free">cl</span> <span class="main">∧</span> <span class="skolem">i1</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> WtFT ni <span class="keyword1"><span class="command">unfolding</span></span> n_i <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?wL</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> ii_def<span class="main">[</span><span class="operator">THEN</span> sym<span class="main">]</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"wt_cont_eff <span class="main">(</span><span class="free">cl</span> <span class="main">!</span> <span class="skolem">n1</span><span class="main">)</span> <span class="free">s</span> <span class="skolem">i1</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> WtFT n1i1 set <span class="keyword1"><span class="command">unfolding</span></span> n1_def i1_def <span class="keyword1"><span class="command">unfolding</span></span> wt_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Language_Semantics-wt_ParT_WtFT_notPickFT_0"><span class="command">lemma</span></span> wt_ParT_WtFT_notPickFT_0<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"properL <span class="free">cl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&lt;</span> length <span class="free">cl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> brn <span class="main">(</span><span class="free">cl</span> <span class="main">!</span> <span class="free">n</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> WtFT<span class="main">:</span> <span class="quoted"><span class="quoted">"WtFT <span class="free">cl</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ni<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> pickFT <span class="free">cl</span> <span class="main">⟶</span> <span class="free">i</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wt <span class="main">(</span>ParT <span class="free">cl</span><span class="main">)</span> <span class="free">s</span> <span class="main">(</span>brnL <span class="free">cl</span> <span class="free">n</span> <span class="main">+</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?wL</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">ii</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ii</span> <span class="main">=</span> brnL <span class="free">cl</span> <span class="free">n</span> <span class="main">+</span> <span class="free">i</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">n1</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n1</span> <span class="main">=</span> locateT <span class="free">cl</span> <span class="skolem">ii</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">i1</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i1</span> <span class="main">=</span> locateI <span class="free">cl</span> <span class="skolem">ii</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> n_i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> <span class="skolem">n1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">=</span> <span class="skolem">i1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> p <span class="keyword1"><span class="command">unfolding</span></span> n1_def i1_def
  <span class="keyword1"><span class="command">using</span></span> ii_def locateTI_unique n i <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> lsum1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ii</span> <span class="main">&lt;</span> brnL <span class="free">cl</span> <span class="main">(</span>length <span class="free">cl</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> ii_def <span class="keyword1"><span class="command">using</span></span> n i <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n1</span> <span class="main">&lt;</span> length <span class="free">cl</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> n1_def <span class="keyword1"><span class="command">using</span></span> i p locateTI<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">cl</span></span> <span class="quoted"><span class="skolem">ii</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> set<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">cl</span> <span class="main">!</span> <span class="skolem">n1</span> <span class="main">∈</span> set <span class="free">cl</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="comment1">(*  *)</span>
  <span class="keyword1"><span class="command">have</span></span> n1i1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n1</span> <span class="main">≠</span> pickFT <span class="free">cl</span> <span class="main">∨</span> <span class="skolem">i1</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> WtFT ni <span class="keyword1"><span class="command">unfolding</span></span> n_i <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?wL</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> ii_def<span class="main">[</span><span class="operator">THEN</span> sym<span class="main">]</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"wt_cont_eff <span class="main">(</span><span class="free">cl</span> <span class="main">!</span> <span class="skolem">n1</span><span class="main">)</span> <span class="free">s</span> <span class="skolem">i1</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> WtFT n1i1 set <span class="keyword1"><span class="command">unfolding</span></span> n1_def i1_def <span class="keyword1"><span class="command">unfolding</span></span> wt_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Language_Semantics-wt_ParT_notWtFT_finished"><span class="command">lemma</span></span> wt_ParT_notWtFT_finished<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"properL <span class="free">cl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&lt;</span> length <span class="free">cl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> brn <span class="main">(</span><span class="free">cl</span> <span class="main">!</span> <span class="free">n</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> WtFT<span class="main">:</span> <span class="quoted"><span class="quoted">"WtFT <span class="free">cl</span> <span class="main">≠</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"finished <span class="main">(</span><span class="free">cl</span> <span class="main">!</span> <span class="free">n</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wt <span class="main">(</span>ParT <span class="free">cl</span><span class="main">)</span> <span class="free">s</span> <span class="main">(</span>brnL <span class="free">cl</span> <span class="free">n</span> <span class="main">+</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?wL</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">ii</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ii</span> <span class="main">=</span> brnL <span class="free">cl</span> <span class="free">n</span> <span class="main">+</span> <span class="free">i</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">n1</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n1</span> <span class="main">=</span> locateT <span class="free">cl</span> <span class="skolem">ii</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">i1</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i1</span> <span class="main">=</span> locateI <span class="free">cl</span> <span class="skolem">ii</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> n_i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> <span class="skolem">n1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">=</span> <span class="skolem">i1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> p <span class="keyword1"><span class="command">unfolding</span></span> n1_def i1_def
  <span class="keyword1"><span class="command">using</span></span> ii_def locateTI_unique n i <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> lsum1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ii</span> <span class="main">&lt;</span> brnL <span class="free">cl</span> <span class="main">(</span>length <span class="free">cl</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> ii_def <span class="keyword1"><span class="command">using</span></span> n i <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n1</span> <span class="main">&lt;</span> length <span class="free">cl</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> n1_def <span class="keyword1"><span class="command">using</span></span> i p locateTI<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">cl</span></span> <span class="quoted"><span class="skolem">ii</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> set<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">cl</span> <span class="main">!</span> <span class="skolem">n1</span> <span class="main">∈</span> set <span class="free">cl</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="comment1">(*  *)</span>
  <span class="keyword1"><span class="command">have</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"finished <span class="main">(</span><span class="free">cl</span> <span class="main">!</span> <span class="skolem">n1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> f <span class="keyword1"><span class="command">unfolding</span></span> n_i <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?wL</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> ii_def<span class="main">[</span><span class="operator">THEN</span> sym<span class="main">]</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"wt_cont_eff <span class="main">(</span><span class="free">cl</span> <span class="main">!</span> <span class="skolem">n1</span><span class="main">)</span> <span class="free">s</span> <span class="skolem">i1</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> WtFT f set <span class="keyword1"><span class="command">unfolding</span></span> n1_def i1_def <span class="keyword1"><span class="command">unfolding</span></span> wt_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Language_Semantics-wt_cont_eff_ParT_notWtFT_notFinished"><span class="command">lemma</span></span> wt_cont_eff_ParT_notWtFT_notFinished<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"properL <span class="free">cl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&lt;</span> length <span class="free">cl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> brn <span class="main">(</span><span class="free">cl</span> <span class="main">!</span> <span class="free">n</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> WtFT<span class="main">:</span> <span class="quoted"><span class="quoted">"WtFT <span class="free">cl</span> <span class="main">≠</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> nf<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> finished <span class="main">(</span><span class="free">cl</span> <span class="main">!</span> <span class="free">n</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wt <span class="main">(</span>ParT <span class="free">cl</span><span class="main">)</span> <span class="free">s</span> <span class="main">(</span>brnL <span class="free">cl</span> <span class="free">n</span> <span class="main">+</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span>
       <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="main">(</span>length <span class="free">cl</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> WtFT <span class="free">cl</span><span class="main">)</span> <span class="main">*</span> wt <span class="main">(</span><span class="free">cl</span> <span class="main">!</span> <span class="free">n</span><span class="main">)</span> <span class="free">s</span> <span class="free">i</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?wL</span> <span class="main">=</span> <span class="var">?wR</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">ii</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ii</span> <span class="main">=</span> brnL <span class="free">cl</span> <span class="free">n</span> <span class="main">+</span> <span class="free">i</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">n1</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n1</span> <span class="main">=</span> locateT <span class="free">cl</span> <span class="skolem">ii</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">i1</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i1</span> <span class="main">=</span> locateI <span class="free">cl</span> <span class="skolem">ii</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> n_i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> <span class="skolem">n1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">=</span> <span class="skolem">i1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> p <span class="keyword1"><span class="command">unfolding</span></span> n1_def i1_def
  <span class="keyword1"><span class="command">using</span></span> ii_def locateTI_unique n i <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> lsum1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ii</span> <span class="main">&lt;</span> brnL <span class="free">cl</span> <span class="main">(</span>length <span class="free">cl</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> ii_def <span class="keyword1"><span class="command">using</span></span> n i <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n1</span> <span class="main">&lt;</span> length <span class="free">cl</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> n1_def <span class="keyword1"><span class="command">using</span></span> i p locateTI<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">cl</span></span> <span class="quoted"><span class="skolem">ii</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> set<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">cl</span> <span class="main">!</span> <span class="skolem">n1</span> <span class="main">∈</span> set <span class="free">cl</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="comment1">(*  *)</span>
  <span class="keyword1"><span class="command">have</span></span> nf<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> finished <span class="main">(</span><span class="free">cl</span> <span class="main">!</span> <span class="skolem">n1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> nf <span class="keyword1"><span class="command">unfolding</span></span> n_i <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?wL</span> <span class="main">=</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="main">(</span>length <span class="free">cl</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> WtFT <span class="free">cl</span><span class="main">)</span> <span class="main">*</span> wt <span class="main">(</span><span class="free">cl</span> <span class="main">!</span> <span class="skolem">n1</span><span class="main">)</span> <span class="free">s</span> <span class="skolem">i1</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> ii_def<span class="main">[</span><span class="operator">THEN</span> sym<span class="main">]</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"wt_cont_eff <span class="main">(</span><span class="free">cl</span> <span class="main">!</span> <span class="skolem">n1</span><span class="main">)</span> <span class="free">s</span> <span class="skolem">i1</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> WtFT nf set <span class="keyword1"><span class="command">unfolding</span></span> n1_def i1_def <span class="keyword1"><span class="command">unfolding</span></span> wt_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="var">?wR</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> n_i <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?wL</span> <span class="main">=</span> <span class="var">?wR</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(*  *)</span>
<span class="keyword1" id="Language_Semantics-wt_ge_0"><span class="command">lemma</span></span> wt_ge_0<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"proper <span class="free">c</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> brn <span class="free">c</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> wt <span class="free">c</span> <span class="free">s</span> <span class="free">i</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">c</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> proper_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Ch <span class="skolem">ch</span> <span class="skolem">c1</span> <span class="skolem">c2</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">using</span></span> properCh  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Par <span class="skolem">cl</span> <span class="skolem">ii</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"properL <span class="skolem">cl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ii</span> <span class="main">&lt;</span> brnL <span class="skolem">cl</span> <span class="main">(</span>length <span class="skolem">cl</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Par <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> brnL_cases<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> Par <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>ParT <span class="skolem">cl</span> <span class="skolem">ii</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"properL <span class="skolem">cl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ii</span> <span class="main">&lt;</span> brnL <span class="skolem">cl</span> <span class="main">(</span>length <span class="skolem">cl</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ParT <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> brnL_cases<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Local <span class="skolem">n</span> <span class="skolem">i</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"WtFT <span class="skolem">cl</span> <span class="main">=</span> <span class="main">1</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Local ParT <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> pickFT <span class="skolem">cl</span> <span class="main">∧</span> <span class="skolem">i</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Local ParT <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"finished <span class="main">(</span><span class="skolem">cl</span> <span class="main">!</span> <span class="skolem">n</span><span class="main">)</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Language_Semantics-wt_le_1"><span class="command">lemma</span></span> wt_le_1<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"proper <span class="free">c</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> brn <span class="free">c</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wt <span class="free">c</span> <span class="free">s</span> <span class="free">i</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">c</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> proper_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Ch <span class="skolem">ch</span> <span class="skolem">c1</span> <span class="skolem">c2</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">using</span></span> properCh <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Par <span class="skolem">cl</span> <span class="skolem">ii</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"properL <span class="skolem">cl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ii</span> <span class="main">&lt;</span> brnL <span class="skolem">cl</span> <span class="main">(</span>length <span class="skolem">cl</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> brnL_cases<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">using</span></span> Par <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add_increasing2 diff_is_0_eq gr0_conv_Suc less_imp_diff_less less_or_eq_imp_le nth_mem of_nat_0_le_iff of_nat_Suc<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>ParT <span class="skolem">cl</span> <span class="skolem">ii</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"properL <span class="skolem">cl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ii</span> <span class="main">&lt;</span> brnL <span class="skolem">cl</span> <span class="main">(</span>length <span class="skolem">cl</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ParT <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> brnL_cases<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Local <span class="skolem">n</span> <span class="skolem">i</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"WtFT <span class="skolem">cl</span> <span class="main">=</span> <span class="main">1</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Local ParT <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> pickFT <span class="skolem">cl</span> <span class="main">∧</span> <span class="skolem">i</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">note</span></span> sch <span class="main">=</span> False
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Local ParT <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"finished <span class="main">(</span><span class="skolem">cl</span> <span class="main">!</span> <span class="skolem">n</span><span class="main">)</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">note</span></span> cln <span class="main">=</span> False
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?L1</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">/</span> <span class="main">(</span>length <span class="skolem">cl</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?L2</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"wt <span class="main">(</span><span class="skolem">cl</span> <span class="main">!</span> <span class="skolem">n</span><span class="main">)</span> <span class="skolem">s</span> <span class="skolem">i</span>"</span></span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?R</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"WtFT <span class="skolem">cl</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="var">?L1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="var">?L2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ParT Local <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L2</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ParT Local <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L1</span> <span class="main">*</span> <span class="var">?L2</span> <span class="main">≤</span> <span class="var">?L1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> mult_right_le_one_le<span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L1</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">-</span> <span class="var">?R</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ParT Local cln <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L1</span> <span class="main">*</span> <span class="var">?L2</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">-</span> <span class="var">?R</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Local ParT cln sch
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pos_divide_le_eq mult.commute<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> sch ParT Local<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">fromPlus</span> <span class="main">(</span><span class="quoted">"<span class="keyword3">(1</span><span class="keyword1">{</span>_<span class="keyword1">..&lt;+</span>_<span class="keyword1">}</span><span class="keyword3">)</span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="main"><span class="free">{</span></span><span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main"><span class="free">..&lt;+</span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main"><span class="free">}</span></span> <span class="main">≡</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">..&lt;</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1" id="Language_Semantics-brnL_UN"><span class="command">lemma</span></span> brnL_UN<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"properL <span class="free">cl</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">{..&lt;</span> brnL <span class="free">cl</span> <span class="main">(</span>length <span class="free">cl</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span> <span class="bound">n</span> <span class="main">&lt;</span> length <span class="free">cl</span><span class="main">.</span> <span class="main">{</span>brnL <span class="free">cl</span> <span class="bound">n</span> <span class="main">..&lt;+</span> brn <span class="main">(</span><span class="free">cl</span><span class="main">!</span><span class="bound">n</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>"</span></span>
<span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span> <span class="bound">n</span> <span class="main">&lt;</span> length <span class="free">cl</span><span class="main">.</span> <span class="var">?R</span> <span class="bound">n</span><span class="main">)</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ii</span> <span class="keyword3"><span class="command">assume</span></span> ii<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ii</span> <span class="main">&lt;</span> brnL <span class="free">cl</span> <span class="main">(</span>length <span class="free">cl</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> assms ii <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ii</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span> <span class="bound">n</span> <span class="main">&lt;</span> length <span class="free">cl</span><span class="main">.</span> <span class="var">?R</span> <span class="bound">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> brnL_cases<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Local <span class="skolem">n</span> <span class="skolem">i</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ii</span> <span class="main">∈</span> <span class="var">?R</span> <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Local <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Language_Semantics-brnL_Int_lt"><span class="command">lemma</span></span> brnL_Int_lt<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> n12<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n1</span> <span class="main">&lt;</span> <span class="free">n2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> n2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n2</span> <span class="main">&lt;</span> length <span class="free">cl</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span>
<span class="quoted"><span class="quoted">"<span class="main">{</span>brnL <span class="free">cl</span> <span class="free">n1</span> <span class="main">..&lt;+</span> brn <span class="main">(</span><span class="free">cl</span><span class="main">!</span><span class="free">n1</span><span class="main">)</span><span class="main">}</span> <span class="main">∩</span> <span class="main">{</span>brnL <span class="free">cl</span> <span class="free">n2</span> <span class="main">..&lt;+</span> brn <span class="main">(</span><span class="free">cl</span><span class="main">!</span><span class="free">n2</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Suc <span class="free">n1</span> <span class="main">≤</span> <span class="free">n2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"brnL <span class="free">cl</span> <span class="main">(</span>Suc <span class="free">n1</span><span class="main">)</span> <span class="main">≤</span> brnL <span class="free">cl</span> <span class="free">n2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Language_Semantics-brnL_Int"><span class="command">lemma</span></span> brnL_Int<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">n1</span> <span class="main">≠</span> <span class="free">n2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">n1</span> <span class="main">&lt;</span> length <span class="free">cl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">n2</span> <span class="main">&lt;</span> length <span class="free">cl</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span>brnL <span class="free">cl</span> <span class="free">n1</span> <span class="main">..&lt;+</span> brn <span class="main">(</span><span class="free">cl</span><span class="main">!</span><span class="free">n1</span><span class="main">)</span><span class="main">}</span> <span class="main">∩</span> <span class="main">{</span>brnL <span class="free">cl</span> <span class="free">n2</span> <span class="main">..&lt;+</span> brn <span class="main">(</span><span class="free">cl</span><span class="main">!</span><span class="free">n2</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">n1</span> <span class="main">&lt;</span> <span class="free">n2</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms brnL_Int_lt <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">n2</span> <span class="main">&lt;</span> <span class="free">n1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> brnL_Int_lt assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Language_Semantics-sum_wt_Par_sub"><span class="command">lemma</span></span> sum_wt_Par_sub<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> cl<span class="main">:</span> <span class="quoted"><span class="quoted">"properL <span class="free">cl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&lt;</span> length <span class="free">cl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">⊆</span> <span class="main">{..&lt;</span> brn <span class="main">(</span><span class="free">cl</span> <span class="main">!</span> <span class="free">n</span><span class="main">)</span><span class="main">}</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sum <span class="main">(</span>wt <span class="main">(</span>Par <span class="free">cl</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span> <span class="main">(</span><span class="main">(+)</span> <span class="main">(</span>brnL <span class="free">cl</span> <span class="free">n</span><span class="main">)</span> <span class="main">`</span> <span class="free">I</span><span class="main">)</span> <span class="main">=</span>
       <span class="main">1</span> <span class="main">/</span><span class="main">(</span>length <span class="free">cl</span><span class="main">)</span> <span class="main">*</span> sum <span class="main">(</span>wt <span class="main">(</span><span class="free">cl</span> <span class="main">!</span> <span class="free">n</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span> <span class="free">I</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">=</span> <span class="var">?wSch</span> <span class="main">*</span> <span class="var">?R</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">=</span> sum <span class="main">(</span><span class="main">%</span><span class="bound">i</span><span class="main">.</span> <span class="var">?wSch</span> <span class="main">*</span> wt <span class="main">(</span><span class="free">cl</span> <span class="main">!</span> <span class="free">n</span><span class="main">)</span> <span class="free">s</span> <span class="bound">i</span><span class="main">)</span> <span class="free">I</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> sum.reindex_cong<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">(+)</span></span> <span class="main"><span class="main">(</span></span>brnL <span class="free"><span class="free">cl</span></span> <span class="free"><span class="free">n</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="var">?wSch</span> <span class="main">*</span> <span class="var">?R</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> sum_distrib_left <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Language_Semantics-sum_wt_Par"><span class="command">lemma</span></span> sum_wt_Par<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> cl<span class="main">:</span> <span class="quoted"><span class="quoted">"properL <span class="free">cl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&lt;</span> length <span class="free">cl</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sum <span class="main">(</span>wt <span class="main">(</span>Par <span class="free">cl</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span> <span class="main">{</span>brnL <span class="free">cl</span> <span class="free">n</span> <span class="main">..&lt;+</span> brn <span class="main">(</span><span class="free">cl</span><span class="main">!</span><span class="free">n</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span>
       <span class="main">1</span> <span class="main">/</span><span class="main">(</span>length <span class="free">cl</span><span class="main">)</span> <span class="main">*</span> sum <span class="main">(</span>wt <span class="main">(</span><span class="free">cl</span> <span class="main">!</span> <span class="free">n</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span> <span class="main">{..&lt;</span> brn <span class="main">(</span><span class="free">cl</span> <span class="main">!</span> <span class="free">n</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">=</span> <span class="var">?W</span> <span class="main">*</span> <span class="var">?R</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum_distrib_left<span class="main">)</span>

<span class="keyword1" id="Language_Semantics-sum_wt_ParT_sub_WtFT_pickFT_0"><span class="command">lemma</span></span> sum_wt_ParT_sub_WtFT_pickFT_0<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> cl<span class="main">:</span> <span class="quoted"><span class="quoted">"properL <span class="free">cl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> nf<span class="main">:</span> <span class="quoted"><span class="quoted">"WtFT <span class="free">cl</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">⊆</span> <span class="main">{..&lt;</span> brn <span class="main">(</span><span class="free">cl</span> <span class="main">!</span> <span class="main">(</span>pickFT <span class="free">cl</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">∈</span> <span class="free">I</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sum <span class="main">(</span>wt <span class="main">(</span>ParT <span class="free">cl</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span> <span class="main">(</span><span class="main">(+)</span> <span class="main">(</span>brnL <span class="free">cl</span> <span class="main">(</span>pickFT <span class="free">cl</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="free">I</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">=</span> <span class="main">1</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?n</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"pickFT <span class="free">cl</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?w</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">%</span><span class="bound">i</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">i</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">(</span><span class="main">1</span><span class="main">::</span>real<span class="main">)</span> <span class="keyword1">else</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?n</span> <span class="main">&lt;</span> length <span class="free">cl</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> nf <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">=</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span> <span class="keyword1">Un</span> <span class="main">(</span><span class="free">I</span> <span class="main">-</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> I <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> finI<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">I</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> I <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> finite_nat_iff_bounded<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">=</span> sum <span class="var">?w</span> <span class="free">I</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> sum.reindex_cong <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"plus <span class="main"><span class="main">(</span></span>brnL <span class="free"><span class="free">cl</span></span> <span class="var"><span class="var">?n</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="keyword3"><span class="command">assume</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="free">I</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> brn <span class="main">(</span><span class="free">cl</span> <span class="main">!</span> <span class="var">?n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> i I <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">note</span></span> i <span class="main">=</span> this i
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wt <span class="main">(</span>ParT <span class="free">cl</span><span class="main">)</span> <span class="free">s</span> <span class="main">(</span>brnL <span class="free">cl</span> <span class="var">?n</span> <span class="main">+</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> <span class="var">?w</span> <span class="skolem">i</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> nf n i cl <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> assms<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> sum <span class="var">?w</span> <span class="main">(</span><span class="main">{</span><span class="main">0</span><span class="main">}</span> <span class="keyword1">Un</span> <span class="main">(</span><span class="free">I</span> <span class="main">-</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> sum <span class="var">?w</span> <span class="main">{</span><span class="main">0</span><span class="main">::</span>real<span class="main">}</span> <span class="main">+</span> sum <span class="var">?w</span> <span class="main">(</span><span class="free">I</span> <span class="main">-</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> sum.union_disjoint<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">0</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">-</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span>"</span></span> <span class="var"><span class="quoted"><span class="var">?w</span></span></span><span class="main">]</span> finI <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Language_Semantics-sum_wt_ParT_sub_WtFT_pickFT_0_2"><span class="command">lemma</span></span> sum_wt_ParT_sub_WtFT_pickFT_0_2<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> cl<span class="main">:</span> <span class="quoted"><span class="quoted">"properL <span class="free">cl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> nf<span class="main">:</span> <span class="quoted"><span class="quoted">"WtFT <span class="free">cl</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> II<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">II</span> <span class="main">⊆</span> <span class="main">{..&lt;</span> brnL <span class="free">cl</span> <span class="main">(</span>length <span class="free">cl</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"brnL <span class="free">cl</span> <span class="main">(</span>pickFT <span class="free">cl</span><span class="main">)</span> <span class="main">∈</span> <span class="free">II</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sum <span class="main">(</span>wt <span class="main">(</span>ParT <span class="free">cl</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span> <span class="free">II</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">=</span> <span class="main">1</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?n</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"pickFT <span class="free">cl</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?w</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">%</span><span class="bound">ii</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">ii</span> <span class="main">=</span> brnL <span class="free">cl</span> <span class="main">(</span>pickFT <span class="free">cl</span><span class="main">)</span> <span class="keyword1">then</span> <span class="main">(</span><span class="main">1</span><span class="main">::</span>real<span class="main">)</span> <span class="keyword1">else</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?n</span> <span class="main">&lt;</span> length <span class="free">cl</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> nf <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">II</span> <span class="main">=</span> <span class="main">{</span>brnL <span class="free">cl</span> <span class="var">?n</span><span class="main">}</span> <span class="keyword1">Un</span> <span class="main">(</span><span class="free">II</span> <span class="main">-</span> <span class="main">{</span>brnL <span class="free">cl</span> <span class="var">?n</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> II <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> finI<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">II</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> II <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> finite_nat_iff_bounded<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">=</span> sum <span class="var">?w</span> <span class="free">II</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> sum.cong<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ii</span> <span class="keyword3"><span class="command">assume</span></span> ii<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ii</span> <span class="main">∈</span> <span class="free">II</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> ii<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ii</span> <span class="main">&lt;</span> brnL <span class="free">cl</span> <span class="main">(</span>length <span class="free">cl</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> II <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> cl ii <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wt <span class="main">(</span>ParT <span class="free">cl</span><span class="main">)</span> <span class="free">s</span> <span class="skolem">ii</span> <span class="main">=</span> <span class="var">?w</span> <span class="skolem">ii</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> brnL_cases<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Local <span class="skolem">n</span> <span class="skolem">i</span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">ii</span> <span class="main">=</span> brnL <span class="free">cl</span> <span class="main">(</span>pickFT <span class="free">cl</span><span class="main">)</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> pickFT <span class="free">cl</span> <span class="main">∧</span> <span class="skolem">i</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">intro</span> brnL_unique<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">cl</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> Local cl nf brn_gt_0 <span class="keyword1"><span class="command">unfolding</span></span> True <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> cl nf True <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> pickFT <span class="free">cl</span> <span class="main">⟶</span> <span class="skolem">i</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> Local <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Local ii nf cl False <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> sum <span class="var">?w</span> <span class="main">(</span><span class="main">{</span>brnL <span class="free">cl</span> <span class="var">?n</span><span class="main">}</span> <span class="keyword1">Un</span> <span class="main">(</span><span class="free">II</span> <span class="main">-</span> <span class="main">{</span>brnL <span class="free">cl</span> <span class="var">?n</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> sum <span class="var">?w</span> <span class="main">{</span>brnL <span class="free">cl</span> <span class="var">?n</span><span class="main">}</span> <span class="main">+</span> sum <span class="var">?w</span> <span class="main">(</span><span class="free">II</span> <span class="main">-</span> <span class="main">{</span>brnL <span class="free">cl</span> <span class="var">?n</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> sum.union_disjoint<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> finI <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Language_Semantics-sum_wt_ParT_sub_WtFT_notPickFT_0"><span class="command">lemma</span></span> sum_wt_ParT_sub_WtFT_notPickFT_0<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> cl<span class="main">:</span> <span class="quoted"><span class="quoted">"properL <span class="free">cl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> nf<span class="main">:</span> <span class="quoted"><span class="quoted">"WtFT <span class="free">cl</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&lt;</span> length <span class="free">cl</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">⊆</span> <span class="main">{..&lt;</span> brn <span class="main">(</span><span class="free">cl</span> <span class="main">!</span> <span class="free">n</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> nI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> pickFT <span class="free">cl</span> <span class="main">⟶</span> <span class="main">0</span> <span class="main">∉</span> <span class="free">I</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sum <span class="main">(</span>wt <span class="main">(</span>ParT <span class="free">cl</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span> <span class="main">(</span><span class="main">(+)</span> <span class="main">(</span>brnL <span class="free">cl</span> <span class="free">n</span><span class="main">)</span> <span class="main">`</span> <span class="free">I</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">=</span> sum <span class="main">(</span><span class="main">%</span><span class="bound">i</span><span class="main">.</span> <span class="main">0</span><span class="main">)</span> <span class="free">I</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> sum.reindex_cong <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"plus <span class="main"><span class="main">(</span></span>brnL <span class="free"><span class="free">cl</span></span> <span class="free"><span class="free">n</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="keyword3"><span class="command">assume</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="free">I</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> pickFT <span class="free">cl</span> <span class="main">⟶</span> <span class="skolem">i</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> nI <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> brn <span class="main">(</span><span class="free">cl</span> <span class="main">!</span> <span class="free">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> i I <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wt <span class="main">(</span>ParT <span class="free">cl</span><span class="main">)</span> <span class="free">s</span> <span class="main">(</span>brnL <span class="free">cl</span> <span class="free">n</span> <span class="main">+</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> nf n cl <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> assms<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Language_Semantics-sum_wt_ParT_sub_notWtFT_finished"><span class="command">lemma</span></span> sum_wt_ParT_sub_notWtFT_finished<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> cl<span class="main">:</span> <span class="quoted"><span class="quoted">"properL <span class="free">cl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> nf<span class="main">:</span> <span class="quoted"><span class="quoted">"WtFT <span class="free">cl</span> <span class="main">≠</span> <span class="main">1</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&lt;</span> length <span class="free">cl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> cln<span class="main">:</span> <span class="quoted"><span class="quoted">"finished <span class="main">(</span><span class="free">cl</span><span class="main">!</span><span class="free">n</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">⊆</span> <span class="main">{..&lt;</span> brn <span class="main">(</span><span class="free">cl</span> <span class="main">!</span> <span class="free">n</span><span class="main">)</span><span class="main">}</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sum <span class="main">(</span>wt <span class="main">(</span>ParT <span class="free">cl</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span> <span class="main">(</span><span class="main">(+)</span> <span class="main">(</span>brnL <span class="free">cl</span> <span class="free">n</span><span class="main">)</span> <span class="main">`</span> <span class="free">I</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">=</span> sum <span class="main">(</span><span class="main">%</span><span class="bound">i</span><span class="main">.</span> <span class="main">0</span><span class="main">)</span> <span class="free">I</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> sum.reindex_cong<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">(+)</span></span> <span class="main"><span class="main">(</span></span>brnL <span class="free"><span class="free">cl</span></span> <span class="free"><span class="free">n</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Language_Semantics-sum_wt_ParT_sub_notWtFT_notFinished"><span class="command">lemma</span></span> sum_wt_ParT_sub_notWtFT_notFinished<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> cl<span class="main">:</span> <span class="quoted"><span class="quoted">"properL <span class="free">cl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> nf<span class="main">:</span> <span class="quoted"><span class="quoted">"WtFT <span class="free">cl</span> <span class="main">≠</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&lt;</span> length <span class="free">cl</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> cln<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> finished <span class="main">(</span><span class="free">cl</span><span class="main">!</span><span class="free">n</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">⊆</span> <span class="main">{..&lt;</span> brn <span class="main">(</span><span class="free">cl</span> <span class="main">!</span> <span class="free">n</span><span class="main">)</span><span class="main">}</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span>
<span class="quoted"><span class="quoted">"sum <span class="main">(</span>wt <span class="main">(</span>ParT <span class="free">cl</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span> <span class="main">(</span><span class="main">(+)</span> <span class="main">(</span>brnL <span class="free">cl</span> <span class="free">n</span><span class="main">)</span> <span class="main">`</span> <span class="free">I</span><span class="main">)</span> <span class="main">=</span>
 <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="main">(</span>length <span class="free">cl</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> WtFT <span class="free">cl</span><span class="main">)</span> <span class="main">*</span> sum <span class="main">(</span>wt <span class="main">(</span><span class="free">cl</span> <span class="main">!</span> <span class="free">n</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span> <span class="free">I</span>"</span></span>
<span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">=</span> <span class="var">?w</span> <span class="main">/</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="var">?wF</span><span class="main">)</span> <span class="main">*</span> <span class="var">?R</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">=</span> sum <span class="main">(</span><span class="main">%</span><span class="bound">i</span><span class="main">.</span> <span class="var">?w</span> <span class="main">/</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="var">?wF</span><span class="main">)</span> <span class="main">*</span> wt <span class="main">(</span><span class="free">cl</span> <span class="main">!</span> <span class="free">n</span><span class="main">)</span> <span class="free">s</span> <span class="bound">i</span><span class="main">)</span> <span class="free">I</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> sum.reindex_cong<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">(+)</span></span> <span class="main"><span class="main">(</span></span>brnL <span class="free"><span class="free">cl</span></span> <span class="free"><span class="free">n</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="var">?w</span> <span class="main">/</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="var">?wF</span><span class="main">)</span> <span class="main">*</span> <span class="var">?R</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> sum_distrib_left <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Language_Semantics-sum_wt_ParT_WtFT_pickFT_0"><span class="command">lemma</span></span> sum_wt_ParT_WtFT_pickFT_0<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> cl<span class="main">:</span> <span class="quoted"><span class="quoted">"properL <span class="free">cl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> nf<span class="main">:</span> <span class="quoted"><span class="quoted">"WtFT <span class="free">cl</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sum <span class="main">(</span>wt <span class="main">(</span>ParT <span class="free">cl</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span> <span class="main">{</span>brnL <span class="free">cl</span> <span class="main">(</span>pickFT <span class="free">cl</span><span class="main">)</span> <span class="main">..&lt;+</span> brn <span class="main">(</span><span class="free">cl</span> <span class="main">!</span> <span class="main">(</span>pickFT <span class="free">cl</span><span class="main">)</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?n</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"pickFT <span class="free">cl</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span>brnL <span class="free">cl</span> <span class="var">?n</span> <span class="main">..&lt;+</span> brn <span class="main">(</span><span class="free">cl</span> <span class="main">!</span> <span class="var">?n</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span>
  <span class="main">(+)</span> <span class="main">(</span>brnL <span class="free">cl</span> <span class="var">?n</span><span class="main">)</span> <span class="main">`</span> <span class="main">{..&lt;</span> brn <span class="main">(</span><span class="free">cl</span> <span class="main">!</span> <span class="var">?n</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> 1
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> sum_wt_ParT_sub_WtFT_pickFT_0<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> brn_gt_0_L nth_mem pickFT_length<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Language_Semantics-sum_wt_ParT_WtFT_notPickFT_0"><span class="command">lemma</span></span> sum_wt_ParT_WtFT_notPickFT_0<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> cl<span class="main">:</span> <span class="quoted"><span class="quoted">"properL <span class="free">cl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> nf<span class="main">:</span> <span class="quoted"><span class="quoted">"WtFT <span class="free">cl</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&lt;</span> length <span class="free">cl</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≠</span> pickFT <span class="free">cl</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sum <span class="main">(</span>wt <span class="main">(</span>ParT <span class="free">cl</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span> <span class="main">{</span>brnL <span class="free">cl</span> <span class="free">n</span> <span class="main">..&lt;+</span> brn <span class="main">(</span><span class="free">cl</span><span class="main">!</span><span class="free">n</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span>brnL <span class="free">cl</span> <span class="free">n</span> <span class="main">..&lt;+</span> brn <span class="main">(</span><span class="free">cl</span><span class="main">!</span><span class="free">n</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span> <span class="main">(+)</span> <span class="main">(</span>brnL <span class="free">cl</span> <span class="free">n</span><span class="main">)</span> <span class="main">`</span> <span class="main">{..&lt;</span> brn <span class="main">(</span><span class="free">cl</span><span class="main">!</span><span class="free">n</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> 1 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> sum_wt_ParT_sub_WtFT_notPickFT_0<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Language_Semantics-sum_wt_ParT_notWtFT_finished"><span class="command">lemma</span></span> sum_wt_ParT_notWtFT_finished<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> cl<span class="main">:</span> <span class="quoted"><span class="quoted">"properL <span class="free">cl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"WtFT <span class="free">cl</span> <span class="main">≠</span> <span class="main">1</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&lt;</span> length <span class="free">cl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> cln<span class="main">:</span> <span class="quoted"><span class="quoted">"finished <span class="main">(</span><span class="free">cl</span><span class="main">!</span><span class="free">n</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sum <span class="main">(</span>wt <span class="main">(</span>ParT <span class="free">cl</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span> <span class="main">{</span>brnL <span class="free">cl</span> <span class="free">n</span> <span class="main">..&lt;+</span> brn <span class="main">(</span><span class="free">cl</span><span class="main">!</span><span class="free">n</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span>brnL <span class="free">cl</span> <span class="free">n</span> <span class="main">..&lt;+</span> brn <span class="main">(</span><span class="free">cl</span><span class="main">!</span><span class="free">n</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span> <span class="main">(+)</span> <span class="main">(</span>brnL <span class="free">cl</span> <span class="free">n</span><span class="main">)</span> <span class="main">`</span> <span class="main">{..&lt;</span> brn <span class="main">(</span><span class="free">cl</span><span class="main">!</span><span class="free">n</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> 1
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> sum_wt_ParT_sub_notWtFT_finished<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Language_Semantics-sum_wt_ParT_notWtFT_notFinished"><span class="command">lemma</span></span> sum_wt_ParT_notWtFT_notFinished<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> cl<span class="main">:</span> <span class="quoted"><span class="quoted">"properL <span class="free">cl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> nf<span class="main">:</span> <span class="quoted"><span class="quoted">"WtFT <span class="free">cl</span> <span class="main">≠</span> <span class="main">1</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&lt;</span> length <span class="free">cl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> cln<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> finished <span class="main">(</span><span class="free">cl</span><span class="main">!</span><span class="free">n</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span>
<span class="quoted"><span class="quoted">"sum <span class="main">(</span>wt <span class="main">(</span>ParT <span class="free">cl</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span> <span class="main">{</span>brnL <span class="free">cl</span> <span class="free">n</span> <span class="main">..&lt;+</span> brn <span class="main">(</span><span class="free">cl</span><span class="main">!</span><span class="free">n</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span>
 <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="main">(</span>length <span class="free">cl</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> WtFT <span class="free">cl</span><span class="main">)</span> <span class="main">*</span>
 sum <span class="main">(</span>wt <span class="main">(</span><span class="free">cl</span> <span class="main">!</span> <span class="free">n</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span> <span class="main">{..&lt;</span> brn <span class="main">(</span><span class="free">cl</span> <span class="main">!</span> <span class="free">n</span><span class="main">)</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span>brnL <span class="free">cl</span> <span class="free">n</span> <span class="main">..&lt;+</span> brn <span class="main">(</span><span class="free">cl</span><span class="main">!</span><span class="free">n</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span> <span class="main">(+)</span> <span class="main">(</span>brnL <span class="free">cl</span> <span class="free">n</span><span class="main">)</span> <span class="main">`</span> <span class="main">{..&lt;</span> brn <span class="main">(</span><span class="free">cl</span><span class="main">!</span><span class="free">n</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> 1 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> sum_wt_ParT_sub_notWtFT_notFinished<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Language_Semantics-sum_wt"><span class="command">lemma</span></span> sum_wt<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"proper <span class="free">c</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sum <span class="main">(</span>wt <span class="free">c</span> <span class="free">s</span><span class="main">)</span> <span class="main">{..&lt;</span> brn <span class="free">c</span><span class="main">}</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">c</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> proper_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Par <span class="skolem">cl</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?w</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">n</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> <span class="main">(</span>length <span class="skolem">cl</span><span class="main">)</span> <span class="main">*</span> sum <span class="main">(</span>wt <span class="main">(</span><span class="skolem">cl</span> <span class="main">!</span> <span class="bound">n</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">{..&lt;</span> brn <span class="main">(</span><span class="skolem">cl</span> <span class="main">!</span> <span class="bound">n</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> sum_UN_introL <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">%</span></span><span class="bound"><span class="bound">n</span></span><span class="main"><span class="main">.</span></span> <span class="main"><span class="main">{</span></span>brnL <span class="skolem"><span class="skolem">cl</span></span> <span class="bound"><span class="bound">n</span></span> <span class="main"><span class="main">..&lt;+</span></span> brn <span class="main"><span class="main">(</span></span><span class="skolem"><span class="skolem">cl</span></span><span class="main"><span class="main">!</span></span><span class="bound"><span class="bound">n</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">}</span></span>"</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">{..&lt;</span></span> length <span class="skolem"><span class="skolem">cl</span></span><span class="main"><span class="main">}</span></span>"</span></span></span> <span class="main"><span class="main">_</span></span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?w</span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">=</span> sum <span class="main">(</span><span class="main">λ</span> <span class="bound">n</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> <span class="main">(</span>length <span class="skolem">cl</span><span class="main">)</span><span class="main">)</span> <span class="main">{..&lt;</span> length <span class="skolem">cl</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Par <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> sum <span class="var">?w</span> <span class="main">{..&lt;</span> length <span class="skolem">cl</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Par <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">=</span> sum <span class="var">?w</span> <span class="main">{..&lt;</span> length <span class="skolem">cl</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">m</span> <span class="skolem">n</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="skolem">m</span><span class="main">,</span> <span class="skolem">n</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">{..&lt;</span>length <span class="skolem">cl</span><span class="main">}</span> <span class="main">∧</span> <span class="skolem">m</span> <span class="main">≠</span> <span class="skolem">n</span>"</span></span>
    <span class="keyword3"><span class="command">thus</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">{</span>brnL <span class="skolem">cl</span> <span class="skolem">m</span> <span class="main">..&lt;+</span> brn <span class="main">(</span><span class="skolem">cl</span><span class="main">!</span><span class="skolem">m</span><span class="main">)</span><span class="main">}</span> <span class="main">∩</span> <span class="main">{</span>brnL <span class="skolem">cl</span> <span class="skolem">n</span> <span class="main">..&lt;+</span> brn <span class="main">(</span><span class="skolem">cl</span><span class="main">!</span><span class="skolem">n</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> brnL_Int <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span><span class="main">(</span><span class="operator">insert</span> Par brnL_UN sum_wt_Par<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>ParT <span class="skolem">cl</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?v</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">1</span><span class="main">/</span><span class="main">(</span>length <span class="skolem">cl</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?wtF</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"WtFT <span class="skolem">cl</span>"</span></span> <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?wtNF</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"WtNFT <span class="skolem">cl</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?w</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">n</span><span class="main">.</span>
  <span class="keyword1">if</span> <span class="var">?wtF</span> <span class="main">=</span> <span class="main">1</span>
    <span class="keyword1">then</span>
      <span class="main">(</span><span class="keyword1">if</span> <span class="bound">n</span> <span class="main">=</span> pickFT <span class="skolem">cl</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>
    <span class="keyword1">else</span>
      <span class="main">(</span><span class="keyword1">if</span> finished <span class="main">(</span><span class="skolem">cl</span><span class="main">!</span><span class="bound">n</span><span class="main">)</span>
         <span class="keyword1">then</span> <span class="main">0</span>
         <span class="keyword1">else</span> <span class="var">?v</span> <span class="main">/</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="var">?wtF</span><span class="main">)</span> <span class="main">*</span>
              sum <span class="main">(</span>wt <span class="main">(</span><span class="skolem">cl</span> <span class="main">!</span> <span class="bound">n</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">{..&lt;</span> brn <span class="main">(</span><span class="skolem">cl</span> <span class="main">!</span> <span class="bound">n</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">=</span> <span class="var">?w</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> w<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">n</span><span class="main">.</span> <span class="var">?wtF</span> <span class="main">≠</span> <span class="main">1</span> <span class="main">∧</span> <span class="bound">n</span> <span class="main">&lt;</span> length <span class="skolem">cl</span> <span class="main">∧</span> <span class="main">¬</span> finished <span class="main">(</span><span class="skolem">cl</span><span class="main">!</span><span class="bound">n</span><span class="main">)</span>
  <span class="main">⟹</span> <span class="skolem">w</span> <span class="bound">n</span> <span class="main">=</span> <span class="var">?v</span> <span class="main">/</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="var">?wtF</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> w_def <span class="keyword1"><span class="command">using</span></span> ParT <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"WtFT <span class="skolem">cl</span> <span class="main">=</span> <span class="main">1</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">with</span></span> ParT <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">note</span></span> nf <span class="main">=</span> False
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> sum_UN_introL <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">%</span></span><span class="bound"><span class="bound">n</span></span><span class="main"><span class="main">.</span></span> <span class="main"><span class="main">{</span></span>brnL <span class="skolem"><span class="skolem">cl</span></span> <span class="bound"><span class="bound">n</span></span> <span class="main"><span class="main">..&lt;+</span></span> brn <span class="main"><span class="main">(</span></span><span class="skolem"><span class="skolem">cl</span></span><span class="main"><span class="main">!</span></span><span class="bound"><span class="bound">n</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">}</span></span>"</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">{..&lt;</span></span> length <span class="skolem"><span class="skolem">cl</span></span><span class="main"><span class="main">}</span></span>"</span></span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">w</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">=</span> sum <span class="skolem">w</span> <span class="main">{..&lt;</span> length <span class="skolem">cl</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="var">?wtF</span> <span class="main">=</span> <span class="main">1</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">note</span></span> sch <span class="main">=</span> True
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?n</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"pickFT <span class="skolem">cl</span>"</span></span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?L</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="var">?n</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Lnot</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{..&lt;</span>length <span class="skolem">cl</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="var">?n</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?n</span> <span class="main">&lt;</span> length <span class="skolem">cl</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ParT True <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">{..&lt;</span> length <span class="skolem">cl</span><span class="main">}</span> <span class="main">=</span> <span class="var">?L</span> <span class="keyword1">Un</span> <span class="var">?Lnot</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"sum <span class="skolem">w</span> <span class="main">{..&lt;</span> length <span class="skolem">cl</span><span class="main">}</span> <span class="main">=</span> sum <span class="skolem">w</span> <span class="main">(</span><span class="var">?L</span> <span class="keyword1">Un</span> <span class="var">?Lnot</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> sum <span class="skolem">w</span> <span class="var">?L</span> <span class="main">+</span> sum <span class="skolem">w</span> <span class="var">?Lnot</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> sum.union_disjoint<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> w_def <span class="keyword1"><span class="command">using</span></span> sch <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">note</span></span> sch <span class="main">=</span> False
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?L</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"theFT <span class="skolem">cl</span>"</span></span> <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Lnot</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"theNFT <span class="skolem">cl</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{..&lt;</span> length <span class="skolem">cl</span><span class="main">}</span> <span class="main">=</span> <span class="var">?L</span> <span class="keyword1">Un</span> <span class="var">?Lnot</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum <span class="skolem">w</span> <span class="main">{..&lt;</span> length <span class="skolem">cl</span><span class="main">}</span> <span class="main">=</span> sum <span class="skolem">w</span> <span class="var">?L</span> <span class="main">+</span> sum <span class="skolem">w</span> <span class="var">?Lnot</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> 1 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> sum.union_disjoint<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> sum <span class="skolem">w</span> <span class="var">?Lnot</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> w_def <span class="keyword1"><span class="command">using</span></span> sch <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> sum <span class="main">(</span><span class="main">%</span><span class="bound">n</span><span class="main">.</span> <span class="var">?v</span> <span class="main">/</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="var">?wtF</span><span class="main">)</span><span class="main">)</span> <span class="var">?Lnot</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> sum.cong<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> w sch <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> sum <span class="main">(</span><span class="main">%</span><span class="bound">n</span><span class="main">.</span> <span class="var">?v</span><span class="main">)</span> <span class="var">?Lnot</span> <span class="main">/</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="var">?wtF</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> sum_divide_distrib <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="var">?wtNF</span> <span class="main">/</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="var">?wtF</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> WtNFT_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> nf ParT <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span> <span class="keyword3"><span class="command">assume</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">∈</span> <span class="main">{..&lt;</span>length <span class="skolem">cl</span><span class="main">}</span>"</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sum <span class="main">(</span>wt <span class="main">(</span>ParT <span class="skolem">cl</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">{</span>brnL <span class="skolem">cl</span> <span class="skolem">n</span><span class="main">..&lt;+</span>brn <span class="main">(</span><span class="skolem">cl</span> <span class="main">!</span> <span class="skolem">n</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span> <span class="skolem">w</span> <span class="skolem">n</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span>brn <span class="main">(</span><span class="skolem">cl</span> <span class="main">!</span> <span class="skolem">n</span><span class="main">)</span><span class="main">.</span> <span class="var">?v</span> <span class="main">*</span> wt <span class="main">(</span><span class="skolem">cl</span> <span class="main">!</span> <span class="skolem">n</span><span class="main">)</span> <span class="skolem">s</span> <span class="bound">i</span> <span class="main">/</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="var">?wtF</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
        <span class="var">?v</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span>brn <span class="main">(</span><span class="skolem">cl</span> <span class="main">!</span> <span class="skolem">n</span><span class="main">)</span><span class="main">.</span> wt <span class="main">(</span><span class="skolem">cl</span> <span class="main">!</span> <span class="skolem">n</span><span class="main">)</span> <span class="skolem">s</span> <span class="bound">i</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="var">?wtF</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> sum_distrib_left sum_divide_distrib <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="var">?v</span> <span class="main">/</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="var">?wtF</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ParT n <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span>brn <span class="main">(</span><span class="skolem">cl</span> <span class="main">!</span> <span class="skolem">n</span><span class="main">)</span><span class="main">.</span> <span class="var">?v</span> <span class="main">*</span> wt <span class="main">(</span><span class="skolem">cl</span> <span class="main">!</span> <span class="skolem">n</span><span class="main">)</span> <span class="skolem">s</span> <span class="bound">i</span> <span class="main">/</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="var">?wtF</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
        <span class="var">?v</span> <span class="main">/</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="var">?wtF</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> w_def <span class="keyword1"><span class="command">using</span></span> n nf ParT <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span><span class="main">(</span><span class="operator">insert</span> ParT brnL_UN brnL_Int sum_wt_Par<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Language_Semantics-proper_cont"><span class="command">lemma</span></span> proper_cont<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"proper <span class="free">c</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> brn <span class="free">c</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"proper <span class="main">(</span>cont <span class="free">c</span> <span class="free">s</span> <span class="free">i</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">c</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> cmd.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Ch <span class="skolem">ch</span> <span class="skolem">c1</span> <span class="skolem">c2</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Seq <span class="skolem">c1</span> <span class="skolem">c2</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"finished <span class="main">(</span>cont <span class="skolem">c1</span> <span class="skolem">s</span> <span class="skolem">i</span><span class="main">)</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>While <span class="skolem">tst</span> <span class="skolem">c</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">tval</span> <span class="skolem">tst</span> <span class="skolem">s</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Par <span class="skolem">cl</span> <span class="skolem">ii</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"properL <span class="skolem">cl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ii</span> <span class="main">&lt;</span> brnL <span class="skolem">cl</span> <span class="main">(</span>length <span class="skolem">cl</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">using</span></span> Par <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> brnL_cases<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>ParT <span class="skolem">cl</span> <span class="skolem">ii</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"properL <span class="skolem">cl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ii</span> <span class="main">&lt;</span> brnL <span class="skolem">cl</span> <span class="main">(</span>length <span class="skolem">cl</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ParT <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> brnL_cases<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> ParT <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Language_Semantics-sum_subset_le_1"><span class="command">lemma</span></span> sum_subset_le_1<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"proper <span class="free">c</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">⊆</span> <span class="main">{..&lt;</span> brn <span class="free">c</span><span class="main">}</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sum <span class="main">(</span>wt <span class="free">c</span> <span class="free">s</span><span class="main">)</span> <span class="free">I</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">J</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">J</span> <span class="main">=</span> <span class="main">{..&lt;</span> brn <span class="free">c</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">⊆</span> <span class="skolem">J</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"finite <span class="skolem">J</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ** <span class="keyword1"><span class="command">unfolding</span></span> J_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">j</span> <span class="main">∈</span> <span class="skolem">J</span><span class="main">.</span> wt <span class="free">c</span> <span class="free">s</span> <span class="bound">j</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> J_def <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum <span class="main">(</span>wt <span class="free">c</span> <span class="free">s</span><span class="main">)</span> <span class="free">I</span> <span class="main">≤</span> sum <span class="main">(</span>wt <span class="free">c</span> <span class="free">s</span><span class="main">)</span> <span class="skolem">J</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> sum_mono2<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">J</span></span> <span class="quoted"><span class="free">I</span></span> <span class="quoted"><span class="quoted">"wt <span class="free">c</span> <span class="free">s</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">unfolding</span></span> J_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sum <span class="main">(</span>wt <span class="free">c</span> <span class="free">s</span><span class="main">)</span> <span class="free">I</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> J_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Language_Semantics-sum_le_1"><span class="command">lemma</span></span> sum_le_1<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"proper <span class="free">c</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> brn <span class="free">c</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sum <span class="main">(</span>wt <span class="free">c</span> <span class="free">s</span><span class="main">)</span> <span class="main">{..</span><span class="free">i</span><span class="main">}</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{..</span><span class="free">i</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">{..&lt;</span> brn <span class="free">c</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ** <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms sum_subset_le_1<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">c</span></span> <span class="quoted"><span class="quoted">"<span class="main">{..</span><span class="free">i</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Operations on configurations›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">cont_eff</span> <span class="free"><span class="bound"><span class="entity">cf</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">=</span> snd <span class="main">(</span>wt_cont_eff <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">cf</span></span></span><span class="main">)</span> <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">cf</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Language_Semantics-cont_eff"><span class="command">lemma</span></span> cont_eff<span class="main">:</span> <span class="quoted"><span class="quoted">"cont_eff <span class="free">cf</span> <span class="free">b</span> <span class="main">=</span> <span class="main">(</span>cont <span class="main">(</span>fst <span class="free">cf</span><span class="main">)</span> <span class="main">(</span>snd <span class="free">cf</span><span class="main">)</span> <span class="free">b</span><span class="main">,</span> eff <span class="main">(</span>fst <span class="free">cf</span><span class="main">)</span> <span class="main">(</span>snd <span class="free">cf</span><span class="main">)</span> <span class="free">b</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> cont_eff_def cont_def eff_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* context PL *)</span>


<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Resumption_Based">
<div class="head">
<h1>Theory Resumption_Based</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Resumption-Based Noninterference›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Resumption_Based
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Language_Semantics.html">Language_Semantics</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="comment1">(* We introduce the resumption based notions: strong probabilistic bisimilarity ≈s and
01- probabilistic bisimilarity ≈01, and prove their basic properties.  E.g., we prove that
≈s is symmetric and transitive.
*)</span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'a</span> rel <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span><span class="tfree">'a</span><span class="main">)</span> set"</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Preliminaries›</span></span>

<span class="keyword1" id="Resumption_Based-int_emp"><span class="command">lemma</span></span> int_emp<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">{..&lt;</span><span class="free">i</span><span class="main">}</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms emptyE lessThan_iff<span class="main">)</span>

<span class="keyword1" id="Resumption_Based-inj_on_inv_into"><span class="command">lemma</span></span> inj_on_inv_into<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="free">F</span> <span class="free">P</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"inv_into <span class="free">P</span> <span class="free">F</span> <span class="main">`</span> <span class="main">(</span><span class="free">F</span> <span class="main">`</span> <span class="free">P</span><span class="main">)</span> <span class="main">=</span> <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Resumption_Based-inj_on_inv_into2"><span class="command">lemma</span></span> inj_on_inv_into2<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="quoted"><span class="quoted">"inj_on <span class="main">(</span>inv_into <span class="free">P</span> <span class="free">F</span><span class="main">)</span> <span class="main">(</span><span class="free">F</span> <span class="main">`</span> <span class="free">P</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Hilbert_Choice.inj_on_inv_into subset_refl<span class="main">)</span>

<span class="keyword1" id="Resumption_Based-refl_gfp"><span class="command">lemma</span></span> refl_gfp<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"mono <span class="free">Retr</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">theta</span><span class="main">.</span> refl <span class="bound">theta</span> <span class="main">⟹</span> refl <span class="main">(</span><span class="free">Retr</span> <span class="bound">theta</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"refl <span class="main">(</span>gfp <span class="free">Retr</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">bis</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">bis</span> <span class="main">=</span> gfp <span class="free">Retr</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">th</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">th</span> <span class="main">=</span> Id <span class="keyword1">Un</span> <span class="skolem">bis</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">bis</span> <span class="main">⊆</span> <span class="free">Retr</span> <span class="skolem">bis</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">unfolding</span></span> bis_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> gfp_unfold subset_refl<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⊆</span> <span class="free">Retr</span> <span class="skolem">th</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">unfolding</span></span> mono_def th_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">bis</span> <span class="main">⊆</span> <span class="free">Retr</span> <span class="skolem">th</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span><span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"refl <span class="skolem">th</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> th_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Un_commute refl_reflcl<span class="main">)</span>
   <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"refl <span class="main">(</span><span class="free">Retr</span> <span class="skolem">th</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Id <span class="main">⊆</span> <span class="free">Retr</span> <span class="skolem">th</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> th_def refl_on_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Id <span class="main">⊆</span> <span class="skolem">bis</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 coinduct <span class="keyword1"><span class="command">unfolding</span></span> th_def bis_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> bis_def refl_on_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Resumption_Based-sym_gfp"><span class="command">lemma</span></span> sym_gfp<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"mono <span class="free">Retr</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">theta</span><span class="main">.</span> sym <span class="bound">theta</span> <span class="main">⟹</span> sym <span class="main">(</span><span class="free">Retr</span> <span class="bound">theta</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sym <span class="main">(</span>gfp <span class="free">Retr</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">bis</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">bis</span> <span class="main">=</span> gfp <span class="free">Retr</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">th</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">th</span> <span class="main">=</span> <span class="skolem">bis</span> <span class="main">^-1</span> <span class="keyword1">Un</span> <span class="skolem">bis</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">bis</span> <span class="main">⊆</span> <span class="free">Retr</span> <span class="skolem">bis</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">unfolding</span></span> bis_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> gfp_unfold subset_refl<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⊆</span> <span class="free">Retr</span> <span class="skolem">th</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">unfolding</span></span> mono_def th_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">bis</span> <span class="main">⊆</span> <span class="free">Retr</span> <span class="skolem">th</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span><span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sym <span class="skolem">th</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> th_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Un_commute sym_Un_converse<span class="main">)</span>
   <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"sym <span class="main">(</span><span class="free">Retr</span> <span class="skolem">th</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">bis</span> <span class="main">^-1</span> <span class="main">⊆</span> <span class="free">Retr</span> <span class="skolem">th</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Un_absorb2 Un_commute Un_upper1 converse_Un sym_conv_converse_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">bis</span> <span class="main">^-1</span> <span class="main">⊆</span> <span class="skolem">bis</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 coinduct<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">Retr</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">bis</span> <span class="main">^-1</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> th_def bis_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> bis_def sym_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Resumption_Based-trancl_trans"><span class="command">lemma</span></span> trancl_trans<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"trans <span class="free">R</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">^+</span> <span class="main">⊆</span> <span class="free">R</span> <span class="main">⟷</span> <span class="free">P</span> <span class="main">⊆</span> <span class="free">R</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊆</span> <span class="free">R</span>"</span></span>
   <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">^+</span> <span class="main">⊆</span> <span class="free">R</span> <span class="main">^+</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> trancl_mono <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
   <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">^+</span> <span class="main">=</span> <span class="free">R</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms trans_trancl <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
   <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">^+</span> <span class="main">⊆</span> <span class="free">R</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Resumption_Based-trans_gfp"><span class="command">lemma</span></span> trans_gfp<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"mono <span class="free">Retr</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">theta</span><span class="main">.</span> trans <span class="bound">theta</span> <span class="main">⟹</span> trans <span class="main">(</span><span class="free">Retr</span> <span class="bound">theta</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"trans <span class="main">(</span>gfp <span class="free">Retr</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">bis</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">bis</span> <span class="main">=</span> gfp <span class="free">Retr</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">th</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">th</span> <span class="main">=</span> <span class="skolem">bis</span> <span class="main">^+</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">bis</span> <span class="main">⊆</span> <span class="free">Retr</span> <span class="skolem">bis</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">unfolding</span></span> bis_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> gfp_unfold subset_refl<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⊆</span> <span class="free">Retr</span> <span class="skolem">th</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">unfolding</span></span> mono_def th_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> trancl_trans order_refl trans_trancl<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">bis</span> <span class="main">⊆</span> <span class="free">Retr</span> <span class="skolem">th</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span><span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"trans <span class="skolem">th</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> th_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> th_def trans_trancl<span class="main">)</span>
   <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"trans <span class="main">(</span><span class="free">Retr</span> <span class="skolem">th</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">bis</span> <span class="main">^+</span> <span class="main">⊆</span> <span class="free">Retr</span> <span class="skolem">th</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">bis</span> <span class="main">^+</span> <span class="main">⊆</span> <span class="skolem">bis</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 coinduct <span class="keyword1"><span class="command">unfolding</span></span> th_def bis_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> bis_def gfp_upperbound th_def<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> bis_def trans_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Resumption_Based-O_subset_trans"><span class="command">lemma</span></span> O_subset_trans<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="keyword1">O</span> <span class="free">r</span> <span class="main">⊆</span> <span class="free">r</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"trans <span class="free">r</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> trans_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Resumption_Based-trancl_imp_trans"><span class="command">lemma</span></span> trancl_imp_trans<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">^+</span> <span class="main">⊆</span> <span class="free">r</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"trans <span class="free">r</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Int_absorb1 Int_commute trancl_trans assms subset_refl trans_trancl<span class="main">)</span>

<span class="keyword1" id="Resumption_Based-sym_trans_gfp"><span class="command">lemma</span></span> sym_trans_gfp<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"mono <span class="free">Retr</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">theta</span><span class="main">.</span> sym <span class="bound">theta</span> <span class="main">∧</span> trans <span class="bound">theta</span> <span class="main">⟹</span> sym <span class="main">(</span><span class="free">Retr</span> <span class="bound">theta</span><span class="main">)</span> <span class="main">∧</span> trans <span class="main">(</span><span class="free">Retr</span> <span class="bound">theta</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sym <span class="main">(</span>gfp <span class="free">Retr</span><span class="main">)</span> <span class="main">∧</span> trans <span class="main">(</span>gfp <span class="free">Retr</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">bis</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">bis</span> <span class="main">=</span> gfp <span class="free">Retr</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">th</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">th</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">bis</span> <span class="keyword1">Un</span> <span class="skolem">bis</span> <span class="main">^-1</span><span class="main">)</span> <span class="main">^+</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">bis</span> <span class="main">⊆</span> <span class="free">Retr</span> <span class="skolem">bis</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">unfolding</span></span> bis_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> gfp_unfold subset_refl<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⊆</span> <span class="free">Retr</span> <span class="skolem">th</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">unfolding</span></span> mono_def th_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> inf_sup_absorb le_iff_inf sup_aci<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> trancl_unfold<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">bis</span> <span class="main">⊆</span> <span class="free">Retr</span> <span class="skolem">th</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">bis</span> <span class="keyword1">Un</span> <span class="skolem">bis</span> <span class="main">^-1</span><span class="main">)</span> <span class="main">^+</span> <span class="main">⊆</span> <span class="main">(</span><span class="main">(</span><span class="free">Retr</span> <span class="skolem">th</span><span class="main">)</span> <span class="keyword1">Un</span> <span class="main">(</span><span class="free">Retr</span> <span class="skolem">th</span><span class="main">)</span> <span class="main">^-1</span><span class="main">)</span> <span class="main">^+</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span><span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sym <span class="skolem">th</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> th_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> sym_Un_converse sym_trancl<span class="main">)</span>
   <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"trans <span class="skolem">th</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> th_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> th_def trans_trancl<span class="main">)</span>
   <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sym <span class="main">(</span><span class="free">Retr</span> <span class="skolem">th</span><span class="main">)</span> <span class="main">∧</span> trans <span class="main">(</span><span class="free">Retr</span> <span class="skolem">th</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
   <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">Retr</span> <span class="skolem">th</span><span class="main">)</span> <span class="keyword1">Un</span> <span class="main">(</span><span class="free">Retr</span> <span class="skolem">th</span><span class="main">)</span> <span class="main">^-1</span><span class="main">)</span> <span class="main">^+</span> <span class="main">⊆</span> <span class="free">Retr</span> <span class="skolem">th</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Un_absorb subset_refl sym_conv_converse_eq trancl_id<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">bis</span> <span class="keyword1">Un</span> <span class="skolem">bis</span> <span class="main">^-1</span><span class="main">)</span> <span class="main">^+</span> <span class="main">⊆</span> <span class="free">Retr</span> <span class="skolem">th</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">bis</span> <span class="keyword1">Un</span> <span class="skolem">bis</span> <span class="main">^-1</span><span class="main">)</span> <span class="main">^+</span> <span class="main">⊆</span> <span class="skolem">bis</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 coinduct <span class="keyword1"><span class="command">unfolding</span></span> th_def bis_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> bis_def gfp_upperbound th_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">bis</span> <span class="main">^-1</span> <span class="main">⊆</span> <span class="skolem">bis</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">bis</span> <span class="main">^+</span> <span class="main">⊆</span> <span class="skolem">bis</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">metis</span> equalityI gfp_upperbound le_supI1 subset_refl sym_Un_converse sym_conv_converse_eq th_def trancl_id trancl_imp_trans<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Un_absorb <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">bis</span> <span class="main">∪</span> <span class="skolem">bis</span><span class="main">¯</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span> <span class="main">⊆</span> <span class="skolem">bis</span>›</span></span> less_supI1 psubset_eq sym_Un_converse sym_conv_converse_eq sym_trancl trancl_id trancl_imp_trans<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> bis_def sym_def <span class="keyword1"><span class="command">using</span></span> trancl_imp_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Infrastructure for partitions›</span></span>

<span class="comment1">(* Being a partition *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">part</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">part</span> <span class="free"><span class="bound"><span class="entity">J</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">≡</span>
 Union <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">J</span></span></span> <span class="main">∧</span>
 <span class="main">(</span><span class="main">∀</span> <span class="bound">J1</span> <span class="bound">J2</span><span class="main">.</span> <span class="bound">J1</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">∧</span> <span class="bound">J2</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">∧</span> <span class="bound">J1</span> <span class="main">≠</span> <span class="bound">J2</span> <span class="main">⟶</span> <span class="bound">J1</span> <span class="main">∩</span> <span class="bound">J2</span> <span class="main">=</span> <span class="main">{}</span><span class="main">)</span>"</span></span>

<span class="comment1">(* gen P I is the set generated from I using intersections with sets of P  *)</span>
<span class="keyword1"><span class="command">inductive_set</span></span> <span class="entity">gen</span>
<span class="keyword2"><span class="keyword">for</span></span> <span class="entity">P</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set set"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="entity">I</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
 incl<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">∈</span> <span class="free">I</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">∈</span> <span class="free">gen</span> <span class="free">P</span> <span class="free">I</span>"</span></span>
<span class="main">|</span>ext<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free"><span class="bound"><span class="entity">J</span></span></span> <span class="main">∈</span> <span class="free">P</span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">j0</span></span></span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">J</span></span></span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">j0</span></span></span> <span class="main">∈</span> <span class="free">gen</span> <span class="free">P</span> <span class="free">I</span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">J</span></span></span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">∈</span> <span class="free">gen</span> <span class="free">P</span> <span class="free">I</span>"</span></span>

<span class="comment1">(* Partition generated by a set *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">partGen</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">partGen</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">≡</span> <span class="main">{</span>gen <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">I</span> <span class="main">|</span> <span class="bound">I</span> <span class="main">.</span> <span class="bound">I</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">}</span>"</span></span>

<span class="comment1">(* finer P Q means: as a partition, P is finer than Q;
   regarding P and Q as equivalence relations, we have Q included in P *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">finer</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">finer</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="main">≡</span>
 <span class="main">(</span><span class="main">∀</span> <span class="bound">J</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main">.</span> <span class="bound">J</span> <span class="main">=</span> Union <span class="main">{</span><span class="bound"><span class="bound">I</span></span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">.</span> <span class="bound">I</span> <span class="main">⊆</span> <span class="bound">J</span><span class="main">}</span><span class="main">)</span> <span class="main">∧</span>
 <span class="main">(</span><span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="main">≠</span> <span class="main">{}</span><span class="main">)</span>"</span></span>

<span class="comment1">(* The join of two partitions; in terms of equivalence relations,
   this is the smallest equivalence containing both *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">partJoin</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">partJoin</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="main">≡</span> partGen <span class="main">(</span><span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">∪</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main">)</span>"</span></span>

<span class="comment1">(* Compatibility of a function f w.r.t. a set I versus a relation theta *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">compat</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">compat</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">theta</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">≡</span> <span class="main">∀</span> <span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="main">{</span><span class="bound">i</span><span class="main">,</span> <span class="bound">j</span><span class="main">}</span> <span class="main">⊆</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">∧</span> <span class="bound">i</span> <span class="main">≠</span> <span class="bound">j</span> <span class="main">⟶</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">i</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">j</span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">theta</span></span></span>"</span></span>

<span class="comment1">(* Compatibility of a function f w.r.t. a partition P versus a relation theta;
if P is regarded as an equivalence class, we have the standard notion of compatibility *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">partCompat</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">partCompat</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">theta</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">≡</span>
 <span class="main">∀</span> <span class="bound">I</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">.</span> compat <span class="bound">I</span> <span class="free"><span class="bound"><span class="entity">theta</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span>"</span></span>

<span class="comment1">(* Lifting a function F on a partition P to elements II of a potentially coarser partition *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">lift</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">lift</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">II</span></span></span> <span class="main">≡</span> Union <span class="main">{</span><span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="bound">I</span> <span class="main">|</span> <span class="bound">I</span> <span class="main">.</span> <span class="bound">I</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">∧</span> <span class="bound">I</span> <span class="main">⊆</span> <span class="free"><span class="bound"><span class="entity">II</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹part:›</span></span>

<span class="keyword1" id="Resumption_Based-part_emp"><span class="command">lemma</span></span> part_emp<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="quoted"><span class="quoted">"part <span class="free">J</span> <span class="main">(</span>insert <span class="main">{}</span> <span class="free">P</span><span class="main">)</span> <span class="main">=</span> part <span class="free">J</span> <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> part_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Resumption_Based-finite_part"><span class="command">lemma</span></span> finite_part<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">I</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"part <span class="free">I</span> <span class="free">P</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms finite_UnionD <span class="keyword1"><span class="command">unfolding</span></span> part_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Resumption_Based-part_sum"><span class="command">lemma</span></span> part_sum<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> P<span class="main">:</span> <span class="quoted"><span class="quoted">"part <span class="main">{..&lt;</span><span class="free">n</span><span class="main">::</span>nat<span class="main">}</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span><span class="free">n</span><span class="main">.</span> <span class="free">f</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">p</span><span class="main">∈</span><span class="free">P</span><span class="main">.</span> <span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="bound">p</span><span class="main">.</span> <span class="free">f</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">subst</span> sum.Union_disjoint <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">∈</span><span class="free">P</span><span class="main">.</span> finite <span class="bound">p</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> <span class="free">P</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> P <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> part_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> finite_subset<span class="main">)</span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">A</span><span class="main">∈</span><span class="free">P</span><span class="main">.</span> <span class="main">∀</span><span class="bound">B</span><span class="main">∈</span><span class="free">P</span><span class="main">.</span> <span class="bound">A</span> <span class="main">≠</span> <span class="bound">B</span> <span class="main">⟶</span> <span class="bound">A</span> <span class="main">∩</span> <span class="bound">B</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> P <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> part_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sum <span class="free">f</span> <span class="main">{..&lt;</span><span class="free">n</span><span class="main">}</span> <span class="main">=</span> sum <span class="free">f</span> <span class="main">(</span><span class="main">⋃</span><span class="free">P</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> P <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> part_def atLeast0LessThan<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Resumption_Based-part_Un"><span class="command">lemma</span></span> part_Un<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"part <span class="free">I1</span> <span class="free">P1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"part <span class="free">I2</span> <span class="free">P2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">I1</span> <span class="keyword1">Int</span> <span class="free">I2</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"part <span class="main">(</span><span class="free">I1</span> <span class="keyword1">Un</span> <span class="free">I2</span><span class="main">)</span> <span class="main">(</span><span class="free">P1</span> <span class="keyword1">Un</span> <span class="free">P2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> part_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Union_Un_distrib Union_disjoint inf_aci<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> mem_simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1" id="Resumption_Based-part_Un_singl"><span class="command">lemma</span></span> part_Un_singl<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"part <span class="free">K</span> <span class="free">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">I</span><span class="main">.</span> <span class="bound">I</span> <span class="main">∈</span> <span class="free">P</span> <span class="main">⟹</span> <span class="free">I0</span> <span class="keyword1">Int</span> <span class="bound">I</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"part <span class="main">(</span><span class="free">I0</span> <span class="keyword1">Un</span> <span class="free">K</span><span class="main">)</span> <span class="main">(</span><span class="main">{</span><span class="free">I0</span><span class="main">}</span> <span class="keyword1">Un</span> <span class="free">P</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> part_def
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> complete_lattice_class.Sup_insert Int_commute insert_iff insert_is_Un<span class="main">)</span>

<span class="keyword1" id="Resumption_Based-part_Un_singl2"><span class="command">lemma</span></span> part_Un_singl2<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">K01</span> <span class="main">=</span> <span class="free">I0</span> <span class="keyword1">Un</span> <span class="free">K1</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"part <span class="free">K1</span> <span class="free">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">I</span><span class="main">.</span> <span class="bound">I</span> <span class="main">∈</span> <span class="free">P</span> <span class="main">⟹</span> <span class="free">I0</span> <span class="keyword1">Int</span> <span class="bound">I</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"part <span class="free">K01</span> <span class="main">(</span><span class="main">{</span><span class="free">I0</span><span class="main">}</span> <span class="keyword1">Un</span> <span class="free">P</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms part_Un_singl <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Resumption_Based-part_UN"><span class="command">lemma</span></span> part_UN<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">∈</span> <span class="free">N</span> <span class="main">⟹</span> part <span class="main">(</span><span class="free">I</span> <span class="bound">n</span><span class="main">)</span> <span class="main">(</span><span class="free">P</span> <span class="bound">n</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">n1</span> <span class="bound">n2</span><span class="main">.</span> <span class="main">{</span><span class="bound">n1</span><span class="main">,</span><span class="bound">n2</span><span class="main">}</span> <span class="main">⊆</span> <span class="free">N</span> <span class="main">∧</span> <span class="bound">n1</span> <span class="main">≠</span> <span class="bound">n2</span> <span class="main">⟹</span> <span class="free">I</span> <span class="bound">n1</span> <span class="main">∩</span> <span class="free">I</span> <span class="bound">n2</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"part <span class="main">(</span><span class="keyword1">UN</span> <span class="bound">n</span> <span class="main">:</span> <span class="free">N</span><span class="main">.</span> <span class="free">I</span> <span class="bound">n</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">UN</span> <span class="bound">n</span> <span class="main">:</span> <span class="free">N</span><span class="main">.</span> <span class="free">P</span> <span class="bound">n</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> part_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> UnionE<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> Union_upper disjoint_iff_not_equal insert_absorb insert_subset<span class="main">)</span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> UnionI disjoint_iff_not_equal<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹gen:›</span></span>

<span class="keyword1" id="Resumption_Based-incl_gen"><span class="command">lemma</span></span> incl_gen<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">⊆</span> gen <span class="free">P</span> <span class="free">I</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Resumption_Based-gen_incl_Un"><span class="command">lemma</span></span> gen_incl_Un<span class="main">:</span>
<span class="quoted"><span class="quoted">"gen <span class="free">P</span> <span class="free">I</span> <span class="main">⊆</span> <span class="free">I</span> <span class="main">∪</span> <span class="main">(</span>Union <span class="free">P</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∈</span> gen <span class="free">P</span> <span class="free">I</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∈</span> <span class="free">I</span> <span class="main">∪</span> <span class="main">⋃</span><span class="free">P</span>"</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">induct</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Resumption_Based-gen_incl"><span class="command">lemma</span></span> gen_incl<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">∈</span> <span class="free">P</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"gen <span class="free">P</span> <span class="free">I</span> <span class="main">⊆</span> Union <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms gen_incl_Un<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">P</span></span> <span class="quoted"><span class="free">I</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Resumption_Based-finite_gen"><span class="command">lemma</span></span> finite_gen<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">J</span><span class="main">.</span> <span class="bound">J</span> <span class="main">∈</span> <span class="free">P</span> <span class="main">⟹</span> finite <span class="bound">J</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">I</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>gen <span class="free">P</span> <span class="free">I</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms finite_Union gen_incl_Un infinite_Un infinite_super<span class="main">)</span>

<span class="keyword1" id="Resumption_Based-subset_gen"><span class="command">lemma</span></span> subset_gen<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">J</span> <span class="main">∈</span> <span class="free">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"gen <span class="free">P</span> <span class="free">I</span> <span class="main">∩</span> <span class="free">J</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">J</span> <span class="main">⊆</span> gen <span class="free">P</span> <span class="free">I</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms gen.ext<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">J</span></span> <span class="quoted"><span class="free">P</span></span> <span class="main">_</span> <span class="quoted"><span class="free">I</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Resumption_Based-gen_subset_gen"><span class="command">lemma</span></span> gen_subset_gen<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">J</span> <span class="main">∈</span> <span class="free">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"gen <span class="free">P</span> <span class="free">I</span> <span class="main">∩</span> <span class="free">J</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"gen <span class="free">P</span> <span class="free">J</span> <span class="main">⊆</span> gen <span class="free">P</span> <span class="free">I</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> J<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">J</span> <span class="main">⊆</span> gen <span class="free">P</span> <span class="free">I</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> gen <span class="free">P</span> <span class="free">J</span>"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> gen <span class="free">P</span> <span class="free">I</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">induct</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>ext <span class="skolem">J'</span> <span class="skolem">j0</span> <span class="skolem">j</span><span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> gen.ext<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">J'</span></span> <span class="quoted"><span class="free">P</span></span> <span class="quoted"><span class="skolem">j0</span></span> <span class="quoted"><span class="free">I</span></span> <span class="quoted"><span class="skolem">j</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> J<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Resumption_Based-gen_mono"><span class="command">lemma</span></span> gen_mono<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">⊆</span> <span class="free">J</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"gen <span class="free">P</span> <span class="free">I</span> <span class="main">⊆</span> gen <span class="free">P</span> <span class="free">J</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> gen <span class="free">P</span> <span class="free">I</span>"</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> gen <span class="free">P</span> <span class="free">J</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">induct</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>ext <span class="skolem">I'</span> <span class="skolem">j0</span> <span class="skolem">j</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> gen.ext<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">I'</span></span> <span class="quoted"><span class="free">P</span></span> <span class="quoted"><span class="skolem">j0</span></span> <span class="quoted"><span class="free">J</span></span> <span class="quoted"><span class="skolem">j</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> assms<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Resumption_Based-gen_idem"><span class="command">lemma</span></span> gen_idem<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="quoted"><span class="quoted">"gen <span class="free">P</span> <span class="main">(</span>gen <span class="free">P</span> <span class="free">I</span><span class="main">)</span> <span class="main">=</span> gen <span class="free">P</span> <span class="free">I</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">J</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">J</span> <span class="main">=</span> gen <span class="free">P</span> <span class="free">I</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">⊆</span> <span class="skolem">J</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> J_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"gen <span class="free">P</span> <span class="free">I</span> <span class="main">⊆</span> gen <span class="free">P</span> <span class="skolem">J</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"gen <span class="free">P</span> <span class="skolem">J</span> <span class="main">⊆</span> gen <span class="free">P</span> <span class="free">I</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> gen <span class="free">P</span> <span class="skolem">J</span>"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> gen <span class="free">P</span> <span class="free">I</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">induct</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>ext <span class="skolem">J'</span> <span class="skolem">j0</span> <span class="skolem">j</span><span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> gen.ext<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">J'</span></span> <span class="quoted"><span class="free">P</span></span> <span class="quoted"><span class="skolem">j0</span></span> <span class="quoted"><span class="free">I</span></span> <span class="quoted"><span class="skolem">j</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">unfold</span> J_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> J_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Resumption_Based-gen_nchotomy"><span class="command">lemma</span></span> gen_nchotomy<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">J</span> <span class="main">∈</span> <span class="free">P</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">J</span> <span class="main">⊆</span> gen <span class="free">P</span> <span class="free">I</span> <span class="main">∨</span> gen <span class="free">P</span> <span class="free">I</span> <span class="main">∩</span> <span class="free">J</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms subset_gen<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">J</span></span> <span class="quoted"><span class="free">P</span></span> <span class="quoted"><span class="free">I</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Resumption_Based-gen_Union"><span class="command">lemma</span></span> gen_Union<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">∈</span> <span class="free">P</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"gen <span class="free">P</span> <span class="free">I</span> <span class="main">=</span> Union <span class="main">{</span><span class="bound"><span class="bound">J</span></span> <span class="main">∈</span> <span class="free">P</span> <span class="main">.</span> <span class="bound">J</span> <span class="main">⊆</span> gen <span class="free">P</span> <span class="free">I</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="keyword3"><span class="command">assume</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> gen <span class="free">P</span> <span class="free">I</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">J</span></span> <span class="keyword2"><span class="keyword">where</span></span> J<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">J</span> <span class="main">∈</span> <span class="free">P</span>"</span></span>  <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="skolem">J</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms gen_incl <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">J</span> <span class="main">⊆</span> gen <span class="free">P</span> <span class="free">I</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms i gen_nchotomy <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="main">⋃</span><span class="main">{</span><span class="bound"><span class="bound">J</span></span> <span class="main">∈</span> <span class="free">P</span><span class="main">.</span> <span class="bound">J</span> <span class="main">⊆</span> gen <span class="free">P</span> <span class="free">I</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> J <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Resumption_Based-subset_gen2"><span class="command">lemma</span></span> subset_gen2<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">I</span><span class="main">,</span><span class="free">J</span><span class="main">}</span> <span class="main">⊆</span> <span class="free">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"gen <span class="free">P</span> <span class="free">I</span> <span class="main">∩</span> gen <span class="free">P</span> <span class="free">J</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">⊆</span> gen <span class="free">P</span> <span class="free">J</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i0</span> <span class="skolem">i</span> <span class="keyword3"><span class="command">assume</span></span> i0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i0</span> <span class="main">∈</span> <span class="free">I</span> <span class="main">∧</span> <span class="skolem">i0</span> <span class="main">∉</span> gen <span class="free">P</span> <span class="free">J</span>"</span></span>
   <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> gen <span class="free">P</span> <span class="free">I</span>"</span></span>
   <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∉</span> gen <span class="free">P</span> <span class="free">J</span>"</span></span>
   <span class="keyword1"><span class="command">proof</span></span> <span class="operator">induct</span>
     <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>incl <span class="skolem">i</span><span class="main">)</span>
     <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> i0 gen_nchotomy<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">I</span></span> <span class="quoted"><span class="free">P</span></span> <span class="quoted"><span class="free">J</span></span><span class="main">]</span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
   <span class="keyword1"><span class="command">next</span></span>
     <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>ext <span class="skolem">I'</span> <span class="skolem">j0</span> <span class="skolem">j</span><span class="main">)</span>
     <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
     <span class="keyword1"><span class="command">using</span></span> gen.ext<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">I'</span></span> <span class="quoted"><span class="free">P</span></span> <span class="quoted"><span class="skolem">j0</span></span> <span class="quoted"><span class="free">J</span></span> <span class="quoted"><span class="skolem">j</span></span><span class="main">]</span> gen_nchotomy<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">I'</span></span> <span class="quoted"><span class="free">P</span></span> <span class="quoted"><span class="free">J</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
   <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Resumption_Based-gen_subset_gen2"><span class="command">lemma</span></span> gen_subset_gen2<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">I</span><span class="main">,</span><span class="free">J</span><span class="main">}</span> <span class="main">⊆</span> <span class="free">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"gen <span class="free">P</span> <span class="free">I</span> <span class="main">∩</span> gen <span class="free">P</span> <span class="free">J</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"gen <span class="free">P</span> <span class="free">I</span> <span class="main">⊆</span> gen <span class="free">P</span> <span class="free">J</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> gen <span class="free">P</span> <span class="free">I</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> gen <span class="free">P</span> <span class="free">J</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">induct</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>incl <span class="skolem">i</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms subset_gen2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>ext <span class="skolem">I'</span> <span class="skolem">j0</span> <span class="skolem">j</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> gen.ext<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">I'</span></span> <span class="quoted"><span class="free">P</span></span> <span class="quoted"><span class="skolem">j0</span></span> <span class="quoted"><span class="free">J</span></span> <span class="quoted"><span class="skolem">j</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Resumption_Based-gen_eq_gen"><span class="command">lemma</span></span> gen_eq_gen<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">I</span><span class="main">,</span><span class="free">J</span><span class="main">}</span> <span class="main">⊆</span> <span class="free">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"gen <span class="free">P</span> <span class="free">I</span> <span class="main">∩</span> gen <span class="free">P</span> <span class="free">J</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"gen <span class="free">P</span> <span class="free">I</span> <span class="main">=</span> gen <span class="free">P</span> <span class="free">J</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms gen_subset_gen2<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">I</span></span> <span class="quoted"><span class="free">J</span></span> <span class="quoted"><span class="free">P</span></span><span class="main">]</span> gen_subset_gen2<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">J</span></span> <span class="quoted"><span class="free">I</span></span> <span class="quoted"><span class="free">P</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Resumption_Based-gen_empty"><span class="command">lemma</span></span> gen_empty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="quoted"><span class="quoted">"gen <span class="free">P</span> <span class="main">{}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∈</span> gen <span class="free">P</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">hence</span></span> <span class="quoted">False</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">induct</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Resumption_Based-gen_empty2"><span class="command">lemma</span></span> gen_empty2<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="quoted"><span class="quoted">"gen <span class="main">{}</span> <span class="free">I</span> <span class="main">=</span> <span class="free">I</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∈</span> gen <span class="main">{}</span> <span class="free">I</span>"</span></span> <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∈</span> <span class="free">I</span>"</span></span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">induct</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Resumption_Based-emp_gen"><span class="command">lemma</span></span> emp_gen<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"gen <span class="free">P</span> <span class="free">I</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> all_not_in_conv assms gen.incl<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹partGen:›</span></span>

<span class="keyword1" id="Resumption_Based-partGen_ex"><span class="command">lemma</span></span> partGen_ex<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">∈</span> <span class="free">P</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">J</span> <span class="main">∈</span> partGen <span class="free">P</span><span class="main">.</span> <span class="free">I</span> <span class="main">⊆</span> <span class="bound">J</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> partGen_def
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">intro</span> bexI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"gen <span class="free"><span class="free">P</span></span> <span class="free"><span class="free">I</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Resumption_Based-ex_partGen"><span class="command">lemma</span></span> ex_partGen<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">J</span> <span class="main">∈</span> partGen <span class="free">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">∈</span> <span class="free">J</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">I</span> <span class="main">∈</span> <span class="free">P</span><span class="main">.</span> <span class="free">j</span> <span class="main">∈</span> <span class="bound">I</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">I0</span></span> <span class="keyword2"><span class="keyword">where</span></span> I0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">I0</span> <span class="main">∈</span> <span class="free">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> J<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">J</span> <span class="main">=</span> gen <span class="free">P</span> <span class="skolem">I0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> partGen_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> j gen_incl<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">I0</span></span> <span class="quoted"><span class="free">P</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Resumption_Based-Union_partGen"><span class="command">lemma</span></span> Union_partGen<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span> <span class="main">(</span>partGen <span class="free">P</span><span class="main">)</span> <span class="main">=</span> <span class="main">⋃</span> <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> ex_partGen<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="free">P</span></span><span class="main">]</span> partGen_ex<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="free">P</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="Resumption_Based-Int_partGen"><span class="command">lemma</span></span> Int_partGen<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">I</span><span class="main">,</span><span class="free">J</span><span class="main">}</span> <span class="main">⊆</span> partGen <span class="free">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">∩</span> <span class="free">J</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">=</span> <span class="free">J</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">I0</span></span> <span class="keyword2"><span class="keyword">where</span></span> I0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">I0</span> <span class="main">∈</span> <span class="free">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">=</span> gen <span class="free">P</span> <span class="skolem">I0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> partGen_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">J0</span></span> <span class="keyword2"><span class="keyword">where</span></span> J0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">J0</span> <span class="main">∈</span> <span class="free">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> J<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">J</span> <span class="main">=</span> gen <span class="free">P</span> <span class="skolem">J0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> partGen_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> gen_eq_gen<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">I0</span></span> <span class="quoted"><span class="skolem">J0</span></span> <span class="quoted"><span class="free">P</span></span><span class="main">]</span> I0 J0 ** <span class="keyword1"><span class="command">unfolding</span></span> I J <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Resumption_Based-part_partGen"><span class="command">lemma</span></span> part_partGen<span class="main">:</span>
<span class="quoted"><span class="quoted">"part <span class="main">(</span>Union <span class="free">P</span><span class="main">)</span> <span class="main">(</span>partGen <span class="free">P</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> part_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">intro</span> conjI allI impI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> Union_partGen<span class="main">)</span>
<span class="keyword1"><span class="command">using</span></span> Int_partGen <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Resumption_Based-finite_partGen"><span class="command">lemma</span></span> finite_partGen<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">P</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>partGen <span class="free">P</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> partGen_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Resumption_Based-emp_partGen"><span class="command">lemma</span></span> emp_partGen<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">{}</span> <span class="main">∉</span> <span class="free">P</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">{}</span> <span class="main">∉</span> partGen <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> partGen_def <span class="keyword1"><span class="command">using</span></span> emp_gen<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">P</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹finer:›</span></span>

<span class="keyword1" id="Resumption_Based-finer_partGen"><span class="command">lemma</span></span> finer_partGen<span class="main">:</span>
<span class="quoted"><span class="quoted">"finer <span class="free">P</span> <span class="main">(</span>partGen <span class="free">P</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> finer_def partGen_def <span class="keyword1"><span class="command">using</span></span> gen_Union <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Resumption_Based-finer_nchotomy"><span class="command">lemma</span></span> finer_nchotomy<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> P<span class="main">:</span> <span class="quoted"><span class="quoted">"part <span class="free">I0</span> <span class="free">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> Q<span class="main">:</span> <span class="quoted"><span class="quoted">"part <span class="free">I0</span> <span class="free">Q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> PQ<span class="main">:</span> <span class="quoted"><span class="quoted">"finer <span class="free">P</span> <span class="free">Q</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">∈</span> <span class="free">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> II<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">II</span> <span class="main">∈</span> <span class="free">Q</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">⊆</span> <span class="free">II</span> <span class="main">∨</span> <span class="main">(</span><span class="free">I</span> <span class="main">∩</span> <span class="free">II</span> <span class="main">=</span> <span class="main">{}</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">∩</span> <span class="free">II</span> <span class="main">=</span> <span class="main">{}</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="free">I</span> <span class="main">∧</span> <span class="skolem">i</span> <span class="main">∈</span> <span class="free">II</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">I'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="skolem">I'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> I'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">I'</span> <span class="main">∈</span> <span class="free">P</span> <span class="main">∧</span> <span class="skolem">I'</span> <span class="main">⊆</span> <span class="free">II</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> PQ II <span class="keyword1"><span class="command">unfolding</span></span> finer_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="keyword1">Int</span> <span class="skolem">I'</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> i <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">=</span> <span class="skolem">I'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> I I' P <span class="keyword1"><span class="command">unfolding</span></span> part_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">⊆</span> <span class="free">II</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> I' <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Resumption_Based-finer_ex"><span class="command">lemma</span></span> finer_ex<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> P<span class="main">:</span> <span class="quoted"><span class="quoted">"part <span class="free">I0</span> <span class="free">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> Q<span class="main">:</span> <span class="quoted"><span class="quoted">"part <span class="free">I0</span> <span class="free">Q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> PQ<span class="main">:</span> <span class="quoted"><span class="quoted">"finer <span class="free">P</span> <span class="free">Q</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">∈</span> <span class="free">P</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">II</span><span class="main">.</span> <span class="bound">II</span> <span class="main">∈</span> <span class="free">Q</span> <span class="main">∧</span> <span class="free">I</span> <span class="main">⊆</span> <span class="bound">II</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">=</span> <span class="main">{}</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> I PQ <span class="keyword1"><span class="command">unfolding</span></span> finer_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">JJ</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">JJ</span> <span class="main">∈</span> <span class="free">Q</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> True <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="free">I</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="free">I0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> I P <span class="keyword1"><span class="command">unfolding</span></span> part_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">II</span></span> <span class="keyword2"><span class="keyword">where</span></span> II<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">II</span> <span class="main">∈</span> <span class="free">Q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="skolem">II</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Q <span class="keyword1"><span class="command">unfolding</span></span> part_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="keyword1">Int</span> <span class="skolem">II</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> i <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms I II finer_nchotomy<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">I0</span></span> <span class="quoted"><span class="free">P</span></span> <span class="quoted"><span class="free">Q</span></span> <span class="quoted"><span class="free">I</span></span> <span class="quoted"><span class="skolem">II</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹partJoin:›</span></span>

<span class="keyword1" id="Resumption_Based-partJoin_commute"><span class="command">lemma</span></span> partJoin_commute<span class="main">:</span>
<span class="quoted"><span class="quoted">"partJoin <span class="free">P</span> <span class="free">Q</span> <span class="main">=</span> partJoin <span class="free">Q</span> <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> partJoin_def partGen_def
<span class="keyword1"><span class="command">using</span></span> Un_commute <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1" id="Resumption_Based-Union_partJoin_L"><span class="command">lemma</span></span> Union_partJoin_L<span class="main">:</span>
<span class="quoted"><span class="quoted">"Union <span class="free">P</span> <span class="main">⊆</span> Union <span class="main">(</span>partJoin <span class="free">P</span> <span class="free">Q</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> partJoin_def partGen_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Resumption_Based-Union_partJoin_R"><span class="command">lemma</span></span> Union_partJoin_R<span class="main">:</span>
<span class="quoted"><span class="quoted">"Union <span class="free">Q</span> <span class="main">⊆</span> Union <span class="main">(</span>partJoin <span class="free">P</span> <span class="free">Q</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> partJoin_def partGen_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Resumption_Based-part_partJoin"><span class="command">lemma</span></span> part_partJoin<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"part <span class="free">I</span> <span class="free">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"part <span class="free">I</span> <span class="free">Q</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"part <span class="free">I</span> <span class="main">(</span>partJoin <span class="free">P</span> <span class="free">Q</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"Union <span class="main">(</span><span class="free">P</span> <span class="keyword1">Un</span> <span class="free">Q</span><span class="main">)</span> <span class="main">=</span> <span class="free">I</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> part_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> part_partGen<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="keyword1">Un</span> <span class="free">Q</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">unfolding</span></span> 1 partJoin_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Resumption_Based-finer_partJoin_L"><span class="command">lemma</span></span> finer_partJoin_L<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"part <span class="free">I</span> <span class="free">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"part <span class="free">I</span> <span class="free">Q</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finer <span class="free">P</span> <span class="main">(</span>partJoin <span class="free">P</span> <span class="free">Q</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"part <span class="free">I</span> <span class="main">(</span>partJoin <span class="free">P</span> <span class="free">Q</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">fix</span></span> <span class="skolem">J</span> <span class="skolem">j</span> <span class="keyword3"><span class="command">assume</span></span> J<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">J</span> <span class="main">∈</span> partJoin <span class="free">P</span> <span class="free">Q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∈</span> <span class="skolem">J</span>"</span></span>
   <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">J</span> <span class="main">⊆</span> <span class="free">I</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Union_upper part_def<span class="main">)</span>
   <span class="keyword1"><span class="command">with</span></span> j <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∈</span> <span class="free">I</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
   <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">J'</span></span> <span class="keyword2"><span class="keyword">where</span></span> jJ'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∈</span> <span class="skolem">J'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> J'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">J'</span> <span class="main">∈</span> <span class="free">P</span>"</span></span>
   <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">unfolding</span></span> part_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
   <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">J</span> <span class="main">∩</span> <span class="skolem">J'</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> j <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
   <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">J0</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">J</span> <span class="main">=</span> gen <span class="main">(</span><span class="free">P</span> <span class="keyword1">Un</span> <span class="free">Q</span><span class="main">)</span> <span class="skolem">J0</span>"</span></span>
   <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">J0</span> <span class="main">∈</span> <span class="free">P</span> <span class="keyword1">Un</span> <span class="free">Q</span>"</span></span>
   <span class="keyword1"><span class="command">using</span></span> J <span class="keyword1"><span class="command">unfolding</span></span> partJoin_def partGen_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
   <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">J'</span> <span class="main">⊆</span> <span class="skolem">J</span>"</span></span>
   <span class="keyword1"><span class="command">using</span></span> J' gen_nchotomy<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">J'</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="keyword1">Un</span> <span class="free">Q</span>"</span></span> <span class="quoted"><span class="skolem">J0</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
   <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∈</span> <span class="main">⋃</span><span class="main">{</span><span class="bound"><span class="bound">J'</span></span> <span class="main">∈</span> <span class="free">P</span><span class="main">.</span> <span class="bound">J'</span> <span class="main">⊆</span> <span class="skolem">J</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> J' jJ' <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> finer_def
  <span class="keyword1"><span class="command">unfolding</span></span> partJoin_def partGen_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Resumption_Based-finer_partJoin_R"><span class="command">lemma</span></span> finer_partJoin_R<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"part <span class="free">I</span> <span class="free">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"part <span class="free">I</span> <span class="free">Q</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finer <span class="free">Q</span> <span class="main">(</span>partJoin <span class="free">P</span> <span class="free">Q</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms finer_partJoin_L<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">I</span></span> <span class="quoted"><span class="free">Q</span></span> <span class="quoted"><span class="free">P</span></span><span class="main">]</span> partJoin_commute<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">P</span></span> <span class="quoted"><span class="free">Q</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Resumption_Based-finer_emp"><span class="command">lemma</span></span> finer_emp<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finer <span class="main">{}</span> <span class="free">Q</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="main">⊆</span> <span class="main">{</span> <span class="main">{}</span> <span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> finer_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹compat:›</span></span>

<span class="keyword1" id="Resumption_Based-part_emp_R"><span class="command">lemma</span></span> part_emp_R<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="quoted"><span class="quoted">"part <span class="free">I</span> <span class="main">{}</span> <span class="main">⟷</span> <span class="free">I</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> part_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Resumption_Based-part_emp_L"><span class="command">lemma</span></span> part_emp_L<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="quoted"><span class="quoted">"part <span class="main">{}</span> <span class="free">P</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">⊆</span> <span class="main">{</span> <span class="main">{}</span> <span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> part_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Resumption_Based-finite_partJoin"><span class="command">lemma</span></span> finite_partJoin<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">Q</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>partJoin <span class="free">P</span> <span class="free">Q</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> partJoin_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Resumption_Based-emp_partJoin"><span class="command">lemma</span></span> emp_partJoin<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">{}</span> <span class="main">∉</span> <span class="free">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">{}</span> <span class="main">∉</span> <span class="free">Q</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">{}</span> <span class="main">∉</span> partJoin <span class="free">P</span> <span class="free">Q</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> partJoin_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹partCompat:›</span></span>

<span class="keyword1" id="Resumption_Based-partCompat_Un"><span class="command">lemma</span></span> partCompat_Un<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="quoted"><span class="quoted">"partCompat <span class="main">(</span><span class="free">P</span> <span class="keyword1">Un</span> <span class="free">Q</span><span class="main">)</span> <span class="free">theta</span> <span class="free">f</span> <span class="main">⟷</span>
 partCompat <span class="free">P</span> <span class="free">theta</span> <span class="free">f</span> <span class="main">∧</span> partCompat <span class="free">Q</span> <span class="free">theta</span> <span class="free">f</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> partCompat_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Resumption_Based-partCompat_gen_aux"><span class="command">lemma</span></span> partCompat_gen_aux<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> theta<span class="main">:</span> <span class="quoted"><span class="quoted">"sym <span class="free">theta</span>"</span></span> <span class="quoted"><span class="quoted">"trans <span class="free">theta</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> fP<span class="main">:</span> <span class="quoted"><span class="quoted">"partCompat <span class="free">P</span> <span class="free">theta</span> <span class="free">f</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">∈</span> <span class="free">P</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> <span class="free">I</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">∈</span> gen <span class="free">P</span> <span class="free">I</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ij<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≠</span> <span class="free">j</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="free">i</span><span class="main">,</span> <span class="free">f</span> <span class="free">j</span><span class="main">)</span> <span class="main">∈</span> <span class="free">theta</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> j ij <span class="keyword1"><span class="command">proof</span></span> <span class="operator">induct</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>incl <span class="skolem">j</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">using</span></span> fP I i <span class="keyword1"><span class="command">unfolding</span></span> partCompat_def compat_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>ext <span class="skolem">J</span> <span class="skolem">j0</span> <span class="skolem">j</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">=</span> <span class="skolem">j0</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">note</span></span> case_i <span class="main">=</span> False
    <span class="keyword1"><span class="command">hence</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="free">i</span><span class="main">,</span> <span class="free">f</span> <span class="skolem">j0</span><span class="main">)</span> <span class="main">∈</span> <span class="free">theta</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ext <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">=</span> <span class="skolem">j0</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> case_i 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="skolem">j</span><span class="main">,</span> <span class="free">f</span> <span class="skolem">j0</span><span class="main">)</span> <span class="main">∈</span> <span class="free">theta</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">j0</span> <span class="main">∈</span> <span class="skolem">J</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">∈</span> <span class="skolem">J</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">J</span> <span class="main">∈</span> <span class="free">P</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> fP <span class="keyword1"><span class="command">unfolding</span></span> partCompat_def compat_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="skolem">j0</span><span class="main">,</span> <span class="free">f</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">∈</span> <span class="free">theta</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> theta <span class="keyword1"><span class="command">unfolding</span></span> sym_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 1 theta <span class="keyword1"><span class="command">unfolding</span></span> trans_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">note</span></span> case_i <span class="main">=</span> True
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j0</span> <span class="main">≠</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">≠</span> <span class="skolem">j</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="skolem">j0</span><span class="main">,</span> <span class="free">f</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">∈</span> <span class="free">theta</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">j0</span> <span class="main">∈</span> <span class="skolem">J</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">∈</span> <span class="skolem">J</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">J</span> <span class="main">∈</span> <span class="free">P</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> fP <span class="keyword1"><span class="command">unfolding</span></span> partCompat_def compat_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> case_i <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Resumption_Based-partCompat_gen"><span class="command">lemma</span></span> partCompat_gen<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> theta<span class="main">:</span> <span class="quoted"><span class="quoted">"sym <span class="free">theta</span>"</span></span> <span class="quoted"><span class="quoted">"trans <span class="free">theta</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> fP<span class="main">:</span> <span class="quoted"><span class="quoted">"partCompat <span class="free">P</span> <span class="free">theta</span> <span class="free">f</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">∈</span> <span class="free">P</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"compat <span class="main">(</span>gen <span class="free">P</span> <span class="free">I</span><span class="main">)</span> <span class="free">theta</span> <span class="free">f</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> compat_def <span class="keyword1"><span class="command">proof</span></span> <span class="operator">clarify</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="skolem">j</span> <span class="keyword3"><span class="command">assume</span></span> ij<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">j</span><span class="main">}</span> <span class="main">⊆</span> gen <span class="free">P</span> <span class="free">I</span>"</span></span>  <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≠</span> <span class="skolem">j</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="skolem">i</span><span class="main">,</span> <span class="free">f</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">∈</span> <span class="free">theta</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="free">I</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">note</span></span> i <span class="main">=</span> True
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∈</span> <span class="free">I</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> i ij I fP <span class="keyword1"><span class="command">unfolding</span></span> partCompat_def compat_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≠</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> i <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms partCompat_gen_aux i ij <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">note</span></span> i <span class="main">=</span> False
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∈</span> <span class="free">I</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≠</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> i <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="skolem">j</span><span class="main">,</span> <span class="free">f</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">∈</span> <span class="free">theta</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms partCompat_gen_aux<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">theta</span></span> <span class="quoted"><span class="free">P</span></span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">I</span></span> <span class="quoted"><span class="skolem">j</span></span> <span class="quoted"><span class="skolem">i</span></span><span class="main">]</span> True ij <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> theta <span class="keyword1"><span class="command">unfolding</span></span> sym_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">note</span></span> j <span class="main">=</span> False
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">=</span> <span class="main">{}</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> ij <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i0</span></span> <span class="keyword2"><span class="keyword">where</span></span> i0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i0</span> <span class="main">∈</span> <span class="free">I</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">hence</span></span> i0_not<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i0</span> <span class="main">∉</span> <span class="main">{</span><span class="skolem">i</span><span class="main">,</span><span class="skolem">j</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> i j <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="skolem">i0</span><span class="main">,</span> <span class="free">f</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">∈</span> <span class="free">theta</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assms i0 i0_not ij partCompat_gen_aux<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">theta</span></span> <span class="quoted"><span class="free">P</span></span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">I</span></span> <span class="quoted"><span class="skolem">i0</span></span> <span class="quoted"><span class="skolem">i</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="skolem">i</span><span class="main">,</span> <span class="free">f</span> <span class="skolem">i0</span><span class="main">)</span> <span class="main">∈</span> <span class="free">theta</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> theta <span class="keyword1"><span class="command">unfolding</span></span> sym_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="skolem">i0</span><span class="main">,</span> <span class="free">f</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">∈</span> <span class="free">theta</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assms i0 i0_not ij partCompat_gen_aux<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">theta</span></span> <span class="quoted"><span class="free">P</span></span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">I</span></span> <span class="quoted"><span class="skolem">i0</span></span> <span class="quoted"><span class="skolem">j</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> theta <span class="keyword1"><span class="command">unfolding</span></span> trans_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Resumption_Based-partCompat_partGen"><span class="command">lemma</span></span> partCompat_partGen<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"sym <span class="free">theta</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"trans <span class="free">theta</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"partCompat <span class="free">P</span> <span class="free">theta</span> <span class="free">f</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"partCompat <span class="main">(</span>partGen <span class="free">P</span><span class="main">)</span> <span class="free">theta</span> <span class="free">f</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> partCompat_def partGen_def
<span class="keyword1"><span class="command">using</span></span> assms partCompat_gen<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">theta</span></span> <span class="quoted"><span class="free">P</span></span> <span class="quoted"><span class="free">f</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Resumption_Based-partCompat_partJoin"><span class="command">lemma</span></span> partCompat_partJoin<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"sym <span class="free">theta</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"trans <span class="free">theta</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"partCompat <span class="free">P</span> <span class="free">theta</span> <span class="free">f</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"partCompat <span class="free">Q</span> <span class="free">theta</span> <span class="free">f</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"partCompat <span class="main">(</span>partJoin <span class="free">P</span> <span class="free">Q</span><span class="main">)</span> <span class="free">theta</span> <span class="free">f</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms partCompat_Un partCompat_partGen partJoin_def<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹lift:›</span></span>

<span class="keyword1" id="Resumption_Based-inj_on_lift"><span class="command">lemma</span></span> inj_on_lift<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> P<span class="main">:</span> <span class="quoted"><span class="quoted">"part <span class="free">I0</span> <span class="free">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> Q<span class="main">:</span> <span class="quoted"><span class="quoted">"part <span class="free">I0</span> <span class="free">Q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> PQ<span class="main">:</span> <span class="quoted"><span class="quoted">"finer <span class="free">P</span> <span class="free">Q</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> F<span class="main">:</span> <span class="quoted"><span class="quoted">"inj_on <span class="free">F</span> <span class="free">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> FP<span class="main">:</span> <span class="quoted"><span class="quoted">"part <span class="free">J0</span> <span class="main">(</span><span class="free">F</span> <span class="main">`</span> <span class="free">P</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> emp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{}</span> <span class="main">∉</span> <span class="free">F</span> <span class="main">`</span> <span class="free">P</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="main">(</span>lift <span class="free">P</span> <span class="free">F</span><span class="main">)</span> <span class="free">Q</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> inj_on_def <span class="keyword1"><span class="command">proof</span></span> <span class="operator">clarify</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">II</span> <span class="skolem">II'</span> <span class="keyword3"><span class="command">assume</span></span> II<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">II</span> <span class="main">∈</span> <span class="free">Q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> II'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">II'</span> <span class="main">∈</span> <span class="free">Q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"lift <span class="free">P</span> <span class="free">F</span> <span class="skolem">II</span> <span class="main">=</span> lift <span class="free">P</span> <span class="free">F</span> <span class="skolem">II'</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">II</span> <span class="main">=</span> Union <span class="main">{</span><span class="bound"><span class="bound">I</span></span> <span class="main">∈</span> <span class="free">P</span> <span class="main">.</span> <span class="bound">I</span> <span class="main">⊆</span> <span class="skolem">II</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> PQ II <span class="keyword1"><span class="command">unfolding</span></span> finer_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">II'</span> <span class="main">=</span> Union <span class="main">{</span><span class="bound"><span class="bound">I</span></span> <span class="main">∈</span> <span class="free">P</span> <span class="main">.</span> <span class="bound">I</span> <span class="main">⊆</span> <span class="skolem">II'</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> PQ II' <span class="keyword1"><span class="command">unfolding</span></span> finer_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">fix</span></span> <span class="skolem">I</span>
   <span class="keyword3"><span class="command">assume</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">I</span> <span class="main">∈</span> <span class="free">P</span>"</span></span>  <span class="quoted"><span class="quoted">"<span class="skolem">I</span> <span class="main">⊆</span> <span class="skolem">II</span>"</span></span>
   <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">F</span> <span class="skolem">I</span> <span class="main">⊆</span> lift <span class="free">P</span> <span class="free">F</span> <span class="skolem">II</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> lift_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
   <span class="keyword1"><span class="command">hence</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">F</span> <span class="skolem">I</span> <span class="main">⊆</span> lift <span class="free">P</span> <span class="free">F</span> <span class="skolem">II'</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> eq <span class="keyword1"><span class="command">.</span></span>
   <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">F</span> <span class="skolem">I</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> emp I FP <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
   <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∈</span> <span class="free">F</span> <span class="skolem">I</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
   <span class="keyword1"><span class="command">with</span></span> 3 <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">I'</span></span> <span class="keyword2"><span class="keyword">where</span></span> I'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">I'</span> <span class="main">∈</span> <span class="free">P</span> <span class="main">∧</span> <span class="skolem">I'</span> <span class="main">⊆</span> <span class="skolem">II'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∈</span> <span class="free">F</span> <span class="skolem">I'</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> lift_def <span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
   <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">F</span> <span class="skolem">I</span> <span class="keyword1">Int</span> <span class="free">F</span> <span class="skolem">I'</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> j <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
   <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">F</span> <span class="skolem">I</span> <span class="main">=</span> <span class="free">F</span> <span class="skolem">I'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> FP I I' <span class="keyword1"><span class="command">unfolding</span></span> part_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
   <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">I</span> <span class="main">=</span> <span class="skolem">I'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> F I I' <span class="keyword1"><span class="command">unfolding</span></span> inj_on_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
   <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">I</span> <span class="main">⊆</span> <span class="skolem">II'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> I' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">hence</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">II</span> <span class="main">⊆</span> <span class="skolem">II'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="comment1">(*  *)</span>
  <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">fix</span></span> <span class="skolem">I</span>
   <span class="keyword3"><span class="command">assume</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">I</span> <span class="main">∈</span> <span class="free">P</span>"</span></span>  <span class="quoted"><span class="quoted">"<span class="skolem">I</span> <span class="main">⊆</span> <span class="skolem">II'</span>"</span></span>
   <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">F</span> <span class="skolem">I</span> <span class="main">⊆</span> lift <span class="free">P</span> <span class="free">F</span> <span class="skolem">II'</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> lift_def <span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
   <span class="keyword1"><span class="command">hence</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">F</span> <span class="skolem">I</span> <span class="main">⊆</span> lift <span class="free">P</span> <span class="free">F</span> <span class="skolem">II</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> eq <span class="keyword1"><span class="command">.</span></span>
   <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">F</span> <span class="skolem">I</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> emp I FP <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
   <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∈</span> <span class="free">F</span> <span class="skolem">I</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
   <span class="keyword1"><span class="command">with</span></span> 3 <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">I'</span></span> <span class="keyword2"><span class="keyword">where</span></span> I'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">I'</span> <span class="main">∈</span> <span class="free">P</span> <span class="main">∧</span> <span class="skolem">I'</span> <span class="main">⊆</span> <span class="skolem">II</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∈</span> <span class="free">F</span> <span class="skolem">I'</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> lift_def <span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
   <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">F</span> <span class="skolem">I</span> <span class="keyword1">Int</span> <span class="free">F</span> <span class="skolem">I'</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> j <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
   <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">F</span> <span class="skolem">I</span> <span class="main">=</span> <span class="free">F</span> <span class="skolem">I'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> FP I I' <span class="keyword1"><span class="command">unfolding</span></span> part_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
   <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">I</span> <span class="main">=</span> <span class="skolem">I'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> F I I' <span class="keyword1"><span class="command">unfolding</span></span> inj_on_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
   <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">I</span> <span class="main">⊆</span> <span class="skolem">II</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> I' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">II'</span> <span class="main">⊆</span> <span class="skolem">II</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">with</span></span> a <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">II</span> <span class="main">=</span> <span class="skolem">II'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Resumption_Based-part_lift"><span class="command">lemma</span></span> part_lift<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> P<span class="main">:</span> <span class="quoted"><span class="quoted">"part <span class="free">I0</span> <span class="free">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> Q<span class="main">:</span> <span class="quoted"><span class="quoted">"part <span class="free">I0</span> <span class="free">Q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> PQ<span class="main">:</span> <span class="quoted"><span class="quoted">"finer <span class="free">P</span> <span class="free">Q</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> F<span class="main">:</span> <span class="quoted"><span class="quoted">"inj_on <span class="free">F</span> <span class="free">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> FP<span class="main">:</span> <span class="quoted"><span class="quoted">"part <span class="free">J0</span> <span class="main">(</span><span class="free">F</span> <span class="main">`</span> <span class="free">P</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> emp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{}</span> <span class="main">∉</span> <span class="free">P</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">{}</span> <span class="main">∉</span> <span class="free">F</span> <span class="main">`</span> <span class="free">P</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"part <span class="free">J0</span> <span class="main">(</span>lift <span class="free">P</span> <span class="free">F</span> <span class="main">`</span> <span class="free">Q</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> part_def <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> conjI allI impI<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span><span class="main">(</span>lift <span class="free">P</span> <span class="free">F</span> <span class="main">`</span> <span class="free">Q</span><span class="main">)</span> <span class="main">=</span> <span class="free">J0</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j</span> <span class="skolem">II</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∈</span> lift <span class="free">P</span> <span class="free">F</span> <span class="skolem">II</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> II<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">II</span> <span class="main">∈</span> <span class="free">Q</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">I</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∈</span> <span class="free">F</span> <span class="skolem">I</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">I</span> <span class="main">∈</span> <span class="free">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">I</span> <span class="main">⊆</span> <span class="skolem">II</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> lift_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∈</span> <span class="free">J0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> FP <span class="keyword1"><span class="command">unfolding</span></span> part_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∈</span> <span class="free">J0</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">J</span></span> <span class="keyword2"><span class="keyword">where</span></span> J<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">J</span> <span class="main">∈</span> <span class="free">F</span> <span class="main">`</span> <span class="free">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∈</span> <span class="skolem">J</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> FP <span class="keyword1"><span class="command">unfolding</span></span> part_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">I</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">I</span> <span class="main">=</span> inv_into <span class="free">P</span> <span class="free">F</span> <span class="skolem">J</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∈</span> <span class="free">F</span> <span class="skolem">I</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> I_def <span class="keyword1"><span class="command">using</span></span> j J F <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">I</span> <span class="main">∈</span> <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> I_def <span class="keyword1"><span class="command">using</span></span> F J <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">II</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">I</span> <span class="main">⊆</span> <span class="skolem">II</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">II</span> <span class="main">∈</span> <span class="free">Q</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> P Q PQ I finer_ex<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">I0</span></span> <span class="quoted"><span class="free">P</span></span> <span class="quoted"><span class="free">Q</span></span> <span class="quoted"><span class="skolem">I</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∈</span> <span class="main">⋃</span> <span class="main">(</span>lift <span class="free">P</span> <span class="free">F</span> <span class="main">`</span> <span class="free">Q</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> lift_def <span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span> <span class="keyword1"><span class="command">using</span></span> j I <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">JJ1</span> <span class="skolem">JJ2</span> <span class="keyword3"><span class="command">assume</span></span> JJ12<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">JJ1</span> <span class="main">∈</span> lift <span class="free">P</span> <span class="free">F</span> <span class="main">`</span> <span class="free">Q</span> <span class="main">∧</span> <span class="skolem">JJ2</span> <span class="main">∈</span> lift <span class="free">P</span> <span class="free">F</span> <span class="main">`</span> <span class="free">Q</span> <span class="main">∧</span> <span class="skolem">JJ1</span> <span class="main">≠</span> <span class="skolem">JJ2</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">II1</span></span> <span class="skolem"><span class="skolem">II2</span></span> <span class="keyword2"><span class="keyword">where</span></span> II12<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="skolem">II1</span><span class="main">,</span><span class="skolem">II2</span><span class="main">}</span> <span class="main">⊆</span> <span class="free">Q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> JJ1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">JJ1</span> <span class="main">=</span> lift <span class="free">P</span> <span class="free">F</span> <span class="skolem">II1</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> JJ2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">JJ2</span> <span class="main">=</span> lift <span class="free">P</span> <span class="free">F</span> <span class="skolem">II2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">II1</span> <span class="main">≠</span> <span class="skolem">II2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> JJ12 <span class="keyword1"><span class="command">unfolding</span></span> JJ1 JJ2 <span class="keyword1"><span class="command">using</span></span> II12 assms
  <span class="keyword1"><span class="command">using</span></span> inj_on_lift<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">I0</span></span> <span class="quoted"><span class="free">P</span></span> <span class="quoted"><span class="free">Q</span></span> <span class="quoted"><span class="free">F</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">II1</span> <span class="keyword1">Int</span> <span class="skolem">II2</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> II12 Q <span class="keyword1"><span class="command">unfolding</span></span> part_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">JJ1</span> <span class="main">∩</span> <span class="skolem">JJ2</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">JJ1</span> <span class="main">∩</span> <span class="skolem">JJ2</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∈</span> <span class="skolem">JJ1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∈</span> <span class="skolem">JJ2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> j <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">I1</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∈</span> <span class="free">F</span> <span class="skolem">I1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> I1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">I1</span> <span class="main">∈</span> <span class="free">P</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">I1</span> <span class="main">⊆</span> <span class="skolem">II1</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> JJ1 lift_def <span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> j <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">I2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∈</span> <span class="free">F</span> <span class="skolem">I2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> I2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">I2</span> <span class="main">∈</span> <span class="free">P</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">I2</span> <span class="main">⊆</span> <span class="skolem">II2</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> JJ2 lift_def <span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">F</span> <span class="skolem">I1</span> <span class="keyword1">Int</span> <span class="free">F</span> <span class="skolem">I2</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">F</span> <span class="skolem">I1</span> <span class="main">=</span> <span class="free">F</span> <span class="skolem">I2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> I1 I2 FP <span class="keyword1"><span class="command">unfolding</span></span> part_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">I1</span> <span class="main">=</span> <span class="skolem">I2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> I1 I2 F <span class="keyword1"><span class="command">unfolding</span></span> inj_on_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">I1</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> I1 emp <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">II1</span> <span class="keyword1">Int</span> <span class="skolem">II2</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> I1 I2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> 4 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Resumption_Based-finer_lift"><span class="command">lemma</span></span> finer_lift<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finer <span class="free">P</span> <span class="free">Q</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finer <span class="main">(</span><span class="free">F</span> <span class="main">`</span> <span class="free">P</span><span class="main">)</span> <span class="main">(</span>lift <span class="free">P</span> <span class="free">F</span> <span class="main">`</span> <span class="free">Q</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> finer_def <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> conjI ballI impI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">JJ</span> <span class="keyword3"><span class="command">assume</span></span> JJ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">JJ</span> <span class="main">∈</span> lift <span class="free">P</span> <span class="free">F</span> <span class="main">`</span> <span class="free">Q</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">JJ</span> <span class="main">=</span> <span class="main">⋃</span> <span class="main">{</span><span class="bound"><span class="bound">J</span></span> <span class="main">∈</span> <span class="free">F</span> <span class="main">`</span> <span class="free">P</span><span class="main">.</span> <span class="bound">J</span> <span class="main">⊆</span> <span class="skolem">JJ</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j</span> <span class="keyword3"><span class="command">assume</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∈</span> <span class="skolem">JJ</span>"</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">II</span></span> <span class="keyword2"><span class="keyword">where</span></span> II<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">II</span> <span class="main">∈</span> <span class="free">Q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> JJ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">JJ</span> <span class="main">=</span> lift <span class="free">P</span> <span class="free">F</span> <span class="skolem">II</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> JJ <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">I</span></span> <span class="keyword2"><span class="keyword">where</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∈</span> <span class="free">F</span> <span class="skolem">I</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">I</span> <span class="main">∈</span> <span class="free">P</span> <span class="main">∧</span> <span class="skolem">I</span> <span class="main">⊆</span> <span class="skolem">II</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">F</span> <span class="skolem">I</span> <span class="main">⊆</span> <span class="skolem">JJ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> j <span class="keyword1"><span class="command">unfolding</span></span> lift_def <span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∈</span> <span class="main">⋃</span><span class="main">{</span><span class="bound"><span class="bound">J</span></span> <span class="main">∈</span> <span class="free">F</span> <span class="main">`</span> <span class="free">P</span><span class="main">.</span> <span class="bound">J</span> <span class="main">⊆</span> <span class="skolem">JJ</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> I j <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">F</span> <span class="main">`</span> <span class="free">P</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"lift <span class="free">P</span> <span class="free">F</span> <span class="main">`</span> <span class="free">Q</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> lift_def <span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span> finer_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Basic setting for bisimilarity›</span></span>

<span class="keyword1"><span class="command">locale</span></span> PL_Indis <span class="main">=</span>
  PL <span class="quoted"><span class="free">aval</span></span> <span class="quoted"><span class="free">tval</span></span> <span class="quoted"><span class="free">cval</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">aval</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'atom</span> <span class="main">⇒</span> <span class="tfree">'state</span> <span class="main">⇒</span> <span class="tfree">'state</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      <span class="free">tval</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'test</span> <span class="main">⇒</span> <span class="tfree">'state</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      <span class="free">cval</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'choice</span> <span class="main">⇒</span> <span class="tfree">'state</span> <span class="main">⇒</span> real"</span></span> <span class="main">+</span>
  <span class="keyword2"><span class="keyword">fixes</span></span>
    <span class="free">indis</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state</span> rel"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    equiv_indis<span class="main">:</span> <span class="quoted"><span class="quoted">"equiv UNIV <span class="free">indis</span>"</span></span>


<span class="comment1">(*******************************************)</span>
<span class="keyword1"><span class="command">context</span></span> PL_Indis
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">indisAbbrev</span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">≈</span>"</span> 50<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="main"><span class="free">≈</span></span> <span class="free"><span class="bound"><span class="entity">s2</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s2</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">indis</span>"</span></span>

<span class="keyword1" id="Resumption_Based-refl_indis"><span class="command">lemma</span></span> refl_indis<span class="main">:</span> <span class="quoted"><span class="quoted">"refl <span class="free">indis</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> trans_indis<span class="main">:</span> <span class="quoted"><span class="quoted">"trans <span class="free">indis</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> sym_indis<span class="main">:</span> <span class="quoted"><span class="quoted">"sym <span class="free">indis</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> equiv_indis <span class="keyword1"><span class="command">unfolding</span></span> equiv_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Resumption_Based-indis_refl"><span class="command">lemma</span></span> indis_refl<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">≈</span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> refl_indis <span class="keyword1"><span class="command">unfolding</span></span> refl_on_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Resumption_Based-indis_trans"><span class="command">lemma</span></span> indis_trans<span class="main">[</span><span class="operator">trans</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">s</span> <span class="main">≈</span> <span class="free">s'</span><span class="main">;</span> <span class="free">s'</span> <span class="main">≈</span> <span class="free">s''</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">s</span> <span class="main">≈</span> <span class="free">s''</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> trans_indis <span class="keyword1"><span class="command">unfolding</span></span> trans_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Resumption_Based-indis_sym"><span class="command">lemma</span></span> indis_sym<span class="main">[</span><span class="operator">sym</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">≈</span> <span class="free">s'</span> <span class="main">⟹</span> <span class="free">s'</span> <span class="main">≈</span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> sym_indis <span class="keyword1"><span class="command">unfolding</span></span> sym_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>


<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Discreetness›</span></span>

<span class="keyword1"><span class="command">coinductive</span></span> <span class="entity">discr</span> <span class="keyword2"><span class="keyword">where</span></span>
intro<span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span> <span class="bound">s</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> brn <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">⟶</span> <span class="bound">s</span> <span class="main">≈</span> eff <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">s</span> <span class="bound">i</span> <span class="main">∧</span> <span class="free">discr</span> <span class="main">(</span>cont <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">s</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>
 <span class="main">⟹</span> <span class="free">discr</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">discrL</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">discrL</span> <span class="free"><span class="bound"><span class="entity">cl</span></span></span> <span class="main">≡</span> <span class="main">∀</span> <span class="bound">c</span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">cl</span></span></span><span class="main">.</span> discr <span class="bound">c</span>"</span></span>

<span class="keyword1" id="Resumption_Based-discrL_intro"><span class="command">lemma</span></span> discrL_intro<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">c</span><span class="main">.</span> <span class="bound">c</span> <span class="main">∈</span> set <span class="free">cl</span> <span class="main">⟹</span> discr <span class="bound">c</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"discrL <span class="free">cl</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> discrL_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Resumption_Based-discrL_discr"><span class="command">lemma</span></span> discrL_discr<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"discrL <span class="free">cl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">∈</span> set <span class="free">cl</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"discr <span class="free">c</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> discrL_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Resumption_Based-discrL_update"><span class="command">lemma</span></span> discrL_update<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> cl<span class="main">:</span> <span class="quoted"><span class="quoted">"discrL <span class="free">cl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> c'<span class="main">:</span> <span class="quoted"><span class="quoted">"discr <span class="free">c'</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"discrL <span class="main">(</span><span class="free">cl</span><span class="main">[</span><span class="free">n</span> <span class="main">:=</span> <span class="free">c'</span><span class="main">]</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&lt;</span> length <span class="free">cl</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> discrL_def <span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">c</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">cl</span><span class="main">[</span><span class="free">n</span> <span class="main">:=</span> <span class="free">c'</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">∈</span> insert <span class="free">c'</span> <span class="main">(</span>set <span class="free">cl</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> set_update_subset_insert <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"discr <span class="skolem">c</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">=</span> <span class="free">c'</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> cl<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Coinduction for discreetness:›</span></span>

<span class="keyword1" id="Resumption_Based-discr_coind"><span class="command">lemma</span></span> discr_coind<span class="main">[</span><span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">case_names</span> Hyp<span class="main">,</span> <span class="operator">induct</span> <span class="quasi_keyword"><span class="quasi_keyword">pred</span></span><span class="main"><span class="main"><span class="main">:</span></span></span> discr<span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">phi</span> <span class="free">c</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
**<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">c</span> <span class="bound">s</span> <span class="bound">i</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">phi</span> <span class="bound">c</span> <span class="main">;</span> <span class="bound">i</span> <span class="main">&lt;</span> brn <span class="bound">c</span><span class="main">⟧</span>
       <span class="main">⟹</span> <span class="bound">s</span> <span class="main">≈</span> eff <span class="bound">c</span> <span class="bound">s</span> <span class="bound">i</span> <span class="main">∧</span> <span class="main">(</span><span class="free">phi</span> <span class="main">(</span>cont <span class="bound">c</span> <span class="bound">s</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∨</span> discr <span class="main">(</span>cont <span class="bound">c</span> <span class="bound">s</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"discr <span class="free">c</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> discr.coinduct<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> ** <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Resumption_Based-discr_raw_coind"><span class="command">lemma</span></span> discr_raw_coind<span class="main">[</span><span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">case_names</span> Hyp<span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">phi</span> <span class="free">c</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
**<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">c</span> <span class="bound">s</span> <span class="bound">i</span><span class="main">.</span> <span class="main">⟦</span><span class="bound">i</span> <span class="main">&lt;</span> brn <span class="bound">c</span><span class="main">;</span> <span class="free">phi</span> <span class="bound">c</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="bound">s</span> <span class="main">≈</span> eff <span class="bound">c</span> <span class="bound">s</span> <span class="bound">i</span> <span class="main">∧</span> <span class="free">phi</span> <span class="main">(</span>cont <span class="bound">c</span> <span class="bound">s</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"discr <span class="free">c</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induct</span><span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> ** <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Discreetness versus transition:›</span></span>

<span class="keyword1" id="Resumption_Based-discr_cont"><span class="command">lemma</span></span> discr_cont<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"discr <span class="free">c</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> brn <span class="free">c</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"discr <span class="main">(</span>cont <span class="free">c</span> <span class="free">s</span> <span class="free">i</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> discr.cases<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> ** <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Resumption_Based-discr_eff_indis"><span class="command">lemma</span></span> discr_eff_indis<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"discr <span class="free">c</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> brn <span class="free">c</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">≈</span> eff <span class="free">c</span> <span class="free">s</span> <span class="free">i</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> discr.cases<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> ** <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>


<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Self-isomorphism›</span></span>

<span class="keyword1"><span class="command">coinductive</span></span> <span class="entity">siso</span> <span class="keyword2"><span class="keyword">where</span></span>
intro<span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">⋀</span> <span class="bound">s</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> brn <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">⟹</span> <span class="free">siso</span> <span class="main">(</span>cont <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">s</span> <span class="bound">i</span><span class="main">)</span><span class="main">;</span>
  <span class="main">⋀</span> <span class="bound">s</span> <span class="bound">t</span> <span class="bound">i</span><span class="main">.</span>
     <span class="bound">i</span> <span class="main">&lt;</span> brn <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">≈</span> <span class="bound">t</span> <span class="main">⟹</span>
     eff <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">s</span> <span class="bound">i</span> <span class="main">≈</span> eff <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">t</span> <span class="bound">i</span> <span class="main">∧</span> wt <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">s</span> <span class="bound">i</span> <span class="main">=</span> wt <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">t</span> <span class="bound">i</span> <span class="main">∧</span> cont <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">s</span> <span class="bound">i</span> <span class="main">=</span> cont <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">t</span> <span class="bound">i</span><span class="main">⟧</span>
  <span class="main">⟹</span> <span class="free">siso</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">sisoL</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">sisoL</span> <span class="free"><span class="bound"><span class="entity">cl</span></span></span> <span class="main">≡</span> <span class="main">∀</span> <span class="bound">c</span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">cl</span></span></span><span class="main">.</span> siso <span class="bound">c</span>"</span></span>

<span class="keyword1" id="Resumption_Based-sisoL_intro"><span class="command">lemma</span></span> sisoL_intro<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">c</span><span class="main">.</span> <span class="bound">c</span> <span class="main">∈</span> set <span class="free">cl</span> <span class="main">⟹</span> siso <span class="bound">c</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sisoL <span class="free">cl</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> sisoL_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Resumption_Based-sisoL_siso"><span class="command">lemma</span></span> sisoL_siso<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"sisoL <span class="free">cl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">∈</span> set <span class="free">cl</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"siso <span class="free">c</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> sisoL_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Resumption_Based-sisoL_update"><span class="command">lemma</span></span> sisoL_update<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> cl<span class="main">:</span> <span class="quoted"><span class="quoted">"sisoL <span class="free">cl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> c'<span class="main">:</span> <span class="quoted"><span class="quoted">"siso <span class="free">c'</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sisoL <span class="main">(</span><span class="free">cl</span><span class="main">[</span><span class="free">n</span> <span class="main">:=</span> <span class="free">c'</span><span class="main">]</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&lt;</span> length <span class="free">cl</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> sisoL_def <span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">c</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">cl</span><span class="main">[</span><span class="free">n</span> <span class="main">:=</span> <span class="free">c'</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">∈</span> insert <span class="free">c'</span> <span class="main">(</span>set <span class="free">cl</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> set_update_subset_insert <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"siso <span class="skolem">c</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">=</span> <span class="free">c'</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> cl<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Coinduction for self-isomorphism:›</span></span>

<span class="keyword1" id="Resumption_Based-siso_coind"><span class="command">lemma</span></span> siso_coind<span class="main">[</span><span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">case_names</span> Obs Cont<span class="main">,</span> <span class="operator">induct</span> <span class="quasi_keyword"><span class="quasi_keyword">pred</span></span><span class="main"><span class="main"><span class="main">:</span></span></span> siso<span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">phi</span> <span class="free">c</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
**<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">c</span> <span class="bound">s</span> <span class="bound">t</span> <span class="bound">i</span><span class="main">.</span> <span class="main">⟦</span><span class="bound">i</span> <span class="main">&lt;</span> brn <span class="bound">c</span><span class="main">;</span> <span class="free">phi</span> <span class="bound">c</span><span class="main">;</span> <span class="bound">s</span> <span class="main">≈</span> <span class="bound">t</span><span class="main">⟧</span> <span class="main">⟹</span>
                 eff <span class="bound">c</span> <span class="bound">s</span> <span class="bound">i</span> <span class="main">≈</span> eff <span class="bound">c</span> <span class="bound">t</span> <span class="bound">i</span> <span class="main">∧</span> wt <span class="bound">c</span> <span class="bound">s</span> <span class="bound">i</span> <span class="main">=</span> wt <span class="bound">c</span> <span class="bound">t</span> <span class="bound">i</span> <span class="main">∧</span> cont <span class="bound">c</span> <span class="bound">s</span> <span class="bound">i</span> <span class="main">=</span> cont <span class="bound">c</span> <span class="bound">t</span> <span class="bound">i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
***<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">c</span> <span class="bound">s</span> <span class="bound">i</span><span class="main">.</span> <span class="main">⟦</span><span class="bound">i</span> <span class="main">&lt;</span> brn <span class="bound">c</span><span class="main">;</span> <span class="free">phi</span> <span class="bound">c</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">phi</span> <span class="main">(</span>cont <span class="bound">c</span> <span class="bound">s</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∨</span> siso <span class="main">(</span>cont <span class="bound">c</span> <span class="bound">s</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"siso <span class="free">c</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> siso.coinduct<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> ** *** <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Resumption_Based-siso_raw_coind"><span class="command">lemma</span></span> siso_raw_coind<span class="main">[</span><span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">case_names</span> Obs Cont<span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">phi</span> <span class="free">c</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
***<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">c</span> <span class="bound">s</span> <span class="bound">t</span> <span class="bound">i</span><span class="main">.</span> <span class="main">⟦</span><span class="bound">i</span> <span class="main">&lt;</span> brn <span class="bound">c</span><span class="main">;</span> <span class="free">phi</span> <span class="bound">c</span><span class="main">;</span> <span class="bound">s</span> <span class="main">≈</span> <span class="bound">t</span><span class="main">⟧</span> <span class="main">⟹</span>
                  eff <span class="bound">c</span> <span class="bound">s</span> <span class="bound">i</span> <span class="main">≈</span> eff <span class="bound">c</span> <span class="bound">t</span> <span class="bound">i</span> <span class="main">∧</span> wt <span class="bound">c</span> <span class="bound">s</span> <span class="bound">i</span> <span class="main">=</span> wt <span class="bound">c</span> <span class="bound">t</span> <span class="bound">i</span> <span class="main">∧</span> cont <span class="bound">c</span> <span class="bound">s</span> <span class="bound">i</span> <span class="main">=</span> cont <span class="bound">c</span> <span class="bound">t</span> <span class="bound">i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
**<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">c</span> <span class="bound">s</span> <span class="bound">i</span><span class="main">.</span> <span class="main">⟦</span><span class="bound">i</span> <span class="main">&lt;</span> brn <span class="bound">c</span><span class="main">;</span> <span class="free">phi</span> <span class="bound">c</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">phi</span> <span class="main">(</span>cont <span class="bound">c</span> <span class="bound">s</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"siso <span class="free">c</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">induct</span> <span class="keyword1"><span class="command">using</span></span> ** *** <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Self-Isomorphism versus transition:›</span></span>

<span class="keyword1" id="Resumption_Based-siso_cont"><span class="command">lemma</span></span> siso_cont<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"siso <span class="free">c</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> brn <span class="free">c</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"siso <span class="main">(</span>cont <span class="free">c</span> <span class="free">s</span> <span class="free">i</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> siso.cases<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> ** <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Resumption_Based-siso_cont_indis"><span class="command">lemma</span></span> siso_cont_indis<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"siso <span class="free">c</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">≈</span> <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> brn <span class="free">c</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"eff <span class="free">c</span> <span class="free">s</span> <span class="free">i</span> <span class="main">≈</span> eff <span class="free">c</span> <span class="free">t</span> <span class="free">i</span> <span class="main">∧</span> wt <span class="free">c</span> <span class="free">s</span> <span class="free">i</span> <span class="main">=</span> wt <span class="free">c</span> <span class="free">t</span> <span class="free">i</span> <span class="main">∧</span> cont <span class="free">c</span> <span class="free">s</span> <span class="free">i</span> <span class="main">=</span> cont <span class="free">c</span> <span class="free">t</span> <span class="free">i</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> siso.cases<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> ** <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>


<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Notions of bisimilarity›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Matchers›</span></span>

<span class="comment1">(* The notations are essentially the ones from the paper, except that,
   instead the paper's "Q" (which is redundant), we write "F P".
   Also, for the proper management of the proof, we have some intermediate
   predicates that compose the matchers.
*)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">mC_C_part</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">mC_C_part</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="main">≡</span>
 <span class="main">{}</span> <span class="main">∉</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">∧</span> <span class="main">{}</span> <span class="main">∉</span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="main">`</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">∧</span>
 part <span class="main">{..&lt;</span> brn <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">}</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">∧</span> part <span class="main">{..&lt;</span> brn <span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">}</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="main">`</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">mC_C_wt</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">mC_C_wt</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="main">≡</span> <span class="main">∀</span> <span class="bound">I</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">.</span> sum <span class="main">(</span>wt <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="bound">I</span> <span class="main">=</span> sum <span class="main">(</span>wt <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="bound">I</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">mC_C_eff_cont</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">mC_C_eff_cont</span> <span class="free"><span class="bound"><span class="entity">theta</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="main">≡</span>
 <span class="main">∀</span> <span class="bound">I</span> <span class="bound">i</span> <span class="bound">j</span><span class="main">.</span>
   <span class="bound">I</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">∧</span> <span class="bound">i</span> <span class="main">∈</span> <span class="bound">I</span> <span class="main">∧</span> <span class="bound">j</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="bound">I</span> <span class="main">⟶</span>
   eff <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="bound">i</span> <span class="main">≈</span> eff <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="bound">j</span> <span class="main">∧</span> <span class="main">(</span>cont <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="bound">i</span><span class="main">,</span> cont <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="bound">j</span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">theta</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">mC_C</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">mC_C</span> <span class="free"><span class="bound"><span class="entity">theta</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="main">≡</span>
 mC_C_part <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="main">∧</span> inj_on <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">∧</span> mC_C_wt <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="main">∧</span> mC_C_eff_cont <span class="free"><span class="bound"><span class="entity">theta</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">F</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">matchC_C</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">matchC_C</span> <span class="free"><span class="bound"><span class="entity">theta</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">≡</span> <span class="main">∀</span> <span class="bound">s</span> <span class="bound">t</span><span class="main">.</span> <span class="bound">s</span> <span class="main">≈</span> <span class="bound">t</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">P</span> <span class="bound">F</span><span class="main">.</span> mC_C <span class="free"><span class="bound"><span class="entity">theta</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="bound">s</span> <span class="bound">t</span> <span class="bound">P</span> <span class="bound">F</span><span class="main">)</span>"</span></span>

<span class="comment1">(*  *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">mC_ZOC_part</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">mC_ZOC_part</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">I0</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="main">≡</span>
 <span class="main">{}</span> <span class="main">∉</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">-</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">I0</span></span></span><span class="main">}</span> <span class="main">∧</span> <span class="main">{}</span> <span class="main">∉</span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="main">`</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">-</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">I0</span></span></span><span class="main">}</span><span class="main">)</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">I0</span></span></span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">∧</span>
 part <span class="main">{..&lt;</span> brn <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">}</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">∧</span> part <span class="main">{..&lt;</span> brn <span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">}</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="main">`</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">mC_ZOC_wt</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">mC_ZOC_wt</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">I0</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="main">≡</span>
 sum <span class="main">(</span>wt <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">I0</span></span></span> <span class="main">&lt;</span> <span class="main">1</span> <span class="main">∧</span> sum <span class="main">(</span>wt <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">I0</span></span></span><span class="main">)</span> <span class="main">&lt;</span> <span class="main">1</span> <span class="main">⟶</span>
 <span class="main">(</span><span class="main">∀</span> <span class="bound">I</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">-</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">I0</span></span></span><span class="main">}</span><span class="main">.</span>
    sum <span class="main">(</span>wt <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="bound">I</span> <span class="main">/</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> sum <span class="main">(</span>wt <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">I0</span></span></span><span class="main">)</span> <span class="main">=</span>
    sum <span class="main">(</span>wt <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="bound">I</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> sum <span class="main">(</span>wt <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">I0</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="comment1">(* Note: In case either sum is 1, the above condition
   holds vacously. *)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">mC_ZOC_eff_cont0</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">mC_ZOC_eff_cont0</span> <span class="free"><span class="bound"><span class="entity">theta</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">I0</span></span></span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="main">≡</span>
 <span class="main">(</span><span class="main">∀</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">I0</span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≈</span> eff <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="bound">i</span> <span class="main">∧</span> <span class="main">(</span>cont <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="bound">i</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">theta</span></span></span><span class="main">)</span> <span class="main">∧</span>
 <span class="main">(</span><span class="main">∀</span> <span class="bound">j</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">I0</span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≈</span> eff <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="bound">j</span> <span class="main">∧</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span> cont <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="bound">j</span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">theta</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">mC_ZOC_eff_cont</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">mC_ZOC_eff_cont</span> <span class="free"><span class="bound"><span class="entity">theta</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">I0</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="main">≡</span>
 <span class="main">∀</span> <span class="bound">I</span> <span class="bound">i</span> <span class="bound">j</span><span class="main">.</span>
   <span class="bound">I</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">-</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">I0</span></span></span><span class="main">}</span> <span class="main">∧</span> <span class="bound">i</span> <span class="main">∈</span> <span class="bound">I</span> <span class="main">∧</span> <span class="bound">j</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="bound">I</span> <span class="main">⟶</span>
   eff <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="bound">i</span> <span class="main">≈</span> eff <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="bound">j</span> <span class="main">∧</span>
   <span class="main">(</span>cont <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="bound">i</span><span class="main">,</span> cont <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="bound">j</span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">theta</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">mC_ZOC</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">mC_ZOC</span> <span class="free"><span class="bound"><span class="entity">theta</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">I0</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="main">≡</span>
 mC_ZOC_part <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">I0</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="main">∧</span>
 inj_on <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">∧</span>
 mC_ZOC_wt <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">I0</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="main">∧</span>
 mC_ZOC_eff_cont0 <span class="free"><span class="bound"><span class="entity">theta</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">I0</span></span></span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="main">∧</span>
 mC_ZOC_eff_cont <span class="free"><span class="bound"><span class="entity">theta</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">I0</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">F</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">matchC_LC</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">matchC_LC</span> <span class="free"><span class="bound"><span class="entity">theta</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">≡</span>
 <span class="main">∀</span> <span class="bound">s</span> <span class="bound">t</span><span class="main">.</span> <span class="bound">s</span> <span class="main">≈</span> <span class="bound">t</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">I0</span> <span class="bound">P</span> <span class="bound">F</span><span class="main">.</span> mC_ZOC <span class="free"><span class="bound"><span class="entity">theta</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="bound">s</span> <span class="bound">t</span> <span class="bound">I0</span> <span class="bound">P</span> <span class="bound">F</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> m_defs <span class="main">=</span> mC_C_def mC_ZOC_def

<span class="keyword1"><span class="command">lemmas</span></span> m_defsAll <span class="main">=</span>
mC_C_def mC_C_part_def mC_C_wt_def mC_C_eff_cont_def
mC_ZOC_def mC_ZOC_part_def mC_ZOC_wt_def mC_ZOC_eff_cont0_def mC_ZOC_eff_cont_def

<span class="keyword1"><span class="command">lemmas</span></span> match_defs <span class="main">=</span>
matchC_C_def matchC_LC_def

<span class="keyword1" id="Resumption_Based-mC_C_mono"><span class="command">lemma</span></span> mC_C_mono<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"mC_C <span class="free">theta</span> <span class="free">c</span> <span class="free">d</span> <span class="free">s</span> <span class="free">t</span> <span class="free">P</span> <span class="free">F</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">theta</span> <span class="main">⊆</span> <span class="free">theta'</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mC_C <span class="free">theta'</span> <span class="free">c</span> <span class="free">d</span> <span class="free">s</span> <span class="free">t</span> <span class="free">P</span> <span class="free">F</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> m_defsAll <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="Resumption_Based-matchC_C_mono"><span class="command">lemma</span></span> matchC_C_mono<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"matchC_C <span class="free">theta</span> <span class="free">c</span> <span class="free">d</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">theta</span> <span class="main">⊆</span> <span class="free">theta'</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"matchC_C <span class="free">theta'</span> <span class="free">c</span> <span class="free">d</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms mC_C_mono <span class="keyword1"><span class="command">unfolding</span></span> matchC_C_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Resumption_Based-mC_ZOC_mono"><span class="command">lemma</span></span> mC_ZOC_mono<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"mC_ZOC <span class="free">theta</span> <span class="free">c</span> <span class="free">d</span> <span class="free">s</span> <span class="free">t</span> <span class="free">I0</span> <span class="free">P</span> <span class="free">F</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">theta</span> <span class="main">⊆</span> <span class="free">theta'</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mC_ZOC <span class="free">theta'</span> <span class="free">c</span> <span class="free">d</span> <span class="free">s</span> <span class="free">t</span> <span class="free">I0</span> <span class="free">P</span> <span class="free">F</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> m_defsAll subset_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Resumption_Based-matchC_LC_mono"><span class="command">lemma</span></span> matchC_LC_mono<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"matchC_LC <span class="free">theta</span> <span class="free">c</span> <span class="free">d</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">theta</span> <span class="main">⊆</span> <span class="free">theta'</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"matchC_LC <span class="free">theta'</span> <span class="free">c</span> <span class="free">d</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms mC_ZOC_mono <span class="keyword1"><span class="command">unfolding</span></span> matchC_LC_def
<span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1" id="Resumption_Based-Int_not_in_eq_emp"><span class="command">lemma</span></span> Int_not_in_eq_emp<span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">∩</span> <span class="main">{</span><span class="bound">I</span><span class="main">.</span> <span class="bound">I</span> <span class="main">∉</span> <span class="free">P</span><span class="main">}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Resumption_Based-mC_C_mC_ZOC"><span class="command">lemma</span></span> mC_C_mC_ZOC<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"mC_C <span class="free">theta</span> <span class="free">c</span> <span class="free">d</span> <span class="free">s</span> <span class="free">t</span> <span class="free">P</span> <span class="free">F</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mC_ZOC <span class="free">theta</span> <span class="free">c</span> <span class="free">d</span> <span class="free">s</span> <span class="free">t</span> <span class="main">{}</span> <span class="main">(</span><span class="free">P</span> <span class="keyword1">Un</span> <span class="main">{</span> <span class="main">{}</span> <span class="main">}</span><span class="main">)</span> <span class="main">(</span><span class="main">%</span><span class="bound">I</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">I</span> <span class="main">∈</span> <span class="free">P</span> <span class="keyword1">then</span> <span class="free">F</span> <span class="bound">I</span> <span class="keyword1">else</span> <span class="main">{}</span><span class="main">)</span>"</span></span>
<span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"mC_ZOC <span class="free">theta</span> <span class="free">c</span> <span class="free">d</span> <span class="free">s</span> <span class="free">t</span> <span class="var">?I0</span> <span class="var">?Q</span> <span class="var">?G</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">unfolding</span></span> mC_ZOC_def <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"mC_ZOC_part <span class="free">c</span> <span class="free">d</span> <span class="free">s</span> <span class="free">t</span> <span class="var">?I0</span> <span class="var">?Q</span> <span class="var">?G</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> mC_ZOC_part_def <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> mC_C_def mC_C_part_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Int_not_in_eq_emp<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="var">?G</span> <span class="var">?Q</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> inj_on_def <span class="keyword1"><span class="command">proof</span></span> <span class="operator">clarify</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">I1</span> <span class="skolem">I2</span> <span class="keyword3"><span class="command">assume</span></span> I12<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">I1</span> <span class="main">∈</span> <span class="var">?Q</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">I2</span> <span class="main">∈</span> <span class="var">?Q</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> G<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?G</span> <span class="skolem">I1</span> <span class="main">=</span> <span class="var">?G</span> <span class="skolem">I2</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">I1</span> <span class="main">=</span> <span class="skolem">I2</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">I1</span> <span class="main">∈</span> <span class="free">P</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">hence</span></span> I2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">I2</span> <span class="main">∈</span> <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> ccontr<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> G assms <span class="keyword1"><span class="command">unfolding</span></span> mC_C_def mC_C_part_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> True G <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">F</span> <span class="skolem">I1</span> <span class="main">=</span> <span class="free">F</span> <span class="skolem">I2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> True I2 I12 assms <span class="keyword1"><span class="command">unfolding</span></span> mC_C_def inj_on_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">note</span></span> case1 <span class="main">=</span> False
      <span class="keyword1"><span class="command">hence</span></span> I1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">I1</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> I12 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">I2</span> <span class="main">∈</span> <span class="free">P</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">I2</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> I12 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> I1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">I1</span> <span class="main">∈</span> <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> ccontr<span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> G assms <span class="keyword1"><span class="command">unfolding</span></span> mC_C_def mC_C_part_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> case1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span><span class="main">(</span><span class="operator">insert</span> assms<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> m_defsAll<span class="main"><span class="keyword3">,</span></span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>

<span class="keyword1" id="Resumption_Based-matchC_C_matchC_LC"><span class="command">lemma</span></span> matchC_C_matchC_LC<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"matchC_C <span class="free">theta</span> <span class="free">c</span> <span class="free">d</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"matchC_LC <span class="free">theta</span> <span class="free">c</span> <span class="free">d</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms mC_C_mC_ZOC <span class="keyword1"><span class="command">unfolding</span></span> match_defs <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>


<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Retracts:›</span></span>

<span class="comment1">(* Strong retract: *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Sretr</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">Sretr</span> <span class="free"><span class="bound"><span class="entity">theta</span></span></span> <span class="main">≡</span>
 <span class="main">{</span><span class="main">(</span><span class="bound">c</span><span class="main">,</span> <span class="bound">d</span><span class="main">)</span><span class="main">.</span> matchC_C <span class="free"><span class="bound"><span class="entity">theta</span></span></span> <span class="bound">c</span> <span class="bound">d</span><span class="main">}</span>"</span></span>

<span class="comment1">(* Zero-One retract: *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ZOretr</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">ZOretr</span> <span class="free"><span class="bound"><span class="entity">theta</span></span></span> <span class="main">≡</span>
 <span class="main">{</span><span class="main">(</span><span class="bound">c</span><span class="main">,</span><span class="bound">d</span><span class="main">)</span><span class="main">.</span> matchC_LC <span class="free"><span class="bound"><span class="entity">theta</span></span></span> <span class="bound">c</span> <span class="bound">d</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> Retr_defs <span class="main">=</span>
Sretr_def
ZOretr_def

<span class="keyword1" id="Resumption_Based-mono_Retr"><span class="command">lemma</span></span> mono_Retr<span class="main">:</span>
<span class="quoted"><span class="quoted">"mono Sretr"</span></span>
<span class="quoted"><span class="quoted">"mono ZOretr"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> mono_def Retr_defs
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> matchC_C_mono matchC_LC_mono<span class="main">)</span>

<span class="keyword1" id="Resumption_Based-Retr_incl"><span class="command">lemma</span></span> Retr_incl<span class="main">:</span>
<span class="quoted"><span class="quoted">"Sretr <span class="free">theta</span> <span class="main">⊆</span> ZOretr <span class="free">theta</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> Retr_defs
<span class="keyword1"><span class="command">using</span></span> matchC_C_matchC_LC <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>


<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The associated bisimilarity relations:›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Sbis</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">Sbis</span> <span class="main">≡</span> gfp Sretr"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ZObis</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">ZObis</span> <span class="main">≡</span> gfp ZOretr"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">Sbis_abbrev</span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">≈s</span>"</span> 55<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="keyword1"><span class="free">≈s</span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">)</span> <span class="main">:</span> Sbis"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">ZObis_abbrev</span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">≈01</span>"</span> 55<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main"><span class="free">≈01</span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">)</span> <span class="main">:</span> ZObis"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> bis_defs <span class="main">=</span> Sbis_def ZObis_def

<span class="comment1">(* Inclusions between bisimilarities: *)</span>
<span class="keyword1" id="Resumption_Based-bis_incl"><span class="command">lemma</span></span> bis_incl<span class="main">:</span>
<span class="quoted"><span class="quoted">"Sbis <span class="main">≤</span> ZObis"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> bis_defs
<span class="keyword1"><span class="command">using</span></span> Retr_incl gfp_mono <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="Resumption_Based-bis_imp"><span class="command">lemma</span></span> bis_imp<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">c1</span> <span class="bound">c2</span><span class="main">.</span> <span class="bound">c1</span> <span class="keyword1">≈s</span> <span class="bound">c2</span> <span class="main">⟹</span> <span class="bound">c1</span> <span class="main">≈01</span> <span class="bound">c2</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> bis_incl <span class="keyword1"><span class="command">unfolding</span></span> bis_defs <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="comment1">(*  Sbis: *)</span>

<span class="keyword1" id="Resumption_Based-Sbis_prefix"><span class="command">lemma</span></span> Sbis_prefix<span class="main">:</span>
<span class="quoted"><span class="quoted">"Sbis <span class="main">≤</span> Sretr Sbis"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> Sbis_def
<span class="keyword1"><span class="command">using</span></span> def_gfp_unfold mono_Retr<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Resumption_Based-Sbis_fix"><span class="command">lemma</span></span> Sbis_fix<span class="main">:</span>
<span class="quoted"><span class="quoted">"Sretr Sbis <span class="main">=</span> Sbis"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> Sbis_def
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> def_gfp_unfold mono_Retr<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1" id="Resumption_Based-Sbis_mC_C"><span class="command">lemma</span></span> Sbis_mC_C<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="keyword1">≈s</span> <span class="free">d</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">≈</span> <span class="free">t</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">P</span> <span class="bound">F</span><span class="main">.</span> mC_C Sbis <span class="free">c</span> <span class="free">d</span> <span class="free">s</span> <span class="free">t</span> <span class="bound">P</span> <span class="bound">F</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms Sbis_prefix <span class="keyword1"><span class="command">unfolding</span></span> Sretr_def matchC_C_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Resumption_Based-Sbis_coind"><span class="command">lemma</span></span> Sbis_coind<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">theta</span> <span class="main">≤</span> Sretr <span class="main">(</span><span class="free">theta</span> <span class="keyword1">Un</span> Sbis<span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">theta</span> <span class="main">≤</span> Sbis"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> Sbis_def
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Sbis_def assms def_coinduct mono_Retr<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1" id="Resumption_Based-Sbis_raw_coind"><span class="command">lemma</span></span> Sbis_raw_coind<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">theta</span> <span class="main">≤</span> Sretr <span class="free">theta</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">theta</span> <span class="main">≤</span> Sbis"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Sretr <span class="free">theta</span> <span class="main">⊆</span> Sretr <span class="main">(</span><span class="free">theta</span> <span class="keyword1">Un</span> Sbis<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Un_upper1 monoD mono_Retr<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">theta</span> <span class="main">⊆</span> Sretr <span class="main">(</span><span class="free">theta</span> <span class="keyword1">Un</span> Sbis<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Sbis_coind <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* Symmetry *)</span>

<span class="keyword1" id="Resumption_Based-mC_C_sym"><span class="command">lemma</span></span> mC_C_sym<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"mC_C <span class="free">theta</span> <span class="free">c</span> <span class="free">d</span> <span class="free">s</span> <span class="free">t</span> <span class="free">P</span> <span class="free">F</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mC_C <span class="main">(</span><span class="free">theta</span> <span class="main">^-1</span><span class="main">)</span> <span class="free">d</span> <span class="free">c</span> <span class="free">t</span> <span class="free">s</span> <span class="main">(</span><span class="free">F</span> <span class="main">`</span> <span class="free">P</span><span class="main">)</span> <span class="main">(</span>inv_into <span class="free">P</span> <span class="free">F</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> mC_C_def <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"mC_C_eff_cont <span class="main">(</span><span class="free">theta</span><span class="main">¯</span><span class="main">)</span> <span class="free">d</span> <span class="free">c</span> <span class="free">t</span> <span class="free">s</span> <span class="main">(</span><span class="free">F</span> <span class="main">`</span> <span class="free">P</span><span class="main">)</span> <span class="main">(</span>inv_into <span class="free">P</span> <span class="free">F</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> mC_C_eff_cont_def <span class="keyword1"><span class="command">proof</span></span> <span class="operator">clarify</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="skolem">j</span> <span class="skolem">I</span>
    <span class="keyword3"><span class="command">assume</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">I</span> <span class="main">∈</span> <span class="free">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∈</span> <span class="free">F</span> <span class="skolem">I</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> inv_into <span class="free">P</span> <span class="free">F</span> <span class="main">(</span><span class="free">F</span> <span class="skolem">I</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="skolem">I</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> mC_C_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"eff <span class="free">c</span> <span class="free">s</span> <span class="skolem">i</span> <span class="main">≈</span> eff <span class="free">d</span> <span class="free">t</span> <span class="skolem">j</span> <span class="main">∧</span> <span class="main">(</span>cont <span class="free">c</span> <span class="free">s</span> <span class="skolem">i</span><span class="main">,</span> cont <span class="free">d</span> <span class="free">t</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">∈</span> <span class="free">theta</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms I j <span class="keyword1"><span class="command">unfolding</span></span> mC_C_def mC_C_eff_cont_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"eff <span class="free">d</span> <span class="free">t</span> <span class="skolem">j</span> <span class="main">≈</span> eff <span class="free">c</span> <span class="free">s</span> <span class="skolem">i</span> <span class="main">∧</span> <span class="main">(</span>cont <span class="free">d</span> <span class="free">t</span> <span class="skolem">j</span><span class="main">,</span> cont <span class="free">c</span> <span class="free">s</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">∈</span> <span class="free">theta</span><span class="main">¯</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> converseI indis_sym<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span><span class="main">(</span><span class="operator">insert</span> assms<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> m_defsAll<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Resumption_Based-matchC_C_sym"><span class="command">lemma</span></span> matchC_C_sym<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"matchC_C <span class="free">theta</span> <span class="free">c</span> <span class="free">d</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"matchC_C <span class="main">(</span><span class="free">theta</span> <span class="main">^-1</span><span class="main">)</span> <span class="free">d</span> <span class="free">c</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> matchC_C_def <span class="keyword1"><span class="command">proof</span></span> <span class="operator">clarify</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span> <span class="skolem">s</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">≈</span> <span class="skolem">s</span>"</span></span>  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">≈</span> <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> indis_sym<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">P</span></span> <span class="skolem"><span class="skolem">F</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"mC_C <span class="free">theta</span> <span class="free">c</span> <span class="free">d</span> <span class="skolem">s</span> <span class="skolem">t</span> <span class="skolem">P</span> <span class="skolem">F</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> matchC_C_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"mC_C <span class="main">(</span><span class="free">theta</span><span class="main">¯</span><span class="main">)</span> <span class="free">d</span> <span class="free">c</span> <span class="skolem">t</span> <span class="skolem">s</span> <span class="main">(</span><span class="skolem">F</span> <span class="main">`</span> <span class="skolem">P</span><span class="main">)</span> <span class="main">(</span>inv_into <span class="skolem">P</span> <span class="skolem">F</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> mC_C_sym <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">Q</span> <span class="bound">G</span><span class="main">.</span> mC_C <span class="main">(</span><span class="free">theta</span><span class="main">¯</span><span class="main">)</span> <span class="free">d</span> <span class="free">c</span> <span class="skolem">t</span> <span class="skolem">s</span> <span class="bound">Q</span> <span class="bound">G</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Resumption_Based-Sretr_sym"><span class="command">lemma</span></span> Sretr_sym<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"sym <span class="free">theta</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sym <span class="main">(</span>Sretr <span class="free">theta</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> sym_def <span class="keyword1"><span class="command">proof</span></span> <span class="operator">clarify</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">c</span> <span class="skolem">d</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">c</span><span class="main">,</span> <span class="skolem">d</span><span class="main">)</span> <span class="main">∈</span> Sretr <span class="free">theta</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">d</span><span class="main">,</span> <span class="skolem">c</span><span class="main">)</span> <span class="main">∈</span> Sretr <span class="main">(</span><span class="free">theta</span> <span class="main">^-1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Sretr_def <span class="keyword1"><span class="command">using</span></span> matchC_C_sym <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">d</span><span class="main">,</span> <span class="skolem">c</span><span class="main">)</span> <span class="main">∈</span> Sretr <span class="free">theta</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> sym_conv_converse_eq<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Resumption_Based-sym_Sbis"><span class="command">lemma</span></span> sym_Sbis<span class="main">:</span> <span class="quoted"><span class="quoted">"sym Sbis"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Sbis_def Sretr_sym mono_Retr<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> sym_gfp<span class="main">)</span>

<span class="keyword1" id="Resumption_Based-Sbis_sym"><span class="command">lemma</span></span> Sbis_sym<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="keyword1">≈s</span> <span class="free">d</span> <span class="main">⟹</span> <span class="free">d</span> <span class="keyword1">≈s</span> <span class="free">c</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> sym_Sbis <span class="keyword1"><span class="command">unfolding</span></span> sym_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>


<span class="comment1">(* Transitivity: *)</span>

<span class="keyword1" id="Resumption_Based-mC_C_trans"><span class="command">lemma</span></span> mC_C_trans<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"mC_C <span class="free">theta1</span> <span class="free">c</span> <span class="free">d</span> <span class="free">s</span> <span class="free">t</span> <span class="free">P</span> <span class="free">F</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"mC_C <span class="free">theta2</span> <span class="free">d</span> <span class="free">e</span> <span class="free">t</span> <span class="free">u</span> <span class="main">(</span><span class="free">F</span> <span class="main">`</span> <span class="free">P</span><span class="main">)</span> <span class="free">G</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mC_C <span class="main">(</span><span class="free">theta1</span> <span class="keyword1">O</span> <span class="free">theta2</span><span class="main">)</span> <span class="free">c</span> <span class="free">e</span> <span class="free">s</span> <span class="free">u</span> <span class="free">P</span> <span class="main">(</span><span class="free">G</span> <span class="keyword1">o</span> <span class="free">F</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> mC_C_def <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"mC_C_part <span class="free">c</span> <span class="free">e</span> <span class="free">P</span> <span class="main">(</span><span class="free">G</span> <span class="main">∘</span> <span class="free">F</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> mC_C_def mC_C_part_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_comp<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="main">(</span><span class="free">G</span> <span class="main">∘</span> <span class="free">F</span><span class="main">)</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> mC_C_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> comp_inj_on<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"mC_C_eff_cont <span class="main">(</span><span class="free">theta1</span> <span class="keyword1">O</span> <span class="free">theta2</span><span class="main">)</span> <span class="free">c</span> <span class="free">e</span> <span class="free">s</span> <span class="free">u</span> <span class="free">P</span> <span class="main">(</span><span class="free">G</span> <span class="main">∘</span> <span class="free">F</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> mC_C_eff_cont_def <span class="keyword1"><span class="command">proof</span></span> <span class="operator">clarify</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">I</span> <span class="skolem">i</span> <span class="skolem">k</span>
    <span class="keyword3"><span class="command">assume</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">I</span> <span class="main">∈</span> <span class="free">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="skolem">I</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">∈</span> <span class="main">(</span><span class="free">G</span> <span class="main">∘</span> <span class="free">F</span><span class="main">)</span> <span class="skolem">I</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">F</span> <span class="skolem">I</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> * I <span class="keyword1"><span class="command">unfolding</span></span> mC_C_def mC_C_part_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∈</span> <span class="free">F</span> <span class="skolem">I</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eff <span class="free">c</span> <span class="free">s</span> <span class="skolem">i</span> <span class="main">≈</span> eff <span class="free">d</span> <span class="free">t</span> <span class="skolem">j</span> <span class="main">∧</span> <span class="main">(</span>cont <span class="free">c</span> <span class="free">s</span> <span class="skolem">i</span><span class="main">,</span> cont <span class="free">d</span> <span class="free">t</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">∈</span> <span class="free">theta1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> I i j * <span class="keyword1"><span class="command">unfolding</span></span> mC_C_def mC_C_eff_cont_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eff <span class="free">d</span> <span class="free">t</span> <span class="skolem">j</span> <span class="main">≈</span> eff <span class="free">e</span> <span class="free">u</span> <span class="skolem">k</span> <span class="main">∧</span> <span class="main">(</span>cont <span class="free">d</span> <span class="free">t</span> <span class="skolem">j</span><span class="main">,</span> cont <span class="free">e</span> <span class="free">u</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">∈</span> <span class="free">theta2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> I j k ** <span class="keyword1"><span class="command">unfolding</span></span> mC_C_def mC_C_eff_cont_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"eff <span class="free">c</span> <span class="free">s</span> <span class="skolem">i</span> <span class="main">≈</span> eff <span class="free">e</span> <span class="free">u</span> <span class="skolem">k</span> <span class="main">∧</span> <span class="main">(</span>cont <span class="free">c</span> <span class="free">s</span> <span class="skolem">i</span><span class="main">,</span> cont <span class="free">e</span> <span class="free">u</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">∈</span> <span class="free">theta1</span> <span class="keyword1">O</span> <span class="free">theta2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> indis_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span><span class="main">(</span><span class="operator">insert</span> assms<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> m_defsAll<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Resumption_Based-mC_C_finer"><span class="command">lemma</span></span> mC_C_finer<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"mC_C <span class="free">theta</span> <span class="free">c</span> <span class="free">d</span> <span class="free">s</span> <span class="free">t</span> <span class="free">P</span> <span class="free">F</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> theta<span class="main">:</span> <span class="quoted"><span class="quoted">"trans <span class="free">theta</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> Q<span class="main">:</span> <span class="quoted"><span class="quoted">"finer <span class="free">P</span> <span class="free">Q</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">Q</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">{}</span> <span class="main">∉</span> <span class="free">Q</span>"</span></span> <span class="quoted"><span class="quoted">"part <span class="main">{..&lt;</span>brn <span class="free">c</span><span class="main">}</span> <span class="free">Q</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"partCompat <span class="free">Q</span> <span class="free">indis</span> <span class="main">(</span>eff <span class="free">c</span> <span class="free">s</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"partCompat <span class="free">Q</span> <span class="free">theta</span> <span class="main">(</span>cont <span class="free">c</span> <span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mC_C <span class="free">theta</span> <span class="free">c</span> <span class="free">d</span> <span class="free">s</span> <span class="free">t</span> <span class="free">Q</span> <span class="main">(</span>lift <span class="free">P</span> <span class="free">F</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> mC_C_def <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"mC_C_part <span class="free">c</span> <span class="free">d</span> <span class="free">Q</span> <span class="main">(</span>lift <span class="free">P</span> <span class="free">F</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> mC_C_part_def <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{}</span> <span class="main">∉</span> lift <span class="free">P</span> <span class="free">F</span> <span class="main">`</span> <span class="free">Q</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> lift_def <span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">clarify</span>
     <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">II</span> <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{}</span> <span class="main">=</span> <span class="main">⋃</span><span class="main">{</span><span class="free">F</span> <span class="bound">I</span> <span class="main">|</span><span class="bound">I</span><span class="main">.</span> <span class="bound">I</span> <span class="main">∈</span> <span class="free">P</span> <span class="main">∧</span> <span class="bound">I</span> <span class="main">⊆</span> <span class="skolem">II</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> II<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">II</span> <span class="main">∈</span> <span class="free">Q</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">II</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Q <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">I</span></span> <span class="keyword2"><span class="keyword">where</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">I</span> <span class="main">∈</span> <span class="free">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">I</span> <span class="main">⊆</span> <span class="skolem">II</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Q II <span class="keyword1"><span class="command">unfolding</span></span> finer_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">F</span> <span class="skolem">I</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> * I <span class="keyword1"><span class="command">unfolding</span></span> mC_C_def mC_C_part_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"part <span class="main">{..&lt;</span>brn <span class="free">d</span><span class="main">}</span> <span class="main">(</span>lift <span class="free">P</span> <span class="free">F</span> <span class="main">`</span> <span class="free">Q</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Q * part_lift<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">{..&lt;</span>brn <span class="free">c</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="free">P</span></span> <span class="quoted"><span class="free">Q</span></span> <span class="quoted"><span class="free">F</span></span> <span class="quoted"><span class="quoted">"<span class="main">{..&lt;</span>brn <span class="free">d</span><span class="main">}</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> mC_C_def mC_C_part_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> Q<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="main">(</span>lift <span class="free">P</span> <span class="free">F</span><span class="main">)</span> <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> Q * inj_on_lift<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">{..&lt;</span>brn <span class="free">c</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="free">P</span></span> <span class="quoted"><span class="free">Q</span></span> <span class="quoted"><span class="free">F</span></span> <span class="quoted"><span class="quoted">"<span class="main">{..&lt;</span>brn <span class="free">d</span><span class="main">}</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">unfolding</span></span> mC_C_def mC_C_part_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"mC_C_wt <span class="free">c</span> <span class="free">d</span> <span class="free">s</span> <span class="free">t</span> <span class="free">Q</span> <span class="main">(</span>lift <span class="free">P</span> <span class="free">F</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> mC_C_wt_def <span class="keyword1"><span class="command">proof</span></span> <span class="operator">clarify</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">II</span> <span class="keyword3"><span class="command">assume</span></span> II<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">II</span> <span class="main">∈</span> <span class="free">Q</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">S</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">I</span></span> <span class="main">∈</span> <span class="free">P</span> <span class="main">.</span> <span class="bound">I</span> <span class="main">⊆</span> <span class="skolem">II</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> II<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">II</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">UN</span> <span class="bound">I</span> <span class="main">:</span> <span class="skolem">S</span> <span class="main">.</span> id <span class="bound">I</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> II Q <span class="keyword1"><span class="command">unfolding</span></span> finer_def S_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> S<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">I</span> <span class="bound">J</span><span class="main">.</span> <span class="main">⟦</span><span class="bound">I</span> <span class="main">:</span> <span class="skolem">S</span><span class="main">;</span> <span class="bound">J</span> <span class="main">:</span> <span class="skolem">S</span><span class="main">;</span> <span class="bound">I</span> <span class="main">≠</span> <span class="bound">J</span><span class="main">⟧</span> <span class="main">⟹</span> id <span class="bound">I</span> <span class="keyword1">Int</span> id <span class="bound">J</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="skolem">S</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> S_def <span class="keyword1"><span class="command">using</span></span> * finite_part<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">{..&lt;</span>brn <span class="free">c</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="free">P</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> mC_C_def mC_C_part_def part_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> SS<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">I</span><span class="main">∈</span><span class="skolem">S</span><span class="main">.</span> finite <span class="bound">I</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">∈</span><span class="skolem">S</span><span class="main">.</span> finite <span class="main">(</span><span class="free">F</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> S_def <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">unfolding</span></span> mC_C_def mC_C_part_def part_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> complete_lattice_class.Sup_upper finite_lessThan finite_subset<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> finite_UN finite_UnionD finite_lessThan<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> SSS<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">∈</span><span class="skolem">S</span><span class="main">.</span> <span class="main">∀</span><span class="bound">j</span><span class="main">∈</span><span class="skolem">S</span><span class="main">.</span> <span class="bound">i</span> <span class="main">≠</span> <span class="bound">j</span> <span class="main">⟶</span> <span class="free">F</span> <span class="bound">i</span> <span class="main">∩</span> <span class="free">F</span> <span class="bound">j</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">clarify</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">I</span> <span class="skolem">J</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">I</span> <span class="main">∈</span> <span class="skolem">S</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">J</span> <span class="main">∈</span> <span class="skolem">S</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> diff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">I</span> <span class="main">≠</span> <span class="skolem">J</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> IJ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="skolem">I</span><span class="main">,</span><span class="skolem">J</span><span class="main">}</span> <span class="main">⊆</span> <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> S_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">F</span> <span class="skolem">I</span> <span class="main">≠</span> <span class="free">F</span> <span class="skolem">J</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> * diff <span class="keyword1"><span class="command">unfolding</span></span> mC_C_def inj_on_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">F</span> <span class="skolem">I</span> <span class="main">∩</span> <span class="free">F</span> <span class="skolem">J</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> * IJ <span class="keyword1"><span class="command">unfolding</span></span> mC_C_def mC_C_part_def part_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum <span class="main">(</span>wt <span class="free">c</span> <span class="free">s</span><span class="main">)</span> <span class="skolem">II</span> <span class="main">=</span> sum <span class="main">(</span>sum <span class="main">(</span>wt <span class="free">c</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="skolem">S</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> II <span class="keyword1"><span class="command">using</span></span> S SS sum.UNION_disjoint<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">S</span></span> <span class="quoted">id</span> <span class="quoted"><span class="quoted">"wt <span class="free">c</span> <span class="free">s</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> sum <span class="main">(</span><span class="main">%</span> <span class="bound">I</span><span class="main">.</span> sum <span class="main">(</span>wt <span class="free">d</span> <span class="free">t</span><span class="main">)</span> <span class="main">(</span><span class="free">F</span> <span class="bound">I</span><span class="main">)</span><span class="main">)</span> <span class="skolem">S</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> sum.cong<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> S <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">unfolding</span></span> S_def <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">unfolding</span></span> mC_C_def mC_C_part_def mC_C_wt_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> sum <span class="main">(</span>wt <span class="free">d</span> <span class="free">t</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">UN</span> <span class="bound">I</span> <span class="main">:</span> <span class="skolem">S</span> <span class="main">.</span> <span class="free">F</span> <span class="bound">I</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> lift_def <span class="keyword1"><span class="command">using</span></span> S sum.UNION_disjoint<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">S</span></span> <span class="quoted"><span class="free">F</span></span> <span class="quoted"><span class="quoted">"wt <span class="free">d</span> <span class="free">t</span>"</span></span><span class="main">]</span> S SS SSS <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">UN</span> <span class="bound">I</span> <span class="main">:</span> <span class="skolem">S</span> <span class="main">.</span> <span class="free">F</span> <span class="bound">I</span><span class="main">)</span> <span class="main">=</span> lift <span class="free">P</span> <span class="free">F</span> <span class="skolem">II</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> lift_def S_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sum <span class="main">(</span>wt <span class="free">c</span> <span class="free">s</span><span class="main">)</span> <span class="skolem">II</span> <span class="main">=</span> sum <span class="main">(</span>wt <span class="free">d</span> <span class="free">t</span><span class="main">)</span> <span class="main">(</span>lift <span class="free">P</span> <span class="free">F</span> <span class="skolem">II</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"mC_C_eff_cont <span class="free">theta</span> <span class="free">c</span> <span class="free">d</span> <span class="free">s</span> <span class="free">t</span> <span class="free">Q</span> <span class="main">(</span>lift <span class="free">P</span> <span class="free">F</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> mC_C_eff_cont_def <span class="keyword1"><span class="command">proof</span></span> <span class="operator">clarify</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">II</span> <span class="skolem">i</span> <span class="skolem">j</span>
    <span class="keyword3"><span class="command">assume</span></span> II<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">II</span> <span class="main">∈</span> <span class="free">Q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="skolem">II</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∈</span> lift <span class="free">P</span> <span class="free">F</span> <span class="skolem">II</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">I</span></span> <span class="keyword2"><span class="keyword">where</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∈</span> <span class="free">F</span> <span class="skolem">I</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">I</span> <span class="main">∈</span> <span class="free">P</span> <span class="main">∧</span> <span class="skolem">I</span> <span class="main">⊆</span> <span class="skolem">II</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> lift_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">I</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">unfolding</span></span> mC_C_def mC_C_part_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i'</span></span> <span class="keyword2"><span class="keyword">where</span></span> i'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i'</span> <span class="main">∈</span> <span class="skolem">I</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"eff <span class="free">c</span> <span class="free">s</span> <span class="skolem">i'</span> <span class="main">≈</span> eff <span class="free">d</span> <span class="free">t</span> <span class="skolem">j</span> <span class="main">∧</span> <span class="main">(</span>cont <span class="free">c</span> <span class="free">s</span> <span class="skolem">i'</span><span class="main">,</span> cont <span class="free">d</span> <span class="free">t</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">∈</span> <span class="free">theta</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> * j I <span class="keyword1"><span class="command">unfolding</span></span> mC_C_def mC_C_eff_cont_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"eff <span class="free">c</span> <span class="free">s</span> <span class="skolem">i</span> <span class="main">≈</span> eff <span class="free">d</span> <span class="free">t</span> <span class="skolem">j</span> <span class="main">∧</span> <span class="main">(</span>cont <span class="free">c</span> <span class="free">s</span> <span class="skolem">i</span><span class="main">,</span> cont <span class="free">d</span> <span class="free">t</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">∈</span> <span class="free">theta</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">i'</span> <span class="main">=</span> <span class="skolem">i</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">unfolding</span></span> True <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i'</span> <span class="main">∈</span> <span class="skolem">II</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> I i' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eff <span class="free">c</span> <span class="free">s</span> <span class="skolem">i</span> <span class="main">≈</span> eff <span class="free">c</span> <span class="free">s</span> <span class="skolem">i'</span> <span class="main">∧</span> <span class="main">(</span>cont <span class="free">c</span> <span class="free">s</span> <span class="skolem">i</span><span class="main">,</span> cont <span class="free">c</span> <span class="free">s</span> <span class="skolem">i'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">theta</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> i II c <span class="keyword1"><span class="command">unfolding</span></span> partCompat_def compat_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 1 indis_trans theta <span class="keyword1"><span class="command">unfolding</span></span> trans_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Resumption_Based-mC_C_partCompat_eff"><span class="command">lemma</span></span> mC_C_partCompat_eff<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"mC_C <span class="free">theta</span> <span class="free">c</span> <span class="free">d</span> <span class="free">s</span> <span class="free">t</span> <span class="free">P</span> <span class="free">F</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"partCompat <span class="free">P</span> <span class="free">indis</span> <span class="main">(</span>eff <span class="free">c</span> <span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> partCompat_def compat_def <span class="keyword1"><span class="command">proof</span></span> <span class="operator">clarify</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">I</span> <span class="skolem">i</span> <span class="skolem">i'</span> <span class="keyword3"><span class="command">assume</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">I</span> <span class="main">∈</span> <span class="free">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ii'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">i'</span><span class="main">}</span> <span class="main">⊆</span> <span class="skolem">I</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≠</span> <span class="skolem">i'</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">F</span> <span class="skolem">I</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">unfolding</span></span> m_defsAll <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∈</span> <span class="free">F</span> <span class="skolem">I</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> ii' j I <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"eff <span class="free">c</span> <span class="free">s</span> <span class="skolem">i</span> <span class="main">≈</span> eff <span class="free">d</span> <span class="free">t</span> <span class="skolem">j</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">unfolding</span></span> m_defsAll <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> ii' j I <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"eff <span class="free">c</span> <span class="free">s</span> <span class="skolem">i'</span> <span class="main">≈</span> eff <span class="free">d</span> <span class="free">t</span> <span class="skolem">j</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">unfolding</span></span> m_defsAll <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> 1 2 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"eff <span class="free">c</span> <span class="free">s</span> <span class="skolem">i</span> <span class="main">≈</span> eff <span class="free">c</span> <span class="free">s</span> <span class="skolem">i'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> indis_trans indis_sym <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Resumption_Based-mC_C_partCompat_cont"><span class="command">lemma</span></span> mC_C_partCompat_cont<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"mC_C <span class="free">theta</span> <span class="free">c</span> <span class="free">d</span> <span class="free">s</span> <span class="free">t</span> <span class="free">P</span> <span class="free">F</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> theta<span class="main">:</span> <span class="quoted"><span class="quoted">"sym <span class="free">theta</span>"</span></span> <span class="quoted"><span class="quoted">"trans <span class="free">theta</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"partCompat <span class="free">P</span> <span class="free">theta</span> <span class="main">(</span>cont <span class="free">c</span> <span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> partCompat_def compat_def <span class="keyword1"><span class="command">proof</span></span> <span class="operator">clarify</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">I</span> <span class="skolem">i</span> <span class="skolem">i'</span> <span class="keyword3"><span class="command">assume</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">I</span> <span class="main">∈</span> <span class="free">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ii'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">i'</span><span class="main">}</span> <span class="main">⊆</span> <span class="skolem">I</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≠</span> <span class="skolem">i'</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">F</span> <span class="skolem">I</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">unfolding</span></span> m_defsAll <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∈</span> <span class="free">F</span> <span class="skolem">I</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> ii' j I <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>cont <span class="free">c</span> <span class="free">s</span> <span class="skolem">i</span><span class="main">,</span> cont <span class="free">d</span> <span class="free">t</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">∈</span> <span class="free">theta</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">unfolding</span></span> m_defsAll <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> ii' j I <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>cont <span class="free">c</span> <span class="free">s</span> <span class="skolem">i'</span><span class="main">,</span> cont <span class="free">d</span> <span class="free">t</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">∈</span> <span class="free">theta</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">unfolding</span></span> m_defsAll <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> 1 2 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>cont <span class="free">c</span> <span class="free">s</span> <span class="skolem">i</span><span class="main">,</span> cont <span class="free">c</span> <span class="free">s</span> <span class="skolem">i'</span><span class="main">)</span>  <span class="main">∈</span> <span class="free">theta</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> theta <span class="keyword1"><span class="command">unfolding</span></span> trans_def sym_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Resumption_Based-matchC_C_sym_trans"><span class="command">lemma</span></span> matchC_C_sym_trans<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"matchC_C <span class="free">theta</span> <span class="free">c1</span> <span class="free">c</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"matchC_C <span class="free">theta</span> <span class="free">c</span> <span class="free">c2</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> theta<span class="main">:</span> <span class="quoted"><span class="quoted">"sym <span class="free">theta</span>"</span></span> <span class="quoted"><span class="quoted">"trans <span class="free">theta</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"matchC_C <span class="free">theta</span> <span class="free">c1</span> <span class="free">c2</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> matchC_C_def <span class="keyword1"><span class="command">proof</span></span> <span class="operator">clarify</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s1</span> <span class="skolem">s2</span> <span class="keyword3"><span class="command">assume</span></span> s1s2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s1</span> <span class="main">≈</span> <span class="skolem">s2</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">=</span> <span class="skolem">s1</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">≈</span> <span class="skolem">s1</span> <span class="main">∧</span> <span class="skolem">s</span> <span class="main">≈</span> <span class="skolem">s2</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> s_def <span class="keyword1"><span class="command">using</span></span> s1s2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> th<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">theta</span> <span class="main">^-1</span> <span class="main">=</span> <span class="free">theta</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">theta</span> <span class="keyword1">O</span> <span class="free">theta</span> <span class="main">⊆</span> <span class="free">theta</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> theta
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> sym_conv_converse_eq trans_O_subset<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">hence</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"matchC_C <span class="free">theta</span> <span class="free">c</span> <span class="free">c1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> * matchC_C_sym<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> s * <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">P1</span></span> <span class="skolem"><span class="skolem">F1</span></span> <span class="keyword2"><span class="keyword">where</span></span> m1<span class="main">:</span> <span class="quoted"><span class="quoted">"mC_C <span class="free">theta</span> <span class="free">c</span> <span class="free">c1</span> <span class="skolem">s</span> <span class="skolem">s1</span> <span class="skolem">P1</span> <span class="skolem">F1</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> matchC_C_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> s ** <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">P2</span></span> <span class="skolem"><span class="skolem">F2</span></span> <span class="keyword2"><span class="keyword">where</span></span> m2<span class="main">:</span> <span class="quoted"><span class="quoted">"mC_C <span class="free">theta</span> <span class="free">c</span> <span class="free">c2</span> <span class="skolem">s</span> <span class="skolem">s2</span> <span class="skolem">P2</span> <span class="skolem">F2</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> matchC_C_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">P</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">=</span> partJoin <span class="skolem">P1</span> <span class="skolem">P2</span>"</span></span>
  <span class="comment1">(*  *)</span>
  <span class="keyword1"><span class="command">have</span></span> P<span class="main">:</span>
  <span class="quoted"><span class="quoted">"finer <span class="skolem">P1</span> <span class="skolem">P</span> <span class="main">∧</span> finer <span class="skolem">P2</span> <span class="skolem">P</span> <span class="main">∧</span>
   finite <span class="skolem">P</span> <span class="main">∧</span> <span class="main">{}</span> <span class="main">∉</span> <span class="skolem">P</span> <span class="main">∧</span> part <span class="main">{..&lt;</span> brn <span class="free">c</span><span class="main">}</span> <span class="skolem">P</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> m1 m2 finer_partJoin_L finite_partJoin emp_partJoin part_partJoin finite_part<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">{..&lt;</span> brn <span class="free">c</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="skolem">P</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">unfolding</span></span> P_def mC_C_def mC_C_part_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="comment1">(*  *)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mC_C <span class="free">theta</span> <span class="free">c</span> <span class="free">c1</span> <span class="skolem">s</span> <span class="skolem">s1</span> <span class="skolem">P</span> <span class="main">(</span>lift <span class="skolem">P1</span> <span class="skolem">F1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> mC_C_finer<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"partCompat <span class="skolem">P</span> <span class="free">indis</span> <span class="main">(</span>eff <span class="free">c</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> P_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> partCompat_partJoin<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> m1 m2 sym_indis trans_indis mC_C_partCompat_eff <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"partCompat <span class="skolem">P</span> <span class="free">theta</span> <span class="main">(</span>cont <span class="free">c</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> P_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> partCompat_partJoin<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> m1 m2 theta mC_C_partCompat_cont <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span><span class="main">(</span><span class="operator">insert</span> P m1 theta<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"mC_C <span class="free">theta</span> <span class="free">c1</span> <span class="free">c</span> <span class="skolem">s1</span> <span class="skolem">s</span> <span class="main">(</span>lift <span class="skolem">P1</span> <span class="skolem">F1</span> <span class="main">`</span> <span class="skolem">P</span><span class="main">)</span> <span class="main">(</span>inv_into <span class="skolem">P</span> <span class="main">(</span>lift <span class="skolem">P1</span> <span class="skolem">F1</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> mC_C_sym<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">theta</span></span> <span class="quoted"><span class="free">c</span></span> <span class="quoted"><span class="free">c1</span></span> <span class="quoted"><span class="skolem">s</span></span> <span class="quoted"><span class="skolem">s1</span></span> <span class="quoted"><span class="skolem">P</span></span> <span class="quoted"><span class="quoted">"lift <span class="skolem">P1</span> <span class="skolem">F1</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> th <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="comment1">(*  *)</span>
  <span class="keyword1"><span class="command">have</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"mC_C <span class="free">theta</span> <span class="free">c</span> <span class="free">c2</span> <span class="skolem">s</span> <span class="skolem">s2</span> <span class="skolem">P</span> <span class="main">(</span>lift <span class="skolem">P2</span> <span class="skolem">F2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> mC_C_finer<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"partCompat <span class="skolem">P</span> <span class="free">indis</span> <span class="main">(</span>eff <span class="free">c</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> P_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> partCompat_partJoin<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> m1 m2 sym_indis trans_indis mC_C_partCompat_eff <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"partCompat <span class="skolem">P</span> <span class="free">theta</span> <span class="main">(</span>cont <span class="free">c</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> P_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> partCompat_partJoin<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> m1 m2 theta mC_C_partCompat_cont <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span><span class="main">(</span><span class="operator">insert</span> P m2 theta<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="comment1">(*  *)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="main">(</span>lift <span class="skolem">P1</span> <span class="skolem">F1</span><span class="main">)</span> <span class="skolem">P</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> inj_on_lift<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> m1 m2 P <span class="keyword1"><span class="command">unfolding</span></span> m_defsAll <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"inv_into <span class="skolem">P</span> <span class="main">(</span>lift <span class="skolem">P1</span> <span class="skolem">F1</span><span class="main">)</span> <span class="main">`</span> lift <span class="skolem">P1</span> <span class="skolem">F1</span> <span class="main">`</span> <span class="skolem">P</span> <span class="main">=</span> <span class="skolem">P</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> inj_on_inv_into<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"mC_C <span class="main">(</span><span class="free">theta</span> <span class="keyword1">O</span> <span class="free">theta</span><span class="main">)</span> <span class="free">c1</span> <span class="free">c2</span> <span class="skolem">s1</span> <span class="skolem">s2</span> <span class="main">(</span>lift <span class="skolem">P1</span> <span class="skolem">F1</span> <span class="main">`</span> <span class="skolem">P</span><span class="main">)</span> <span class="main">(</span>lift <span class="skolem">P2</span> <span class="skolem">F2</span> <span class="keyword1">o</span> <span class="main">(</span>inv_into <span class="skolem">P</span> <span class="main">(</span>lift <span class="skolem">P1</span> <span class="skolem">F1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> mC_C_trans<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">theta</span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">c1</span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">c</span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">s1</span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">s</span></span></span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">theta</span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">c2</span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">s2</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> A B <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"mC_C <span class="free">theta</span> <span class="free">c1</span> <span class="free">c2</span> <span class="skolem">s1</span> <span class="skolem">s2</span> <span class="main">(</span>lift <span class="skolem">P1</span> <span class="skolem">F1</span> <span class="main">`</span> <span class="skolem">P</span><span class="main">)</span> <span class="main">(</span>lift <span class="skolem">P2</span> <span class="skolem">F2</span> <span class="keyword1">o</span> <span class="main">(</span>inv_into <span class="skolem">P</span> <span class="main">(</span>lift <span class="skolem">P1</span> <span class="skolem">F1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> th mC_C_mono <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">R</span> <span class="bound">H</span><span class="main">.</span> mC_C <span class="free">theta</span> <span class="free">c1</span> <span class="free">c2</span> <span class="skolem">s1</span> <span class="skolem">s2</span> <span class="bound">R</span> <span class="bound">H</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Resumption_Based-Sretr_sym_trans"><span class="command">lemma</span></span> Sretr_sym_trans<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"sym <span class="free">theta</span> <span class="main">∧</span> trans <span class="free">theta</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"trans <span class="main">(</span>Sretr <span class="free">theta</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> trans_def <span class="keyword1"><span class="command">proof</span></span> <span class="operator">clarify</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">c</span> <span class="skolem">d</span> <span class="skolem">e</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">c</span><span class="main">,</span> <span class="skolem">d</span><span class="main">)</span> <span class="main">∈</span> Sretr <span class="free">theta</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">d</span><span class="main">,</span> <span class="skolem">e</span><span class="main">)</span> <span class="main">∈</span> Sretr <span class="free">theta</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">c</span><span class="main">,</span> <span class="skolem">e</span><span class="main">)</span> <span class="main">∈</span> Sretr <span class="free">theta</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Sretr_def <span class="keyword1"><span class="command">using</span></span> assms matchC_C_sym_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Resumption_Based-trans_Sbis"><span class="command">lemma</span></span> trans_Sbis<span class="main">:</span> <span class="quoted"><span class="quoted">"trans Sbis"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Sbis_def Sretr_sym Sretr_sym_trans mono_Retr sym_trans_gfp<span class="main">)</span>

<span class="keyword1" id="Resumption_Based-Sbis_trans"><span class="command">lemma</span></span> Sbis_trans<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">c</span> <span class="keyword1">≈s</span> <span class="free">d</span><span class="main">;</span> <span class="free">d</span> <span class="keyword1">≈s</span> <span class="free">e</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">c</span> <span class="keyword1">≈s</span> <span class="free">e</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> trans_Sbis <span class="keyword1"><span class="command">unfolding</span></span> trans_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>


<span class="comment1">(* ZObis: *)</span>

<span class="keyword1" id="Resumption_Based-ZObis_prefix"><span class="command">lemma</span></span> ZObis_prefix<span class="main">:</span>
<span class="quoted"><span class="quoted">"ZObis <span class="main">≤</span> ZOretr ZObis"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> ZObis_def
<span class="keyword1"><span class="command">using</span></span> def_gfp_unfold mono_Retr<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Resumption_Based-ZObis_fix"><span class="command">lemma</span></span> ZObis_fix<span class="main">:</span>
<span class="quoted"><span class="quoted">"ZOretr ZObis <span class="main">=</span> ZObis"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> ZObis_def
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> def_gfp_unfold mono_Retr<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1" id="Resumption_Based-ZObis_mC_ZOC"><span class="command">lemma</span></span> ZObis_mC_ZOC<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">≈01</span> <span class="free">d</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">≈</span> <span class="free">t</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">I0</span>  <span class="bound">P</span> <span class="bound">F</span><span class="main">.</span> mC_ZOC ZObis <span class="free">c</span> <span class="free">d</span> <span class="free">s</span> <span class="free">t</span> <span class="bound">I0</span> <span class="bound">P</span> <span class="bound">F</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms ZObis_prefix <span class="keyword1"><span class="command">unfolding</span></span> ZOretr_def matchC_LC_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Resumption_Based-ZObis_coind"><span class="command">lemma</span></span> ZObis_coind<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">theta</span> <span class="main">≤</span> ZOretr <span class="main">(</span><span class="free">theta</span> <span class="keyword1">Un</span> ZObis<span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">theta</span> <span class="main">≤</span> ZObis"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> ZObis_def
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> ZObis_def assms def_coinduct mono_Retr<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1" id="Resumption_Based-ZObis_raw_coind"><span class="command">lemma</span></span> ZObis_raw_coind<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">theta</span> <span class="main">≤</span> ZOretr <span class="free">theta</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">theta</span> <span class="main">≤</span> ZObis"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ZOretr <span class="free">theta</span> <span class="main">⊆</span> ZOretr <span class="main">(</span><span class="free">theta</span> <span class="keyword1">Un</span> ZObis<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Un_upper1 monoD mono_Retr<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">theta</span> <span class="main">⊆</span> ZOretr <span class="main">(</span><span class="free">theta</span> <span class="keyword1">Un</span> ZObis<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> ZObis_coind <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* Symmetry *)</span>

<span class="keyword1" id="Resumption_Based-mC_ZOC_sym"><span class="command">lemma</span></span> mC_ZOC_sym<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> theta<span class="main">:</span> <span class="quoted"><span class="quoted">"sym <span class="free">theta</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"mC_ZOC <span class="free">theta</span> <span class="free">c</span> <span class="free">d</span> <span class="free">s</span> <span class="free">t</span> <span class="free">I0</span> <span class="free">P</span> <span class="free">F</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mC_ZOC <span class="free">theta</span> <span class="free">d</span> <span class="free">c</span> <span class="free">t</span> <span class="free">s</span> <span class="main">(</span><span class="free">F</span> <span class="free">I0</span><span class="main">)</span> <span class="main">(</span><span class="free">F</span> <span class="main">`</span> <span class="free">P</span><span class="main">)</span> <span class="main">(</span>inv_into <span class="free">P</span> <span class="free">F</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> mC_ZOC_def <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"mC_ZOC_part <span class="free">d</span> <span class="free">c</span> <span class="free">t</span> <span class="free">s</span> <span class="main">(</span><span class="free">F</span> <span class="free">I0</span><span class="main">)</span> <span class="main">(</span><span class="free">F</span> <span class="main">`</span> <span class="free">P</span><span class="main">)</span> <span class="main">(</span>inv_into <span class="free">P</span> <span class="free">F</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> mC_ZOC_part_def <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"inj_on <span class="free">F</span> <span class="free">P</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">I0</span> <span class="main">∈</span> <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">unfolding</span></span> mC_ZOC_def mC_ZOC_part_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inv_into <span class="free">P</span> <span class="free">F</span> <span class="main">`</span> <span class="main">(</span><span class="free">F</span> <span class="main">`</span> <span class="free">P</span> <span class="main">-</span> <span class="main">{</span><span class="free">F</span> <span class="free">I0</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> inv_into <span class="free">P</span> <span class="free">F</span> <span class="main">`</span> <span class="main">(</span><span class="free">F</span> <span class="main">`</span> <span class="main">(</span><span class="free">P</span> <span class="main">-</span> <span class="main">{</span><span class="free">I0</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> 0 inj_on_image_set_diff<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">F</span></span> <span class="quoted"><span class="free">P</span></span> <span class="quoted"><span class="free">P</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">I0</span><span class="main">}</span>"</span></span><span class="main">,</span> <span class="operator">OF</span> _ Set.Diff_subset<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="free">P</span> <span class="main">-</span> <span class="main">{</span><span class="free">I0</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 0 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Diff_subset inv_into_image_cancel<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inv_into <span class="free">P</span> <span class="free">F</span> <span class="main">`</span> <span class="main">(</span><span class="free">F</span> <span class="main">`</span> <span class="free">P</span> <span class="main">-</span> <span class="main">{</span><span class="free">F</span> <span class="free">I0</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="free">P</span> <span class="main">-</span> <span class="main">{</span><span class="free">I0</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">{}</span> <span class="main">∉</span> inv_into <span class="free">P</span> <span class="free">F</span> <span class="main">`</span> <span class="main">(</span><span class="free">F</span> <span class="main">`</span> <span class="free">P</span> <span class="main">-</span> <span class="main">{</span><span class="free">F</span> <span class="free">I0</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">unfolding</span></span> mC_ZOC_def mC_ZOC_part_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="comment1">(*  *)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"part <span class="main">{..&lt;</span>brn <span class="free">c</span><span class="main">}</span> <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">unfolding</span></span> mC_ZOC_def mC_ZOC_part_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"part <span class="main">{..&lt;</span>brn <span class="free">c</span><span class="main">}</span> <span class="main">(</span>inv_into <span class="free">P</span> <span class="free">F</span> <span class="main">`</span> <span class="free">F</span> <span class="main">`</span> <span class="free">P</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span><span class="main">(</span><span class="operator">insert</span> *<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> mC_ZOC_def mC_ZOC_part_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword1"><span class="command">have</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"inj_on <span class="free">F</span> <span class="free">P</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">I0</span> <span class="main">∈</span> <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">unfolding</span></span> mC_ZOC_def mC_ZOC_part_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"mC_ZOC_wt <span class="free">d</span> <span class="free">c</span> <span class="free">t</span> <span class="free">s</span> <span class="main">(</span><span class="free">F</span> <span class="free">I0</span><span class="main">)</span> <span class="main">(</span><span class="free">F</span> <span class="main">`</span> <span class="free">P</span><span class="main">)</span> <span class="main">(</span>inv_into <span class="free">P</span> <span class="free">F</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> mC_ZOC_wt_def <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">intro</span> conjI ballI impI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">J</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">J</span> <span class="main">∈</span> <span class="free">F</span> <span class="main">`</span> <span class="free">P</span> <span class="main">-</span> <span class="main">{</span><span class="free">F</span> <span class="free">I0</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> le_1<span class="main">:</span> <span class="quoted"><span class="quoted">"sum <span class="main">(</span>wt <span class="free">d</span> <span class="free">t</span><span class="main">)</span> <span class="main">(</span><span class="free">F</span> <span class="free">I0</span><span class="main">)</span> <span class="main">&lt;</span> <span class="main">1</span> <span class="main">∧</span> sum <span class="main">(</span>wt <span class="free">c</span> <span class="free">s</span><span class="main">)</span> <span class="main">(</span>inv_into <span class="free">P</span> <span class="free">F</span> <span class="main">(</span><span class="free">F</span> <span class="free">I0</span><span class="main">)</span><span class="main">)</span> <span class="main">&lt;</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">I</span></span> <span class="keyword2"><span class="keyword">where</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">I</span> <span class="main">∈</span> <span class="free">P</span> <span class="main">-</span> <span class="main">{</span><span class="free">I0</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> J<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">J</span> <span class="main">=</span> <span class="free">F</span> <span class="skolem">I</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> image_iff member_remove remove_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"inv_into <span class="free">P</span> <span class="free">F</span> <span class="skolem">J</span> <span class="main">=</span> <span class="skolem">I</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> J <span class="keyword1"><span class="command">using</span></span> 0 I <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"inv_into <span class="free">P</span> <span class="free">F</span> <span class="main">(</span><span class="free">F</span> <span class="free">I0</span><span class="main">)</span> <span class="main">=</span> <span class="free">I0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span>
    <span class="quoted"><span class="quoted">"sum <span class="main">(</span>wt <span class="free">d</span> <span class="free">t</span><span class="main">)</span> <span class="skolem">J</span> <span class="main">/</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> sum <span class="main">(</span>wt <span class="free">d</span> <span class="free">t</span><span class="main">)</span> <span class="main">(</span><span class="free">F</span> <span class="free">I0</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
     sum <span class="main">(</span>wt <span class="free">c</span> <span class="free">s</span><span class="main">)</span> <span class="main">(</span>inv_into <span class="free">P</span> <span class="free">F</span> <span class="skolem">J</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> sum <span class="main">(</span>wt <span class="free">c</span> <span class="free">s</span><span class="main">)</span> <span class="main">(</span>inv_into <span class="free">P</span> <span class="free">F</span> <span class="main">(</span><span class="free">F</span> <span class="free">I0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> 2 3 <span class="keyword1"><span class="command">unfolding</span></span> J
    <span class="keyword1"><span class="command">using</span></span> * I le_1 <span class="keyword1"><span class="command">unfolding</span></span> mC_ZOC_def mC_ZOC_wt_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> 3 J<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"mC_ZOC_eff_cont <span class="free">theta</span> <span class="free">d</span> <span class="free">c</span> <span class="free">t</span> <span class="free">s</span> <span class="main">(</span><span class="free">F</span> <span class="free">I0</span><span class="main">)</span> <span class="main">(</span><span class="free">F</span> <span class="main">`</span> <span class="free">P</span><span class="main">)</span> <span class="main">(</span>inv_into <span class="free">P</span> <span class="free">F</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> mC_ZOC_eff_cont_def <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">intro</span> allI impI<span class="main"><span class="keyword3">,</span></span> <span class="operator">elim</span> conjE<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="skolem">j</span> <span class="skolem">J</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">J</span> <span class="main">∈</span> <span class="free">F</span> <span class="main">`</span> <span class="free">P</span> <span class="main">-</span> <span class="main">{</span><span class="free">F</span> <span class="free">I0</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∈</span> <span class="skolem">J</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> inv_into <span class="free">P</span> <span class="free">F</span> <span class="skolem">J</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">I</span></span> <span class="keyword2"><span class="keyword">where</span></span> J<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">J</span> <span class="main">=</span> <span class="free">F</span> <span class="skolem">I</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">I</span> <span class="main">∈</span> <span class="free">P</span> <span class="main">-</span> <span class="main">{</span><span class="free">I0</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> image_iff member_remove remove_def<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="skolem">I</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms i <span class="keyword1"><span class="command">unfolding</span></span> mC_ZOC_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"eff <span class="free">c</span> <span class="free">s</span> <span class="skolem">i</span> <span class="main">≈</span> eff <span class="free">d</span> <span class="free">t</span> <span class="skolem">j</span> <span class="main">∧</span> <span class="main">(</span>cont <span class="free">c</span> <span class="free">s</span> <span class="skolem">i</span><span class="main">,</span> cont <span class="free">d</span> <span class="free">t</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">∈</span> <span class="free">theta</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms I j <span class="keyword1"><span class="command">unfolding</span></span> mC_ZOC_def mC_ZOC_eff_cont_def J <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"eff <span class="free">d</span> <span class="free">t</span> <span class="skolem">j</span> <span class="main">≈</span> eff <span class="free">c</span> <span class="free">s</span> <span class="skolem">i</span> <span class="main">∧</span> <span class="main">(</span>cont <span class="free">d</span> <span class="free">t</span> <span class="skolem">j</span><span class="main">,</span> cont <span class="free">c</span> <span class="free">s</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">∈</span> <span class="free">theta</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms indis_sym sym_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span><span class="main">(</span><span class="operator">insert</span> assms<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> sym_def m_defsAll<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Resumption_Based-matchC_LC_sym"><span class="command">lemma</span></span> matchC_LC_sym<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"sym <span class="free">theta</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"matchC_LC <span class="free">theta</span> <span class="free">c</span> <span class="free">d</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"matchC_LC <span class="free">theta</span> <span class="free">d</span> <span class="free">c</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> matchC_LC_def <span class="keyword1"><span class="command">proof</span></span> <span class="operator">clarify</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span> <span class="skolem">s</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">≈</span> <span class="skolem">s</span>"</span></span>  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">≈</span> <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> indis_sym<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">I0</span></span> <span class="skolem"><span class="skolem">P</span></span> <span class="skolem"><span class="skolem">F</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"mC_ZOC <span class="free">theta</span> <span class="free">c</span> <span class="free">d</span> <span class="skolem">s</span> <span class="skolem">t</span> <span class="skolem">I0</span> <span class="skolem">P</span> <span class="skolem">F</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> matchC_LC_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"mC_ZOC <span class="free">theta</span> <span class="free">d</span> <span class="free">c</span> <span class="skolem">t</span> <span class="skolem">s</span> <span class="main">(</span><span class="skolem">F</span> <span class="skolem">I0</span><span class="main">)</span> <span class="main">(</span><span class="skolem">F</span> <span class="main">`</span> <span class="skolem">P</span><span class="main">)</span> <span class="main">(</span>inv_into <span class="skolem">P</span> <span class="skolem">F</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> mC_ZOC_sym * <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">I0</span> <span class="bound">Q</span> <span class="bound">G</span><span class="main">.</span> mC_ZOC <span class="free">theta</span> <span class="free">d</span> <span class="free">c</span> <span class="skolem">t</span> <span class="skolem">s</span> <span class="bound">I0</span> <span class="bound">Q</span> <span class="bound">G</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Resumption_Based-ZOretr_sym"><span class="command">lemma</span></span> ZOretr_sym<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"sym <span class="free">theta</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sym <span class="main">(</span>ZOretr <span class="free">theta</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> sym_def <span class="keyword1"><span class="command">proof</span></span> <span class="operator">clarify</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">c</span> <span class="skolem">d</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">c</span><span class="main">,</span> <span class="skolem">d</span><span class="main">)</span> <span class="main">∈</span> ZOretr <span class="free">theta</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">d</span><span class="main">,</span> <span class="skolem">c</span><span class="main">)</span> <span class="main">∈</span> ZOretr <span class="free">theta</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> ZOretr_def <span class="keyword1"><span class="command">using</span></span> assms matchC_LC_sym <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">d</span><span class="main">,</span> <span class="skolem">c</span><span class="main">)</span> <span class="main">∈</span> ZOretr <span class="free">theta</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> sym_conv_converse_eq<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Resumption_Based-sym_ZObis"><span class="command">lemma</span></span> sym_ZObis<span class="main">:</span> <span class="quoted"><span class="quoted">"sym ZObis"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> ZObis_def ZOretr_sym mono_Retr sym_gfp<span class="main">)</span>

<span class="keyword1" id="Resumption_Based-ZObis_sym"><span class="command">lemma</span></span> ZObis_sym<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">≈01</span> <span class="free">d</span> <span class="main">⟹</span> <span class="free">d</span> <span class="main">≈01</span> <span class="free">c</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> sym_ZObis <span class="keyword1"><span class="command">unfolding</span></span> sym_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹List versions of the bisimilarities›</span></span>

<span class="comment1">(* For Sbis: *)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">SbisL</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">SbisL</span> <span class="free"><span class="bound"><span class="entity">cl</span></span></span> <span class="free"><span class="bound"><span class="entity">dl</span></span></span> <span class="main">≡</span>
 length <span class="free"><span class="bound"><span class="entity">cl</span></span></span> <span class="main">=</span> length <span class="free"><span class="bound"><span class="entity">dl</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound"><span class="bound">n</span></span> <span class="main">&lt;</span> length <span class="free"><span class="bound"><span class="entity">cl</span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">cl</span></span></span> <span class="main">!</span> <span class="bound">n</span> <span class="keyword1">≈s</span> <span class="free"><span class="bound"><span class="entity">dl</span></span></span> <span class="main">!</span> <span class="bound">n</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Resumption_Based-SbisL_intro"><span class="command">lemma</span></span> SbisL_intro<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"length <span class="free">cl</span> <span class="main">=</span> length <span class="free">dl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
<span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">n</span><span class="main">.</span> <span class="main">⟦</span><span class="bound">n</span> <span class="main">&lt;</span> length <span class="free">cl</span><span class="main">;</span> <span class="bound">n</span> <span class="main">&lt;</span> length <span class="free">dl</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">cl</span> <span class="main">!</span> <span class="bound">n</span> <span class="keyword1">≈s</span> <span class="free">dl</span> <span class="main">!</span> <span class="bound">n</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"SbisL <span class="free">cl</span> <span class="free">dl</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> SbisL_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Resumption_Based-SbisL_length"><span class="command">lemma</span></span> SbisL_length<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"SbisL <span class="free">cl</span> <span class="free">dl</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"length <span class="free">cl</span> <span class="main">=</span> length <span class="free">dl</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> SbisL_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Resumption_Based-SbisL_Sbis"><span class="command">lemma</span></span> SbisL_Sbis<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"SbisL <span class="free">cl</span> <span class="free">dl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&lt;</span> length <span class="free">cl</span> <span class="main">∨</span> <span class="free">n</span> <span class="main">&lt;</span> length <span class="free">dl</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">cl</span> <span class="main">!</span> <span class="free">n</span> <span class="keyword1">≈s</span> <span class="free">dl</span> <span class="main">!</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> SbisL_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Resumption_Based-SbisL_update"><span class="command">lemma</span></span> SbisL_update<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> cldl<span class="main">:</span> <span class="quoted"><span class="quoted">"SbisL <span class="free">cl</span> <span class="free">dl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> c'd'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c'</span> <span class="keyword1">≈s</span> <span class="free">d'</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"SbisL <span class="main">(</span><span class="free">cl</span> <span class="main">[</span><span class="free">n</span> <span class="main">:=</span> <span class="free">c'</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span><span class="free">dl</span> <span class="main">[</span><span class="free">n</span> <span class="main">:=</span> <span class="free">d'</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"SbisL <span class="var">?cl'</span> <span class="var">?dl'</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&lt;</span> length <span class="free">cl</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">m</span> <span class="keyword3"><span class="command">assume</span></span> m<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">&lt;</span> length <span class="var">?cl'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">&lt;</span> length <span class="var">?dl'</span>"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="var">?cl'</span> <span class="main">!</span> <span class="skolem">m</span> <span class="keyword1">≈s</span> <span class="var">?dl'</span> <span class="main">!</span> <span class="skolem">m</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">=</span> <span class="free">n</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> cldl<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> cldl<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="Resumption_Based-SbisL_update_L"><span class="command">lemma</span></span> SbisL_update_L<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"SbisL <span class="free">cl</span> <span class="free">dl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">c'</span> <span class="keyword1">≈s</span> <span class="free">dl</span><span class="main">!</span><span class="free">n</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"SbisL <span class="main">(</span><span class="free">cl</span><span class="main">[</span><span class="free">n</span> <span class="main">:=</span> <span class="free">c'</span><span class="main">]</span><span class="main">)</span> <span class="free">dl</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?d'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">dl</span><span class="main">!</span><span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"SbisL <span class="main">(</span><span class="free">cl</span><span class="main">[</span><span class="free">n</span> <span class="main">:=</span> <span class="free">c'</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span><span class="free">dl</span><span class="main">[</span><span class="free">n</span> <span class="main">:=</span> <span class="var">?d'</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> SbisL_update<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Resumption_Based-SbisL_update_R"><span class="command">lemma</span></span> SbisL_update_R<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"SbisL <span class="free">cl</span> <span class="free">dl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">cl</span><span class="main">!</span><span class="free">n</span> <span class="keyword1">≈s</span> <span class="free">d'</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"SbisL <span class="free">cl</span> <span class="main">(</span><span class="free">dl</span><span class="main">[</span><span class="free">n</span> <span class="main">:=</span> <span class="free">d'</span><span class="main">]</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?c'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">cl</span><span class="main">!</span><span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"SbisL <span class="main">(</span><span class="free">cl</span><span class="main">[</span><span class="free">n</span> <span class="main">:=</span> <span class="var">?c'</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span><span class="free">dl</span><span class="main">[</span><span class="free">n</span> <span class="main">:=</span> <span class="free">d'</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> SbisL_update<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* For ZObis: *)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ZObisL</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">ZObisL</span> <span class="free"><span class="bound"><span class="entity">cl</span></span></span> <span class="free"><span class="bound"><span class="entity">dl</span></span></span> <span class="main">≡</span>
 length <span class="free"><span class="bound"><span class="entity">cl</span></span></span> <span class="main">=</span> length <span class="free"><span class="bound"><span class="entity">dl</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound"><span class="bound">n</span></span> <span class="main">&lt;</span> length <span class="free"><span class="bound"><span class="entity">cl</span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">cl</span></span></span> <span class="main">!</span> <span class="bound">n</span> <span class="main">≈01</span> <span class="free"><span class="bound"><span class="entity">dl</span></span></span> <span class="main">!</span> <span class="bound">n</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Resumption_Based-ZObisL_intro"><span class="command">lemma</span></span> ZObisL_intro<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"length <span class="free">cl</span> <span class="main">=</span> length <span class="free">dl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
<span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">n</span><span class="main">.</span> <span class="main">⟦</span><span class="bound">n</span> <span class="main">&lt;</span> length <span class="free">cl</span><span class="main">;</span> <span class="bound">n</span> <span class="main">&lt;</span> length <span class="free">dl</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">cl</span> <span class="main">!</span> <span class="bound">n</span> <span class="main">≈01</span> <span class="free">dl</span> <span class="main">!</span> <span class="bound">n</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ZObisL <span class="free">cl</span> <span class="free">dl</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> ZObisL_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Resumption_Based-ZObisL_length"><span class="command">lemma</span></span> ZObisL_length<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"ZObisL <span class="free">cl</span> <span class="free">dl</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"length <span class="free">cl</span> <span class="main">=</span> length <span class="free">dl</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> ZObisL_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Resumption_Based-ZObisL_ZObis"><span class="command">lemma</span></span> ZObisL_ZObis<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"ZObisL <span class="free">cl</span> <span class="free">dl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&lt;</span> length <span class="free">cl</span> <span class="main">∨</span> <span class="free">n</span> <span class="main">&lt;</span> length <span class="free">dl</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">cl</span> <span class="main">!</span> <span class="free">n</span> <span class="main">≈01</span> <span class="free">dl</span> <span class="main">!</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> ZObisL_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Resumption_Based-ZObisL_update"><span class="command">lemma</span></span> ZObisL_update<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> cldl<span class="main">:</span> <span class="quoted"><span class="quoted">"ZObisL <span class="free">cl</span> <span class="free">dl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> c'd'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c'</span> <span class="main">≈01</span> <span class="free">d'</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ZObisL <span class="main">(</span><span class="free">cl</span> <span class="main">[</span><span class="free">n</span> <span class="main">:=</span> <span class="free">c'</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span><span class="free">dl</span> <span class="main">[</span><span class="free">n</span> <span class="main">:=</span> <span class="free">d'</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"ZObisL <span class="var">?cl'</span> <span class="var">?dl'</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&lt;</span> length <span class="free">cl</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">m</span> <span class="keyword3"><span class="command">assume</span></span> m<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">&lt;</span> length <span class="var">?cl'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">&lt;</span> length <span class="var">?dl'</span>"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="var">?cl'</span> <span class="main">!</span> <span class="skolem">m</span> <span class="main">≈01</span> <span class="var">?dl'</span> <span class="main">!</span> <span class="skolem">m</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">=</span> <span class="free">n</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> cldl<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> cldl<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="Resumption_Based-ZObisL_update_L"><span class="command">lemma</span></span> ZObisL_update_L<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"ZObisL <span class="free">cl</span> <span class="free">dl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">c'</span> <span class="main">≈01</span> <span class="free">dl</span><span class="main">!</span><span class="free">n</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ZObisL <span class="main">(</span><span class="free">cl</span><span class="main">[</span><span class="free">n</span> <span class="main">:=</span> <span class="free">c'</span><span class="main">]</span><span class="main">)</span> <span class="free">dl</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?d'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">dl</span><span class="main">!</span><span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ZObisL <span class="main">(</span><span class="free">cl</span><span class="main">[</span><span class="free">n</span> <span class="main">:=</span> <span class="free">c'</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span><span class="free">dl</span><span class="main">[</span><span class="free">n</span> <span class="main">:=</span> <span class="var">?d'</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ZObisL_update<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Resumption_Based-ZObisL_update_R"><span class="command">lemma</span></span> ZObisL_update_R<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"ZObisL <span class="free">cl</span> <span class="free">dl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">cl</span><span class="main">!</span><span class="free">n</span> <span class="main">≈01</span> <span class="free">d'</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ZObisL <span class="free">cl</span> <span class="main">(</span><span class="free">dl</span><span class="main">[</span><span class="free">n</span> <span class="main">:=</span> <span class="free">d'</span><span class="main">]</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?c'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">cl</span><span class="main">!</span><span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ZObisL <span class="main">(</span><span class="free">cl</span><span class="main">[</span><span class="free">n</span> <span class="main">:=</span> <span class="var">?c'</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span><span class="free">dl</span><span class="main">[</span><span class="free">n</span> <span class="main">:=</span> <span class="free">d'</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ZObisL_update<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Discreetness for configurations›</span></span>

<span class="keyword1"><span class="command">coinductive</span></span> <span class="entity">discrCf</span> <span class="keyword2"><span class="keyword">where</span></span>
intro<span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> brn <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">cf</span></span></span><span class="main">)</span> <span class="main">⟶</span>
       snd <span class="free"><span class="bound"><span class="entity">cf</span></span></span> <span class="main">≈</span> snd <span class="main">(</span>cont_eff <span class="free"><span class="bound"><span class="entity">cf</span></span></span> <span class="bound">i</span><span class="main">)</span> <span class="main">∧</span> <span class="free">discrCf</span> <span class="main">(</span>cont_eff <span class="free"><span class="bound"><span class="entity">cf</span></span></span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>
 <span class="main">⟹</span> <span class="free">discrCf</span> <span class="free"><span class="bound"><span class="entity">cf</span></span></span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Coinduction for discrness:›</span></span>

<span class="keyword1" id="Resumption_Based-discrCf_coind"><span class="command">lemma</span></span> discrCf_coind<span class="main">[</span><span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">case_names</span> Hyp<span class="main">,</span> <span class="operator">induct</span> <span class="quasi_keyword"><span class="quasi_keyword">pred</span></span><span class="main"><span class="main"><span class="main">:</span></span></span> discr<span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">phi</span> <span class="free">cf</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
**<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">cf</span> <span class="bound">i</span><span class="main">.</span>
       <span class="main">⟦</span><span class="bound">i</span> <span class="main">&lt;</span> brn <span class="main">(</span>fst <span class="bound">cf</span><span class="main">)</span><span class="main">;</span> <span class="free">phi</span> <span class="bound">cf</span><span class="main">⟧</span> <span class="main">⟹</span>
        snd <span class="bound">cf</span> <span class="main">≈</span> snd <span class="main">(</span>cont_eff <span class="bound">cf</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="free">phi</span> <span class="main">(</span>cont_eff <span class="bound">cf</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∨</span> discrCf <span class="main">(</span>cont_eff <span class="bound">cf</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"discrCf <span class="free">cf</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> discrCf.coinduct<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> ** <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Resumption_Based-discrCf_raw_coind"><span class="command">lemma</span></span> discrCf_raw_coind<span class="main">[</span><span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">case_names</span> Hyp<span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">phi</span> <span class="free">cf</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
**<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">cf</span> <span class="bound">i</span><span class="main">.</span> <span class="main">⟦</span><span class="bound">i</span> <span class="main">&lt;</span> brn <span class="main">(</span>fst <span class="bound">cf</span><span class="main">)</span><span class="main">;</span> <span class="free">phi</span> <span class="bound">cf</span><span class="main">⟧</span> <span class="main">⟹</span>
              snd <span class="bound">cf</span> <span class="main">≈</span> snd <span class="main">(</span>cont_eff <span class="bound">cf</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∧</span> <span class="free">phi</span> <span class="main">(</span>cont_eff <span class="bound">cf</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"discrCf <span class="free">cf</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induct</span><span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> ** <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Discreetness versus transition:›</span></span>

<span class="keyword1" id="Resumption_Based-discrCf_cont"><span class="command">lemma</span></span> discrCf_cont<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"discrCf <span class="free">cf</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> brn <span class="main">(</span>fst <span class="free">cf</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"discrCf <span class="main">(</span>cont_eff <span class="free">cf</span> <span class="free">i</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> discrCf.cases<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> ** <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Resumption_Based-discrCf_eff_indis"><span class="command">lemma</span></span> discrCf_eff_indis<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"discrCf <span class="free">cf</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> brn <span class="main">(</span>fst <span class="free">cf</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"snd <span class="free">cf</span> <span class="main">≈</span> snd <span class="main">(</span>cont_eff <span class="free">cf</span> <span class="free">i</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> discrCf.cases<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> ** <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Resumption_Based-discr_discrCf"><span class="command">lemma</span></span> discr_discrCf<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"discr <span class="free">c</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"discrCf <span class="main">(</span><span class="free">c</span><span class="main">,</span> <span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">fix</span></span> <span class="skolem">cf</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'test</span><span class="main">,</span> <span class="tfree">'atom</span><span class="main">,</span> <span class="tfree">'choice</span><span class="main">)</span> cmd <span class="main">×</span> <span class="tfree">'state</span>"</span></span>
   <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"discr <span class="main">(</span>fst <span class="skolem">cf</span><span class="main">)</span>"</span></span>
   <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"discrCf <span class="skolem">cf</span>"</span></span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span><span class="main">)</span>
   <span class="keyword1"><span class="command">using</span></span> discr_eff_indis discr_cont <span class="keyword1"><span class="command">unfolding</span></span> eff_def cont_def cont_eff_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Resumption_Based-ZObis_pres_discrCfL"><span class="command">lemma</span></span> ZObis_pres_discrCfL<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"fst <span class="free">cf</span> <span class="main">≈01</span> fst <span class="free">df</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"snd <span class="free">cf</span> <span class="main">≈</span> snd <span class="free">df</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"discrCf <span class="free">df</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"discrCf <span class="free">cf</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">df</span><span class="main">.</span> fst <span class="free">cf</span> <span class="main">≈01</span> fst <span class="bound">df</span> <span class="main">∧</span> snd <span class="free">cf</span> <span class="main">≈</span> snd <span class="bound">df</span> <span class="main">∧</span> discrCf <span class="bound">df</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> discrCf_raw_coind<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Hyp <span class="skolem">cf</span> <span class="skolem">i</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">df</span></span> <span class="keyword2"><span class="keyword">where</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> brn <span class="main">(</span>fst <span class="skolem">cf</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    df<span class="main">:</span> <span class="quoted"><span class="quoted">"discrCf <span class="skolem">df</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> cf_df<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="skolem">cf</span> <span class="main">≈01</span> fst <span class="skolem">df</span>"</span></span> <span class="quoted"><span class="quoted">"snd <span class="skolem">cf</span> <span class="main">≈</span> snd <span class="skolem">df</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">I0</span></span> <span class="skolem"><span class="skolem">P</span></span> <span class="skolem"><span class="skolem">F</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    match<span class="main">:</span> <span class="quoted"><span class="quoted">"mC_ZOC ZObis <span class="main">(</span>fst <span class="skolem">cf</span><span class="main">)</span> <span class="main">(</span>fst <span class="skolem">df</span><span class="main">)</span> <span class="main">(</span>snd <span class="skolem">cf</span><span class="main">)</span> <span class="main">(</span>snd <span class="skolem">df</span><span class="main">)</span> <span class="skolem">I0</span> <span class="skolem">P</span> <span class="skolem">F</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ZObis_mC_ZOC <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span><span class="skolem">P</span> <span class="main">=</span> <span class="main">{..&lt;</span>brn <span class="main">(</span>fst <span class="skolem">cf</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> i <span class="keyword1"><span class="command">unfolding</span></span> mC_ZOC_def mC_ZOC_part_def part_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">I</span></span> <span class="keyword2"><span class="keyword">where</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">I</span> <span class="main">∈</span> <span class="skolem">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="skolem">I</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> i <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">I</span> <span class="main">=</span> <span class="skolem">I0</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∈</span> <span class="skolem">F</span> <span class="skolem">I</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> match I False <span class="keyword1"><span class="command">unfolding</span></span> m_defsAll <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> brn <span class="main">(</span>fst <span class="skolem">df</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> I match
      <span class="keyword1"><span class="command">unfolding</span></span> mC_ZOC_def mC_ZOC_part_def part_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">hence</span></span> md<span class="main">:</span> <span class="quoted"><span class="quoted">"discrCf <span class="main">(</span>cont_eff <span class="skolem">df</span> <span class="skolem">j</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"snd <span class="skolem">df</span> <span class="main">≈</span> snd <span class="main">(</span>cont_eff <span class="skolem">df</span> <span class="skolem">j</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> df discrCf_cont<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">df</span></span> <span class="quoted"><span class="skolem">j</span></span><span class="main">]</span> discrCf_eff_indis<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">df</span></span> <span class="quoted"><span class="skolem">j</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>cont_eff <span class="skolem">cf</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">≈</span> snd <span class="main">(</span>cont_eff <span class="skolem">df</span> <span class="skolem">j</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      md2<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>cont_eff <span class="skolem">cf</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">≈01</span> fst <span class="main">(</span>cont_eff <span class="skolem">df</span> <span class="skolem">j</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> I i j match False <span class="keyword1"><span class="command">unfolding</span></span> mC_ZOC_def mC_ZOC_eff_cont_def
      <span class="keyword1"><span class="command">unfolding</span></span> eff_def cont_def cont_eff_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"snd <span class="skolem">cf</span> <span class="main">≈</span> snd <span class="main">(</span>cont_eff <span class="skolem">cf</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> s indis_sym indis_trans cf_df <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> md md2 0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"snd <span class="skolem">cf</span> <span class="main">≈</span> snd <span class="main">(</span>cont_eff <span class="skolem">cf</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">∧</span> fst <span class="main">(</span>cont_eff <span class="skolem">cf</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">≈01</span> fst <span class="skolem">df</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> match i ZObis_sym <span class="keyword1"><span class="command">unfolding</span></span> mC_ZOC_def mC_ZOC_eff_cont0_def
      <span class="keyword1"><span class="command">unfolding</span></span> cont_eff_def cont_def eff_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>cont_eff <span class="skolem">cf</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">≈</span> snd <span class="skolem">df</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> match i indis_sym indis_trans cf_df <span class="keyword1"><span class="command">unfolding</span></span> mC_ZOC_def mC_ZOC_eff_cont0_def
      <span class="keyword1"><span class="command">unfolding</span></span> cont_eff_def cont_def eff_def True <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> df cf_df <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> ZObis_pres_discrCfR<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"discrCf <span class="free">cf</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"fst <span class="free">cf</span> <span class="main">≈01</span> fst <span class="free">df</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"snd <span class="free">cf</span> <span class="main">≈</span> snd <span class="free">df</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"discrCf <span class="free">df</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms ZObis_pres_discrCfL ZObis_sym indis_sym <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>


<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* context PL_Indis *)</span>
<span class="comment1">(*******************************************)</span>


<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Trace_Based">
<div class="head">
<h1>Theory Trace_Based</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹Trace-Based Noninterference›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Trace_Based
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="Resumption_Based.html">Resumption_Based</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="comment1">(* This contains the development leading to the paper's Prop. 4. *)</span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Preliminaries›</span></span>

<span class="keyword1" id="Trace_Based-dist_sum"><span class="command">lemma</span></span> dist_sum<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">g</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> real"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">I</span> <span class="main">⟹</span> dist <span class="main">(</span><span class="free">f</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free">g</span> <span class="bound">i</span><span class="main">)</span> <span class="main">≤</span> <span class="free">e</span> <span class="bound">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"dist <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="free">I</span><span class="main">.</span> <span class="free">f</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="free">I</span><span class="main">.</span> <span class="free">g</span> <span class="bound">i</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="free">I</span><span class="main">.</span> <span class="free">e</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">I</span>"</span></span> <span class="keyword1"><span class="command">from</span></span> this assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">induct</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>insert <span class="skolem">i</span> <span class="skolem">I</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dist <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span>insert <span class="skolem">i</span> <span class="skolem">I</span><span class="main">.</span> <span class="free">f</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span>insert <span class="skolem">i</span> <span class="skolem">I</span><span class="main">.</span> <span class="free">g</span> <span class="bound">i</span><span class="main">)</span> <span class="main">≤</span> dist <span class="main">(</span><span class="free">f</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span><span class="free">g</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">+</span> dist <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="skolem">I</span><span class="main">.</span> <span class="free">f</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="skolem">I</span><span class="main">.</span> <span class="free">g</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dist_triangle_add<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="free">e</span> <span class="skolem">i</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="skolem">I</span><span class="main">.</span> <span class="free">e</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> insert <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> add_mono<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> insert <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Trace_Based-dist_mult"><span class="command">lemma</span></span> dist_mult<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"dist <span class="main">(</span><span class="free">x</span> <span class="main">*</span> <span class="free">y</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span> <span class="main">*</span> <span class="free">z</span><span class="main">)</span> <span class="main">=</span> <span class="main">¦</span><span class="free">x</span><span class="main">¦</span> <span class="main">*</span> dist <span class="free">y</span> <span class="free">z</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> dist_real_def abs_mult<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> right_diff_distrib <span class="keyword1"><span class="command">..</span></span>

<span class="keyword1" id="Trace_Based-dist_divide"><span class="command">lemma</span></span> dist_divide<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"dist <span class="main">(</span><span class="free">y</span> <span class="main">/</span> <span class="free">r</span><span class="main">)</span> <span class="main">(</span><span class="free">z</span> <span class="main">/</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> dist <span class="free">y</span> <span class="free">z</span> <span class="main">/</span> <span class="main">¦</span><span class="free">r</span><span class="main">¦</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> dist_real_def abs_divide<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> diff_divide_distrib <span class="keyword1"><span class="command">..</span></span>

<span class="keyword1" id="Trace_Based-dist_weighted_sum"><span class="command">lemma</span></span> dist_weighted_sum<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">g</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> <span class="main">⇒</span> real"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> eps<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">I</span> <span class="main">⟹</span> <span class="bound">j</span> <span class="main">∈</span> <span class="free">J</span> <span class="main">⟹</span> <span class="free">w</span> <span class="bound">i</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free">v</span> <span class="bound">j</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟹</span> dist <span class="main">(</span><span class="free">f</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free">g</span> <span class="bound">j</span><span class="main">)</span> <span class="main">≤</span> <span class="free">d</span> <span class="bound">i</span> <span class="main">+</span> <span class="free">e</span> <span class="bound">j</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> pos<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span><span class="main">∈</span><span class="free">I</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">≤</span> <span class="free">w</span> <span class="bound">i</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span><span class="main">∈</span><span class="free">J</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">≤</span> <span class="free">v</span> <span class="bound">j</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> sum<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="free">I</span><span class="main">.</span> <span class="free">w</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">j</span><span class="main">∈</span><span class="free">J</span><span class="main">.</span> <span class="free">v</span> <span class="bound">j</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"dist <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="free">I</span><span class="main">.</span> <span class="free">w</span> <span class="bound">i</span> <span class="main">*</span> <span class="free">f</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="main">∑</span><span class="bound">j</span><span class="main">∈</span><span class="free">J</span><span class="main">.</span> <span class="free">v</span> <span class="bound">j</span> <span class="main">*</span> <span class="free">g</span> <span class="bound">j</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="free">I</span><span class="main">.</span> <span class="free">w</span> <span class="bound">i</span> <span class="main">*</span> <span class="free">d</span> <span class="bound">i</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">j</span><span class="main">∈</span><span class="free">J</span><span class="main">.</span> <span class="free">v</span> <span class="bound">j</span> <span class="main">*</span> <span class="free">e</span> <span class="bound">j</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="quoted"><span class="quoted">"<span class="var">?W</span> <span class="free">h</span>"</span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="bound">j</span><span class="main">)</span><span class="main">∈</span><span class="free">I</span><span class="main">×</span><span class="free">J</span><span class="main">.</span> <span class="main">(</span><span class="free">w</span> <span class="bound">i</span> <span class="main">*</span> <span class="free">v</span> <span class="bound">j</span><span class="main">)</span> <span class="main">*</span> <span class="free">h</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="bound">j</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">g</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> <span class="main">⇒</span> real"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">j</span><span class="main">∈</span><span class="free">J</span><span class="main">.</span> <span class="free">v</span> <span class="bound">j</span> <span class="main">*</span> <span class="skolem">g</span> <span class="bound">j</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="free">I</span><span class="main">.</span> <span class="free">w</span> <span class="bound">i</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">j</span><span class="main">∈</span><span class="free">J</span><span class="main">.</span> <span class="free">v</span> <span class="bound">j</span> <span class="main">*</span> <span class="skolem">g</span> <span class="bound">j</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> sum <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="var">?W</span> <span class="main">(</span><span class="skolem">g</span><span class="main">∘</span>snd<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">ac_simps</span></span> sum_product sum.cartesian_product<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">j</span><span class="main">∈</span><span class="free">J</span><span class="main">.</span> <span class="free">v</span> <span class="bound">j</span> <span class="main">*</span> <span class="skolem">g</span> <span class="bound">j</span><span class="main">)</span> <span class="main">=</span> <span class="var">?W</span> <span class="main">(</span><span class="skolem">g</span><span class="main">∘</span>snd<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span> <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> real"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="free">I</span><span class="main">.</span> <span class="free">w</span> <span class="bound">i</span> <span class="main">*</span> <span class="skolem">f</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="free">I</span><span class="main">.</span> <span class="free">w</span> <span class="bound">i</span> <span class="main">*</span> <span class="skolem">f</span> <span class="bound">i</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">j</span><span class="main">∈</span><span class="free">J</span><span class="main">.</span> <span class="free">v</span> <span class="bound">j</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> sum <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="var">?W</span> <span class="main">(</span><span class="skolem">f</span><span class="main">∘</span>fst<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> sum_product sum.cartesian_product <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="free">I</span><span class="main">.</span> <span class="free">w</span> <span class="bound">i</span> <span class="main">*</span> <span class="skolem">f</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="var">?W</span> <span class="main">(</span><span class="skolem">f</span><span class="main">∘</span>fst<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span> <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dist <span class="main">(</span><span class="var">?W</span> <span class="main">(</span><span class="free">f</span><span class="main">∘</span>fst<span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="var">?W</span> <span class="main">(</span><span class="free">g</span><span class="main">∘</span>snd<span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="var">?W</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="bound">j</span><span class="main">)</span><span class="main">.</span> <span class="free">d</span> <span class="bound">i</span> <span class="main">+</span> <span class="free">e</span> <span class="bound">j</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> eps pos
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> dist_sum<span class="main">)</span>
         <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mult_le_cancel_left zero_less_mult_iff mult_le_0_iff not_le<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="var">?W</span> <span class="main">(</span><span class="free">d</span> <span class="main">∘</span> fst<span class="main">)</span> <span class="main">+</span> <span class="var">?W</span> <span class="main">(</span><span class="free">e</span> <span class="main">∘</span> snd<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum.distrib<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sum.cong<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dist <span class="main">(</span><span class="var">?W</span> <span class="main">(</span><span class="free">f</span><span class="main">∘</span>fst<span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="var">?W</span> <span class="main">(</span><span class="free">g</span><span class="main">∘</span>snd<span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="var">?W</span> <span class="main">(</span><span class="free">d</span> <span class="main">∘</span> fst<span class="main">)</span> <span class="main">+</span> <span class="var">?W</span> <span class="main">(</span><span class="free">e</span> <span class="main">∘</span> snd<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Trace_Based-field_abs_le_zero_epsilon"><span class="command">lemma</span></span> field_abs_le_zero_epsilon<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">x</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>linordered_field<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> epsilon<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">e</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="bound">e</span> <span class="main">⟹</span> <span class="main">¦</span><span class="free">x</span><span class="main">¦</span> <span class="main">≤</span> <span class="bound">e</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="free">x</span><span class="main">¦</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> antisym<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="free">x</span><span class="main">¦</span> <span class="main">≤</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> field_le_epsilon<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">e</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">e</span>"</span></span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="free">x</span><span class="main">¦</span> <span class="main">≤</span> <span class="main">0</span> <span class="main">+</span> <span class="skolem">e</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Trace_Based-nat_nat_induct"><span class="command">lemma</span></span> nat_nat_induct<span class="main">[</span><span class="operator">case_names</span> less<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">P</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> less<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span> <span class="bound">m</span><span class="main">.</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">j</span> <span class="bound">k</span><span class="main">.</span> <span class="bound">j</span> <span class="main">+</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="bound">n</span> <span class="main">+</span> <span class="bound">m</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">j</span> <span class="bound">k</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">n</span> <span class="bound">m</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">n</span> <span class="free">m</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">N</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">N</span> <span class="main">≡</span> <span class="free">n</span> <span class="main">+</span> <span class="free">m</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">N</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">m</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> nat_less_induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 1 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">n</span> <span class="skolem">m</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> less<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> 1<span class="main"><span class="main">[</span></span><span class="operator">rule_format</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Trace_Based-part_insert"><span class="command">lemma</span></span> part_insert<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"part <span class="free">A</span> <span class="free">P</span>"</span></span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">∩</span> <span class="free">A</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"part <span class="main">(</span><span class="free">A</span> <span class="main">∪</span> <span class="free">X</span><span class="main">)</span> <span class="main">(</span>insert <span class="free">X</span> <span class="free">P</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> part_def<span class="main">)</span>

<span class="keyword1" id="Trace_Based-part_insert_subset"><span class="command">lemma</span></span> part_insert_subset<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> X<span class="main">:</span> <span class="quoted"><span class="quoted">"part <span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="free">X</span><span class="main">)</span> <span class="free">P</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"part <span class="free">A</span> <span class="main">(</span>insert <span class="free">X</span> <span class="free">P</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> X part_insert<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">-</span> <span class="free">X</span>"</span></span> <span class="quoted"><span class="free">P</span></span> <span class="quoted"><span class="free">X</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Un_absorb2<span class="main">)</span>

<span class="keyword1" id="Trace_Based-part_is_subset"><span class="command">lemma</span></span> part_is_subset<span class="main">:</span>
  <span class="quoted"><span class="quoted">"part <span class="free">S</span> <span class="free">P</span> <span class="main">⟹</span> <span class="free">p</span> <span class="main">∈</span> <span class="free">P</span> <span class="main">⟹</span> <span class="free">p</span> <span class="main">⊆</span> <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> part_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Union_upper<span class="main">)</span>

<span class="keyword1" id="Trace_Based-dist_nonneg_bounded"><span class="command">lemma</span></span> dist_nonneg_bounded<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">l</span> <span class="free">u</span> <span class="free">x</span> <span class="free">y</span> <span class="main">::</span> <span class="quoted">real</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">≤</span> <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≤</span> <span class="free">u</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">≤</span> <span class="free">y</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">≤</span> <span class="free">u</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"dist <span class="free">x</span> <span class="free">y</span> <span class="main">≤</span> <span class="free">u</span> <span class="main">-</span> <span class="free">l</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> dist_real_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>

<span class="keyword1" id="Trace_Based-integrable_count_space_finite_support"><span class="command">lemma</span></span> integrable_count_space_finite_support<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span><span class="main">{</span>banach<span class="main">,</span>second_countable_topology<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound"><span class="bound">x</span></span><span class="main">∈</span><span class="free">X</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">≠</span> <span class="main">0</span><span class="main">}</span> <span class="main">⟹</span> integrable <span class="main">(</span>count_space <span class="free">X</span><span class="main">)</span> <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nn_integral_count_space integrable_iff_bounded<span class="main">)</span>

<span class="keyword1" id="Trace_Based-lebesgue_integral_point_measure"><span class="command">lemma</span></span> lebesgue_integral_point_measure<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">g</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⇒</span> real"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound"><span class="bound">a</span></span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="free">f</span> <span class="bound">a</span> <span class="main">∧</span> <span class="free">g</span> <span class="bound">a</span> <span class="main">≠</span> <span class="main">0</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">integral<span class="hidden">⇧</span><sup>L</sup></span> <span class="main">(</span>point_measure <span class="free">A</span> <span class="free">f</span><span class="main">)</span> <span class="free">g</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">a</span></span><span class="main">|</span><span class="bound">a</span><span class="main">∈</span><span class="free">A</span> <span class="main">∧</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="free">f</span> <span class="bound">a</span> <span class="main">∧</span> <span class="free">g</span> <span class="bound">a</span> <span class="main">≠</span> <span class="main">0</span><span class="main">.</span> <span class="free">f</span> <span class="bound">a</span> <span class="main">*</span> <span class="free">g</span> <span class="bound">a</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">a</span></span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> max <span class="main">0</span> <span class="main">(</span><span class="free">f</span> <span class="bound">a</span><span class="main">)</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span> <span class="free">g</span> <span class="bound">a</span> <span class="main">≠</span> <span class="main">0</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">a</span></span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="free">f</span> <span class="bound">a</span> <span class="main">∧</span> <span class="free">g</span> <span class="bound">a</span> <span class="main">≠</span> <span class="main">0</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"ennreal <span class="main">(</span><span class="free">f</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">=</span> ennreal <span class="main">(</span>max <span class="main">0</span> <span class="main">(</span><span class="free">f</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">f</span> <span class="skolem">x</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> max.absorb1 ennreal_neg<span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> point_measure_def *
    <span class="keyword1"><span class="command">using</span></span> f
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> integral_real_density<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> integral_real_density lebesgue_integral_count_space_finite_support eq
      <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sum.cong<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> finite_measure<span class="main">)</span> finite_measure_dist<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> AE<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">AE</span> <span class="bound">x</span> <span class="keyword1">in</span> <span class="free">M</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∉</span> <span class="free">C</span> <span class="main">⟶</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟷</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">B</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> sets<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈</span> sets <span class="free">M</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">∈</span> sets <span class="free">M</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">∈</span> sets <span class="free">M</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"dist <span class="main">(</span>measure <span class="free">M</span> <span class="free">A</span><span class="main">)</span> <span class="main">(</span>measure <span class="free">M</span> <span class="free">B</span><span class="main">)</span> <span class="main">≤</span> measure <span class="free">M</span> <span class="free">C</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"measure <span class="free">M</span> <span class="free">A</span> <span class="main">≤</span> measure <span class="free">M</span> <span class="main">(</span><span class="free">B</span> <span class="main">∪</span> <span class="free">C</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> AE sets <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> finite_measure_mono_AE<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> measure <span class="free">M</span> <span class="free">B</span> <span class="main">+</span> measure <span class="free">M</span> <span class="free">C</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> sets <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> finite_measure_subadditive<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"measure <span class="free">M</span> <span class="free">A</span> <span class="main">≤</span> measure <span class="free">M</span> <span class="free">B</span> <span class="main">+</span> measure <span class="free">M</span> <span class="free">C</span>"</span></span> <span class="keyword1"><span class="command">.</span></span> <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"measure <span class="free">M</span> <span class="free">B</span> <span class="main">≤</span> measure <span class="free">M</span> <span class="main">(</span><span class="free">A</span> <span class="main">∪</span> <span class="free">C</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> AE sets <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> finite_measure_mono_AE<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> measure <span class="free">M</span> <span class="free">A</span> <span class="main">+</span> measure <span class="free">M</span> <span class="free">C</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> sets <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> finite_measure_subadditive<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"measure <span class="free">M</span> <span class="free">B</span> <span class="main">≤</span> measure <span class="free">M</span> <span class="free">A</span> <span class="main">+</span> measure <span class="free">M</span> <span class="free">C</span>"</span></span> <span class="keyword1"><span class="command">.</span></span> <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dist_real_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> prob_space<span class="main">)</span> prob_dist<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> AE<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">AE</span> <span class="bound">x</span> <span class="keyword1">in</span> <span class="free">M</span><span class="main">.</span> <span class="main">¬</span> <span class="free">C</span> <span class="bound">x</span> <span class="main">⟶</span> <span class="main">(</span><span class="free">A</span> <span class="bound">x</span> <span class="main">⟷</span> <span class="free">B</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> sets<span class="main">:</span> <span class="quoted"><span class="quoted">"Measurable.pred <span class="free">M</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"Measurable.pred <span class="free">M</span> <span class="free">B</span>"</span></span> <span class="quoted"><span class="quoted">"Measurable.pred <span class="free">M</span> <span class="free">C</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"dist <span class="keyword1">𝒫(</span><span class="bound"><span class="bound">x</span></span> <span class="keyword1">in</span> <span class="free"><span class="free">M</span></span><span class="main">.</span> <span class="free">A</span> <span class="bound">x</span><span class="main">)</span> <span class="keyword1">𝒫(</span><span class="bound"><span class="bound">x</span></span> <span class="keyword1">in</span> <span class="free"><span class="free">M</span></span><span class="main">.</span> <span class="free">B</span> <span class="bound">x</span><span class="main">)</span> <span class="main">≤</span> <span class="keyword1">𝒫(</span><span class="bound"><span class="bound">x</span></span> <span class="keyword1">in</span> <span class="free"><span class="free">M</span></span><span class="main">.</span> <span class="free">C</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> finite_measure_dist<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Trace_Based-Least_eq_0_iff"><span class="command">lemma</span></span> Least_eq_0_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">i</span><span class="main">::</span>nat<span class="main">.</span> <span class="free">P</span> <span class="bound">i</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">i</span><span class="main">.</span> <span class="free">P</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟷</span> <span class="free">P</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> LeastI_ex neq0_conv not_less_Least<span class="main">)</span>

<span class="keyword1" id="Trace_Based-case_nat_comp_Suc"><span class="command">lemma</span></span> case_nat_comp_Suc<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"case_nat <span class="free">x</span> <span class="free">f</span> <span class="main">∘</span> Suc <span class="main">=</span> <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Trace_Based-sum_eq_0_iff"><span class="command">lemma</span></span> sum_eq_0_iff<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">::</span> <span class="main">{</span>comm_monoid_add<span class="main">,</span>ordered_ab_group_add<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">≤</span> <span class="free">f</span> <span class="bound">i</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="free">f</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">i</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="free">f</span> <span class="bound">i</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> sum_nonneg_0<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Trace_Based-sum_less_0_iff"><span class="command">lemma</span></span> sum_less_0_iff<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">::</span> <span class="main">{</span>comm_monoid_add<span class="main">,</span>ordered_ab_group_add<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">≤</span> <span class="free">f</span> <span class="bound">i</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="free">f</span> <span class="bound">i</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">i</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="free">f</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> sum_nonneg<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">f</span></span><span class="main">]</span> sum_eq_0_iff<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">f</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> less_le<span class="main">)</span>

<span class="keyword1"><span class="command">context</span></span> PL_Indis
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">declare</span></span> emp_gen<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>

<span class="keyword1"><span class="command">interpretation</span></span> pmf_as_function <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> wt_pmf <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'test</span><span class="main">,</span> <span class="tfree">'atom</span><span class="main">,</span> <span class="tfree">'choice</span><span class="main">)</span> cmd <span class="main">×</span> <span class="tfree">'state</span> <span class="main">⇒</span> nat pmf"</span></span> <span class="keyword2"><span class="keyword">is</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main">(</span><span class="bound">c</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span> <span class="bound">i</span><span class="main">.</span> <span class="keyword1">if</span> proper <span class="bound">c</span> <span class="keyword1">then</span> <span class="keyword1">if</span> <span class="bound">i</span> <span class="main">&lt;</span> brn <span class="bound">c</span> <span class="keyword1">then</span> wt <span class="bound">c</span> <span class="bound">s</span> <span class="bound">i</span> <span class="keyword1">else</span> <span class="main">0</span> <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="bound">i</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main">(</span><span class="bound">c</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span> <span class="bound">i</span><span class="main">.</span> <span class="keyword1">if</span> proper <span class="bound">c</span> <span class="keyword1">then</span> <span class="keyword1">if</span> <span class="bound">i</span> <span class="main">&lt;</span> brn <span class="bound">c</span> <span class="keyword1">then</span> wt <span class="bound">c</span> <span class="bound">s</span> <span class="bound">i</span> <span class="keyword1">else</span> <span class="main">0</span> <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="bound">i</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span>"</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">cf</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="var">?f</span> <span class="skolem">cf</span> <span class="bound">i</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.split<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">i</span><span class="main">.</span> <span class="var">?f</span> <span class="skolem">cf</span> <span class="bound">i</span> <span class="main">∂</span>count_space UNIV<span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> nn_integral_count_space'<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> A<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="keyword1"><span class="keyword1"><span class="keyword1">if</span></span></span> proper <span class="main"><span class="main"><span class="main">(</span></span></span>fst <span class="skolem"><span class="skolem"><span class="skolem">cf</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span> <span class="keyword1"><span class="keyword1"><span class="keyword1">then</span></span></span> <span class="main"><span class="main"><span class="main">{..&lt;</span></span></span>brn <span class="main"><span class="main"><span class="main">(</span></span></span>fst <span class="skolem"><span class="skolem"><span class="skolem">cf</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main"><span class="main">}</span></span></span> <span class="keyword1"><span class="keyword1"><span class="keyword1">else</span></span></span> <span class="main"><span class="main"><span class="main">{</span></span></span><span class="main"><span class="main"><span class="main">0</span></span></span><span class="main"><span class="main"><span class="main">}</span></span></span>"</span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">for</span></span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">n</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.split<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">trans</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'test</span><span class="main">,</span> <span class="tfree">'atom</span><span class="main">,</span> <span class="tfree">'choice</span><span class="main">)</span> cmd <span class="main">×</span> <span class="tfree">'state</span> <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span><span class="tfree">'test</span><span class="main">,</span> <span class="tfree">'atom</span><span class="main">,</span> <span class="tfree">'choice</span><span class="main">)</span> cmd <span class="main">×</span> <span class="tfree">'state</span><span class="main">)</span> pmf"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">trans</span> <span class="free"><span class="bound"><span class="entity">cf</span></span></span> <span class="main">=</span> map_pmf <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="keyword1">if</span> proper <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">cf</span></span></span><span class="main">)</span> <span class="keyword1">then</span> cont_eff <span class="free"><span class="bound"><span class="entity">cf</span></span></span> <span class="bound">i</span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">cf</span></span></span><span class="main">)</span> <span class="main">(</span>wt_pmf <span class="free"><span class="bound"><span class="entity">cf</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> T<span class="main">?</span><span class="main">:</span> MC_syntax <span class="quoted">trans</span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">G</span> <span class="free"><span class="bound"><span class="entity">cf</span></span></span> <span class="main">≡</span> set_pmf <span class="main">(</span>trans <span class="free"><span class="bound"><span class="entity">cf</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Trace_Based-set_pmf_map"><span class="command">lemma</span></span> set_pmf_map<span class="main">:</span> <span class="quoted"><span class="quoted">"set_pmf <span class="main">(</span>map_pmf <span class="free">f</span> <span class="free">M</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="main">`</span> set_pmf <span class="free">M</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> pmf_set_map<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">f</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> comp_def fun_eq_iff<span class="main">)</span>

<span class="keyword1" id="Trace_Based-set_pmf_wt"><span class="command">lemma</span></span> set_pmf_wt<span class="main">:</span>
  <span class="quoted"><span class="quoted">"set_pmf <span class="main">(</span>wt_pmf <span class="free">cf</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> proper <span class="main">(</span>fst <span class="free">cf</span><span class="main">)</span> <span class="keyword1">then</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> brn <span class="main">(</span>fst <span class="free">cf</span><span class="main">)</span> <span class="main">∧</span> <span class="main">0</span> <span class="main">&lt;</span> wt <span class="main">(</span>fst <span class="free">cf</span><span class="main">)</span> <span class="main">(</span>snd <span class="free">cf</span><span class="main">)</span> <span class="bound">i</span><span class="main">}</span> <span class="keyword1">else</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> set_eq_iff set_pmf_iff wt_pmf.rep_eq <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.split<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> less_le wt_ge_0<span class="main">)</span>

<span class="keyword1" id="Trace_Based-G_eq"><span class="command">lemma</span></span> G_eq<span class="main">:</span>
  <span class="quoted"><span class="quoted">"G <span class="free">cf</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> proper <span class="main">(</span>fst <span class="free">cf</span><span class="main">)</span> <span class="keyword1">then</span> <span class="main">{</span>cont_eff <span class="free">cf</span> <span class="bound">i</span> <span class="main">|</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> brn <span class="main">(</span>fst <span class="free">cf</span><span class="main">)</span> <span class="main">∧</span> <span class="main">0</span> <span class="main">&lt;</span> wt <span class="main">(</span>fst <span class="free">cf</span><span class="main">)</span> <span class="main">(</span>snd <span class="free">cf</span><span class="main">)</span> <span class="bound">i</span> <span class="main">}</span> <span class="keyword1">else</span> <span class="main">{</span><span class="free">cf</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> trans_def set_pmf_map set_pmf_wt<span class="main">)</span>

<span class="keyword1" id="Trace_Based-discrCf_G"><span class="command">lemma</span></span> discrCf_G<span class="main">:</span> <span class="quoted"><span class="quoted">"discrCf <span class="free">cf</span> <span class="main">⟹</span> <span class="free">cf'</span> <span class="main">∈</span> G <span class="free">cf</span> <span class="main">⟹</span> discrCf <span class="free">cf'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> discrCf_cont<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">cf</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> G_eq <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>

<span class="keyword1" id="Trace_Based-measurable_discrCf"><span class="command">lemma</span></span> measurable_discrCf<span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Measurable.pred <span class="main">(</span>count_space UNIV<span class="main">)</span> discrCf"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Trace_Based-measurable_indis"><span class="command">lemma</span></span> measurable_indis<span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Measurable.pred <span class="main">(</span>count_space UNIV<span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> snd <span class="bound">x</span> <span class="main">≈</span> <span class="free">c</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Trace_Based-integral_trans"><span class="command">lemma</span></span> integral_trans<span class="main">:</span>
  <span class="quoted"><span class="quoted">"proper <span class="main">(</span>fst <span class="free">cf</span><span class="main">)</span> <span class="main">⟹</span>
    <span class="main">(</span><span class="main">∫</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">∂</span>trans <span class="free">cf</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span>brn <span class="main">(</span>fst <span class="free">cf</span><span class="main">)</span><span class="main">.</span> wt <span class="main">(</span>fst <span class="free">cf</span><span class="main">)</span> <span class="main">(</span>snd <span class="free">cf</span><span class="main">)</span> <span class="bound">i</span> <span class="main">*</span> <span class="free">f</span> <span class="main">(</span>cont_eff <span class="free">cf</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> trans_def map_pmf_rep_eq
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> integral_distr<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> integral_measure_pmf<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">{..&lt;</span></span> brn <span class="main"><span class="main">(</span></span>fst <span class="free"><span class="free">cf</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">}</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> set_pmf_wt mult_ac wt_pmf.rep_eq <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.split<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Quasi strong termination traces"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">qsend</span> <span class="main">≡</span> sfirst <span class="main">(</span>holds discrCf<span class="main">)</span>"</span></span>

<span class="keyword1" id="Trace_Based-qsend_eq_0_iff"><span class="command">lemma</span></span> qsend_eq_0_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"qsend <span class="free">cfT</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟷</span> discrCf <span class="main">(</span>shd <span class="free">cfT</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sfirst.simps<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free">cfT</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="Trace_Based-qsend_eq_0"><span class="command">lemma</span></span> qsend_eq_0<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"discrCf <span class="free">cf</span> <span class="main">⟹</span> qsend <span class="main">(</span><span class="free">cf</span> <span class="main">##</span> <span class="free">ω</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> qsend_eq_0_iff<span class="main">)</span>

<span class="keyword1" id="Trace_Based-alw_discrCf"><span class="command">lemma</span></span> alw_discrCf<span class="main">:</span> <span class="quoted"><span class="quoted">"enabled <span class="free">cf</span> <span class="free">ω</span> <span class="main">⟹</span> discrCf <span class="free">cf</span> <span class="main">⟹</span> alw <span class="main">(</span>holds discrCf<span class="main">)</span> <span class="free">ω</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">cf</span></span> <span class="quoted"><span class="free">ω</span></span><span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HLD_iff <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> enabled.cases <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> discrCf_G <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> split_paired_Ex<span class="main">)</span>

<span class="keyword1" id="Trace_Based-alw_discrCf_indis'"><span class="command">lemma</span></span> alw_discrCf_indis'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"enabled <span class="free">cf</span> <span class="free">ω</span> <span class="main">⟹</span> discrCf <span class="free">cf</span> <span class="main">⟹</span> snd <span class="free">cf</span> <span class="main">≈</span> <span class="free">t</span> <span class="main">⟹</span> alw <span class="main">(</span>holds <span class="main">(</span><span class="main">λ</span><span class="bound">cf'</span><span class="main">.</span> snd <span class="bound">cf'</span> <span class="main">≈</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="free">ω</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">cf</span></span> <span class="quoted"><span class="free">ω</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> alw <span class="keyword1"><span class="command">with</span></span> discrCf_eff_indis<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">cf</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HLD_iff enabled.simps<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">ω</span></span><span class="main"><span class="main">]</span></span> G_eq
             <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> split_paired_Ex discrCf_eff_indis
             <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"shd <span class="skolem">ω</span>"</span></span><span class="main"><span class="main">]</span></span>
             <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>
       <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> indis_trans indis_sym<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Trace_Based-alw_discrCf_indis"><span class="command">lemma</span></span> alw_discrCf_indis<span class="main">:</span>
  <span class="quoted"><span class="quoted">"enabled <span class="free">cf</span> <span class="free">ω</span> <span class="main">⟹</span> discrCf <span class="free">cf</span> <span class="main">⟹</span> alw <span class="main">(</span>holds <span class="main">(</span><span class="main">λ</span><span class="bound">cf'</span><span class="main">.</span> snd <span class="bound">cf'</span> <span class="main">≈</span> snd <span class="free">cf</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">cf</span> <span class="main">##</span> <span class="free">ω</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> alw_discrCf_indis'<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">cf</span></span> <span class="quoted"><span class="free">ω</span></span><span class="main">,</span> <span class="operator">OF</span> _ _ indis_refl<span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> alw.simps<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="free">cf</span> <span class="main">##</span> <span class="free">ω</span>"</span></span><span class="main"><span class="main">]</span></span> indis_refl<span class="main">)</span>

<span class="keyword1" id="Trace_Based-enabled_sdrop"><span class="command">lemma</span></span> enabled_sdrop<span class="main">:</span> <span class="quoted"><span class="quoted">"enabled <span class="free">cf</span> <span class="free">ω</span> <span class="main">⟹</span> enabled <span class="main">(</span><span class="main">(</span><span class="free">cf</span> <span class="main">##</span> <span class="free">ω</span><span class="main">)</span> <span class="main">!!</span> <span class="free">n</span><span class="main">)</span> <span class="main">(</span>sdrop <span class="free">n</span> <span class="free">ω</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">cf</span></span> <span class="quoted"><span class="free">ω</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="keyword1"><span class="command">from</span></span> Suc.IH<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"shd <span class="skolem">ω</span>"</span></span> <span class="quoted"><span class="quoted">"stl <span class="skolem">ω</span>"</span></span><span class="main">]</span> Suc.prems <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> enabled.simps<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">cf</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Trace_Based-sfirst_eq_eSuc"><span class="command">lemma</span></span> sfirst_eq_eSuc<span class="main">:</span> <span class="quoted"><span class="quoted">"sfirst <span class="free">P</span> <span class="free">ω</span> <span class="main">=</span> eSuc <span class="free">n</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">¬</span> <span class="free">P</span> <span class="free">ω</span><span class="main">)</span> <span class="main">∧</span> sfirst <span class="free">P</span> <span class="main">(</span>stl <span class="free">ω</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sfirst.simps<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Trace_Based-qsend_snth"><span class="command">lemma</span></span> qsend_snth<span class="main">:</span> <span class="quoted"><span class="quoted">"qsend <span class="free">ω</span> <span class="main">=</span> enat <span class="free">n</span> <span class="main">⟹</span> discrCf <span class="main">(</span><span class="free">ω</span> <span class="main">!!</span> <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ω</span></span><span class="main">)</span>
     <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eSuc_enat<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> enat_0 sfirst_eq_0 sfirst_eq_eSuc<span class="main">)</span>

<span class="keyword1" id="Trace_Based-indis_iff"><span class="command">lemma</span></span> indis_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≈</span> <span class="free">d</span> <span class="main">⟹</span> <span class="free">b</span> <span class="main">≈</span> <span class="free">d</span> <span class="main">⟹</span> <span class="free">a</span> <span class="main">≈</span> <span class="free">c</span> <span class="main">⟷</span> <span class="free">b</span> <span class="main">≈</span> <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> indis_trans indis_sym indis_refl<span class="main">)</span>

<span class="keyword1" id="Trace_Based-enabled_qsend_indis"><span class="command">lemma</span></span> enabled_qsend_indis<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"enabled <span class="free">cf</span> <span class="free">ω</span>"</span></span> <span class="quoted"><span class="quoted">"qsend <span class="main">(</span><span class="free">cf</span> <span class="main">##</span> <span class="free">ω</span><span class="main">)</span> <span class="main">≤</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"qsend <span class="main">(</span><span class="free">cf</span> <span class="main">##</span> <span class="free">ω</span><span class="main">)</span> <span class="main">≤</span> <span class="free">m</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span><span class="main">(</span><span class="free">cf</span> <span class="main">##</span> <span class="free">ω</span><span class="main">)</span> <span class="main">!!</span> <span class="free">n</span><span class="main">)</span> <span class="main">≈</span> <span class="free">t</span> <span class="main">⟷</span> snd <span class="main">(</span><span class="main">(</span><span class="free">cf</span> <span class="main">##</span> <span class="free">ω</span><span class="main">)</span> <span class="main">!!</span> <span class="free">m</span><span class="main">)</span> <span class="main">≈</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">N</span></span> <span class="main">::</span> <span class="quoted">nat</span> <span class="keyword2"><span class="keyword">where</span></span> N<span class="main">:</span> <span class="quoted"><span class="quoted">"qsend <span class="main">(</span><span class="free">cf</span> <span class="main">##</span> <span class="free">ω</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">N</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"qsend <span class="main">(</span><span class="free">cf</span> <span class="main">##</span> <span class="free">ω</span><span class="main">)</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">note</span></span> discr_N <span class="main">=</span> qsend_snth<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> sd <span class="main">=</span> enabled_sdrop<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">N</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ω</span><span class="main">.</span> <span class="bound">ω</span> <span class="main">!!</span> <span class="skolem">N</span> <span class="main">##</span> sdrop <span class="skolem">N</span> <span class="main">(</span>stl <span class="bound">ω</span><span class="main">)</span> <span class="main">=</span> sdrop <span class="skolem">N</span> <span class="bound">ω</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">N</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> this<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">cf</span> <span class="main">##</span> <span class="free">ω</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">cf</span> <span class="main">##</span> <span class="free">ω</span><span class="main">)</span> <span class="main">!!</span> <span class="skolem">N</span> <span class="main">##</span> sdrop <span class="skolem">N</span> <span class="free">ω</span> <span class="main">=</span> sdrop <span class="skolem">N</span> <span class="main">(</span><span class="free">cf</span> <span class="main">##</span> <span class="free">ω</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">from</span></span> discr_N alw_discrCf_indis<span class="main">[</span><span class="operator">OF</span> sd _<span class="main">]</span> assms<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> N alw_iff_sdrop le_iff_add<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="tfree">'a</span><span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted">nat</span><span class="main"><span class="main">]</span></span> eq<span class="main">)</span>
       <span class="main">(</span><span class="operator">metis</span> indis_iff<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Trace_Based-enabled_imp_UNTIL_alw_discrCf"><span class="command">lemma</span></span> enabled_imp_UNTIL_alw_discrCf<span class="main">:</span>
  <span class="quoted"><span class="quoted">"enabled <span class="main">(</span>shd <span class="free">ω</span><span class="main">)</span> <span class="main">(</span>stl <span class="free">ω</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span>not <span class="main">(</span>holds discrCf<span class="main">)</span> <span class="keyword1">until</span> <span class="main">(</span>alw <span class="main">(</span>holds discrCf<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">ω</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ω</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> UNTIL <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> alw_discrCf<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"shd <span class="skolem">ω</span>"</span></span> <span class="quoted"><span class="quoted">"stl <span class="skolem">ω</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"discrCf <span class="main">(</span>shd <span class="skolem">ω</span><span class="main">)</span>"</span></span><span class="main">)</span>
       <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> enabled.simps<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"shd <span class="skolem">ω</span>"</span></span><span class="main"><span class="main">]</span></span> alw.simps<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">ω</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Trace_Based-less_qsend_iff_not_discrCf"><span class="command">lemma</span></span> less_qsend_iff_not_discrCf<span class="main">:</span>
  <span class="quoted"><span class="quoted">"enabled <span class="free">cf</span> <span class="free">bT</span> <span class="main">⟹</span> <span class="free">n</span> <span class="main">&lt;</span> qsend <span class="main">(</span><span class="free">cf</span> <span class="main">##</span> <span class="free">bT</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">¬</span> discrCf <span class="main">(</span><span class="main">(</span><span class="free">cf</span> <span class="main">##</span> <span class="free">bT</span><span class="main">)</span> <span class="main">!!</span> <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> enabled_imp_UNTIL_alw_discrCf<span class="main">[</span><span class="operator">THEN</span> less_sfirst_iff<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">cf</span> <span class="main">##</span> <span class="free">bT</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> holds.simps<span class="main"><span class="main">[</span></span><span class="operator">abs_def</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Terminating configurations"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">qstermCf</span> <span class="free"><span class="bound"><span class="entity">cf</span></span></span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">cfT</span><span class="main">.</span> enabled <span class="free"><span class="bound"><span class="entity">cf</span></span></span> <span class="bound">cfT</span> <span class="main">⟶</span> qsend <span class="main">(</span><span class="free"><span class="bound"><span class="entity">cf</span></span></span> <span class="main">##</span> <span class="bound">cfT</span><span class="main">)</span> <span class="main">&lt;</span> <span class="main">∞</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Trace_Based-qstermCf_E"><span class="command">lemma</span></span> qstermCf_E<span class="main">:</span>
  <span class="quoted"><span class="quoted">"qstermCf <span class="free">cf</span> <span class="main">⟹</span> <span class="free">cf'</span> <span class="main">∈</span> G <span class="free">cf</span> <span class="main">⟹</span> qstermCf <span class="free">cf'</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> qstermCf_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">cf'</span> <span class="main">##</span> <span class="improper">cfT</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sfirst_Stream <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> enat_0 discrCf_G <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> enabled.intros<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">eff_at</span> <span class="free"><span class="bound"><span class="entity">cf</span></span></span> <span class="free"><span class="bound"><span class="entity">bT</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">≡</span> snd <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">cf</span></span></span> <span class="main">##</span> <span class="free"><span class="bound"><span class="entity">bT</span></span></span><span class="main">)</span> <span class="main">!!</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">cont_at</span> <span class="free"><span class="bound"><span class="entity">cf</span></span></span> <span class="free"><span class="bound"><span class="entity">bT</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">≡</span> fst <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">cf</span></span></span> <span class="main">##</span> <span class="free"><span class="bound"><span class="entity">bT</span></span></span><span class="main">)</span> <span class="main">!!</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">amSec</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">s1</span> <span class="bound">s2</span> <span class="bound">n</span> <span class="bound">t</span><span class="main">.</span> <span class="bound">s1</span> <span class="main">≈</span> <span class="bound">s2</span> <span class="main">⟶</span>
  <span class="keyword1">𝒫(</span><span class="bound"><span class="bound">bT</span></span> <span class="keyword1">in</span> T.T <span class="main">(</span><span class="free"><span class="free"><span class="bound"><span class="bound"><span class="entity"><span class="entity">c</span></span></span></span></span></span><span class="main">,</span> <span class="bound"><span class="bound">s1</span></span><span class="main">)</span><span class="main">.</span> eff_at <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span> <span class="bound">s1</span><span class="main">)</span> <span class="bound">bT</span> <span class="bound">n</span> <span class="main">≈</span> <span class="bound">t</span><span class="main">)</span> <span class="main">=</span>
  <span class="keyword1">𝒫(</span><span class="bound"><span class="bound">bT</span></span> <span class="keyword1">in</span> T.T <span class="main">(</span><span class="free"><span class="free"><span class="bound"><span class="bound"><span class="entity"><span class="entity">c</span></span></span></span></span></span><span class="main">,</span> <span class="bound"><span class="bound">s2</span></span><span class="main">)</span><span class="main">.</span> eff_at <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span> <span class="bound">s2</span><span class="main">)</span> <span class="bound">bT</span> <span class="bound">n</span> <span class="main">≈</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">eSec</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">s1</span> <span class="bound">s2</span> <span class="bound">t</span><span class="main">.</span> <span class="bound">s1</span> <span class="main">≈</span> <span class="bound">s2</span> <span class="main">⟶</span>
  <span class="keyword1">𝒫(</span><span class="bound"><span class="bound">bT</span></span> <span class="keyword1">in</span> T.T <span class="main">(</span><span class="free"><span class="free"><span class="bound"><span class="bound"><span class="entity"><span class="entity">c</span></span></span></span></span></span><span class="main">,</span> <span class="bound"><span class="bound">s1</span></span><span class="main">)</span><span class="main">.</span> <span class="main">∃</span><span class="bound">n</span><span class="main">.</span> qsend <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span> <span class="bound">s1</span><span class="main">)</span> <span class="main">##</span> <span class="bound">bT</span><span class="main">)</span> <span class="main">=</span> <span class="bound">n</span> <span class="main">∧</span> eff_at <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span> <span class="bound">s1</span><span class="main">)</span> <span class="bound">bT</span> <span class="bound">n</span> <span class="main">≈</span> <span class="bound">t</span><span class="main">)</span> <span class="main">=</span>
  <span class="keyword1">𝒫(</span><span class="bound"><span class="bound">bT</span></span> <span class="keyword1">in</span> T.T <span class="main">(</span><span class="free"><span class="free"><span class="bound"><span class="bound"><span class="entity"><span class="entity">c</span></span></span></span></span></span><span class="main">,</span> <span class="bound"><span class="bound">s2</span></span><span class="main">)</span><span class="main">.</span> <span class="main">∃</span><span class="bound">n</span><span class="main">.</span> qsend <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span> <span class="bound">s2</span><span class="main">)</span> <span class="main">##</span> <span class="bound">bT</span><span class="main">)</span> <span class="main">=</span> <span class="bound">n</span> <span class="main">∧</span> eff_at <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span> <span class="bound">s2</span><span class="main">)</span> <span class="bound">bT</span> <span class="bound">n</span> <span class="main">≈</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">aeT</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">s</span><span class="main">.</span> <span class="keyword1">AE</span> <span class="bound">bT</span> <span class="keyword1">in</span> T.T <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span><span class="bound">s</span><span class="main">)</span><span class="main">.</span> qsend <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span><span class="bound">s</span><span class="main">)</span> <span class="main">##</span> <span class="bound">bT</span><span class="main">)</span> <span class="main">&lt;</span> <span class="main">∞</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Trace_Based-dist_Ps_upper_bound"><span class="command">lemma</span></span> dist_Ps_upper_bound<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">cf1</span> <span class="free">cf2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'test</span><span class="main">,</span> <span class="tfree">'atom</span><span class="main">,</span> <span class="tfree">'choice</span><span class="main">)</span> cmd <span class="main">×</span> <span class="tfree">'state</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">s</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">S</span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="free">cf</span> <span class="free">bT</span> <span class="main">≡</span> <span class="main">∃</span><span class="bound">n</span><span class="main">.</span> qsend <span class="main">(</span><span class="free">cf</span> <span class="main">##</span> <span class="free">bT</span><span class="main">)</span> <span class="main">=</span> <span class="bound">n</span> <span class="main">∧</span> eff_at <span class="free">cf</span> <span class="free">bT</span> <span class="bound">n</span> <span class="main">≈</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">Ps</span> <span class="free">cf</span> <span class="main">≡</span> <span class="keyword1">𝒫(</span><span class="bound"><span class="bound">bT</span></span> <span class="keyword1">in</span> T.T <span class="free"><span class="free">cf</span></span><span class="main">.</span> <span class="free">S</span> <span class="free">cf</span> <span class="bound">bT</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">N</span> <span class="free">cf</span> <span class="free">n</span> <span class="free">bT</span> <span class="main">≡</span> <span class="main">¬</span> discrCf <span class="main">(</span><span class="main">(</span><span class="free">cf</span> <span class="main">##</span> <span class="free">bT</span><span class="main">)</span> <span class="main">!!</span> <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">Pn</span> <span class="free">cf</span> <span class="free">n</span> <span class="main">≡</span> <span class="keyword1">𝒫(</span><span class="bound"><span class="bound">bT</span></span> <span class="keyword1">in</span> T.T <span class="free"><span class="free">cf</span></span><span class="main">.</span> <span class="free">N</span> <span class="free">cf</span> <span class="free">n</span> <span class="bound">bT</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> bisim<span class="main">:</span> <span class="quoted"><span class="quoted">"proper <span class="main">(</span>fst <span class="free">cf1</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"proper <span class="main">(</span>fst <span class="free">cf2</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"fst <span class="free">cf1</span> <span class="main">≈01</span> fst <span class="free">cf2</span>"</span></span> <span class="quoted"><span class="quoted">"snd <span class="free">cf1</span> <span class="main">≈</span> snd <span class="free">cf2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"dist <span class="main">(</span><span class="free">Ps</span> <span class="free">cf1</span><span class="main">)</span> <span class="main">(</span><span class="free">Ps</span> <span class="free">cf2</span><span class="main">)</span> <span class="main">≤</span> <span class="free">Pn</span> <span class="free">cf1</span> <span class="free">n</span> <span class="main">+</span> <span class="free">Pn</span> <span class="free">cf2</span> <span class="free">m</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> bisim <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">m</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">cf1</span></span> <span class="quoted"><span class="free">cf2</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> nat_nat_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>less <span class="skolem">n</span> <span class="skolem">m</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> <span class="quoted"><span class="quoted">‹proper <span class="main">(</span>fst <span class="skolem">cf1</span><span class="main">)</span>›</span></span><span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main">]</span>
  <span class="keyword1"><span class="command">note</span></span> <span class="quoted"><span class="quoted">‹proper <span class="main">(</span>fst <span class="skolem">cf2</span><span class="main">)</span>›</span></span><span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main">]</span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">W</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">W</span> <span class="skolem">c</span> <span class="main">=</span> sum <span class="main">(</span>wt <span class="main">(</span>fst <span class="skolem">c</span><span class="main">)</span> <span class="main">(</span>snd <span class="skolem">c</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">c</span>
  <span class="keyword1"><span class="command">from</span></span> ZObis_mC_ZOC<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹fst <span class="skolem">cf1</span> <span class="main">≈01</span> fst <span class="skolem">cf2</span>›</span></span> <span class="quoted"><span class="quoted">‹snd <span class="skolem">cf1</span> <span class="main">≈</span> snd <span class="skolem">cf2</span>›</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">I0</span></span> <span class="skolem"><span class="skolem">P</span></span> <span class="skolem"><span class="skolem">F</span></span> <span class="keyword2"><span class="keyword">where</span></span> mC<span class="main">:</span> <span class="quoted"><span class="quoted">"mC_ZOC ZObis <span class="main">(</span>fst <span class="skolem">cf1</span><span class="main">)</span> <span class="main">(</span>fst <span class="skolem">cf2</span><span class="main">)</span> <span class="main">(</span>snd <span class="skolem">cf1</span><span class="main">)</span> <span class="main">(</span>snd <span class="skolem">cf2</span><span class="main">)</span> <span class="skolem">I0</span> <span class="skolem">P</span> <span class="skolem">F</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> P<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{}</span> <span class="main">∉</span> <span class="skolem">P</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">I0</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"part <span class="main">{..&lt;</span>brn <span class="main">(</span>fst <span class="skolem">cf1</span><span class="main">)</span><span class="main">}</span> <span class="skolem">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">I0</span> <span class="main">∈</span> <span class="skolem">P</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> FP<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{}</span> <span class="main">∉</span> <span class="skolem">F</span><span class="main">`</span><span class="main">(</span><span class="skolem">P</span><span class="main">-</span><span class="main">{</span><span class="skolem">I0</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"part <span class="main">{..&lt;</span>brn <span class="main">(</span>fst <span class="skolem">cf2</span><span class="main">)</span><span class="main">}</span> <span class="main">(</span><span class="skolem">F</span><span class="main">`</span><span class="skolem">P</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="skolem">F</span> <span class="skolem">P</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> eff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">q</span> <span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">q</span><span class="main">∈</span><span class="skolem">P</span> <span class="main">⟹</span> <span class="bound">q</span><span class="main">≠</span><span class="skolem">I0</span> <span class="main">⟹</span> <span class="bound">i</span><span class="main">∈</span><span class="bound">q</span> <span class="main">⟹</span> <span class="bound">j</span><span class="main">∈</span><span class="skolem">F</span> <span class="bound">q</span> <span class="main">⟹</span> eff <span class="main">(</span>fst <span class="skolem">cf1</span><span class="main">)</span> <span class="main">(</span>snd <span class="skolem">cf1</span><span class="main">)</span> <span class="bound">i</span> <span class="main">≈</span> eff <span class="main">(</span>fst <span class="skolem">cf2</span><span class="main">)</span> <span class="main">(</span>snd <span class="skolem">cf2</span><span class="main">)</span> <span class="bound">j</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> cont<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">q</span> <span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">q</span><span class="main">∈</span><span class="skolem">P</span> <span class="main">⟹</span> <span class="bound">q</span><span class="main">≠</span><span class="skolem">I0</span> <span class="main">⟹</span> <span class="bound">i</span><span class="main">∈</span><span class="bound">q</span> <span class="main">⟹</span> <span class="bound">j</span><span class="main">∈</span><span class="skolem">F</span> <span class="bound">q</span> <span class="main">⟹</span> cont <span class="main">(</span>fst <span class="skolem">cf1</span><span class="main">)</span> <span class="main">(</span>snd <span class="skolem">cf1</span><span class="main">)</span> <span class="bound">i</span> <span class="main">≈01</span> cont <span class="main">(</span>fst <span class="skolem">cf2</span><span class="main">)</span> <span class="main">(</span>snd <span class="skolem">cf2</span><span class="main">)</span> <span class="bound">j</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> wt<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">I</span><span class="main">.</span> <span class="bound">I</span> <span class="main">∈</span> <span class="skolem">P</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">I0</span><span class="main">}</span> <span class="main">⟹</span> <span class="skolem">W</span> <span class="skolem">cf1</span> <span class="skolem">I0</span> <span class="main">&lt;</span> <span class="main">1</span> <span class="main">⟹</span> <span class="skolem">W</span> <span class="skolem">cf2</span> <span class="main">(</span><span class="skolem">F</span> <span class="skolem">I0</span><span class="main">)</span> <span class="main">&lt;</span> <span class="main">1</span> <span class="main">⟹</span>
      <span class="skolem">W</span> <span class="skolem">cf1</span> <span class="bound">I</span> <span class="main">/</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="skolem">W</span> <span class="skolem">cf1</span> <span class="skolem">I0</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">W</span> <span class="skolem">cf2</span> <span class="main">(</span><span class="skolem">F</span> <span class="bound">I</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="skolem">W</span> <span class="skolem">cf2</span> <span class="main">(</span><span class="skolem">F</span> <span class="skolem">I0</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> I0<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="skolem">I0</span> <span class="main">⟹</span> snd <span class="skolem">cf1</span> <span class="main">≈</span> eff <span class="main">(</span>fst <span class="skolem">cf1</span><span class="main">)</span> <span class="main">(</span>snd <span class="skolem">cf1</span><span class="main">)</span> <span class="bound">i</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="skolem">I0</span> <span class="main">⟹</span> cont <span class="main">(</span>fst <span class="skolem">cf1</span><span class="main">)</span> <span class="main">(</span>snd <span class="skolem">cf1</span><span class="main">)</span> <span class="bound">i</span> <span class="main">≈01</span> fst <span class="skolem">cf2</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> FI0<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="skolem">F</span> <span class="skolem">I0</span> <span class="main">⟹</span> snd <span class="skolem">cf2</span> <span class="main">≈</span> eff <span class="main">(</span>fst <span class="skolem">cf2</span><span class="main">)</span> <span class="main">(</span>snd <span class="skolem">cf2</span><span class="main">)</span> <span class="bound">i</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="skolem">F</span> <span class="skolem">I0</span> <span class="main">⟹</span> fst <span class="skolem">cf1</span> <span class="main">≈01</span> cont <span class="main">(</span>fst <span class="skolem">cf2</span><span class="main">)</span> <span class="main">(</span>snd <span class="skolem">cf2</span><span class="main">)</span> <span class="bound">i</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> mC_ZOC_def mC_ZOC_part_def mC_ZOC_eff_cont_def mC_ZOC_eff_cont0_def mC_ZOC_wt_def W_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="skolem">P</span>"</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="skolem">F</span> <span class="main">(</span><span class="skolem">P</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">I0</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> FP'<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="skolem">F</span><span class="main">`</span><span class="skolem">P</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">F</span> <span class="skolem">I0</span> <span class="main">∈</span> <span class="skolem">F</span><span class="main">`</span><span class="skolem">P</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> finite_part<span class="main">[</span><span class="operator">OF</span> _ P<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> finite_part<span class="main">[</span><span class="operator">OF</span> _ FP<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="skolem">I0</span> <span class="main">∈</span> <span class="skolem">P</span>›</span></span> <span class="quoted"><span class="quoted">‹inj_on <span class="skolem">F</span> <span class="skolem">P</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> inj_on_diff<span class="main">)</span>

  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">I</span> <span class="skolem">i</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">I</span> <span class="main">∈</span> <span class="skolem">P</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="skolem">I</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> P <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> wt <span class="main">(</span>fst <span class="skolem">cf1</span><span class="main">)</span> <span class="main">(</span>snd <span class="skolem">cf1</span><span class="main">)</span> <span class="skolem">i</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> part_is_subset <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> wt_ge_0<span class="main">)</span> <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">note</span></span> wt1_nneg<span class="main">[</span><span class="operator">intro</span><span class="main">]</span> <span class="main">=</span> this

  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">I</span> <span class="skolem">i</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">I</span> <span class="main">∈</span> <span class="skolem">P</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="skolem">F</span> <span class="skolem">I</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> FP <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> wt <span class="main">(</span>fst <span class="skolem">cf2</span><span class="main">)</span> <span class="main">(</span>snd <span class="skolem">cf2</span><span class="main">)</span> <span class="skolem">i</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> part_is_subset <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> wt_ge_0<span class="main">)</span> <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">note</span></span> wt2_nneg<span class="main">[</span><span class="operator">intro</span><span class="main">]</span> <span class="main">=</span> this

  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">I</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">I</span> <span class="main">∈</span> <span class="skolem">P</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="skolem">W</span> <span class="skolem">cf1</span> <span class="skolem">I</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> W_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sum_nonneg<span class="main">)</span> <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">note</span></span> W1_nneg<span class="main">[</span><span class="operator">intro</span><span class="main">]</span> <span class="main">=</span> this

  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">I</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">I</span> <span class="main">∈</span> <span class="skolem">P</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="skolem">W</span> <span class="skolem">cf2</span> <span class="main">(</span><span class="skolem">F</span> <span class="skolem">I</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> W_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sum_nonneg<span class="main">)</span> <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">note</span></span> W2_nneg<span class="main">[</span><span class="operator">intro</span><span class="main">]</span> <span class="main">=</span> this

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span> <span class="skolem">cf1</span> <span class="skolem">cf2</span> <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="skolem">cf1</span> <span class="main">≈01</span> fst <span class="skolem">cf2</span>"</span></span> <span class="quoted"><span class="quoted">"snd <span class="skolem">cf1</span> <span class="main">≈</span> snd <span class="skolem">cf2</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dist <span class="main">(</span><span class="free">Ps</span> <span class="skolem">cf1</span><span class="main">)</span> <span class="main">(</span><span class="free">Ps</span> <span class="skolem">cf2</span><span class="main">)</span> <span class="main">≤</span> <span class="free">Pn</span> <span class="skolem">cf1</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
        <span class="keyword3"><span class="command">assume</span></span> cf1<span class="main">:</span> <span class="quoted"><span class="quoted">"discrCf <span class="skolem">cf1</span>"</span></span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">note</span></span> cf2 <span class="main">=</span> ZObis_pres_discrCfR<span class="main">[</span><span class="operator">OF</span> cf1 *<span class="main">]</span>
        <span class="keyword1"><span class="command">from</span></span> cf1 cf2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="skolem">cf1</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">bT</span><span class="main">.</span> snd <span class="skolem">cf1</span> <span class="main">≈</span> <span class="free">s</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="skolem">cf2</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">bT</span><span class="main">.</span> snd <span class="skolem">cf2</span> <span class="main">≈</span> <span class="free">s</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> S_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> enat_0<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹snd <span class="skolem">cf1</span> <span class="main">≈</span> snd <span class="skolem">cf2</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd <span class="skolem">cf1</span> <span class="main">≈</span> <span class="free">s</span> <span class="main">⟷</span> snd <span class="skolem">cf2</span> <span class="main">≈</span> <span class="free">s</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> indis_sym indis_trans<span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> T.prob_space <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"snd <span class="skolem">cf2</span> <span class="main">≈</span> <span class="free">s</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Ps_def Pn_def measure_nonneg<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">assume</span></span> cf1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> discrCf <span class="skolem">cf1</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Pn</span> <span class="skolem">cf1</span> <span class="main">0</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> T.prob_space <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Pn_def N_def<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dist <span class="main">(</span><span class="free">Ps</span> <span class="skolem">cf1</span><span class="main">)</span> <span class="main">(</span><span class="free">Ps</span> <span class="skolem">cf2</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> dist_nonneg_bounded<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> u<span class="main"><span class="main">=</span></span><span class="quoted"><span class="main">1</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> l<span class="main"><span class="main">=</span></span><span class="quoted"><span class="main">0</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">Ps</span> <span class="skolem">cf1</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> y<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">Ps</span> <span class="skolem">cf2</span>"</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dist_real_def Ps_def measure_nonneg <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> abs_split<span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">note</span></span> base_case <span class="main">=</span> this

    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> <span class="skolem">m</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command"><span class="improper">with</span></span></span> T.prob_space <span class="quoted"><span class="quoted">‹fst <span class="skolem">cf1</span> <span class="main">≈01</span> fst <span class="skolem">cf2</span>›</span></span> <span class="quoted"><span class="quoted">‹snd <span class="skolem">cf1</span> <span class="main">≈</span> snd <span class="skolem">cf2</span>›</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dist <span class="main">(</span><span class="free">Ps</span> <span class="skolem">cf1</span><span class="main">)</span> <span class="main">(</span><span class="free">Ps</span> <span class="skolem">cf2</span><span class="main">)</span> <span class="main">≤</span> <span class="free">Pn</span> <span class="skolem">cf1</span> <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> base_case<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Ps_def Pn_def<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">Pn</span> <span class="skolem">cf2</span> <span class="skolem">m</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Pn_def measure_nonneg<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command"><span class="improper">with</span></span></span> T.prob_space <span class="quoted"><span class="quoted">‹fst <span class="skolem">cf1</span> <span class="main">≈01</span> fst <span class="skolem">cf2</span>›</span></span> <span class="quoted"><span class="quoted">‹snd <span class="skolem">cf1</span> <span class="main">≈</span> snd <span class="skolem">cf2</span>›</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dist <span class="main">(</span><span class="free">Ps</span> <span class="skolem">cf2</span><span class="main">)</span> <span class="main">(</span><span class="free">Ps</span> <span class="skolem">cf1</span><span class="main">)</span> <span class="main">≤</span> <span class="free">Pn</span> <span class="skolem">cf2</span> <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> base_case<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Ps_def Pn_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> indis_sym ZObis_sym<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">Pn</span> <span class="skolem">cf1</span> <span class="skolem">n</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Pn_def measure_nonneg<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dist_commute<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="skolem">n</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> <span class="skolem">m</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n'</span></span> <span class="skolem"><span class="skolem">m'</span></span> <span class="keyword2"><span class="keyword">where</span></span> nm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> Suc <span class="skolem">n'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">=</span> Suc <span class="skolem">m'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> nat.exhaust<span class="main">)</span>

    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">ps</span></span> <span class="skolem"><span class="skolem">pn</span></span>
      <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ps</span> <span class="skolem">cf</span> <span class="skolem">I</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">b</span><span class="main">∈</span><span class="skolem">I</span><span class="main">.</span> wt <span class="main">(</span>fst <span class="skolem">cf</span><span class="main">)</span> <span class="main">(</span>snd <span class="skolem">cf</span><span class="main">)</span> <span class="bound">b</span> <span class="main">/</span> <span class="skolem">W</span> <span class="skolem">cf</span> <span class="skolem">I</span> <span class="main">*</span> <span class="free">Ps</span> <span class="main">(</span>cont_eff <span class="skolem">cf</span> <span class="bound">b</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pn</span> <span class="skolem">cf</span> <span class="skolem">I</span> <span class="skolem">n</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">b</span><span class="main">∈</span><span class="skolem">I</span><span class="main">.</span> wt <span class="main">(</span>fst <span class="skolem">cf</span><span class="main">)</span> <span class="main">(</span>snd <span class="skolem">cf</span><span class="main">)</span> <span class="bound">b</span> <span class="main">/</span> <span class="skolem">W</span> <span class="skolem">cf</span> <span class="skolem">I</span> <span class="main">*</span> <span class="free">Pn</span> <span class="main">(</span>cont_eff <span class="skolem">cf</span> <span class="bound">b</span><span class="main">)</span> <span class="skolem">n</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">cf</span> <span class="skolem">I</span> <span class="skolem">n</span>

    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">I</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">I</span> <span class="main">∈</span> <span class="skolem">P</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">I</span> <span class="main">≠</span> <span class="skolem">I0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> W<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">W</span> <span class="skolem">cf1</span> <span class="skolem">I</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">W</span> <span class="skolem">cf2</span> <span class="main">(</span><span class="skolem">F</span> <span class="skolem">I</span><span class="main">)</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dist <span class="main">(</span><span class="skolem">ps</span> <span class="skolem">cf1</span> <span class="skolem">I</span><span class="main">)</span> <span class="main">(</span><span class="skolem">ps</span> <span class="skolem">cf2</span> <span class="main">(</span><span class="skolem">F</span> <span class="skolem">I</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">pn</span> <span class="skolem">cf1</span> <span class="skolem">I</span> <span class="skolem">n'</span> <span class="main">+</span> <span class="skolem">pn</span> <span class="skolem">cf2</span> <span class="main">(</span><span class="skolem">F</span> <span class="skolem">I</span><span class="main">)</span> <span class="skolem">m'</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> ps_def pn_def
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> dist_weighted_sum<span class="main">)</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="skolem">j</span> <span class="keyword3"><span class="command">assume</span></span> ij<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="skolem">I</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∈</span> <span class="skolem">F</span> <span class="skolem">I</span>"</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"wt <span class="main">(</span>fst <span class="skolem">cf1</span><span class="main">)</span> <span class="main">(</span>snd <span class="skolem">cf1</span><span class="main">)</span> <span class="skolem">i</span> <span class="main">/</span> <span class="skolem">W</span> <span class="skolem">cf1</span> <span class="skolem">I</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
          <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"wt <span class="main">(</span>fst <span class="skolem">cf2</span><span class="main">)</span> <span class="main">(</span>snd <span class="skolem">cf2</span><span class="main">)</span> <span class="skolem">j</span> <span class="main">/</span> <span class="skolem">W</span> <span class="skolem">cf2</span> <span class="main">(</span><span class="skolem">F</span> <span class="skolem">I</span><span class="main">)</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">I</span> <span class="main">∈</span> <span class="skolem">P</span>›</span></span> ij P<span class="main">(</span>2<span class="main">)</span> FP<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> br<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> brn <span class="main">(</span>fst <span class="skolem">cf1</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> brn <span class="main">(</span>fst <span class="skolem">cf2</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> part_is_subset<span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"dist <span class="main">(</span><span class="free">Ps</span> <span class="main">(</span>cont_eff <span class="skolem">cf1</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">Ps</span> <span class="main">(</span>cont_eff <span class="skolem">cf2</span> <span class="skolem">j</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span>
          <span class="free">Pn</span> <span class="main">(</span>cont_eff <span class="skolem">cf1</span> <span class="skolem">i</span><span class="main">)</span> <span class="skolem">n'</span> <span class="main">+</span> <span class="free">Pn</span> <span class="main">(</span>cont_eff <span class="skolem">cf2</span> <span class="skolem">j</span><span class="main">)</span> <span class="skolem">m'</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> less.hyps<span class="main">)</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n'</span> <span class="main">+</span> <span class="skolem">m'</span> <span class="main">&lt;</span> <span class="skolem">n</span> <span class="main">+</span> <span class="skolem">m</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> nm <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"proper <span class="main">(</span>fst <span class="main">(</span>cont_eff <span class="skolem">cf1</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"proper <span class="main">(</span>fst <span class="main">(</span>cont_eff <span class="skolem">cf2</span> <span class="skolem">j</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> br less.prems <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cont_eff<span class="main">)</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>cont_eff <span class="skolem">cf1</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">≈01</span> fst <span class="main">(</span>cont_eff <span class="skolem">cf2</span> <span class="skolem">j</span><span class="main">)</span>"</span></span>
            <span class="quoted"><span class="quoted">"snd <span class="main">(</span>cont_eff <span class="skolem">cf1</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">≈</span> snd <span class="main">(</span>cont_eff <span class="skolem">cf2</span> <span class="skolem">j</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> cont<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">I</span> <span class="main">∈</span> <span class="skolem">P</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">I</span> <span class="main">≠</span> <span class="skolem">I0</span>›</span></span> ij<span class="main">]</span> eff<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">I</span> <span class="main">∈</span> <span class="skolem">P</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">I</span> <span class="main">≠</span> <span class="skolem">I0</span>›</span></span> ij<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cont_eff<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">b</span><span class="main">∈</span><span class="skolem">F</span> <span class="skolem">I</span><span class="main">.</span> wt <span class="main">(</span>fst <span class="skolem">cf2</span><span class="main">)</span> <span class="main">(</span>snd <span class="skolem">cf2</span><span class="main">)</span> <span class="bound">b</span> <span class="main">/</span> <span class="skolem">W</span> <span class="skolem">cf2</span> <span class="main">(</span><span class="skolem">F</span> <span class="skolem">I</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">b</span><span class="main">∈</span><span class="skolem">I</span><span class="main">.</span> wt <span class="main">(</span>fst <span class="skolem">cf1</span><span class="main">)</span> <span class="main">(</span>snd <span class="skolem">cf1</span><span class="main">)</span> <span class="bound">b</span> <span class="main">/</span> <span class="skolem">W</span> <span class="skolem">cf1</span> <span class="skolem">I</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> W <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sum_divide_distrib<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> sum_nonneg W_def<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">note</span></span> dist_n'_m' <span class="main">=</span> this

    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">I</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">I</span> <span class="main">∈</span> <span class="skolem">P</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">I</span> <span class="main">≠</span> <span class="skolem">I0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> W<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">W</span> <span class="skolem">cf1</span> <span class="skolem">I</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟷</span> <span class="skolem">W</span> <span class="skolem">cf2</span> <span class="main">(</span><span class="skolem">F</span> <span class="skolem">I</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dist <span class="main">(</span><span class="skolem">ps</span> <span class="skolem">cf1</span> <span class="skolem">I</span><span class="main">)</span> <span class="main">(</span><span class="skolem">ps</span> <span class="skolem">cf2</span> <span class="main">(</span><span class="skolem">F</span> <span class="skolem">I</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">pn</span> <span class="skolem">cf1</span> <span class="skolem">I</span> <span class="skolem">n'</span> <span class="main">+</span> <span class="skolem">pn</span> <span class="skolem">cf2</span> <span class="main">(</span><span class="skolem">F</span> <span class="skolem">I</span><span class="main">)</span> <span class="skolem">m'</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">W</span> <span class="skolem">cf2</span> <span class="main">(</span><span class="skolem">F</span> <span class="skolem">I</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">W</span> <span class="skolem">cf2</span> <span class="main">(</span><span class="skolem">F</span> <span class="skolem">I</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">W</span> <span class="skolem">cf1</span> <span class="skolem">I</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> W<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ps_def pn_def<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">W</span> <span class="skolem">cf2</span> <span class="main">(</span><span class="skolem">F</span> <span class="skolem">I</span><span class="main">)</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">W</span> <span class="skolem">cf1</span> <span class="skolem">I</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">W</span> <span class="skolem">cf2</span> <span class="main">(</span><span class="skolem">F</span> <span class="skolem">I</span><span class="main">)</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> W<span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> dist_n'_m'<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">I</span> <span class="main">∈</span> <span class="skolem">P</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">I</span> <span class="main">≠</span> <span class="skolem">I0</span>›</span></span> this<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">note</span></span> dist_n'_m'_W_iff <span class="main">=</span> this

    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">I</span> <span class="skolem">j</span> <span class="keyword3"><span class="command">assume</span></span> W<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">W</span> <span class="skolem">cf2</span> <span class="main">(</span><span class="skolem">F</span> <span class="skolem">I0</span><span class="main">)</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">I0</span> <span class="main">∈</span> <span class="skolem">P</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dist <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="main">{</span><span class="main">()</span><span class="main">}</span><span class="main">.</span> <span class="main">1</span> <span class="main">*</span> <span class="free">Ps</span> <span class="skolem">cf1</span><span class="main">)</span> <span class="main">(</span><span class="skolem">ps</span> <span class="skolem">cf2</span> <span class="main">(</span><span class="skolem">F</span> <span class="skolem">I0</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="main">{</span><span class="main">()</span><span class="main">}</span><span class="main">.</span> <span class="main">1</span> <span class="main">*</span> <span class="free">Pn</span> <span class="skolem">cf1</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">pn</span> <span class="skolem">cf2</span> <span class="main">(</span><span class="skolem">F</span> <span class="skolem">I0</span><span class="main">)</span> <span class="skolem">m'</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> ps_def pn_def
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> dist_weighted_sum<span class="main">)</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∈</span> <span class="skolem">F</span> <span class="skolem">I0</span>"</span></span>
        <span class="keyword1"><span class="command">with</span></span> FP<span class="main">(</span>2<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="skolem">I0</span> <span class="main">∈</span> <span class="skolem">P</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> br<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> brn <span class="main">(</span>fst <span class="skolem">cf2</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> part_is_subset<span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"dist <span class="main">(</span><span class="free">Ps</span> <span class="skolem">cf1</span><span class="main">)</span> <span class="main">(</span><span class="free">Ps</span> <span class="main">(</span>cont_eff <span class="skolem">cf2</span> <span class="skolem">j</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="free">Pn</span> <span class="skolem">cf1</span> <span class="skolem">n</span> <span class="main">+</span> <span class="free">Pn</span> <span class="main">(</span>cont_eff <span class="skolem">cf2</span> <span class="skolem">j</span><span class="main">)</span> <span class="skolem">m'</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> less.hyps<span class="main">)</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">+</span> <span class="skolem">m'</span> <span class="main">&lt;</span> <span class="skolem">n</span> <span class="main">+</span> <span class="skolem">m</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> nm <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"proper <span class="main">(</span>fst <span class="skolem">cf1</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"proper <span class="main">(</span>fst <span class="main">(</span>cont_eff <span class="skolem">cf2</span> <span class="skolem">j</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> br <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cont_eff<span class="main">)</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fst <span class="skolem">cf1</span> <span class="main">≈01</span> fst <span class="main">(</span>cont_eff <span class="skolem">cf2</span> <span class="skolem">j</span><span class="main">)</span>"</span></span>
            <span class="quoted"><span class="quoted">"snd <span class="skolem">cf1</span> <span class="main">≈</span> snd <span class="main">(</span>cont_eff <span class="skolem">cf2</span> <span class="skolem">j</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> FI0<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted"><span class="quoted">‹<span class="skolem"><span class="skolem">j</span></span> <span class="main"><span class="main">∈</span></span> <span class="skolem"><span class="skolem">F</span></span> <span class="skolem"><span class="skolem">I0</span></span>›</span></span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹snd <span class="skolem">cf1</span> <span class="main">≈</span> snd <span class="skolem">cf2</span>›</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cont_eff <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> indis_trans<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">b</span><span class="main">∈</span><span class="skolem">F</span> <span class="skolem">I0</span><span class="main">.</span> wt <span class="main">(</span>fst <span class="skolem">cf2</span><span class="main">)</span> <span class="main">(</span>snd <span class="skolem">cf2</span><span class="main">)</span> <span class="bound">b</span> <span class="main">/</span> <span class="skolem">W</span> <span class="skolem">cf2</span> <span class="main">(</span><span class="skolem">F</span> <span class="skolem">I0</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> W <span class="quoted"><span class="quoted">‹<span class="skolem">I0</span> <span class="main">∈</span> <span class="skolem">P</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sum_divide_distrib<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> sum_nonneg W_def<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dist <span class="main">(</span><span class="free">Ps</span> <span class="skolem">cf1</span><span class="main">)</span> <span class="main">(</span><span class="skolem">ps</span> <span class="skolem">cf2</span> <span class="main">(</span><span class="skolem">F</span> <span class="skolem">I0</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="free">Pn</span> <span class="skolem">cf1</span> <span class="skolem">n</span> <span class="main">+</span> <span class="skolem">pn</span> <span class="skolem">cf2</span> <span class="main">(</span><span class="skolem">F</span> <span class="skolem">I0</span><span class="main">)</span> <span class="skolem">m'</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">note</span></span> dist_n_m' <span class="main">=</span> this

    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">I</span> <span class="skolem">j</span> <span class="keyword3"><span class="command">assume</span></span> W<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">W</span> <span class="skolem">cf1</span> <span class="skolem">I0</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">I0</span> <span class="main">∈</span> <span class="skolem">P</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dist <span class="main">(</span><span class="skolem">ps</span> <span class="skolem">cf1</span> <span class="skolem">I0</span><span class="main">)</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="main">{</span><span class="main">()</span><span class="main">}</span><span class="main">.</span> <span class="main">1</span> <span class="main">*</span> <span class="free">Ps</span> <span class="skolem">cf2</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">pn</span> <span class="skolem">cf1</span> <span class="skolem">I0</span> <span class="skolem">n'</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="main">{</span><span class="main">()</span><span class="main">}</span><span class="main">.</span> <span class="main">1</span> <span class="main">*</span> <span class="free">Pn</span> <span class="skolem">cf2</span> <span class="skolem">m</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> ps_def pn_def
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> dist_weighted_sum<span class="main">)</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="skolem">I0</span>"</span></span>
        <span class="keyword1"><span class="command">with</span></span> P<span class="main">(</span>2<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="skolem">I0</span> <span class="main">∈</span> <span class="skolem">P</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> br<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> brn <span class="main">(</span>fst <span class="skolem">cf1</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> part_is_subset<span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"dist <span class="main">(</span><span class="free">Ps</span> <span class="main">(</span>cont_eff <span class="skolem">cf1</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">Ps</span> <span class="skolem">cf2</span><span class="main">)</span> <span class="main">≤</span> <span class="free">Pn</span> <span class="main">(</span>cont_eff <span class="skolem">cf1</span> <span class="skolem">i</span><span class="main">)</span> <span class="skolem">n'</span> <span class="main">+</span> <span class="free">Pn</span> <span class="skolem">cf2</span> <span class="skolem">m</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> less.hyps<span class="main">)</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n'</span> <span class="main">+</span> <span class="skolem">m</span> <span class="main">&lt;</span> <span class="skolem">n</span> <span class="main">+</span> <span class="skolem">m</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> nm <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"proper <span class="main">(</span>fst <span class="main">(</span>cont_eff <span class="skolem">cf1</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"proper <span class="main">(</span>fst <span class="skolem">cf2</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> br less.prems <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cont_eff<span class="main">)</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>cont_eff <span class="skolem">cf1</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">≈01</span> fst <span class="skolem">cf2</span>"</span></span>
            <span class="quoted"><span class="quoted">"snd <span class="main">(</span>cont_eff <span class="skolem">cf1</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">≈</span> snd <span class="skolem">cf2</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> I0<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted"><span class="quoted">‹<span class="skolem"><span class="skolem">i</span></span> <span class="main"><span class="main">∈</span></span> <span class="skolem"><span class="skolem">I0</span></span>›</span></span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹snd <span class="skolem">cf1</span> <span class="main">≈</span> snd <span class="skolem">cf2</span>›</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cont_eff <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> indis_trans indis_sym<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">b</span><span class="main">∈</span><span class="skolem">I0</span><span class="main">.</span> wt <span class="main">(</span>fst <span class="skolem">cf1</span><span class="main">)</span> <span class="main">(</span>snd <span class="skolem">cf1</span><span class="main">)</span> <span class="bound">b</span> <span class="main">/</span> <span class="skolem">W</span> <span class="skolem">cf1</span> <span class="skolem">I0</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> W <span class="quoted"><span class="quoted">‹<span class="skolem">I0</span> <span class="main">∈</span> <span class="skolem">P</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sum_divide_distrib<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> sum_nonneg W_def<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dist <span class="main">(</span><span class="skolem">ps</span> <span class="skolem">cf1</span> <span class="skolem">I0</span><span class="main">)</span> <span class="main">(</span><span class="free">Ps</span> <span class="skolem">cf2</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">pn</span> <span class="skolem">cf1</span> <span class="skolem">I0</span> <span class="skolem">n'</span> <span class="main">+</span> <span class="free">Pn</span> <span class="skolem">cf2</span> <span class="skolem">m</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">note</span></span> dist_n'_m <span class="main">=</span> this

    <span class="keyword1"><span class="command">have</span></span> S_measurable<span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">cf</span><span class="main">.</span> Measurable.pred T.S <span class="main">(</span><span class="free">S</span> <span class="bound">cf</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> S_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">measurable</span>

    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">cf'</span> <span class="skolem">cf</span> <span class="keyword3"><span class="command">assume</span></span> cf<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"proper <span class="main">(</span>fst <span class="skolem">cf</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> cf'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">cf'</span> <span class="main">∈</span> G <span class="skolem">cf</span>"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?S</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">bT</span> <span class="bound">n</span><span class="main">.</span> qsend <span class="bound">bT</span> <span class="main">=</span> enat <span class="bound">n</span> <span class="main">∧</span> snd <span class="main">(</span><span class="bound">bT</span> <span class="main">!!</span> <span class="bound">n</span><span class="main">)</span> <span class="main">≈</span> <span class="free">s</span>"</span></span>
      <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">bT</span> <span class="skolem">n</span> <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?S</span> <span class="main">(</span><span class="skolem">cf</span> <span class="main">##</span> <span class="skolem">cf'</span> <span class="main">##</span> <span class="skolem">bT</span><span class="main">)</span> <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="skolem">cf'</span> <span class="skolem">bT</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> 0 <span class="keyword1"><span class="command">with</span></span> * cf' <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> S_def enat_0 sfirst_Stream G_eq <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="main">0</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
               <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> indis_trans indis_sym discrCf_eff_indis<span class="main">)</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="keyword1"><span class="command">with</span></span> * cf' <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="skolem">cf'</span> <span class="skolem">bT</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> eSuc_enat<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> sfirst_Stream S_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span> <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">bT</span> <span class="skolem">n</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?S</span> <span class="main">(</span><span class="skolem">cf'</span> <span class="main">##</span> <span class="skolem">bT</span><span class="main">)</span> <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">with</span></span> cf' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?S</span> <span class="main">(</span><span class="skolem">cf</span> <span class="main">##</span> <span class="skolem">cf'</span> <span class="main">##</span> <span class="skolem">bT</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">if</span> discrCf <span class="skolem">cf</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> Suc <span class="skolem">n</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> eSuc_enat<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> enat_0<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> sfirst_Stream G_eq <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>
             <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> indis_trans indis_sym discrCf_eff_indis<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="skolem">cf</span> <span class="main">(</span><span class="skolem">cf'</span> <span class="main">##</span> <span class="skolem">bT</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> S_def<span class="main">)</span> <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">AE</span> <span class="bound">bT</span> <span class="keyword1">in</span> T.T <span class="skolem">cf'</span><span class="main">.</span> <span class="free">S</span> <span class="skolem">cf</span> <span class="main">(</span><span class="skolem">cf'</span> <span class="main">##</span> <span class="bound">bT</span><span class="main">)</span> <span class="main">=</span> <span class="free">S</span> <span class="skolem">cf'</span> <span class="bound">bT</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> S_def<span class="main">)</span> <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">note</span></span> S_sets <span class="main">=</span> this

    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">cf</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'test</span><span class="main">,</span> <span class="tfree">'atom</span><span class="main">,</span> <span class="tfree">'choice</span><span class="main">)</span> cmd <span class="main">×</span> <span class="tfree">'state</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">P</span> <span class="skolem">I0</span> <span class="skolem">S</span> <span class="skolem">n</span> <span class="skolem">st</span>
      <span class="keyword3"><span class="command">assume</span></span> cf<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"proper <span class="main">(</span>fst <span class="skolem">cf</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> P<span class="main">:</span> <span class="quoted"><span class="quoted">"part <span class="main">{..&lt;</span>brn <span class="main">(</span>fst <span class="skolem">cf</span><span class="main">)</span><span class="main">}</span> <span class="skolem">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"finite <span class="skolem">P</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">I0</span> <span class="main">∈</span> <span class="skolem">P</span>"</span></span>

      <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">I</span> <span class="skolem">i</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">I</span> <span class="main">∈</span> <span class="skolem">P</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="skolem">I</span>"</span></span>
        <span class="keyword1"><span class="command">with</span></span> P <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> wt <span class="main">(</span>fst <span class="skolem">cf</span><span class="main">)</span> <span class="main">(</span>snd <span class="skolem">cf</span><span class="main">)</span> <span class="skolem">i</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> part_is_subset <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> wt_ge_0<span class="main">)</span> <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">note</span></span> wt_nneg<span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> this

      <span class="keyword3"><span class="command">assume</span></span> S_measurable<span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">cf</span> <span class="bound">n</span><span class="main">.</span> Measurable.pred T.S <span class="main">(</span><span class="main">λ</span><span class="bound">bT</span><span class="main">.</span> <span class="skolem">S</span> <span class="bound">cf</span> <span class="bound">n</span> <span class="bound">bT</span><span class="main">)</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> S_next<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">cf</span> <span class="bound">cf'</span> <span class="bound">n</span><span class="main">.</span> proper <span class="main">(</span>fst <span class="bound">cf</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">cf'</span> <span class="main">∈</span> G <span class="bound">cf</span> <span class="main">⟹</span>
          <span class="keyword1">AE</span> <span class="bound">bT</span> <span class="keyword1">in</span> T.T <span class="bound">cf'</span><span class="main">.</span> <span class="skolem">S</span> <span class="bound">cf</span> <span class="main">(</span>Suc <span class="bound">n</span><span class="main">)</span> <span class="main">(</span><span class="bound">cf'</span> <span class="main">##</span> <span class="bound">bT</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">S</span> <span class="bound">cf'</span> <span class="bound">n</span> <span class="bound">bT</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> finite_I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">I</span><span class="main">.</span> <span class="bound">I</span> <span class="main">∈</span> <span class="skolem">P</span> <span class="main">⟹</span> finite <span class="bound">I</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> finite_subset<span class="main">[</span><span class="operator">OF</span> part_is_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> P<span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">I</span><span class="main">.</span> <span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="bound">I</span><span class="main">.</span> wt <span class="main">(</span>fst <span class="skolem">cf</span><span class="main">)</span> <span class="main">(</span>snd <span class="skolem">cf</span><span class="main">)</span> <span class="bound">i</span> <span class="main">*</span> <span class="keyword1">𝒫(</span><span class="bound"><span class="bound">bT</span></span> <span class="keyword1">in</span> T.T <span class="main">(</span>cont_eff <span class="skolem"><span class="skolem">cf</span></span> <span class="bound"><span class="bound">i</span></span><span class="main">)</span><span class="main">.</span> <span class="skolem">S</span> <span class="main">(</span>cont_eff <span class="skolem">cf</span> <span class="bound">i</span><span class="main">)</span> <span class="skolem">n</span> <span class="bound">bT</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">I</span><span class="main">.</span> <span class="skolem">W</span> <span class="skolem">cf</span> <span class="bound">I</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="bound">I</span><span class="main">.</span> wt <span class="main">(</span>fst <span class="skolem">cf</span><span class="main">)</span> <span class="main">(</span>snd <span class="skolem">cf</span><span class="main">)</span> <span class="bound">i</span> <span class="main">/</span> <span class="skolem">W</span> <span class="skolem">cf</span> <span class="bound">I</span> <span class="main">*</span> <span class="keyword1">𝒫(</span><span class="bound"><span class="bound">bT</span></span> <span class="keyword1">in</span> T.T <span class="main">(</span>cont_eff <span class="skolem"><span class="skolem">cf</span></span> <span class="bound"><span class="bound">i</span></span><span class="main">)</span><span class="main">.</span> <span class="skolem">S</span> <span class="main">(</span>cont_eff <span class="skolem">cf</span> <span class="bound">i</span><span class="main">)</span> <span class="skolem">n</span> <span class="bound">bT</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝒫(</span><span class="bound"><span class="bound">bT</span></span> <span class="keyword1">in</span> T.T <span class="skolem"><span class="skolem">cf</span></span><span class="main">.</span> <span class="skolem">S</span> <span class="skolem">cf</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="bound">bT</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∫</span><span class="bound">cf'</span><span class="main">.</span> <span class="keyword1">𝒫(</span><span class="bound"><span class="bound">bT</span></span> <span class="keyword1">in</span> T.T <span class="bound"><span class="bound">cf'</span></span><span class="main">.</span> <span class="skolem">S</span> <span class="bound">cf'</span> <span class="skolem">n</span> <span class="bound">bT</span><span class="main">)</span> <span class="main">∂</span>trans <span class="skolem">cf</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> T.prob_T<span class="main"><span class="main">[</span></span><span class="operator">OF</span> S_measurable<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> integral_cong_AE<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> AE_measure_pmf_iff <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> T.prob_eq_AE S_next <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> space_T<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">I</span><span class="main">∈</span><span class="skolem">P</span><span class="main">.</span> <span class="var">?P</span> <span class="bound">I</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> integral_trans<span class="main">[</span><span class="operator">OF</span> cf<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> part_sum<span class="main"><span class="main">[</span></span><span class="operator">OF</span> P<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">I</span><span class="main">∈</span><span class="skolem">P</span><span class="main">.</span> <span class="var">?P'</span> <span class="bound">I</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> finite_I
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sum.cong <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum_distrib_left sum_nonneg_eq_0_iff W_def<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="var">?P'</span> <span class="skolem">I0</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">I</span><span class="main">∈</span><span class="skolem">P</span><span class="main">-</span><span class="main">{</span><span class="skolem">I0</span><span class="main">}</span><span class="main">.</span> <span class="var">?P'</span> <span class="bound">I</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> sum.remove<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹finite <span class="skolem">P</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">I0</span> <span class="main">∈</span> <span class="skolem">P</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝒫(</span><span class="bound"><span class="bound">bT</span></span> <span class="keyword1">in</span> T.T <span class="skolem"><span class="skolem">cf</span></span><span class="main">.</span> <span class="skolem">S</span> <span class="skolem">cf</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="bound">bT</span><span class="main">)</span> <span class="main">=</span> <span class="main">…</span>"</span></span> <span class="keyword1"><span class="command">.</span></span> <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">note</span></span> P_split <span class="main">=</span> this

    <span class="keyword1"><span class="command">have</span></span> Ps1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Ps</span> <span class="skolem">cf1</span> <span class="main">=</span> <span class="skolem">W</span> <span class="skolem">cf1</span> <span class="skolem">I0</span> <span class="main">*</span> <span class="skolem">ps</span> <span class="skolem">cf1</span> <span class="skolem">I0</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">I</span><span class="main">∈</span><span class="skolem">P</span><span class="main">-</span><span class="main">{</span><span class="skolem">I0</span><span class="main">}</span><span class="main">.</span> <span class="skolem">W</span> <span class="skolem">cf1</span> <span class="bound">I</span> <span class="main">*</span> <span class="skolem">ps</span> <span class="skolem">cf1</span> <span class="bound">I</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> Ps_def ps_def <span class="keyword1"><span class="command">using</span></span> P<span class="main">(</span>2<span class="main">)</span> <span class="quoted"><span class="quoted">‹finite <span class="skolem">P</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">I0</span> <span class="main">∈</span> <span class="skolem">P</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> P_split S_sets<span class="main">)</span> <span class="operator">simp_all</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Ps</span> <span class="skolem">cf2</span> <span class="main">=</span> <span class="skolem">W</span> <span class="skolem">cf2</span> <span class="main">(</span><span class="skolem">F</span> <span class="skolem">I0</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">ps</span> <span class="skolem">cf2</span> <span class="main">(</span><span class="skolem">F</span> <span class="skolem">I0</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">I</span><span class="main">∈</span><span class="skolem">F</span><span class="main">`</span><span class="skolem">P</span><span class="main">-</span><span class="main">{</span><span class="skolem">F</span> <span class="skolem">I0</span><span class="main">}</span><span class="main">.</span> <span class="skolem">W</span> <span class="skolem">cf2</span> <span class="bound">I</span> <span class="main">*</span> <span class="skolem">ps</span> <span class="skolem">cf2</span> <span class="bound">I</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> Ps_def ps_def <span class="keyword1"><span class="command">using</span></span> FP<span class="main">(</span>2<span class="main">)</span> <span class="quoted"><span class="quoted">‹finite <span class="skolem">P</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">I0</span> <span class="main">∈</span> <span class="skolem">P</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> P_split S_sets<span class="main">)</span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> F_diff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">F</span> <span class="main">`</span> <span class="skolem">P</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">F</span> <span class="skolem">I0</span><span class="main">}</span> <span class="main">=</span> <span class="skolem">F</span> <span class="main">`</span> <span class="main">(</span><span class="skolem">P</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">I0</span><span class="main">}</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹inj_on <span class="skolem">F</span> <span class="skolem">P</span>›</span></span><span class="main"><span class="main">[</span></span><span class="operator">THEN</span> inj_on_eq_iff<span class="main"><span class="main">]</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">I0</span> <span class="main">∈</span> <span class="skolem">P</span>›</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> Ps2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Ps</span> <span class="skolem">cf2</span> <span class="main">=</span> <span class="skolem">W</span> <span class="skolem">cf2</span> <span class="main">(</span><span class="skolem">F</span> <span class="skolem">I0</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">ps</span> <span class="skolem">cf2</span> <span class="main">(</span><span class="skolem">F</span> <span class="skolem">I0</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">I</span><span class="main">∈</span><span class="skolem">P</span><span class="main">-</span><span class="main">{</span><span class="skolem">I0</span><span class="main">}</span><span class="main">.</span> <span class="skolem">W</span> <span class="skolem">cf2</span> <span class="main">(</span><span class="skolem">F</span> <span class="bound">I</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">ps</span> <span class="skolem">cf2</span> <span class="main">(</span><span class="skolem">F</span> <span class="bound">I</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum.reindex <span class="quoted"><span class="quoted">‹inj_on <span class="skolem">F</span> <span class="main">(</span><span class="skolem">P</span><span class="main">-</span><span class="main">{</span><span class="skolem">I0</span><span class="main">}</span><span class="main">)</span>›</span></span><span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> Pn1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Pn</span> <span class="skolem">cf1</span> <span class="skolem">n</span> <span class="main">=</span> <span class="skolem">W</span> <span class="skolem">cf1</span> <span class="skolem">I0</span> <span class="main">*</span> <span class="skolem">pn</span> <span class="skolem">cf1</span> <span class="skolem">I0</span> <span class="skolem">n'</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">I</span><span class="main">∈</span><span class="skolem">P</span><span class="main">-</span><span class="main">{</span><span class="skolem">I0</span><span class="main">}</span><span class="main">.</span> <span class="skolem">W</span> <span class="skolem">cf1</span> <span class="bound">I</span> <span class="main">*</span> <span class="skolem">pn</span> <span class="skolem">cf1</span> <span class="bound">I</span> <span class="skolem">n'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> Pn_def pn_def nm <span class="keyword1"><span class="command">using</span></span> P<span class="main">(</span>2<span class="main">)</span> <span class="quoted"><span class="quoted">‹finite <span class="skolem">P</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">I0</span> <span class="main">∈</span> <span class="skolem">P</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> P_split<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> N_def<span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Pn</span> <span class="skolem">cf2</span> <span class="skolem">m</span> <span class="main">=</span> <span class="skolem">W</span> <span class="skolem">cf2</span> <span class="main">(</span><span class="skolem">F</span> <span class="skolem">I0</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">pn</span> <span class="skolem">cf2</span> <span class="main">(</span><span class="skolem">F</span> <span class="skolem">I0</span><span class="main">)</span> <span class="skolem">m'</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">I</span><span class="main">∈</span><span class="skolem">F</span><span class="main">`</span><span class="skolem">P</span><span class="main">-</span><span class="main">{</span><span class="skolem">F</span> <span class="skolem">I0</span><span class="main">}</span><span class="main">.</span> <span class="skolem">W</span> <span class="skolem">cf2</span> <span class="bound">I</span> <span class="main">*</span> <span class="skolem">pn</span> <span class="skolem">cf2</span> <span class="bound">I</span> <span class="skolem">m'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> Pn_def pn_def nm <span class="keyword1"><span class="command">using</span></span> FP<span class="main">(</span>2<span class="main">)</span> <span class="quoted"><span class="quoted">‹finite <span class="skolem">P</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">I0</span> <span class="main">∈</span> <span class="skolem">P</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> P_split<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> N_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> F_diff <span class="keyword1"><span class="command">have</span></span> Pn2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Pn</span> <span class="skolem">cf2</span> <span class="skolem">m</span> <span class="main">=</span> <span class="skolem">W</span> <span class="skolem">cf2</span> <span class="main">(</span><span class="skolem">F</span> <span class="skolem">I0</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">pn</span> <span class="skolem">cf2</span> <span class="main">(</span><span class="skolem">F</span> <span class="skolem">I0</span><span class="main">)</span> <span class="skolem">m'</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">I</span><span class="main">∈</span><span class="skolem">P</span><span class="main">-</span><span class="main">{</span><span class="skolem">I0</span><span class="main">}</span><span class="main">.</span> <span class="skolem">W</span> <span class="skolem">cf2</span> <span class="main">(</span><span class="skolem">F</span> <span class="bound">I</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">pn</span> <span class="skolem">cf2</span> <span class="main">(</span><span class="skolem">F</span> <span class="bound">I</span><span class="main">)</span> <span class="skolem">m'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum.reindex <span class="quoted"><span class="quoted">‹inj_on <span class="skolem">F</span> <span class="main">(</span><span class="skolem">P</span><span class="main">-</span><span class="main">{</span><span class="skolem">I0</span><span class="main">}</span><span class="main">)</span>›</span></span><span class="main">)</span>

    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">W</span> <span class="skolem">cf1</span> <span class="skolem">I0</span> <span class="main">=</span> <span class="main">1</span> <span class="main">∨</span> <span class="skolem">W</span> <span class="skolem">cf2</span> <span class="main">(</span><span class="skolem">F</span> <span class="skolem">I0</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span>
        <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">W</span> <span class="skolem">cf1</span> <span class="skolem">I0</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">W</span> <span class="skolem">cf1</span> <span class="skolem">I0</span> <span class="main">=</span> <span class="skolem">W</span> <span class="skolem">cf1</span> <span class="main">{..&lt;</span>brn <span class="main">(</span>fst <span class="skolem">cf1</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> W_def<span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="skolem">W</span> <span class="skolem">cf1</span> <span class="skolem">I0</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">I</span><span class="main">∈</span><span class="skolem">P</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">I0</span><span class="main">}</span><span class="main">.</span> <span class="skolem">W</span> <span class="skolem">cf1</span> <span class="bound">I</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹part <span class="main">{..&lt;</span>brn <span class="main">(</span>fst <span class="skolem">cf1</span><span class="main">)</span><span class="main">}</span> <span class="skolem">P</span>›</span></span><span class="main">[</span><span class="operator">THEN</span> part_sum<span class="main">]</span> W_def
          <span class="keyword1"><span class="command">unfolding</span></span> sum.remove<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹finite <span class="skolem">P</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">I0</span> <span class="main">∈</span> <span class="skolem">P</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">..</span></span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">I</span><span class="main">∈</span><span class="skolem">P</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">I0</span><span class="main">}</span><span class="main">.</span> <span class="skolem">W</span> <span class="skolem">cf1</span> <span class="bound">I</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">I</span><span class="main">∈</span><span class="skolem">P</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">I0</span><span class="main">}</span><span class="main">.</span> <span class="skolem">W</span> <span class="skolem">cf1</span> <span class="bound">I</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹finite <span class="skolem">P</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> sum_nonneg_eq_0_iff<span class="main">)</span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Ps</span> <span class="skolem">cf1</span> <span class="main">=</span> <span class="skolem">ps</span> <span class="skolem">cf1</span> <span class="skolem">I0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">Pn</span> <span class="skolem">cf1</span> <span class="skolem">n</span> <span class="main">=</span> <span class="skolem">pn</span> <span class="skolem">cf1</span> <span class="skolem">I0</span> <span class="skolem">n'</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> Ps1 Pn1 * <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">note</span></span> dist_n'_m *
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">W</span> <span class="skolem">cf2</span> <span class="main">(</span><span class="skolem">F</span> <span class="skolem">I0</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">W</span> <span class="skolem">cf2</span> <span class="main">(</span><span class="skolem">F</span> <span class="skolem">I0</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">W</span> <span class="skolem">cf2</span> <span class="main">{..&lt;</span>brn <span class="main">(</span>fst <span class="skolem">cf2</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> W_def<span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="skolem">W</span> <span class="skolem">cf2</span> <span class="main">(</span><span class="skolem">F</span> <span class="skolem">I0</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">I</span><span class="main">∈</span><span class="skolem">F</span> <span class="main">`</span> <span class="skolem">P</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">F</span> <span class="skolem">I0</span><span class="main">}</span><span class="main">.</span> <span class="skolem">W</span> <span class="skolem">cf2</span> <span class="bound">I</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> FP<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">THEN</span> part_sum<span class="main">]</span> W_def
          <span class="keyword1"><span class="command">unfolding</span></span> sum.remove<span class="main">[</span><span class="operator">OF</span> FP'<span class="main">]</span> <span class="keyword1"><span class="command">..</span></span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">I</span><span class="main">∈</span><span class="skolem">F</span><span class="main">`</span><span class="skolem">P</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">F</span> <span class="skolem">I0</span><span class="main">}</span><span class="main">.</span> <span class="skolem">W</span> <span class="skolem">cf2</span> <span class="bound">I</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">I</span><span class="main">∈</span><span class="skolem">F</span><span class="main">`</span><span class="skolem">P</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">F</span> <span class="skolem">I0</span><span class="main">}</span><span class="main">.</span> <span class="skolem">W</span> <span class="skolem">cf2</span> <span class="bound">I</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹finite <span class="skolem">P</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> sum_nonneg_eq_0_iff<span class="main">)</span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Ps</span> <span class="skolem">cf2</span> <span class="main">=</span> <span class="skolem">ps</span> <span class="skolem">cf2</span> <span class="main">(</span><span class="skolem">F</span> <span class="skolem">I0</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">Pn</span> <span class="skolem">cf2</span> <span class="skolem">m</span> <span class="main">=</span> <span class="skolem">pn</span> <span class="skolem">cf2</span> <span class="main">(</span><span class="skolem">F</span> <span class="skolem">I0</span><span class="main">)</span> <span class="skolem">m'</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> Ps2 Pn2 * <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> F_diff<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">note</span></span> dist_n_m' *
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> W_neq1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="skolem">W</span> <span class="skolem">cf1</span> <span class="skolem">I0</span> <span class="main">=</span> <span class="main">1</span> <span class="main">∨</span> <span class="skolem">W</span> <span class="skolem">cf2</span> <span class="main">(</span><span class="skolem">F</span> <span class="skolem">I0</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">cf</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'test</span><span class="main">,</span> <span class="tfree">'atom</span><span class="main">,</span> <span class="tfree">'choice</span><span class="main">)</span> cmd <span class="main">×</span> <span class="tfree">'state</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">I</span> <span class="skolem">P</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"proper <span class="main">(</span>fst <span class="skolem">cf</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"part <span class="main">{..&lt;</span>brn <span class="main">(</span>fst <span class="main">(</span><span class="skolem">cf</span><span class="main">)</span><span class="main">)</span><span class="main">}</span> <span class="skolem">P</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">I</span> <span class="main">∈</span> <span class="skolem">P</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">W</span> <span class="skolem">cf</span> <span class="skolem">I</span> <span class="main">≤</span> <span class="skolem">W</span> <span class="skolem">cf</span> <span class="main">{..&lt;</span>brn <span class="main">(</span>fst <span class="main">(</span><span class="skolem">cf</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> W_def
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum_mono2 part_is_subset<span class="main">)</span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">W</span> <span class="skolem">cf</span> <span class="skolem">I</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹proper <span class="main">(</span>fst <span class="skolem">cf</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> W_def<span class="main">)</span> <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> wt_less1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">W</span> <span class="skolem">cf1</span> <span class="skolem">I0</span> <span class="main">&lt;</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">W</span> <span class="skolem">cf2</span> <span class="main">(</span><span class="skolem">F</span> <span class="skolem">I0</span><span class="main">)</span> <span class="main">&lt;</span> <span class="main">1</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> FP<span class="main">(</span>2<span class="main">)</span> FP'<span class="main">(</span>2<span class="main">)</span> P<span class="main">(</span>2<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="skolem">I0</span> <span class="main">∈</span> <span class="skolem">P</span>›</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> le_less <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>

      <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">I</span> <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">I</span> <span class="main">∈</span> <span class="skolem">P</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">I0</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">W</span> <span class="skolem">cf1</span> <span class="skolem">I</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟷</span> <span class="skolem">W</span> <span class="skolem">cf2</span> <span class="main">(</span><span class="skolem">F</span> <span class="skolem">I</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> wt<span class="main">[</span><span class="operator">OF</span> * wt_less1<span class="main">]</span> wt_less1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">with</span></span> * <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dist <span class="main">(</span><span class="skolem">ps</span> <span class="skolem">cf1</span> <span class="skolem">I</span><span class="main">)</span> <span class="main">(</span><span class="skolem">ps</span> <span class="skolem">cf2</span> <span class="main">(</span><span class="skolem">F</span> <span class="skolem">I</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">pn</span> <span class="skolem">cf1</span> <span class="skolem">I</span> <span class="skolem">n'</span> <span class="main">+</span> <span class="skolem">pn</span> <span class="skolem">cf2</span> <span class="main">(</span><span class="skolem">F</span> <span class="skolem">I</span><span class="main">)</span> <span class="skolem">m'</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> dist_n'_m'_W_iff<span class="main">)</span> <span class="operator">auto</span> <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">note</span></span> dist_eps <span class="main">=</span> this

      <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="skolem">b</span> <span class="skolem">c</span> <span class="skolem">d</span> <span class="main">::</span> <span class="quoted">real</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dist <span class="skolem">a</span> <span class="skolem">b</span> <span class="main">=</span> dist <span class="main">(</span><span class="main">(</span><span class="skolem">a</span> <span class="main">-</span> <span class="skolem">c</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">c</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="skolem">b</span> <span class="main">-</span> <span class="skolem">d</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">d</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> dist <span class="main">(</span><span class="skolem">a</span> <span class="main">-</span> <span class="skolem">c</span><span class="main">)</span> <span class="main">(</span><span class="skolem">b</span> <span class="main">-</span> <span class="skolem">d</span><span class="main">)</span> <span class="main">+</span> dist <span class="skolem">c</span> <span class="skolem">d</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> dist_triangle_add <span class="keyword1"><span class="command">.</span></span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dist <span class="skolem">a</span> <span class="skolem">b</span> <span class="main">≤</span> dist <span class="main">(</span><span class="skolem">a</span> <span class="main">-</span> <span class="skolem">c</span><span class="main">)</span> <span class="main">(</span><span class="skolem">b</span> <span class="main">-</span> <span class="skolem">d</span><span class="main">)</span> <span class="main">+</span> dist <span class="skolem">c</span> <span class="skolem">d</span>"</span></span> <span class="keyword1"><span class="command">.</span></span> <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">note</span></span> dist_triangle_diff <span class="main">=</span> this

      <span class="keyword1"><span class="command">have</span></span> dist_diff_diff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span> <span class="bound">b</span> <span class="bound">c</span> <span class="bound">d</span><span class="main">::</span>real<span class="main">.</span> dist <span class="main">(</span><span class="bound">a</span> <span class="main">-</span> <span class="bound">b</span><span class="main">)</span> <span class="main">(</span><span class="bound">c</span> <span class="main">-</span> <span class="bound">d</span><span class="main">)</span> <span class="main">≤</span> dist <span class="bound">a</span> <span class="bound">b</span> <span class="main">+</span> dist <span class="bound">c</span> <span class="bound">d</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> dist_real_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?v0</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">W</span> <span class="skolem">cf1</span> <span class="skolem">I0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="var"><span class="quoted"><span class="var">?w0</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">W</span> <span class="skolem">cf2</span> <span class="main">(</span><span class="skolem">F</span> <span class="skolem">I0</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?v1</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">-</span> <span class="var">?v0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="var"><span class="quoted"><span class="var">?w1</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">-</span> <span class="var">?w0</span>"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?wQ</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Ps</span> <span class="skolem">cf2</span> <span class="main">-</span> <span class="var">?w0</span> <span class="main">*</span> <span class="skolem">ps</span> <span class="skolem">cf2</span> <span class="main">(</span><span class="skolem">F</span> <span class="skolem">I0</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> <span class="var">?w1</span>"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?wP</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Ps</span> <span class="skolem">cf1</span> <span class="main">-</span> <span class="var">?v0</span> <span class="main">*</span> <span class="skolem">ps</span> <span class="skolem">cf1</span> <span class="skolem">I0</span><span class="main">)</span> <span class="main">/</span> <span class="var">?v1</span>"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?D</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?w0</span> <span class="main">*</span> <span class="var">?v1</span> <span class="main">*</span> <span class="free">Ps</span> <span class="skolem">cf1</span> <span class="main">+</span> <span class="var">?w1</span> <span class="main">*</span> <span class="var">?v0</span> <span class="main">*</span> <span class="skolem">ps</span> <span class="skolem">cf1</span> <span class="skolem">I0</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?E</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?v0</span> <span class="main">*</span> <span class="var">?w1</span> <span class="main">*</span> <span class="free">Ps</span> <span class="skolem">cf2</span> <span class="main">+</span> <span class="var">?v1</span> <span class="main">*</span> <span class="var">?w0</span> <span class="main">*</span> <span class="skolem">ps</span> <span class="skolem">cf2</span> <span class="main">(</span><span class="skolem">F</span> <span class="skolem">I0</span><span class="main">)</span><span class="main">)</span>"</span></span>

      <span class="keyword1"><span class="command">have</span></span> w0v0_less1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?w0</span> <span class="main">*</span> <span class="var">?v0</span> <span class="main">&lt;</span> <span class="main">1</span> <span class="main">*</span> <span class="main">1</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> wt_less1 <span class="quoted"><span class="quoted">‹<span class="skolem">I0</span> <span class="main">∈</span> <span class="skolem">P</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> mult_strict_mono<span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> neg_w0v0_nonneg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">-</span> <span class="var">?w0</span> <span class="main">*</span> <span class="var">?v0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?e1</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">I</span><span class="main">∈</span><span class="skolem">P</span><span class="main">-</span><span class="main">{</span><span class="skolem">I0</span><span class="main">}</span><span class="main">.</span> <span class="skolem">W</span> <span class="skolem">cf1</span> <span class="bound">I</span> <span class="main">/</span> <span class="var">?v1</span> <span class="main">*</span> <span class="skolem">pn</span> <span class="skolem">cf1</span> <span class="bound">I</span> <span class="skolem">n'</span><span class="main">)</span> <span class="main">+</span>
            <span class="main">(</span><span class="main">∑</span><span class="bound">I</span><span class="main">∈</span><span class="skolem">P</span><span class="main">-</span><span class="main">{</span><span class="skolem">I0</span><span class="main">}</span><span class="main">.</span> <span class="skolem">W</span> <span class="skolem">cf2</span> <span class="main">(</span><span class="skolem">F</span> <span class="bound">I</span><span class="main">)</span> <span class="main">/</span> <span class="var">?w1</span> <span class="main">*</span> <span class="skolem">pn</span> <span class="skolem">cf2</span> <span class="main">(</span><span class="skolem">F</span> <span class="bound">I</span><span class="main">)</span> <span class="skolem">m'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dist <span class="main">(</span><span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="var">?w0</span> <span class="main">*</span> <span class="var">?v0</span><span class="main">)</span> <span class="main">*</span> <span class="free">Ps</span> <span class="skolem">cf1</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="var">?w0</span> <span class="main">*</span> <span class="var">?v0</span><span class="main">)</span> <span class="main">*</span> <span class="free">Ps</span> <span class="skolem">cf2</span><span class="main">)</span> <span class="main">≤</span>
        dist <span class="main">(</span><span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="var">?w0</span> <span class="main">*</span> <span class="var">?v0</span><span class="main">)</span> <span class="main">*</span> <span class="free">Ps</span> <span class="skolem">cf1</span> <span class="main">-</span> <span class="var">?D</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="var">?w0</span> <span class="main">*</span> <span class="var">?v0</span><span class="main">)</span> <span class="main">*</span> <span class="free">Ps</span> <span class="skolem">cf2</span> <span class="main">-</span> <span class="var">?E</span><span class="main">)</span> <span class="main">+</span> dist <span class="var">?D</span> <span class="var">?E</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> dist_triangle_diff<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="var">?v1</span> <span class="main">*</span> <span class="var">?w1</span> <span class="main">*</span> <span class="var">?e1</span> <span class="main">+</span> <span class="main">(</span><span class="var">?v1</span> <span class="main">*</span> <span class="var">?w0</span> <span class="main">*</span> <span class="main">(</span><span class="free">Pn</span> <span class="skolem">cf1</span> <span class="skolem">n</span> <span class="main">+</span> <span class="skolem">pn</span> <span class="skolem">cf2</span> <span class="main">(</span><span class="skolem">F</span> <span class="skolem">I0</span><span class="main">)</span> <span class="skolem">m'</span><span class="main">)</span> <span class="main">+</span> <span class="var">?w1</span> <span class="main">*</span> <span class="var">?v0</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">pn</span> <span class="skolem">cf1</span> <span class="skolem">I0</span> <span class="skolem">n'</span> <span class="main">+</span> <span class="free">Pn</span> <span class="skolem">cf2</span> <span class="skolem">m</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> add_mono<span class="main">)</span>
        <span class="keyword1"><span class="command">{</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?wP</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">I</span><span class="main">∈</span><span class="skolem">P</span><span class="main">-</span><span class="main">{</span><span class="skolem">I0</span><span class="main">}</span><span class="main">.</span> <span class="skolem">W</span> <span class="skolem">cf1</span> <span class="bound">I</span> <span class="main">*</span> <span class="skolem">ps</span> <span class="skolem">cf1</span> <span class="bound">I</span><span class="main">)</span> <span class="main">/</span> <span class="var">?v1</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> Ps1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">I</span><span class="main">∈</span><span class="skolem">P</span><span class="main">-</span><span class="main">{</span><span class="skolem">I0</span><span class="main">}</span><span class="main">.</span> <span class="skolem">W</span> <span class="skolem">cf1</span> <span class="bound">I</span> <span class="main">/</span> <span class="var">?v1</span> <span class="main">*</span> <span class="skolem">ps</span> <span class="skolem">cf1</span> <span class="bound">I</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sum_divide_distrib<span class="main">)</span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?wP</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">I</span><span class="main">∈</span><span class="skolem">P</span><span class="main">-</span><span class="main">{</span><span class="skolem">I0</span><span class="main">}</span><span class="main">.</span> <span class="skolem">W</span> <span class="skolem">cf1</span> <span class="bound">I</span> <span class="main">/</span> <span class="var">?v1</span> <span class="main">*</span> <span class="skolem">ps</span> <span class="skolem">cf1</span> <span class="bound">I</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span> <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">{</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?wQ</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">I</span><span class="main">∈</span><span class="skolem">P</span><span class="main">-</span><span class="main">{</span><span class="skolem">I0</span><span class="main">}</span><span class="main">.</span> <span class="skolem">W</span> <span class="skolem">cf2</span> <span class="main">(</span><span class="skolem">F</span> <span class="bound">I</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">ps</span> <span class="skolem">cf2</span> <span class="main">(</span><span class="skolem">F</span> <span class="bound">I</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> <span class="var">?w1</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> Ps2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">I</span><span class="main">∈</span><span class="skolem">P</span><span class="main">-</span><span class="main">{</span><span class="skolem">I0</span><span class="main">}</span><span class="main">.</span> <span class="skolem">W</span> <span class="skolem">cf2</span> <span class="main">(</span><span class="skolem">F</span> <span class="bound">I</span><span class="main">)</span> <span class="main">/</span> <span class="var">?w1</span> <span class="main">*</span> <span class="skolem">ps</span> <span class="skolem">cf2</span> <span class="main">(</span><span class="skolem">F</span> <span class="bound">I</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sum_divide_distrib<span class="main">)</span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">I</span><span class="main">∈</span><span class="skolem">P</span><span class="main">-</span><span class="main">{</span><span class="skolem">I0</span><span class="main">}</span><span class="main">.</span> <span class="skolem">W</span> <span class="skolem">cf1</span> <span class="bound">I</span> <span class="main">/</span> <span class="var">?v1</span> <span class="main">*</span> <span class="skolem">ps</span> <span class="skolem">cf2</span> <span class="main">(</span><span class="skolem">F</span> <span class="bound">I</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> wt<span class="main">[</span><span class="operator">OF</span> _ wt_less1<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?wQ</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">I</span><span class="main">∈</span><span class="skolem">P</span><span class="main">-</span><span class="main">{</span><span class="skolem">I0</span><span class="main">}</span><span class="main">.</span> <span class="skolem">W</span> <span class="skolem">cf1</span> <span class="bound">I</span> <span class="main">/</span> <span class="var">?v1</span> <span class="main">*</span> <span class="skolem">ps</span> <span class="skolem">cf2</span> <span class="main">(</span><span class="skolem">F</span> <span class="bound">I</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span> <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword1"><span class="command">ultimately</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dist <span class="var">?wP</span> <span class="var">?wQ</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">I</span><span class="main">∈</span><span class="skolem">P</span><span class="main">-</span><span class="main">{</span><span class="skolem">I0</span><span class="main">}</span><span class="main">.</span> <span class="skolem">W</span> <span class="skolem">cf1</span> <span class="bound">I</span> <span class="main">/</span> <span class="var">?v1</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">pn</span> <span class="skolem">cf1</span> <span class="bound">I</span> <span class="skolem">n'</span> <span class="main">+</span> <span class="skolem">pn</span> <span class="skolem">cf2</span> <span class="main">(</span><span class="skolem">F</span> <span class="bound">I</span><span class="main">)</span> <span class="skolem">m'</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> wt_less1 dist_eps
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> dist_sum<span class="main">)</span>
             <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum_nonneg divide_le_cancel mult_le_cancel_left not_le<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> W1_nneg<span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="var">?e1</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> sum.distrib<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">using</span></span>  wt<span class="main">[</span><span class="operator">OF</span> _ wt_less1<span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span> add_divide_distrib<span class="main">)</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dist <span class="main">(</span><span class="var">?v1</span> <span class="main">*</span> <span class="var">?w1</span> <span class="main">*</span> <span class="var">?wP</span><span class="main">)</span> <span class="main">(</span><span class="var">?v1</span> <span class="main">*</span> <span class="var">?w1</span> <span class="main">*</span> <span class="var">?wQ</span><span class="main">)</span> <span class="main">≤</span> <span class="var">?v1</span> <span class="main">*</span> <span class="var">?w1</span> <span class="main">*</span> <span class="var">?e1</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> wt_less1 <span class="keyword1"><span class="command">unfolding</span></span> dist_mult <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">{</span></span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?v1</span> <span class="main">*</span> <span class="var">?w1</span> <span class="main">*</span> <span class="var">?wP</span> <span class="main">=</span> <span class="var">?w1</span> <span class="main">*</span> <span class="main">(</span><span class="var">?v0</span> <span class="main">*</span> <span class="free">Ps</span> <span class="skolem">cf1</span> <span class="main">+</span> <span class="var">?v1</span> <span class="main">*</span> <span class="free">Ps</span> <span class="skolem">cf1</span><span class="main">)</span> <span class="main">-</span> <span class="var">?w1</span> <span class="main">*</span> <span class="var">?v0</span> <span class="main">*</span> <span class="skolem">ps</span> <span class="skolem">cf1</span> <span class="skolem">I0</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> wt_less1 <span class="keyword1"><span class="command">unfolding</span></span> divide_eq_eq <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="var">?w0</span> <span class="main">*</span> <span class="var">?v0</span><span class="main">)</span> <span class="main">*</span> <span class="free">Ps</span> <span class="skolem">cf1</span> <span class="main">-</span> <span class="var">?D</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?v1</span> <span class="main">*</span> <span class="var">?w1</span> <span class="main">*</span> <span class="var">?wP</span> <span class="main">=</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="var">?w0</span> <span class="main">*</span> <span class="var">?v0</span><span class="main">)</span> <span class="main">*</span> <span class="free">Ps</span> <span class="skolem">cf1</span> <span class="main">-</span> <span class="var">?D</span>"</span></span> <span class="keyword1"><span class="command">.</span></span> <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">{</span></span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?v1</span> <span class="main">*</span> <span class="var">?w1</span> <span class="main">*</span> <span class="var">?wQ</span> <span class="main">=</span> <span class="var">?v1</span> <span class="main">*</span> <span class="main">(</span><span class="var">?w0</span> <span class="main">*</span> <span class="free">Ps</span> <span class="skolem">cf2</span> <span class="main">+</span> <span class="var">?w1</span> <span class="main">*</span> <span class="free">Ps</span> <span class="skolem">cf2</span><span class="main">)</span> <span class="main">-</span> <span class="var">?v1</span> <span class="main">*</span> <span class="var">?w0</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">ps</span> <span class="skolem">cf2</span> <span class="main">(</span><span class="skolem">F</span> <span class="skolem">I0</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> wt_less1 <span class="keyword1"><span class="command">unfolding</span></span> divide_eq_eq <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="var">?w0</span> <span class="main">*</span> <span class="var">?v0</span><span class="main">)</span> <span class="main">*</span> <span class="free">Ps</span> <span class="skolem">cf2</span> <span class="main">-</span> <span class="var">?E</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?v1</span> <span class="main">*</span> <span class="var">?w1</span> <span class="main">*</span> <span class="var">?wQ</span> <span class="main">=</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="var">?w0</span> <span class="main">*</span> <span class="var">?v0</span><span class="main">)</span> <span class="main">*</span> <span class="free">Ps</span> <span class="skolem">cf2</span> <span class="main">-</span> <span class="var">?E</span>"</span></span> <span class="keyword1"><span class="command">.</span></span> <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"dist <span class="main">(</span><span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="var">?w0</span> <span class="main">*</span> <span class="var">?v0</span><span class="main">)</span> <span class="main">*</span> <span class="free">Ps</span> <span class="skolem">cf1</span> <span class="main">-</span> <span class="var">?D</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="var">?w0</span> <span class="main">*</span> <span class="var">?v0</span><span class="main">)</span> <span class="main">*</span> <span class="free">Ps</span> <span class="skolem">cf2</span> <span class="main">-</span> <span class="var">?E</span><span class="main">)</span> <span class="main">≤</span> <span class="var">?v1</span> <span class="main">*</span> <span class="var">?w1</span> <span class="main">*</span> <span class="var">?e1</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dist <span class="var">?D</span> <span class="var">?E</span> <span class="main">=</span> dist
          <span class="main">(</span><span class="var">?v1</span> <span class="main">*</span> <span class="var">?w0</span> <span class="main">*</span> <span class="free">Ps</span> <span class="skolem">cf1</span> <span class="main">-</span> <span class="var">?v1</span> <span class="main">*</span> <span class="var">?w0</span> <span class="main">*</span> <span class="skolem">ps</span> <span class="skolem">cf2</span> <span class="main">(</span><span class="skolem">F</span> <span class="skolem">I0</span><span class="main">)</span><span class="main">)</span>
          <span class="main">(</span><span class="var">?w1</span> <span class="main">*</span> <span class="var">?v0</span> <span class="main">*</span> <span class="free">Ps</span> <span class="skolem">cf2</span> <span class="main">-</span> <span class="var">?w1</span> <span class="main">*</span> <span class="var">?v0</span> <span class="main">*</span> <span class="skolem">ps</span> <span class="skolem">cf1</span> <span class="skolem">I0</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> dist_real_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> dist <span class="main">(</span><span class="var">?v1</span> <span class="main">*</span> <span class="var">?w0</span> <span class="main">*</span> <span class="free">Ps</span> <span class="skolem">cf1</span><span class="main">)</span> <span class="main">(</span><span class="var">?v1</span> <span class="main">*</span> <span class="var">?w0</span> <span class="main">*</span> <span class="skolem">ps</span> <span class="skolem">cf2</span> <span class="main">(</span><span class="skolem">F</span> <span class="skolem">I0</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span>
          dist <span class="main">(</span><span class="var">?w1</span> <span class="main">*</span> <span class="var">?v0</span> <span class="main">*</span> <span class="free">Ps</span> <span class="skolem">cf2</span><span class="main">)</span> <span class="main">(</span><span class="var">?w1</span> <span class="main">*</span> <span class="var">?v0</span> <span class="main">*</span> <span class="skolem">ps</span> <span class="skolem">cf1</span> <span class="skolem">I0</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> dist_diff_diff <span class="keyword1"><span class="command">.</span></span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="var">?v1</span> <span class="main">*</span> <span class="var">?w0</span> <span class="main">*</span> <span class="main">(</span><span class="free">Pn</span> <span class="skolem">cf1</span> <span class="skolem">n</span> <span class="main">+</span> <span class="skolem">pn</span> <span class="skolem">cf2</span> <span class="main">(</span><span class="skolem">F</span> <span class="skolem">I0</span><span class="main">)</span> <span class="skolem">m'</span><span class="main">)</span> <span class="main">+</span> <span class="var">?w1</span> <span class="main">*</span> <span class="var">?v0</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">pn</span> <span class="skolem">cf1</span> <span class="skolem">I0</span> <span class="skolem">n'</span> <span class="main">+</span> <span class="free">Pn</span> <span class="skolem">cf2</span> <span class="skolem">m</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> add_mono<span class="main">)</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"dist <span class="main">(</span><span class="var">?v1</span> <span class="main">*</span> <span class="var">?w0</span> <span class="main">*</span> <span class="free">Ps</span> <span class="skolem">cf1</span><span class="main">)</span> <span class="main">(</span><span class="var">?v1</span> <span class="main">*</span> <span class="var">?w0</span> <span class="main">*</span> <span class="skolem">ps</span> <span class="skolem">cf2</span> <span class="main">(</span><span class="skolem">F</span> <span class="skolem">I0</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="var">?v1</span> <span class="main">*</span> <span class="var">?w0</span> <span class="main">*</span> <span class="main">(</span><span class="free">Pn</span> <span class="skolem">cf1</span> <span class="skolem">n</span> <span class="main">+</span> <span class="skolem">pn</span> <span class="skolem">cf2</span> <span class="main">(</span><span class="skolem">F</span> <span class="skolem">I0</span><span class="main">)</span> <span class="skolem">m'</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> wt_less1 dist_n_m' <span class="quoted"><span class="quoted">‹<span class="skolem">I0</span> <span class="main">∈</span> <span class="skolem">P</span>›</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum_nonneg mult_le_cancel_left not_le<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> mult_le_0_iff W2_nneg<span class="main">)</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"dist <span class="main">(</span><span class="var">?w1</span> <span class="main">*</span> <span class="var">?v0</span> <span class="main">*</span> <span class="free">Ps</span> <span class="skolem">cf2</span><span class="main">)</span> <span class="main">(</span><span class="var">?w1</span> <span class="main">*</span> <span class="var">?v0</span> <span class="main">*</span> <span class="skolem">ps</span> <span class="skolem">cf1</span> <span class="skolem">I0</span><span class="main">)</span> <span class="main">≤</span> <span class="var">?w1</span> <span class="main">*</span> <span class="var">?v0</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">pn</span> <span class="skolem">cf1</span> <span class="skolem">I0</span> <span class="skolem">n'</span> <span class="main">+</span> <span class="free">Pn</span> <span class="skolem">cf2</span> <span class="skolem">m</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> wt_less1 dist_n'_m <span class="quoted"><span class="quoted">‹<span class="skolem">I0</span> <span class="main">∈</span> <span class="skolem">P</span>›</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> dist_commute<span class="main">)</span>
               <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum_nonneg mult_le_cancel_left not_le<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> mult_le_0_iff W1_nneg<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"dist <span class="var">?D</span> <span class="var">?E</span> <span class="main">≤</span> <span class="var">?v1</span> <span class="main">*</span> <span class="var">?w0</span> <span class="main">*</span> <span class="main">(</span><span class="free">Pn</span> <span class="skolem">cf1</span> <span class="skolem">n</span> <span class="main">+</span> <span class="skolem">pn</span> <span class="skolem">cf2</span> <span class="main">(</span><span class="skolem">F</span> <span class="skolem">I0</span><span class="main">)</span> <span class="skolem">m'</span><span class="main">)</span> <span class="main">+</span> <span class="var">?w1</span> <span class="main">*</span> <span class="var">?v0</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">pn</span> <span class="skolem">cf1</span> <span class="skolem">I0</span> <span class="skolem">n'</span> <span class="main">+</span> <span class="free">Pn</span> <span class="skolem">cf2</span> <span class="skolem">m</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">also</span></span>  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="var">?w1</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">I</span><span class="main">∈</span><span class="skolem">P</span><span class="main">-</span><span class="main">{</span><span class="skolem">I0</span><span class="main">}</span><span class="main">.</span> <span class="skolem">W</span> <span class="skolem">cf1</span> <span class="bound">I</span> <span class="main">*</span> <span class="skolem">pn</span> <span class="skolem">cf1</span> <span class="bound">I</span> <span class="skolem">n'</span><span class="main">)</span> <span class="main">+</span> <span class="var">?v1</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">I</span><span class="main">∈</span><span class="skolem">P</span><span class="main">-</span><span class="main">{</span><span class="skolem">I0</span><span class="main">}</span><span class="main">.</span> <span class="skolem">W</span> <span class="skolem">cf2</span> <span class="main">(</span><span class="skolem">F</span> <span class="bound">I</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">pn</span> <span class="skolem">cf2</span> <span class="main">(</span><span class="skolem">F</span> <span class="bound">I</span><span class="main">)</span> <span class="skolem">m'</span><span class="main">)</span> <span class="main">+</span>
        <span class="var">?v1</span> <span class="main">*</span> <span class="var">?w0</span> <span class="main">*</span> <span class="main">(</span><span class="free">Pn</span> <span class="skolem">cf1</span> <span class="skolem">n</span> <span class="main">+</span> <span class="skolem">pn</span> <span class="skolem">cf2</span> <span class="main">(</span><span class="skolem">F</span> <span class="skolem">I0</span><span class="main">)</span> <span class="skolem">m'</span><span class="main">)</span> <span class="main">+</span> <span class="var">?w1</span> <span class="main">*</span> <span class="var">?v0</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">pn</span> <span class="skolem">cf1</span> <span class="skolem">I0</span> <span class="skolem">n'</span> <span class="main">+</span> <span class="free">Pn</span> <span class="skolem">cf2</span> <span class="skolem">m</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> W_neq1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum_divide_distrib<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> add_divide_eq_iff divide_add_eq_iff<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="var">?w0</span> <span class="main">*</span> <span class="var">?v0</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">Pn</span> <span class="skolem">cf1</span> <span class="skolem">n</span> <span class="main">+</span> <span class="free">Pn</span> <span class="skolem">cf2</span> <span class="skolem">m</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> Pn1 Pn2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"dist <span class="main">(</span><span class="free">Ps</span> <span class="skolem">cf1</span><span class="main">)</span> <span class="main">(</span><span class="free">Ps</span> <span class="skolem">cf2</span><span class="main">)</span> <span class="main">≤</span> <span class="free">Pn</span> <span class="skolem">cf1</span> <span class="skolem">n</span> <span class="main">+</span> <span class="free">Pn</span> <span class="skolem">cf2</span> <span class="skolem">m</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> neg_w0v0_nonneg w0v0_less1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult_le_cancel_left<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Trace_Based-AE_T_max_qsend_time"><span class="command">lemma</span></span> AE_T_max_qsend_time<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">cf</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">e</span> <span class="main">::</span> <span class="quoted">real</span> <span class="keyword2"><span class="keyword">assumes</span></span> AE<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">AE</span> <span class="bound">bT</span> <span class="keyword1">in</span> T.T <span class="free">cf</span><span class="main">.</span> qsend <span class="main">(</span><span class="free">cf</span> <span class="main">##</span> <span class="bound">bT</span><span class="main">)</span> <span class="main">&lt;</span> <span class="main">∞</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">e</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">N</span><span class="main">.</span> <span class="keyword1">𝒫(</span><span class="bound"><span class="bound">bT</span></span> <span class="keyword1">in</span> T.T <span class="free"><span class="free">cf</span></span><span class="main">.</span> <span class="main">¬</span> discrCf <span class="main">(</span><span class="main">(</span><span class="free">cf</span> <span class="main">##</span> <span class="bound">bT</span><span class="main">)</span> <span class="main">!!</span> <span class="bound">N</span><span class="main">)</span><span class="main">)</span> <span class="main">&lt;</span> <span class="free">e</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> AE_T_max_sfirst<span class="main">[</span><span class="operator">OF</span> _ AE<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">N</span></span> <span class="main">::</span> <span class="quoted">nat</span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝒫(</span><span class="bound"><span class="bound">bT</span></span> <span class="keyword1">in</span> T.T <span class="free"><span class="free">cf</span></span><span class="main">.</span> <span class="skolem">N</span> <span class="main">&lt;</span> qsend <span class="main">(</span><span class="free">cf</span> <span class="main">##</span> <span class="bound">bT</span><span class="main">)</span><span class="main">)</span> <span class="main">&lt;</span> <span class="free">e</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝒫(</span><span class="bound"><span class="bound">bT</span></span> <span class="keyword1">in</span> T.T <span class="free"><span class="free">cf</span></span><span class="main">.</span> <span class="skolem">N</span> <span class="main">&lt;</span> qsend <span class="main">(</span><span class="free">cf</span> <span class="main">##</span> <span class="bound">bT</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">𝒫(</span><span class="bound"><span class="bound">bT</span></span> <span class="keyword1">in</span> T.T <span class="free"><span class="free">cf</span></span><span class="main">.</span> <span class="main">¬</span> discrCf <span class="main">(</span><span class="main">(</span><span class="free">cf</span> <span class="main">##</span> <span class="bound">bT</span><span class="main">)</span> <span class="main">!!</span> <span class="skolem">N</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> less_qsend_iff_not_discrCf<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">cf</span></span><span class="main">]</span> AE_T_enabled<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">cf</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> T.prob_eq_AE<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Trace_Based-Ps_eq"><span class="command">lemma</span></span> Ps_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">cf1</span> <span class="free">cf2</span> <span class="free">s</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">S</span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="free">cf</span> <span class="free">bT</span> <span class="main">≡</span> <span class="main">∃</span><span class="bound">n</span><span class="main">.</span> qsend <span class="main">(</span><span class="free">cf</span> <span class="main">##</span> <span class="free">bT</span><span class="main">)</span> <span class="main">=</span> <span class="bound">n</span> <span class="main">∧</span> eff_at <span class="free">cf</span> <span class="free">bT</span> <span class="bound">n</span> <span class="main">≈</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">Ps</span> <span class="free">cf</span> <span class="main">≡</span> <span class="keyword1">𝒫(</span><span class="bound"><span class="bound">bT</span></span> <span class="keyword1">in</span> T.T <span class="free"><span class="free">cf</span></span><span class="main">.</span> <span class="free">S</span> <span class="free">cf</span> <span class="bound">bT</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> qsterm1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">AE</span> <span class="bound">bT</span> <span class="keyword1">in</span> T.T <span class="free">cf1</span><span class="main">.</span> qsend <span class="main">(</span><span class="free">cf1</span> <span class="main">##</span> <span class="bound">bT</span><span class="main">)</span> <span class="main">&lt;</span> <span class="main">∞</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> qsterm2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">AE</span> <span class="bound">bT</span> <span class="keyword1">in</span> T.T <span class="free">cf2</span><span class="main">.</span> qsend <span class="main">(</span><span class="free">cf2</span> <span class="main">##</span> <span class="bound">bT</span><span class="main">)</span> <span class="main">&lt;</span> <span class="main">∞</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> bisim<span class="main">:</span> <span class="quoted"><span class="quoted">"proper <span class="main">(</span>fst <span class="free">cf1</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"proper <span class="main">(</span>fst <span class="free">cf2</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"fst <span class="free">cf1</span> <span class="main">≈01</span> fst <span class="free">cf2</span>"</span></span> <span class="quoted"><span class="quoted">"snd <span class="free">cf1</span> <span class="main">≈</span> snd <span class="free">cf2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Ps</span> <span class="free">cf1</span> <span class="main">=</span> <span class="free">Ps</span> <span class="free">cf2</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?nT</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">cf</span> <span class="bound">n</span> <span class="bound">bT</span><span class="main">.</span> <span class="main">¬</span> discrCf <span class="main">(</span><span class="main">(</span><span class="bound">cf</span> <span class="main">##</span> <span class="bound">bT</span><span class="main">)</span> <span class="main">!!</span> <span class="bound">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?PnT</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">cf</span> <span class="bound">n</span><span class="main">.</span> <span class="keyword1">𝒫(</span><span class="bound"><span class="bound">bT</span></span> <span class="keyword1">in</span> T.T <span class="bound"><span class="bound">cf</span></span><span class="main">.</span> <span class="var">?nT</span> <span class="bound">cf</span> <span class="bound">n</span> <span class="bound">bT</span><span class="main">)</span>"</span></span>

   <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dist <span class="main">(</span><span class="free">Ps</span> <span class="free">cf1</span><span class="main">)</span> <span class="main">(</span><span class="free">Ps</span> <span class="free">cf2</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
     <span class="keyword1"><span class="command">unfolding</span></span> dist_real_def
   <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> field_abs_le_zero_epsilon<span class="main">)</span>
     <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">e</span> <span class="main">::</span><span class="quoted">real</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">e</span>"</span></span>
     <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">e</span> <span class="main">/</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
     <span class="keyword1"><span class="command">from</span></span> AE_T_max_qsend_time<span class="main">[</span><span class="operator">OF</span> qsterm1 this<span class="main">]</span> AE_T_max_qsend_time<span class="main">[</span><span class="operator">OF</span> qsterm2 this<span class="main">]</span>
     <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="var">?PnT</span> <span class="free">cf1</span> <span class="skolem">n</span> <span class="main">&lt;</span> <span class="skolem">e</span> <span class="main">/</span> <span class="numeral">2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?PnT</span> <span class="free">cf2</span> <span class="skolem">m</span> <span class="main">&lt;</span> <span class="skolem">e</span> <span class="main">/</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
     <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dist <span class="main">(</span><span class="free">Ps</span> <span class="free">cf1</span><span class="main">)</span> <span class="main">(</span><span class="free">Ps</span> <span class="free">cf2</span><span class="main">)</span> <span class="main">≤</span> <span class="var">?PnT</span> <span class="free">cf1</span> <span class="skolem">n</span> <span class="main">+</span> <span class="var">?PnT</span> <span class="free">cf2</span> <span class="skolem">m</span>"</span></span>
       <span class="keyword1"><span class="command">unfolding</span></span> Ps_def S_def <span class="keyword1"><span class="command">using</span></span> bisim <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> dist_Ps_upper_bound<span class="main">)</span>
     <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="free">Ps</span> <span class="free">cf1</span> <span class="main">-</span> <span class="free">Ps</span> <span class="free">cf2</span><span class="main">¦</span> <span class="main">≤</span> <span class="skolem">e</span>"</span></span>
       <span class="keyword1"><span class="command">unfolding</span></span> dist_real_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
   <span class="keyword1"><span class="command">qed</span></span>
   <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">Ps</span> <span class="free">cf1</span> <span class="main">=</span> <span class="free">Ps</span> <span class="free">cf2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Trace_Based-siso_trace"><span class="command">lemma</span></span> siso_trace<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"siso <span class="free">c</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">≈</span> <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"enabled <span class="main">(</span><span class="free">c</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span> <span class="free">cfT</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"siso <span class="main">(</span>cont_at <span class="main">(</span><span class="free">c</span><span class="main">,</span> <span class="free">s</span><span class="main">)</span> <span class="free">cfT</span> <span class="free">n</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"cont_at <span class="main">(</span><span class="free">c</span><span class="main">,</span> <span class="free">s</span><span class="main">)</span> <span class="free">cfT</span> <span class="free">n</span> <span class="main">=</span> cont_at <span class="main">(</span><span class="free">c</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span> <span class="free">cfT</span> <span class="free">n</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"eff_at <span class="main">(</span><span class="free">c</span><span class="main">,</span> <span class="free">s</span><span class="main">)</span> <span class="free">cfT</span> <span class="free">n</span> <span class="main">≈</span> eff_at <span class="main">(</span><span class="free">c</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span> <span class="free">cfT</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">c</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">cfT</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="keyword3"><span class="command">case</span></span> 1
  <span class="keyword1"><span class="command">with</span></span> Suc<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>shd <span class="skolem">cfT</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>shd <span class="skolem">cfT</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>shd <span class="skolem">cfT</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"stl <span class="skolem">cfT</span>"</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> enabled.simps<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">cfT</span></span><span class="main"><span class="main">]</span></span> G_eq cont_eff indis_refl <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Trace_Based-Sbis_trace"><span class="command">lemma</span></span> Sbis_trace<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"proper <span class="main">(</span>fst <span class="free">cf1</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"proper <span class="main">(</span>fst <span class="free">cf2</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"fst <span class="free">cf1</span> <span class="keyword1">≈s</span> fst <span class="free">cf2</span>"</span></span> <span class="quoted"><span class="quoted">"snd <span class="free">cf1</span> <span class="main">≈</span> snd <span class="free">cf2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝒫(</span><span class="bound"><span class="bound">cfT</span></span> <span class="keyword1">in</span> T.T <span class="free"><span class="free">cf1</span></span><span class="main">.</span> eff_at <span class="free">cf1</span> <span class="bound">cfT</span> <span class="free">n</span> <span class="main">≈</span> <span class="free">s'</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">𝒫(</span><span class="bound"><span class="bound">cfT</span></span> <span class="keyword1">in</span> T.T <span class="free"><span class="free">cf2</span></span><span class="main">.</span> eff_at <span class="free">cf2</span> <span class="bound">cfT</span> <span class="free">n</span> <span class="main">≈</span> <span class="free">s'</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="free">cf1</span> <span class="free">n</span> <span class="main">=</span> <span class="var">?P</span> <span class="free">cf2</span> <span class="free">n</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">cf1</span></span> <span class="quoted"><span class="free">cf2</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"snd <span class="skolem">cf1</span> <span class="main">≈</span> <span class="free">s'</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹snd <span class="skolem">cf1</span> <span class="main">≈</span> snd <span class="skolem">cf2</span>›</span></span> <span class="quoted"><span class="quoted">‹fst <span class="skolem">cf1</span> <span class="keyword1">≈s</span> fst <span class="skolem">cf2</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd <span class="skolem">cf1</span> <span class="main">≈</span> <span class="free">s'</span>"</span></span> <span class="quoted"><span class="quoted">"snd <span class="skolem">cf2</span> <span class="main">≈</span> <span class="free">s'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> indis_trans indis_sym<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> T.prob_space <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> snd <span class="skolem">cf1</span> <span class="main">≈</span> <span class="free">s'</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹snd <span class="skolem">cf1</span> <span class="main">≈</span> snd <span class="skolem">cf2</span>›</span></span> <span class="quoted"><span class="quoted">‹fst <span class="skolem">cf1</span> <span class="keyword1">≈s</span> fst <span class="skolem">cf2</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> snd <span class="skolem">cf1</span> <span class="main">≈</span> <span class="free">s'</span> <span class="main">∧</span> <span class="main">¬</span> snd <span class="skolem">cf2</span> <span class="main">≈</span> <span class="free">s'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> indis_trans indis_sym<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> <span class="quoted"><span class="quoted">‹proper <span class="main">(</span>fst <span class="skolem">cf1</span><span class="main">)</span>›</span></span><span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="quoted"><span class="quoted">‹proper <span class="main">(</span>fst <span class="skolem">cf2</span><span class="main">)</span>›</span></span><span class="main">[</span><span class="operator">simp</span><span class="main">]</span>

  <span class="keyword1"><span class="command">from</span></span> Sbis_mC_C <span class="quoted"><span class="quoted">‹fst <span class="skolem">cf1</span> <span class="keyword1">≈s</span> fst <span class="skolem">cf2</span>›</span></span> <span class="quoted"><span class="quoted">‹snd <span class="skolem">cf1</span> <span class="main">≈</span> snd <span class="skolem">cf2</span>›</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">P</span></span> <span class="skolem"><span class="skolem">F</span></span> <span class="keyword2"><span class="keyword">where</span></span> mP<span class="main">:</span> <span class="quoted"><span class="quoted">"mC_C Sbis <span class="main">(</span>fst <span class="skolem">cf1</span><span class="main">)</span> <span class="main">(</span>fst <span class="skolem">cf2</span><span class="main">)</span> <span class="main">(</span>snd <span class="skolem">cf1</span><span class="main">)</span> <span class="main">(</span>snd <span class="skolem">cf2</span><span class="main">)</span> <span class="skolem">P</span> <span class="skolem">F</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span>
    P<span class="main">:</span> <span class="quoted"><span class="quoted">"part <span class="main">{..&lt;</span>brn <span class="main">(</span>fst <span class="skolem">cf1</span><span class="main">)</span><span class="main">}</span> <span class="skolem">P</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">{}</span> <span class="main">∉</span> <span class="skolem">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    FP<span class="main">:</span> <span class="quoted"><span class="quoted">"part <span class="main">{..&lt;</span>brn <span class="main">(</span>fst <span class="skolem">cf2</span><span class="main">)</span><span class="main">}</span> <span class="main">(</span><span class="skolem">F</span><span class="main">`</span><span class="skolem">P</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">{}</span> <span class="main">∉</span> <span class="skolem">F</span> <span class="main">`</span> <span class="skolem">P</span>"</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="skolem">F</span> <span class="skolem">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    W<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">I</span><span class="main">.</span> <span class="bound">I</span> <span class="main">∈</span> <span class="skolem">P</span> <span class="main">⟹</span> sum <span class="main">(</span>wt <span class="main">(</span>fst <span class="skolem">cf1</span><span class="main">)</span> <span class="main">(</span>snd <span class="skolem">cf1</span><span class="main">)</span><span class="main">)</span> <span class="bound">I</span> <span class="main">=</span> sum <span class="main">(</span>wt <span class="main">(</span>fst <span class="skolem">cf2</span><span class="main">)</span> <span class="main">(</span>snd <span class="skolem">cf2</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">F</span> <span class="bound">I</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    eff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">I</span> <span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">I</span> <span class="main">∈</span> <span class="skolem">P</span> <span class="main">⟹</span> <span class="bound">i</span> <span class="main">∈</span> <span class="bound">I</span> <span class="main">⟹</span> <span class="bound">j</span> <span class="main">∈</span> <span class="skolem">F</span> <span class="bound">I</span> <span class="main">⟹</span>
      eff <span class="main">(</span>fst <span class="skolem">cf1</span><span class="main">)</span> <span class="main">(</span>snd <span class="skolem">cf1</span><span class="main">)</span> <span class="bound">i</span> <span class="main">≈</span> eff <span class="main">(</span>fst <span class="skolem">cf2</span><span class="main">)</span> <span class="main">(</span>snd <span class="skolem">cf2</span><span class="main">)</span> <span class="bound">j</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    cont<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">I</span> <span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">I</span> <span class="main">∈</span> <span class="skolem">P</span> <span class="main">⟹</span> <span class="bound">i</span> <span class="main">∈</span> <span class="bound">I</span> <span class="main">⟹</span> <span class="bound">j</span> <span class="main">∈</span> <span class="skolem">F</span> <span class="bound">I</span> <span class="main">⟹</span>
      cont <span class="main">(</span>fst <span class="skolem">cf1</span><span class="main">)</span> <span class="main">(</span>snd <span class="skolem">cf1</span><span class="main">)</span> <span class="bound">i</span> <span class="keyword1">≈s</span> cont <span class="main">(</span>fst <span class="skolem">cf2</span><span class="main">)</span> <span class="main">(</span>snd <span class="skolem">cf2</span><span class="main">)</span> <span class="bound">j</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> mC_C_def mC_C_eff_cont_def mC_C_part_def mC_C_wt_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">cf1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'test</span><span class="main">,</span> <span class="tfree">'atom</span><span class="main">,</span> <span class="tfree">'choice</span><span class="main">)</span> cmd <span class="main">×</span> <span class="tfree">'state</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">P</span> <span class="keyword3"><span class="command">assume</span></span> cf<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"proper <span class="main">(</span>fst <span class="skolem">cf1</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> P<span class="main">:</span> <span class="quoted"><span class="quoted">"part <span class="main">{..&lt;</span>brn <span class="main">(</span>fst <span class="skolem">cf1</span><span class="main">)</span><span class="main">}</span> <span class="skolem">P</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="skolem">cf1</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∫</span><span class="bound">cf'</span><span class="main">.</span> <span class="var">?P</span> <span class="bound">cf'</span> <span class="skolem">n</span> <span class="main">∂</span>trans <span class="skolem">cf1</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> T.prob_T<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">b</span><span class="main">&lt;</span>brn <span class="main">(</span>fst <span class="skolem">cf1</span><span class="main">)</span><span class="main">.</span> wt <span class="main">(</span>fst <span class="skolem">cf1</span><span class="main">)</span> <span class="main">(</span>snd <span class="skolem">cf1</span><span class="main">)</span> <span class="bound">b</span> <span class="main">*</span> <span class="var">?P</span> <span class="main">(</span>cont_eff <span class="skolem">cf1</span> <span class="bound">b</span><span class="main">)</span> <span class="skolem">n</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> integral_trans<span class="main">[</span><span class="operator">OF</span> cf<span class="main">]</span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">I</span><span class="main">∈</span><span class="skolem">P</span><span class="main">.</span> <span class="main">∑</span><span class="bound">b</span><span class="main">∈</span><span class="bound">I</span><span class="main">.</span> wt <span class="main">(</span>fst <span class="skolem">cf1</span><span class="main">)</span> <span class="main">(</span>snd <span class="skolem">cf1</span><span class="main">)</span> <span class="bound">b</span> <span class="main">*</span> <span class="var">?P</span> <span class="main">(</span>cont_eff <span class="skolem">cf1</span> <span class="bound">b</span><span class="main">)</span> <span class="skolem">n</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> part_sum<span class="main">[</span><span class="operator">OF</span> P<span class="main">]</span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="skolem">cf1</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">=</span> <span class="main">…</span>"</span></span> <span class="keyword1"><span class="command">.</span></span> <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">note</span></span> split <span class="main">=</span> this

  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">I</span> <span class="skolem">i</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">I</span> <span class="main">∈</span> <span class="skolem">P</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="skolem">I</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹proper <span class="main">(</span>fst <span class="skolem">cf1</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> brn <span class="main">(</span>fst <span class="skolem">cf1</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> part_is_subset<span class="main">[</span><span class="operator">OF</span> P<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">I</span> <span class="main">∈</span> <span class="skolem">P</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">note</span></span> brn_cf<span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> this

  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">I</span> <span class="skolem">i</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">I</span> <span class="main">∈</span> <span class="skolem">P</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="skolem">F</span> <span class="skolem">I</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹proper <span class="main">(</span>fst <span class="skolem">cf2</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> brn <span class="main">(</span>fst <span class="skolem">cf2</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> part_is_subset<span class="main">[</span><span class="operator">OF</span> FP<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">F</span> <span class="skolem">I</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">note</span></span> brn_cf2<span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> this

  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">I</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">I</span> <span class="main">∈</span> <span class="skolem">P</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="main">{}</span> <span class="main">∉</span> <span class="skolem">P</span>›</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="skolem">I</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> all_not_in_conv<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">I</span> <span class="main">∈</span> <span class="skolem">P</span>›</span></span> FP <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">F</span> <span class="skolem">I</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">F</span> <span class="skolem">I</span> <span class="main">⊆</span> <span class="main">{..&lt;</span>brn <span class="main">(</span>fst <span class="skolem">cf2</span><span class="main">)</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> part_is_subset<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> brn <span class="main">(</span>fst <span class="skolem">cf2</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∈</span> <span class="skolem">F</span> <span class="skolem">I</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">b</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">∈</span> <span class="skolem">F</span> <span class="skolem">I</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">(</span>cont_eff <span class="skolem">cf1</span> <span class="skolem">i</span><span class="main">)</span> <span class="skolem">n</span> <span class="main">=</span> <span class="var">?P</span> <span class="main">(</span>cont_eff <span class="skolem">cf2</span> <span class="skolem">b</span><span class="main">)</span> <span class="skolem">n</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">I</span> <span class="main">∈</span> <span class="skolem">P</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">∈</span> <span class="skolem">I</span>›</span></span> cont eff
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> Suc<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cont_eff<span class="main">)</span> <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">note</span></span> cont_d_const <span class="main">=</span> this<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> <span class="skolem">I</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">I</span> <span class="main">∈</span> <span class="skolem">P</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">∈</span> <span class="skolem">I</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">∈</span> <span class="skolem">F</span> <span class="skolem">I</span>›</span></span> cont eff
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">(</span>cont_eff <span class="skolem">cf1</span> <span class="skolem">i</span><span class="main">)</span> <span class="skolem">n</span> <span class="main">=</span> <span class="var">?P</span> <span class="main">(</span>cont_eff <span class="skolem">cf2</span> <span class="skolem">j</span><span class="main">)</span> <span class="skolem">n</span> <span class="main">∧</span>
        <span class="var">?P</span> <span class="main">(</span>cont_eff <span class="skolem">cf1</span> <span class="skolem">a</span><span class="main">)</span> <span class="skolem">n</span> <span class="main">=</span> <span class="var">?P</span> <span class="main">(</span>cont_eff <span class="skolem">cf2</span> <span class="skolem">j</span><span class="main">)</span> <span class="skolem">n</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> conjI Suc<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cont_eff<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">(</span>cont_eff <span class="skolem">cf1</span> <span class="skolem">a</span><span class="main">)</span> <span class="skolem">n</span> <span class="main">=</span> <span class="var">?P</span> <span class="main">(</span>cont_eff <span class="skolem">cf1</span> <span class="skolem">i</span><span class="main">)</span> <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">b</span><span class="main">∈</span><span class="skolem">I</span><span class="main">.</span> wt <span class="main">(</span>fst <span class="skolem">cf1</span><span class="main">)</span> <span class="main">(</span>snd <span class="skolem">cf1</span><span class="main">)</span> <span class="bound">b</span> <span class="main">*</span> <span class="var">?P</span> <span class="main">(</span>cont_eff <span class="skolem">cf1</span> <span class="bound">b</span><span class="main">)</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">=</span>
        <span class="main">(</span><span class="main">∑</span><span class="bound">b</span><span class="main">∈</span><span class="skolem">I</span><span class="main">.</span> wt <span class="main">(</span>fst <span class="skolem">cf1</span><span class="main">)</span> <span class="main">(</span>snd <span class="skolem">cf1</span><span class="main">)</span> <span class="bound">b</span><span class="main">)</span> <span class="main">*</span> <span class="var">?P</span> <span class="main">(</span>cont_eff <span class="skolem">cf1</span> <span class="skolem">i</span><span class="main">)</span> <span class="skolem">n</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum_distrib_right<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">b</span><span class="main">∈</span><span class="skolem">F</span> <span class="skolem">I</span><span class="main">.</span> wt <span class="main">(</span>fst <span class="skolem">cf2</span><span class="main">)</span> <span class="main">(</span>snd <span class="skolem">cf2</span><span class="main">)</span> <span class="bound">b</span><span class="main">)</span> <span class="main">*</span> <span class="var">?P</span> <span class="main">(</span>cont_eff <span class="skolem">cf1</span> <span class="skolem">i</span><span class="main">)</span> <span class="skolem">n</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> W <span class="quoted"><span class="quoted">‹<span class="skolem">I</span> <span class="main">∈</span> <span class="skolem">P</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">b</span><span class="main">∈</span><span class="skolem">F</span> <span class="skolem">I</span><span class="main">.</span> wt <span class="main">(</span>fst <span class="skolem">cf2</span><span class="main">)</span> <span class="main">(</span>snd <span class="skolem">cf2</span><span class="main">)</span> <span class="bound">b</span> <span class="main">*</span> <span class="var">?P</span> <span class="main">(</span>cont_eff <span class="skolem">cf2</span> <span class="bound">b</span><span class="main">)</span> <span class="skolem">n</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> cont_d_const <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum_distrib_right<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">b</span><span class="main">∈</span><span class="skolem">I</span><span class="main">.</span> wt <span class="main">(</span>fst <span class="skolem">cf1</span><span class="main">)</span> <span class="main">(</span>snd <span class="skolem">cf1</span><span class="main">)</span> <span class="bound">b</span> <span class="main">*</span> <span class="var">?P</span> <span class="main">(</span>cont_eff <span class="skolem">cf1</span> <span class="bound">b</span><span class="main">)</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">=</span> <span class="main">…</span>"</span></span> <span class="keyword1"><span class="command">.</span></span> <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">note</span></span> sum_eq <span class="main">=</span> this

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="skolem">cf1</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">I</span><span class="main">∈</span><span class="skolem">P</span><span class="main">.</span> <span class="main">∑</span><span class="bound">b</span><span class="main">∈</span><span class="bound">I</span><span class="main">.</span> wt <span class="main">(</span>fst <span class="skolem">cf1</span><span class="main">)</span> <span class="main">(</span>snd <span class="skolem">cf1</span><span class="main">)</span> <span class="bound">b</span> <span class="main">*</span> <span class="var">?P</span> <span class="main">(</span>cont_eff <span class="skolem">cf1</span> <span class="bound">b</span><span class="main">)</span> <span class="skolem">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹proper <span class="main">(</span>fst <span class="skolem">cf1</span><span class="main">)</span>›</span></span> P<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> split<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">I</span><span class="main">∈</span><span class="skolem">P</span><span class="main">.</span> <span class="main">∑</span><span class="bound">b</span><span class="main">∈</span><span class="skolem">F</span> <span class="bound">I</span><span class="main">.</span> wt <span class="main">(</span>fst <span class="skolem">cf2</span><span class="main">)</span> <span class="main">(</span>snd <span class="skolem">cf2</span><span class="main">)</span> <span class="bound">b</span> <span class="main">*</span> <span class="var">?P</span> <span class="main">(</span>cont_eff <span class="skolem">cf2</span> <span class="bound">b</span><span class="main">)</span> <span class="skolem">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> sum_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">I</span><span class="main">∈</span><span class="skolem">F</span><span class="main">`</span><span class="skolem">P</span><span class="main">.</span> <span class="main">∑</span><span class="bound">b</span><span class="main">∈</span><span class="bound">I</span><span class="main">.</span> wt <span class="main">(</span>fst <span class="skolem">cf2</span><span class="main">)</span> <span class="main">(</span>snd <span class="skolem">cf2</span><span class="main">)</span> <span class="bound">b</span> <span class="main">*</span> <span class="var">?P</span> <span class="main">(</span>cont_eff <span class="skolem">cf2</span> <span class="bound">b</span><span class="main">)</span> <span class="skolem">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹inj_on <span class="skolem">F</span> <span class="skolem">P</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum.reindex<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="var">?P</span> <span class="skolem">cf2</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹proper <span class="main">(</span>fst <span class="skolem">cf2</span><span class="main">)</span>›</span></span> FP<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> split<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Final Theorems›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> ZObis_eSec<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>proper <span class="free">c</span><span class="main">;</span> <span class="free">c</span> <span class="main">≈01</span> <span class="free">c</span><span class="main">;</span> aeT <span class="free">c</span><span class="main">⟧</span> <span class="main">⟹</span> eSec <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> aeT_def eSec_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Ps_eq<span class="main"><span class="main">[</span></span><span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> Sbis_amSec<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>proper <span class="free">c</span><span class="main">;</span> <span class="free">c</span> <span class="keyword1">≈s</span> <span class="free">c</span><span class="main">⟧</span> <span class="main">⟹</span> amSec <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> amSec_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Sbis_trace<span class="main"><span class="main">[</span></span><span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> amSec_eSec<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"proper <span class="free">c</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"aeT <span class="free">c</span>"</span></span> <span class="quoted"><span class="quoted">"amSec <span class="free">c</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"eSec <span class="free">c</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold</span> eSec_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> allI impI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s1</span> <span class="skolem">s2</span> <span class="skolem">t</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s1</span> <span class="main">≈</span> <span class="skolem">s2</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?T</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">s</span> <span class="bound">bT</span><span class="main">.</span> <span class="main">∃</span><span class="bound">n</span><span class="main">.</span> qsend <span class="main">(</span><span class="main">(</span><span class="free">c</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span> <span class="main">##</span> <span class="bound">bT</span><span class="main">)</span> <span class="main">=</span> <span class="bound">n</span> <span class="main">∧</span> eff_at <span class="main">(</span><span class="free">c</span><span class="main">,</span><span class="bound">s</span><span class="main">)</span> <span class="bound">bT</span> <span class="bound">n</span> <span class="main">≈</span> <span class="skolem">t</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="keyword1">𝒫(</span><span class="bound"><span class="bound">bT</span></span> <span class="keyword1">in</span> T.T <span class="main">(</span><span class="free"><span class="free">c</span></span><span class="main">,</span> <span class="bound"><span class="bound">s</span></span><span class="main">)</span><span class="main">.</span> <span class="var">?T</span> <span class="bound">s</span> <span class="bound">bT</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dist <span class="main">(</span><span class="var">?P</span> <span class="skolem">s1</span><span class="main">)</span> <span class="main">(</span><span class="var">?P</span> <span class="skolem">s2</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> dist_real_def
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> field_abs_le_zero_epsilon<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">e</span> <span class="main">::</span> <span class="quoted">real</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">e</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">e</span> <span class="main">/</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?N</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">s</span> <span class="bound">n</span> <span class="bound">bT</span><span class="main">.</span> <span class="main">¬</span> discrCf <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="free">c</span><span class="main">,</span><span class="bound">s</span><span class="main">)</span> <span class="main">##</span> <span class="bound">bT</span><span class="main">)</span> <span class="main">!!</span> <span class="bound">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> AE_T_max_qsend_time<span class="main">[</span><span class="operator">OF</span> _ <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">e</span> <span class="main">/</span> <span class="numeral">2</span>›</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">c</span><span class="main">,</span><span class="skolem">s1</span><span class="main">)</span>"</span></span><span class="main">]</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">N1</span></span> <span class="keyword2"><span class="keyword">where</span></span> N1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝒫(</span><span class="bound"><span class="bound">bT</span></span> <span class="keyword1">in</span> T.T <span class="main">(</span><span class="free"><span class="free">c</span></span><span class="main">,</span> <span class="skolem"><span class="skolem">s1</span></span><span class="main">)</span><span class="main">.</span> <span class="var">?N</span> <span class="skolem">s1</span> <span class="skolem">N1</span> <span class="bound">bT</span><span class="main">)</span> <span class="main">&lt;</span> <span class="skolem">e</span> <span class="main">/</span> <span class="numeral">2</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹aeT <span class="free">c</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> aeT_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> AE_T_max_qsend_time<span class="main">[</span><span class="operator">OF</span> _ <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">e</span> <span class="main">/</span> <span class="numeral">2</span>›</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">c</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>"</span></span><span class="main">]</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">N2</span></span> <span class="keyword2"><span class="keyword">where</span></span> N2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝒫(</span><span class="bound"><span class="bound">bT</span></span> <span class="keyword1">in</span> T.T <span class="main">(</span><span class="free"><span class="free">c</span></span><span class="main">,</span> <span class="skolem"><span class="skolem">s2</span></span><span class="main">)</span><span class="main">.</span> <span class="var">?N</span> <span class="skolem">s2</span> <span class="skolem">N2</span> <span class="bound">bT</span><span class="main">)</span> <span class="main">&lt;</span> <span class="skolem">e</span> <span class="main">/</span> <span class="numeral">2</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹aeT <span class="free">c</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> aeT_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">N</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">N</span> <span class="main">=</span> max <span class="skolem">N1</span> <span class="skolem">N2</span>"</span></span>

    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Tn</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">n</span> <span class="bound">s</span> <span class="bound">bT</span><span class="main">.</span> eff_at <span class="main">(</span><span class="free">c</span><span class="main">,</span><span class="bound">s</span><span class="main">)</span> <span class="bound">bT</span> <span class="bound">n</span> <span class="main">≈</span> <span class="skolem">t</span>"</span></span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dist <span class="keyword1">𝒫(</span><span class="bound"><span class="bound">bT</span></span> <span class="keyword1">in</span> T.T <span class="main">(</span><span class="free"><span class="free">c</span></span><span class="main">,</span> <span class="skolem"><span class="skolem">s1</span></span><span class="main">)</span><span class="main">.</span> <span class="var">?T</span> <span class="skolem">s1</span> <span class="bound">bT</span><span class="main">)</span> <span class="keyword1">𝒫(</span><span class="bound"><span class="bound">bT</span></span> <span class="keyword1">in</span> T.T <span class="main">(</span><span class="free"><span class="free">c</span></span><span class="main">,</span> <span class="skolem"><span class="skolem">s1</span></span><span class="main">)</span><span class="main">.</span> <span class="var">?Tn</span> <span class="skolem">N</span> <span class="skolem">s1</span> <span class="bound">bT</span><span class="main">)</span> <span class="main">≤</span>
        <span class="keyword1">𝒫(</span><span class="bound"><span class="bound">bT</span></span> <span class="keyword1">in</span> T.T <span class="main">(</span><span class="free"><span class="free">c</span></span><span class="main">,</span> <span class="skolem"><span class="skolem">s1</span></span><span class="main">)</span><span class="main">.</span> <span class="var">?N</span> <span class="skolem">s1</span> <span class="skolem">N1</span> <span class="bound">bT</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹aeT <span class="free">c</span>›</span></span><span class="main">[</span><span class="operator">unfolded</span> aeT_def<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span> AE_T_enabled AE_space
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> T.prob_dist<span class="main"><span class="keyword3">,</span></span> <span class="operator">eventually_elim</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> impI<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">bT</span> <span class="keyword3"><span class="command">assume</span></span> bT<span class="main">:</span> <span class="quoted"><span class="quoted">"enabled <span class="main">(</span><span class="free">c</span><span class="main">,</span><span class="skolem">s1</span><span class="main">)</span> <span class="skolem">bT</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">¬</span> discrCf <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="free">c</span><span class="main">,</span><span class="skolem">s1</span><span class="main">)</span> <span class="main">##</span> <span class="skolem">bT</span><span class="main">)</span> <span class="main">!!</span> <span class="skolem">N1</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> bT <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"qsend <span class="main">(</span><span class="main">(</span><span class="free">c</span><span class="main">,</span><span class="skolem">s1</span><span class="main">)</span> <span class="main">##</span> <span class="skolem">bT</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">N1</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> less_qsend_iff_not_discrCf<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">c</span><span class="main">,</span><span class="skolem">s1</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="skolem">bT</span></span> <span class="quoted"><span class="skolem">N1</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?T</span> <span class="skolem">s1</span> <span class="skolem">bT</span> <span class="main">⟷</span> <span class="var">?Tn</span> <span class="skolem">N</span> <span class="skolem">s1</span> <span class="skolem">bT</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> bT
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"qsend <span class="main">(</span><span class="main">(</span><span class="free">c</span><span class="main">,</span> <span class="skolem">s1</span><span class="main">)</span> <span class="main">##</span> <span class="skolem">bT</span><span class="main">)</span>"</span></span><span class="main">)</span>
           <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> enabled_qsend_indis <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> iffI <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> N_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">measurable</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dist <span class="keyword1">𝒫(</span><span class="bound"><span class="bound">bT</span></span> <span class="keyword1">in</span> T.T <span class="main">(</span><span class="free"><span class="free">c</span></span><span class="main">,</span> <span class="skolem"><span class="skolem">s2</span></span><span class="main">)</span><span class="main">.</span> <span class="var">?T</span> <span class="skolem">s2</span> <span class="bound">bT</span><span class="main">)</span> <span class="keyword1">𝒫(</span><span class="bound"><span class="bound">bT</span></span> <span class="keyword1">in</span> T.T <span class="main">(</span><span class="free"><span class="free">c</span></span><span class="main">,</span> <span class="skolem"><span class="skolem">s2</span></span><span class="main">)</span><span class="main">.</span> <span class="var">?Tn</span> <span class="skolem">N</span> <span class="skolem">s2</span> <span class="bound">bT</span><span class="main">)</span> <span class="main">≤</span>
        <span class="keyword1">𝒫(</span><span class="bound"><span class="bound">bT</span></span> <span class="keyword1">in</span> T.T <span class="main">(</span><span class="free"><span class="free">c</span></span><span class="main">,</span> <span class="skolem"><span class="skolem">s2</span></span><span class="main">)</span><span class="main">.</span> <span class="var">?N</span> <span class="skolem">s2</span> <span class="skolem">N2</span> <span class="bound">bT</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹aeT <span class="free">c</span>›</span></span><span class="main">[</span><span class="operator">unfolded</span> aeT_def<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span> AE_T_enabled AE_space
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> T.prob_dist<span class="main"><span class="keyword3">,</span></span> <span class="operator">eventually_elim</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> impI<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">bT</span> <span class="keyword3"><span class="command">assume</span></span> bT<span class="main">:</span> <span class="quoted"><span class="quoted">"enabled <span class="main">(</span><span class="free">c</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span> <span class="skolem">bT</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">¬</span> discrCf <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="free">c</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span> <span class="main">##</span> <span class="skolem">bT</span><span class="main">)</span> <span class="main">!!</span> <span class="skolem">N2</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> bT <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"qsend <span class="main">(</span><span class="main">(</span><span class="free">c</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span> <span class="main">##</span> <span class="skolem">bT</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">N2</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> less_qsend_iff_not_discrCf<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">c</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="skolem">bT</span></span> <span class="quoted"><span class="skolem">N2</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?T</span> <span class="skolem">s2</span> <span class="skolem">bT</span> <span class="main">⟷</span> <span class="var">?Tn</span> <span class="skolem">N</span> <span class="skolem">s2</span> <span class="skolem">bT</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> bT
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"qsend <span class="main">(</span><span class="main">(</span><span class="free">c</span><span class="main">,</span> <span class="skolem">s2</span><span class="main">)</span> <span class="main">##</span> <span class="skolem">bT</span><span class="main">)</span>"</span></span><span class="main">)</span>
           <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> enabled_qsend_indis <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> iffI <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> N_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">measurable</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dist <span class="keyword1">𝒫(</span><span class="bound"><span class="bound">bT</span></span> <span class="keyword1">in</span> T.T <span class="main">(</span><span class="free"><span class="free">c</span></span><span class="main">,</span> <span class="skolem"><span class="skolem">s1</span></span><span class="main">)</span><span class="main">.</span> <span class="var">?T</span> <span class="skolem">s1</span> <span class="bound">bT</span><span class="main">)</span> <span class="keyword1">𝒫(</span><span class="bound"><span class="bound">bT</span></span> <span class="keyword1">in</span> T.T <span class="main">(</span><span class="free"><span class="free">c</span></span><span class="main">,</span> <span class="skolem"><span class="skolem">s1</span></span><span class="main">)</span><span class="main">.</span> <span class="var">?Tn</span> <span class="skolem">N</span> <span class="skolem">s1</span> <span class="bound">bT</span><span class="main">)</span> <span class="main">+</span>
      dist <span class="keyword1">𝒫(</span><span class="bound"><span class="bound">bT</span></span> <span class="keyword1">in</span> T.T <span class="main">(</span><span class="free"><span class="free">c</span></span><span class="main">,</span> <span class="skolem"><span class="skolem">s2</span></span><span class="main">)</span><span class="main">.</span> <span class="var">?T</span> <span class="skolem">s2</span> <span class="bound">bT</span><span class="main">)</span> <span class="keyword1">𝒫(</span><span class="bound"><span class="bound">bT</span></span> <span class="keyword1">in</span> T.T <span class="main">(</span><span class="free"><span class="free">c</span></span><span class="main">,</span> <span class="skolem"><span class="skolem">s1</span></span><span class="main">)</span><span class="main">.</span> <span class="var">?Tn</span> <span class="skolem">N</span> <span class="skolem">s1</span> <span class="bound">bT</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">e</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹amSec <span class="free">c</span>›</span></span><span class="main">[</span><span class="operator">unfolded</span> amSec_def<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">s1</span> <span class="main">≈</span> <span class="skolem">s2</span>›</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">N</span></span> <span class="quoted"><span class="skolem">t</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">using</span></span> N1 N2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> dist_triangle_le<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="var">?P</span> <span class="skolem">s1</span> <span class="main">-</span> <span class="var">?P</span> <span class="skolem">s2</span><span class="main">¦</span> <span class="main">≤</span> <span class="skolem">e</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dist_real_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="skolem">s1</span> <span class="main">=</span> <span class="var">?P</span> <span class="skolem">s2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Compositionality">
<div class="head">
<h1>Theory Compositionality</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Compositionality of Resumption-Based Noninterference›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Compositionality
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Resumption_Based.html">Resumption_Based</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="comment1">(* The results corresponding to the paper's Prop. 2 are marked below with "theorem". *)</span>

<span class="keyword1"><span class="command">context</span></span> PL_Indis
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Compatibility and discreetness of atoms, tests and choices›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">compatAtm</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">compatAtm</span> <span class="free"><span class="bound"><span class="entity">atm</span></span></span> <span class="main">≡</span>
 <span class="keyword1">ALL</span> <span class="bound">s</span> <span class="bound">t</span><span class="main">.</span> <span class="bound">s</span> <span class="main">≈</span> <span class="bound">t</span> <span class="main">⟶</span> <span class="free">aval</span> <span class="free"><span class="bound"><span class="entity">atm</span></span></span> <span class="bound">s</span> <span class="main">≈</span> <span class="free">aval</span> <span class="free"><span class="bound"><span class="entity">atm</span></span></span> <span class="bound">t</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">presAtm</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">presAtm</span> <span class="free"><span class="bound"><span class="entity">atm</span></span></span> <span class="main">≡</span>
 <span class="keyword1">ALL</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">≈</span> <span class="free">aval</span> <span class="free"><span class="bound"><span class="entity">atm</span></span></span> <span class="bound">s</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">compatTst</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">compatTst</span> <span class="free"><span class="bound"><span class="entity">tst</span></span></span> <span class="main">≡</span>
 <span class="keyword1">ALL</span> <span class="bound">s</span> <span class="bound">t</span><span class="main">.</span> <span class="bound">s</span> <span class="main">≈</span> <span class="bound">t</span> <span class="main">⟶</span> <span class="free">tval</span> <span class="free"><span class="bound"><span class="entity">tst</span></span></span> <span class="bound">s</span> <span class="main">=</span> <span class="free">tval</span> <span class="free"><span class="bound"><span class="entity">tst</span></span></span> <span class="bound">t</span>"</span></span>

<span class="keyword1" id="Compositionality-discrAt_compatAt"><span class="command">lemma</span></span> discrAt_compatAt<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"presAtm <span class="free">atm</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"compatAtm <span class="free">atm</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> compatAtm_def
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> presAtm_def indis_sym indis_trans<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">compatCh</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">compatCh</span> <span class="free"><span class="bound"><span class="entity">ch</span></span></span> <span class="main">≡</span> <span class="main">∀</span> <span class="bound">s</span> <span class="bound">t</span><span class="main">.</span> <span class="bound">s</span> <span class="main">≈</span> <span class="bound">t</span> <span class="main">⟶</span> <span class="free">cval</span> <span class="free"><span class="bound"><span class="entity">ch</span></span></span> <span class="bound">s</span> <span class="main">=</span> <span class="free">cval</span> <span class="free"><span class="bound"><span class="entity">ch</span></span></span> <span class="bound">t</span>"</span></span>

<span class="keyword1" id="Compositionality-compatCh_cval"><span class="command">lemma</span></span> compatCh_cval<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"compatCh <span class="free">ch</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">≈</span> <span class="free">t</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">" <span class="free">cval</span> <span class="free">ch</span> <span class="free">s</span> <span class="main">=</span> <span class="free">cval</span> <span class="free">ch</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> compatCh_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Compositionality of self-isomorphism›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Self-Isomorphism versus language constructs:›</span></span>

<span class="keyword1" id="Compositionality-siso_Done"><span class="command">lemma</span></span> siso_Done<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="quoted"><span class="quoted">"siso Done"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">fix</span></span> <span class="skolem">c</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'test</span><span class="main">,</span> <span class="tfree">'atom</span><span class="main">,</span> <span class="tfree">'choice</span><span class="main">)</span> cmd"</span></span>
   <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">=</span> Done"</span></span> <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"siso <span class="skolem">c</span>"</span></span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">induct</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Compositionality-siso_Atm"><span class="command">lemma</span></span> siso_Atm<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="quoted"><span class="quoted">"siso <span class="main">(</span>Atm <span class="free">atm</span><span class="main">)</span> <span class="main">=</span> compatAtm <span class="free">atm</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">fix</span></span> <span class="skolem">c</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'test</span><span class="main">,</span> <span class="tfree">'atom</span><span class="main">,</span> <span class="tfree">'choice</span><span class="main">)</span> cmd"</span></span>
   <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">atm</span><span class="main">.</span> <span class="skolem">c</span> <span class="main">=</span> Atm <span class="bound">atm</span> <span class="main">∧</span> compatAtm <span class="bound">atm</span>"</span></span>
   <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"siso <span class="skolem">c</span>"</span></span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">induct</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> compatAtm_def eff_Atm cont_Atm wt_Atm<span class="main">)</span>
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> cont_Atm siso_Done<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"siso <span class="main">(</span>Atm <span class="free">atm</span><span class="main">)</span> <span class="main">⟹</span> compatAtm <span class="free">atm</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> compatAtm_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> brn.simps eff_Atm less_Suc_eq mult_less_cancel1 nat_mult_1 siso_cont_indis<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Compositionality-siso_Seq"><span class="command">lemma</span></span> siso_Seq<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"siso <span class="free">c1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"siso <span class="free">c2</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"siso <span class="main">(</span><span class="free">c1</span> <span class="main">;;</span> <span class="free">c2</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">fix</span></span> <span class="skolem">c</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'test</span><span class="main">,</span> <span class="tfree">'atom</span><span class="main">,</span> <span class="tfree">'choice</span><span class="main">)</span> cmd"</span></span>
   <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">c1</span> <span class="bound">c2</span><span class="main">.</span> <span class="skolem">c</span> <span class="main">=</span> <span class="bound">c1</span> <span class="main">;;</span> <span class="bound">c2</span> <span class="main">∧</span> siso <span class="bound">c1</span> <span class="main">∧</span> siso <span class="bound">c2</span>"</span></span>
   <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"siso <span class="skolem">c</span>"</span></span>
   <span class="keyword1"><span class="command">proof</span></span> <span class="operator">induct</span>
     <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Obs <span class="skolem">c</span> <span class="skolem">s</span> <span class="skolem">t</span> <span class="skolem">i</span><span class="main">)</span>
     <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c1</span></span> <span class="skolem"><span class="skolem">c2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> brn <span class="skolem">c1</span>"</span></span>
     <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">=</span> <span class="skolem">c1</span> <span class="main">;;</span> <span class="skolem">c2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"siso <span class="skolem">c1</span> <span class="main">∧</span> siso <span class="skolem">c2</span>"</span></span>
     <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">≈</span> <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
     <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"finished <span class="main">(</span>cont <span class="skolem">c1</span> <span class="skolem">s</span> <span class="skolem">i</span><span class="main">)</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>
   <span class="keyword1"><span class="command">next</span></span>
     <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cont <span class="skolem">c</span> <span class="skolem">s</span> <span class="skolem">i</span><span class="main">)</span>
     <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c1</span></span> <span class="skolem"><span class="skolem">c2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> brn <span class="skolem">c1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
     <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">=</span> <span class="skolem">c1</span> <span class="main">;;</span> <span class="skolem">c2</span> <span class="main">∧</span> siso <span class="skolem">c1</span> <span class="main">∧</span> siso <span class="skolem">c2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
     <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"finished <span class="main">(</span>cont <span class="skolem">c1</span> <span class="skolem">s</span> <span class="skolem">i</span><span class="main">)</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
   <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Compositionality-siso_While"><span class="command">lemma</span></span> siso_While<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"compatTst <span class="free">tst</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"siso <span class="free">c</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"siso <span class="main">(</span>While <span class="free">tst</span> <span class="free">c</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">fix</span></span> <span class="skolem">c</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'test</span><span class="main">,</span> <span class="tfree">'atom</span><span class="main">,</span> <span class="tfree">'choice</span><span class="main">)</span> cmd"</span></span>
   <span class="keyword3"><span class="command">assume</span></span>
   <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span> <span class="bound">tst</span> <span class="bound">d</span><span class="main">.</span> compatTst <span class="bound">tst</span> <span class="main">∧</span> <span class="skolem">c</span> <span class="main">=</span> While <span class="bound">tst</span> <span class="bound">d</span> <span class="main">∧</span> siso <span class="bound">d</span><span class="main">)</span> <span class="main">∨</span>
    <span class="main">(</span><span class="main">∃</span> <span class="bound">tst</span> <span class="bound">d1</span> <span class="bound">d</span><span class="main">.</span> compatTst <span class="bound">tst</span> <span class="main">∧</span> <span class="skolem">c</span> <span class="main">=</span> <span class="bound">d1</span> <span class="main">;;</span> <span class="main">(</span>While <span class="bound">tst</span> <span class="bound">d</span><span class="main">)</span> <span class="main">∧</span> siso <span class="bound">d1</span> <span class="main">∧</span> siso <span class="bound">d</span><span class="main">)</span>"</span></span>
   <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"siso <span class="skolem">c</span>"</span></span>
   <span class="keyword1"><span class="command">proof</span></span> <span class="operator">induct</span>
     <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Obs <span class="skolem">c</span> <span class="skolem">s</span> <span class="skolem">t</span> <span class="skolem">i</span><span class="main">)</span>
     <span class="keyword1"><span class="command">hence</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="skolem">i</span> <span class="main">&lt;</span> brn <span class="skolem">c</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> st<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">≈</span> <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
     <span class="keyword1"><span class="command">from</span></span> Obs <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
     <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">elim</span> disjE exE conjE<span class="main">)</span>
       <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">tst</span> <span class="skolem">d</span>
       <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"compatTst <span class="skolem">tst</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">=</span> While <span class="skolem">tst</span> <span class="skolem">d</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"siso <span class="skolem">d</span>"</span></span>
       <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> i st <span class="keyword1"><span class="command">unfolding</span></span> compatTst_def
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">tval</span> <span class="skolem">tst</span> <span class="skolem">s</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
     <span class="keyword1"><span class="command">next</span></span>
       <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">tst</span> <span class="skolem">d1</span> <span class="skolem">d</span>
       <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"compatTst <span class="skolem">tst</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">=</span> <span class="skolem">d1</span> <span class="main">;;</span> While <span class="skolem">tst</span> <span class="skolem">d</span>"</span></span>
       <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"siso <span class="skolem">d1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"siso <span class="skolem">d</span>"</span></span>
       <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
       <span class="keyword1"><span class="command">using</span></span> i st <span class="keyword1"><span class="command">unfolding</span></span> compatTst_def
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">tval</span> <span class="skolem">tst</span> <span class="skolem">s</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"finished <span class="main">(</span>cont <span class="skolem">d1</span> <span class="skolem">s</span> <span class="skolem">i</span><span class="main">)</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
     <span class="keyword1"><span class="command">qed</span></span>
   <span class="keyword1"><span class="command">next</span></span>
     <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cont <span class="skolem">c</span> <span class="skolem">s</span> <span class="skolem">i</span><span class="main">)</span>
     <span class="keyword1"><span class="command">hence</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="skolem">i</span> <span class="main">&lt;</span> brn <span class="skolem">c</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
     <span class="keyword1"><span class="command">from</span></span> Cont <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
     <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">elim</span> disjE exE conjE<span class="main">)</span>
       <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">tst</span> <span class="skolem">d</span>
       <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"compatTst <span class="skolem">tst</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">=</span> While <span class="skolem">tst</span> <span class="skolem">d</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"siso <span class="skolem">d</span>"</span></span>
       <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">tval</span> <span class="skolem">tst</span> <span class="skolem">s</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
     <span class="keyword1"><span class="command">next</span></span>
       <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">tst</span> <span class="skolem">d1</span> <span class="skolem">d</span>
       <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"compatTst <span class="skolem">tst</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">=</span> <span class="skolem">d1</span> <span class="main">;;</span> While <span class="skolem">tst</span> <span class="skolem">d</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"siso <span class="skolem">d1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"siso <span class="skolem">d</span>"</span></span>
       <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> i <span class="keyword1"><span class="command">unfolding</span></span> compatTst_def
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">tval</span> <span class="skolem">tst</span> <span class="skolem">s</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"finished <span class="main">(</span>cont <span class="skolem">d1</span> <span class="skolem">s</span> <span class="skolem">i</span><span class="main">)</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
     <span class="keyword1"><span class="command">qed</span></span>
   <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Compositionality-siso_Ch"><span class="command">lemma</span></span> siso_Ch<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"compatCh <span class="free">ch</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"siso <span class="free">c1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"siso <span class="free">c2</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"siso <span class="main">(</span>Ch <span class="free">ch</span> <span class="free">c1</span> <span class="free">c2</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">fix</span></span> <span class="skolem">c</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'test</span><span class="main">,</span> <span class="tfree">'atom</span><span class="main">,</span> <span class="tfree">'choice</span><span class="main">)</span> cmd"</span></span>
   <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">ch</span> <span class="bound">c1</span> <span class="bound">c2</span><span class="main">.</span> compatCh <span class="bound">ch</span> <span class="main">∧</span> <span class="skolem">c</span> <span class="main">=</span> Ch <span class="bound">ch</span> <span class="bound">c1</span> <span class="bound">c2</span> <span class="main">∧</span> siso <span class="bound">c1</span> <span class="main">∧</span> siso <span class="bound">c2</span>"</span></span>
   <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"siso <span class="skolem">c</span>"</span></span>
   <span class="keyword1"><span class="command">proof</span></span> <span class="operator">induct</span>
     <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Obs <span class="skolem">c</span> <span class="skolem">s</span> <span class="skolem">t</span> <span class="skolem">i</span><span class="main">)</span>
     <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ch</span></span> <span class="skolem"><span class="skolem">c1</span></span> <span class="skolem"><span class="skolem">c2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="numeral">2</span>"</span></span>
     <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"compatCh <span class="skolem">ch</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">=</span> Ch <span class="skolem">ch</span> <span class="skolem">c1</span> <span class="skolem">c2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"siso <span class="skolem">c1</span> <span class="main">∧</span> siso <span class="skolem">c2</span>"</span></span>
     <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">≈</span> <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
     <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">)</span> <span class="operator">auto</span>
   <span class="keyword1"><span class="command">next</span></span>
     <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cont <span class="skolem">c</span> <span class="skolem">s</span> <span class="skolem">i</span><span class="main">)</span>
     <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ch</span></span> <span class="skolem"><span class="skolem">c1</span></span> <span class="skolem"><span class="skolem">c2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="numeral">2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
     <span class="quoted"><span class="quoted">"compatCh <span class="skolem">ch</span> <span class="main">∧</span> <span class="skolem">c</span> <span class="main">=</span> Ch <span class="skolem">ch</span> <span class="skolem">c1</span> <span class="skolem">c2</span> <span class="main">∧</span> siso <span class="skolem">c1</span> <span class="main">∧</span> siso <span class="skolem">c2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
     <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">)</span> <span class="operator">auto</span>
   <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Compositionality-siso_Par"><span class="command">lemma</span></span> siso_Par<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"properL <span class="free">cl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"sisoL <span class="free">cl</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"siso <span class="main">(</span>Par <span class="free">cl</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">fix</span></span> <span class="skolem">c</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'test</span><span class="main">,</span> <span class="tfree">'atom</span><span class="main">,</span> <span class="tfree">'choice</span><span class="main">)</span> cmd"</span></span>
   <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">cl</span><span class="main">.</span> <span class="skolem">c</span> <span class="main">=</span> Par <span class="bound">cl</span> <span class="main">∧</span> properL <span class="bound">cl</span> <span class="main">∧</span> sisoL <span class="bound">cl</span>"</span></span>
   <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"siso <span class="skolem">c</span>"</span></span>
   <span class="keyword1"><span class="command">proof</span></span> <span class="operator">induct</span>
     <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Obs <span class="skolem">c</span> <span class="skolem">s</span> <span class="skolem">t</span> <span class="skolem">ii</span><span class="main">)</span>
     <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">cl</span></span> <span class="keyword2"><span class="keyword">where</span></span> ii<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ii</span> <span class="main">&lt;</span> brnL <span class="skolem">cl</span> <span class="main">(</span>length <span class="skolem">cl</span><span class="main">)</span>"</span></span>
     <span class="keyword2"><span class="keyword">and</span></span> cl<span class="main">:</span> <span class="quoted"><span class="quoted">"properL <span class="skolem">cl</span>"</span></span>
     <span class="keyword2"><span class="keyword">and</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">=</span> Par <span class="skolem">cl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> siso<span class="main">:</span> <span class="quoted"><span class="quoted">"sisoL <span class="skolem">cl</span>"</span></span>
     <span class="keyword2"><span class="keyword">and</span></span> st<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">≈</span> <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
     <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?N</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"length <span class="skolem">cl</span>"</span></span>
     <span class="keyword1"><span class="command">from</span></span> cl ii <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> brnL_cases<span class="main">)</span>
     <span class="keyword1"><span class="command">using</span></span> siso st cl <span class="keyword1"><span class="command">unfolding</span></span> c <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
   <span class="keyword1"><span class="command">next</span></span>
     <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cont <span class="skolem">c</span> <span class="skolem">s</span> <span class="skolem">ii</span><span class="main">)</span>
     <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">cl</span></span> <span class="keyword2"><span class="keyword">where</span></span> ii<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ii</span> <span class="main">&lt;</span> brnL <span class="skolem">cl</span> <span class="main">(</span>length <span class="skolem">cl</span><span class="main">)</span>"</span></span>
     <span class="keyword2"><span class="keyword">and</span></span> cl<span class="main">:</span> <span class="quoted"><span class="quoted">"properL <span class="skolem">cl</span>"</span></span>
     <span class="keyword2"><span class="keyword">and</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">=</span> Par <span class="skolem">cl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> sisoL<span class="main">:</span> <span class="quoted"><span class="quoted">"sisoL <span class="skolem">cl</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
     <span class="keyword1"><span class="command">from</span></span> cl ii <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> brnL_cases<span class="main">)</span>
     <span class="keyword1"><span class="command">using</span></span> cl sisoL <span class="keyword1"><span class="command">unfolding</span></span> c <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
   <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Compositionality-siso_ParT"><span class="command">lemma</span></span> siso_ParT<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"properL <span class="free">cl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"sisoL <span class="free">cl</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"siso <span class="main">(</span>ParT <span class="free">cl</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">fix</span></span> <span class="skolem">c</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'test</span><span class="main">,</span> <span class="tfree">'atom</span><span class="main">,</span> <span class="tfree">'choice</span><span class="main">)</span> cmd"</span></span>
   <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">cl</span><span class="main">.</span> <span class="skolem">c</span> <span class="main">=</span> ParT <span class="bound">cl</span> <span class="main">∧</span> properL <span class="bound">cl</span> <span class="main">∧</span> sisoL <span class="bound">cl</span>"</span></span>
   <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"siso <span class="skolem">c</span>"</span></span>
   <span class="keyword1"><span class="command">proof</span></span> <span class="operator">induct</span>
     <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Obs <span class="skolem">c</span> <span class="skolem">s</span> <span class="skolem">t</span> <span class="skolem">ii</span><span class="main">)</span>
     <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">cl</span></span> <span class="keyword2"><span class="keyword">where</span></span> ii<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ii</span> <span class="main">&lt;</span> brnL <span class="skolem">cl</span> <span class="main">(</span>length <span class="skolem">cl</span><span class="main">)</span>"</span></span>
     <span class="keyword2"><span class="keyword">and</span></span> cl<span class="main">:</span> <span class="quoted"><span class="quoted">"properL <span class="skolem">cl</span>"</span></span>
     <span class="keyword2"><span class="keyword">and</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">=</span> ParT <span class="skolem">cl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> siso<span class="main">:</span> <span class="quoted"><span class="quoted">"sisoL <span class="skolem">cl</span>"</span></span>
     <span class="keyword2"><span class="keyword">and</span></span> st<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">≈</span> <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
     <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?N</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"length <span class="skolem">cl</span>"</span></span>
     <span class="keyword1"><span class="command">from</span></span> cl ii <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> brnL_cases<span class="main">)</span>
       <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Local <span class="skolem">n</span> <span class="skolem">i</span><span class="main">)</span>
       <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?eff</span> <span class="main">∧</span> <span class="var">?wt</span> <span class="main">∧</span> <span class="var">?mv</span>"</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
         <span class="keyword1"><span class="command">have</span></span> eff_mv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?eff</span> <span class="main">∧</span> <span class="var">?mv</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Local siso cl st <span class="keyword1"><span class="command">unfolding</span></span> c <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
         <span class="keyword1"><span class="command">have</span></span> wt<span class="main">:</span> <span class="var"><span class="quoted"><span class="var">?wt</span></span></span>
         <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"WtFT <span class="skolem">cl</span> <span class="main">=</span> <span class="main">1</span>"</span></span><span class="main">)</span>
           <span class="keyword3"><span class="command">case</span></span> True
           <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> c <span class="keyword1"><span class="command">using</span></span> Local cl st siso True
           <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> pickFT <span class="skolem">cl</span> <span class="main">∧</span> <span class="skolem">i</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>
         <span class="keyword1"><span class="command">next</span></span>
           <span class="keyword3"><span class="command">case</span></span> False
           <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> c <span class="keyword1"><span class="command">using</span></span> Local cl st siso False
           <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"finished <span class="main">(</span><span class="skolem">cl</span><span class="main">!</span><span class="skolem">n</span><span class="main">)</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>
         <span class="keyword1"><span class="command">qed</span></span>
         <span class="keyword1"><span class="command">from</span></span> eff_mv wt <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
       <span class="keyword1"><span class="command">qed</span></span>
     <span class="keyword1"><span class="command">qed</span></span>
   <span class="keyword1"><span class="command">next</span></span>
     <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cont <span class="skolem">c</span> <span class="skolem">s</span> <span class="skolem">ii</span><span class="main">)</span>
     <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">cl</span></span> <span class="keyword2"><span class="keyword">where</span></span> ii<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ii</span> <span class="main">&lt;</span> brnL <span class="skolem">cl</span> <span class="main">(</span>length <span class="skolem">cl</span><span class="main">)</span>"</span></span>
     <span class="keyword2"><span class="keyword">and</span></span> cl<span class="main">:</span> <span class="quoted"><span class="quoted">"properL <span class="skolem">cl</span>"</span></span>
     <span class="keyword2"><span class="keyword">and</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">=</span> ParT <span class="skolem">cl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> siso<span class="main">:</span> <span class="quoted"><span class="quoted">"sisoL <span class="skolem">cl</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
     <span class="keyword1"><span class="command">from</span></span> cl ii <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> brnL_cases<span class="main">)</span>
     <span class="keyword1"><span class="command">using</span></span> siso cl <span class="keyword1"><span class="command">unfolding</span></span> c <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
   <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Self-isomorphism implies strong bisimilarity:›</span></span>

<span class="keyword1" id="Compositionality-bij_betw_emp"><span class="command">lemma</span></span> bij_betw_emp<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="quoted"><span class="quoted">"bij_betw <span class="free">f</span> <span class="main">{}</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> bij_betw_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Compositionality-part_full"><span class="command">lemma</span></span> part_full<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="quoted"><span class="quoted">"part <span class="free">I</span> <span class="main">{</span><span class="free">I</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> part_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">singlPart</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">singlPart</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">{</span><span class="bound">i</span><span class="main">}</span> <span class="main">|</span> <span class="bound">i</span> <span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1" id="Compositionality-part_singlPart"><span class="command">lemma</span></span> part_singlPart<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="quoted"><span class="quoted">"part <span class="free">I</span> <span class="main">(</span>singlPart <span class="free">I</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> part_def singlPart_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Compositionality-singlPart_inj_on"><span class="command">lemma</span></span> singlPart_inj_on<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="quoted"><span class="quoted">"inj_on <span class="main">(</span>image <span class="free">f</span><span class="main">)</span> <span class="main">(</span>singlPart <span class="free">I</span><span class="main">)</span> <span class="main">=</span> inj_on <span class="free">f</span> <span class="free">I</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> inj_on_def singlPart_def
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> image_insert insertI1 insert_absorb insert_code singleton_inject<span class="main">)</span>

<span class="keyword1" id="Compositionality-singlPart_surj"><span class="command">lemma</span></span> singlPart_surj<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="main">(</span>image <span class="free">f</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span>singlPart <span class="free">I</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>singlPart <span class="free">J</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">f</span> <span class="main">`</span> <span class="free">I</span> <span class="main">=</span> <span class="free">J</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> inj_on_def singlPart_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Compositionality-singlPart_bij_betw"><span class="command">lemma</span></span> singlPart_bij_betw<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="quoted"><span class="quoted">"bij_betw <span class="main">(</span>image <span class="free">f</span><span class="main">)</span> <span class="main">(</span>singlPart <span class="free">I</span><span class="main">)</span> <span class="main">(</span>singlPart <span class="free">J</span><span class="main">)</span> <span class="main">=</span> bij_betw <span class="free">f</span> <span class="free">I</span> <span class="free">J</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> bij_betw_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Compositionality-singlPart_finite1"><span class="command">lemma</span></span> singlPart_finite1<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>singlPart <span class="free">I</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="free">I</span><span class="main">::</span><span class="tfree">'a</span> set<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="skolem">i</span> <span class="main">=</span> <span class="main">{</span><span class="skolem">i</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">`</span> <span class="free">I</span> <span class="main">⊆</span> singlPart <span class="free">I</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> u_def singlPart_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="skolem">u</span> <span class="free">I</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> u_def inj_on_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹inj_on <span class="skolem">u</span> <span class="free">I</span>›</span></span> finite_imageD infinite_super<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Compositionality-singlPart_finite"><span class="command">lemma</span></span> singlPart_finite<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="quoted"><span class="quoted">"finite <span class="main">(</span>singlPart <span class="free">I</span><span class="main">)</span> <span class="main">=</span> finite <span class="free">I</span>"</span></span>
 <span class="keyword1"><span class="command">using</span></span> singlPart_finite1<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">I</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> singlPart_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Compositionality-emp_notIn_singlPart"><span class="command">lemma</span></span> emp_notIn_singlPart<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="main">{}</span> <span class="main">∉</span> singlPart <span class="free">I</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> singlPart_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Compositionality-Sbis_coinduct"><span class="command">lemma</span></span> Sbis_coinduct<span class="main">[</span><span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">case_names</span> step<span class="main">,</span> <span class="operator">coinduct</span> <span class="quasi_keyword"><span class="quasi_keyword">set</span></span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="free">c</span> <span class="free">d</span> <span class="main">⟹</span>
    <span class="main">(</span><span class="main">⋀</span><span class="bound">c</span> <span class="bound">d</span> <span class="bound">s</span> <span class="bound">t</span><span class="main">.</span> <span class="free">R</span> <span class="bound">c</span> <span class="bound">d</span> <span class="main">⟹</span> <span class="bound">s</span> <span class="main">≈</span> <span class="bound">t</span> <span class="main">⟹</span>
      <span class="main">∃</span><span class="bound">P</span> <span class="bound">F</span><span class="main">.</span> mC_C_part <span class="bound">c</span> <span class="bound">d</span> <span class="bound">P</span> <span class="bound">F</span> <span class="main">∧</span> inj_on <span class="bound">F</span> <span class="bound">P</span> <span class="main">∧</span> mC_C_wt <span class="bound">c</span> <span class="bound">d</span> <span class="bound">s</span> <span class="bound">t</span> <span class="bound">P</span> <span class="bound">F</span> <span class="main">∧</span>
        <span class="main">(</span><span class="main">∀</span><span class="bound">I</span><span class="main">∈</span><span class="bound">P</span><span class="main">.</span> <span class="main">∀</span><span class="bound">i</span><span class="main">∈</span><span class="bound">I</span><span class="main">.</span> <span class="main">∀</span><span class="bound">j</span><span class="main">∈</span><span class="bound">F</span> <span class="bound">I</span><span class="main">.</span> 
                eff <span class="bound">c</span> <span class="bound">s</span> <span class="bound">i</span> <span class="main">≈</span> eff <span class="bound">d</span> <span class="bound">t</span> <span class="bound">j</span> <span class="main">∧</span> <span class="main">(</span><span class="free">R</span> <span class="main">(</span>cont <span class="bound">c</span> <span class="bound">s</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span>cont <span class="bound">d</span> <span class="bound">t</span> <span class="bound">j</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span>cont <span class="bound">c</span> <span class="bound">s</span> <span class="bound">i</span><span class="main">,</span> cont <span class="bound">d</span> <span class="bound">t</span> <span class="bound">j</span><span class="main">)</span> <span class="main">∈</span> Sbis<span class="main">)</span><span class="main">)</span><span class="main">)</span>
  <span class="main">⟹</span> <span class="main">(</span><span class="free">c</span><span class="main">,</span> <span class="free">d</span><span class="main">)</span> <span class="main">∈</span> Sbis"</span></span>
  <span class="keyword1"><span class="command">using</span></span> Sbis_coind<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="free">R</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">}</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">unfolding</span></span> Sretr_def matchC_C_def mC_C_def mC_C_eff_cont_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subset_eq Ball_def <span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Compositionality-siso_Sbis"><span class="command">lemma</span></span> siso_Sbis<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"siso <span class="free">c</span> <span class="main">⟹</span> <span class="free">c</span> <span class="keyword1">≈s</span> <span class="free">c</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">c</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">s</span> <span class="skolem">t</span> <span class="skolem">c</span><span class="main">)</span> <span class="keyword1"><span class="command">with</span></span> siso_cont_indis<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">c</span></span> <span class="quoted"><span class="skolem">s</span></span> <span class="quoted"><span class="skolem">t</span></span><span class="main">]</span> part_singlPart<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">{..&lt;</span>brn <span class="skolem">c</span><span class="main">}</span>"</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"singlPart <span class="main"><span class="main"><span class="main">{..&lt;</span></span></span> brn <span class="skolem"><span class="skolem"><span class="skolem">c</span></span></span><span class="main"><span class="main"><span class="main">}</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">id</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mC_C_part_def mC_C_wt_def singlPart_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Discreetness versus language constructs:›</span></span>

<span class="keyword1" id="Compositionality-discr_Done"><span class="command">lemma</span></span> discr_Done<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"discr Done"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">coinduction</span> <span class="operator">auto</span>

<span class="keyword1" id="Compositionality-discr_Atm_presAtm"><span class="command">lemma</span></span> discr_Atm_presAtm<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"discr <span class="main">(</span>Atm <span class="free">atm</span><span class="main">)</span> <span class="main">=</span> presAtm <span class="free">atm</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"presAtm <span class="free">atm</span> <span class="main">⟹</span> discr <span class="main">(</span>Atm <span class="free">atm</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">atm</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> presAtm_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"discr <span class="main">(</span>Atm <span class="free">atm</span><span class="main">)</span> <span class="main">⟹</span> presAtm <span class="free">atm</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> presAtm_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> One_nat_def brn.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> discr.simps eff_Atm lessI<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Compositionality-discr_Seq"><span class="command">lemma</span></span> discr_Seq<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"discr <span class="free">c1</span> <span class="main">⟹</span> discr <span class="free">c2</span> <span class="main">⟹</span> discr <span class="main">(</span><span class="free">c1</span> <span class="main">;;</span> <span class="free">c2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">c1</span></span> <span class="quoted"><span class="free">c2</span></span><span class="main">)</span>
     <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> cont_Seq_finished discr_cont cont_Seq_notFinished<span class="main">)</span>

<span class="keyword1" id="Compositionality-discr_While"><span class="command">lemma</span></span> discr_While<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"discr <span class="free">c</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"discr <span class="main">(</span>While <span class="free">tst</span> <span class="free">c</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">fix</span></span> <span class="skolem">c</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'test</span><span class="main">,</span> <span class="tfree">'atom</span><span class="main">,</span> <span class="tfree">'choice</span><span class="main">)</span> cmd"</span></span>
   <span class="keyword3"><span class="command">assume</span></span>
   <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span> <span class="bound">tst</span> <span class="bound">d</span><span class="main">.</span> <span class="skolem">c</span> <span class="main">=</span> While <span class="bound">tst</span> <span class="bound">d</span> <span class="main">∧</span> discr <span class="bound">d</span><span class="main">)</span> <span class="main">∨</span>
    <span class="main">(</span><span class="main">∃</span> <span class="bound">tst</span> <span class="bound">d1</span> <span class="bound">d</span><span class="main">.</span> <span class="skolem">c</span> <span class="main">=</span> <span class="bound">d1</span> <span class="main">;;</span> <span class="main">(</span>While <span class="bound">tst</span> <span class="bound">d</span><span class="main">)</span> <span class="main">∧</span> discr <span class="bound">d1</span> <span class="main">∧</span> discr <span class="bound">d</span><span class="main">)</span>"</span></span>
   <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"discr <span class="skolem">c</span>"</span></span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">induct</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> eff_While indis_refl<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> cont_While_False discr_Done cont_While_True<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> eff_Seq discr.simps brn.simps<span class="main">)</span>
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> cont_Seq_finished discr.simps cont_Seq_notFinished brn.simps<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Compositionality-discr_Ch"><span class="command">lemma</span></span> discr_Ch<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"discr <span class="free">c1</span> <span class="main">⟹</span> discr <span class="free">c2</span> <span class="main">⟹</span> discr <span class="main">(</span>Ch <span class="free">ch</span> <span class="free">c1</span> <span class="free">c2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">coinduction</span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> indis_refl less_2_cases cont_Ch_L cont_Ch_R<span class="main">)</span>

<span class="keyword1" id="Compositionality-discr_Par"><span class="command">lemma</span></span> discr_Par<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"properL <span class="free">cl</span> <span class="main">⟹</span> discrL <span class="free">cl</span> <span class="main">⟹</span> discr <span class="main">(</span>Par <span class="free">cl</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">cl</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">cl</span> <span class="skolem">ii</span> <span class="skolem">s</span>
  <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"properL <span class="skolem">cl</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ii</span> <span class="main">&lt;</span> brnL <span class="skolem">cl</span> <span class="main">(</span>length <span class="skolem">cl</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"discrL <span class="skolem">cl</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> * <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">≈</span> eff <span class="main">(</span>Par <span class="skolem">cl</span><span class="main">)</span> <span class="skolem">s</span> <span class="skolem">ii</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">(</span><span class="main">∃</span><span class="bound">cl'</span><span class="main">.</span> cont <span class="main">(</span>Par <span class="skolem">cl</span><span class="main">)</span> <span class="skolem">s</span> <span class="skolem">ii</span> <span class="main">=</span> Par <span class="bound">cl'</span> <span class="main">∧</span> properL <span class="bound">cl'</span> <span class="main">∧</span> discrL <span class="bound">cl'</span><span class="main">)</span> <span class="main">∨</span> discr <span class="main">(</span>cont <span class="main">(</span>Par <span class="skolem">cl</span><span class="main">)</span> <span class="skolem">s</span> <span class="skolem">ii</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> brnL_cases<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Local <span class="skolem">n</span> <span class="skolem">i</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹discrL <span class="skolem">cl</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">≈</span> eff <span class="main">(</span><span class="skolem">cl</span> <span class="main">!</span> <span class="skolem">n</span><span class="main">)</span> <span class="skolem">s</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> Local <span class="quoted"><span class="quoted">‹discrL <span class="skolem">cl</span>›</span></span> <span class="quoted"><span class="quoted">‹properL <span class="skolem">cl</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Compositionality-discr_ParT"><span class="command">lemma</span></span> discr_ParT<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"properL <span class="free">cl</span> <span class="main">⟹</span> discrL <span class="free">cl</span> <span class="main">⟹</span> discr <span class="main">(</span>ParT <span class="free">cl</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">cl</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span> <span class="skolem">cl</span> <span class="skolem">s</span> <span class="skolem">ii</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"properL <span class="skolem">cl</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ii</span> <span class="main">&lt;</span> brnL <span class="skolem">cl</span> <span class="main">(</span>length <span class="skolem">cl</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"discrL <span class="skolem">cl</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">≈</span> eff <span class="main">(</span>ParT <span class="skolem">cl</span><span class="main">)</span> <span class="skolem">s</span> <span class="skolem">ii</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">(</span><span class="main">∃</span><span class="bound">cl'</span><span class="main">.</span> cont <span class="main">(</span>ParT <span class="skolem">cl</span><span class="main">)</span> <span class="skolem">s</span> <span class="skolem">ii</span> <span class="main">=</span> ParT <span class="bound">cl'</span> <span class="main">∧</span> properL <span class="bound">cl'</span> <span class="main">∧</span> discrL <span class="bound">cl'</span><span class="main">)</span> <span class="main">∨</span> discr <span class="main">(</span>cont <span class="main">(</span>ParT <span class="skolem">cl</span><span class="main">)</span> <span class="skolem">s</span> <span class="skolem">ii</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> brnL_cases<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Local <span class="skolem">n</span> <span class="skolem">i</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">≈</span> eff <span class="main">(</span><span class="skolem">cl</span> <span class="main">!</span> <span class="skolem">n</span><span class="main">)</span> <span class="skolem">s</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Local <span class="quoted"><span class="quoted">‹discrL <span class="skolem">cl</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Local <span class="quoted"><span class="quoted">‹discrL <span class="skolem">cl</span>›</span></span> <span class="quoted"><span class="quoted">‹properL <span class="skolem">cl</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Compositionality-discr_finished"><span class="command">lemma</span></span> discr_finished<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"proper <span class="free">c</span> <span class="main">⟹</span> finished <span class="free">c</span> <span class="main">⟹</span> discr <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">c</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> proper_induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> discrL_intro<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Strong bisimilarity versus language constructs›</span></span>

<span class="keyword1" id="Compositionality-Sbis_pres_discr_L"><span class="command">lemma</span></span> Sbis_pres_discr_L<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="keyword1">≈s</span> <span class="free">d</span> <span class="main">⟹</span> discr <span class="free">d</span> <span class="main">⟹</span> discr <span class="free">c</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">d</span></span> <span class="quoted"><span class="free">c</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">c</span> <span class="skolem">d</span> <span class="skolem">s</span> <span class="skolem">i</span>
  <span class="keyword3"><span class="command">assume</span></span> d<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="keyword1">≈s</span> <span class="skolem">d</span>"</span></span> <span class="quoted"><span class="quoted">"discr <span class="skolem">d</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> brn <span class="skolem">c</span>"</span></span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">P</span></span> <span class="skolem"><span class="skolem">F</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    match<span class="main">:</span> <span class="quoted"><span class="quoted">"mC_C Sbis <span class="skolem">c</span> <span class="skolem">d</span> <span class="skolem">s</span> <span class="skolem">s</span> <span class="skolem">P</span> <span class="skolem">F</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Sbis_mC_C<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">c</span></span> <span class="quoted"><span class="skolem">d</span></span> <span class="quoted"><span class="skolem">s</span></span> <span class="quoted"><span class="skolem">s</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span><span class="skolem">P</span> <span class="main">=</span> <span class="main">{..&lt;</span>brn <span class="skolem">c</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> i <span class="keyword1"><span class="command">unfolding</span></span> mC_C_def mC_C_part_def part_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">I</span></span> <span class="keyword2"><span class="keyword">where</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">I</span> <span class="main">∈</span> <span class="skolem">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="skolem">I</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> i <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∈</span> <span class="skolem">F</span> <span class="skolem">I</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> match I <span class="keyword1"><span class="command">unfolding</span></span> mC_C_def mC_C_part_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> brn <span class="skolem">d</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> I match
    <span class="keyword1"><span class="command">unfolding</span></span> mC_C_def mC_C_part_def part_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> md<span class="main">:</span> <span class="quoted"><span class="quoted">"discr <span class="main">(</span>cont <span class="skolem">d</span> <span class="skolem">s</span> <span class="skolem">j</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">≈</span> eff <span class="skolem">d</span> <span class="skolem">s</span> <span class="skolem">j</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> d discr_cont<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">d</span></span> <span class="quoted"><span class="skolem">j</span></span> <span class="quoted"><span class="skolem">s</span></span><span class="main">]</span> discr_eff_indis<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">d</span></span> <span class="quoted"><span class="skolem">j</span></span> <span class="quoted"><span class="skolem">s</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eff <span class="skolem">c</span> <span class="skolem">s</span> <span class="skolem">i</span> <span class="main">≈</span> eff <span class="skolem">d</span> <span class="skolem">s</span> <span class="skolem">j</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> md2<span class="main">:</span> <span class="quoted"><span class="quoted">"cont <span class="skolem">c</span> <span class="skolem">s</span> <span class="skolem">i</span> <span class="keyword1">≈s</span> cont <span class="skolem">d</span> <span class="skolem">s</span> <span class="skolem">j</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> I i j match <span class="keyword1"><span class="command">unfolding</span></span> mC_C_def mC_C_eff_cont_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">≈</span> eff <span class="skolem">c</span> <span class="skolem">s</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> s indis_sym indis_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">≈</span> eff <span class="skolem">c</span> <span class="skolem">s</span> <span class="skolem">i</span> <span class="main">∧</span> <span class="main">(</span><span class="main">(</span><span class="main">∃</span><span class="bound">d</span><span class="main">.</span> cont <span class="skolem">c</span> <span class="skolem">s</span> <span class="skolem">i</span> <span class="keyword1">≈s</span> <span class="bound">d</span> <span class="main">∧</span> discr <span class="bound">d</span><span class="main">)</span> <span class="main">∨</span> discr <span class="main">(</span>cont <span class="skolem">c</span> <span class="skolem">s</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> md md2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Compositionality-Sbis_pres_discr_R"><span class="command">lemma</span></span> Sbis_pres_discr_R<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"discr <span class="free">c</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="keyword1">≈s</span> <span class="free">d</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"discr <span class="free">d</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms Sbis_pres_discr_L Sbis_sym <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Compositionality-Sbis_finished_discr_L"><span class="command">lemma</span></span> Sbis_finished_discr_L<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="keyword1">≈s</span> <span class="free">d</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"proper <span class="free">d</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"finished <span class="free">d</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"discr <span class="free">c</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms Sbis_pres_discr_L <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Compositionality-Sbis_finished_discr_R"><span class="command">lemma</span></span> Sbis_finished_discr_R<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"proper <span class="free">c</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"finished <span class="free">c</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="keyword1">≈s</span> <span class="free">d</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"discr <span class="free">d</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms Sbis_pres_discr_R<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">c</span></span> <span class="quoted"><span class="free">d</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="comment1">(*  *)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">thetaSD</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">thetaSD</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">c</span><span class="main">,</span> <span class="bound">d</span><span class="main">)</span> <span class="main">|</span> <span class="bound">c</span> <span class="bound">d</span> <span class="main">.</span> proper <span class="bound">c</span> <span class="main">∧</span> proper <span class="bound">d</span> <span class="main">∧</span> discr <span class="bound">c</span> <span class="main">∧</span> discr <span class="bound">d</span><span class="main">}</span>"</span></span>

<span class="keyword1" id="Compositionality-thetaSD_Sretr"><span class="command">lemma</span></span> thetaSD_Sretr<span class="main">:</span>
<span class="quoted"><span class="quoted">"thetaSD <span class="main">⊆</span> Sretr thetaSD"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> Sretr_def matchC_C_def <span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">c</span> <span class="skolem">d</span> <span class="skolem">s</span> <span class="skolem">t</span>
  <span class="keyword3"><span class="command">assume</span></span> c_d<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">c</span><span class="main">,</span> <span class="skolem">d</span><span class="main">)</span> <span class="main">∈</span> thetaSD"</span></span> <span class="keyword2"><span class="keyword">and</span></span> st<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">≈</span> <span class="skolem">t</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"proper <span class="skolem">c</span> <span class="main">∧</span> proper <span class="skolem">d</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> thetaSD_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">{..&lt;</span>brn <span class="skolem">c</span><span class="main">}</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?F</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">%</span> <span class="bound">I</span><span class="main">.</span> <span class="main">{..&lt;</span> brn <span class="skolem">d</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{..&lt;</span>brn <span class="skolem">c</span><span class="main">}</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>  <span class="quoted"><span class="quoted">"<span class="main">{..&lt;</span>brn <span class="skolem">d</span><span class="main">}</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> p int_emp brn_gt_0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">P</span> <span class="bound">F</span><span class="main">.</span> mC_C thetaSD <span class="skolem">c</span> <span class="skolem">d</span> <span class="skolem">s</span> <span class="skolem">t</span> <span class="bound">P</span> <span class="bound">F</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?P</span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?F</span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> mC_C_def <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"mC_C_part <span class="skolem">c</span> <span class="skolem">d</span> <span class="var">?P</span> <span class="var">?F</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> mC_C_part_def <span class="keyword1"><span class="command">using</span></span> 0 <span class="keyword1"><span class="command">unfolding</span></span> part_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="var">?F</span> <span class="var">?P</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> inj_on_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"mC_C_wt <span class="skolem">c</span> <span class="skolem">d</span> <span class="skolem">s</span> <span class="skolem">t</span> <span class="var">?P</span> <span class="var">?F</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> mC_C_wt_def <span class="keyword1"><span class="command">using</span></span> p <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"mC_C_eff_cont thetaSD <span class="skolem">c</span> <span class="skolem">d</span> <span class="skolem">s</span> <span class="skolem">t</span> <span class="var">?P</span> <span class="var">?F</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> mC_C_eff_cont_def <span class="keyword1"><span class="command">proof</span></span> <span class="operator">clarify</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">I</span> <span class="skolem">i</span> <span class="skolem">j</span>
      <span class="keyword3"><span class="command">assume</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> brn <span class="skolem">c</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> brn <span class="skolem">d</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">≈</span> eff <span class="skolem">c</span> <span class="skolem">s</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> c_d <span class="keyword1"><span class="command">unfolding</span></span> thetaSD_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">≈</span> eff <span class="skolem">d</span> <span class="skolem">t</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> i j c_d <span class="keyword1"><span class="command">unfolding</span></span> thetaSD_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eff <span class="skolem">c</span> <span class="skolem">s</span> <span class="skolem">i</span> <span class="main">≈</span> eff <span class="skolem">d</span> <span class="skolem">t</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> st indis_sym indis_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"eff <span class="skolem">c</span> <span class="skolem">s</span> <span class="skolem">i</span> <span class="main">≈</span> eff <span class="skolem">d</span> <span class="skolem">t</span> <span class="skolem">j</span> <span class="main">∧</span> <span class="main">(</span>cont <span class="skolem">c</span> <span class="skolem">s</span> <span class="skolem">i</span><span class="main">,</span> cont <span class="skolem">d</span> <span class="skolem">t</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">∈</span> thetaSD"</span></span>
      <span class="keyword1"><span class="command">using</span></span> c_d i j <span class="keyword1"><span class="command">unfolding</span></span> thetaSD_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Compositionality-thetaSD_Sbis"><span class="command">lemma</span></span> thetaSD_Sbis<span class="main">:</span>
<span class="quoted"><span class="quoted">"thetaSD <span class="main">⊆</span> Sbis"</span></span>
<span class="keyword1"><span class="command">using</span></span> Sbis_raw_coind thetaSD_Sretr <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">theorem</span></span> discr_Sbis<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"proper <span class="free">c</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"proper <span class="free">d</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"discr <span class="free">c</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"discr <span class="free">d</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="keyword1">≈s</span> <span class="free">d</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms thetaSD_Sbis <span class="keyword1"><span class="command">unfolding</span></span> thetaSD_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="comment1">(* Done: *)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">thetaSDone</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">thetaSDone</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span>Done<span class="main">,</span> Done<span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1" id="Compositionality-thetaSDone_Sretr"><span class="command">lemma</span></span> thetaSDone_Sretr<span class="main">:</span>
<span class="quoted"><span class="quoted">"thetaSDone <span class="main">⊆</span> Sretr thetaSDone"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> Sretr_def matchC_C_def thetaSDone_def <span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="skolem">t</span> <span class="keyword3"><span class="command">assume</span></span> st<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">≈</span> <span class="skolem">t</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">{</span><span class="main">0</span><span class="main">}</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?F</span></span></span> <span class="main">=</span> <span class="quoted">id</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">P</span> <span class="bound">F</span><span class="main">.</span> mC_C <span class="main">{</span><span class="main">(</span>Done<span class="main">,</span> Done<span class="main">)</span><span class="main">}</span> Done Done <span class="skolem">s</span> <span class="skolem">t</span> <span class="bound">P</span> <span class="bound">F</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">intro</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?P</span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">intro</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?F</span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> m_defsAll part_def <span class="keyword1"><span class="command">using</span></span> st <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Compositionality-thetaSDone_Sbis"><span class="command">lemma</span></span> thetaSDone_Sbis<span class="main">:</span>
<span class="quoted"><span class="quoted">"thetaSDone <span class="main">⊆</span> Sbis"</span></span>
<span class="keyword1"><span class="command">using</span></span> Sbis_raw_coind thetaSDone_Sretr <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">theorem</span></span> Done_Sbis<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="quoted"><span class="quoted">"Done <span class="keyword1">≈s</span> Done"</span></span>
<span class="keyword1"><span class="command">using</span></span> thetaSDone_Sbis <span class="keyword1"><span class="command">unfolding</span></span> thetaSDone_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="comment1">(* Atm: *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">thetaSAtm</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">thetaSAtm</span> <span class="free"><span class="bound"><span class="entity">atm</span></span></span> <span class="main">≡</span>
 <span class="main">{</span><span class="main">(</span>Atm <span class="free"><span class="bound"><span class="entity">atm</span></span></span><span class="main">,</span> Atm <span class="free"><span class="bound"><span class="entity">atm</span></span></span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>Done<span class="main">,</span> Done<span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1" id="Compositionality-thetaSAtm_Sretr"><span class="command">lemma</span></span> thetaSAtm_Sretr<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"compatAtm <span class="free">atm</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"thetaSAtm <span class="free">atm</span> <span class="main">⊆</span> Sretr <span class="main">(</span>thetaSAtm <span class="free">atm</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> Sretr_def matchC_C_def thetaSAtm_def <span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="skolem">t</span> <span class="keyword3"><span class="command">assume</span></span> st<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">≈</span> <span class="skolem">t</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">{</span><span class="main">0</span><span class="main">}</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?F</span></span></span> <span class="main">=</span> <span class="quoted">id</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">P</span> <span class="bound">F</span><span class="main">.</span> mC_C <span class="main">{</span><span class="main">(</span>Atm <span class="free">atm</span><span class="main">,</span> Atm <span class="free">atm</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>Done<span class="main">,</span> Done<span class="main">)</span><span class="main">}</span> Done Done <span class="skolem">s</span> <span class="skolem">t</span> <span class="bound">P</span> <span class="bound">F</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">intro</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?P</span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">intro</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?F</span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> m_defsAll part_def <span class="keyword1"><span class="command">using</span></span> st <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="skolem">t</span> <span class="keyword3"><span class="command">assume</span></span> st<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">≈</span> <span class="skolem">t</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">{</span><span class="main">0</span><span class="main">}</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?F</span></span></span> <span class="main">=</span> <span class="quoted">id</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">P</span> <span class="bound">F</span><span class="main">.</span> mC_C <span class="main">{</span><span class="main">(</span>Atm <span class="free">atm</span><span class="main">,</span> Atm <span class="free">atm</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>Done<span class="main">,</span> Done<span class="main">)</span><span class="main">}</span> <span class="main">(</span>Atm <span class="free">atm</span><span class="main">)</span> <span class="main">(</span>Atm <span class="free">atm</span><span class="main">)</span> <span class="skolem">s</span> <span class="skolem">t</span> <span class="bound">P</span> <span class="bound">F</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">intro</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?P</span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">intro</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?F</span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> m_defsAll part_def <span class="keyword1"><span class="command">using</span></span> st assms <span class="keyword1"><span class="command">unfolding</span></span> compatAtm_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Compositionality-thetaSAtm_Sbis"><span class="command">lemma</span></span> thetaSAtm_Sbis<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"compatAtm <span class="free">atm</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"thetaSAtm <span class="free">atm</span> <span class="main">⊆</span> Sbis"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms Sbis_raw_coind thetaSAtm_Sretr <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">theorem</span></span> Atm_Sbis<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"compatAtm <span class="free">atm</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Atm <span class="free">atm</span> <span class="keyword1">≈s</span> Atm <span class="free">atm</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms thetaSAtm_Sbis <span class="keyword1"><span class="command">unfolding</span></span> thetaSAtm_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="comment1">(* Seq *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">thetaSSeqI</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">thetaSSeqI</span> <span class="main">≡</span>
 <span class="main">{</span><span class="main">(</span><span class="bound">e</span> <span class="main">;;</span> <span class="bound">c</span><span class="main">,</span> <span class="bound">e</span> <span class="main">;;</span> <span class="bound">d</span><span class="main">)</span> <span class="main">|</span> <span class="bound">e</span> <span class="bound">c</span> <span class="bound">d</span> <span class="main">.</span> siso <span class="bound">e</span> <span class="main">∧</span> <span class="bound">c</span> <span class="keyword1">≈s</span> <span class="bound">d</span><span class="main">}</span>"</span></span>

<span class="keyword1" id="Compositionality-thetaSSeqI_Sretr"><span class="command">lemma</span></span> thetaSSeqI_Sretr<span class="main">:</span>
<span class="quoted"><span class="quoted">"thetaSSeqI <span class="main">⊆</span> Sretr <span class="main">(</span>thetaSSeqI <span class="keyword1">Un</span> Sbis<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> Sretr_def matchC_C_def <span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">c</span> <span class="skolem">d</span> <span class="skolem">s</span> <span class="skolem">t</span>
  <span class="keyword3"><span class="command">assume</span></span> c_d<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">c</span><span class="main">,</span> <span class="skolem">d</span><span class="main">)</span> <span class="main">∈</span> thetaSSeqI"</span></span> <span class="keyword2"><span class="keyword">and</span></span> st<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">≈</span> <span class="skolem">t</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">e</span></span> <span class="skolem"><span class="skolem">c1</span></span> <span class="skolem"><span class="skolem">d1</span></span> <span class="keyword2"><span class="keyword">where</span></span> e<span class="main">:</span> <span class="quoted"><span class="quoted">"siso <span class="skolem">e</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> c1d1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c1</span> <span class="keyword1">≈s</span> <span class="skolem">d1</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">=</span> <span class="skolem">e</span> <span class="main">;;</span> <span class="skolem">c1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> d<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">=</span> <span class="skolem">e</span> <span class="main">;;</span> <span class="skolem">d1</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> thetaSSeqI_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">{</span><span class="bound">i</span><span class="main">}</span> <span class="main">|</span> <span class="bound">i</span> <span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> brn <span class="skolem">e</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?F</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">%</span><span class="bound">I</span><span class="main">.</span> <span class="bound">I</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">P</span> <span class="bound">F</span><span class="main">.</span> mC_C <span class="main">(</span>thetaSSeqI <span class="keyword1">Un</span> Sbis<span class="main">)</span> <span class="skolem">c</span> <span class="skolem">d</span> <span class="skolem">s</span> <span class="skolem">t</span> <span class="bound">P</span> <span class="bound">F</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?P</span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?F</span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> mC_C_def <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"mC_C_part <span class="skolem">c</span> <span class="skolem">d</span> <span class="var">?P</span> <span class="var">?F</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> mC_C_part_def <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"part <span class="main">{..&lt;</span>brn <span class="skolem">c</span><span class="main">}</span> <span class="var">?P</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> part_def <span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> brn <span class="skolem">c</span>"</span></span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="main">⋃</span> <span class="var">?P</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> c e st siso_cont_indis<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">e</span></span> <span class="quoted"><span class="skolem">s</span></span> <span class="quoted"><span class="skolem">t</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">unfold</span> c<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
      <span class="comment1">(*  *)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"part <span class="main">{..&lt;</span>brn <span class="skolem">d</span><span class="main">}</span> <span class="main">(</span><span class="var">?F</span> <span class="main">`</span> <span class="var">?P</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> c d <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"mC_C_eff_cont <span class="main">(</span>thetaSSeqI <span class="keyword1">Un</span> Sbis<span class="main">)</span> <span class="skolem">c</span> <span class="skolem">d</span> <span class="skolem">s</span> <span class="skolem">t</span> <span class="var">?P</span> <span class="var">?F</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> mC_C_eff_cont_def <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> impI allI<span class="main"><span class="keyword3">,</span></span> <span class="operator">elim</span> conjE<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">I</span> <span class="skolem">i</span> <span class="skolem">j</span>
      <span class="keyword3"><span class="command">assume</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">I</span> <span class="main">∈</span> <span class="var">?P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="skolem">I</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∈</span> <span class="skolem">I</span>"</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"eff <span class="skolem">c</span> <span class="skolem">s</span> <span class="skolem">i</span> <span class="main">≈</span> eff <span class="skolem">d</span> <span class="skolem">t</span> <span class="skolem">j</span> <span class="main">∧</span> <span class="main">(</span>cont <span class="skolem">c</span> <span class="skolem">s</span> <span class="skolem">i</span><span class="main">,</span> cont <span class="skolem">d</span> <span class="skolem">t</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">∈</span> thetaSSeqI <span class="main">∪</span> Sbis"</span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">I</span> <span class="main">=</span> <span class="main">{}</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> i <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∈</span> <span class="var">?F</span> <span class="main">{</span><span class="skolem">i'</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i'</span> <span class="main">&lt;</span> brn <span class="skolem">e</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> I j <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> st c_d e i j I <span class="keyword1"><span class="command">unfolding</span></span> c d thetaSSeqI_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"finished <span class="main">(</span>cont <span class="skolem">e</span> <span class="skolem">s</span> <span class="skolem">i'</span><span class="main">)</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> st c_d c<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> m_defsAll thetaSSeqI_def part_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Compositionality-thetaSSeqI_Sbis"><span class="command">lemma</span></span> thetaSSeqI_Sbis<span class="main">:</span>
<span class="quoted"><span class="quoted">"thetaSSeqI <span class="main">⊆</span> Sbis"</span></span>
<span class="keyword1"><span class="command">using</span></span> Sbis_coind thetaSSeqI_Sretr <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">theorem</span></span> Seq_siso_Sbis<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"siso <span class="free">e</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">c2</span> <span class="keyword1">≈s</span> <span class="free">d2</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">;;</span> <span class="free">c2</span> <span class="keyword1">≈s</span> <span class="free">e</span> <span class="main">;;</span> <span class="free">d2</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms thetaSSeqI_Sbis <span class="keyword1"><span class="command">unfolding</span></span> thetaSSeqI_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="comment1">(*  *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">thetaSSeqD</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">thetaSSeqD</span> <span class="main">≡</span>
 <span class="main">{</span><span class="main">(</span><span class="bound">c1</span> <span class="main">;;</span> <span class="bound">c2</span><span class="main">,</span> <span class="bound">d1</span> <span class="main">;;</span> <span class="bound">d2</span><span class="main">)</span> <span class="main">|</span>
     <span class="bound">c1</span> <span class="bound">c2</span> <span class="bound">d1</span> <span class="bound">d2</span><span class="main">.</span>
        proper <span class="bound">c1</span> <span class="main">∧</span> proper <span class="bound">d1</span> <span class="main">∧</span> proper <span class="bound">c2</span> <span class="main">∧</span> proper <span class="bound">d2</span> <span class="main">∧</span>
        discr <span class="bound">c2</span> <span class="main">∧</span> discr <span class="bound">d2</span> <span class="main">∧</span>
        <span class="bound">c1</span> <span class="keyword1">≈s</span> <span class="bound">d1</span><span class="main">}</span>"</span></span>

<span class="keyword1" id="Compositionality-thetaSSeqD_Sretr"><span class="command">lemma</span></span> thetaSSeqD_Sretr<span class="main">:</span>
<span class="quoted"><span class="quoted">"thetaSSeqD <span class="main">⊆</span> Sretr <span class="main">(</span>thetaSSeqD <span class="keyword1">Un</span> Sbis<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> Sretr_def matchC_C_def <span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">c</span> <span class="skolem">d</span> <span class="skolem">s</span> <span class="skolem">t</span>
  <span class="keyword3"><span class="command">assume</span></span> c_d<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">c</span><span class="main">,</span> <span class="skolem">d</span><span class="main">)</span> <span class="main">∈</span> thetaSSeqD"</span></span> <span class="keyword2"><span class="keyword">and</span></span> st<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">≈</span> <span class="skolem">t</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c1</span></span> <span class="skolem"><span class="skolem">c2</span></span> <span class="skolem"><span class="skolem">d1</span></span> <span class="skolem"><span class="skolem">d2</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  c1d1<span class="main">:</span> <span class="quoted"><span class="quoted">"proper <span class="skolem">c1</span>"</span></span> <span class="quoted"><span class="quoted">"proper <span class="skolem">d1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c1</span> <span class="keyword1">≈s</span> <span class="skolem">d1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  c2d2<span class="main">:</span> <span class="quoted"><span class="quoted">"proper <span class="skolem">c2</span>"</span></span> <span class="quoted"><span class="quoted">"proper <span class="skolem">d2</span>"</span></span> <span class="quoted"><span class="quoted">"discr <span class="skolem">c2</span>"</span></span> <span class="quoted"><span class="quoted">"discr <span class="skolem">d2</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">=</span> <span class="skolem">c1</span> <span class="main">;;</span> <span class="skolem">c2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> d<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">=</span> <span class="skolem">d1</span> <span class="main">;;</span> <span class="skolem">d2</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> thetaSSeqD_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> c1d1 st <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">P</span></span> <span class="skolem"><span class="skolem">F</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> match<span class="main">:</span> <span class="quoted"><span class="quoted">"mC_C Sbis <span class="skolem">c1</span> <span class="skolem">d1</span> <span class="skolem">s</span> <span class="skolem">t</span> <span class="skolem">P</span> <span class="skolem">F</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> Sbis_mC_C <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> P<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span><span class="skolem">P</span> <span class="main">=</span> <span class="main">{..&lt;</span>brn <span class="skolem">c1</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> FP<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span> <span class="main">(</span><span class="skolem">F</span> <span class="main">`</span> <span class="skolem">P</span><span class="main">)</span> <span class="main">=</span> <span class="main">{..&lt;</span>brn <span class="skolem">d1</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> match <span class="keyword1"><span class="command">unfolding</span></span> mC_C_def mC_C_part_def part_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">P</span> <span class="bound">F</span><span class="main">.</span> mC_C <span class="main">(</span>thetaSSeqD <span class="keyword1">Un</span> Sbis<span class="main">)</span> <span class="skolem">c</span> <span class="skolem">d</span> <span class="skolem">s</span> <span class="skolem">t</span> <span class="bound">P</span> <span class="bound">F</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">P</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">F</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> mC_C_def <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"mC_C_eff_cont <span class="main">(</span>thetaSSeqD <span class="main">∪</span> Sbis<span class="main">)</span> <span class="skolem">c</span> <span class="skolem">d</span> <span class="skolem">s</span> <span class="skolem">t</span> <span class="skolem">P</span> <span class="skolem">F</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> mC_C_eff_cont_def <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">intro</span> allI impI<span class="main"><span class="keyword3">,</span></span> <span class="operator">elim</span> conjE<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="skolem">j</span> <span class="skolem">I</span> <span class="keyword3"><span class="command">assume</span></span> I <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">I</span> <span class="main">∈</span> <span class="skolem">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="skolem">I</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∈</span> <span class="skolem">F</span> <span class="skolem">I</span>"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?c1'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"cont <span class="skolem">c1</span> <span class="skolem">s</span> <span class="skolem">i</span>"</span></span>  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?d1'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"cont <span class="skolem">d1</span> <span class="skolem">t</span> <span class="skolem">j</span>"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"eff <span class="skolem">c1</span> <span class="skolem">s</span> <span class="skolem">i</span>"</span></span>  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?t'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"eff <span class="skolem">d1</span> <span class="skolem">t</span> <span class="skolem">j</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> brn <span class="skolem">c1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> i I P <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> <span class="keyword1"><span class="command">note</span></span> i <span class="main">=</span> this i
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> brn <span class="skolem">d1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> j I FP <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> <span class="keyword1"><span class="command">note</span></span> j <span class="main">=</span> this j
      <span class="keyword1"><span class="command">have</span></span> c1'd1'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?c1'</span> <span class="keyword1">≈s</span> <span class="var">?d1'</span>"</span></span>
      <span class="quoted"><span class="quoted">"proper <span class="var">?c1'</span>"</span></span> <span class="quoted"><span class="quoted">"proper <span class="var">?d1'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> c1d1 i j I match <span class="keyword1"><span class="command">unfolding</span></span> c mC_C_def mC_C_eff_cont_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"eff <span class="skolem">c</span> <span class="skolem">s</span> <span class="skolem">i</span> <span class="main">≈</span> eff <span class="skolem">d</span> <span class="skolem">t</span> <span class="skolem">j</span> <span class="main">∧</span> <span class="main">(</span>cont <span class="skolem">c</span> <span class="skolem">s</span> <span class="skolem">i</span><span class="main">,</span> cont <span class="skolem">d</span> <span class="skolem">t</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">∈</span> thetaSSeqD <span class="main">∪</span> Sbis"</span></span>
      <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?eff</span> <span class="main">∧</span> <span class="var">?cont</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">proof</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?eff</span></span></span> <span class="keyword1"><span class="command">using</span></span> match I i j <span class="keyword1"><span class="command">unfolding</span></span> c d m_defsAll <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?cont</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"finished <span class="var">?c1'</span>"</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">note</span></span> c1' <span class="main">=</span> True
          <span class="keyword1"><span class="command">hence</span></span> csi<span class="main">:</span> <span class="quoted"><span class="quoted">"cont <span class="skolem">c</span> <span class="skolem">s</span> <span class="skolem">i</span> <span class="main">=</span> <span class="skolem">c2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> i match <span class="keyword1"><span class="command">unfolding</span></span> c m_defsAll <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"finished <span class="var">?d1'</span>"</span></span><span class="main">)</span>
            <span class="keyword3"><span class="command">case</span></span> True
            <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"cont <span class="skolem">d</span> <span class="skolem">t</span> <span class="skolem">j</span> <span class="main">=</span> <span class="skolem">d2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> j match <span class="keyword1"><span class="command">unfolding</span></span> d m_defsAll <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> csi c2d2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">case</span></span> False
            <span class="keyword1"><span class="command">hence</span></span> dtj<span class="main">:</span> <span class="quoted"><span class="quoted">"cont <span class="skolem">d</span> <span class="skolem">t</span> <span class="skolem">j</span> <span class="main">=</span> <span class="var">?d1'</span> <span class="main">;;</span> <span class="skolem">d2</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> j match <span class="keyword1"><span class="command">unfolding</span></span> d m_defsAll <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"discr <span class="var">?d1'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> c1'd1'  c1' Sbis_finished_discr_R <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> c1'd1' c2d2 <span class="keyword1"><span class="command">unfolding</span></span> csi dtj <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">note</span></span> Done_c <span class="main">=</span> False
          <span class="keyword1"><span class="command">hence</span></span> csi<span class="main">:</span> <span class="quoted"><span class="quoted">"cont <span class="skolem">c</span> <span class="skolem">s</span> <span class="skolem">i</span> <span class="main">=</span> <span class="var">?c1'</span> <span class="main">;;</span> <span class="skolem">c2</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> i match <span class="keyword1"><span class="command">unfolding</span></span> c m_defsAll <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"finished <span class="main">(</span>cont <span class="skolem">d1</span> <span class="skolem">t</span> <span class="skolem">j</span><span class="main">)</span>"</span></span><span class="main">)</span>
            <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">note</span></span> d1' <span class="main">=</span> True
            <span class="keyword1"><span class="command">hence</span></span> dtj<span class="main">:</span> <span class="quoted"><span class="quoted">"cont <span class="skolem">d</span> <span class="skolem">t</span> <span class="skolem">j</span> <span class="main">=</span> <span class="skolem">d2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> j match <span class="keyword1"><span class="command">unfolding</span></span> d m_defsAll <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"discr <span class="var">?c1'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> c1'd1'  d1' Sbis_finished_discr_L <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> c1'd1' c2d2 <span class="keyword1"><span class="command">unfolding</span></span> csi dtj <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">case</span></span> False
            <span class="keyword1"><span class="command">hence</span></span> dtj<span class="main">:</span> <span class="quoted"><span class="quoted">"cont <span class="skolem">d</span> <span class="skolem">t</span> <span class="skolem">j</span> <span class="main">=</span> <span class="var">?d1'</span> <span class="main">;;</span> <span class="skolem">d2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> j match <span class="keyword1"><span class="command">unfolding</span></span> d m_defsAll <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> csi dtj thetaSSeqD_def
            <span class="keyword1"><span class="command">using</span></span> c1'd1' c2d2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span><span class="main">(</span><span class="operator">insert</span> match<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> m_defsAll c d<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Compositionality-thetaSSeqD_Sbis"><span class="command">lemma</span></span> thetaSSeqD_Sbis<span class="main">:</span>
<span class="quoted"><span class="quoted">"thetaSSeqD <span class="main">⊆</span> Sbis"</span></span>
<span class="keyword1"><span class="command">using</span></span> Sbis_coind thetaSSeqD_Sretr <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">theorem</span></span> Seq_Sbis<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"proper <span class="free">c1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"proper <span class="free">d1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"proper <span class="free">c2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"proper <span class="free">d2</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">c1</span> <span class="keyword1">≈s</span> <span class="free">d1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"discr <span class="free">c2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"discr <span class="free">d2</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">c1</span> <span class="main">;;</span> <span class="free">c2</span> <span class="keyword1">≈s</span> <span class="free">d1</span> <span class="main">;;</span> <span class="free">d2</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms thetaSSeqD_Sbis <span class="keyword1"><span class="command">unfolding</span></span> thetaSSeqD_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="comment1">(* Note: no compositionality w.r.t. while loop. *)</span>

<span class="comment1">(* Ch *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">thetaSCh</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">thetaSCh</span> <span class="free"><span class="bound"><span class="entity">ch</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span> <span class="free"><span class="bound"><span class="entity">d1</span></span></span> <span class="free"><span class="bound"><span class="entity">d2</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span>Ch <span class="free"><span class="bound"><span class="entity">ch</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span><span class="main">,</span> Ch <span class="free"><span class="bound"><span class="entity">ch</span></span></span> <span class="free"><span class="bound"><span class="entity">d1</span></span></span> <span class="free"><span class="bound"><span class="entity">d2</span></span></span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1" id="Compositionality-thetaSCh_Sretr"><span class="command">lemma</span></span> thetaSCh_Sretr<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"compatCh <span class="free">ch</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">c1</span> <span class="keyword1">≈s</span> <span class="free">d1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">c2</span> <span class="keyword1">≈s</span> <span class="free">d2</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"thetaSCh <span class="free">ch</span> <span class="free">c1</span> <span class="free">c2</span> <span class="free">d1</span> <span class="free">d2</span> <span class="main">⊆</span>
       Sretr <span class="main">(</span>thetaSCh <span class="free">ch</span> <span class="free">c1</span> <span class="free">c2</span> <span class="free">d1</span> <span class="free">d2</span> <span class="main">∪</span> Sbis<span class="main">)</span>"</span></span>
<span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?th</span> <span class="main">⊆</span> Sretr <span class="main">(</span><span class="var">?th</span> <span class="main">∪</span> Sbis<span class="main">)</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">unfolding</span></span> Sretr_def matchC_C_def <span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">c</span> <span class="skolem">d</span> <span class="skolem">s</span> <span class="skolem">t</span>
  <span class="keyword3"><span class="command">assume</span></span> c_d<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">c</span><span class="main">,</span> <span class="skolem">d</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?th</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> st<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">≈</span> <span class="skolem">t</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">=</span> Ch <span class="free">ch</span> <span class="free">c1</span> <span class="free">c2</span>"</span></span> <span class="quoted"><span class="quoted">"brn <span class="skolem">c</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> d<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">=</span> Ch <span class="free">ch</span> <span class="free">d1</span> <span class="free">d2</span>"</span></span> <span class="quoted"><span class="quoted">"brn <span class="skolem">d</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> thetaSCh_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">{</span><span class="main">0</span><span class="main">}</span><span class="main">,</span> <span class="main">{</span><span class="main">1</span><span class="main">}</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?F</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">%</span><span class="bound">I</span><span class="main">.</span> <span class="bound">I</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">P</span> <span class="bound">F</span><span class="main">.</span> mC_C <span class="main">(</span><span class="var">?th</span> <span class="keyword1">Un</span> Sbis<span class="main">)</span> <span class="skolem">c</span> <span class="skolem">d</span> <span class="skolem">s</span> <span class="skolem">t</span> <span class="bound">P</span> <span class="bound">F</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?P</span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?F</span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> assms st c_d c <span class="keyword1"><span class="command">unfolding</span></span> m_defsAll thetaSCh_def part_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Compositionality-thetaSCh_Sbis"><span class="command">lemma</span></span> thetaSCh_Sbis<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"compatCh <span class="free">ch</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">c1</span> <span class="keyword1">≈s</span> <span class="free">d1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">c2</span> <span class="keyword1">≈s</span> <span class="free">d2</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"thetaSCh <span class="free">ch</span> <span class="free">c1</span> <span class="free">c2</span> <span class="free">d1</span> <span class="free">d2</span> <span class="main">⊆</span> Sbis"</span></span>
<span class="keyword1"><span class="command">using</span></span> Sbis_coind thetaSCh_Sretr<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">theorem</span></span> Ch_siso_Sbis<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"compatCh <span class="free">ch</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">c1</span> <span class="keyword1">≈s</span> <span class="free">d1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">c2</span> <span class="keyword1">≈s</span> <span class="free">d2</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Ch <span class="free">ch</span> <span class="free">c1</span> <span class="free">c2</span> <span class="keyword1">≈s</span> Ch <span class="free">ch</span> <span class="free">d1</span> <span class="free">d2</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> thetaSCh_Sbis<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> thetaSCh_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="comment1">(* Par: *)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">shift</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">shift</span> <span class="free"><span class="bound"><span class="entity">cl</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">≡</span> image <span class="main">(</span><span class="main">%</span><span class="bound">i</span><span class="main">.</span> brnL <span class="free"><span class="bound"><span class="entity">cl</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">+</span> <span class="bound">i</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted">"<span class="entity">back</span>"</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">back</span> <span class="free"><span class="bound"><span class="entity">cl</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">≡</span> image <span class="main">(</span><span class="main">%</span> <span class="bound">ii</span><span class="main">.</span> <span class="bound">ii</span> <span class="main">-</span> brnL <span class="free"><span class="bound"><span class="entity">cl</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Compositionality-emp_shift"><span class="command">lemma</span></span> emp_shift<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="quoted"><span class="quoted">"shift <span class="free">cl</span> <span class="free">n</span> <span class="free">I</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟷</span> <span class="free">I</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> shift_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Compositionality-emp_shift_rev"><span class="command">lemma</span></span> emp_shift_rev<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="main">{}</span> <span class="main">=</span> shift <span class="free">cl</span> <span class="free">n</span> <span class="free">I</span> <span class="main">⟷</span> <span class="free">I</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> shift_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Compositionality-emp_back"><span class="command">lemma</span></span> emp_back<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="quoted"><span class="quoted">"back <span class="free">cl</span> <span class="free">n</span> <span class="free">II</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟷</span> <span class="free">II</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> back_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1" id="Compositionality-emp_back_rev"><span class="command">lemma</span></span> emp_back_rev<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="main">{}</span> <span class="main">=</span> back <span class="free">cl</span> <span class="free">n</span> <span class="free">II</span> <span class="main">⟷</span> <span class="free">II</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> back_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1" id="Compositionality-in_shift"><span class="command">lemma</span></span> in_shift<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="quoted"><span class="quoted">"brnL <span class="free">cl</span> <span class="free">n</span> <span class="main">+</span> <span class="free">i</span> <span class="main">∈</span> shift <span class="free">cl</span> <span class="free">n</span> <span class="free">I</span> <span class="main">⟷</span> <span class="free">i</span> <span class="main">∈</span> <span class="free">I</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> shift_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Compositionality-in_back"><span class="command">lemma</span></span> in_back<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="free">ii</span> <span class="main">∈</span> <span class="free">II</span> <span class="main">⟹</span> <span class="free">ii</span> <span class="main">-</span> brnL <span class="free">cl</span> <span class="free">n</span> <span class="main">∈</span> back <span class="free">cl</span> <span class="free">n</span> <span class="free">II</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> back_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Compositionality-in_back2"><span class="command">lemma</span></span> in_back2<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">ii</span> <span class="main">&gt;</span> brnL <span class="free">cl</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">II</span> <span class="main">⊆</span> <span class="main">{</span>brnL <span class="free">cl</span> <span class="free">n</span> <span class="main">..&lt;+</span> brn <span class="main">(</span><span class="free">cl</span><span class="main">!</span><span class="free">n</span><span class="main">)</span><span class="main">}</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">ii</span> <span class="main">-</span> brnL <span class="free">cl</span> <span class="free">n</span> <span class="main">∈</span> back <span class="free">cl</span> <span class="free">n</span> <span class="free">II</span> <span class="main">⟷</span> <span class="free">ii</span> <span class="main">∈</span> <span class="free">II</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">⟷</span> <span class="var">?R</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> back_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1" id="Compositionality-shift"><span class="command">lemma</span></span> shift<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">⊆</span> <span class="main">{..&lt;</span> brn <span class="main">(</span><span class="free">cl</span><span class="main">!</span><span class="free">n</span><span class="main">)</span><span class="main">}</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"shift <span class="free">cl</span> <span class="free">n</span> <span class="free">I</span> <span class="main">⊆</span> <span class="main">{</span>brnL <span class="free">cl</span> <span class="free">n</span> <span class="main">..&lt;+</span> brn <span class="main">(</span><span class="free">cl</span><span class="main">!</span><span class="free">n</span><span class="main">)</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> shift_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Compositionality-shift2"><span class="command">lemma</span></span> shift2<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">⊆</span> <span class="main">{..&lt;</span> brn <span class="main">(</span><span class="free">cl</span><span class="main">!</span><span class="free">n</span><span class="main">)</span><span class="main">}</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">ii</span> <span class="main">∈</span> shift <span class="free">cl</span> <span class="free">n</span> <span class="free">I</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"brnL <span class="free">cl</span> <span class="free">n</span> <span class="main">≤</span> <span class="free">ii</span> <span class="main">∧</span> <span class="free">ii</span> <span class="main">&lt;</span> brnL <span class="free">cl</span> <span class="free">n</span> <span class="main">+</span> brn <span class="main">(</span><span class="free">cl</span><span class="main">!</span><span class="free">n</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> shift_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Compositionality-shift3"><span class="command">lemma</span></span> shift3<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&lt;</span> length <span class="free">cl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">⊆</span> <span class="main">{..&lt;</span> brn <span class="main">(</span><span class="free">cl</span><span class="main">!</span><span class="free">n</span><span class="main">)</span><span class="main">}</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> ii<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ii</span> <span class="main">∈</span> shift <span class="free">cl</span> <span class="free">n</span> <span class="free">I</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">ii</span> <span class="main">&lt;</span> brnL <span class="free">cl</span> <span class="main">(</span>length <span class="free">cl</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">ii</span> <span class="main">&lt;</span> brnL <span class="free">cl</span> <span class="free">n</span> <span class="main">+</span> brn <span class="main">(</span><span class="free">cl</span><span class="main">!</span><span class="free">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> I ii <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> brnL <span class="free">cl</span> <span class="main">(</span>length <span class="free">cl</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> n
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> brnL_Suc brnL_mono Suc_leI<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted">"back"</span><span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">II</span> <span class="main">⊆</span> <span class="main">{</span>brnL <span class="free">cl</span> <span class="free">n</span> <span class="main">..&lt;+</span> brn <span class="main">(</span><span class="free">cl</span><span class="main">!</span><span class="free">n</span><span class="main">)</span><span class="main">}</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"back <span class="free">cl</span> <span class="free">n</span> <span class="free">II</span> <span class="main">⊆</span> <span class="main">{..&lt;</span> brn <span class="main">(</span><span class="free">cl</span><span class="main">!</span><span class="free">n</span><span class="main">)</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> back_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1" id="Compositionality-back2"><span class="command">lemma</span></span> back2<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">II</span> <span class="main">⊆</span> <span class="main">{</span>brnL <span class="free">cl</span> <span class="free">n</span> <span class="main">..&lt;+</span> brn <span class="main">(</span><span class="free">cl</span><span class="main">!</span><span class="free">n</span><span class="main">)</span><span class="main">}</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> back <span class="free">cl</span> <span class="free">n</span> <span class="free">II</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> brn <span class="main">(</span><span class="free">cl</span><span class="main">!</span><span class="free">n</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> back_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1" id="Compositionality-shift_inj"><span class="command">lemma</span></span> shift_inj<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="quoted"><span class="quoted">"shift <span class="free">cl</span> <span class="free">n</span> <span class="free">I1</span> <span class="main">=</span> shift <span class="free">cl</span> <span class="free">n</span> <span class="free">I2</span> <span class="main">⟷</span> <span class="free">I1</span> <span class="main">=</span> <span class="free">I2</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> shift_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1" id="Compositionality-shift_mono"><span class="command">lemma</span></span> shift_mono<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="quoted"><span class="quoted">"shift <span class="free">cl</span> <span class="free">n</span> <span class="free">I1</span> <span class="main">⊆</span> shift <span class="free">cl</span> <span class="free">n</span> <span class="free">I2</span> <span class="main">⟷</span> <span class="free">I1</span> <span class="main">⊆</span> <span class="free">I2</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> shift_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Compositionality-shift_Int"><span class="command">lemma</span></span> shift_Int<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="quoted"><span class="quoted">"shift <span class="free">cl</span> <span class="free">n</span> <span class="free">I1</span> <span class="main">∩</span> shift <span class="free">cl</span> <span class="free">n</span> <span class="free">I2</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟷</span> <span class="free">I1</span> <span class="main">∩</span> <span class="free">I2</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> shift_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1" id="Compositionality-inj_shift"><span class="command">lemma</span></span> inj_shift<span class="main">:</span> <span class="quoted"><span class="quoted">"inj <span class="main">(</span>shift <span class="free">cl</span> <span class="free">n</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> inj_on_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Compositionality-inj_on_shift"><span class="command">lemma</span></span> inj_on_shift<span class="main">:</span> <span class="quoted"><span class="quoted">"inj_on <span class="main">(</span>shift <span class="free">cl</span> <span class="free">n</span><span class="main">)</span> <span class="free">K</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> inj_shift <span class="keyword1"><span class="command">unfolding</span></span> inj_on_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Compositionality-back_shift"><span class="command">lemma</span></span> back_shift<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="quoted"><span class="quoted">"back <span class="free">cl</span> <span class="free">n</span> <span class="main">(</span>shift <span class="free">cl</span> <span class="free">n</span> <span class="free">I</span><span class="main">)</span> <span class="main">=</span> <span class="free">I</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> back_def shift_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1" id="Compositionality-shift_back"><span class="command">lemma</span></span> shift_back<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">II</span> <span class="main">⊆</span> <span class="main">{</span>brnL <span class="free">cl</span> <span class="free">n</span> <span class="main">..&lt;+</span> brn <span class="main">(</span><span class="free">cl</span><span class="main">!</span><span class="free">n</span><span class="main">)</span><span class="main">}</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"shift <span class="free">cl</span> <span class="free">n</span> <span class="main">(</span>back <span class="free">cl</span> <span class="free">n</span> <span class="free">II</span><span class="main">)</span> <span class="main">=</span> <span class="free">II</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> shift_def back_def atLeastLessThan_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1" id="Compositionality-back_inj"><span class="command">lemma</span></span> back_inj<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> II1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">II1</span> <span class="main">⊆</span> <span class="main">{</span>brnL <span class="free">cl</span> <span class="free">n</span> <span class="main">..&lt;+</span> brn <span class="main">(</span><span class="free">cl</span><span class="main">!</span><span class="free">n</span><span class="main">)</span><span class="main">}</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> II2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">II2</span> <span class="main">⊆</span> <span class="main">{</span>brnL <span class="free">cl</span> <span class="free">n</span> <span class="main">..&lt;+</span> brn <span class="main">(</span><span class="free">cl</span><span class="main">!</span><span class="free">n</span><span class="main">)</span><span class="main">}</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"back <span class="free">cl</span> <span class="free">n</span> <span class="free">II1</span> <span class="main">=</span> back <span class="free">cl</span> <span class="free">n</span> <span class="free">II2</span> <span class="main">⟷</span> <span class="free">II1</span> <span class="main">=</span> <span class="free">II2</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">=</span> <span class="var">?R</span> <span class="main">⟷</span> <span class="free">II1</span> <span class="main">=</span> <span class="free">II2</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">II1</span> <span class="main">=</span> shift <span class="free">cl</span> <span class="free">n</span> <span class="var">?L</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> II1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">=</span> <span class="var">?R</span>"</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"shift <span class="free">cl</span> <span class="free">n</span> <span class="var">?R</span> <span class="main">=</span> <span class="free">II2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> II2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">II1</span> <span class="main">=</span> <span class="free">II2</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Compositionality-back_mono"><span class="command">lemma</span></span> back_mono<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">II1</span> <span class="main">⊆</span> <span class="main">{</span>brnL <span class="free">cl</span> <span class="free">n</span> <span class="main">..&lt;+</span> brn <span class="main">(</span><span class="free">cl</span><span class="main">!</span><span class="free">n</span><span class="main">)</span><span class="main">}</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">II2</span> <span class="main">⊆</span> <span class="main">{</span>brnL <span class="free">cl</span> <span class="free">n</span> <span class="main">..&lt;</span> brnL <span class="free">cl</span> <span class="free">n</span> <span class="main">+</span> brn <span class="main">(</span><span class="free">cl</span><span class="main">!</span><span class="free">n</span><span class="main">)</span><span class="main">}</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"back <span class="free">cl</span> <span class="free">n</span> <span class="free">II1</span> <span class="main">⊆</span> back <span class="free">cl</span> <span class="free">n</span> <span class="free">II2</span> <span class="main">⟷</span> <span class="free">II1</span> <span class="main">⊆</span> <span class="free">II2</span>"</span></span>
<span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">⊆</span> <span class="var">?R</span> <span class="main">⟷</span> <span class="free">II1</span> <span class="main">⊆</span> <span class="free">II2</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">⊆</span> <span class="var">?R</span> <span class="main">⟷</span> shift <span class="free">cl</span> <span class="free">n</span> <span class="var">?L</span> <span class="main">⊆</span> shift <span class="free">cl</span> <span class="free">n</span> <span class="var">?R</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⟷</span> <span class="free">II1</span> <span class="main">⊆</span> <span class="free">II2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Compositionality-back_Int"><span class="command">lemma</span></span> back_Int<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">II1</span> <span class="main">⊆</span> <span class="main">{</span>brnL <span class="free">cl</span> <span class="free">n</span> <span class="main">..&lt;+</span> brn <span class="main">(</span><span class="free">cl</span><span class="main">!</span><span class="free">n</span><span class="main">)</span><span class="main">}</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">II2</span> <span class="main">⊆</span> <span class="main">{</span>brnL <span class="free">cl</span> <span class="free">n</span> <span class="main">..&lt;</span> brnL <span class="free">cl</span> <span class="free">n</span> <span class="main">+</span> brn <span class="main">(</span><span class="free">cl</span><span class="main">!</span><span class="free">n</span><span class="main">)</span><span class="main">}</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"back <span class="free">cl</span> <span class="free">n</span> <span class="free">II1</span> <span class="main">∩</span> back <span class="free">cl</span> <span class="free">n</span> <span class="free">II2</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟷</span> <span class="free">II1</span> <span class="main">∩</span> <span class="free">II2</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">∩</span> <span class="var">?R</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟷</span> <span class="free">II1</span> <span class="main">∩</span> <span class="free">II2</span> <span class="main">=</span> <span class="main">{}</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">∩</span> <span class="var">?R</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟷</span> shift <span class="free">cl</span> <span class="free">n</span> <span class="var">?L</span> <span class="main">∩</span> shift <span class="free">cl</span> <span class="free">n</span> <span class="var">?R</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⟷</span> <span class="free">II1</span> <span class="main">∩</span> <span class="free">II2</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Compositionality-inj_on_back"><span class="command">lemma</span></span> inj_on_back<span class="main">:</span>
<span class="quoted"><span class="quoted">"inj_on <span class="main">(</span>back <span class="free">cl</span> <span class="free">n</span><span class="main">)</span> <span class="main">(</span>Pow <span class="main">{</span>brnL <span class="free">cl</span> <span class="free">n</span> <span class="main">..&lt;+</span> brn <span class="main">(</span><span class="free">cl</span><span class="main">!</span><span class="free">n</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> inj_on_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Compositionality-shift_surj"><span class="command">lemma</span></span> shift_surj<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">II</span> <span class="main">⊆</span> <span class="main">{</span>brnL <span class="free">cl</span> <span class="free">n</span> <span class="main">..&lt;+</span> brn <span class="main">(</span><span class="free">cl</span><span class="main">!</span><span class="free">n</span><span class="main">)</span><span class="main">}</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">I</span><span class="main">.</span> <span class="bound">I</span> <span class="main">⊆</span> <span class="main">{..&lt;</span> brn <span class="main">(</span><span class="free">cl</span><span class="main">!</span><span class="free">n</span><span class="main">)</span><span class="main">}</span> <span class="main">∧</span> shift <span class="free">cl</span> <span class="free">n</span> <span class="bound">I</span> <span class="main">=</span> <span class="free">II</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">intro</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"back <span class="free"><span class="free">cl</span></span> <span class="free"><span class="free">n</span></span> <span class="free"><span class="free">II</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Compositionality-back_surj"><span class="command">lemma</span></span> back_surj<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">⊆</span> <span class="main">{..&lt;</span> brn <span class="main">(</span><span class="free">cl</span><span class="main">!</span><span class="free">n</span><span class="main">)</span><span class="main">}</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">II</span><span class="main">.</span> <span class="bound">II</span> <span class="main">⊆</span> <span class="main">{</span>brnL <span class="free">cl</span> <span class="free">n</span> <span class="main">..&lt;+</span> brn <span class="main">(</span><span class="free">cl</span><span class="main">!</span><span class="free">n</span><span class="main">)</span><span class="main">}</span> <span class="main">∧</span> back <span class="free">cl</span> <span class="free">n</span> <span class="bound">II</span> <span class="main">=</span> <span class="free">I</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">intro</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"shift <span class="free"><span class="free">cl</span></span> <span class="free"><span class="free">n</span></span> <span class="free"><span class="free">I</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Compositionality-shift_part"><span class="command">lemma</span></span> shift_part<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"part <span class="main">{..&lt;</span> brn <span class="main">(</span><span class="free">cl</span><span class="main">!</span><span class="free">n</span><span class="main">)</span><span class="main">}</span> <span class="free">P</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"part <span class="main">{</span>brnL <span class="free">cl</span> <span class="free">n</span> <span class="main">..&lt;+</span> brn <span class="main">(</span><span class="free">cl</span><span class="main">!</span><span class="free">n</span><span class="main">)</span><span class="main">}</span> <span class="main">(</span>shift <span class="free">cl</span> <span class="free">n</span> <span class="main">`</span> <span class="free">P</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> part_def <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">intro</span> conjI allI impI<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span> <span class="main">(</span>shift <span class="free">cl</span> <span class="free">n</span> <span class="main">`</span> <span class="free">P</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span>brnL <span class="free">cl</span> <span class="free">n</span> <span class="main">..&lt;+</span> brn <span class="main">(</span><span class="free">cl</span><span class="main">!</span><span class="free">n</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ii</span> <span class="skolem">I</span> <span class="keyword3"><span class="command">assume</span></span> ii<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ii</span> <span class="main">∈</span> shift <span class="free">cl</span> <span class="free">n</span> <span class="skolem">I</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">I</span> <span class="main">∈</span> <span class="free">P</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">I</span> <span class="main">⊆</span> <span class="main">{..&lt;</span> brn <span class="main">(</span><span class="free">cl</span><span class="main">!</span><span class="free">n</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> part_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ii</span> <span class="main">∈</span> <span class="main">{</span>brnL <span class="free">cl</span> <span class="free">n</span> <span class="main">..&lt;+</span> brn <span class="main">(</span><span class="free">cl</span><span class="main">!</span><span class="free">n</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ii <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ii</span> <span class="keyword3"><span class="command">assume</span></span> ii_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ii</span> <span class="main">∈</span> <span class="main">{</span>brnL <span class="free">cl</span> <span class="free">n</span><span class="main">..&lt;+</span>brn <span class="main">(</span><span class="free">cl</span> <span class="main">!</span> <span class="free">n</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> <span class="skolem">ii</span> <span class="main">-</span> brnL <span class="free">cl</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> ii<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ii</span> <span class="main">=</span> brnL <span class="free">cl</span> <span class="free">n</span> <span class="main">+</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> i_def <span class="keyword1"><span class="command">using</span></span> ii_in <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="main">{..&lt;</span> brn <span class="main">(</span><span class="free">cl</span><span class="main">!</span><span class="free">n</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> i_def <span class="keyword1"><span class="command">using</span></span> ii_in <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">I</span></span> <span class="keyword2"><span class="keyword">where</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="skolem">I</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">I</span> <span class="main">∈</span> <span class="free">P</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> part_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ii</span> <span class="main">∈</span> <span class="main">⋃</span> <span class="main">(</span>shift <span class="free">cl</span> <span class="free">n</span> <span class="main">`</span> <span class="free">P</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> ii <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span><span class="main">(</span><span class="operator">insert</span> assms<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> part_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main">)</span>

<span class="keyword1" id="Compositionality-part_brn_disj1"><span class="command">lemma</span></span> part_brn_disj1<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> P<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> length <span class="free">cl</span> <span class="main">⟹</span> part <span class="main">{..&lt;</span> brn <span class="main">(</span><span class="free">cl</span><span class="main">!</span><span class="bound">n</span><span class="main">)</span><span class="main">}</span> <span class="main">(</span><span class="free">P</span> <span class="bound">n</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> n1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n1</span> <span class="main">&lt;</span> length <span class="free">cl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> n2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n2</span> <span class="main">&lt;</span> length <span class="free">cl</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> II1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">II1</span> <span class="main">∈</span> shift <span class="free">cl</span> <span class="free">n1</span> <span class="main">`</span> <span class="main">(</span><span class="free">P</span> <span class="free">n1</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> II2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">II2</span> <span class="main">∈</span> shift <span class="free">cl</span> <span class="free">n2</span> <span class="main">`</span> <span class="main">(</span><span class="free">P</span> <span class="free">n2</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> d<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n1</span> <span class="main">≠</span> <span class="free">n2</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">II1</span> <span class="main">∩</span> <span class="free">II2</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?N</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"length <span class="free">cl</span>"</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">I1</span></span> <span class="skolem"><span class="skolem">I2</span></span> <span class="keyword2"><span class="keyword">where</span></span> I1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">I1</span> <span class="main">∈</span> <span class="free">P</span> <span class="free">n1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> I2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">I2</span> <span class="main">∈</span> <span class="free">P</span> <span class="free">n2</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> II1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">II1</span> <span class="main">=</span> shift <span class="free">cl</span> <span class="free">n1</span> <span class="skolem">I1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> II2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">II2</span> <span class="main">=</span> shift <span class="free">cl</span> <span class="free">n2</span> <span class="skolem">I2</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> II1 II2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">I1</span> <span class="main">⊆</span> <span class="main">{..&lt;</span> brn <span class="main">(</span><span class="free">cl</span><span class="main">!</span><span class="free">n1</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">I2</span> <span class="main">⊆</span> <span class="main">{..&lt;</span> brn <span class="main">(</span><span class="free">cl</span><span class="main">!</span><span class="free">n2</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> n1 I1 n2 I2 P <span class="keyword1"><span class="command">unfolding</span></span> part_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">II1</span> <span class="main">⊆</span> <span class="main">{</span>brnL <span class="free">cl</span> <span class="free">n1</span> <span class="main">..&lt;+</span> brn <span class="main">(</span><span class="free">cl</span><span class="main">!</span><span class="free">n1</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">II2</span> <span class="main">⊆</span> <span class="main">{</span>brnL <span class="free">cl</span> <span class="free">n2</span> <span class="main">..&lt;+</span> brn <span class="main">(</span><span class="free">cl</span><span class="main">!</span><span class="free">n2</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> II1 II2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> n1 n2 d brnL_Int <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Compositionality-part_brn_disj2"><span class="command">lemma</span></span> part_brn_disj2<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> P<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> length <span class="free">cl</span> <span class="main">⟹</span> part <span class="main">{..&lt;</span> brn <span class="main">(</span><span class="free">cl</span><span class="main">!</span><span class="bound">n</span><span class="main">)</span><span class="main">}</span> <span class="main">(</span><span class="free">P</span> <span class="bound">n</span><span class="main">)</span> <span class="main">∧</span> <span class="main">{}</span> <span class="main">∉</span> <span class="free">P</span> <span class="bound">n</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> n1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n1</span> <span class="main">&lt;</span> length <span class="free">cl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> n2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n2</span> <span class="main">&lt;</span> length <span class="free">cl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> d<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n1</span> <span class="main">≠</span> <span class="free">n2</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"shift <span class="free">cl</span> <span class="free">n1</span> <span class="main">`</span> <span class="main">(</span><span class="free">P</span> <span class="free">n1</span><span class="main">)</span> <span class="main">∩</span> shift <span class="free">cl</span> <span class="free">n2</span> <span class="main">`</span> <span class="main">(</span><span class="free">P</span> <span class="free">n2</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">∩</span> <span class="var">?R</span> <span class="main">=</span> <span class="main">{}</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">fix</span></span> <span class="skolem">II</span> <span class="keyword3"><span class="command">assume</span></span> II<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">II</span> <span class="main">∈</span> <span class="var">?L</span> <span class="main">∩</span> <span class="var">?R</span>"</span></span>
   <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">II</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> part_brn_disj1<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">cl</span></span> <span class="quoted"><span class="free">P</span></span> <span class="quoted"><span class="free">n1</span></span> <span class="quoted"><span class="free">n2</span></span> <span class="quoted"><span class="skolem">II</span></span> <span class="quoted"><span class="skolem">II</span></span><span class="main">]</span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
   <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">{}</span> <span class="main">∈</span> <span class="var">?L</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> II <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
   <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">I</span></span> <span class="keyword2"><span class="keyword">where</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">I</span> <span class="main">∈</span> <span class="free">P</span> <span class="free">n1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> II<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{}</span> <span class="main">=</span> shift <span class="free">cl</span> <span class="free">n1</span> <span class="skolem">I</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
   <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">I</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
   <span class="keyword1"><span class="command">hence</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> n1 P I <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Compositionality-part_brn_disj3"><span class="command">lemma</span></span> part_brn_disj3<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> P<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> length <span class="free">cl</span> <span class="main">⟹</span> part <span class="main">{..&lt;</span> brn <span class="main">(</span><span class="free">cl</span><span class="main">!</span><span class="bound">n</span><span class="main">)</span><span class="main">}</span> <span class="main">(</span><span class="free">P</span> <span class="bound">n</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> n1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n1</span> <span class="main">&lt;</span> length <span class="free">cl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> n2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n2</span> <span class="main">&lt;</span> length <span class="free">cl</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> I1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I1</span> <span class="main">∈</span> <span class="free">P</span> <span class="free">n1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> I2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I2</span> <span class="main">∈</span> <span class="free">P</span> <span class="free">n2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> d<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n1</span> <span class="main">≠</span> <span class="free">n2</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"shift <span class="free">cl</span> <span class="free">n1</span> <span class="free">I1</span> <span class="main">∩</span> shift <span class="free">cl</span> <span class="free">n2</span> <span class="free">I2</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> part_brn_disj1<span class="main">)</span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Compositionality-sum_wt_Par_sub_shift"><span class="command">lemma</span></span> sum_wt_Par_sub_shift<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> cl<span class="main">:</span> <span class="quoted"><span class="quoted">"properL <span class="free">cl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&lt;</span> length <span class="free">cl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">⊆</span> <span class="main">{..&lt;</span> brn <span class="main">(</span><span class="free">cl</span> <span class="main">!</span> <span class="free">n</span><span class="main">)</span><span class="main">}</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span>
<span class="quoted"><span class="quoted">"sum <span class="main">(</span>wt <span class="main">(</span>Par <span class="free">cl</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span> <span class="main">(</span>shift <span class="free">cl</span> <span class="free">n</span> <span class="free">I</span><span class="main">)</span> <span class="main">=</span>
 <span class="main">1</span> <span class="main">/</span> <span class="main">(</span>length <span class="free">cl</span><span class="main">)</span> <span class="main">*</span> sum <span class="main">(</span>wt <span class="main">(</span><span class="free">cl</span> <span class="main">!</span> <span class="free">n</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span> <span class="free">I</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms sum_wt_Par_sub <span class="keyword1"><span class="command">unfolding</span></span> shift_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Compositionality-sum_wt_ParT_sub_WtFT_pickFT_0_shift"><span class="command">lemma</span></span> sum_wt_ParT_sub_WtFT_pickFT_0_shift<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> cl<span class="main">:</span> <span class="quoted"><span class="quoted">"properL <span class="free">cl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> nf<span class="main">:</span> <span class="quoted"><span class="quoted">"WtFT <span class="free">cl</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">⊆</span> <span class="main">{..&lt;</span> brn <span class="main">(</span><span class="free">cl</span> <span class="main">!</span> <span class="main">(</span>pickFT <span class="free">cl</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">∈</span> <span class="free">I</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span>
<span class="quoted"><span class="quoted">"sum <span class="main">(</span>wt <span class="main">(</span>ParT <span class="free">cl</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span> <span class="main">(</span>shift <span class="free">cl</span> <span class="main">(</span>pickFT <span class="free">cl</span><span class="main">)</span> <span class="free">I</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms sum_wt_ParT_sub_WtFT_pickFT_0
<span class="keyword1"><span class="command">unfolding</span></span> shift_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Compositionality-sum_wt_ParT_sub_WtFT_notPickFT_0_shift"><span class="command">lemma</span></span> sum_wt_ParT_sub_WtFT_notPickFT_0_shift<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> cl<span class="main">:</span> <span class="quoted"><span class="quoted">"properL <span class="free">cl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> nf<span class="main">:</span> <span class="quoted"><span class="quoted">"WtFT <span class="free">cl</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&lt;</span> length <span class="free">cl</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">⊆</span> <span class="main">{..&lt;</span> brn <span class="main">(</span><span class="free">cl</span> <span class="main">!</span> <span class="free">n</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> nI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> pickFT <span class="free">cl</span> <span class="main">⟶</span> <span class="main">0</span> <span class="main">∉</span> <span class="free">I</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sum <span class="main">(</span>wt <span class="main">(</span>ParT <span class="free">cl</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span> <span class="main">(</span>shift <span class="free">cl</span> <span class="free">n</span> <span class="free">I</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms sum_wt_ParT_sub_WtFT_notPickFT_0 <span class="keyword1"><span class="command">unfolding</span></span> shift_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Compositionality-sum_wt_ParT_sub_notWtFT_finished_shift"><span class="command">lemma</span></span> sum_wt_ParT_sub_notWtFT_finished_shift<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> cl<span class="main">:</span> <span class="quoted"><span class="quoted">"properL <span class="free">cl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> nf<span class="main">:</span> <span class="quoted"><span class="quoted">"WtFT <span class="free">cl</span> <span class="main">≠</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&lt;</span> length <span class="free">cl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> cln<span class="main">:</span> <span class="quoted"><span class="quoted">"finished <span class="main">(</span><span class="free">cl</span><span class="main">!</span><span class="free">n</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">⊆</span> <span class="main">{..&lt;</span> brn <span class="main">(</span><span class="free">cl</span> <span class="main">!</span> <span class="free">n</span><span class="main">)</span><span class="main">}</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sum <span class="main">(</span>wt <span class="main">(</span>ParT <span class="free">cl</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span> <span class="main">(</span>shift <span class="free">cl</span> <span class="free">n</span> <span class="free">I</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms sum_wt_ParT_sub_notWtFT_finished
<span class="keyword1"><span class="command">unfolding</span></span> shift_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Compositionality-sum_wt_ParT_sub_notWtFT_notFinished_shift"><span class="command">lemma</span></span> sum_wt_ParT_sub_notWtFT_notFinished_shift<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> cl<span class="main">:</span> <span class="quoted"><span class="quoted">"properL <span class="free">cl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> nf<span class="main">:</span> <span class="quoted"><span class="quoted">"WtFT <span class="free">cl</span> <span class="main">≠</span> <span class="main">1</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&lt;</span> length <span class="free">cl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> cln<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> finished <span class="main">(</span><span class="free">cl</span><span class="main">!</span><span class="free">n</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">⊆</span> <span class="main">{..&lt;</span> brn <span class="main">(</span><span class="free">cl</span> <span class="main">!</span> <span class="free">n</span><span class="main">)</span><span class="main">}</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span>
<span class="quoted"><span class="quoted">"sum <span class="main">(</span>wt <span class="main">(</span>ParT <span class="free">cl</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span> <span class="main">(</span>shift <span class="free">cl</span> <span class="free">n</span> <span class="free">I</span><span class="main">)</span> <span class="main">=</span>
 <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="main">(</span>length <span class="free">cl</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> WtFT <span class="free">cl</span><span class="main">)</span> <span class="main">*</span> sum <span class="main">(</span>wt <span class="main">(</span><span class="free">cl</span> <span class="main">!</span> <span class="free">n</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span> <span class="free">I</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms sum_wt_ParT_sub_notWtFT_notFinished
<span class="keyword1"><span class="command">unfolding</span></span> shift_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="comment1">(*  *)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">UNpart</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">UNpart</span> <span class="free"><span class="bound"><span class="entity">cl</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">≡</span> <span class="main">⋃</span> <span class="bound">n</span> <span class="main">&lt;</span> length <span class="free"><span class="bound"><span class="entity">cl</span></span></span><span class="main">.</span> shift <span class="free"><span class="bound"><span class="entity">cl</span></span></span> <span class="bound">n</span> <span class="main">`</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">n</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Compositionality-UNpart_cases"><span class="command">lemma</span></span> UNpart_cases<span class="main">[</span><span class="operator">elim</span><span class="main">,</span> <span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">case_names</span> Local<span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">II</span> <span class="main">∈</span> UNpart <span class="free">cl</span> <span class="free">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
<span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">n</span> <span class="bound">I</span><span class="main">.</span> <span class="main">⟦</span><span class="bound">n</span> <span class="main">&lt;</span> length <span class="free">cl</span><span class="main">;</span> <span class="bound">I</span> <span class="main">∈</span> <span class="free">P</span> <span class="bound">n</span><span class="main">;</span> <span class="free">II</span> <span class="main">=</span> shift <span class="free">cl</span> <span class="bound">n</span> <span class="bound">I</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">phi</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="free">phi</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> UNpart_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Compositionality-emp_UNpart"><span class="command">lemma</span></span> emp_UNpart<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> length <span class="free">cl</span> <span class="main">⟹</span> <span class="main">{}</span> <span class="main">∉</span> <span class="free">P</span> <span class="bound">n</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">{}</span> <span class="main">∉</span> UNpart <span class="free">cl</span> <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> UNpart_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Compositionality-part_UNpart"><span class="command">lemma</span></span> part_UNpart<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> cl<span class="main">:</span> <span class="quoted"><span class="quoted">"properL <span class="free">cl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
P<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> length <span class="free">cl</span> <span class="main">⟹</span> part <span class="main">{..&lt;</span> brn <span class="main">(</span><span class="free">cl</span><span class="main">!</span><span class="bound">n</span><span class="main">)</span><span class="main">}</span> <span class="main">(</span><span class="free">P</span> <span class="bound">n</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"part <span class="main">{..&lt;</span> brnL <span class="free">cl</span> <span class="main">(</span>length <span class="free">cl</span><span class="main">)</span><span class="main">}</span> <span class="main">(</span>UNpart <span class="free">cl</span> <span class="free">P</span><span class="main">)</span>"</span></span>
<span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"part <span class="var">?J</span> <span class="var">?Q</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?N</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"length <span class="free">cl</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> J<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?J</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span> <span class="bound">n</span> <span class="main">∈</span> <span class="main">{..&lt;</span> <span class="var">?N</span><span class="main">}</span><span class="main">.</span> <span class="main">{</span>brnL <span class="free">cl</span> <span class="bound">n</span> <span class="main">..&lt;+</span> brn <span class="main">(</span><span class="free">cl</span><span class="main">!</span><span class="bound">n</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> cl brnL_UN <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> Q<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?Q</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span> <span class="bound">n</span> <span class="main">∈</span> <span class="main">{..&lt;</span> <span class="var">?N</span><span class="main">}</span><span class="main">.</span> shift <span class="free">cl</span> <span class="bound">n</span> <span class="main">`</span> <span class="main">(</span><span class="free">P</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> UNpart_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> J Q <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> part_UN<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> P brnL_Int <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(*  *)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">pickT_pred</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">pickT_pred</span> <span class="free"><span class="bound"><span class="entity">cl</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">II</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">&lt;</span> length <span class="free"><span class="bound"><span class="entity">cl</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">II</span></span></span> <span class="main">∈</span> shift <span class="free"><span class="bound"><span class="entity">cl</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">`</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">pickT</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">pickT</span> <span class="free"><span class="bound"><span class="entity">cl</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">II</span></span></span> <span class="main">≡</span> <span class="keyword1">SOME</span> <span class="bound">n</span><span class="main">.</span> pickT_pred <span class="free"><span class="bound"><span class="entity">cl</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">II</span></span></span> <span class="bound">n</span>"</span></span>

<span class="keyword1" id="Compositionality-pickT_pred"><span class="command">lemma</span></span> pickT_pred<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">II</span> <span class="main">∈</span> UNpart <span class="free">cl</span> <span class="free">P</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">n</span><span class="main">.</span> pickT_pred <span class="free">cl</span> <span class="free">P</span> <span class="free">II</span> <span class="bound">n</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> UNpart_def pickT_pred_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Compositionality-pickT_pred_unique"><span class="command">lemma</span></span> pickT_pred_unique<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> P<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> length <span class="free">cl</span> <span class="main">⟹</span> part <span class="main">{..&lt;</span> brn <span class="main">(</span><span class="free">cl</span><span class="main">!</span><span class="bound">n</span><span class="main">)</span><span class="main">}</span> <span class="main">(</span><span class="free">P</span> <span class="bound">n</span><span class="main">)</span>  <span class="main">∧</span> <span class="main">{}</span> <span class="main">∉</span> <span class="free">P</span> <span class="bound">n</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"pickT_pred <span class="free">cl</span> <span class="free">P</span> <span class="free">II</span> <span class="free">n1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"pickT_pred <span class="free">cl</span> <span class="free">P</span> <span class="free">II</span> <span class="free">n2</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">n1</span> <span class="main">=</span> <span class="free">n2</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">n1</span> <span class="main">≠</span> <span class="free">n2</span>"</span></span>
   <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"shift <span class="free">cl</span> <span class="free">n1</span> <span class="main">`</span> <span class="main">(</span><span class="free">P</span> <span class="free">n1</span><span class="main">)</span> <span class="main">∩</span> shift <span class="free">cl</span> <span class="free">n2</span> <span class="main">`</span> <span class="main">(</span><span class="free">P</span> <span class="free">n2</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
   <span class="keyword1"><span class="command">using</span></span> assms part_brn_disj2 <span class="keyword1"><span class="command">unfolding</span></span> pickT_pred_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
   <span class="keyword1"><span class="command">hence</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> 1 2 <span class="keyword1"><span class="command">unfolding</span></span> pickT_pred_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Compositionality-pickT_pred_pickT"><span class="command">lemma</span></span> pickT_pred_pickT<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">II</span> <span class="main">∈</span> UNpart <span class="free">cl</span> <span class="free">P</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"pickT_pred <span class="free">cl</span> <span class="free">P</span> <span class="free">II</span> <span class="main">(</span>pickT <span class="free">cl</span> <span class="free">P</span> <span class="free">II</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> pickT_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> someI_ex<span class="main">)</span>
<span class="keyword1"><span class="command">using</span></span> assms pickT_pred <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Compositionality-pickT_pred_pickT_unique"><span class="command">lemma</span></span> pickT_pred_pickT_unique<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> P<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> length <span class="free">cl</span> <span class="main">⟹</span> part <span class="main">{..&lt;</span> brn <span class="main">(</span><span class="free">cl</span><span class="main">!</span><span class="bound">n</span><span class="main">)</span><span class="main">}</span> <span class="main">(</span><span class="free">P</span> <span class="bound">n</span><span class="main">)</span> <span class="main">∧</span> <span class="main">{}</span> <span class="main">∉</span> <span class="free">P</span> <span class="bound">n</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"pickT_pred <span class="free">cl</span> <span class="free">P</span> <span class="free">II</span> <span class="free">n</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> pickT <span class="free">cl</span> <span class="free">P</span> <span class="free">II</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> pickT_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> sym<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> some_equality<span class="main">)</span>
<span class="keyword1"><span class="command">using</span></span> assms pickT_pred_unique<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">cl</span></span> <span class="quoted"><span class="free">P</span></span> <span class="quoted"><span class="free">II</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Compositionality-pickT_length"><span class="command">lemma</span></span> pickT_length<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">II</span> <span class="main">∈</span> UNpart <span class="free">cl</span> <span class="free">P</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"pickT <span class="free">cl</span> <span class="free">P</span> <span class="free">II</span> <span class="main">&lt;</span> length <span class="free">cl</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms pickT_pred_pickT <span class="keyword1"><span class="command">unfolding</span></span> pickT_pred_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Compositionality-pickT_shift"><span class="command">lemma</span></span> pickT_shift<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">II</span> <span class="main">∈</span> UNpart <span class="free">cl</span> <span class="free">P</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">II</span> <span class="main">∈</span> shift <span class="free">cl</span> <span class="main">(</span>pickT <span class="free">cl</span> <span class="free">P</span> <span class="free">II</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span><span class="free">P</span> <span class="main">(</span>pickT <span class="free">cl</span> <span class="free">P</span> <span class="free">II</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms pickT_pred_pickT <span class="keyword1"><span class="command">unfolding</span></span> pickT_pred_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Compositionality-pickT_unique"><span class="command">lemma</span></span> pickT_unique<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> P<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> length <span class="free">cl</span> <span class="main">⟹</span> part <span class="main">{..&lt;</span> brn <span class="main">(</span><span class="free">cl</span><span class="main">!</span><span class="bound">n</span><span class="main">)</span><span class="main">}</span> <span class="main">(</span><span class="free">P</span> <span class="bound">n</span><span class="main">)</span> <span class="main">∧</span> <span class="main">{}</span> <span class="main">∉</span> <span class="free">P</span> <span class="bound">n</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&lt;</span> length <span class="free">cl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">II</span> <span class="main">∈</span> shift <span class="free">cl</span> <span class="free">n</span> <span class="main">`</span> <span class="main">(</span><span class="free">P</span> <span class="free">n</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> pickT <span class="free">cl</span> <span class="free">P</span> <span class="free">II</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms pickT_pred_pickT_unique <span class="keyword1"><span class="command">unfolding</span></span> pickT_pred_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">UNlift</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">UNlift</span> <span class="free"><span class="bound"><span class="entity">cl</span></span></span> <span class="free"><span class="bound"><span class="entity">dl</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">II</span></span></span> <span class="main">≡</span>
 shift <span class="free"><span class="bound"><span class="entity">dl</span></span></span> <span class="main">(</span>pickT <span class="free"><span class="bound"><span class="entity">cl</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">II</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="main">(</span>pickT <span class="free"><span class="bound"><span class="entity">cl</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">II</span></span></span><span class="main">)</span> <span class="main">(</span>back <span class="free"><span class="bound"><span class="entity">cl</span></span></span> <span class="main">(</span>pickT <span class="free"><span class="bound"><span class="entity">cl</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">II</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">II</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Compositionality-UNlift_shift"><span class="command">lemma</span></span> UNlift_shift<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> P<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> length <span class="free">cl</span> <span class="main">⟹</span> part <span class="main">{..&lt;</span> brn <span class="main">(</span><span class="free">cl</span><span class="main">!</span><span class="bound">n</span><span class="main">)</span><span class="main">}</span> <span class="main">(</span><span class="free">P</span> <span class="bound">n</span><span class="main">)</span> <span class="main">∧</span> <span class="main">{}</span> <span class="main">∉</span> <span class="free">P</span> <span class="bound">n</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&lt;</span> length <span class="free">cl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">∈</span> <span class="free">P</span> <span class="free">n</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"UNlift <span class="free">cl</span> <span class="free">dl</span> <span class="free">P</span> <span class="free">F</span> <span class="main">(</span>shift <span class="free">cl</span> <span class="free">n</span> <span class="free">I</span><span class="main">)</span> <span class="main">=</span> shift <span class="free">dl</span> <span class="free">n</span> <span class="main">(</span><span class="free">F</span> <span class="free">n</span> <span class="free">I</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?N</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"length <span class="free">cl</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">II</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">II</span> <span class="main">=</span> shift <span class="free">cl</span> <span class="free">n</span> <span class="free">I</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> II<span class="main">:</span> <span class="quoted"><span class="quoted">"shift <span class="free">cl</span> <span class="free">n</span> <span class="free">I</span> <span class="main">=</span> <span class="skolem">II</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> II_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> pickT <span class="free">cl</span> <span class="free">P</span> <span class="skolem">II</span>"</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> pickT_unique<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> II_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"back <span class="free">cl</span> <span class="free">n</span> <span class="skolem">II</span> <span class="main">=</span> <span class="free">I</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> II_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"shift <span class="free">dl</span> <span class="free">n</span> <span class="main">(</span><span class="free">F</span> <span class="free">n</span> <span class="main">(</span>back <span class="free">cl</span> <span class="free">n</span> <span class="skolem">II</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> shift <span class="free">dl</span> <span class="free">n</span> <span class="main">(</span><span class="free">F</span> <span class="free">n</span> <span class="free">I</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> UNlift_def II n<span class="main">[</span><span class="operator">THEN</span> sym<span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Compositionality-UNlift_inj_on"><span class="command">lemma</span></span> UNlift_inj_on<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> l<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">cl</span> <span class="main">=</span> length <span class="free">dl</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> P<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> length <span class="free">cl</span> <span class="main">⟹</span> part <span class="main">{..&lt;</span> brn <span class="main">(</span><span class="free">cl</span><span class="main">!</span><span class="bound">n</span><span class="main">)</span><span class="main">}</span> <span class="main">(</span><span class="free">P</span> <span class="bound">n</span><span class="main">)</span> <span class="main">∧</span> <span class="main">{}</span> <span class="main">∉</span> <span class="free">P</span> <span class="bound">n</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> FP<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> length <span class="free">dl</span> <span class="main">⟹</span> part <span class="main">{..&lt;</span> brn <span class="main">(</span><span class="free">dl</span><span class="main">!</span><span class="bound">n</span><span class="main">)</span><span class="main">}</span> <span class="main">(</span><span class="free">F</span> <span class="bound">n</span> <span class="main">`</span> <span class="main">(</span><span class="free">P</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="main">{}</span> <span class="main">∉</span> <span class="free">F</span> <span class="bound">n</span> <span class="main">`</span> <span class="main">(</span><span class="free">P</span> <span class="bound">n</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> F<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> length <span class="free">cl</span> <span class="main">⟹</span> inj_on <span class="main">(</span><span class="free">F</span> <span class="bound">n</span><span class="main">)</span> <span class="main">(</span><span class="free">P</span> <span class="bound">n</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="main">(</span>UNlift <span class="free">cl</span> <span class="free">dl</span> <span class="free">P</span> <span class="free">F</span><span class="main">)</span> <span class="main">(</span>UNpart <span class="free">cl</span> <span class="free">P</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="var">?G</span> <span class="var">?Q</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">unfolding</span></span> inj_on_def <span class="keyword1"><span class="command">proof</span></span> <span class="operator">clarify</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">II1</span> <span class="skolem">II2</span>
  <span class="keyword3"><span class="command">assume</span></span> II1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">II1</span> <span class="main">∈</span> <span class="var">?Q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> II2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">II2</span> <span class="main">∈</span> <span class="var">?Q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> G<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?G</span> <span class="skolem">II1</span> <span class="main">=</span> <span class="var">?G</span> <span class="skolem">II2</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> II1 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">II1</span> <span class="main">=</span> <span class="skolem">II2</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> UNpart_cases<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Local <span class="skolem">n1</span> <span class="skolem">I1</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> n1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n1</span> <span class="main">&lt;</span> length <span class="free">cl</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n1</span> <span class="main">&lt;</span> length <span class="free">dl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> I1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">I1</span> <span class="main">∈</span> <span class="free">P</span> <span class="skolem">n1</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> II1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">II1</span> <span class="main">=</span> shift <span class="free">cl</span> <span class="skolem">n1</span> <span class="skolem">I1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> l <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> G1_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?G</span> <span class="skolem">II1</span> <span class="main">=</span> shift <span class="free">dl</span> <span class="skolem">n1</span> <span class="main">(</span><span class="free">F</span> <span class="skolem">n1</span> <span class="skolem">I1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> P <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> Pn1<span class="main">:</span> <span class="quoted"><span class="quoted">"part <span class="main">{..&lt;</span> brn <span class="main">(</span><span class="free">dl</span><span class="main">!</span><span class="skolem">n1</span><span class="main">)</span><span class="main">}</span> <span class="main">(</span><span class="free">F</span> <span class="skolem">n1</span> <span class="main">`</span> <span class="main">(</span><span class="free">P</span> <span class="skolem">n1</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">{}</span> <span class="main">∉</span> <span class="free">F</span> <span class="skolem">n1</span> <span class="main">`</span> <span class="main">(</span><span class="free">P</span> <span class="skolem">n1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> n1 FP <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> F1_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">F</span> <span class="skolem">n1</span> <span class="skolem">I1</span> <span class="main">∈</span> <span class="free">F</span> <span class="skolem">n1</span> <span class="main">`</span> <span class="main">(</span><span class="free">P</span> <span class="skolem">n1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> I1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> Fn1I1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">F</span> <span class="skolem">n1</span> <span class="skolem">I1</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">F</span> <span class="skolem">n1</span> <span class="skolem">I1</span> <span class="main">⊆</span> <span class="main">{..&lt;</span> brn <span class="main">(</span><span class="free">dl</span><span class="main">!</span><span class="skolem">n1</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Pn1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> part_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> G1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?G</span> <span class="skolem">II1</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?G</span> <span class="skolem">II1</span> <span class="main">⊆</span> <span class="main">{</span>brnL <span class="free">dl</span> <span class="skolem">n1</span> <span class="main">..&lt;+</span> brn <span class="main">(</span><span class="free">dl</span><span class="main">!</span><span class="skolem">n1</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> G1_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command">from</span></span> II2 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> UNpart_cases<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Local <span class="skolem">n2</span> <span class="skolem">I2</span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> n2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n2</span> <span class="main">&lt;</span> length <span class="free">cl</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n2</span> <span class="main">&lt;</span> length <span class="free">dl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> I2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">I2</span> <span class="main">∈</span> <span class="free">P</span> <span class="skolem">n2</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> II2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">II2</span> <span class="main">=</span> shift <span class="free">cl</span> <span class="skolem">n2</span> <span class="skolem">I2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> l <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> G2_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?G</span> <span class="skolem">II2</span> <span class="main">=</span> shift <span class="free">dl</span> <span class="skolem">n2</span> <span class="main">(</span><span class="free">F</span> <span class="skolem">n2</span> <span class="skolem">I2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> P <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">have</span></span> Pn2<span class="main">:</span> <span class="quoted"><span class="quoted">"part <span class="main">{..&lt;</span> brn <span class="main">(</span><span class="free">dl</span><span class="main">!</span><span class="skolem">n2</span><span class="main">)</span><span class="main">}</span> <span class="main">(</span><span class="free">F</span> <span class="skolem">n2</span> <span class="main">`</span> <span class="main">(</span><span class="free">P</span> <span class="skolem">n2</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">{}</span> <span class="main">∉</span> <span class="free">F</span> <span class="skolem">n2</span> <span class="main">`</span> <span class="main">(</span><span class="free">P</span> <span class="skolem">n2</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> n2 FP <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> F2_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">F</span> <span class="skolem">n2</span> <span class="skolem">I2</span> <span class="main">∈</span> <span class="free">F</span> <span class="skolem">n2</span> <span class="main">`</span> <span class="main">(</span><span class="free">P</span> <span class="skolem">n2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> I2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">hence</span></span> Fn2I2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">F</span> <span class="skolem">n2</span> <span class="skolem">I2</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">F</span> <span class="skolem">n2</span> <span class="skolem">I2</span> <span class="main">⊆</span> <span class="main">{..&lt;</span> brn <span class="main">(</span><span class="free">dl</span><span class="main">!</span><span class="skolem">n2</span><span class="main">)</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Pn2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> part_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> G2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?G</span> <span class="skolem">II2</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?G</span> <span class="skolem">II2</span> <span class="main">⊆</span> <span class="main">{</span>brnL <span class="free">dl</span> <span class="skolem">n2</span> <span class="main">..&lt;+</span> brn <span class="main">(</span><span class="free">dl</span><span class="main">!</span><span class="skolem">n2</span><span class="main">)</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> G2_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
      <span class="comment1">(*  *)</span>
      <span class="keyword1"><span class="command">have</span></span> n12<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n1</span> <span class="main">=</span> <span class="skolem">n2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> n1 n2 G1 G2 G brnL_Int <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">F</span> <span class="skolem">n1</span> <span class="skolem">I1</span> <span class="main">=</span> <span class="free">F</span> <span class="skolem">n2</span> <span class="skolem">I2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> G <span class="keyword1"><span class="command">unfolding</span></span> G1_def G2_def n12 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">I1</span> <span class="main">=</span> <span class="skolem">I2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> I1 I2 n1 F <span class="keyword1"><span class="command">unfolding</span></span> n12 inj_on_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> II1 II2 n12 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Compositionality-UNlift_UNpart"><span class="command">lemma</span></span> UNlift_UNpart<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> l<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">cl</span> <span class="main">=</span> length <span class="free">dl</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> P<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> length <span class="free">cl</span> <span class="main">⟹</span> part <span class="main">{..&lt;</span> brn <span class="main">(</span><span class="free">cl</span><span class="main">!</span><span class="bound">n</span><span class="main">)</span><span class="main">}</span> <span class="main">(</span><span class="free">P</span> <span class="bound">n</span><span class="main">)</span> <span class="main">∧</span> <span class="main">{}</span> <span class="main">∉</span> <span class="free">P</span> <span class="bound">n</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>UNlift <span class="free">cl</span> <span class="free">dl</span> <span class="free">P</span> <span class="free">F</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span>UNpart <span class="free">cl</span> <span class="free">P</span><span class="main">)</span> <span class="main">=</span> UNpart <span class="free">dl</span> <span class="main">(</span><span class="main">%</span><span class="bound">n</span><span class="main">.</span> <span class="free">F</span> <span class="bound">n</span> <span class="main">`</span> <span class="main">(</span><span class="free">P</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?G</span> <span class="main">`</span> <span class="var">?Q</span> <span class="main">=</span> <span class="var">?R</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">II</span> <span class="keyword3"><span class="command">assume</span></span> II<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">II</span> <span class="main">∈</span> <span class="var">?Q</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="var">?G</span> <span class="skolem">II</span> <span class="main">∈</span> <span class="var">?R</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> UNpart_cases<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Local <span class="skolem">n</span> <span class="skolem">I</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">&lt;</span> length <span class="free">cl</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">&lt;</span> length <span class="free">dl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">I</span> <span class="main">∈</span> <span class="free">P</span> <span class="skolem">n</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> II<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">II</span> <span class="main">=</span> shift <span class="free">cl</span> <span class="skolem">n</span> <span class="skolem">I</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> l <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> G<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?G</span> <span class="skolem">II</span> <span class="main">=</span> shift <span class="free">dl</span> <span class="skolem">n</span> <span class="main">(</span><span class="free">F</span> <span class="skolem">n</span> <span class="skolem">I</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> P <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> n I <span class="keyword1"><span class="command">unfolding</span></span> G UNpart_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">JJ</span> <span class="keyword3"><span class="command">assume</span></span> JJ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">JJ</span> <span class="main">∈</span> <span class="var">?R</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">JJ</span> <span class="main">∈</span> <span class="var">?G</span> <span class="main">`</span> <span class="var">?Q</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> UNpart_cases<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Local <span class="skolem">n</span> <span class="skolem">J</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">&lt;</span> length <span class="free">cl</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">&lt;</span> length <span class="free">dl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> J<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">J</span> <span class="main">∈</span> <span class="free">F</span> <span class="skolem">n</span> <span class="main">`</span> <span class="main">(</span><span class="free">P</span> <span class="skolem">n</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> JJ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">JJ</span> <span class="main">=</span> shift <span class="free">dl</span> <span class="skolem">n</span> <span class="skolem">J</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> l <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">I</span></span> <span class="keyword2"><span class="keyword">where</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">I</span> <span class="main">∈</span> <span class="free">P</span> <span class="skolem">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">J</span> <span class="main">=</span> <span class="free">F</span> <span class="skolem">n</span> <span class="skolem">I</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">JJ</span> <span class="main">=</span> shift <span class="free">dl</span> <span class="skolem">n</span> <span class="main">(</span><span class="free">F</span> <span class="skolem">n</span> <span class="skolem">I</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> JJ <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> UNlift <span class="free">cl</span> <span class="free">dl</span> <span class="free">P</span> <span class="free">F</span> <span class="main">(</span>shift <span class="free">cl</span> <span class="skolem">n</span> <span class="skolem">I</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> n I P <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> JJ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">JJ</span> <span class="main">=</span> UNlift <span class="free">cl</span> <span class="free">dl</span> <span class="free">P</span> <span class="free">F</span> <span class="main">(</span>shift <span class="free">cl</span> <span class="skolem">n</span> <span class="skolem">I</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> n I <span class="keyword1"><span class="command">unfolding</span></span> JJ UNpart_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Compositionality-emp_UNlift_UNpart"><span class="command">lemma</span></span> emp_UNlift_UNpart<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> l<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">cl</span> <span class="main">=</span> length <span class="free">dl</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> P<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> length <span class="free">cl</span> <span class="main">⟹</span> part <span class="main">{..&lt;</span> brn <span class="main">(</span><span class="free">cl</span><span class="main">!</span><span class="bound">n</span><span class="main">)</span><span class="main">}</span> <span class="main">(</span><span class="free">P</span> <span class="bound">n</span><span class="main">)</span> <span class="main">∧</span> <span class="main">{}</span> <span class="main">∉</span> <span class="free">P</span> <span class="bound">n</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> FP<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> length <span class="free">dl</span> <span class="main">⟹</span> <span class="main">{}</span> <span class="main">∉</span> <span class="free">F</span> <span class="bound">n</span> <span class="main">`</span> <span class="main">(</span><span class="free">P</span> <span class="bound">n</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">{}</span> <span class="main">∉</span> <span class="main">(</span>UNlift <span class="free">cl</span> <span class="free">dl</span> <span class="free">P</span> <span class="free">F</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span>UNpart <span class="free">cl</span> <span class="free">P</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">{}</span> <span class="main">∉</span> <span class="var">?R</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> R<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?R</span> <span class="main">=</span> UNpart <span class="free">dl</span> <span class="main">(</span><span class="main">%</span><span class="bound">n</span><span class="main">.</span> <span class="free">F</span> <span class="bound">n</span> <span class="main">`</span> <span class="main">(</span><span class="free">P</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> UNlift_UNpart<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> R <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> emp_UNpart<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> FP <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Compositionality-part_UNlift_UNpart"><span class="command">lemma</span></span> part_UNlift_UNpart<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> l<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">cl</span> <span class="main">=</span> length <span class="free">dl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> dl<span class="main">:</span> <span class="quoted"><span class="quoted">"properL <span class="free">dl</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> P<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> length <span class="free">cl</span> <span class="main">⟹</span> part <span class="main">{..&lt;</span> brn <span class="main">(</span><span class="free">cl</span><span class="main">!</span><span class="bound">n</span><span class="main">)</span><span class="main">}</span> <span class="main">(</span><span class="free">P</span> <span class="bound">n</span><span class="main">)</span> <span class="main">∧</span> <span class="main">{}</span> <span class="main">∉</span> <span class="free">P</span> <span class="bound">n</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> FP<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> length <span class="free">dl</span> <span class="main">⟹</span> part <span class="main">{..&lt;</span> brn <span class="main">(</span><span class="free">dl</span><span class="main">!</span><span class="bound">n</span><span class="main">)</span><span class="main">}</span> <span class="main">(</span><span class="free">F</span> <span class="bound">n</span> <span class="main">`</span> <span class="main">(</span><span class="free">P</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"part <span class="main">{..&lt;</span> brnL <span class="free">dl</span> <span class="main">(</span>length <span class="free">dl</span><span class="main">)</span><span class="main">}</span> <span class="main">(</span><span class="main">(</span>UNlift <span class="free">cl</span> <span class="free">dl</span> <span class="free">P</span> <span class="free">F</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span>UNpart <span class="free">cl</span> <span class="free">P</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"part <span class="var">?C</span> <span class="var">?R</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> R<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?R</span> <span class="main">=</span> UNpart <span class="free">dl</span> <span class="main">(</span><span class="main">%</span><span class="bound">n</span><span class="main">.</span> <span class="free">F</span> <span class="bound">n</span> <span class="main">`</span> <span class="main">(</span><span class="free">P</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> UNlift_UNpart<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> R <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> part_UNpart<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> dl FP <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Compositionality-ss_wt_Par_UNlift"><span class="command">lemma</span></span> ss_wt_Par_UNlift<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> l<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">cl</span> <span class="main">=</span> length <span class="free">dl</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> cldl<span class="main">:</span> <span class="quoted"><span class="quoted">"properL <span class="free">cl</span>"</span></span> <span class="quoted"><span class="quoted">"properL <span class="free">dl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> II<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">II</span> <span class="main">∈</span> UNpart <span class="free">cl</span> <span class="free">P</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> P<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> length <span class="free">cl</span> <span class="main">⟹</span> part <span class="main">{..&lt;</span> brn <span class="main">(</span><span class="free">cl</span><span class="main">!</span><span class="bound">n</span><span class="main">)</span><span class="main">}</span> <span class="main">(</span><span class="free">P</span> <span class="bound">n</span><span class="main">)</span> <span class="main">∧</span> <span class="main">{}</span> <span class="main">∉</span> <span class="free">P</span> <span class="bound">n</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> FP<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> length <span class="free">dl</span> <span class="main">⟹</span> part <span class="main">{..&lt;</span> brn <span class="main">(</span><span class="free">dl</span><span class="main">!</span><span class="bound">n</span><span class="main">)</span><span class="main">}</span> <span class="main">(</span><span class="free">F</span> <span class="bound">n</span> <span class="main">`</span> <span class="main">(</span><span class="free">P</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> sw<span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span> <span class="bound">I</span><span class="main">.</span> <span class="main">⟦</span><span class="bound">n</span> <span class="main">&lt;</span> length <span class="free">cl</span><span class="main">;</span> <span class="bound">I</span> <span class="main">∈</span> <span class="free">P</span> <span class="bound">n</span><span class="main">⟧</span> <span class="main">⟹</span>
     sum <span class="main">(</span>wt <span class="main">(</span><span class="free">cl</span> <span class="main">!</span> <span class="bound">n</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span> <span class="bound">I</span> <span class="main">=</span>
     sum <span class="main">(</span>wt <span class="main">(</span><span class="free">dl</span> <span class="main">!</span> <span class="bound">n</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span> <span class="main">(</span><span class="free">F</span> <span class="bound">n</span> <span class="bound">I</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> st<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">≈</span> <span class="free">t</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span>
<span class="quoted"><span class="quoted">"sum <span class="main">(</span>wt <span class="main">(</span>Par <span class="free">cl</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span> <span class="free">II</span> <span class="main">=</span>
 sum <span class="main">(</span>wt <span class="main">(</span>Par <span class="free">dl</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span> <span class="main">(</span>UNlift <span class="free">cl</span> <span class="free">dl</span> <span class="free">P</span> <span class="free">F</span> <span class="free">II</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">=</span> <span class="var">?R</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?N</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"length <span class="free">cl</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?p</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">%</span><span class="bound">n</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> <span class="var">?N</span>"</span></span> <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?q</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">%</span><span class="bound">n</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> <span class="main">(</span>length <span class="free">dl</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ss</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">%</span><span class="bound">n</span><span class="main">.</span> <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?tt</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">%</span><span class="bound">n</span><span class="main">.</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> sstt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> <span class="var">?N</span> <span class="main">⟹</span> <span class="var">?ss</span> <span class="bound">n</span> <span class="main">≈</span> <span class="var">?tt</span> <span class="bound">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> st <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> pq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> <span class="var">?N</span> <span class="main">⟹</span> <span class="var">?p</span> <span class="bound">n</span> <span class="main">=</span> <span class="var">?q</span> <span class="bound">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> sstt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> <span class="var">?N</span> <span class="main">⟹</span> <span class="var">?ss</span> <span class="bound">n</span> <span class="main">≈</span> <span class="var">?tt</span> <span class="bound">n</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms l <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> II <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> UNpart_cases<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Local <span class="skolem">n</span> <span class="skolem">I</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">&lt;</span> <span class="var">?N</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">&lt;</span> length <span class="free">dl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">I</span> <span class="main">∈</span> <span class="free">P</span> <span class="skolem">n</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> II<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">II</span> <span class="main">=</span> shift <span class="free">cl</span> <span class="skolem">n</span> <span class="skolem">I</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> l <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> I_sub<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">I</span> <span class="main">⊆</span> <span class="main">{..&lt;</span> brn <span class="main">(</span><span class="free">cl</span><span class="main">!</span><span class="skolem">n</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> n I P <span class="keyword1"><span class="command">unfolding</span></span> part_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">hence</span></span> FnI_sub<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">F</span> <span class="skolem">n</span> <span class="skolem">I</span> <span class="main">⊆</span> <span class="main">{..&lt;</span> brn <span class="main">(</span><span class="free">dl</span><span class="main">!</span><span class="skolem">n</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> n I FP <span class="keyword1"><span class="command">unfolding</span></span> part_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">=</span> <span class="main">(</span><span class="var">?p</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">*</span> sum <span class="main">(</span>wt <span class="main">(</span><span class="free">cl</span> <span class="main">!</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span><span class="var">?ss</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="skolem">I</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> II <span class="keyword1"><span class="command">using</span></span> n cldl I_sub <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="var">?q</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">*</span> sum <span class="main">(</span>wt <span class="main">(</span><span class="free">dl</span> <span class="main">!</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span><span class="var">?tt</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">F</span> <span class="skolem">n</span> <span class="skolem">I</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> n pq <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span> <span class="keyword1"><span class="command">using</span></span> I sw<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">n</span></span> <span class="quoted"><span class="skolem">I</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> l <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="var">?R</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> II <span class="keyword1"><span class="command">using</span></span> l cldl n FnI_sub P I <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* *)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">thetaSPar</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">thetaSPar</span> <span class="main">≡</span>
 <span class="main">{</span><span class="main">(</span>Par <span class="bound">cl</span><span class="main">,</span> Par <span class="bound">dl</span><span class="main">)</span> <span class="main">|</span>
    <span class="bound">cl</span> <span class="bound">dl</span><span class="main">.</span> properL <span class="bound">cl</span> <span class="main">∧</span> properL <span class="bound">dl</span> <span class="main">∧</span> SbisL <span class="bound">cl</span> <span class="bound">dl</span><span class="main">}</span>"</span></span>

<span class="keyword1" id="Compositionality-cont_eff_Par_UNlift"><span class="command">lemma</span></span> cont_eff_Par_UNlift<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> l<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">cl</span> <span class="main">=</span> length <span class="free">dl</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> cldl<span class="main">:</span> <span class="quoted"><span class="quoted">"properL <span class="free">cl</span>"</span></span> <span class="quoted"><span class="quoted">"properL <span class="free">dl</span>"</span></span> <span class="quoted"><span class="quoted">"SbisL <span class="free">cl</span> <span class="free">dl</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> II<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">II</span> <span class="main">∈</span> UNpart <span class="free">cl</span> <span class="free">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ii<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ii</span> <span class="main">∈</span> <span class="free">II</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> jj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">jj</span> <span class="main">∈</span> UNlift <span class="free">cl</span> <span class="free">dl</span> <span class="free">P</span> <span class="free">F</span> <span class="free">II</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> P<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> length <span class="free">cl</span> <span class="main">⟹</span> part <span class="main">{..&lt;</span> brn <span class="main">(</span><span class="free">cl</span><span class="main">!</span><span class="bound">n</span><span class="main">)</span><span class="main">}</span> <span class="main">(</span><span class="free">P</span> <span class="bound">n</span><span class="main">)</span> <span class="main">∧</span> <span class="main">{}</span> <span class="main">∉</span> <span class="free">P</span> <span class="bound">n</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> FP<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> length <span class="free">dl</span> <span class="main">⟹</span> part <span class="main">{..&lt;</span> brn <span class="main">(</span><span class="free">dl</span><span class="main">!</span><span class="bound">n</span><span class="main">)</span><span class="main">}</span> <span class="main">(</span><span class="free">F</span> <span class="bound">n</span> <span class="main">`</span> <span class="main">(</span><span class="free">P</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> eff_cont<span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span> <span class="bound">I</span> <span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="main">⟦</span><span class="bound">n</span> <span class="main">&lt;</span> length <span class="free">cl</span><span class="main">;</span> <span class="bound">I</span> <span class="main">∈</span> <span class="free">P</span> <span class="bound">n</span><span class="main">;</span> <span class="bound">i</span> <span class="main">∈</span> <span class="bound">I</span><span class="main">;</span> <span class="bound">j</span> <span class="main">∈</span> <span class="free">F</span> <span class="bound">n</span> <span class="bound">I</span><span class="main">⟧</span> <span class="main">⟹</span>
  eff <span class="main">(</span><span class="free">cl</span><span class="main">!</span><span class="bound">n</span><span class="main">)</span> <span class="free">s</span> <span class="bound">i</span> <span class="main">≈</span> eff <span class="main">(</span><span class="free">dl</span><span class="main">!</span><span class="bound">n</span><span class="main">)</span> <span class="free">t</span> <span class="bound">j</span> <span class="main">∧</span>
  cont <span class="main">(</span><span class="free">cl</span><span class="main">!</span><span class="bound">n</span><span class="main">)</span> <span class="free">s</span> <span class="bound">i</span> <span class="keyword1">≈s</span> cont <span class="main">(</span><span class="free">dl</span><span class="main">!</span><span class="bound">n</span><span class="main">)</span> <span class="free">t</span> <span class="bound">j</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> st<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">≈</span> <span class="free">t</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span>
<span class="quoted"><span class="quoted">"eff <span class="main">(</span>Par <span class="free">cl</span><span class="main">)</span> <span class="free">s</span> <span class="free">ii</span> <span class="main">≈</span> eff <span class="main">(</span>Par <span class="free">dl</span><span class="main">)</span> <span class="free">t</span> <span class="free">jj</span> <span class="main">∧</span>
 <span class="main">(</span>cont <span class="main">(</span>Par <span class="free">cl</span><span class="main">)</span> <span class="free">s</span> <span class="free">ii</span><span class="main">,</span> cont <span class="main">(</span>Par <span class="free">dl</span><span class="main">)</span> <span class="free">t</span> <span class="free">jj</span><span class="main">)</span> <span class="main">∈</span> thetaSPar"</span></span>
<span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?eff</span> <span class="main">∧</span> <span class="var">?cont</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?N</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"length <span class="free">cl</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?p</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">%</span><span class="bound">n</span><span class="main">.</span> <span class="main">1</span><span class="main">/</span><span class="var">?N</span>"</span></span> <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?q</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">%</span><span class="bound">n</span><span class="main">.</span> <span class="main">1</span><span class="main">/</span><span class="main">(</span>length <span class="free">dl</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ss</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">%</span><span class="bound">n</span><span class="main">.</span> <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?tt</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">%</span><span class="bound">n</span><span class="main">.</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> sstt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> <span class="var">?N</span> <span class="main">⟹</span> <span class="var">?ss</span> <span class="bound">n</span> <span class="main">≈</span> <span class="var">?tt</span> <span class="bound">n</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> st l <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> pq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> <span class="var">?N</span> <span class="main">⟹</span> <span class="var">?p</span> <span class="bound">n</span> <span class="main">=</span> <span class="var">?q</span> <span class="bound">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> sstt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> <span class="var">?N</span> <span class="main">⟹</span> <span class="var">?ss</span> <span class="bound">n</span> <span class="main">≈</span> <span class="var">?tt</span> <span class="bound">n</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms l <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> II <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> UNpart_cases<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Local <span class="skolem">n</span> <span class="skolem">I</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">&lt;</span> length <span class="free">cl</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">&lt;</span> length <span class="free">dl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">I</span> <span class="main">∈</span> <span class="free">P</span> <span class="skolem">n</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> II<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">II</span> <span class="main">=</span> shift <span class="free">cl</span> <span class="skolem">n</span> <span class="skolem">I</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> l <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> ii II <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="skolem">I</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ii<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ii</span> <span class="main">=</span> brnL <span class="free">cl</span> <span class="skolem">n</span> <span class="main">+</span> <span class="skolem">i</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> shift_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> brn <span class="main">(</span><span class="free">cl</span><span class="main">!</span><span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> i I n P <span class="keyword1"><span class="command">unfolding</span></span> part_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> <span class="keyword1"><span class="command">note</span></span> i <span class="main">=</span> this i
    <span class="keyword1"><span class="command">have</span></span> jj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">jj</span> <span class="main">∈</span> shift <span class="free">dl</span> <span class="skolem">n</span> <span class="main">(</span><span class="free">F</span> <span class="skolem">n</span> <span class="skolem">I</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> jj P n I <span class="keyword1"><span class="command">unfolding</span></span> II <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> jj II <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∈</span> <span class="free">F</span> <span class="skolem">n</span> <span class="skolem">I</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> jj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">jj</span> <span class="main">=</span> brnL <span class="free">dl</span> <span class="skolem">n</span> <span class="main">+</span> <span class="skolem">j</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> shift_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> brn <span class="main">(</span><span class="free">dl</span><span class="main">!</span><span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> j I n FP <span class="keyword1"><span class="command">unfolding</span></span> part_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> <span class="keyword1"><span class="command">note</span></span> j <span class="main">=</span> this j
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eff <span class="main">(</span><span class="free">cl</span><span class="main">!</span><span class="skolem">n</span><span class="main">)</span> <span class="main">(</span><span class="var">?ss</span> <span class="skolem">n</span><span class="main">)</span> <span class="skolem">i</span> <span class="main">≈</span> eff <span class="main">(</span><span class="free">dl</span><span class="main">!</span><span class="skolem">n</span><span class="main">)</span> <span class="main">(</span><span class="var">?tt</span> <span class="skolem">n</span><span class="main">)</span> <span class="skolem">j</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> n I i j eff_cont <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?eff</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> ii jj <span class="keyword1"><span class="command">using</span></span> st cldl n i j <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cont <span class="main">(</span><span class="free">cl</span><span class="main">!</span><span class="skolem">n</span><span class="main">)</span> <span class="main">(</span><span class="var">?ss</span> <span class="skolem">n</span><span class="main">)</span> <span class="skolem">i</span> <span class="keyword1">≈s</span> cont <span class="main">(</span><span class="free">dl</span><span class="main">!</span><span class="skolem">n</span><span class="main">)</span> <span class="main">(</span><span class="var">?tt</span> <span class="skolem">n</span><span class="main">)</span> <span class="skolem">j</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> n I i j eff_cont <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?cont</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> ii jj thetaSPar_def <span class="keyword1"><span class="command">using</span></span> n i j l cldl <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Compositionality-thetaSPar_Sretr"><span class="command">lemma</span></span> thetaSPar_Sretr<span class="main">:</span> <span class="quoted"><span class="quoted">"thetaSPar <span class="main">⊆</span> Sretr <span class="main">(</span>thetaSPar<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> Sretr_def matchC_C_def <span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">c</span> <span class="skolem">d</span> <span class="skolem">s</span> <span class="skolem">t</span>
  <span class="keyword3"><span class="command">assume</span></span> c_d<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">c</span><span class="main">,</span> <span class="skolem">d</span><span class="main">)</span> <span class="main">∈</span> thetaSPar"</span></span> <span class="keyword2"><span class="keyword">and</span></span> st<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">≈</span> <span class="skolem">t</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">cl</span></span> <span class="skolem"><span class="skolem">dl</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">=</span> Par <span class="skolem">cl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> d<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">=</span> Par <span class="skolem">dl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  cldl<span class="main">:</span> <span class="quoted"><span class="quoted">"properL <span class="skolem">cl</span>"</span></span> <span class="quoted"><span class="quoted">"properL <span class="skolem">dl</span>"</span></span> <span class="quoted"><span class="quoted">"SbisL <span class="skolem">cl</span> <span class="skolem">dl</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> thetaSPar_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?N</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"length <span class="skolem">cl</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ss</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">%</span><span class="bound">n</span><span class="main">.</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?tt</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">%</span><span class="bound">n</span><span class="main">.</span> <span class="skolem">t</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> N<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?N</span> <span class="main">=</span> length <span class="skolem">dl</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> cldl <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> sstt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> <span class="var">?N</span> <span class="main">⟹</span> <span class="var">?ss</span> <span class="bound">n</span> <span class="main">≈</span> <span class="var">?tt</span> <span class="bound">n</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> st N <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?phi</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">%</span><span class="bound">n</span> <span class="bound">PFn</span><span class="main">.</span> mC_C Sbis <span class="main">(</span><span class="skolem">cl</span> <span class="main">!</span> <span class="bound">n</span><span class="main">)</span> <span class="main">(</span><span class="skolem">dl</span> <span class="main">!</span> <span class="bound">n</span><span class="main">)</span> <span class="main">(</span><span class="var">?ss</span> <span class="bound">n</span><span class="main">)</span> <span class="main">(</span><span class="var">?tt</span> <span class="bound">n</span><span class="main">)</span> <span class="main">(</span>fst <span class="bound">PFn</span><span class="main">)</span> <span class="main">(</span>snd <span class="bound">PFn</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span> <span class="keyword3"><span class="command">assume</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">&lt;</span> <span class="var">?N</span>"</span></span>
   <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">cl</span> <span class="main">!</span> <span class="skolem">n</span> <span class="keyword1">≈s</span> <span class="skolem">dl</span> <span class="main">!</span> <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> cldl <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
   <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">PFn</span><span class="main">.</span> <span class="var">?phi</span> <span class="skolem">n</span> <span class="bound">PFn</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> n Sbis_mC_C sstt <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">PF</span></span> <span class="keyword2"><span class="keyword">where</span></span> phi<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> <span class="var">?N</span> <span class="main">⟹</span> <span class="var">?phi</span> <span class="bound">n</span> <span class="main">(</span><span class="skolem">PF</span> <span class="bound">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> bchoice<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">{..&lt;</span> <span class="var">?N</span><span class="main">}</span>"</span></span> <span class="var"><span class="quoted"><span class="var">?phi</span></span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">P</span></span> <span class="skolem"><span class="skolem">F</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">=</span> fst <span class="keyword1">o</span> <span class="skolem">PF</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">F</span> <span class="main">=</span> snd <span class="keyword1">o</span> <span class="skolem">PF</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> m<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> <span class="var">?N</span> <span class="main">⟹</span> mC_C Sbis <span class="main">(</span><span class="skolem">cl</span> <span class="main">!</span> <span class="bound">n</span><span class="main">)</span> <span class="main">(</span><span class="skolem">dl</span> <span class="main">!</span> <span class="bound">n</span><span class="main">)</span> <span class="main">(</span><span class="var">?ss</span> <span class="bound">n</span><span class="main">)</span> <span class="main">(</span><span class="var">?tt</span> <span class="bound">n</span><span class="main">)</span> <span class="main">(</span><span class="skolem">P</span> <span class="bound">n</span><span class="main">)</span> <span class="main">(</span><span class="skolem">F</span> <span class="bound">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> phi <span class="keyword1"><span class="command">unfolding</span></span> P_def F_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="comment1">(*  *)</span>
  <span class="keyword1"><span class="command">have</span></span> brn_c<span class="main">:</span> <span class="quoted"><span class="quoted">"brn <span class="skolem">c</span> <span class="main">=</span> brnL <span class="skolem">cl</span> <span class="var">?N</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> c <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> brn_d<span class="main">:</span> <span class="quoted"><span class="quoted">"brn <span class="skolem">d</span> <span class="main">=</span> brnL <span class="skolem">dl</span> <span class="main">(</span>length <span class="skolem">dl</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> d <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> P<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> <span class="var">?N</span> <span class="main">⟹</span> part <span class="main">{..&lt;</span> brn <span class="main">(</span><span class="skolem">cl</span> <span class="main">!</span> <span class="bound">n</span><span class="main">)</span><span class="main">}</span> <span class="main">(</span><span class="skolem">P</span> <span class="bound">n</span><span class="main">)</span> <span class="main">∧</span> <span class="main">{}</span> <span class="main">∉</span> <span class="main">(</span><span class="skolem">P</span> <span class="bound">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> m <span class="keyword1"><span class="command">unfolding</span></span> m_defsAll part_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> FP<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> length <span class="skolem">dl</span> <span class="main">⟹</span> part <span class="main">{..&lt;</span> brn <span class="main">(</span><span class="skolem">dl</span> <span class="main">!</span> <span class="bound">n</span><span class="main">)</span><span class="main">}</span> <span class="main">(</span><span class="skolem">F</span> <span class="bound">n</span> <span class="main">`</span> <span class="main">(</span><span class="skolem">P</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="main">{}</span> <span class="main">∉</span> <span class="skolem">F</span> <span class="bound">n</span> <span class="main">`</span> <span class="main">(</span><span class="skolem">P</span> <span class="bound">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> m N <span class="keyword1"><span class="command">unfolding</span></span> m_defsAll part_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> F<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> <span class="var">?N</span> <span class="main">⟹</span> inj_on <span class="main">(</span><span class="skolem">F</span> <span class="bound">n</span><span class="main">)</span> <span class="main">(</span><span class="skolem">P</span> <span class="bound">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> m <span class="keyword1"><span class="command">unfolding</span></span> m_defsAll <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> sw<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span> <span class="bound">I</span><span class="main">.</span> <span class="main">⟦</span><span class="bound">n</span> <span class="main">&lt;</span> length <span class="skolem">cl</span><span class="main">;</span> <span class="bound">I</span> <span class="main">∈</span> <span class="skolem">P</span> <span class="bound">n</span><span class="main">⟧</span> <span class="main">⟹</span>
     sum <span class="main">(</span>wt <span class="main">(</span><span class="skolem">cl</span> <span class="main">!</span> <span class="bound">n</span><span class="main">)</span> <span class="main">(</span><span class="var">?ss</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span> <span class="bound">I</span> <span class="main">=</span> sum <span class="main">(</span>wt <span class="main">(</span><span class="skolem">dl</span> <span class="main">!</span> <span class="bound">n</span><span class="main">)</span> <span class="main">(</span><span class="var">?tt</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">F</span> <span class="bound">n</span> <span class="bound">I</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> m <span class="keyword1"><span class="command">unfolding</span></span> mC_C_def mC_C_wt_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> eff_cont<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span> <span class="bound">I</span> <span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="main">⟦</span><span class="bound">n</span> <span class="main">&lt;</span> length <span class="skolem">cl</span><span class="main">;</span> <span class="bound">I</span> <span class="main">∈</span> <span class="skolem">P</span> <span class="bound">n</span><span class="main">;</span> <span class="bound">i</span> <span class="main">∈</span> <span class="bound">I</span><span class="main">;</span> <span class="bound">j</span> <span class="main">∈</span> <span class="skolem">F</span> <span class="bound">n</span> <span class="bound">I</span><span class="main">⟧</span> <span class="main">⟹</span>
     eff <span class="main">(</span><span class="skolem">cl</span><span class="main">!</span><span class="bound">n</span><span class="main">)</span> <span class="main">(</span><span class="var">?ss</span> <span class="bound">n</span><span class="main">)</span> <span class="bound">i</span> <span class="main">≈</span> eff <span class="main">(</span><span class="skolem">dl</span><span class="main">!</span><span class="bound">n</span><span class="main">)</span> <span class="main">(</span><span class="var">?tt</span> <span class="bound">n</span><span class="main">)</span> <span class="bound">j</span> <span class="main">∧</span>
     cont <span class="main">(</span><span class="skolem">cl</span><span class="main">!</span><span class="bound">n</span><span class="main">)</span> <span class="main">(</span><span class="var">?ss</span> <span class="bound">n</span><span class="main">)</span> <span class="bound">i</span> <span class="keyword1">≈s</span> cont <span class="main">(</span><span class="skolem">dl</span><span class="main">!</span><span class="bound">n</span><span class="main">)</span> <span class="main">(</span><span class="var">?tt</span> <span class="bound">n</span><span class="main">)</span> <span class="bound">j</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> m <span class="keyword1"><span class="command">unfolding</span></span> mC_C_def mC_C_eff_cont_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="comment1">(*  *)</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">Q</span></span> <span class="skolem"><span class="skolem">G</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Q</span> <span class="main">=</span> UNpart <span class="skolem">cl</span> <span class="skolem">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">G</span> <span class="main">=</span> UNlift <span class="skolem">cl</span> <span class="skolem">dl</span> <span class="skolem">P</span> <span class="skolem">F</span>"</span></span>
  <span class="keyword1"><span class="command">note</span></span> defi <span class="main">=</span> Q_def G_def brn_c brn_d
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">Q</span> <span class="bound">G</span><span class="main">.</span> mC_C <span class="main">(</span>thetaSPar<span class="main">)</span> <span class="skolem">c</span> <span class="skolem">d</span> <span class="skolem">s</span> <span class="skolem">t</span> <span class="bound">Q</span> <span class="bound">G</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">Q</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">G</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> mC_C_def <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"mC_C_part <span class="skolem">c</span> <span class="skolem">d</span> <span class="skolem">Q</span> <span class="skolem">G</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> mC_C_part_def <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{}</span> <span class="main">∉</span> <span class="skolem">Q</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> defi <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> emp_UNpart<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> P <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{}</span> <span class="main">∉</span> <span class="skolem">G</span> <span class="main">`</span> <span class="skolem">Q</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> defi <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> emp_UNlift_UNpart<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> N P FP <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"part <span class="main">{..&lt;</span>brn <span class="skolem">c</span><span class="main">}</span> <span class="skolem">Q</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> defi <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> part_UNpart<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> cldl P <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"part <span class="main">{..&lt;</span>brn <span class="skolem">d</span><span class="main">}</span> <span class="main">(</span><span class="skolem">G</span> <span class="main">`</span> <span class="skolem">Q</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> defi <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> part_UNlift_UNpart<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> N cldl P FP <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="skolem">G</span> <span class="skolem">Q</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> defi <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> UNlift_inj_on<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> N P FP F <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"mC_C_wt <span class="skolem">c</span> <span class="skolem">d</span> <span class="skolem">s</span> <span class="skolem">t</span> <span class="skolem">Q</span> <span class="skolem">G</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> mC_C_wt_def defi <span class="keyword1"><span class="command">proof</span></span> <span class="operator">clarify</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">I</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">I</span> <span class="main">∈</span> UNpart <span class="skolem">cl</span> <span class="skolem">P</span>"</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"sum <span class="main">(</span>wt <span class="skolem">c</span> <span class="skolem">s</span><span class="main">)</span> <span class="skolem">I</span> <span class="main">=</span> sum <span class="main">(</span>wt <span class="skolem">d</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">(</span>UNlift <span class="skolem">cl</span> <span class="skolem">dl</span> <span class="skolem">P</span> <span class="skolem">F</span> <span class="skolem">I</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> c d <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">intro</span> ss_wt_Par_UNlift<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> N cldl P FP sw st <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"mC_C_eff_cont <span class="main">(</span>thetaSPar<span class="main">)</span> <span class="skolem">c</span> <span class="skolem">d</span> <span class="skolem">s</span> <span class="skolem">t</span> <span class="skolem">Q</span> <span class="skolem">G</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> mC_C_eff_cont_def <span class="keyword1"><span class="command">proof</span></span> <span class="operator">clarify</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">II</span> <span class="skolem">ii</span> <span class="skolem">jj</span> <span class="keyword3"><span class="command">assume</span></span> II<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">II</span> <span class="main">∈</span> <span class="skolem">Q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ii<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ii</span> <span class="main">∈</span> <span class="skolem">II</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> jj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">jj</span> <span class="main">∈</span> <span class="skolem">G</span> <span class="skolem">II</span>"</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"eff <span class="skolem">c</span> <span class="skolem">s</span> <span class="skolem">ii</span> <span class="main">≈</span> eff <span class="skolem">d</span> <span class="skolem">t</span> <span class="skolem">jj</span> <span class="main">∧</span> <span class="main">(</span>cont <span class="skolem">c</span> <span class="skolem">s</span> <span class="skolem">ii</span><span class="main">,</span> cont <span class="skolem">d</span> <span class="skolem">t</span> <span class="skolem">jj</span><span class="main">)</span> <span class="main">∈</span> thetaSPar"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> defi c d <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">intro</span> cont_eff_Par_UNlift<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> N cldl P FP eff_cont st <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Compositionality-thetaSPar_Sbis"><span class="command">lemma</span></span> thetaSPar_Sbis<span class="main">:</span> <span class="quoted"><span class="quoted">"thetaSPar <span class="main">⊆</span> Sbis"</span></span>
<span class="keyword1"><span class="command">using</span></span> Sbis_raw_coind thetaSPar_Sretr <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">theorem</span></span> Par_Sbis<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"properL <span class="free">cl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"properL <span class="free">dl</span>"</span></span> <span class="quoted"><span class="quoted">"SbisL <span class="free">cl</span> <span class="free">dl</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Par <span class="free">cl</span> <span class="keyword1">≈s</span> Par <span class="free">dl</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms thetaSPar_Sbis <span class="keyword1"><span class="command">unfolding</span></span> thetaSPar_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>


<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹01-bisimilarity versus language constructs›</span></span>

<span class="comment1">(* Discreetness: *)</span>
<span class="keyword1" id="Compositionality-ZObis_pres_discr_L"><span class="command">lemma</span></span> ZObis_pres_discr_L<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">≈01</span> <span class="free">d</span> <span class="main">⟹</span> discr <span class="free">d</span> <span class="main">⟹</span> discr <span class="free">c</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">d</span></span> <span class="quoted"><span class="free">c</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="skolem">i</span> <span class="skolem">c</span> <span class="skolem">d</span> <span class="keyword3"><span class="command">assume</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> brn <span class="skolem">c</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> d<span class="main">:</span> <span class="quoted"><span class="quoted">"discr <span class="skolem">d</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> c_d<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">≈01</span> <span class="skolem">d</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">I0</span></span> <span class="skolem"><span class="skolem">P</span></span> <span class="skolem"><span class="skolem">F</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    match<span class="main">:</span> <span class="quoted"><span class="quoted">"mC_ZOC ZObis <span class="skolem">c</span> <span class="skolem">d</span> <span class="skolem">s</span> <span class="skolem">s</span> <span class="skolem">I0</span> <span class="skolem">P</span> <span class="skolem">F</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ZObis_mC_ZOC<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">c</span></span> <span class="quoted"><span class="skolem">d</span></span> <span class="quoted"><span class="skolem">s</span></span> <span class="quoted"><span class="skolem">s</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span><span class="skolem">P</span> <span class="main">=</span> <span class="main">{..&lt;</span>brn <span class="skolem">c</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> i <span class="keyword1"><span class="command">unfolding</span></span> mC_ZOC_def mC_ZOC_part_def part_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">I</span></span> <span class="keyword2"><span class="keyword">where</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">I</span> <span class="main">∈</span> <span class="skolem">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="skolem">I</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> i <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">≈</span> eff <span class="skolem">c</span> <span class="skolem">s</span> <span class="skolem">i</span> <span class="main">∧</span> <span class="main">(</span><span class="main">(</span><span class="main">∃</span><span class="bound">d</span><span class="main">.</span> cont <span class="skolem">c</span> <span class="skolem">s</span> <span class="skolem">i</span> <span class="main">≈01</span> <span class="bound">d</span> <span class="main">∧</span> discr <span class="bound">d</span><span class="main">)</span> <span class="main">∨</span> discr <span class="main">(</span>cont <span class="skolem">c</span> <span class="skolem">s</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">I</span> <span class="main">=</span> <span class="skolem">I0</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∈</span> <span class="skolem">F</span> <span class="skolem">I</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> match I False <span class="keyword1"><span class="command">unfolding</span></span> mC_ZOC_def mC_ZOC_part_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> brn <span class="skolem">d</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> I match
      <span class="keyword1"><span class="command">unfolding</span></span> mC_ZOC_def mC_ZOC_part_def part_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">hence</span></span> md<span class="main">:</span> <span class="quoted"><span class="quoted">"discr <span class="main">(</span>cont <span class="skolem">d</span> <span class="skolem">s</span> <span class="skolem">j</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">≈</span> eff <span class="skolem">d</span> <span class="skolem">s</span> <span class="skolem">j</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> d discr_cont<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">d</span></span> <span class="quoted"><span class="skolem">j</span></span> <span class="quoted"><span class="skolem">s</span></span><span class="main">]</span> discr_eff_indis<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">d</span></span> <span class="quoted"><span class="skolem">j</span></span> <span class="quoted"><span class="skolem">s</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eff <span class="skolem">c</span> <span class="skolem">s</span> <span class="skolem">i</span> <span class="main">≈</span> eff <span class="skolem">d</span> <span class="skolem">s</span> <span class="skolem">j</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> md2<span class="main">:</span> <span class="quoted"><span class="quoted">"cont <span class="skolem">c</span> <span class="skolem">s</span> <span class="skolem">i</span> <span class="main">≈01</span> cont <span class="skolem">d</span> <span class="skolem">s</span> <span class="skolem">j</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> I i j match False <span class="keyword1"><span class="command">unfolding</span></span> mC_ZOC_def mC_ZOC_eff_cont_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">≈</span> eff <span class="skolem">c</span> <span class="skolem">s</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> s indis_sym indis_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> md md2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">≈</span> eff <span class="skolem">c</span> <span class="skolem">s</span> <span class="skolem">i</span> <span class="main">∧</span> cont <span class="skolem">c</span> <span class="skolem">s</span> <span class="skolem">i</span> <span class="main">≈01</span> <span class="skolem">d</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> match i ZObis_sym <span class="keyword1"><span class="command">unfolding</span></span> mC_ZOC_def mC_ZOC_eff_cont0_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> d <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> ZObis_pres_discr_R<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"discr <span class="free">c</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">≈01</span> <span class="free">d</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"discr <span class="free">d</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms ZObis_pres_discr_L ZObis_sym <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">theorem</span></span> ZObis_finished_discr_L<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">≈01</span> <span class="free">d</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"proper <span class="free">d</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"finished <span class="free">d</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"discr <span class="free">c</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms ZObis_pres_discr_L <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">theorem</span></span> ZObis_finished_discr_R<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"proper <span class="free">c</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"finished <span class="free">c</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">≈01</span> <span class="free">d</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"discr <span class="free">d</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms ZObis_pres_discr_R<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">c</span></span> <span class="quoted"><span class="free">d</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">theorem</span></span> discr_ZObis<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"proper <span class="free">c</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"proper <span class="free">d</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"discr <span class="free">c</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"discr <span class="free">d</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">≈01</span> <span class="free">d</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="comment1">(* Done: *)</span>
 <span class="keyword1"><span class="command">theorem</span></span> Done_ZObis<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="quoted"><span class="quoted">"Done <span class="main">≈01</span> Done"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="comment1">(* Atm: *)</span>
<span class="keyword1"><span class="command">theorem</span></span> Atm_ZObis<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"compatAtm <span class="free">atm</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Atm <span class="free">atm</span> <span class="main">≈01</span> Atm <span class="free">atm</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="comment1">(* Seq *)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">thetaZOSeqI</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">thetaZOSeqI</span> <span class="main">≡</span>
 <span class="main">{</span><span class="main">(</span><span class="bound">e</span> <span class="main">;;</span> <span class="bound">c</span><span class="main">,</span> <span class="bound">e</span> <span class="main">;;</span> <span class="bound">d</span><span class="main">)</span> <span class="main">|</span> <span class="bound">e</span> <span class="bound">c</span> <span class="bound">d</span> <span class="main">.</span> siso <span class="bound">e</span> <span class="main">∧</span> <span class="bound">c</span> <span class="main">≈01</span> <span class="bound">d</span><span class="main">}</span>"</span></span>

<span class="keyword1" id="Compositionality-thetaZOSeqI_ZOretr"><span class="command">lemma</span></span> thetaZOSeqI_ZOretr<span class="main">:</span>
<span class="quoted"><span class="quoted">"thetaZOSeqI <span class="main">⊆</span> ZOretr <span class="main">(</span>thetaZOSeqI <span class="keyword1">Un</span> ZObis<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> ZOretr_def matchC_LC_def <span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">c</span> <span class="skolem">d</span> <span class="skolem">s</span> <span class="skolem">t</span>
  <span class="keyword3"><span class="command">assume</span></span> c_d<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">c</span><span class="main">,</span> <span class="skolem">d</span><span class="main">)</span> <span class="main">∈</span> thetaZOSeqI"</span></span> <span class="keyword2"><span class="keyword">and</span></span> st<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">≈</span> <span class="skolem">t</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">e</span></span> <span class="skolem"><span class="skolem">c1</span></span> <span class="skolem"><span class="skolem">d1</span></span> <span class="keyword2"><span class="keyword">where</span></span> e<span class="main">:</span> <span class="quoted"><span class="quoted">"siso <span class="skolem">e</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> c1d1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c1</span> <span class="main">≈01</span> <span class="skolem">d1</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">=</span> <span class="skolem">e</span> <span class="main">;;</span> <span class="skolem">c1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> d<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">=</span> <span class="skolem">e</span> <span class="main">;;</span> <span class="skolem">d1</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> thetaZOSeqI_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?I0</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?J0</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="var">?I0</span><span class="main">}</span> <span class="keyword1">Un</span> <span class="main">{</span><span class="main">{</span><span class="bound">i</span><span class="main">}</span> <span class="main">|</span> <span class="bound">i</span> <span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> brn <span class="skolem">e</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?F</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">%</span><span class="bound">I</span><span class="main">.</span> <span class="bound">I</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">I0</span> <span class="bound">P</span> <span class="bound">F</span><span class="main">.</span> mC_ZOC <span class="main">(</span>thetaZOSeqI <span class="keyword1">Un</span> ZObis<span class="main">)</span> <span class="skolem">c</span> <span class="skolem">d</span> <span class="skolem">s</span> <span class="skolem">t</span> <span class="bound">I0</span> <span class="bound">P</span> <span class="bound">F</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?I0</span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?P</span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?F</span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> mC_ZOC_def <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"mC_ZOC_part <span class="skolem">c</span> <span class="skolem">d</span> <span class="skolem">s</span> <span class="skolem">t</span> <span class="var">?I0</span> <span class="var">?P</span> <span class="var">?F</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> mC_ZOC_part_def <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"part <span class="main">{..&lt;</span>brn <span class="skolem">c</span><span class="main">}</span> <span class="var">?P</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> part_def <span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> brn <span class="skolem">c</span>"</span></span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="main">⋃</span> <span class="var">?P</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> c e st siso_cont_indis<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">e</span></span> <span class="quoted"><span class="skolem">s</span></span> <span class="quoted"><span class="skolem">t</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">unfold</span> c<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
      <span class="comment1">(*  *)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"part <span class="main">{..&lt;</span>brn <span class="skolem">d</span><span class="main">}</span> <span class="main">(</span><span class="var">?F</span> <span class="main">`</span> <span class="var">?P</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> c d <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"mC_ZOC_eff_cont <span class="main">(</span>thetaZOSeqI <span class="keyword1">Un</span> ZObis<span class="main">)</span> <span class="skolem">c</span> <span class="skolem">d</span> <span class="skolem">s</span> <span class="skolem">t</span> <span class="var">?I0</span> <span class="var">?P</span> <span class="var">?F</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> mC_ZOC_eff_cont_def <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">intro</span> allI impI<span class="main"><span class="keyword3">,</span></span> <span class="operator">elim</span> conjE<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">I</span> <span class="skolem">i</span> <span class="skolem">j</span>
      <span class="keyword3"><span class="command">assume</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">I</span> <span class="main">∈</span> <span class="var">?P</span> <span class="main">-</span> <span class="main">{</span><span class="var">?I0</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="skolem">I</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∈</span> <span class="skolem">I</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∈</span> <span class="var">?F</span> <span class="main">{</span><span class="skolem">i'</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i'</span> <span class="main">&lt;</span> brn <span class="skolem">e</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> I j <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"eff <span class="skolem">c</span> <span class="skolem">s</span> <span class="skolem">i</span> <span class="main">≈</span> eff <span class="skolem">d</span> <span class="skolem">t</span> <span class="skolem">j</span> <span class="main">∧</span> <span class="main">(</span>cont <span class="skolem">c</span> <span class="skolem">s</span> <span class="skolem">i</span><span class="main">,</span> cont <span class="skolem">d</span> <span class="skolem">t</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">∈</span> thetaZOSeqI <span class="main">∪</span> ZObis"</span></span>
      <span class="keyword1"><span class="command">using</span></span> st c_d e i j I <span class="keyword1"><span class="command">unfolding</span></span> c d thetaZOSeqI_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"finished <span class="main">(</span>cont <span class="skolem">e</span> <span class="skolem">s</span> <span class="skolem">i'</span><span class="main">)</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> st c_d c<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> m_defsAll thetaZOSeqI_def part_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Compositionality-thetaZOSeqI_ZObis"><span class="command">lemma</span></span> thetaZOSeqI_ZObis<span class="main">:</span>
<span class="quoted"><span class="quoted">"thetaZOSeqI <span class="main">⊆</span> ZObis"</span></span>
<span class="keyword1"><span class="command">using</span></span> ZObis_coind thetaZOSeqI_ZOretr <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">theorem</span></span> Seq_siso_ZObis<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"siso <span class="free">e</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">c2</span> <span class="main">≈01</span> <span class="free">d2</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">;;</span> <span class="free">c2</span> <span class="main">≈01</span> <span class="free">e</span> <span class="main">;;</span> <span class="free">d2</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms thetaZOSeqI_ZObis <span class="keyword1"><span class="command">unfolding</span></span> thetaZOSeqI_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="comment1">(*  *)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">thetaZOSeqD</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">thetaZOSeqD</span> <span class="main">≡</span>
 <span class="main">{</span><span class="main">(</span><span class="bound">c1</span> <span class="main">;;</span> <span class="bound">c2</span><span class="main">,</span> <span class="bound">d1</span> <span class="main">;;</span> <span class="bound">d2</span><span class="main">)</span> <span class="main">|</span>
     <span class="bound">c1</span> <span class="bound">c2</span> <span class="bound">d1</span> <span class="bound">d2</span><span class="main">.</span>
        proper <span class="bound">c1</span> <span class="main">∧</span> proper <span class="bound">d1</span> <span class="main">∧</span> proper <span class="bound">c2</span> <span class="main">∧</span> proper <span class="bound">d2</span> <span class="main">∧</span>
        discr <span class="bound">c2</span> <span class="main">∧</span> discr <span class="bound">d2</span> <span class="main">∧</span>
        <span class="bound">c1</span> <span class="main">≈01</span> <span class="bound">d1</span><span class="main">}</span>"</span></span>

<span class="keyword1" id="Compositionality-thetaZOSeqD_ZOretr"><span class="command">lemma</span></span> thetaZOSeqD_ZOretr<span class="main">:</span>
<span class="quoted"><span class="quoted">"thetaZOSeqD <span class="main">⊆</span> ZOretr <span class="main">(</span>thetaZOSeqD <span class="keyword1">Un</span> ZObis<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> ZOretr_def matchC_LC_def <span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">c</span> <span class="skolem">d</span> <span class="skolem">s</span> <span class="skolem">t</span>
  <span class="keyword3"><span class="command">assume</span></span> c_d<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">c</span><span class="main">,</span> <span class="skolem">d</span><span class="main">)</span> <span class="main">∈</span> thetaZOSeqD"</span></span> <span class="keyword2"><span class="keyword">and</span></span> st<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">≈</span> <span class="skolem">t</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c1</span></span> <span class="skolem"><span class="skolem">c2</span></span> <span class="skolem"><span class="skolem">d1</span></span> <span class="skolem"><span class="skolem">d2</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  c1d1<span class="main">:</span> <span class="quoted"><span class="quoted">"proper <span class="skolem">c1</span>"</span></span> <span class="quoted"><span class="quoted">"proper <span class="skolem">d1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c1</span> <span class="main">≈01</span> <span class="skolem">d1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  c2d2<span class="main">:</span> <span class="quoted"><span class="quoted">"proper <span class="skolem">c2</span>"</span></span> <span class="quoted"><span class="quoted">"proper <span class="skolem">d2</span>"</span></span> <span class="quoted"><span class="quoted">"discr <span class="skolem">c2</span>"</span></span> <span class="quoted"><span class="quoted">"discr <span class="skolem">d2</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">=</span> <span class="skolem">c1</span> <span class="main">;;</span> <span class="skolem">c2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> d<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">=</span> <span class="skolem">d1</span> <span class="main">;;</span> <span class="skolem">d2</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> thetaZOSeqD_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> c1d1 st <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">P</span></span> <span class="skolem"><span class="skolem">F</span></span> <span class="skolem"><span class="skolem">I0</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> match<span class="main">:</span> <span class="quoted"><span class="quoted">"mC_ZOC ZObis <span class="skolem">c1</span> <span class="skolem">d1</span> <span class="skolem">s</span> <span class="skolem">t</span> <span class="skolem">I0</span> <span class="skolem">P</span> <span class="skolem">F</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> ZObis_mC_ZOC <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> P<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span><span class="skolem">P</span> <span class="main">=</span> <span class="main">{..&lt;</span>brn <span class="skolem">c1</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> FP<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span><span class="main">(</span><span class="skolem">F</span> <span class="main">`</span> <span class="skolem">P</span><span class="main">)</span> <span class="main">=</span> <span class="main">{..&lt;</span>brn <span class="skolem">d1</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> match <span class="keyword1"><span class="command">unfolding</span></span> mC_ZOC_def mC_ZOC_part_def part_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">I0</span> <span class="bound">P</span> <span class="bound">F</span><span class="main">.</span> mC_ZOC <span class="main">(</span>thetaZOSeqD <span class="keyword1">Un</span> ZObis<span class="main">)</span> <span class="skolem">c</span> <span class="skolem">d</span> <span class="skolem">s</span> <span class="skolem">t</span> <span class="bound">I0</span> <span class="bound">P</span> <span class="bound">F</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">intro</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">I0</span></span></span></span><span class="main"><span class="main">]</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">P</span></span></span></span><span class="main"><span class="main">]</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">F</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> mC_ZOC_def <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> I0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">I0</span> <span class="main">∈</span> <span class="skolem">P</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> match <span class="keyword1"><span class="command">unfolding</span></span> m_defsAll <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"mC_ZOC_eff_cont0 <span class="main">(</span>thetaZOSeqD <span class="main">∪</span> ZObis<span class="main">)</span> <span class="skolem">c</span> <span class="skolem">d</span> <span class="skolem">s</span> <span class="skolem">t</span> <span class="skolem">I0</span> <span class="skolem">F</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> mC_ZOC_eff_cont0_def <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">intro</span> conjI ballI<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="keyword3"><span class="command">assume</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="skolem">I0</span>"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?c1'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"cont <span class="skolem">c1</span> <span class="skolem">s</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"eff <span class="skolem">c1</span> <span class="skolem">s</span> <span class="skolem">i</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> brn <span class="skolem">c1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> i I0 P <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> <span class="keyword1"><span class="command">note</span></span> i <span class="main">=</span> this i
      <span class="keyword1"><span class="command">have</span></span> c1'd1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?c1'</span> <span class="main">≈01</span> <span class="skolem">d1</span>"</span></span> <span class="quoted"><span class="quoted">"proper <span class="var">?c1'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> c1d1 i I0 match <span class="keyword1"><span class="command">unfolding</span></span> mC_ZOC_def mC_ZOC_eff_cont0_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">≈</span> eff <span class="skolem">c</span> <span class="skolem">s</span> <span class="skolem">i</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> i match <span class="keyword1"><span class="command">unfolding</span></span> c mC_ZOC_def mC_ZOC_eff_cont0_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>cont <span class="skolem">c</span> <span class="skolem">s</span> <span class="skolem">i</span><span class="main">,</span> <span class="skolem">d</span><span class="main">)</span> <span class="main">∈</span> thetaZOSeqD <span class="main">∪</span> ZObis"</span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"finished <span class="var">?c1'</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">note</span></span> f_c1' <span class="main">=</span> False
        <span class="keyword1"><span class="command">hence</span></span> csi<span class="main">:</span> <span class="quoted"><span class="quoted">"cont <span class="skolem">c</span> <span class="skolem">s</span> <span class="skolem">i</span> <span class="main">=</span> <span class="var">?c1'</span> <span class="main">;;</span> <span class="skolem">c2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> i <span class="keyword1"><span class="command">unfolding</span></span> c <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>cont <span class="skolem">c</span> <span class="skolem">s</span> <span class="skolem">i</span><span class="main">,</span> <span class="skolem">d</span><span class="main">)</span> <span class="main">∈</span> thetaZOSeqD"</span></span>
        <span class="keyword1"><span class="command">using</span></span> c1'd1 c1d1 c2d2 f_c1' i match
        <span class="keyword1"><span class="command">unfolding</span></span> csi d thetaZOSeqD_def mC_ZOC_def mC_ZOC_eff_cont0_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">note</span></span> f_c1' <span class="main">=</span> True
        <span class="keyword1"><span class="command">hence</span></span> csi<span class="main">:</span> <span class="quoted"><span class="quoted">"cont <span class="skolem">c</span> <span class="skolem">s</span> <span class="skolem">i</span> <span class="main">=</span> <span class="skolem">c2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> i <span class="keyword1"><span class="command">unfolding</span></span> c <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"discr <span class="skolem">d1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> f_c1' c1'd1 ZObis_finished_discr_R <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c2</span> <span class="main">≈01</span> <span class="skolem">d</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> c2d2 c1d1 <span class="keyword1"><span class="command">unfolding</span></span> d <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> csi <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j</span> <span class="keyword3"><span class="command">assume</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∈</span> <span class="skolem">F</span> <span class="skolem">I0</span>"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?d1'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"cont <span class="skolem">d1</span> <span class="skolem">t</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?t'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"eff <span class="skolem">d1</span> <span class="skolem">t</span> <span class="skolem">j</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> brn <span class="skolem">d1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> j I0 FP <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> <span class="keyword1"><span class="command">note</span></span> j <span class="main">=</span> this j
      <span class="keyword1"><span class="command">have</span></span> c1d1'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c1</span> <span class="main">≈01</span> <span class="var">?d1'</span>"</span></span> <span class="quoted"><span class="quoted">"proper <span class="var">?d1'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> c1d1 j I0 match <span class="keyword1"><span class="command">unfolding</span></span> mC_ZOC_def mC_ZOC_eff_cont0_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">≈</span> eff <span class="skolem">d</span> <span class="skolem">t</span> <span class="skolem">j</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> j match <span class="keyword1"><span class="command">unfolding</span></span> d mC_ZOC_def mC_ZOC_eff_cont0_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">c</span><span class="main">,</span> cont <span class="skolem">d</span> <span class="skolem">t</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">∈</span> thetaZOSeqD <span class="main">∪</span> ZObis"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"finished <span class="var">?d1'</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">note</span></span> f_d1' <span class="main">=</span> False
        <span class="keyword1"><span class="command">hence</span></span> dtj<span class="main">:</span> <span class="quoted"><span class="quoted">"cont <span class="skolem">d</span> <span class="skolem">t</span> <span class="skolem">j</span> <span class="main">=</span> <span class="var">?d1'</span> <span class="main">;;</span> <span class="skolem">d2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> j <span class="keyword1"><span class="command">unfolding</span></span> d <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">c</span><span class="main">,</span> cont <span class="skolem">d</span> <span class="skolem">t</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">∈</span> thetaZOSeqD"</span></span>
        <span class="keyword1"><span class="command">using</span></span> c1d1' c1d1 c2d2 f_d1' j match
        <span class="keyword1"><span class="command">unfolding</span></span> c dtj thetaZOSeqD_def mC_ZOC_def mC_ZOC_eff_cont0_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">note</span></span> f_d1' <span class="main">=</span> True
        <span class="keyword1"><span class="command">hence</span></span> dtj<span class="main">:</span> <span class="quoted"><span class="quoted">"cont <span class="skolem">d</span> <span class="skolem">t</span> <span class="skolem">j</span> <span class="main">=</span> <span class="skolem">d2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> j <span class="keyword1"><span class="command">unfolding</span></span> d <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"discr <span class="skolem">c1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> f_d1' c1d1' ZObis_finished_discr_L <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">≈01</span> <span class="skolem">d2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> c2d2 c1d1 <span class="keyword1"><span class="command">unfolding</span></span> c <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> dtj <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"mC_ZOC_eff_cont <span class="main">(</span>thetaZOSeqD <span class="main">∪</span> ZObis<span class="main">)</span> <span class="skolem">c</span> <span class="skolem">d</span> <span class="skolem">s</span> <span class="skolem">t</span> <span class="skolem">I0</span> <span class="skolem">P</span> <span class="skolem">F</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> mC_ZOC_eff_cont_def <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">intro</span> allI impI<span class="main"><span class="keyword3">,</span></span> <span class="operator">elim</span> conjE<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="skolem">j</span> <span class="skolem">I</span> <span class="keyword3"><span class="command">assume</span></span> I <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">I</span> <span class="main">∈</span> <span class="skolem">P</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">I0</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="skolem">I</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∈</span> <span class="skolem">F</span> <span class="skolem">I</span>"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?c1'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"cont <span class="skolem">c1</span> <span class="skolem">s</span> <span class="skolem">i</span>"</span></span>  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?d1'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"cont <span class="skolem">d1</span> <span class="skolem">t</span> <span class="skolem">j</span>"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"eff <span class="skolem">c1</span> <span class="skolem">s</span> <span class="skolem">i</span>"</span></span>  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?t'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"eff <span class="skolem">d1</span> <span class="skolem">t</span> <span class="skolem">j</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> brn <span class="skolem">c1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> i I P <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> <span class="keyword1"><span class="command">note</span></span> i <span class="main">=</span> this i
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> brn <span class="skolem">d1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> j I FP <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> <span class="keyword1"><span class="command">note</span></span> j <span class="main">=</span> this j
      <span class="keyword1"><span class="command">have</span></span> c1'd1'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?c1'</span> <span class="main">≈01</span> <span class="var">?d1'</span>"</span></span> <span class="quoted"><span class="quoted">"proper <span class="var">?c1'</span>"</span></span> <span class="quoted"><span class="quoted">"proper <span class="var">?d1'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> c1d1 i j I match <span class="keyword1"><span class="command">unfolding</span></span> c mC_ZOC_def mC_ZOC_eff_cont_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"eff <span class="skolem">c</span> <span class="skolem">s</span> <span class="skolem">i</span> <span class="main">≈</span> eff <span class="skolem">d</span> <span class="skolem">t</span> <span class="skolem">j</span> <span class="main">∧</span> <span class="main">(</span>cont <span class="skolem">c</span> <span class="skolem">s</span> <span class="skolem">i</span><span class="main">,</span> cont <span class="skolem">d</span> <span class="skolem">t</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">∈</span> thetaZOSeqD <span class="main">∪</span> ZObis"</span></span>
      <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?eff</span> <span class="main">∧</span> <span class="var">?cont</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">proof</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?eff</span></span></span> <span class="keyword1"><span class="command">using</span></span> match I i j <span class="keyword1"><span class="command">unfolding</span></span> c d m_defsAll <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?cont</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"finished <span class="var">?c1'</span>"</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">note</span></span> c1' <span class="main">=</span> True
          <span class="keyword1"><span class="command">hence</span></span> csi<span class="main">:</span> <span class="quoted"><span class="quoted">"cont <span class="skolem">c</span> <span class="skolem">s</span> <span class="skolem">i</span> <span class="main">=</span> <span class="skolem">c2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> i match <span class="keyword1"><span class="command">unfolding</span></span> c m_defsAll <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"finished <span class="var">?d1'</span>"</span></span><span class="main">)</span>
            <span class="keyword3"><span class="command">case</span></span> True
            <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"cont <span class="skolem">d</span> <span class="skolem">t</span> <span class="skolem">j</span> <span class="main">=</span> <span class="skolem">d2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> j match <span class="keyword1"><span class="command">unfolding</span></span> d m_defsAll <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> csi c2d2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">case</span></span> False
            <span class="keyword1"><span class="command">hence</span></span> dtj<span class="main">:</span> <span class="quoted"><span class="quoted">"cont <span class="skolem">d</span> <span class="skolem">t</span> <span class="skolem">j</span> <span class="main">=</span> <span class="var">?d1'</span> <span class="main">;;</span> <span class="skolem">d2</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> j match <span class="keyword1"><span class="command">unfolding</span></span> d m_defsAll <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"discr <span class="var">?d1'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> c1'd1' c1' ZObis_finished_discr_R <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> c1'd1' c2d2 <span class="keyword1"><span class="command">unfolding</span></span> csi dtj <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> False
          <span class="keyword1"><span class="command">hence</span></span> csi<span class="main">:</span> <span class="quoted"><span class="quoted">"cont <span class="skolem">c</span> <span class="skolem">s</span> <span class="skolem">i</span> <span class="main">=</span> <span class="var">?c1'</span> <span class="main">;;</span> <span class="skolem">c2</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> i match <span class="keyword1"><span class="command">unfolding</span></span> c m_defsAll <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"finished <span class="main">(</span>cont <span class="skolem">d1</span> <span class="skolem">t</span> <span class="skolem">j</span><span class="main">)</span>"</span></span><span class="main">)</span>
            <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">note</span></span> d1' <span class="main">=</span> True
            <span class="keyword1"><span class="command">hence</span></span> dtj<span class="main">:</span> <span class="quoted"><span class="quoted">"cont <span class="skolem">d</span> <span class="skolem">t</span> <span class="skolem">j</span> <span class="main">=</span> <span class="skolem">d2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> j match <span class="keyword1"><span class="command">unfolding</span></span> d m_defsAll <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"discr <span class="var">?c1'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> c1'd1' d1' ZObis_finished_discr_L <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> c1'd1' c2d2 <span class="keyword1"><span class="command">unfolding</span></span> csi dtj <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">case</span></span> False
            <span class="keyword1"><span class="command">hence</span></span> dtj<span class="main">:</span> <span class="quoted"><span class="quoted">"cont <span class="skolem">d</span> <span class="skolem">t</span> <span class="skolem">j</span> <span class="main">=</span> <span class="var">?d1'</span> <span class="main">;;</span> <span class="skolem">d2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> j match <span class="keyword1"><span class="command">unfolding</span></span> d m_defsAll <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> csi dtj thetaZOSeqD_def
            <span class="keyword1"><span class="command">using</span></span> c1'd1' c2d2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span><span class="main">(</span><span class="operator">insert</span> match<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> m_defsAll c d<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Compositionality-thetaZOSeqD_ZObis"><span class="command">lemma</span></span> thetaZOSeqD_ZObis<span class="main">:</span>
<span class="quoted"><span class="quoted">"thetaZOSeqD <span class="main">⊆</span> ZObis"</span></span>
<span class="keyword1"><span class="command">using</span></span> ZObis_coind thetaZOSeqD_ZOretr <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">theorem</span></span> Seq_ZObis<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"proper <span class="free">c1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"proper <span class="free">d1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"proper <span class="free">c2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"proper <span class="free">d2</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">c1</span> <span class="main">≈01</span> <span class="free">d1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"discr <span class="free">c2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"discr <span class="free">d2</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">c1</span> <span class="main">;;</span> <span class="free">c2</span> <span class="main">≈01</span> <span class="free">d1</span> <span class="main">;;</span> <span class="free">d2</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms thetaZOSeqD_ZObis <span class="keyword1"><span class="command">unfolding</span></span> thetaZOSeqD_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="comment1">(* Ch *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">thetaZOCh</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">thetaZOCh</span> <span class="free"><span class="bound"><span class="entity">ch</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span> <span class="free"><span class="bound"><span class="entity">d1</span></span></span> <span class="free"><span class="bound"><span class="entity">d2</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span>Ch <span class="free"><span class="bound"><span class="entity">ch</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span><span class="main">,</span> Ch <span class="free"><span class="bound"><span class="entity">ch</span></span></span> <span class="free"><span class="bound"><span class="entity">d1</span></span></span> <span class="free"><span class="bound"><span class="entity">d2</span></span></span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1" id="Compositionality-thetaZOCh_Sretr"><span class="command">lemma</span></span> thetaZOCh_Sretr<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"compatCh <span class="free">ch</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">c1</span> <span class="main">≈01</span> <span class="free">d1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">c2</span> <span class="main">≈01</span> <span class="free">d2</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"thetaZOCh <span class="free">ch</span> <span class="free">c1</span> <span class="free">c2</span> <span class="free">d1</span> <span class="free">d2</span> <span class="main">⊆</span>
       Sretr <span class="main">(</span>thetaZOCh <span class="free">ch</span> <span class="free">c1</span> <span class="free">c2</span> <span class="free">d1</span> <span class="free">d2</span> <span class="main">∪</span> ZObis<span class="main">)</span>"</span></span>
<span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?th</span> <span class="main">⊆</span> Sretr <span class="main">(</span><span class="var">?th</span> <span class="main">∪</span> ZObis<span class="main">)</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">unfolding</span></span> Sretr_def matchC_C_def <span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">c</span> <span class="skolem">d</span> <span class="skolem">s</span> <span class="skolem">t</span>
  <span class="keyword3"><span class="command">assume</span></span> c_d<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">c</span><span class="main">,</span> <span class="skolem">d</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?th</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> st<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">≈</span> <span class="skolem">t</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">=</span> Ch <span class="free">ch</span> <span class="free">c1</span> <span class="free">c2</span>"</span></span> <span class="quoted"><span class="quoted">"brn <span class="skolem">c</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> d<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">=</span> Ch <span class="free">ch</span> <span class="free">d1</span> <span class="free">d2</span>"</span></span> <span class="quoted"><span class="quoted">"brn <span class="skolem">d</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> thetaZOCh_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">{</span><span class="main">0</span><span class="main">}</span><span class="main">,</span> <span class="main">{</span><span class="main">1</span><span class="main">}</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?F</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">%</span><span class="bound">I</span><span class="main">.</span> <span class="bound">I</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">P</span> <span class="bound">F</span><span class="main">.</span> mC_C <span class="main">(</span><span class="var">?th</span> <span class="keyword1">Un</span> ZObis<span class="main">)</span> <span class="skolem">c</span> <span class="skolem">d</span> <span class="skolem">s</span> <span class="skolem">t</span> <span class="bound">P</span> <span class="bound">F</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?P</span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?F</span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> assms st c_d c <span class="keyword1"><span class="command">unfolding</span></span> m_defsAll thetaZOCh_def part_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Compositionality-thetaZOCh_ZOretr"><span class="command">lemma</span></span> thetaZOCh_ZOretr<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"compatCh <span class="free">ch</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">c1</span> <span class="main">≈01</span> <span class="free">d1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">c2</span> <span class="main">≈01</span> <span class="free">d2</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"thetaZOCh <span class="free">ch</span> <span class="free">c1</span> <span class="free">c2</span> <span class="free">d1</span> <span class="free">d2</span> <span class="main">⊆</span>
       ZOretr <span class="main">(</span>thetaZOCh <span class="free">ch</span> <span class="free">c1</span> <span class="free">c2</span> <span class="free">d1</span> <span class="free">d2</span> <span class="main">∪</span> ZObis<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> thetaZOCh_Sretr<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> Retr_incl subset_trans<span class="main">)</span>

<span class="keyword1" id="Compositionality-thetaZOCh_ZObis"><span class="command">lemma</span></span> thetaZOCh_ZObis<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"compatCh <span class="free">ch</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">c1</span> <span class="main">≈01</span> <span class="free">d1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">c2</span> <span class="main">≈01</span> <span class="free">d2</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"thetaZOCh <span class="free">ch</span> <span class="free">c1</span> <span class="free">c2</span> <span class="free">d1</span> <span class="free">d2</span> <span class="main">⊆</span> ZObis"</span></span>
<span class="keyword1"><span class="command">using</span></span> ZObis_coind thetaZOCh_ZOretr<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">theorem</span></span> Ch_siso_ZObis<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"compatCh <span class="free">ch</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">c1</span> <span class="main">≈01</span> <span class="free">d1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">c2</span> <span class="main">≈01</span> <span class="free">d2</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Ch <span class="free">ch</span> <span class="free">c1</span> <span class="free">c2</span> <span class="main">≈01</span> Ch <span class="free">ch</span> <span class="free">d1</span> <span class="free">d2</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> thetaZOCh_ZObis<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> thetaZOCh_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="comment1">(*  *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">theFTOne</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">theFTOne</span> <span class="free"><span class="bound"><span class="entity">cl</span></span></span> <span class="free"><span class="bound"><span class="entity">dl</span></span></span> <span class="main">≡</span> theFT <span class="free"><span class="bound"><span class="entity">cl</span></span></span> <span class="main">∪</span> theFT <span class="free"><span class="bound"><span class="entity">dl</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">theNFTBoth</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">theNFTBoth</span> <span class="free"><span class="bound"><span class="entity">cl</span></span></span> <span class="free"><span class="bound"><span class="entity">dl</span></span></span> <span class="main">≡</span> theNFT <span class="free"><span class="bound"><span class="entity">cl</span></span></span> <span class="main">∩</span> theNFT <span class="free"><span class="bound"><span class="entity">dl</span></span></span>"</span></span>

<span class="keyword1" id="Compositionality-theFTOne_sym"><span class="command">lemma</span></span> theFTOne_sym<span class="main">:</span> <span class="quoted"><span class="quoted">"theFTOne <span class="free">cl</span> <span class="free">dl</span> <span class="main">=</span> theFTOne <span class="free">dl</span> <span class="free">cl</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> theFTOne_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Compositionality-finite_theFTOne"><span class="command">lemma</span></span> finite_theFTOne<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="quoted"><span class="quoted">"finite <span class="main">(</span>theFTOne <span class="free">cl</span> <span class="free">dl</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> theFTOne_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Compositionality-theFTOne_length_finished"><span class="command">lemma</span></span> theFTOne_length_finished<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">∈</span> theFTOne <span class="free">cl</span> <span class="free">dl</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">n</span> <span class="main">&lt;</span> length <span class="free">cl</span> <span class="main">∧</span> finished <span class="main">(</span><span class="free">cl</span><span class="main">!</span><span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="free">n</span> <span class="main">&lt;</span> length <span class="free">dl</span> <span class="main">∧</span> finished <span class="main">(</span><span class="free">dl</span><span class="main">!</span><span class="free">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> theFTOne_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Compositionality-theFTOne_length"><span class="command">lemma</span></span> theFTOne_length<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"length <span class="free">cl</span> <span class="main">=</span> length <span class="free">dl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">∈</span> theFTOne <span class="free">cl</span> <span class="free">dl</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&lt;</span> length <span class="free">cl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&lt;</span> length <span class="free">dl</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms theFTOne_length_finished<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">cl</span></span> <span class="quoted"><span class="free">dl</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Compositionality-theFTOne_intro"><span class="command">lemma</span></span> theFTOne_intro<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">n</span><span class="main">.</span> <span class="main">(</span><span class="bound">n</span> <span class="main">&lt;</span> length <span class="free">cl</span> <span class="main">∧</span> finished <span class="main">(</span><span class="free">cl</span><span class="main">!</span><span class="bound">n</span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="bound">n</span> <span class="main">&lt;</span> length <span class="free">dl</span> <span class="main">∧</span> finished <span class="main">(</span><span class="free">dl</span><span class="main">!</span><span class="bound">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">∈</span> theFTOne <span class="free">cl</span> <span class="free">dl</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> theFTOne_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Compositionality-pickFT_theFTOne"><span class="command">lemma</span></span> pickFT_theFTOne<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"WtFT <span class="free">cl</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"pickFT <span class="free">cl</span> <span class="main">∈</span> theFTOne <span class="free">cl</span> <span class="free">dl</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> theFTOne_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Compositionality-finite_theNFTBoth"><span class="command">lemma</span></span> finite_theNFTBoth<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="quoted"><span class="quoted">"finite <span class="main">(</span>theNFTBoth <span class="free">cl</span> <span class="free">dl</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> theNFTBoth_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Compositionality-theNFTBoth_sym"><span class="command">lemma</span></span> theNFTBoth_sym<span class="main">:</span> <span class="quoted"><span class="quoted">"theNFTBoth <span class="free">cl</span> <span class="free">dl</span> <span class="main">=</span> theNFTBoth <span class="free">dl</span> <span class="free">cl</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> theNFTBoth_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Compositionality-theNFTBoth_length_finished"><span class="command">lemma</span></span> theNFTBoth_length_finished<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">∈</span> theNFTBoth <span class="free">cl</span> <span class="free">dl</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&lt;</span> length <span class="free">cl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> finished <span class="main">(</span><span class="free">cl</span><span class="main">!</span><span class="free">n</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&lt;</span> length <span class="free">dl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> finished <span class="main">(</span><span class="free">dl</span><span class="main">!</span><span class="free">n</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> theNFTBoth_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Compositionality-theNFTBoth_intro"><span class="command">lemma</span></span> theNFTBoth_intro<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> length <span class="free">cl</span> <span class="main">∧</span> <span class="main">¬</span> finished <span class="main">(</span><span class="free">cl</span><span class="main">!</span><span class="bound">n</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">n</span> <span class="main">&lt;</span> length <span class="free">dl</span> <span class="main">∧</span> <span class="main">¬</span> finished <span class="main">(</span><span class="free">dl</span><span class="main">!</span><span class="bound">n</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">∈</span> theNFTBoth <span class="free">cl</span> <span class="free">dl</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> theNFTBoth_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Compositionality-theFTOne_Int_theNFTBoth"><span class="command">lemma</span></span> theFTOne_Int_theNFTBoth<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="quoted"><span class="quoted">"theFTOne <span class="free">cl</span> <span class="free">dl</span> <span class="main">∩</span> theNFTBoth <span class="free">cl</span> <span class="free">dl</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"theNFTBoth <span class="free">cl</span> <span class="free">dl</span> <span class="main">∩</span> theFTOne <span class="free">cl</span> <span class="free">dl</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> theFTOne_def theNFTBoth_def theFT_def theNFT_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Compositionality-theFT_Un_theNFT_One_Both"><span class="command">lemma</span></span> theFT_Un_theNFT_One_Both<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"length <span class="free">cl</span> <span class="main">=</span> length <span class="free">dl</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span>
<span class="quoted"><span class="quoted">"theFTOne <span class="free">cl</span> <span class="free">dl</span> <span class="main">∪</span> theNFTBoth <span class="free">cl</span> <span class="free">dl</span> <span class="main">=</span> <span class="main">{..&lt;</span> length <span class="free">cl</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
<span class="quoted"><span class="quoted">"theNFTBoth <span class="free">cl</span> <span class="free">dl</span> <span class="main">∪</span> theFTOne <span class="free">cl</span> <span class="free">dl</span> <span class="main">=</span> <span class="main">{..&lt;</span> length <span class="free">cl</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">unfolding</span></span> theFTOne_def theNFTBoth_def theFT_def theNFT_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Compositionality-in_theFTOne_theNFTBoth"><span class="command">lemma</span></span> in_theFTOne_theNFTBoth<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">n1</span> <span class="main">∈</span> theFTOne <span class="free">cl</span> <span class="free">dl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">n2</span> <span class="main">∈</span> theNFTBoth <span class="free">cl</span> <span class="free">dl</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">n1</span> <span class="main">≠</span> <span class="free">n2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">n2</span> <span class="main">≠</span> <span class="free">n1</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms theFTOne_Int_theNFTBoth <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>


<span class="comment1">(*  *)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">BrnFT</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">BrnFT</span> <span class="free"><span class="bound"><span class="entity">cl</span></span></span> <span class="free"><span class="bound"><span class="entity">dl</span></span></span> <span class="main">≡</span> <span class="main">⋃</span> <span class="bound">n</span> <span class="main">∈</span> theFTOne <span class="free"><span class="bound"><span class="entity">cl</span></span></span> <span class="free"><span class="bound"><span class="entity">dl</span></span></span><span class="main">.</span> <span class="main">{</span>brnL <span class="free"><span class="bound"><span class="entity">cl</span></span></span> <span class="bound">n</span> <span class="main">..&lt;+</span> brn <span class="main">(</span><span class="free"><span class="bound"><span class="entity">cl</span></span></span><span class="main">!</span><span class="bound">n</span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">BrnNFT</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">BrnNFT</span> <span class="free"><span class="bound"><span class="entity">cl</span></span></span> <span class="free"><span class="bound"><span class="entity">dl</span></span></span> <span class="main">≡</span> <span class="main">⋃</span> <span class="bound">n</span> <span class="main">∈</span> theNFTBoth <span class="free"><span class="bound"><span class="entity">cl</span></span></span> <span class="free"><span class="bound"><span class="entity">dl</span></span></span><span class="main">.</span> <span class="main">{</span>brnL <span class="free"><span class="bound"><span class="entity">cl</span></span></span> <span class="bound">n</span> <span class="main">..&lt;+</span> brn <span class="main">(</span><span class="free"><span class="bound"><span class="entity">cl</span></span></span><span class="main">!</span><span class="bound">n</span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1" id="Compositionality-BrnFT_elim"><span class="command">lemma</span></span> BrnFT_elim<span class="main">[</span><span class="operator">elim</span><span class="main">,</span> <span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">case_names</span> Local<span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">ii</span> <span class="main">∈</span> BrnFT <span class="free">cl</span> <span class="free">dl</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">n</span> <span class="bound">i</span><span class="main">.</span> <span class="main">⟦</span><span class="bound">n</span> <span class="main">∈</span> theFTOne <span class="free">cl</span> <span class="free">dl</span><span class="main">;</span> <span class="bound">i</span> <span class="main">&lt;</span> brn <span class="main">(</span><span class="free">cl</span><span class="main">!</span><span class="bound">n</span><span class="main">)</span><span class="main">;</span> <span class="free">ii</span> <span class="main">=</span> brnL <span class="free">cl</span> <span class="bound">n</span> <span class="main">+</span> <span class="bound">i</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">phi</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="free">phi</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> BrnFT_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Compositionality-finite_BrnFT"><span class="command">lemma</span></span> finite_BrnFT<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="quoted"><span class="quoted">"finite <span class="main">(</span>BrnFT <span class="free">cl</span> <span class="free">dl</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> BrnFT_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Compositionality-BrnFT_incl_brnL"><span class="command">lemma</span></span> BrnFT_incl_brnL<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> l<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">cl</span> <span class="main">=</span> length <span class="free">dl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> cl<span class="main">:</span> <span class="quoted"><span class="quoted">"properL <span class="free">cl</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"BrnFT <span class="free">cl</span> <span class="free">dl</span> <span class="main">⊆</span> <span class="main">{..&lt;</span> brnL <span class="free">cl</span> <span class="main">(</span>length <span class="free">cl</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">⊆</span> <span class="var">?R</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">⊆</span> <span class="main">(</span><span class="main">⋃</span> <span class="bound">n</span><span class="main">&lt;</span>length <span class="free">cl</span><span class="main">.</span> <span class="main">{</span>brnL <span class="free">cl</span> <span class="bound">n</span><span class="main">..&lt;+</span>brn <span class="main">(</span><span class="free">cl</span> <span class="main">!</span> <span class="bound">n</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> l <span class="keyword1"><span class="command">unfolding</span></span> BrnFT_def theFTOne_def theFT_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="var">?R</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> cl brnL_UN <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Compositionality-BrnNFT_elim"><span class="command">lemma</span></span> BrnNFT_elim<span class="main">[</span><span class="operator">elim</span><span class="main">,</span> <span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">case_names</span> Local<span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">ii</span> <span class="main">∈</span> BrnNFT <span class="free">cl</span> <span class="free">dl</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">n</span> <span class="bound">i</span><span class="main">.</span> <span class="main">⟦</span><span class="bound">n</span> <span class="main">∈</span> theNFTBoth <span class="free">cl</span> <span class="free">dl</span><span class="main">;</span> <span class="bound">i</span> <span class="main">&lt;</span> brn <span class="main">(</span><span class="free">cl</span><span class="main">!</span><span class="bound">n</span><span class="main">)</span><span class="main">;</span> <span class="free">ii</span> <span class="main">=</span> brnL <span class="free">cl</span> <span class="bound">n</span> <span class="main">+</span> <span class="bound">i</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">phi</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="free">phi</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> BrnNFT_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Compositionality-finite_BrnNFT"><span class="command">lemma</span></span> finite_BrnNFT<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="quoted"><span class="quoted">"finite <span class="main">(</span>BrnNFT <span class="free">cl</span> <span class="free">dl</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> BrnNFT_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Compositionality-BrnNFT_incl_brnL"><span class="command">lemma</span></span> BrnNFT_incl_brnL<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> cl<span class="main">:</span> <span class="quoted"><span class="quoted">"properL <span class="free">cl</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"BrnNFT <span class="free">cl</span> <span class="free">dl</span> <span class="main">⊆</span> <span class="main">{..&lt;</span> brnL <span class="free">cl</span> <span class="main">(</span>length <span class="free">cl</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">⊆</span> <span class="var">?R</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">⊆</span> <span class="main">(</span><span class="main">⋃</span> <span class="bound">n</span><span class="main">&lt;</span>length <span class="free">cl</span><span class="main">.</span> <span class="main">{</span>brnL <span class="free">cl</span> <span class="bound">n</span><span class="main">..&lt;+</span>brn <span class="main">(</span><span class="free">cl</span> <span class="main">!</span> <span class="bound">n</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> BrnNFT_def theNFTBoth_def theNFT_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="var">?R</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> cl brnL_UN <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Compositionality-BrnFT_Int_BrnNFT"><span class="command">lemma</span></span> BrnFT_Int_BrnNFT<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> l<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">cl</span> <span class="main">=</span> length <span class="free">dl</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span>
<span class="quoted"><span class="quoted">"BrnFT <span class="free">cl</span> <span class="free">dl</span> <span class="main">∩</span> BrnNFT <span class="free">cl</span> <span class="free">dl</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span>"</span></span><span class="main">)</span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"BrnNFT <span class="free">cl</span> <span class="free">dl</span> <span class="main">∩</span> BrnFT <span class="free">cl</span> <span class="free">dl</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?R</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ii</span> <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ii</span> <span class="main">∈</span> BrnFT <span class="free">cl</span> <span class="free">dl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ii</span> <span class="main">∈</span> BrnNFT <span class="free">cl</span> <span class="free">dl</span>"</span></span>
   <span class="keyword1"><span class="command">from</span></span> 1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span>
   <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> BrnFT_elim<span class="main">)</span>
     <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Local <span class="skolem">n1</span> <span class="skolem">i1</span><span class="main">)</span>
     <span class="keyword1"><span class="command">hence</span></span> n1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n1</span> <span class="main">&lt;</span> length <span class="free">cl</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n1</span> <span class="main">&lt;</span> length <span class="free">dl</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n1</span> <span class="main">∈</span> theFTOne <span class="free">cl</span> <span class="free">dl</span>"</span></span>
     <span class="keyword2"><span class="keyword">and</span></span> i1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i1</span> <span class="main">&lt;</span> brn <span class="main">(</span><span class="free">cl</span> <span class="main">!</span> <span class="skolem">n1</span><span class="main">)</span>"</span></span>
     <span class="keyword2"><span class="keyword">and</span></span> ii1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ii</span> <span class="main">=</span> brnL <span class="free">cl</span> <span class="skolem">n1</span> <span class="main">+</span> <span class="skolem">i1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> l <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
     <span class="keyword1"><span class="command">from</span></span> 2 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
     <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> BrnNFT_elim<span class="main">)</span>
       <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Local <span class="skolem">n2</span> <span class="skolem">i2</span><span class="main">)</span>
       <span class="keyword1"><span class="command">hence</span></span> n2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n2</span> <span class="main">∈</span> theNFTBoth <span class="free">cl</span> <span class="free">dl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> i2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i2</span> <span class="main">&lt;</span> brn <span class="main">(</span><span class="free">cl</span> <span class="main">!</span> <span class="skolem">n2</span><span class="main">)</span>"</span></span>
       <span class="keyword2"><span class="keyword">and</span></span> ii2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ii</span> <span class="main">=</span> brnL <span class="free">cl</span> <span class="skolem">n2</span> <span class="main">+</span> <span class="skolem">i2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
       <span class="keyword1"><span class="command">have</span></span> n12<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n1</span> <span class="main">≠</span> <span class="skolem">n2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> n1 n2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
       <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
       <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">n1</span> <span class="main">&lt;</span> <span class="skolem">n2</span>"</span></span><span class="main">)</span>
         <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">hence</span></span> Suc<span class="main">:</span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">n1</span> <span class="main">≤</span> <span class="skolem">n2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
         <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ii</span> <span class="main">&lt;</span> brnL <span class="free">cl</span> <span class="main">(</span>Suc <span class="skolem">n1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> ii1 <span class="keyword1"><span class="command">using</span></span> i1 n1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
         <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> brnL <span class="free">cl</span> <span class="skolem">n2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
         <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> <span class="skolem">ii</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> ii2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
         <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
       <span class="keyword1"><span class="command">next</span></span>
         <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">hence</span></span> Suc<span class="main">:</span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">n2</span> <span class="main">≤</span> <span class="skolem">n1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> n12 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
         <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ii</span> <span class="main">&lt;</span> brnL <span class="free">cl</span> <span class="main">(</span>Suc <span class="skolem">n2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> ii2 <span class="keyword1"><span class="command">using</span></span> i2 n2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
         <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> brnL <span class="free">cl</span> <span class="skolem">n1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
         <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> <span class="skolem">ii</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> ii1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
         <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
       <span class="keyword1"><span class="command">qed</span></span>
     <span class="keyword1"><span class="command">qed</span></span>
   <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?L</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?R</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Compositionality-BrnFT_Un_BrnNFT"><span class="command">lemma</span></span> BrnFT_Un_BrnNFT<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> l<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">cl</span> <span class="main">=</span> length <span class="free">dl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> cl<span class="main">:</span> <span class="quoted"><span class="quoted">"properL <span class="free">cl</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"BrnFT <span class="free">cl</span> <span class="free">dl</span> <span class="main">∪</span> BrnNFT <span class="free">cl</span> <span class="free">dl</span> <span class="main">=</span> <span class="main">{..&lt;</span> brnL <span class="free">cl</span> <span class="main">(</span>length <span class="free">cl</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L1</span> <span class="main">=</span> <span class="var">?R</span>"</span></span><span class="main">)</span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"BrnNFT <span class="free">cl</span> <span class="free">dl</span> <span class="main">∪</span> BrnFT <span class="free">cl</span> <span class="free">dl</span> <span class="main">=</span> <span class="main">{..&lt;</span> brnL <span class="free">cl</span> <span class="main">(</span>length <span class="free">cl</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L2</span> <span class="main">=</span> <span class="var">?R</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> R<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?R</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span> <span class="bound">n</span><span class="main">&lt;</span>length <span class="free">cl</span><span class="main">.</span> <span class="main">{</span>brnL <span class="free">cl</span> <span class="bound">n</span><span class="main">..&lt;+</span>brn <span class="main">(</span><span class="free">cl</span> <span class="main">!</span> <span class="bound">n</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> cl brnL_UN <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L1</span> <span class="main">=</span> <span class="var">?R</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> R
  <span class="keyword1"><span class="command">unfolding</span></span> l BrnFT_def BrnNFT_def
  theFTOne_def theNFTBoth_def theFT_def theNFT_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L2</span> <span class="main">=</span> <span class="var">?R</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Compositionality-BrnFT_part"><span class="command">lemma</span></span> BrnFT_part<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> l<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">cl</span> <span class="main">=</span> length <span class="free">dl</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> P<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> length <span class="free">cl</span> <span class="main">⟹</span> part <span class="main">{..&lt;</span> brn <span class="main">(</span><span class="free">cl</span><span class="main">!</span><span class="bound">n</span><span class="main">)</span><span class="main">}</span> <span class="main">(</span><span class="free">P</span> <span class="bound">n</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"BrnFT <span class="free">cl</span> <span class="free">dl</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span> <span class="bound">n</span> <span class="main">∈</span> theFTOne <span class="free">cl</span> <span class="free">dl</span><span class="main">.</span> Union <span class="main">(</span>shift <span class="free">cl</span> <span class="bound">n</span> <span class="main">`</span> <span class="main">(</span><span class="free">P</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">=</span> <span class="var">?R</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">safe</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> BrnFT_elim<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">n</span> <span class="skolem">i</span> <span class="keyword3"><span class="command">assume</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">∈</span> theFTOne <span class="free">cl</span> <span class="free">dl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> brn <span class="main">(</span><span class="free">cl</span> <span class="main">!</span> <span class="skolem">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">&lt;</span> length <span class="free">cl</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">&lt;</span> length <span class="free">dl</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> l <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command">note</span></span> n <span class="main">=</span> this n
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> Union <span class="main">(</span><span class="free">P</span> <span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> P i <span class="keyword1"><span class="command">unfolding</span></span> part_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">I</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="skolem">I</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">I</span> <span class="main">∈</span> <span class="free">P</span> <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"brnL <span class="free">cl</span> <span class="skolem">n</span> <span class="main">+</span> <span class="skolem">i</span> <span class="main">∈</span> <span class="var">?R</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> n <span class="keyword1"><span class="command">unfolding</span></span> shift_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span> <span class="skolem">ii</span> <span class="skolem">I</span> <span class="keyword3"><span class="command">assume</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">∈</span> theFTOne <span class="free">cl</span> <span class="free">dl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ii<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ii</span> <span class="main">∈</span> shift <span class="free">cl</span> <span class="skolem">n</span> <span class="skolem">I</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">I</span> <span class="main">∈</span> <span class="free">P</span> <span class="skolem">n</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">&lt;</span> length <span class="free">cl</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> l <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">I</span> <span class="main">⊆</span> <span class="main">{..&lt;</span> brn <span class="main">(</span><span class="free">cl</span> <span class="main">!</span> <span class="skolem">n</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> I P <span class="keyword1"><span class="command">unfolding</span></span> part_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ii</span> <span class="main">∈</span> <span class="main">{</span>brnL <span class="free">cl</span> <span class="skolem">n</span><span class="main">..&lt;+</span>brn <span class="main">(</span><span class="free">cl</span> <span class="main">!</span> <span class="skolem">n</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ii <span class="keyword1"><span class="command">unfolding</span></span> shift_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ii</span> <span class="main">∈</span> <span class="var">?L</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> n <span class="keyword1"><span class="command">unfolding</span></span> BrnFT_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Compositionality-brnL_pickFT_BrnFT"><span class="command">lemma</span></span> brnL_pickFT_BrnFT<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"properL <span class="free">cl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"WtFT <span class="free">cl</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"brnL <span class="free">cl</span> <span class="main">(</span>pickFT <span class="free">cl</span><span class="main">)</span> <span class="main">∈</span> BrnFT <span class="free">cl</span> <span class="free">dl</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms brn_gt_0_L <span class="keyword1"><span class="command">unfolding</span></span> BrnFT_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Compositionality-WtFT_ParT_BrnFT"><span class="command">lemma</span></span> WtFT_ParT_BrnFT<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"length <span class="free">cl</span> <span class="main">=</span> length <span class="free">dl</span>"</span></span> <span class="quoted"><span class="quoted">"properL <span class="free">cl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"WtFT <span class="free">cl</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sum <span class="main">(</span>wt <span class="main">(</span>ParT <span class="free">cl</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span> <span class="main">(</span>BrnFT <span class="free">cl</span> <span class="free">dl</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"brnL <span class="free">cl</span> <span class="main">(</span>pickFT <span class="free">cl</span><span class="main">)</span> <span class="main">∈</span> BrnFT <span class="free">cl</span> <span class="free">dl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  <span class="quoted"><span class="quoted">"BrnFT <span class="free">cl</span> <span class="free">dl</span> <span class="main">⊆</span> <span class="main">{..&lt;</span>brnL <span class="free">cl</span> <span class="main">(</span>length <span class="free">cl</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms BrnFT_incl_brnL <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(*  *)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">UNpart1</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">UNpart1</span> <span class="free"><span class="bound"><span class="entity">cl</span></span></span> <span class="free"><span class="bound"><span class="entity">dl</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">≡</span> <span class="main">⋃</span> <span class="bound">n</span> <span class="main">∈</span> theNFTBoth <span class="free"><span class="bound"><span class="entity">cl</span></span></span> <span class="free"><span class="bound"><span class="entity">dl</span></span></span><span class="main">.</span> shift <span class="free"><span class="bound"><span class="entity">cl</span></span></span> <span class="bound">n</span> <span class="main">`</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">n</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">UNpart01</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">UNpart01</span> <span class="free"><span class="bound"><span class="entity">cl</span></span></span> <span class="free"><span class="bound"><span class="entity">dl</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">≡</span> <span class="main">{</span>BrnFT <span class="free"><span class="bound"><span class="entity">cl</span></span></span> <span class="free"><span class="bound"><span class="entity">dl</span></span></span><span class="main">}</span> <span class="main">∪</span> UNpart1 <span class="free"><span class="bound"><span class="entity">cl</span></span></span> <span class="free"><span class="bound"><span class="entity">dl</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span>"</span></span>

<span class="keyword1" id="Compositionality-BrnFT_UNpart01"><span class="command">lemma</span></span> BrnFT_UNpart01<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="quoted"><span class="quoted">"BrnFT <span class="free">cl</span> <span class="free">dl</span> <span class="main">∈</span> UNpart01 <span class="free">cl</span> <span class="free">dl</span> <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> UNpart01_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Compositionality-UNpart1_cases"><span class="command">lemma</span></span> UNpart1_cases<span class="main">[</span><span class="operator">elim</span><span class="main">,</span> <span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">case_names</span> Local<span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">II</span> <span class="main">∈</span> UNpart1 <span class="free">cl</span> <span class="free">dl</span> <span class="free">P</span>"</span></span>
<span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">n</span> <span class="bound">I</span><span class="main">.</span> <span class="main">⟦</span><span class="bound">n</span> <span class="main">∈</span> theNFTBoth <span class="free">cl</span> <span class="free">dl</span><span class="main">;</span> <span class="bound">I</span> <span class="main">∈</span> <span class="free">P</span> <span class="bound">n</span><span class="main">;</span> <span class="free">II</span> <span class="main">=</span> shift <span class="free">cl</span> <span class="bound">n</span> <span class="bound">I</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">phi</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="free">phi</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> UNpart1_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Compositionality-UNpart01_cases"><span class="command">lemma</span></span> UNpart01_cases<span class="main">[</span><span class="operator">elim</span><span class="main">,</span> <span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">case_names</span> Local0 Local<span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">II</span> <span class="main">∈</span> UNpart01 <span class="free">cl</span> <span class="free">dl</span> <span class="free">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">II</span> <span class="main">=</span> BrnFT <span class="free">cl</span> <span class="free">dl</span> <span class="main">⟹</span> <span class="free">phi</span>"</span></span>
<span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">n</span> <span class="bound">I</span><span class="main">.</span> <span class="main">⟦</span><span class="bound">n</span> <span class="main">∈</span> theNFTBoth <span class="free">cl</span> <span class="free">dl</span><span class="main">;</span> <span class="bound">I</span> <span class="main">∈</span> <span class="free">P</span> <span class="bound">n</span><span class="main">;</span> <span class="free">II</span> <span class="main">=</span> shift <span class="free">cl</span> <span class="bound">n</span> <span class="bound">I</span><span class="main">;</span> <span class="free">II</span> <span class="main">∈</span> UNpart1 <span class="free">cl</span> <span class="free">dl</span> <span class="free">P</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">phi</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="free">phi</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> UNpart01_def UNpart1_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Compositionality-emp_UNpart1"><span class="command">lemma</span></span> emp_UNpart1<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> length <span class="free">cl</span> <span class="main">⟹</span> <span class="main">{}</span> <span class="main">∉</span> <span class="free">P</span> <span class="bound">n</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">{}</span> <span class="main">∉</span> UNpart1 <span class="free">cl</span> <span class="free">dl</span> <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> UNpart1_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Compositionality-emp_UNpart01"><span class="command">lemma</span></span> emp_UNpart01<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> length <span class="free">cl</span> <span class="main">⟹</span> <span class="main">{}</span> <span class="main">∉</span> <span class="free">P</span> <span class="bound">n</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">{}</span> <span class="main">∉</span> UNpart01 <span class="free">cl</span> <span class="free">dl</span> <span class="free">P</span> <span class="main">-</span> <span class="main">{</span>BrnFT <span class="free">cl</span> <span class="free">dl</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms emp_UNpart1 <span class="keyword1"><span class="command">unfolding</span></span> UNpart01_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Compositionality-BrnFT_Int_UNpart1"><span class="command">lemma</span></span> BrnFT_Int_UNpart1<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> l<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">cl</span> <span class="main">=</span> length <span class="free">dl</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> P<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> length <span class="free">cl</span> <span class="main">⟹</span> part <span class="main">{..&lt;</span> brn <span class="main">(</span><span class="free">cl</span><span class="main">!</span><span class="bound">n</span><span class="main">)</span><span class="main">}</span> <span class="main">(</span><span class="free">P</span> <span class="bound">n</span><span class="main">)</span> <span class="main">∧</span> <span class="main">{}</span> <span class="main">∉</span> <span class="free">P</span> <span class="bound">n</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> II<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">II</span> <span class="main">∈</span> UNpart1 <span class="free">cl</span> <span class="free">dl</span> <span class="free">P</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"BrnFT <span class="free">cl</span> <span class="free">dl</span> <span class="main">∩</span> <span class="free">II</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> II <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> UNpart1_cases<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"BrnFT <span class="free">cl</span> <span class="free">dl</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span> <span class="bound">n</span> <span class="main">∈</span> theFTOne <span class="free">cl</span> <span class="free">dl</span><span class="main">.</span> Union <span class="main">(</span>shift <span class="free">cl</span> <span class="bound">n</span> <span class="main">`</span> <span class="main">(</span><span class="free">P</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> BrnFT_part<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> l P <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Local <span class="skolem">n</span> <span class="skolem">I</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">&lt;</span> length <span class="free">cl</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">&lt;</span> length <span class="free">dl</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">∈</span> theNFTBoth <span class="free">cl</span> <span class="free">dl</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">I</span> <span class="main">∈</span> <span class="free">P</span> <span class="skolem">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> II<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">II</span> <span class="main">=</span> shift <span class="free">cl</span> <span class="skolem">n</span> <span class="skolem">I</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n0</span> <span class="keyword3"><span class="command">assume</span></span> n0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n0</span> <span class="main">∈</span> theFTOne <span class="free">cl</span> <span class="free">dl</span>"</span></span>
   <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n0</span> <span class="main">&lt;</span> length <span class="free">cl</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n0</span> <span class="main">&lt;</span> length <span class="free">dl</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> l <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command">note</span></span> n0 <span class="main">=</span> this n0
   <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">fix</span></span> <span class="skolem">JJ</span> <span class="keyword3"><span class="command">assume</span></span>  <span class="quoted"><span class="quoted">"<span class="skolem">JJ</span> <span class="main">∈</span> shift <span class="free">cl</span> <span class="skolem">n0</span> <span class="main">`</span> <span class="main">(</span><span class="free">P</span> <span class="skolem">n0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">J</span></span> <span class="keyword2"><span class="keyword">where</span></span> J<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">J</span> <span class="main">∈</span> <span class="free">P</span> <span class="skolem">n0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> JJ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">JJ</span> <span class="main">=</span> shift <span class="free">cl</span> <span class="skolem">n0</span> <span class="skolem">J</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">≠</span> <span class="skolem">n0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> n n0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">JJ</span> <span class="keyword1">Int</span> <span class="free">II</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> JJ II
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> part_brn_disj3<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> P I J n n0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
   <span class="keyword1"><span class="command">}</span></span>
   <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Union <span class="main">(</span>shift <span class="free">cl</span> <span class="skolem">n0</span> <span class="main">`</span> <span class="main">(</span><span class="free">P</span> <span class="skolem">n0</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">Int</span> <span class="free">II</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> II 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Compositionality-BrnFT_notIn_UNpart1"><span class="command">lemma</span></span> BrnFT_notIn_UNpart1<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> l<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">cl</span> <span class="main">=</span> length <span class="free">dl</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> P<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> length <span class="free">cl</span> <span class="main">⟹</span> part <span class="main">{..&lt;</span> brn <span class="main">(</span><span class="free">cl</span><span class="main">!</span><span class="bound">n</span><span class="main">)</span><span class="main">}</span> <span class="main">(</span><span class="free">P</span> <span class="bound">n</span><span class="main">)</span> <span class="main">∧</span> <span class="main">{}</span> <span class="main">∉</span> <span class="free">P</span> <span class="bound">n</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"BrnFT <span class="free">cl</span> <span class="free">dl</span> <span class="main">∉</span> UNpart1 <span class="free">cl</span> <span class="free">dl</span> <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms BrnFT_Int_UNpart1 emp_UNpart1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Int_absorb<span class="main">)</span>

<span class="keyword1" id="Compositionality-UNpart1_UNpart01"><span class="command">lemma</span></span> UNpart1_UNpart01<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> l<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">cl</span> <span class="main">=</span> length <span class="free">dl</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> P<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> length <span class="free">cl</span> <span class="main">⟹</span> part <span class="main">{..&lt;</span> brn <span class="main">(</span><span class="free">cl</span><span class="main">!</span><span class="bound">n</span><span class="main">)</span><span class="main">}</span> <span class="main">(</span><span class="free">P</span> <span class="bound">n</span><span class="main">)</span> <span class="main">∧</span> <span class="main">{}</span> <span class="main">∉</span> <span class="free">P</span> <span class="bound">n</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"UNpart1 <span class="free">cl</span> <span class="free">dl</span> <span class="free">P</span> <span class="main">=</span> UNpart01 <span class="free">cl</span> <span class="free">dl</span> <span class="free">P</span> <span class="main">-</span> <span class="main">{</span>BrnFT <span class="free">cl</span> <span class="free">dl</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"BrnFT <span class="free">cl</span> <span class="free">dl</span> <span class="main">∉</span> UNpart1 <span class="free">cl</span> <span class="free">dl</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> BrnFT_notIn_UNpart1<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> UNpart01_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Compositionality-part_UNpart1"><span class="command">lemma</span></span> part_UNpart1<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> l<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">cl</span> <span class="main">=</span> length <span class="free">dl</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> P<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> length <span class="free">cl</span> <span class="main">⟹</span> part <span class="main">{..&lt;</span> brn <span class="main">(</span><span class="free">cl</span><span class="main">!</span><span class="bound">n</span><span class="main">)</span><span class="main">}</span> <span class="main">(</span><span class="free">P</span> <span class="bound">n</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"part <span class="main">(</span>BrnNFT <span class="free">cl</span> <span class="free">dl</span><span class="main">)</span> <span class="main">(</span>UNpart1 <span class="free">cl</span> <span class="free">dl</span> <span class="free">P</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> BrnNFT_def UNpart1_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> part_UN<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> l P <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> brnL_Int<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> l <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Compositionality-part_UNpart01"><span class="command">lemma</span></span> part_UNpart01<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> cl<span class="main">:</span> <span class="quoted"><span class="quoted">"properL <span class="free">cl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> l<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">cl</span> <span class="main">=</span> length <span class="free">dl</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> P<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> length <span class="free">cl</span> <span class="main">⟹</span> part <span class="main">{..&lt;</span> brn <span class="main">(</span><span class="free">cl</span><span class="main">!</span><span class="bound">n</span><span class="main">)</span><span class="main">}</span> <span class="main">(</span><span class="free">P</span> <span class="bound">n</span><span class="main">)</span> <span class="main">∧</span> <span class="main">{}</span> <span class="main">∉</span> <span class="free">P</span> <span class="bound">n</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"part <span class="main">{..&lt;</span> brnL <span class="free">cl</span> <span class="main">(</span>length <span class="free">cl</span><span class="main">)</span><span class="main">}</span> <span class="main">(</span>UNpart01 <span class="free">cl</span> <span class="free">dl</span> <span class="free">P</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> UNpart01_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> part_Un_singl2<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"BrnNFT <span class="free"><span class="free">cl</span></span> <span class="free"><span class="free">dl</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">using</span></span> BrnFT_Int_UNpart1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>

<span class="comment1">(*  *)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">UNlift01</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">UNlift01</span> <span class="free"><span class="bound"><span class="entity">cl</span></span></span> <span class="free"><span class="bound"><span class="entity">dl</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">II</span></span></span> <span class="main">≡</span>
 <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">II</span></span></span> <span class="main">=</span> BrnFT <span class="free"><span class="bound"><span class="entity">cl</span></span></span> <span class="free"><span class="bound"><span class="entity">dl</span></span></span>
   <span class="keyword1">then</span> BrnFT <span class="free"><span class="bound"><span class="entity">dl</span></span></span> <span class="free"><span class="bound"><span class="entity">cl</span></span></span>
   <span class="keyword1">else</span> shift <span class="free"><span class="bound"><span class="entity">dl</span></span></span> <span class="main">(</span>pickT <span class="free"><span class="bound"><span class="entity">cl</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">II</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="main">(</span>pickT <span class="free"><span class="bound"><span class="entity">cl</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">II</span></span></span><span class="main">)</span> <span class="main">(</span>back <span class="free"><span class="bound"><span class="entity">cl</span></span></span> <span class="main">(</span>pickT <span class="free"><span class="bound"><span class="entity">cl</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">II</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">II</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Compositionality-UNlift01_BrnFT"><span class="command">lemma</span></span> UNlift01_BrnFT<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="quoted"><span class="quoted">"UNlift01 <span class="free">cl</span> <span class="free">dl</span> <span class="free">P</span> <span class="free">F</span> <span class="main">(</span>BrnFT <span class="free">cl</span> <span class="free">dl</span><span class="main">)</span> <span class="main">=</span> BrnFT <span class="free">dl</span> <span class="free">cl</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> UNlift01_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Compositionality-UNlift01_shift"><span class="command">lemma</span></span> UNlift01_shift<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> l<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">cl</span> <span class="main">=</span> length <span class="free">dl</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> P<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> length <span class="free">cl</span> <span class="main">⟹</span> part <span class="main">{..&lt;</span> brn <span class="main">(</span><span class="free">cl</span><span class="main">!</span><span class="bound">n</span><span class="main">)</span><span class="main">}</span> <span class="main">(</span><span class="free">P</span> <span class="bound">n</span><span class="main">)</span> <span class="main">∧</span> <span class="main">{}</span> <span class="main">∉</span> <span class="free">P</span> <span class="bound">n</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">∈</span> theNFTBoth <span class="free">cl</span> <span class="free">dl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">∈</span> <span class="free">P</span> <span class="free">n</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"UNlift01 <span class="free">cl</span> <span class="free">dl</span> <span class="free">P</span> <span class="free">F</span> <span class="main">(</span>shift <span class="free">cl</span> <span class="free">n</span> <span class="free">I</span><span class="main">)</span> <span class="main">=</span> shift <span class="free">dl</span> <span class="free">n</span> <span class="main">(</span><span class="free">F</span> <span class="free">n</span> <span class="free">I</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?N</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"length <span class="free">cl</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">II</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">II</span> <span class="main">=</span> shift <span class="free">cl</span> <span class="free">n</span> <span class="free">I</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&lt;</span> length <span class="free">cl</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> n l <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command">note</span></span> n <span class="main">=</span> this n
  <span class="keyword1"><span class="command">have</span></span> II<span class="main">:</span> <span class="quoted"><span class="quoted">"shift <span class="free">cl</span> <span class="free">n</span> <span class="free">I</span> <span class="main">=</span> <span class="skolem">II</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> II_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">II</span> <span class="main">∈</span> UNpart1 <span class="free">cl</span> <span class="free">dl</span> <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> II_def UNpart1_def <span class="keyword1"><span class="command">using</span></span> n I <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">II</span> <span class="main">≠</span> BrnFT <span class="free">cl</span> <span class="free">dl</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> BrnFT_notIn_UNpart1<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">cl</span></span> <span class="quoted"><span class="free">dl</span></span> <span class="quoted"><span class="free">P</span></span><span class="main">]</span> l n P <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"UNlift01 <span class="free">cl</span> <span class="free">dl</span> <span class="free">P</span> <span class="free">F</span> <span class="skolem">II</span> <span class="main">=</span>
  shift <span class="free">dl</span> <span class="main">(</span>pickT <span class="free">cl</span> <span class="free">P</span> <span class="skolem">II</span><span class="main">)</span> <span class="main">(</span><span class="free">F</span> <span class="main">(</span>pickT <span class="free">cl</span> <span class="free">P</span> <span class="skolem">II</span><span class="main">)</span> <span class="main">(</span>back <span class="free">cl</span> <span class="main">(</span>pickT <span class="free">cl</span> <span class="free">P</span> <span class="skolem">II</span><span class="main">)</span> <span class="skolem">II</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> UNlift01_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> pickT <span class="free">cl</span> <span class="free">P</span> <span class="skolem">II</span>"</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> pickT_unique<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> II_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"back <span class="free">cl</span> <span class="free">n</span> <span class="skolem">II</span> <span class="main">=</span> <span class="free">I</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> II_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"shift <span class="free">dl</span> <span class="free">n</span> <span class="main">(</span><span class="free">F</span> <span class="free">n</span> <span class="main">(</span>back <span class="free">cl</span> <span class="free">n</span> <span class="skolem">II</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> shift <span class="free">dl</span> <span class="free">n</span> <span class="main">(</span><span class="free">F</span> <span class="free">n</span> <span class="free">I</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> 1 II n<span class="main">[</span><span class="operator">THEN</span> sym<span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Compositionality-UNlift01_inj_on_UNpart1"><span class="command">lemma</span></span> UNlift01_inj_on_UNpart1<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> l<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">cl</span> <span class="main">=</span> length <span class="free">dl</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> P<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> length <span class="free">cl</span> <span class="main">⟹</span> part <span class="main">{..&lt;</span> brn <span class="main">(</span><span class="free">cl</span><span class="main">!</span><span class="bound">n</span><span class="main">)</span><span class="main">}</span> <span class="main">(</span><span class="free">P</span> <span class="bound">n</span><span class="main">)</span> <span class="main">∧</span> <span class="main">{}</span> <span class="main">∉</span> <span class="free">P</span> <span class="bound">n</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> FP<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> length <span class="free">dl</span> <span class="main">⟹</span> part <span class="main">{..&lt;</span> brn <span class="main">(</span><span class="free">dl</span><span class="main">!</span><span class="bound">n</span><span class="main">)</span><span class="main">}</span> <span class="main">(</span><span class="free">F</span> <span class="bound">n</span> <span class="main">`</span> <span class="main">(</span><span class="free">P</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="main">{}</span> <span class="main">∉</span> <span class="free">F</span> <span class="bound">n</span> <span class="main">`</span> <span class="main">(</span><span class="free">P</span> <span class="bound">n</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> F<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> length <span class="free">cl</span> <span class="main">⟹</span> inj_on <span class="main">(</span><span class="free">F</span> <span class="bound">n</span><span class="main">)</span> <span class="main">(</span><span class="free">P</span> <span class="bound">n</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="main">(</span>UNlift01 <span class="free">cl</span> <span class="free">dl</span> <span class="free">P</span> <span class="free">F</span><span class="main">)</span> <span class="main">(</span>UNpart1 <span class="free">cl</span> <span class="free">dl</span> <span class="free">P</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="var">?G</span> <span class="var">?Q</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">unfolding</span></span> inj_on_def <span class="keyword1"><span class="command">proof</span></span> <span class="operator">clarify</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">II1</span> <span class="skolem">II2</span>
  <span class="keyword3"><span class="command">assume</span></span> II1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">II1</span> <span class="main">∈</span> <span class="var">?Q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> II2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">II2</span> <span class="main">∈</span> <span class="var">?Q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> G<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?G</span> <span class="skolem">II1</span> <span class="main">=</span> <span class="var">?G</span> <span class="skolem">II2</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> II1 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">II1</span> <span class="main">=</span> <span class="skolem">II2</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> UNpart1_cases<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Local <span class="skolem">n1</span> <span class="skolem">I1</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> n1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n1</span> <span class="main">∈</span> theNFTBoth <span class="free">cl</span> <span class="free">dl</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n1</span> <span class="main">&lt;</span> length <span class="free">cl</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n1</span> <span class="main">&lt;</span> length <span class="free">dl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> I1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">I1</span> <span class="main">∈</span> <span class="free">P</span> <span class="skolem">n1</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> II1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">II1</span> <span class="main">=</span> shift <span class="free">cl</span> <span class="skolem">n1</span> <span class="skolem">I1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> l <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> G1_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?G</span> <span class="skolem">II1</span> <span class="main">=</span> shift <span class="free">dl</span> <span class="skolem">n1</span> <span class="main">(</span><span class="free">F</span> <span class="skolem">n1</span> <span class="skolem">I1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> l P <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> Pn1<span class="main">:</span> <span class="quoted"><span class="quoted">"part <span class="main">{..&lt;</span> brn <span class="main">(</span><span class="free">dl</span><span class="main">!</span><span class="skolem">n1</span><span class="main">)</span><span class="main">}</span> <span class="main">(</span><span class="free">F</span> <span class="skolem">n1</span> <span class="main">`</span> <span class="main">(</span><span class="free">P</span> <span class="skolem">n1</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">{}</span> <span class="main">∉</span> <span class="free">F</span> <span class="skolem">n1</span> <span class="main">`</span> <span class="main">(</span><span class="free">P</span> <span class="skolem">n1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> n1 FP <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> F1_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">F</span> <span class="skolem">n1</span> <span class="skolem">I1</span> <span class="main">∈</span> <span class="free">F</span> <span class="skolem">n1</span> <span class="main">`</span> <span class="main">(</span><span class="free">P</span> <span class="skolem">n1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> I1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> Fn1I1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">F</span> <span class="skolem">n1</span> <span class="skolem">I1</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">F</span> <span class="skolem">n1</span> <span class="skolem">I1</span> <span class="main">⊆</span> <span class="main">{..&lt;</span> brn <span class="main">(</span><span class="free">dl</span><span class="main">!</span><span class="skolem">n1</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Pn1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> part_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> G1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?G</span> <span class="skolem">II1</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?G</span> <span class="skolem">II1</span> <span class="main">⊆</span> <span class="main">{</span>brnL <span class="free">dl</span> <span class="skolem">n1</span> <span class="main">..&lt;+</span> brn <span class="main">(</span><span class="free">dl</span><span class="main">!</span><span class="skolem">n1</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> G1_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command">from</span></span> II2 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> UNpart1_cases<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Local <span class="skolem">n2</span> <span class="skolem">I2</span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> n2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n2</span> <span class="main">∈</span> theNFTBoth <span class="free">cl</span> <span class="free">dl</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n2</span> <span class="main">&lt;</span> length <span class="free">cl</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n2</span> <span class="main">&lt;</span> length <span class="free">dl</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> I2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">I2</span> <span class="main">∈</span> <span class="free">P</span> <span class="skolem">n2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> II2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">II2</span> <span class="main">=</span> shift <span class="free">cl</span> <span class="skolem">n2</span> <span class="skolem">I2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> l <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> G2_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?G</span> <span class="skolem">II2</span> <span class="main">=</span> shift <span class="free">dl</span> <span class="skolem">n2</span> <span class="main">(</span><span class="free">F</span> <span class="skolem">n2</span> <span class="skolem">I2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> l P <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> Pn2<span class="main">:</span> <span class="quoted"><span class="quoted">"part <span class="main">{..&lt;</span> brn <span class="main">(</span><span class="free">dl</span><span class="main">!</span><span class="skolem">n2</span><span class="main">)</span><span class="main">}</span> <span class="main">(</span><span class="free">F</span> <span class="skolem">n2</span> <span class="main">`</span> <span class="main">(</span><span class="free">P</span> <span class="skolem">n2</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">{}</span> <span class="main">∉</span> <span class="free">F</span> <span class="skolem">n2</span> <span class="main">`</span> <span class="main">(</span><span class="free">P</span> <span class="skolem">n2</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> n2 FP <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> F2_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">F</span> <span class="skolem">n2</span> <span class="skolem">I2</span> <span class="main">∈</span> <span class="free">F</span> <span class="skolem">n2</span> <span class="main">`</span> <span class="main">(</span><span class="free">P</span> <span class="skolem">n2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> I2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">hence</span></span> Fn2I2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">F</span> <span class="skolem">n2</span> <span class="skolem">I2</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">F</span> <span class="skolem">n2</span> <span class="skolem">I2</span> <span class="main">⊆</span> <span class="main">{..&lt;</span> brn <span class="main">(</span><span class="free">dl</span><span class="main">!</span><span class="skolem">n2</span><span class="main">)</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Pn2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> part_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> G2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?G</span> <span class="skolem">II2</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?G</span> <span class="skolem">II2</span> <span class="main">⊆</span> <span class="main">{</span>brnL <span class="free">dl</span> <span class="skolem">n2</span> <span class="main">..&lt;+</span> brn <span class="main">(</span><span class="free">dl</span><span class="main">!</span><span class="skolem">n2</span><span class="main">)</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> G2_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
      <span class="comment1">(*  *)</span>
      <span class="keyword1"><span class="command">have</span></span> n12<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n1</span> <span class="main">=</span> <span class="skolem">n2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> n1 n2 G1 G2 G brnL_Int <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">F</span> <span class="skolem">n1</span> <span class="skolem">I1</span> <span class="main">=</span> <span class="free">F</span> <span class="skolem">n2</span> <span class="skolem">I2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> G <span class="keyword1"><span class="command">unfolding</span></span> G1_def G2_def n12 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">I1</span> <span class="main">=</span> <span class="skolem">I2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> I1 I2 n1 F <span class="keyword1"><span class="command">unfolding</span></span> n12 inj_on_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> II1 II2 n12 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Compositionality-inj_on_singl"><span class="command">lemma</span></span> inj_on_singl<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="free">f</span> <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">a0</span> <span class="main">∉</span> <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">a</span> <span class="main">≠</span> <span class="free">f</span> <span class="free">a0</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="free">f</span> <span class="main">(</span><span class="main">{</span><span class="free">a0</span><span class="main">}</span> <span class="keyword1">Un</span> <span class="free">A</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> inj_on_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="Compositionality-UNlift01_inj_on"><span class="command">lemma</span></span> UNlift01_inj_on<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> l<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">cl</span> <span class="main">=</span> length <span class="free">dl</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> P<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> length <span class="free">cl</span> <span class="main">⟹</span> part <span class="main">{..&lt;</span> brn <span class="main">(</span><span class="free">cl</span><span class="main">!</span><span class="bound">n</span><span class="main">)</span><span class="main">}</span> <span class="main">(</span><span class="free">P</span> <span class="bound">n</span><span class="main">)</span> <span class="main">∧</span> <span class="main">{}</span> <span class="main">∉</span> <span class="free">P</span> <span class="bound">n</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> FP<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> length <span class="free">dl</span> <span class="main">⟹</span> part <span class="main">{..&lt;</span> brn <span class="main">(</span><span class="free">dl</span><span class="main">!</span><span class="bound">n</span><span class="main">)</span><span class="main">}</span> <span class="main">(</span><span class="free">F</span> <span class="bound">n</span> <span class="main">`</span> <span class="main">(</span><span class="free">P</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="main">{}</span> <span class="main">∉</span> <span class="free">F</span> <span class="bound">n</span> <span class="main">`</span> <span class="main">(</span><span class="free">P</span> <span class="bound">n</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> F<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> length <span class="free">cl</span> <span class="main">⟹</span> inj_on <span class="main">(</span><span class="free">F</span> <span class="bound">n</span><span class="main">)</span> <span class="main">(</span><span class="free">P</span> <span class="bound">n</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="main">(</span>UNlift01 <span class="free">cl</span> <span class="free">dl</span> <span class="free">P</span> <span class="free">F</span><span class="main">)</span> <span class="main">(</span>UNpart01 <span class="free">cl</span> <span class="free">dl</span> <span class="free">P</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> UNpart01_def <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> inj_on_singl<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="main">(</span>UNlift01 <span class="free">cl</span> <span class="free">dl</span> <span class="free">P</span> <span class="free">F</span><span class="main">)</span> <span class="main">(</span>UNpart1 <span class="free">cl</span> <span class="free">dl</span> <span class="free">P</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> UNlift01_inj_on_UNpart1<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"BrnFT <span class="free">cl</span> <span class="free">dl</span> <span class="main">∉</span> UNpart1 <span class="free">cl</span> <span class="free">dl</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> BrnFT_notIn_UNpart1<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> l P <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Q</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">%</span><span class="bound">n</span><span class="main">.</span> <span class="free">F</span> <span class="bound">n</span> <span class="main">`</span> <span class="main">(</span><span class="free">P</span> <span class="bound">n</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">II</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">II</span> <span class="main">∈</span> UNpart1 <span class="free">cl</span> <span class="free">dl</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"UNlift01 <span class="free">cl</span> <span class="free">dl</span> <span class="free">P</span> <span class="free">F</span> <span class="skolem">II</span> <span class="main">≠</span> BrnFT <span class="free">dl</span> <span class="free">cl</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> UNpart1_cases<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Local <span class="skolem">n</span> <span class="skolem">I</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">∈</span> theNFTBoth <span class="free">cl</span> <span class="free">dl</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">∈</span> theNFTBoth <span class="free">dl</span> <span class="free">cl</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">&lt;</span> length <span class="free">cl</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">&lt;</span> length <span class="free">dl</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">I</span> <span class="main">∈</span> <span class="free">P</span> <span class="skolem">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> II<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">II</span> <span class="main">=</span> shift <span class="free">cl</span> <span class="skolem">n</span> <span class="skolem">I</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> l theNFTBoth_sym <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"shift <span class="free">dl</span> <span class="skolem">n</span> <span class="main">(</span><span class="free">F</span> <span class="skolem">n</span> <span class="skolem">I</span><span class="main">)</span> <span class="main">∈</span> UNpart1 <span class="free">dl</span> <span class="free">cl</span> <span class="var">?Q</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> UNpart1_def shift_def <span class="keyword1"><span class="command">using</span></span> n I <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"shift <span class="free">dl</span> <span class="skolem">n</span> <span class="main">(</span><span class="free">F</span> <span class="skolem">n</span> <span class="skolem">I</span><span class="main">)</span> <span class="main">≠</span> BrnFT <span class="free">dl</span> <span class="free">cl</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> BrnFT_notIn_UNpart1<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">dl</span></span> <span class="quoted"><span class="free">cl</span></span> <span class="var"><span class="quoted"><span class="var">?Q</span></span></span><span class="main">]</span> n l FP <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> II <span class="keyword1"><span class="command">using</span></span> n I l P <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"UNlift01 <span class="free">cl</span> <span class="free">dl</span> <span class="free">P</span> <span class="free">F</span> <span class="skolem">II</span> <span class="main">≠</span> UNlift01 <span class="free">cl</span> <span class="free">dl</span> <span class="free">P</span> <span class="free">F</span> <span class="main">(</span>BrnFT <span class="free">cl</span> <span class="free">dl</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Compositionality-UNlift01_UNpart1"><span class="command">lemma</span></span> UNlift01_UNpart1<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> l<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">cl</span> <span class="main">=</span> length <span class="free">dl</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> P<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> length <span class="free">cl</span> <span class="main">⟹</span> part <span class="main">{..&lt;</span> brn <span class="main">(</span><span class="free">cl</span><span class="main">!</span><span class="bound">n</span><span class="main">)</span><span class="main">}</span> <span class="main">(</span><span class="free">P</span> <span class="bound">n</span><span class="main">)</span> <span class="main">∧</span> <span class="main">{}</span> <span class="main">∉</span> <span class="free">P</span> <span class="bound">n</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>UNlift01 <span class="free">cl</span> <span class="free">dl</span> <span class="free">P</span> <span class="free">F</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span>UNpart1 <span class="free">cl</span> <span class="free">dl</span> <span class="free">P</span><span class="main">)</span> <span class="main">=</span> UNpart1 <span class="free">dl</span> <span class="free">cl</span> <span class="main">(</span><span class="main">%</span><span class="bound">n</span><span class="main">.</span> <span class="free">F</span> <span class="bound">n</span> <span class="main">`</span> <span class="main">(</span><span class="free">P</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?G</span> <span class="main">`</span> <span class="var">?Q</span> <span class="main">=</span> <span class="var">?R</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">II</span> <span class="keyword3"><span class="command">assume</span></span> II<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">II</span> <span class="main">∈</span> <span class="var">?Q</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="var">?G</span> <span class="skolem">II</span> <span class="main">∈</span> <span class="var">?R</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> UNpart1_cases<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Local <span class="skolem">n</span> <span class="skolem">I</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">∈</span> theNFTBoth <span class="free">cl</span> <span class="free">dl</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">∈</span> theNFTBoth <span class="free">dl</span> <span class="free">cl</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">&lt;</span> length <span class="free">cl</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">&lt;</span> length <span class="free">dl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">I</span> <span class="main">∈</span> <span class="free">P</span> <span class="skolem">n</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> II<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">II</span> <span class="main">=</span> shift <span class="free">cl</span> <span class="skolem">n</span> <span class="skolem">I</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> l theNFTBoth_sym <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> G<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?G</span> <span class="skolem">II</span> <span class="main">=</span> shift <span class="free">dl</span> <span class="skolem">n</span> <span class="main">(</span><span class="free">F</span> <span class="skolem">n</span> <span class="skolem">I</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> l P <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> n I <span class="keyword1"><span class="command">unfolding</span></span> G UNpart1_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">JJ</span> <span class="keyword3"><span class="command">assume</span></span> JJ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">JJ</span> <span class="main">∈</span> <span class="var">?R</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">JJ</span> <span class="main">∈</span> <span class="var">?G</span> <span class="main">`</span> <span class="var">?Q</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> UNpart1_cases<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Local <span class="skolem">n</span> <span class="skolem">J</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">∈</span> theNFTBoth <span class="free">cl</span> <span class="free">dl</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">∈</span> theNFTBoth <span class="free">dl</span> <span class="free">cl</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">&lt;</span> length <span class="free">cl</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">&lt;</span> length <span class="free">dl</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> J<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">J</span> <span class="main">∈</span> <span class="free">F</span> <span class="skolem">n</span> <span class="main">`</span> <span class="main">(</span><span class="free">P</span> <span class="skolem">n</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> JJ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">JJ</span> <span class="main">=</span> shift <span class="free">dl</span> <span class="skolem">n</span> <span class="skolem">J</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> l theNFTBoth_sym <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">I</span></span> <span class="keyword2"><span class="keyword">where</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">I</span> <span class="main">∈</span> <span class="free">P</span> <span class="skolem">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">J</span> <span class="main">=</span> <span class="free">F</span> <span class="skolem">n</span> <span class="skolem">I</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">JJ</span> <span class="main">=</span> shift <span class="free">dl</span> <span class="skolem">n</span> <span class="main">(</span><span class="free">F</span> <span class="skolem">n</span> <span class="skolem">I</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> JJ <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> UNlift01 <span class="free">cl</span> <span class="free">dl</span> <span class="free">P</span> <span class="free">F</span> <span class="main">(</span>shift <span class="free">cl</span> <span class="skolem">n</span> <span class="skolem">I</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> n I l P <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> JJ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">JJ</span> <span class="main">=</span> UNlift01 <span class="free">cl</span> <span class="free">dl</span> <span class="free">P</span> <span class="free">F</span> <span class="main">(</span>shift <span class="free">cl</span> <span class="skolem">n</span> <span class="skolem">I</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> n l I <span class="keyword1"><span class="command">unfolding</span></span> JJ UNpart1_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Compositionality-UNlift01_UNpart01"><span class="command">lemma</span></span> UNlift01_UNpart01<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> l<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">cl</span> <span class="main">=</span> length <span class="free">dl</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> P<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> length <span class="free">cl</span> <span class="main">⟹</span> part <span class="main">{..&lt;</span> brn <span class="main">(</span><span class="free">cl</span><span class="main">!</span><span class="bound">n</span><span class="main">)</span><span class="main">}</span> <span class="main">(</span><span class="free">P</span> <span class="bound">n</span><span class="main">)</span> <span class="main">∧</span> <span class="main">{}</span> <span class="main">∉</span> <span class="free">P</span> <span class="bound">n</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>UNlift01 <span class="free">cl</span> <span class="free">dl</span> <span class="free">P</span> <span class="free">F</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span>UNpart01 <span class="free">cl</span> <span class="free">dl</span> <span class="free">P</span><span class="main">)</span> <span class="main">=</span> UNpart01 <span class="free">dl</span> <span class="free">cl</span> <span class="main">(</span><span class="main">%</span><span class="bound">n</span><span class="main">.</span> <span class="free">F</span> <span class="bound">n</span> <span class="main">`</span> <span class="main">(</span><span class="free">P</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms UNlift01_UNpart1<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">cl</span></span> <span class="quoted"><span class="free">dl</span></span> <span class="quoted"><span class="free">P</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> UNpart01_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Compositionality-emp_UNlift01_UNpart1"><span class="command">lemma</span></span> emp_UNlift01_UNpart1<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> l<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">cl</span> <span class="main">=</span> length <span class="free">dl</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> P<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> length <span class="free">cl</span> <span class="main">⟹</span> part <span class="main">{..&lt;</span> brn <span class="main">(</span><span class="free">cl</span><span class="main">!</span><span class="bound">n</span><span class="main">)</span><span class="main">}</span> <span class="main">(</span><span class="free">P</span> <span class="bound">n</span><span class="main">)</span> <span class="main">∧</span> <span class="main">{}</span> <span class="main">∉</span> <span class="free">P</span> <span class="bound">n</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> FP<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> length <span class="free">dl</span> <span class="main">⟹</span> <span class="main">{}</span> <span class="main">∉</span> <span class="free">F</span> <span class="bound">n</span> <span class="main">`</span> <span class="main">(</span><span class="free">P</span> <span class="bound">n</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">{}</span> <span class="main">∉</span> <span class="main">(</span>UNlift01 <span class="free">cl</span> <span class="free">dl</span> <span class="free">P</span> <span class="free">F</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span>UNpart1 <span class="free">cl</span> <span class="free">dl</span> <span class="free">P</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">{}</span> <span class="main">∉</span> <span class="var">?R</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> R<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?R</span> <span class="main">=</span> UNpart1 <span class="free">dl</span> <span class="free">cl</span> <span class="main">(</span><span class="main">%</span><span class="bound">n</span><span class="main">.</span> <span class="free">F</span> <span class="bound">n</span> <span class="main">`</span> <span class="main">(</span><span class="free">P</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> UNlift01_UNpart1<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> R <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> emp_UNpart1<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> FP <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Compositionality-emp_UNlift01_UNpart01"><span class="command">lemma</span></span> emp_UNlift01_UNpart01<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> l<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">cl</span> <span class="main">=</span> length <span class="free">dl</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> P<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> length <span class="free">cl</span> <span class="main">⟹</span> part <span class="main">{..&lt;</span> brn <span class="main">(</span><span class="free">cl</span><span class="main">!</span><span class="bound">n</span><span class="main">)</span><span class="main">}</span> <span class="main">(</span><span class="free">P</span> <span class="bound">n</span><span class="main">)</span> <span class="main">∧</span> <span class="main">{}</span> <span class="main">∉</span> <span class="free">P</span> <span class="bound">n</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> FP<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> length <span class="free">dl</span> <span class="main">⟹</span> <span class="main">{}</span> <span class="main">∉</span> <span class="free">F</span> <span class="bound">n</span> <span class="main">`</span> <span class="main">(</span><span class="free">P</span> <span class="bound">n</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">{}</span> <span class="main">∉</span> <span class="main">(</span>UNlift01 <span class="free">cl</span> <span class="free">dl</span> <span class="free">P</span> <span class="free">F</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span>UNpart01 <span class="free">cl</span> <span class="free">dl</span> <span class="free">P</span> <span class="main">-</span> <span class="main">{</span>BrnFT <span class="free">cl</span> <span class="free">dl</span><span class="main">}</span><span class="main">)</span>"</span></span>
<span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">{}</span> <span class="main">∉</span> <span class="var">?U</span> <span class="main">`</span> <span class="var">?V</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> V<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?V</span> <span class="main">=</span> UNpart1 <span class="free">cl</span> <span class="free">dl</span> <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> UNpart1_UNpart01<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> sym<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> V <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> emp_UNlift01_UNpart1<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Compositionality-part_UNlift01_UNpart1"><span class="command">lemma</span></span> part_UNlift01_UNpart1<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> l<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">cl</span> <span class="main">=</span> length <span class="free">dl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> dl<span class="main">:</span> <span class="quoted"><span class="quoted">"properL <span class="free">dl</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> P<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> length <span class="free">cl</span> <span class="main">⟹</span> part <span class="main">{..&lt;</span> brn <span class="main">(</span><span class="free">cl</span><span class="main">!</span><span class="bound">n</span><span class="main">)</span><span class="main">}</span> <span class="main">(</span><span class="free">P</span> <span class="bound">n</span><span class="main">)</span> <span class="main">∧</span> <span class="main">{}</span> <span class="main">∉</span> <span class="free">P</span> <span class="bound">n</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> FP<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> length <span class="free">dl</span> <span class="main">⟹</span> part <span class="main">{..&lt;</span> brn <span class="main">(</span><span class="free">dl</span><span class="main">!</span><span class="bound">n</span><span class="main">)</span><span class="main">}</span> <span class="main">(</span><span class="free">F</span> <span class="bound">n</span> <span class="main">`</span> <span class="main">(</span><span class="free">P</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"part <span class="main">(</span>BrnNFT <span class="free">dl</span> <span class="free">cl</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span>UNlift01 <span class="free">cl</span> <span class="free">dl</span> <span class="free">P</span> <span class="free">F</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span>UNpart1 <span class="free">cl</span> <span class="free">dl</span> <span class="free">P</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"part <span class="var">?C</span> <span class="var">?R</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Q</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">%</span><span class="bound">n</span><span class="main">.</span> <span class="free">F</span> <span class="bound">n</span> <span class="main">`</span> <span class="main">(</span><span class="free">P</span> <span class="bound">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> R<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?R</span> <span class="main">=</span> UNpart1 <span class="free">dl</span> <span class="free">cl</span> <span class="var">?Q</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> UNlift01_UNpart1<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">cl</span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">dl</span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">P</span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">F</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> R <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> part_UNpart1<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> dl l FP <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Compositionality-part_UNlift01_UNpart01"><span class="command">lemma</span></span> part_UNlift01_UNpart01<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> l<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">cl</span> <span class="main">=</span> length <span class="free">dl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> dl<span class="main">:</span> <span class="quoted"><span class="quoted">"properL <span class="free">dl</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> P<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> length <span class="free">cl</span> <span class="main">⟹</span> part <span class="main">{..&lt;</span> brn <span class="main">(</span><span class="free">cl</span><span class="main">!</span><span class="bound">n</span><span class="main">)</span><span class="main">}</span> <span class="main">(</span><span class="free">P</span> <span class="bound">n</span><span class="main">)</span> <span class="main">∧</span> <span class="main">{}</span> <span class="main">∉</span> <span class="free">P</span> <span class="bound">n</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> FP<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> length <span class="free">dl</span> <span class="main">⟹</span> part <span class="main">{..&lt;</span> brn <span class="main">(</span><span class="free">dl</span><span class="main">!</span><span class="bound">n</span><span class="main">)</span><span class="main">}</span> <span class="main">(</span><span class="free">F</span> <span class="bound">n</span> <span class="main">`</span> <span class="main">(</span><span class="free">P</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="main">{}</span> <span class="main">∉</span> <span class="main">(</span><span class="free">F</span> <span class="bound">n</span> <span class="main">`</span> <span class="main">(</span><span class="free">P</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"part <span class="main">{..&lt;</span> brnL <span class="free">dl</span> <span class="main">(</span>length <span class="free">dl</span><span class="main">)</span><span class="main">}</span> <span class="main">(</span><span class="main">(</span>UNlift01 <span class="free">cl</span> <span class="free">dl</span> <span class="free">P</span> <span class="free">F</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span>UNpart01 <span class="free">cl</span> <span class="free">dl</span> <span class="free">P</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"part <span class="var">?K</span> <span class="var">?R</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?G</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"UNlift01 <span class="free">cl</span> <span class="free">dl</span> <span class="free">P</span> <span class="free">F</span>"</span></span> <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Q</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">%</span><span class="bound">n</span><span class="main">.</span> <span class="free">F</span> <span class="bound">n</span> <span class="main">`</span> <span class="main">(</span><span class="free">P</span> <span class="bound">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> R<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?R</span> <span class="main">=</span> <span class="main">{</span><span class="var">?G</span> <span class="main">(</span>BrnFT <span class="free">cl</span> <span class="free">dl</span><span class="main">)</span><span class="main">}</span> <span class="main">∪</span> <span class="var">?G</span> <span class="main">`</span> <span class="main">(</span>UNpart1 <span class="free">cl</span> <span class="free">dl</span> <span class="free">P</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> UNpart01_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> R <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> part_Un_singl2<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"BrnNFT <span class="free"><span class="free">dl</span></span> <span class="free"><span class="free">cl</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> assms part_UNlift01_UNpart1
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">force</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> BrnFT_Int_UNpart1<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">dl</span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">cl</span></span></span></span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?Q</span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">force</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> UNlift01_UNpart1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* fixme: cont *)</span>
<span class="keyword1" id="Compositionality-diff_frac_eq_1"><span class="command">lemma</span></span> diff_frac_eq_1<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">≠</span> <span class="main">(</span><span class="main">0</span><span class="main">::</span>real<span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">-</span> <span class="free">a</span> <span class="main">/</span> <span class="free">b</span> <span class="main">=</span> <span class="main">(</span><span class="free">b</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span> <span class="main">/</span> <span class="free">b</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms diff_divide_distrib divide_self_if<span class="main">)</span>

<span class="keyword1" id="Compositionality-diff_frac_eq_2"><span class="command">lemma</span></span> diff_frac_eq_2<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">≠</span> <span class="main">(</span><span class="main">1</span><span class="main">::</span>real<span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">-</span> <span class="main">(</span><span class="free">a</span> <span class="main">-</span> <span class="free">b</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">b</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">b</span><span class="main">)</span>"</span></span>
<span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">=</span> <span class="var">?R</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">-</span> <span class="free">b</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">=</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">b</span> <span class="main">-</span> <span class="main">(</span><span class="free">a</span> <span class="main">-</span> <span class="free">b</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">b</span><span class="main">)</span>"</span></span>  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">=</span> <span class="var">?A</span> <span class="main">/</span> <span class="var">?B</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> diff_frac_eq_1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?A</span> <span class="main">=</span> <span class="main">1</span> <span class="main">-</span> <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Compositionality-triv_div_mult"><span class="command">lemma</span></span> triv_div_mult<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> vSF<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">vSF</span> <span class="main">≠</span> <span class="main">(</span><span class="main">1</span><span class="main">::</span>real<span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> L<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">L</span> <span class="main">=</span> <span class="main">(</span><span class="free">K</span> <span class="main">-</span> <span class="free">vSF</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">vSF</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> Ln<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">L</span> <span class="main">≠</span> <span class="main">1</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">VS</span> <span class="main">/</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">vSF</span><span class="main">)</span> <span class="main">*</span> <span class="free">V</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">L</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">VS</span> <span class="main">*</span> <span class="free">V</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">K</span><span class="main">)</span>"</span></span>
<span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?A</span> <span class="main">=</span> <span class="var">?B</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> vSF_0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">-</span> <span class="free">vSF</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> vSF <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">K</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
   <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">L</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> L vSF <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
   <span class="keyword1"><span class="command">hence</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> Ln <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">hence</span></span> Kn<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">K</span> <span class="main">≠</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> K_0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">-</span> <span class="free">K</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">-</span> <span class="free">L</span> <span class="main">=</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">K</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">vSF</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> L <span class="keyword1"><span class="command">using</span></span> vSF diff_frac_eq_2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?A</span> <span class="main">=</span> <span class="main">(</span><span class="free">VS</span> <span class="main">/</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">vSF</span><span class="main">)</span> <span class="main">*</span> <span class="free">V</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">K</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">vSF</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="var">?B</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> vSF_0 K_0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="comment1">(* end fixme *)</span>

<span class="keyword1" id="Compositionality-ss_wt_ParT_UNlift01"><span class="command">lemma</span></span> ss_wt_ParT_UNlift01<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> l<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">cl</span> <span class="main">=</span> length <span class="free">dl</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> cldl<span class="main">:</span> <span class="quoted"><span class="quoted">"properL <span class="free">cl</span>"</span></span> <span class="quoted"><span class="quoted">"properL <span class="free">dl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> II<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">II</span> <span class="main">∈</span> UNpart01 <span class="free">cl</span> <span class="free">dl</span> <span class="free">P</span> <span class="main">-</span> <span class="main">{</span>BrnFT <span class="free">cl</span> <span class="free">dl</span><span class="main">}</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> P<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> length <span class="free">cl</span> <span class="main">⟹</span> part <span class="main">{..&lt;</span> brn <span class="main">(</span><span class="free">cl</span><span class="main">!</span><span class="bound">n</span><span class="main">)</span><span class="main">}</span> <span class="main">(</span><span class="free">P</span> <span class="bound">n</span><span class="main">)</span> <span class="main">∧</span> <span class="main">{}</span> <span class="main">∉</span> <span class="free">P</span> <span class="bound">n</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> FP<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> length <span class="free">dl</span> <span class="main">⟹</span> part <span class="main">{..&lt;</span> brn <span class="main">(</span><span class="free">dl</span><span class="main">!</span><span class="bound">n</span><span class="main">)</span><span class="main">}</span> <span class="main">(</span><span class="free">F</span> <span class="bound">n</span> <span class="main">`</span> <span class="main">(</span><span class="free">P</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> sw<span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span> <span class="bound">I</span><span class="main">.</span> <span class="main">⟦</span><span class="bound">n</span> <span class="main">&lt;</span> length <span class="free">cl</span><span class="main">;</span> <span class="bound">I</span> <span class="main">∈</span> <span class="free">P</span> <span class="bound">n</span><span class="main">⟧</span> <span class="main">⟹</span>
     sum <span class="main">(</span>wt <span class="main">(</span><span class="free">cl</span> <span class="main">!</span> <span class="bound">n</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span> <span class="bound">I</span> <span class="main">=</span>
     sum <span class="main">(</span>wt <span class="main">(</span><span class="free">dl</span> <span class="main">!</span> <span class="bound">n</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span> <span class="main">(</span><span class="free">F</span> <span class="bound">n</span> <span class="bound">I</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> st<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">≈</span> <span class="free">t</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> le1<span class="main">:</span> <span class="quoted"><span class="quoted">"sum <span class="main">(</span>wt <span class="main">(</span>ParT <span class="free">cl</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span> <span class="main">(</span>BrnFT <span class="free">cl</span> <span class="free">dl</span><span class="main">)</span> <span class="main">&lt;</span> <span class="main">1</span>"</span></span>
<span class="quoted"><span class="quoted">"sum <span class="main">(</span>wt <span class="main">(</span>ParT <span class="free">dl</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span> <span class="main">(</span>BrnFT <span class="free">dl</span> <span class="free">cl</span><span class="main">)</span> <span class="main">&lt;</span> <span class="main">1</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span>
<span class="quoted"><span class="quoted">"sum <span class="main">(</span>wt <span class="main">(</span>ParT <span class="free">cl</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span> <span class="free">II</span> <span class="main">/</span>
 <span class="main">(</span><span class="main">1</span> <span class="main">-</span> sum <span class="main">(</span>wt <span class="main">(</span>ParT <span class="free">cl</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span> <span class="main">(</span>BrnFT <span class="free">cl</span> <span class="free">dl</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
 sum <span class="main">(</span>wt <span class="main">(</span>ParT <span class="free">dl</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span> <span class="main">(</span>UNlift01 <span class="free">cl</span> <span class="free">dl</span> <span class="free">P</span> <span class="free">F</span> <span class="free">II</span><span class="main">)</span> <span class="main">/</span>
 <span class="main">(</span><span class="main">1</span> <span class="main">-</span> sum <span class="main">(</span>wt <span class="main">(</span>ParT <span class="free">dl</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span> <span class="main">(</span>BrnFT <span class="free">dl</span> <span class="free">cl</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"sum <span class="var">?vP</span> <span class="free">II</span> <span class="main">/</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> sum <span class="var">?vP</span> <span class="var">?II_0</span><span class="main">)</span> <span class="main">=</span>
     sum <span class="var">?wP</span> <span class="var">?JJ</span> <span class="main">/</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> sum <span class="var">?wP</span> <span class="var">?JJ_0</span><span class="main">)</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?N</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"length <span class="free">cl</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?vS</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">%</span><span class="bound">n</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> <span class="var">?N</span>"</span></span> <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?wS</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">%</span><span class="bound">n</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> <span class="main">(</span>length <span class="free">dl</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?vSF</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"WtFT <span class="free">cl</span>"</span></span> <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?wSF</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"WtFT <span class="free">dl</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ss</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">%</span><span class="bound">n</span><span class="main">.</span> <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?tt</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">%</span><span class="bound">n</span><span class="main">.</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?v</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">%</span><span class="bound">n</span><span class="main">.</span> wt <span class="main">(</span><span class="free">cl</span> <span class="main">!</span> <span class="bound">n</span><span class="main">)</span> <span class="main">(</span><span class="var">?ss</span> <span class="bound">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?w</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">%</span><span class="bound">n</span><span class="main">.</span> wt <span class="main">(</span><span class="free">dl</span> <span class="main">!</span> <span class="bound">n</span><span class="main">)</span> <span class="main">(</span><span class="var">?tt</span> <span class="bound">n</span><span class="main">)</span>"</span></span>
  <span class="comment1">(*  *)</span>
  <span class="keyword1"><span class="command">have</span></span> sstt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> <span class="var">?N</span> <span class="main">⟹</span> <span class="var">?ss</span> <span class="bound">n</span> <span class="main">≈</span> <span class="var">?tt</span> <span class="bound">n</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> st l <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> vSwS<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> <span class="var">?N</span> <span class="main">⟹</span> <span class="var">?vS</span> <span class="bound">n</span> <span class="main">=</span> <span class="var">?wS</span> <span class="bound">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> sstt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> <span class="var">?N</span> <span class="main">⟹</span> <span class="var">?ss</span> <span class="bound">n</span> <span class="main">≈</span> <span class="var">?tt</span> <span class="bound">n</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> nf<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?vSF</span> <span class="main">≠</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?wSF</span> <span class="main">≠</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> le1 cldl l <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> theFT_theNFT<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">∈</span> theFT <span class="free">dl</span> <span class="main">-</span> theFT <span class="free">cl</span> <span class="main">⟹</span> <span class="bound">n</span> <span class="main">&lt;</span> length <span class="free">cl</span> <span class="main">∧</span> <span class="main">¬</span> finished <span class="main">(</span><span class="free">cl</span> <span class="main">!</span> <span class="bound">n</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">∈</span> theFT <span class="free">cl</span> <span class="main">-</span> theFT <span class="free">dl</span> <span class="main">⟹</span> <span class="bound">n</span> <span class="main">&lt;</span> length <span class="free">dl</span> <span class="main">∧</span> <span class="main">¬</span> finished <span class="main">(</span><span class="free">dl</span> <span class="main">!</span> <span class="bound">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> theFT_def <span class="keyword1"><span class="command">using</span></span> l <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> sum_v<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> length <span class="free">cl</span> <span class="main">⟹</span> sum <span class="main">(</span><span class="var">?v</span> <span class="bound">n</span><span class="main">)</span> <span class="main">{..&lt;</span> brn <span class="main">(</span><span class="free">cl</span> <span class="main">!</span> <span class="bound">n</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> cldl <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> sum_w<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> length <span class="free">dl</span> <span class="main">⟹</span> sum <span class="main">(</span><span class="var">?w</span> <span class="bound">n</span><span class="main">)</span> <span class="main">{..&lt;</span> brn <span class="main">(</span><span class="free">dl</span> <span class="main">!</span> <span class="bound">n</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> cldl <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> theFTOne<span class="main">:</span> <span class="quoted"><span class="quoted">"theFTOne <span class="free">cl</span> <span class="free">dl</span> <span class="main">=</span> theFT <span class="free">dl</span> <span class="main">-</span> theFT <span class="free">cl</span> <span class="main">∪</span> theFT <span class="free">cl</span>"</span></span>
  <span class="quoted"><span class="quoted">"theFTOne <span class="free">dl</span> <span class="free">cl</span> <span class="main">=</span> theFT <span class="free">cl</span> <span class="main">-</span> theFT <span class="free">dl</span> <span class="main">∪</span> theFT <span class="free">dl</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> theFTOne_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">have</span></span> sum_vS_wS<span class="main">:</span> <span class="quoted"><span class="quoted">"sum <span class="var">?vS</span> <span class="main">(</span>theFTOne <span class="free">cl</span> <span class="free">dl</span><span class="main">)</span> <span class="main">=</span> sum <span class="var">?wS</span> <span class="main">(</span>theFTOne <span class="free">dl</span> <span class="free">cl</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> theFTOne_sym<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">cl</span></span> <span class="quoted"><span class="free">dl</span></span><span class="main">]</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sum.cong<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> vSwS l <span class="keyword1"><span class="command">unfolding</span></span> theFTOne_def theFT_def theNFT_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="comment1">(*  *)</span>
  <span class="keyword1"><span class="command">have</span></span> II<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">II</span> <span class="main">∈</span> UNpart1 <span class="free">cl</span> <span class="free">dl</span> <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> II l P UNpart1_UNpart01 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> UNpart1_cases<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Local <span class="skolem">n</span> <span class="skolem">I</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">&lt;</span> <span class="var">?N</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">&lt;</span> length <span class="free">dl</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">∈</span> theNFTBoth <span class="free">cl</span> <span class="free">dl</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">¬</span> finished <span class="main">(</span><span class="free">cl</span><span class="main">!</span><span class="skolem">n</span><span class="main">)</span>"</span></span>  <span class="quoted"><span class="quoted">"<span class="main">¬</span> finished <span class="main">(</span><span class="free">dl</span><span class="main">!</span><span class="skolem">n</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">I</span> <span class="main">∈</span> <span class="free">P</span> <span class="skolem">n</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> II<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">II</span> <span class="main">=</span> shift <span class="free">cl</span> <span class="skolem">n</span> <span class="skolem">I</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> l <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> I_sub<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">I</span> <span class="main">⊆</span> <span class="main">{..&lt;</span> brn <span class="main">(</span><span class="free">cl</span><span class="main">!</span><span class="skolem">n</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> n I P <span class="keyword1"><span class="command">unfolding</span></span> part_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">hence</span></span> FnI_sub<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">F</span> <span class="skolem">n</span> <span class="skolem">I</span> <span class="main">⊆</span> <span class="main">{..&lt;</span> brn <span class="main">(</span><span class="free">dl</span><span class="main">!</span><span class="skolem">n</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> n I FP <span class="keyword1"><span class="command">unfolding</span></span> part_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> JJ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?JJ</span> <span class="main">=</span> shift <span class="free">dl</span> <span class="skolem">n</span> <span class="main">(</span><span class="free">F</span> <span class="skolem">n</span> <span class="skolem">I</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> II <span class="keyword1"><span class="command">using</span></span> l P n I <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="comment1">(*  *)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum <span class="var">?vP</span> <span class="var">?II_0</span> <span class="main">=</span>
    sum <span class="main">(</span><span class="main">%</span><span class="bound">n</span><span class="main">.</span> sum <span class="var">?vP</span> <span class="main">{</span>brnL <span class="free">cl</span> <span class="bound">n</span><span class="main">..&lt;+</span>brn <span class="main">(</span><span class="free">cl</span> <span class="main">!</span> <span class="bound">n</span><span class="main">)</span><span class="main">}</span><span class="main">)</span> <span class="main">(</span>theFTOne <span class="free">cl</span> <span class="free">dl</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> BrnFT_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> sum.UNION_disjoint<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> brnL_Int l <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span>
    sum
      <span class="main">(</span><span class="main">%</span><span class="bound">n</span><span class="main">.</span> sum <span class="var">?vP</span> <span class="main">{</span>brnL <span class="free">cl</span> <span class="bound">n</span><span class="main">..&lt;+</span>brn <span class="main">(</span><span class="free">cl</span> <span class="main">!</span> <span class="bound">n</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>
      <span class="main">(</span><span class="main">(</span>theFT <span class="free">dl</span> <span class="main">-</span> theFT <span class="free">cl</span><span class="main">)</span> <span class="main">∪</span> theFT <span class="free">cl</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> theFTOne_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Un_Diff_cancel2 Un_commute<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span>
    sum
      <span class="main">(</span><span class="main">%</span><span class="bound">n</span><span class="main">.</span> sum <span class="var">?vP</span> <span class="main">{</span>brnL <span class="free">cl</span> <span class="bound">n</span><span class="main">..&lt;+</span>brn <span class="main">(</span><span class="free">cl</span> <span class="main">!</span> <span class="bound">n</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>
      <span class="main">(</span>theFT <span class="free">dl</span> <span class="main">-</span> theFT <span class="free">cl</span><span class="main">)</span> <span class="main">+</span>
    sum
      <span class="main">(</span><span class="main">%</span><span class="bound">n</span><span class="main">.</span> sum <span class="var">?vP</span> <span class="main">{</span>brnL <span class="free">cl</span> <span class="bound">n</span><span class="main">..&lt;+</span>brn <span class="main">(</span><span class="free">cl</span> <span class="main">!</span> <span class="bound">n</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>
      <span class="main">(</span>theFT <span class="free">cl</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="var">?L</span> <span class="main">+</span> <span class="var">?R</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> sum.union_disjoint<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?R</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> sum.neutral<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> cldl nf <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum <span class="var">?vP</span> <span class="var">?II_0</span> <span class="main">=</span> <span class="var">?L</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">=</span>
    sum
      <span class="main">(</span><span class="main">%</span><span class="bound">n</span><span class="main">.</span> <span class="var">?vS</span> <span class="bound">n</span> <span class="main">/</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="var">?vSF</span><span class="main">)</span> <span class="main">*</span> sum <span class="main">(</span><span class="var">?v</span> <span class="bound">n</span><span class="main">)</span> <span class="main">{..&lt;</span> brn <span class="main">(</span><span class="free">cl</span> <span class="main">!</span> <span class="bound">n</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>
      <span class="main">(</span>theFT <span class="free">dl</span> <span class="main">-</span> theFT <span class="free">cl</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">intro</span> sum.cong<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> cldl nf
    <span class="keyword1"><span class="command">using</span></span> theFT_theNFT sum_wt_ParT_notWtFT_notFinished<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">cl</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span>
    sum
      <span class="main">(</span><span class="main">%</span><span class="bound">n</span><span class="main">.</span> <span class="var">?vS</span> <span class="bound">n</span> <span class="main">*</span> sum <span class="main">(</span><span class="var">?v</span> <span class="bound">n</span><span class="main">)</span> <span class="main">{..&lt;</span> brn <span class="main">(</span><span class="free">cl</span> <span class="main">!</span> <span class="bound">n</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>
      <span class="main">(</span>theFT <span class="free">dl</span> <span class="main">-</span> theFT <span class="free">cl</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="var">?vSF</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="var">?L</span> <span class="main">/</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="var">?vSF</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> times_divide_eq_left sum_divide_distrib <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">=</span> sum <span class="var">?vS</span> <span class="main">(</span>theFT <span class="free">dl</span> <span class="main">-</span> theFT <span class="free">cl</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">intro</span> sum.cong<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"sum <span class="var">?vP</span> <span class="var">?II_0</span> <span class="main">=</span> <span class="main">(</span>sum <span class="var">?vS</span> <span class="main">(</span>theFT <span class="free">dl</span> <span class="main">-</span> theFT <span class="free">cl</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="var">?vSF</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="var">?L</span> <span class="main">/</span> <span class="var">?R</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">=</span> sum <span class="var">?vS</span> <span class="main">(</span>theFTOne <span class="free">cl</span> <span class="free">dl</span><span class="main">)</span> <span class="main">-</span> <span class="var">?vSF</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> eq_diff_eq WtFT_def theFTOne
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> sum.union_disjoint<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> sym<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> vPII0<span class="main">:</span> <span class="quoted"><span class="quoted">"sum <span class="var">?vP</span> <span class="var">?II_0</span> <span class="main">=</span>
    <span class="main">(</span>sum <span class="var">?vS</span> <span class="main">(</span>theFTOne <span class="free">cl</span> <span class="free">dl</span><span class="main">)</span> <span class="main">-</span> <span class="var">?vSF</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="var">?vSF</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="comment1">(*  *)</span>
    <span class="comment1">(*  *)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum <span class="var">?wP</span> <span class="var">?JJ_0</span> <span class="main">=</span>
    sum <span class="main">(</span><span class="main">%</span><span class="bound">n</span><span class="main">.</span> sum <span class="var">?wP</span> <span class="main">{</span>brnL <span class="free">dl</span> <span class="bound">n</span><span class="main">..&lt;+</span>brn <span class="main">(</span><span class="free">dl</span> <span class="main">!</span> <span class="bound">n</span><span class="main">)</span><span class="main">}</span><span class="main">)</span> <span class="main">(</span>theFTOne <span class="free">dl</span> <span class="free">cl</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> BrnFT_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> sum.UNION_disjoint<span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> theFTOne_def theFT_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">force</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">clarify</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> brnL_Int<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> l <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span>
    sum
      <span class="main">(</span><span class="main">%</span><span class="bound">n</span><span class="main">.</span> sum <span class="var">?wP</span> <span class="main">{</span>brnL <span class="free">dl</span> <span class="bound">n</span><span class="main">..&lt;+</span> brn <span class="main">(</span><span class="free">dl</span> <span class="main">!</span> <span class="bound">n</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>
      <span class="main">(</span><span class="main">(</span>theFT <span class="free">cl</span> <span class="main">-</span> theFT <span class="free">dl</span><span class="main">)</span> <span class="main">∪</span> theFT <span class="free">dl</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> theFTOne_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Un_Diff_cancel2 Un_commute<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span>
    sum
      <span class="main">(</span><span class="main">%</span><span class="bound">n</span><span class="main">.</span> sum <span class="var">?wP</span> <span class="main">{</span>brnL <span class="free">dl</span> <span class="bound">n</span><span class="main">..&lt;+</span>brn <span class="main">(</span><span class="free">dl</span> <span class="main">!</span> <span class="bound">n</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>
      <span class="main">(</span>theFT <span class="free">cl</span> <span class="main">-</span> theFT <span class="free">dl</span><span class="main">)</span> <span class="main">+</span>
    sum
      <span class="main">(</span><span class="main">%</span><span class="bound">n</span><span class="main">.</span> sum <span class="var">?wP</span> <span class="main">{</span>brnL <span class="free">dl</span> <span class="bound">n</span><span class="main">..&lt;+</span>brn <span class="main">(</span><span class="free">dl</span> <span class="main">!</span> <span class="bound">n</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>
      <span class="main">(</span>theFT <span class="free">dl</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="var">?L</span> <span class="main">+</span> <span class="var">?R</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> sum.union_disjoint<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?R</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> sum.neutral<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> cldl nf <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum <span class="var">?wP</span> <span class="var">?JJ_0</span> <span class="main">=</span> <span class="var">?L</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">=</span>
    sum
      <span class="main">(</span><span class="main">%</span><span class="bound">n</span><span class="main">.</span> <span class="var">?wS</span> <span class="bound">n</span> <span class="main">/</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="var">?wSF</span><span class="main">)</span> <span class="main">*</span> sum <span class="main">(</span><span class="var">?w</span> <span class="bound">n</span><span class="main">)</span> <span class="main">{..&lt;</span> brn <span class="main">(</span><span class="free">dl</span> <span class="main">!</span> <span class="bound">n</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>
      <span class="main">(</span>theFT <span class="free">cl</span> <span class="main">-</span> theFT <span class="free">dl</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">intro</span> sum.cong<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> cldl nf
    <span class="keyword1"><span class="command">using</span></span> theFT_theNFT sum_wt_ParT_notWtFT_notFinished<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">dl</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span>
    sum
      <span class="main">(</span><span class="main">%</span><span class="bound">n</span><span class="main">.</span> <span class="var">?wS</span> <span class="bound">n</span> <span class="main">*</span> sum <span class="main">(</span><span class="var">?w</span> <span class="bound">n</span><span class="main">)</span> <span class="main">{..&lt;</span> brn <span class="main">(</span><span class="free">dl</span> <span class="main">!</span> <span class="bound">n</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>
      <span class="main">(</span>theFT <span class="free">cl</span> <span class="main">-</span> theFT <span class="free">dl</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="var">?wSF</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="var">?L</span> <span class="main">/</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="var">?wSF</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> times_divide_eq_left sum_divide_distrib <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">=</span> sum <span class="var">?wS</span> <span class="main">(</span>theFT <span class="free">cl</span> <span class="main">-</span> theFT <span class="free">dl</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">intro</span> sum.cong<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"sum <span class="var">?wP</span> <span class="var">?JJ_0</span> <span class="main">=</span> <span class="main">(</span>sum <span class="var">?wS</span> <span class="main">(</span>theFT <span class="free">cl</span> <span class="main">-</span> theFT <span class="free">dl</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="var">?wSF</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="var">?L</span> <span class="main">/</span> <span class="var">?R</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">=</span> sum <span class="var">?wS</span> <span class="main">(</span>theFTOne <span class="free">dl</span> <span class="free">cl</span><span class="main">)</span> <span class="main">-</span> <span class="var">?wSF</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> eq_diff_eq WtFT_def theFTOne
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> sum.union_disjoint<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> sym<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> wPJJ0<span class="main">:</span> <span class="quoted"><span class="quoted">"sum <span class="var">?wP</span> <span class="var">?JJ_0</span> <span class="main">=</span>
    <span class="main">(</span>sum <span class="var">?wS</span> <span class="main">(</span>theFTOne <span class="free">dl</span> <span class="free">cl</span><span class="main">)</span> <span class="main">-</span> <span class="var">?wSF</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="var">?wSF</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="comment1">(*  *)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum <span class="var">?vP</span> <span class="free">II</span> <span class="main">/</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> sum <span class="var">?vP</span> <span class="var">?II_0</span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="var">?vS</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="var">?vSF</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>sum <span class="main">(</span><span class="var">?v</span> <span class="skolem">n</span><span class="main">)</span> <span class="skolem">I</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> sum <span class="var">?vP</span> <span class="var">?II_0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> II <span class="keyword1"><span class="command">using</span></span> n nf cldl I_sub <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span>
    <span class="main">(</span><span class="var">?vS</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>sum <span class="main">(</span><span class="var">?v</span> <span class="skolem">n</span><span class="main">)</span> <span class="skolem">I</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> sum <span class="var">?vS</span> <span class="main">(</span>theFTOne <span class="free">cl</span> <span class="free">dl</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> nf<span class="main">(</span>1<span class="main">)</span> vPII0 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> triv_div_mult<span class="main">)</span> <span class="main">(</span><span class="operator">insert</span> le1<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span>
    <span class="main">(</span><span class="var">?wS</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>sum <span class="main">(</span><span class="var">?w</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span><span class="free">F</span> <span class="skolem">n</span> <span class="skolem">I</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> sum <span class="var">?wS</span> <span class="main">(</span>theFTOne <span class="free">dl</span> <span class="free">cl</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> n vSwS<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">]</span> sw<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">n</span></span> <span class="quoted"><span class="skolem">I</span></span><span class="main">]</span> I <span class="keyword1"><span class="command">unfolding</span></span> sum_vS_wS <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span>
    <span class="main">(</span><span class="var">?wS</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="var">?wSF</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>sum <span class="main">(</span><span class="var">?w</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span><span class="free">F</span> <span class="skolem">n</span> <span class="skolem">I</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> sum <span class="var">?wP</span> <span class="var">?JJ_0</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> nf<span class="main">(</span>2<span class="main">)</span> wPJJ0 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> triv_div_mult<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> sym<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">insert</span> le1<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> sum <span class="var">?wP</span> <span class="var">?JJ</span> <span class="main">/</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> sum <span class="var">?wP</span> <span class="var">?JJ_0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> JJ <span class="keyword1"><span class="command">using</span></span> n nf cldl FnI_sub <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* *)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">thetaZOParT</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">thetaZOParT</span> <span class="main">≡</span>
 <span class="main">{</span><span class="main">(</span>ParT <span class="bound">cl</span><span class="main">,</span> ParT <span class="bound">dl</span><span class="main">)</span> <span class="main">|</span>
    <span class="bound">cl</span> <span class="bound">dl</span><span class="main">.</span>
      properL <span class="bound">cl</span> <span class="main">∧</span> properL <span class="bound">dl</span> <span class="main">∧</span> SbisL <span class="bound">cl</span> <span class="bound">dl</span><span class="main">}</span>"</span></span>

<span class="keyword1" id="Compositionality-cont_eff_ParT_BrnFT_L"><span class="command">lemma</span></span> cont_eff_ParT_BrnFT_L<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> l<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">cl</span> <span class="main">=</span> length <span class="free">dl</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> cldl<span class="main">:</span> <span class="quoted"><span class="quoted">"properL <span class="free">cl</span>"</span></span> <span class="quoted"><span class="quoted">"properL <span class="free">dl</span>"</span></span> <span class="quoted"><span class="quoted">"SbisL <span class="free">cl</span> <span class="free">dl</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> ii<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ii</span> <span class="main">∈</span> BrnFT <span class="free">cl</span> <span class="free">dl</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> eff_cont<span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span> <span class="bound">I</span> <span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="main">⟦</span><span class="bound">n</span> <span class="main">&lt;</span> length <span class="free">cl</span><span class="main">;</span> <span class="bound">I</span> <span class="main">∈</span> <span class="free">P</span> <span class="bound">n</span><span class="main">;</span> <span class="bound">i</span> <span class="main">∈</span> <span class="bound">I</span><span class="main">;</span> <span class="bound">j</span> <span class="main">∈</span> <span class="free">F</span> <span class="bound">n</span> <span class="bound">I</span><span class="main">⟧</span> <span class="main">⟹</span>
  eff <span class="main">(</span><span class="free">cl</span><span class="main">!</span><span class="bound">n</span><span class="main">)</span> <span class="free">s</span> <span class="bound">i</span> <span class="main">≈</span> eff <span class="main">(</span><span class="free">dl</span><span class="main">!</span><span class="bound">n</span><span class="main">)</span> <span class="free">t</span> <span class="bound">j</span> <span class="main">∧</span>
  cont <span class="main">(</span><span class="free">cl</span><span class="main">!</span><span class="bound">n</span><span class="main">)</span> <span class="free">s</span> <span class="bound">i</span> <span class="keyword1">≈s</span> cont <span class="main">(</span><span class="free">dl</span><span class="main">!</span><span class="bound">n</span><span class="main">)</span> <span class="free">t</span> <span class="bound">j</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span>
<span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">≈</span> eff <span class="main">(</span>ParT <span class="free">cl</span><span class="main">)</span> <span class="free">s</span> <span class="free">ii</span> <span class="main">∧</span>
 <span class="main">(</span>cont <span class="main">(</span>ParT <span class="free">cl</span><span class="main">)</span> <span class="free">s</span> <span class="free">ii</span><span class="main">,</span> ParT <span class="free">dl</span><span class="main">)</span> <span class="main">∈</span> thetaZOParT"</span></span>
<span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?eff</span> <span class="main">∧</span> <span class="var">?cont</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?N</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"length <span class="free">cl</span>"</span></span> <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?p</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">%</span><span class="bound">n</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> length <span class="free">cl</span>"</span></span> <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ss</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">%</span><span class="bound">n</span><span class="main">.</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> ii <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> BrnFT_elim<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Local <span class="skolem">n</span> <span class="skolem">i</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">∈</span> theFTOne <span class="free">cl</span> <span class="free">dl</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> brn <span class="main">(</span><span class="free">cl</span> <span class="main">!</span> <span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ii<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ii</span> <span class="main">=</span> brnL <span class="free">cl</span> <span class="skolem">n</span> <span class="main">+</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> n <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">&lt;</span> length <span class="free">cl</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">&lt;</span> length <span class="free">dl</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> l cldl
    <span class="keyword1"><span class="command">unfolding</span></span> theFTOne_def theFT_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command">note</span></span> n <span class="main">=</span> this n
    <span class="keyword1"><span class="command">have</span></span> discr<span class="main">:</span> <span class="quoted"><span class="quoted">"discr <span class="main">(</span><span class="free">cl</span><span class="main">!</span><span class="skolem">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"finished <span class="main">(</span><span class="free">cl</span><span class="main">!</span><span class="skolem">n</span><span class="main">)</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> n cldl discr_finished <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"finished <span class="main">(</span><span class="free">dl</span><span class="main">!</span><span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> n <span class="keyword1"><span class="command">unfolding</span></span> theFTOne_def theFT_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"proper <span class="main">(</span><span class="free">cl</span><span class="main">!</span><span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"proper <span class="main">(</span><span class="free">dl</span><span class="main">!</span><span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">cl</span><span class="main">!</span><span class="skolem">n</span> <span class="main">≈01</span> <span class="free">dl</span><span class="main">!</span><span class="skolem">n</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> n cldl <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> ZObis_finished_discr_L <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">hence</span></span> eff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?ss</span> <span class="skolem">n</span> <span class="main">≈</span> eff <span class="main">(</span><span class="free">cl</span><span class="main">!</span><span class="skolem">n</span><span class="main">)</span> <span class="main">(</span><span class="var">?ss</span> <span class="skolem">n</span><span class="main">)</span> <span class="skolem">i</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> cont<span class="main">:</span> <span class="quoted"><span class="quoted">"proper <span class="main">(</span>cont <span class="main">(</span><span class="free">cl</span><span class="main">!</span><span class="skolem">n</span><span class="main">)</span> <span class="main">(</span><span class="var">?ss</span> <span class="skolem">n</span><span class="main">)</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">∧</span> discr <span class="main">(</span>cont <span class="main">(</span><span class="free">cl</span><span class="main">!</span><span class="skolem">n</span><span class="main">)</span> <span class="main">(</span><span class="var">?ss</span> <span class="skolem">n</span><span class="main">)</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> i cldl n <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">≈</span> eff <span class="main">(</span><span class="free">cl</span><span class="main">!</span><span class="skolem">n</span><span class="main">)</span> <span class="main">(</span><span class="var">?ss</span> <span class="skolem">n</span><span class="main">)</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> eff n indis_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?eff</span></span></span> <span class="keyword1"><span class="command">using</span></span> i n cldl <span class="keyword1"><span class="command">unfolding</span></span> ii <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cont <span class="main">(</span><span class="free">cl</span><span class="main">!</span><span class="skolem">n</span><span class="main">)</span> <span class="main">(</span><span class="var">?ss</span> <span class="skolem">n</span><span class="main">)</span> <span class="skolem">i</span> <span class="keyword1">≈s</span> <span class="free">cl</span><span class="main">!</span><span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> discr cont cldl n <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">cl</span><span class="main">!</span><span class="skolem">n</span> <span class="keyword1">≈s</span> <span class="free">dl</span><span class="main">!</span><span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> cldl n <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cont <span class="main">(</span><span class="free">cl</span><span class="main">!</span><span class="skolem">n</span><span class="main">)</span> <span class="main">(</span><span class="var">?ss</span> <span class="skolem">n</span><span class="main">)</span> <span class="skolem">i</span> <span class="keyword1">≈s</span> <span class="free">dl</span><span class="main">!</span><span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Sbis_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?cont</span></span></span> <span class="keyword1"><span class="command">using</span></span> i n cldl <span class="keyword1"><span class="command">unfolding</span></span> ii thetaZOParT_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Compositionality-cont_eff_ParT_BrnFT_R"><span class="command">lemma</span></span> cont_eff_ParT_BrnFT_R<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> l<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">cl</span> <span class="main">=</span> length <span class="free">dl</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> cldl<span class="main">:</span> <span class="quoted"><span class="quoted">"properL <span class="free">cl</span>"</span></span> <span class="quoted"><span class="quoted">"properL <span class="free">dl</span>"</span></span> <span class="quoted"><span class="quoted">"SbisL <span class="free">cl</span> <span class="free">dl</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> jj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">jj</span> <span class="main">∈</span> BrnFT <span class="free">dl</span> <span class="free">cl</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> eff_cont<span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span> <span class="bound">I</span> <span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="main">⟦</span><span class="bound">n</span> <span class="main">&lt;</span> length <span class="free">cl</span><span class="main">;</span> <span class="bound">I</span> <span class="main">∈</span> <span class="free">P</span> <span class="bound">n</span><span class="main">;</span> <span class="bound">i</span> <span class="main">∈</span> <span class="bound">I</span><span class="main">;</span> <span class="bound">j</span> <span class="main">∈</span> <span class="free">F</span> <span class="bound">n</span> <span class="bound">I</span><span class="main">⟧</span> <span class="main">⟹</span>
  eff <span class="main">(</span><span class="free">cl</span><span class="main">!</span><span class="bound">n</span><span class="main">)</span> <span class="free">s</span> <span class="bound">i</span> <span class="main">≈</span> eff <span class="main">(</span><span class="free">dl</span><span class="main">!</span><span class="bound">n</span><span class="main">)</span> <span class="free">t</span> <span class="bound">j</span> <span class="main">∧</span> cont <span class="main">(</span><span class="free">cl</span><span class="main">!</span><span class="bound">n</span><span class="main">)</span> <span class="free">s</span> <span class="bound">i</span> <span class="keyword1">≈s</span> cont <span class="main">(</span><span class="free">dl</span><span class="main">!</span><span class="bound">n</span><span class="main">)</span> <span class="free">t</span> <span class="bound">j</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span>
<span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">≈</span> eff <span class="main">(</span>ParT <span class="free">dl</span><span class="main">)</span> <span class="free">t</span> <span class="free">jj</span> <span class="main">∧</span>
 <span class="main">(</span>ParT <span class="free">cl</span><span class="main">,</span> cont <span class="main">(</span>ParT <span class="free">dl</span><span class="main">)</span> <span class="free">t</span> <span class="free">jj</span><span class="main">)</span> <span class="main">∈</span> thetaZOParT"</span></span>
<span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?eff</span> <span class="main">∧</span> <span class="var">?cont</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?N</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"length <span class="free">dl</span>"</span></span>  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?q</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">%</span><span class="bound">n</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span><span class="var">?N</span>"</span></span> <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?tt</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">%</span><span class="bound">n</span><span class="main">.</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> jj <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> BrnFT_elim<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Local <span class="skolem">n</span> <span class="skolem">j</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">∈</span> theFTOne <span class="free">dl</span> <span class="free">cl</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> brn <span class="main">(</span><span class="free">dl</span> <span class="main">!</span> <span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> jj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">jj</span> <span class="main">=</span> brnL <span class="free">dl</span> <span class="skolem">n</span> <span class="main">+</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> n <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">&lt;</span> length <span class="free">cl</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">&lt;</span> length <span class="free">dl</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> l cldl
    <span class="keyword1"><span class="command">unfolding</span></span> theFTOne_def theFT_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command">note</span></span> n <span class="main">=</span> this n
    <span class="keyword1"><span class="command">have</span></span> discr<span class="main">:</span> <span class="quoted"><span class="quoted">"discr <span class="main">(</span><span class="free">dl</span><span class="main">!</span><span class="skolem">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"finished <span class="main">(</span><span class="free">dl</span><span class="main">!</span><span class="skolem">n</span><span class="main">)</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> n cldl discr_finished <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"finished <span class="main">(</span><span class="free">cl</span><span class="main">!</span><span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> n <span class="keyword1"><span class="command">unfolding</span></span> theFTOne_def theFT_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"proper <span class="main">(</span><span class="free">cl</span><span class="main">!</span><span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"proper <span class="main">(</span><span class="free">dl</span><span class="main">!</span><span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">cl</span><span class="main">!</span><span class="skolem">n</span> <span class="main">≈01</span> <span class="free">dl</span><span class="main">!</span><span class="skolem">n</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> n cldl <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> ZObis_finished_discr_R <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">hence</span></span> eff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?tt</span> <span class="skolem">n</span> <span class="main">≈</span> eff <span class="main">(</span><span class="free">dl</span><span class="main">!</span><span class="skolem">n</span><span class="main">)</span> <span class="main">(</span><span class="var">?tt</span> <span class="skolem">n</span><span class="main">)</span> <span class="skolem">j</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> cont<span class="main">:</span> <span class="quoted"><span class="quoted">"proper <span class="main">(</span>cont <span class="main">(</span><span class="free">dl</span><span class="main">!</span><span class="skolem">n</span><span class="main">)</span> <span class="main">(</span><span class="var">?tt</span> <span class="skolem">n</span><span class="main">)</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">∧</span> discr <span class="main">(</span>cont <span class="main">(</span><span class="free">dl</span><span class="main">!</span><span class="skolem">n</span><span class="main">)</span> <span class="main">(</span><span class="var">?tt</span> <span class="skolem">n</span><span class="main">)</span> <span class="skolem">j</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> j cldl n <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">≈</span> eff <span class="main">(</span><span class="free">dl</span><span class="main">!</span><span class="skolem">n</span><span class="main">)</span> <span class="main">(</span><span class="var">?tt</span> <span class="skolem">n</span><span class="main">)</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> eff n indis_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?eff</span></span></span> <span class="keyword1"><span class="command">using</span></span> j n cldl <span class="keyword1"><span class="command">unfolding</span></span> jj <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">cl</span><span class="main">!</span><span class="skolem">n</span> <span class="keyword1">≈s</span> <span class="free">dl</span><span class="main">!</span><span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> cldl n <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">dl</span><span class="main">!</span><span class="skolem">n</span> <span class="keyword1">≈s</span> cont <span class="main">(</span><span class="free">dl</span><span class="main">!</span><span class="skolem">n</span><span class="main">)</span> <span class="main">(</span><span class="var">?tt</span> <span class="skolem">n</span><span class="main">)</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> discr cont cldl n <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">cl</span><span class="main">!</span><span class="skolem">n</span> <span class="keyword1">≈s</span> cont <span class="main">(</span><span class="free">dl</span><span class="main">!</span><span class="skolem">n</span><span class="main">)</span> <span class="main">(</span><span class="var">?tt</span> <span class="skolem">n</span><span class="main">)</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Sbis_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?cont</span></span></span> <span class="keyword1"><span class="command">using</span></span> j n cldl <span class="keyword1"><span class="command">unfolding</span></span> jj thetaZOParT_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Compositionality-cont_eff_ParT_UNlift01"><span class="command">lemma</span></span> cont_eff_ParT_UNlift01<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> l<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">cl</span> <span class="main">=</span> length <span class="free">dl</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> cldl<span class="main">:</span> <span class="quoted"><span class="quoted">"properL <span class="free">cl</span>"</span></span> <span class="quoted"><span class="quoted">"properL <span class="free">dl</span>"</span></span> <span class="quoted"><span class="quoted">"SbisL <span class="free">cl</span> <span class="free">dl</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> II<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">II</span> <span class="main">∈</span> UNpart01 <span class="free">cl</span> <span class="free">dl</span> <span class="free">P</span> <span class="main">-</span> <span class="main">{</span>BrnFT <span class="free">cl</span> <span class="free">dl</span><span class="main">}</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> ii<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ii</span> <span class="main">∈</span> <span class="free">II</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> jj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">jj</span> <span class="main">∈</span> UNlift01 <span class="free">cl</span> <span class="free">dl</span> <span class="free">P</span> <span class="free">F</span> <span class="free">II</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> P<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> length <span class="free">cl</span> <span class="main">⟹</span> part <span class="main">{..&lt;</span> brn <span class="main">(</span><span class="free">cl</span><span class="main">!</span><span class="bound">n</span><span class="main">)</span><span class="main">}</span> <span class="main">(</span><span class="free">P</span> <span class="bound">n</span><span class="main">)</span> <span class="main">∧</span> <span class="main">{}</span> <span class="main">∉</span> <span class="free">P</span> <span class="bound">n</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> FP<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> length <span class="free">dl</span> <span class="main">⟹</span> part <span class="main">{..&lt;</span> brn <span class="main">(</span><span class="free">dl</span><span class="main">!</span><span class="bound">n</span><span class="main">)</span><span class="main">}</span> <span class="main">(</span><span class="free">F</span> <span class="bound">n</span> <span class="main">`</span> <span class="main">(</span><span class="free">P</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> eff_cont<span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span> <span class="bound">I</span> <span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="main">⟦</span><span class="bound">n</span> <span class="main">&lt;</span> length <span class="free">cl</span><span class="main">;</span> <span class="bound">I</span> <span class="main">∈</span> <span class="free">P</span> <span class="bound">n</span><span class="main">;</span> <span class="bound">i</span> <span class="main">∈</span> <span class="bound">I</span><span class="main">;</span> <span class="bound">j</span> <span class="main">∈</span> <span class="free">F</span> <span class="bound">n</span> <span class="bound">I</span><span class="main">⟧</span> <span class="main">⟹</span>
  eff <span class="main">(</span><span class="free">cl</span><span class="main">!</span><span class="bound">n</span><span class="main">)</span> <span class="free">s</span> <span class="bound">i</span> <span class="main">≈</span>
  eff <span class="main">(</span><span class="free">dl</span><span class="main">!</span><span class="bound">n</span><span class="main">)</span> <span class="free">t</span> <span class="bound">j</span> <span class="main">∧</span>
  cont <span class="main">(</span><span class="free">cl</span><span class="main">!</span><span class="bound">n</span><span class="main">)</span> <span class="free">s</span> <span class="bound">i</span> <span class="keyword1">≈s</span>
  cont <span class="main">(</span><span class="free">dl</span><span class="main">!</span><span class="bound">n</span><span class="main">)</span> <span class="free">t</span> <span class="bound">j</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> st<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">≈</span> <span class="free">t</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span>
<span class="quoted"><span class="quoted">"eff <span class="main">(</span>ParT <span class="free">cl</span><span class="main">)</span> <span class="free">s</span> <span class="free">ii</span> <span class="main">≈</span> eff <span class="main">(</span>ParT <span class="free">dl</span><span class="main">)</span> <span class="free">t</span> <span class="free">jj</span> <span class="main">∧</span>
 <span class="main">(</span>cont <span class="main">(</span>ParT <span class="free">cl</span><span class="main">)</span> <span class="free">s</span> <span class="free">ii</span><span class="main">,</span> cont <span class="main">(</span>ParT <span class="free">dl</span><span class="main">)</span> <span class="free">t</span> <span class="free">jj</span><span class="main">)</span> <span class="main">∈</span> thetaZOParT"</span></span>
<span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?eff</span> <span class="main">∧</span> <span class="var">?cont</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?N</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"length <span class="free">cl</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?p</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">%</span><span class="bound">n</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> <span class="var">?N</span>"</span></span> <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?q</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">%</span><span class="bound">n</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> <span class="main">(</span>length <span class="free">dl</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ss</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">%</span><span class="bound">n</span><span class="main">.</span> <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?tt</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">%</span><span class="bound">n</span><span class="main">.</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> sstt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> <span class="var">?N</span> <span class="main">⟹</span> <span class="var">?ss</span> <span class="bound">n</span> <span class="main">≈</span> <span class="var">?tt</span> <span class="bound">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> st l <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> pq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> <span class="var">?N</span> <span class="main">⟹</span> <span class="var">?p</span> <span class="bound">n</span> <span class="main">=</span> <span class="var">?q</span> <span class="bound">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> sstt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> <span class="var">?N</span> <span class="main">⟹</span> <span class="var">?ss</span> <span class="bound">n</span> <span class="main">≈</span> <span class="var">?tt</span> <span class="bound">n</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms l <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> II<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">II</span> <span class="main">∈</span> UNpart1 <span class="free">cl</span> <span class="free">dl</span> <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> II l P UNpart1_UNpart01 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> UNpart1_cases<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Local <span class="skolem">n</span> <span class="skolem">I</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">&lt;</span> <span class="var">?N</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">&lt;</span> length <span class="free">dl</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">∈</span> theNFTBoth <span class="free">cl</span> <span class="free">dl</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">¬</span> finished <span class="main">(</span><span class="free">cl</span><span class="main">!</span><span class="skolem">n</span><span class="main">)</span>"</span></span>  <span class="quoted"><span class="quoted">"<span class="main">¬</span> finished <span class="main">(</span><span class="free">dl</span><span class="main">!</span><span class="skolem">n</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">I</span> <span class="main">∈</span> <span class="free">P</span> <span class="skolem">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> II<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">II</span> <span class="main">=</span> shift <span class="free">cl</span> <span class="skolem">n</span> <span class="skolem">I</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> l <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> ii II <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="skolem">I</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ii<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ii</span> <span class="main">=</span> brnL <span class="free">cl</span> <span class="skolem">n</span> <span class="main">+</span> <span class="skolem">i</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> shift_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> brn <span class="main">(</span><span class="free">cl</span><span class="main">!</span><span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> i I n P <span class="keyword1"><span class="command">unfolding</span></span> part_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> <span class="keyword1"><span class="command">note</span></span> i <span class="main">=</span> this i
    <span class="keyword1"><span class="command">have</span></span> jj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">jj</span> <span class="main">∈</span> shift <span class="free">dl</span> <span class="skolem">n</span> <span class="main">(</span><span class="free">F</span> <span class="skolem">n</span> <span class="skolem">I</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> jj P n I l <span class="keyword1"><span class="command">unfolding</span></span> II <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> jj II <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∈</span> <span class="free">F</span> <span class="skolem">n</span> <span class="skolem">I</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> jj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">jj</span> <span class="main">=</span> brnL <span class="free">dl</span> <span class="skolem">n</span> <span class="main">+</span> <span class="skolem">j</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> shift_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> brn <span class="main">(</span><span class="free">dl</span><span class="main">!</span><span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> j I n FP <span class="keyword1"><span class="command">unfolding</span></span> part_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> <span class="keyword1"><span class="command">note</span></span> j <span class="main">=</span> this j
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eff <span class="main">(</span><span class="free">cl</span><span class="main">!</span><span class="skolem">n</span><span class="main">)</span> <span class="main">(</span><span class="var">?ss</span> <span class="skolem">n</span><span class="main">)</span> <span class="skolem">i</span> <span class="main">≈</span> eff <span class="main">(</span><span class="free">dl</span><span class="main">!</span><span class="skolem">n</span><span class="main">)</span> <span class="main">(</span><span class="var">?tt</span> <span class="skolem">n</span><span class="main">)</span> <span class="skolem">j</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> n I i j eff_cont <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?eff</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> ii jj <span class="keyword1"><span class="command">using</span></span> st cldl n i j <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"cont <span class="main">(</span><span class="free">cl</span><span class="main">!</span><span class="skolem">n</span><span class="main">)</span> <span class="main">(</span><span class="var">?ss</span> <span class="skolem">n</span><span class="main">)</span> <span class="skolem">i</span> <span class="keyword1">≈s</span> cont <span class="main">(</span><span class="free">dl</span><span class="main">!</span><span class="skolem">n</span><span class="main">)</span> <span class="main">(</span><span class="var">?tt</span> <span class="skolem">n</span><span class="main">)</span> <span class="skolem">j</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> n I i j eff_cont <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>cont <span class="main">(</span>ParT <span class="free">cl</span><span class="main">)</span> <span class="free">s</span> <span class="free">ii</span><span class="main">,</span> cont <span class="main">(</span>ParT <span class="free">dl</span><span class="main">)</span> <span class="free">t</span> <span class="free">jj</span><span class="main">)</span> <span class="main">=</span>
            <span class="main">(</span>ParT <span class="main">(</span><span class="free">cl</span><span class="main">[</span><span class="skolem">n</span> <span class="main">:=</span> cont <span class="main">(</span><span class="free">cl</span> <span class="main">!</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span><span class="var">?ss</span> <span class="skolem">n</span><span class="main">)</span> <span class="skolem">i</span><span class="main">]</span><span class="main">)</span><span class="main">,</span>
              ParT <span class="main">(</span><span class="free">dl</span><span class="main">[</span><span class="skolem">n</span> <span class="main">:=</span> cont <span class="main">(</span><span class="free">dl</span> <span class="main">!</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span><span class="var">?tt</span> <span class="skolem">n</span><span class="main">)</span> <span class="skolem">j</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?A</span> <span class="main">=</span> <span class="var">?B</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">unfolding</span></span> ii jj <span class="keyword1"><span class="command">using</span></span> n i j cldl <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?B</span> <span class="main">∈</span> thetaZOParT"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> thetaZOParT_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">intro</span> properL_update<span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> cldl <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> proper_cont<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> cldl i n <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">force</span><span class="main"><span class="keyword3">,</span></span><span class="operator">force</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">intro</span> properL_update<span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> cldl <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> proper_cont<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> cldl j n <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">force</span><span class="main"><span class="keyword3">,</span></span><span class="operator">force</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">intro</span> SbisL_update<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> 1 cldl n i <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">force</span><span class="main"><span class="keyword3">,</span></span><span class="operator">force</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?cont</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Compositionality-thetaZOParT_ZOretr"><span class="command">lemma</span></span> thetaZOParT_ZOretr<span class="main">:</span> <span class="quoted"><span class="quoted">"thetaZOParT <span class="main">⊆</span> ZOretr <span class="main">(</span>thetaZOParT<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> ZOretr_def matchC_LC_def <span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">c</span> <span class="skolem">d</span> <span class="skolem">s</span> <span class="skolem">t</span>
  <span class="keyword3"><span class="command">assume</span></span> c_d<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">c</span><span class="main">,</span> <span class="skolem">d</span><span class="main">)</span> <span class="main">∈</span> thetaZOParT"</span></span> <span class="keyword2"><span class="keyword">and</span></span> st<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">≈</span> <span class="skolem">t</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">cl</span></span> <span class="skolem"><span class="skolem">dl</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">=</span> ParT <span class="skolem">cl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> d<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">=</span> ParT <span class="skolem">dl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  cldl<span class="main">:</span> <span class="quoted"><span class="quoted">"properL <span class="skolem">cl</span>"</span></span> <span class="quoted"><span class="quoted">"properL <span class="skolem">dl</span>"</span></span> <span class="quoted"><span class="quoted">"SbisL <span class="skolem">cl</span> <span class="skolem">dl</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> thetaZOParT_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?N</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"length <span class="skolem">cl</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ss</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">%</span><span class="bound">n</span><span class="main">.</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?tt</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">%</span><span class="bound">n</span><span class="main">.</span> <span class="skolem">t</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> N<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?N</span> <span class="main">=</span> length <span class="skolem">dl</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> cldl <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> sstt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> <span class="var">?N</span> <span class="main">⟹</span> <span class="var">?ss</span> <span class="bound">n</span> <span class="main">≈</span> <span class="var">?tt</span> <span class="bound">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> st N <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?phi</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">%</span><span class="bound">n</span> <span class="bound">PFn</span><span class="main">.</span> mC_C Sbis <span class="main">(</span><span class="skolem">cl</span> <span class="main">!</span> <span class="bound">n</span><span class="main">)</span> <span class="main">(</span><span class="skolem">dl</span> <span class="main">!</span> <span class="bound">n</span><span class="main">)</span> <span class="main">(</span><span class="var">?ss</span> <span class="bound">n</span><span class="main">)</span> <span class="main">(</span><span class="var">?tt</span> <span class="bound">n</span><span class="main">)</span> <span class="main">(</span>fst <span class="bound">PFn</span><span class="main">)</span> <span class="main">(</span>snd <span class="bound">PFn</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span> <span class="keyword3"><span class="command">assume</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">&lt;</span> <span class="var">?N</span>"</span></span>
   <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">cl</span> <span class="main">!</span> <span class="skolem">n</span> <span class="keyword1">≈s</span> <span class="skolem">dl</span> <span class="main">!</span> <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> cldl <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
   <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">PFn</span><span class="main">.</span> <span class="var">?phi</span> <span class="skolem">n</span> <span class="bound">PFn</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> n Sbis_mC_C sstt <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">PF</span></span> <span class="keyword2"><span class="keyword">where</span></span> phi<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> <span class="var">?N</span> <span class="main">⟹</span> <span class="var">?phi</span> <span class="bound">n</span> <span class="main">(</span><span class="skolem">PF</span> <span class="bound">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> bchoice<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">{..&lt;</span> <span class="var">?N</span><span class="main">}</span>"</span></span> <span class="var"><span class="quoted"><span class="var">?phi</span></span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">P</span></span> <span class="skolem"><span class="skolem">F</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">=</span> fst <span class="keyword1">o</span> <span class="skolem">PF</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">F</span> <span class="main">=</span> snd <span class="keyword1">o</span> <span class="skolem">PF</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> m<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> <span class="var">?N</span> <span class="main">⟹</span> mC_C Sbis <span class="main">(</span><span class="skolem">cl</span> <span class="main">!</span> <span class="bound">n</span><span class="main">)</span> <span class="main">(</span><span class="skolem">dl</span> <span class="main">!</span> <span class="bound">n</span><span class="main">)</span> <span class="main">(</span><span class="var">?ss</span> <span class="bound">n</span><span class="main">)</span> <span class="main">(</span><span class="var">?tt</span> <span class="bound">n</span><span class="main">)</span> <span class="main">(</span><span class="skolem">P</span> <span class="bound">n</span><span class="main">)</span> <span class="main">(</span><span class="skolem">F</span> <span class="bound">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> phi <span class="keyword1"><span class="command">unfolding</span></span> P_def F_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="comment1">(*  *)</span>
  <span class="keyword1"><span class="command">have</span></span> brn_c<span class="main">:</span> <span class="quoted"><span class="quoted">"brn <span class="skolem">c</span> <span class="main">=</span> brnL <span class="skolem">cl</span> <span class="var">?N</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> c <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> brn_d<span class="main">:</span> <span class="quoted"><span class="quoted">"brn <span class="skolem">d</span> <span class="main">=</span> brnL <span class="skolem">dl</span> <span class="main">(</span>length <span class="skolem">dl</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> d <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> P<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> <span class="var">?N</span> <span class="main">⟹</span> part <span class="main">{..&lt;</span> brn <span class="main">(</span><span class="skolem">cl</span> <span class="main">!</span> <span class="bound">n</span><span class="main">)</span><span class="main">}</span> <span class="main">(</span><span class="skolem">P</span> <span class="bound">n</span><span class="main">)</span> <span class="main">∧</span> <span class="main">{}</span> <span class="main">∉</span> <span class="main">(</span><span class="skolem">P</span> <span class="bound">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> m <span class="keyword1"><span class="command">unfolding</span></span> m_defsAll part_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> FP<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> length <span class="skolem">dl</span> <span class="main">⟹</span> part <span class="main">{..&lt;</span> brn <span class="main">(</span><span class="skolem">dl</span> <span class="main">!</span> <span class="bound">n</span><span class="main">)</span><span class="main">}</span> <span class="main">(</span><span class="skolem">F</span> <span class="bound">n</span> <span class="main">`</span> <span class="main">(</span><span class="skolem">P</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="main">{}</span> <span class="main">∉</span> <span class="skolem">F</span> <span class="bound">n</span> <span class="main">`</span> <span class="main">(</span><span class="skolem">P</span> <span class="bound">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> m N <span class="keyword1"><span class="command">unfolding</span></span> m_defsAll part_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> F<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> <span class="var">?N</span> <span class="main">⟹</span> inj_on <span class="main">(</span><span class="skolem">F</span> <span class="bound">n</span><span class="main">)</span> <span class="main">(</span><span class="skolem">P</span> <span class="bound">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> m <span class="keyword1"><span class="command">unfolding</span></span> m_defsAll <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> sw<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span> <span class="bound">I</span><span class="main">.</span> <span class="main">⟦</span><span class="bound">n</span> <span class="main">&lt;</span> length <span class="skolem">cl</span><span class="main">;</span> <span class="bound">I</span> <span class="main">∈</span> <span class="skolem">P</span> <span class="bound">n</span><span class="main">⟧</span> <span class="main">⟹</span>
     sum <span class="main">(</span>wt <span class="main">(</span><span class="skolem">cl</span> <span class="main">!</span> <span class="bound">n</span><span class="main">)</span> <span class="main">(</span><span class="var">?ss</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span> <span class="bound">I</span> <span class="main">=</span> sum <span class="main">(</span>wt <span class="main">(</span><span class="skolem">dl</span> <span class="main">!</span> <span class="bound">n</span><span class="main">)</span> <span class="main">(</span><span class="var">?tt</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">F</span> <span class="bound">n</span> <span class="bound">I</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> m <span class="keyword1"><span class="command">unfolding</span></span> mC_C_def mC_C_wt_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> eff_cont<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span> <span class="bound">I</span> <span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="main">⟦</span><span class="bound">n</span> <span class="main">&lt;</span> length <span class="skolem">cl</span><span class="main">;</span> <span class="bound">I</span> <span class="main">∈</span> <span class="skolem">P</span> <span class="bound">n</span><span class="main">;</span> <span class="bound">i</span> <span class="main">∈</span> <span class="bound">I</span><span class="main">;</span> <span class="bound">j</span> <span class="main">∈</span> <span class="skolem">F</span> <span class="bound">n</span> <span class="bound">I</span><span class="main">⟧</span> <span class="main">⟹</span>
     eff <span class="main">(</span><span class="skolem">cl</span><span class="main">!</span><span class="bound">n</span><span class="main">)</span> <span class="main">(</span><span class="var">?ss</span> <span class="bound">n</span><span class="main">)</span> <span class="bound">i</span> <span class="main">≈</span> eff <span class="main">(</span><span class="skolem">dl</span><span class="main">!</span><span class="bound">n</span><span class="main">)</span> <span class="main">(</span><span class="var">?tt</span> <span class="bound">n</span><span class="main">)</span> <span class="bound">j</span> <span class="main">∧</span> cont <span class="main">(</span><span class="skolem">cl</span><span class="main">!</span><span class="bound">n</span><span class="main">)</span> <span class="main">(</span><span class="var">?ss</span> <span class="bound">n</span><span class="main">)</span> <span class="bound">i</span> <span class="keyword1">≈s</span> cont <span class="main">(</span><span class="skolem">dl</span><span class="main">!</span><span class="bound">n</span><span class="main">)</span> <span class="main">(</span><span class="var">?tt</span> <span class="bound">n</span><span class="main">)</span> <span class="bound">j</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> m <span class="keyword1"><span class="command">unfolding</span></span> mC_C_def mC_C_eff_cont_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="comment1">(*  *)</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">II0</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">II0</span> <span class="main">=</span> BrnFT <span class="skolem">cl</span> <span class="skolem">dl</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">Q</span></span> <span class="skolem"><span class="skolem">G</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Q</span> <span class="main">=</span> UNpart01 <span class="skolem">cl</span> <span class="skolem">dl</span> <span class="skolem">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">G</span> <span class="main">=</span> UNlift01 <span class="skolem">cl</span> <span class="skolem">dl</span> <span class="skolem">P</span> <span class="skolem">F</span>"</span></span>
  <span class="keyword1"><span class="command">note</span></span> defi <span class="main">=</span> II0_def Q_def G_def brn_c brn_d
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">II0</span> <span class="bound">Q</span> <span class="bound">G</span><span class="main">.</span> mC_ZOC <span class="main">(</span>thetaZOParT<span class="main">)</span> <span class="skolem">c</span> <span class="skolem">d</span> <span class="skolem">s</span> <span class="skolem">t</span> <span class="bound">II0</span> <span class="bound">Q</span> <span class="bound">G</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">II0</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">Q</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">G</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> mC_ZOC_def <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"mC_ZOC_part <span class="skolem">c</span> <span class="skolem">d</span> <span class="skolem">s</span> <span class="skolem">t</span> <span class="skolem">II0</span> <span class="skolem">Q</span> <span class="skolem">G</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> mC_ZOC_part_def <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{}</span> <span class="main">∉</span> <span class="skolem">Q</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">II0</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> defi <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> emp_UNpart01<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> P <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{}</span> <span class="main">∉</span> <span class="skolem">G</span> <span class="main">`</span> <span class="main">(</span><span class="skolem">Q</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">II0</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> defi
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> emp_UNlift01_UNpart01<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> N P FP <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">II0</span> <span class="main">∈</span> <span class="skolem">Q</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> defi <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"part <span class="main">{..&lt;</span>brn <span class="skolem">c</span><span class="main">}</span> <span class="skolem">Q</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> defi <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> part_UNpart01<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> cldl P <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"part <span class="main">{..&lt;</span>brn <span class="skolem">d</span><span class="main">}</span> <span class="main">(</span><span class="skolem">G</span> <span class="main">`</span> <span class="skolem">Q</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> defi <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> part_UNlift01_UNpart01<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> N cldl P FP <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="skolem">G</span> <span class="skolem">Q</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> defi <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> UNlift01_inj_on<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> N P FP F <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"mC_ZOC_wt <span class="skolem">c</span> <span class="skolem">d</span> <span class="skolem">s</span> <span class="skolem">t</span> <span class="skolem">II0</span> <span class="skolem">Q</span> <span class="skolem">G</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> mC_ZOC_wt_def <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> impI ballI<span class="main"><span class="keyword3">,</span></span> <span class="operator">elim</span> conjE<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">II</span> <span class="keyword3"><span class="command">assume</span></span> II<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">II</span> <span class="main">∈</span> <span class="skolem">Q</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">II0</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      le1<span class="main">:</span> <span class="quoted"><span class="quoted">"sum <span class="main">(</span>wt <span class="skolem">c</span> <span class="skolem">s</span><span class="main">)</span> <span class="skolem">II0</span> <span class="main">&lt;</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"sum <span class="main">(</span>wt <span class="skolem">d</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">(</span><span class="skolem">G</span> <span class="skolem">II0</span><span class="main">)</span> <span class="main">&lt;</span> <span class="main">1</span>"</span></span>
      <span class="keyword3"><span class="command">thus</span></span>
      <span class="quoted"><span class="quoted">"sum <span class="main">(</span>wt <span class="skolem">c</span> <span class="skolem">s</span><span class="main">)</span> <span class="skolem">II</span> <span class="main">/</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> sum <span class="main">(</span>wt <span class="skolem">c</span> <span class="skolem">s</span><span class="main">)</span> <span class="skolem">II0</span><span class="main">)</span> <span class="main">=</span>
       sum <span class="main">(</span>wt <span class="skolem">d</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">(</span><span class="skolem">G</span> <span class="skolem">II</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> sum <span class="main">(</span>wt <span class="skolem">d</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">(</span><span class="skolem">G</span> <span class="skolem">II0</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> c d defi UNlift01_BrnFT <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">intro</span> ss_wt_ParT_UNlift01<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> N cldl II P FP sw st <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"mC_ZOC_eff_cont0 <span class="main">(</span>thetaZOParT<span class="main">)</span> <span class="skolem">c</span> <span class="skolem">d</span> <span class="skolem">s</span> <span class="skolem">t</span> <span class="skolem">II0</span> <span class="skolem">G</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> mC_ZOC_eff_cont0_def
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">intro</span> conjI<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ballI ballI<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ii</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ii</span> <span class="main">∈</span> <span class="skolem">II0</span>"</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">≈</span> eff <span class="skolem">c</span> <span class="skolem">s</span> <span class="skolem">ii</span> <span class="main">∧</span> <span class="main">(</span>cont <span class="skolem">c</span> <span class="skolem">s</span> <span class="skolem">ii</span><span class="main">,</span> <span class="skolem">d</span><span class="main">)</span> <span class="main">∈</span> thetaZOParT"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> defi c d <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">intro</span> cont_eff_ParT_BrnFT_L<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> N cldl P FP eff_cont st <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">jj</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">jj</span> <span class="main">∈</span> <span class="skolem">G</span> <span class="skolem">II0</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">jj</span> <span class="main">∈</span> BrnFT <span class="skolem">dl</span> <span class="skolem">cl</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> defi UNlift01_BrnFT <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">≈</span> eff <span class="skolem">d</span> <span class="skolem">t</span> <span class="skolem">jj</span> <span class="main">∧</span> <span class="main">(</span><span class="skolem">c</span><span class="main">,</span> cont <span class="skolem">d</span> <span class="skolem">t</span> <span class="skolem">jj</span><span class="main">)</span> <span class="main">∈</span> thetaZOParT"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> defi c d <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">intro</span> cont_eff_ParT_BrnFT_R<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> N cldl P FP eff_cont st <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"mC_ZOC_eff_cont <span class="main">(</span>thetaZOParT<span class="main">)</span> <span class="skolem">c</span> <span class="skolem">d</span> <span class="skolem">s</span> <span class="skolem">t</span> <span class="skolem">II0</span> <span class="skolem">Q</span> <span class="skolem">G</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> mC_ZOC_eff_cont_def <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> allI impI<span class="main"><span class="keyword3">,</span></span> <span class="operator">elim</span> conjE<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">II</span> <span class="skolem">ii</span> <span class="skolem">jj</span> <span class="keyword3"><span class="command">assume</span></span> II<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">II</span> <span class="main">∈</span> <span class="skolem">Q</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">II0</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ii<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ii</span> <span class="main">∈</span> <span class="skolem">II</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> jj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">jj</span> <span class="main">∈</span> <span class="skolem">G</span> <span class="skolem">II</span>"</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"eff <span class="skolem">c</span> <span class="skolem">s</span> <span class="skolem">ii</span> <span class="main">≈</span> eff <span class="skolem">d</span> <span class="skolem">t</span> <span class="skolem">jj</span> <span class="main">∧</span> <span class="main">(</span>cont <span class="skolem">c</span> <span class="skolem">s</span> <span class="skolem">ii</span><span class="main">,</span> cont <span class="skolem">d</span> <span class="skolem">t</span> <span class="skolem">jj</span><span class="main">)</span> <span class="main">∈</span> thetaZOParT"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> defi c d <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">intro</span> cont_eff_ParT_UNlift01<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> N cldl P FP eff_cont st <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Compositionality-thetaZOParT_ZObis"><span class="command">lemma</span></span> thetaZOParT_ZObis<span class="main">:</span> <span class="quoted"><span class="quoted">"thetaZOParT <span class="main">⊆</span> ZObis"</span></span>
<span class="keyword1"><span class="command">using</span></span> ZObis_raw_coind thetaZOParT_ZOretr <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">theorem</span></span> ParT_ZObis<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"properL <span class="free">cl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"properL <span class="free">dl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"SbisL <span class="free">cl</span> <span class="free">dl</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ParT <span class="free">cl</span> <span class="main">≈01</span> ParT <span class="free">dl</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms thetaZOParT_ZObis <span class="keyword1"><span class="command">unfolding</span></span> thetaZOParT_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>


<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* context PL_Indis *)</span>
<span class="comment1">(*******************************************)</span>


<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Syntactic_Criteria">
<div class="head">
<h1>Theory Syntactic_Criteria</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Syntactic Criteria›</span></span>
<span class="keyword1"><span class="command">theory</span></span> Syntactic_Criteria
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="Compositionality.html">Compositionality</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">context</span></span> PL_Indis
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Syntactic_Criteria-proper_intros"><span class="command">lemma</span></span> proper_intros<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"proper Done"</span></span>
  <span class="quoted"><span class="quoted">"proper <span class="main">(</span>Atm <span class="free">atm</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"proper <span class="free">c1</span> <span class="main">⟹</span> proper <span class="free">c2</span> <span class="main">⟹</span> proper <span class="main">(</span>Seq <span class="free">c1</span> <span class="free">c2</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"proper <span class="free">c1</span> <span class="main">⟹</span> proper <span class="free">c2</span> <span class="main">⟹</span> proper <span class="main">(</span>Ch <span class="free">ch</span> <span class="free">c1</span> <span class="free">c2</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"proper <span class="free">c</span> <span class="main">⟹</span> proper <span class="main">(</span>While <span class="free">tst</span> <span class="free">c</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"properL <span class="free">cs</span> <span class="main">⟹</span> proper <span class="main">(</span>Par <span class="free">cs</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"properL <span class="free">cs</span> <span class="main">⟹</span> proper <span class="main">(</span>ParT <span class="free">cs</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">c</span><span class="main">.</span> <span class="bound">c</span> <span class="main">∈</span> set <span class="free">cs</span> <span class="main">⟹</span> proper <span class="bound">c</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">cs</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span> properL <span class="free">cs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Syntactic_Criteria-discr"><span class="command">lemma</span></span> discr<span class="main">:</span>
  <span class="quoted"><span class="quoted">"discr Done"</span></span>
  <span class="quoted"><span class="quoted">"presAtm <span class="free">atm</span> <span class="main">⟹</span> discr <span class="main">(</span>Atm <span class="free">atm</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"discr <span class="free">c1</span> <span class="main">⟹</span> discr <span class="free">c2</span> <span class="main">⟹</span> discr <span class="main">(</span>Seq <span class="free">c1</span> <span class="free">c2</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"discr <span class="free">c1</span> <span class="main">⟹</span> discr <span class="free">c2</span> <span class="main">⟹</span> discr <span class="main">(</span>Ch <span class="free">ch</span> <span class="free">c1</span> <span class="free">c2</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"discr <span class="free">c</span> <span class="main">⟹</span> discr <span class="main">(</span>While <span class="free">tst</span> <span class="free">c</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"properL <span class="free">cs</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">c</span><span class="main">.</span> <span class="bound">c</span> <span class="main">∈</span> set <span class="free">cs</span> <span class="main">⟹</span> discr <span class="bound">c</span><span class="main">)</span> <span class="main">⟹</span> discr <span class="main">(</span>Par <span class="free">cs</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"properL <span class="free">cs</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">c</span><span class="main">.</span> <span class="bound">c</span> <span class="main">∈</span> set <span class="free">cs</span> <span class="main">⟹</span> discr <span class="bound">c</span><span class="main">)</span> <span class="main">⟹</span> discr <span class="main">(</span>ParT <span class="free">cs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> discr_Par discr_ParT<span class="main">)</span>

<span class="keyword1" id="Syntactic_Criteria-siso"><span class="command">lemma</span></span> siso<span class="main">:</span>
  <span class="quoted"><span class="quoted">"compatAtm <span class="free">atm</span> <span class="main">⟹</span> siso <span class="main">(</span>Atm <span class="free">atm</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"siso <span class="free">c1</span> <span class="main">⟹</span> siso <span class="free">c2</span> <span class="main">⟹</span> siso <span class="main">(</span>Seq <span class="free">c1</span> <span class="free">c2</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"compatCh <span class="free">ch</span> <span class="main">⟹</span> siso <span class="free">c1</span> <span class="main">⟹</span> siso <span class="free">c2</span> <span class="main">⟹</span> siso <span class="main">(</span>Ch <span class="free">ch</span> <span class="free">c1</span> <span class="free">c2</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"compatTst <span class="free">tst</span> <span class="main">⟹</span> siso <span class="free">c</span> <span class="main">⟹</span> siso <span class="main">(</span>While <span class="free">tst</span> <span class="free">c</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"properL <span class="free">cs</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">c</span><span class="main">.</span> <span class="bound">c</span> <span class="main">∈</span> set <span class="free">cs</span> <span class="main">⟹</span> siso <span class="bound">c</span><span class="main">)</span> <span class="main">⟹</span> siso <span class="main">(</span>Par <span class="free">cs</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"properL <span class="free">cs</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">c</span><span class="main">.</span> <span class="bound">c</span> <span class="main">∈</span> set <span class="free">cs</span> <span class="main">⟹</span> siso <span class="bound">c</span><span class="main">)</span> <span class="main">⟹</span> siso <span class="main">(</span>ParT <span class="free">cs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> siso_Par siso_ParT<span class="main">)</span>

<span class="keyword1" id="Syntactic_Criteria-Sbis"><span class="command">lemma</span></span> Sbis<span class="main">:</span>
  <span class="quoted"><span class="quoted">"compatAtm <span class="free">atm</span> <span class="main">⟹</span> Atm <span class="free">atm</span> <span class="keyword1">≈s</span> Atm <span class="free">atm</span>"</span></span>
  <span class="quoted"><span class="quoted">"siso <span class="free">c1</span> <span class="main">⟹</span> <span class="free">c2</span> <span class="keyword1">≈s</span> <span class="free">c2</span> <span class="main">⟹</span> Seq <span class="free">c1</span> <span class="free">c2</span> <span class="keyword1">≈s</span> Seq <span class="free">c1</span> <span class="free">c2</span>"</span></span>
  <span class="quoted"><span class="quoted">"proper <span class="free">c1</span> <span class="main">⟹</span> proper <span class="free">c2</span> <span class="main">⟹</span> <span class="free">c1</span> <span class="keyword1">≈s</span> <span class="free">c1</span> <span class="main">⟹</span> discr <span class="free">c2</span> <span class="main">⟹</span> Seq <span class="free">c1</span> <span class="free">c2</span> <span class="keyword1">≈s</span> Seq <span class="free">c1</span> <span class="free">c2</span>"</span></span>
  <span class="quoted"><span class="quoted">"compatCh <span class="free">ch</span> <span class="main">⟹</span> <span class="free">c1</span> <span class="keyword1">≈s</span> <span class="free">c1</span> <span class="main">⟹</span> <span class="free">c2</span> <span class="keyword1">≈s</span> <span class="free">c2</span> <span class="main">⟹</span> Ch <span class="free">ch</span> <span class="free">c1</span> <span class="free">c2</span> <span class="keyword1">≈s</span> Ch <span class="free">ch</span> <span class="free">c1</span> <span class="free">c2</span>"</span></span>
  <span class="quoted"><span class="quoted">"properL <span class="free">cs</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">c</span><span class="main">.</span> <span class="bound">c</span> <span class="main">∈</span> set <span class="free">cs</span> <span class="main">⟹</span> <span class="bound">c</span> <span class="keyword1">≈s</span> <span class="bound">c</span><span class="main">)</span> <span class="main">⟹</span> Par <span class="free">cs</span> <span class="keyword1">≈s</span> Par <span class="free">cs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Par_Sbis<span class="main">)</span>

<span class="keyword1" id="Syntactic_Criteria-ZObis"><span class="command">lemma</span></span> ZObis<span class="main">:</span>
  <span class="quoted"><span class="quoted">"compatAtm <span class="free">atm</span> <span class="main">⟹</span> Atm <span class="free">atm</span> <span class="main">≈01</span> Atm <span class="free">atm</span>"</span></span>
  <span class="quoted"><span class="quoted">"siso <span class="free">c1</span> <span class="main">⟹</span> <span class="free">c2</span> <span class="main">≈01</span> <span class="free">c2</span> <span class="main">⟹</span> Seq <span class="free">c1</span> <span class="free">c2</span> <span class="main">≈01</span> Seq <span class="free">c1</span> <span class="free">c2</span>"</span></span>
  <span class="quoted"><span class="quoted">"proper <span class="free">c1</span> <span class="main">⟹</span> proper <span class="free">c2</span> <span class="main">⟹</span> <span class="free">c1</span> <span class="main">≈01</span> <span class="free">c1</span> <span class="main">⟹</span> discr <span class="free">c2</span> <span class="main">⟹</span> Seq <span class="free">c1</span> <span class="free">c2</span> <span class="main">≈01</span> Seq <span class="free">c1</span> <span class="free">c2</span>"</span></span>
  <span class="quoted"><span class="quoted">"compatCh <span class="free">ch</span> <span class="main">⟹</span> <span class="free">c1</span> <span class="main">≈01</span> <span class="free">c1</span> <span class="main">⟹</span> <span class="free">c2</span> <span class="main">≈01</span> <span class="free">c2</span> <span class="main">⟹</span> Ch <span class="free">ch</span> <span class="free">c1</span> <span class="free">c2</span> <span class="main">≈01</span> Ch <span class="free">ch</span> <span class="free">c1</span> <span class="free">c2</span>"</span></span>
  <span class="quoted"><span class="quoted">"properL <span class="free">cs</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">c</span><span class="main">.</span> <span class="bound">c</span> <span class="main">∈</span> set <span class="free">cs</span> <span class="main">⟹</span> <span class="bound">c</span> <span class="keyword1">≈s</span> <span class="bound">c</span><span class="main">)</span> <span class="main">⟹</span> ParT <span class="free">cs</span> <span class="main">≈01</span> ParT <span class="free">cs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ParT_ZObis<span class="main">)</span>

<span class="keyword1" id="Syntactic_Criteria-discr_imp_Sbis"><span class="command">lemma</span></span> discr_imp_Sbis<span class="main">:</span> <span class="quoted"><span class="quoted">"proper <span class="free">c</span> <span class="main">⟹</span> discr <span class="free">c</span> <span class="main">⟹</span> <span class="free">c</span> <span class="keyword1">≈s</span> <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Syntactic_Criteria-siso_imp_Sbis"><span class="command">lemma</span></span> siso_imp_Sbis<span class="main">:</span> <span class="quoted"><span class="quoted">"siso <span class="free">c</span> <span class="main">⟹</span> <span class="free">c</span> <span class="keyword1">≈s</span> <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Syntactic_Criteria-Sbis_imp_ZObis"><span class="command">lemma</span></span> Sbis_imp_ZObis<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="keyword1">≈s</span> <span class="free">c</span> <span class="main">⟹</span> <span class="free">c</span> <span class="main">≈01</span> <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>


<span class="comment1">(* The syntactic predicates: SC_φ corresponds to the paper's overlined φ: *)</span> 

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">SC_discr</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">SC_discr</span> Done          <span class="main">⟷</span> True"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">SC_discr</span> <span class="main">(</span>Atm <span class="free"><span class="bound"><span class="entity">atm</span></span></span><span class="main">)</span>     <span class="main">⟷</span> presAtm <span class="free"><span class="bound"><span class="entity">atm</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">SC_discr</span> <span class="main">(</span>Seq <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span><span class="main">)</span>   <span class="main">⟷</span> <span class="free">SC_discr</span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="main">∧</span> <span class="free">SC_discr</span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">SC_discr</span> <span class="main">(</span>Ch <span class="free"><span class="bound"><span class="entity">ch</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span><span class="main">)</span> <span class="main">⟷</span> <span class="free">SC_discr</span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="main">∧</span> <span class="free">SC_discr</span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">SC_discr</span> <span class="main">(</span>While <span class="free"><span class="bound"><span class="entity">tst</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="main">⟷</span> <span class="free">SC_discr</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">SC_discr</span> <span class="main">(</span>ParT <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">c</span><span class="main">∈</span>set <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">.</span> <span class="free">SC_discr</span> <span class="bound">c</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">SC_discr</span> <span class="main">(</span>Par <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">)</span>  <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">c</span><span class="main">∈</span>set <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">.</span> <span class="free">SC_discr</span> <span class="bound">c</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">theorem</span></span> SC_discr_discr<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"proper <span class="free">c</span> <span class="main">⟹</span> SC_discr <span class="free">c</span> <span class="main">⟹</span> discr <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">c</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> discr<span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">SC_siso</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">SC_siso</span> Done           <span class="main">⟷</span> True"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">SC_siso</span> <span class="main">(</span>Atm <span class="free"><span class="bound"><span class="entity">atm</span></span></span><span class="main">)</span>      <span class="main">⟷</span> compatAtm <span class="free"><span class="bound"><span class="entity">atm</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">SC_siso</span> <span class="main">(</span>Seq <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span><span class="main">)</span>    <span class="main">⟷</span> <span class="free">SC_siso</span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="main">∧</span> <span class="free">SC_siso</span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">SC_siso</span> <span class="main">(</span>Ch <span class="free"><span class="bound"><span class="entity">ch</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span><span class="main">)</span>  <span class="main">⟷</span> compatCh <span class="free"><span class="bound"><span class="entity">ch</span></span></span> <span class="main">∧</span> <span class="free">SC_siso</span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="main">∧</span> <span class="free">SC_siso</span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">SC_siso</span> <span class="main">(</span>While <span class="free"><span class="bound"><span class="entity">tst</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span>  <span class="main">⟷</span> compatTst <span class="free"><span class="bound"><span class="entity">tst</span></span></span> <span class="main">∧</span> <span class="free">SC_siso</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">SC_siso</span> <span class="main">(</span>Par <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">)</span>   <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">c</span><span class="main">∈</span>set <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">.</span> <span class="free">SC_siso</span> <span class="bound">c</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">SC_siso</span> <span class="main">(</span>ParT <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">)</span>  <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">c</span><span class="main">∈</span>set <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">.</span> <span class="free">SC_siso</span> <span class="bound">c</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">theorem</span></span> SC_siso_siso<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"proper <span class="free">c</span> <span class="main">⟹</span> SC_siso <span class="free">c</span> <span class="main">⟹</span> siso <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">c</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> siso<span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">SC_Sbis</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">SC_Sbis</span> Done           <span class="main">⟷</span> True"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">SC_Sbis</span> <span class="main">(</span>Atm <span class="free"><span class="bound"><span class="entity">atm</span></span></span><span class="main">)</span>      <span class="main">⟷</span> compatAtm <span class="free"><span class="bound"><span class="entity">atm</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">SC_Sbis</span> <span class="main">(</span>Seq <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span><span class="main">)</span>    <span class="main">⟷</span> <span class="main">(</span>SC_siso <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="main">∧</span> <span class="free">SC_Sbis</span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span><span class="main">)</span> <span class="main">∨</span>
                             <span class="main">(</span><span class="free">SC_Sbis</span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="main">∧</span> SC_discr <span class="free"><span class="bound"><span class="entity">c2</span></span></span><span class="main">)</span> <span class="main">∨</span>
                             SC_discr <span class="main">(</span>Seq <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span><span class="main">)</span> <span class="main">∨</span> SC_siso <span class="main">(</span>Seq <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">SC_Sbis</span> <span class="main">(</span>Ch <span class="free"><span class="bound"><span class="entity">ch</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span><span class="main">)</span>  <span class="main">⟷</span> <span class="main">(</span><span class="keyword1">if</span> compatCh <span class="free"><span class="bound"><span class="entity">ch</span></span></span>
                             <span class="keyword1">then</span> <span class="free">SC_Sbis</span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="main">∧</span> <span class="free">SC_Sbis</span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span>
                             <span class="keyword1">else</span> <span class="main">(</span>SC_discr <span class="main">(</span>Ch <span class="free"><span class="bound"><span class="entity">ch</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span><span class="main">)</span> <span class="main">∨</span> SC_siso <span class="main">(</span>Ch <span class="free"><span class="bound"><span class="entity">ch</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">SC_Sbis</span> <span class="main">(</span>While <span class="free"><span class="bound"><span class="entity">tst</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span>  <span class="main">⟷</span> SC_discr <span class="main">(</span>While <span class="free"><span class="bound"><span class="entity">tst</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="main">∨</span> SC_siso <span class="main">(</span>While <span class="free"><span class="bound"><span class="entity">tst</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">SC_Sbis</span> <span class="main">(</span>Par <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">)</span>   <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">c</span><span class="main">∈</span>set <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">.</span> <span class="free">SC_Sbis</span> <span class="bound">c</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">SC_Sbis</span> <span class="main">(</span>ParT <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">)</span>  <span class="main">⟷</span> SC_siso <span class="main">(</span>ParT <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">)</span> <span class="main">∨</span> SC_discr <span class="main">(</span>ParT <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">theorem</span></span> SC_siso_SCbis<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"SC_siso <span class="free">c</span> <span class="main">⟹</span> SC_Sbis <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">c</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">theorem</span></span> SC_discr_SCbis<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"SC_discr <span class="free">c</span> <span class="main">⟹</span> SC_Sbis <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">c</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">declare</span></span> SC_siso.simps<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">del</span></span></span></span></span></span></span><span class="main">]</span>

<span class="keyword1"><span class="command">declare</span></span> SC_discr.simps<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">del</span></span></span></span></span></span></span><span class="main">]</span>

<span class="keyword1"><span class="command">theorem</span></span> SC_Sbis_Sbis<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"proper <span class="free">c</span> <span class="main">⟹</span> SC_Sbis <span class="free">c</span> <span class="main">⟹</span> <span class="free">c</span> <span class="keyword1">≈s</span> <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">c</span></span><span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Sbis discr_imp_Sbis siso_imp_Sbis
           <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">SC_ZObis</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">SC_ZObis</span> Done           <span class="main">⟷</span> True"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">SC_ZObis</span> <span class="main">(</span>Atm <span class="free"><span class="bound"><span class="entity">atm</span></span></span><span class="main">)</span>      <span class="main">⟷</span> compatAtm <span class="free"><span class="bound"><span class="entity">atm</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">SC_ZObis</span> <span class="main">(</span>Seq <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span><span class="main">)</span>    <span class="main">⟷</span> <span class="main">(</span>SC_siso <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="main">∧</span> <span class="free">SC_ZObis</span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span><span class="main">)</span> <span class="main">∨</span>
                             <span class="main">(</span><span class="free">SC_ZObis</span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="main">∧</span> SC_discr <span class="free"><span class="bound"><span class="entity">c2</span></span></span><span class="main">)</span> <span class="main">∨</span>
                             SC_Sbis <span class="main">(</span>Seq <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">SC_ZObis</span> <span class="main">(</span>Ch <span class="free"><span class="bound"><span class="entity">ch</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span><span class="main">)</span>  <span class="main">⟷</span> <span class="main">(</span><span class="keyword1">if</span> compatCh <span class="free"><span class="bound"><span class="entity">ch</span></span></span>
                             <span class="keyword1">then</span> <span class="free">SC_ZObis</span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="main">∧</span> <span class="free">SC_ZObis</span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span>
                             <span class="keyword1">else</span> SC_Sbis <span class="main">(</span>Ch <span class="free"><span class="bound"><span class="entity">ch</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">SC_ZObis</span> <span class="main">(</span>While <span class="free"><span class="bound"><span class="entity">tst</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span>  <span class="main">⟷</span> SC_Sbis <span class="main">(</span>While <span class="free"><span class="bound"><span class="entity">tst</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">SC_ZObis</span> <span class="main">(</span>Par <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">)</span>   <span class="main">⟷</span> SC_Sbis <span class="main">(</span>Par <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">SC_ZObis</span> <span class="main">(</span>ParT <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">)</span>  <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">c</span><span class="main">∈</span>set <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">.</span> SC_Sbis <span class="bound">c</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">theorem</span></span> SC_Sbis_SC_ZObis<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"SC_Sbis <span class="free">c</span> <span class="main">⟹</span> SC_ZObis <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">c</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> SC_siso.simps SC_discr.simps<span class="main">)</span>

<span class="keyword1"><span class="command">declare</span></span> SC_Sbis.simps<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">del</span></span></span></span></span></span></span><span class="main">]</span>

<span class="keyword1"><span class="command">theorem</span></span> SC_ZObis_ZObis<span class="main">:</span> <span class="quoted"><span class="quoted">"proper <span class="free">c</span> <span class="main">⟹</span> SC_ZObis <span class="free">c</span> <span class="main">⟹</span> <span class="free">c</span> <span class="main">≈01</span> <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">c</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Sbis_imp_ZObis ZObis <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ZObis<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Concrete">
<div class="head">
<h1>Theory Concrete</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Concrete setting›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Concrete
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Syntactic_Criteria.html">Syntactic_Criteria</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="comment1">(* We instatiate the parameters according to Examples 1 and 2 from the paper. *)</span>

<span class="comment1">(* Security levels: *)</span>
<span class="keyword1"><span class="command">datatype</span></span> level <span class="main">=</span> Lo <span class="main">|</span> Hi

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">l</span><span class="main">.</span> <span class="bound">l</span> <span class="main">≠</span> Hi <span class="main">⟷</span> <span class="bound">l</span> <span class="main">=</span> Lo"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">l</span><span class="main">.</span> Hi <span class="main">≠</span> <span class="bound">l</span> <span class="main">⟷</span> Lo <span class="main">=</span> <span class="bound">l</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">l</span><span class="main">.</span> <span class="bound">l</span> <span class="main">≠</span> Lo <span class="main">⟷</span> <span class="bound">l</span> <span class="main">=</span> Hi"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">l</span><span class="main">.</span> Lo <span class="main">≠</span> <span class="bound">l</span> <span class="main">⟷</span> Hi <span class="main">=</span> <span class="bound">l</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> level.exhaust level.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">l</span> <span class="bound">A</span><span class="main">.</span> <span class="main">⟦</span><span class="bound">l</span> <span class="main">∈</span> <span class="bound">A</span><span class="main">;</span> Lo <span class="main">∉</span> <span class="bound">A</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="bound">l</span> <span class="main">=</span> Hi"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      <span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">l</span> <span class="bound">A</span><span class="main">.</span> <span class="main">⟦</span><span class="bound">l</span> <span class="main">∈</span> <span class="bound">A</span><span class="main">;</span> Hi <span class="main">∉</span> <span class="bound">A</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="bound">l</span> <span class="main">=</span> Lo"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> level.exhaust<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">declare</span></span> level.split<span class="main">[</span><span class="operator">split</span><span class="main">]</span>

<span class="keyword1"><span class="command">instantiation</span></span> level <span class="main">::</span> <span class="quoted">complete_lattice</span>
<span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword1"><span class="command">definition</span></span> top_level<span class="main">:</span> <span class="quoted"><span class="quoted">"top <span class="main">≡</span> Hi"</span></span>
  <span class="keyword1"><span class="command">definition</span></span> bot_level<span class="main">:</span> <span class="quoted"><span class="quoted">"bot <span class="main">≡</span> Lo"</span></span>
  <span class="keyword1"><span class="command">definition</span></span> inf_level<span class="main">:</span> <span class="quoted"><span class="quoted">"inf <span class="free"><span class="bound"><span class="entity">l1</span></span></span> <span class="free"><span class="bound"><span class="entity">l2</span></span></span> <span class="main">≡</span> <span class="keyword1">if</span> Lo <span class="main">∈</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">l1</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">l2</span></span></span><span class="main">}</span> <span class="keyword1">then</span> Lo <span class="keyword1">else</span> Hi"</span></span>
  <span class="keyword1"><span class="command">definition</span></span> sup_level<span class="main">:</span> <span class="quoted"><span class="quoted">"sup <span class="free"><span class="bound"><span class="entity">l1</span></span></span> <span class="free"><span class="bound"><span class="entity">l2</span></span></span> <span class="main">≡</span> <span class="keyword1">if</span> Hi <span class="main">∈</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">l1</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">l2</span></span></span><span class="main">}</span> <span class="keyword1">then</span> Hi <span class="keyword1">else</span> Lo"</span></span>
  <span class="keyword1"><span class="command">definition</span></span> less_eq_level<span class="main">:</span> <span class="quoted"><span class="quoted">"less_eq <span class="free"><span class="bound"><span class="entity">l1</span></span></span> <span class="free"><span class="bound"><span class="entity">l2</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">l1</span></span></span> <span class="main">=</span> Lo <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">l2</span></span></span> <span class="main">=</span> Hi<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">definition</span></span> less_level<span class="main">:</span> <span class="quoted"><span class="quoted">"less <span class="free"><span class="bound"><span class="entity">l1</span></span></span> <span class="free"><span class="bound"><span class="entity">l2</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">l1</span></span></span> <span class="main">=</span> Lo <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">l2</span></span></span> <span class="main">=</span> Hi"</span></span>
  <span class="keyword1"><span class="command">definition</span></span> Inf_level<span class="main">:</span> <span class="quoted"><span class="quoted">"Inf <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="main">≡</span> <span class="keyword1">if</span> Lo <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="keyword1">then</span> Lo <span class="keyword1">else</span> Hi"</span></span>
  <span class="keyword1"><span class="command">definition</span></span> Sup_level<span class="main">:</span> <span class="quoted"><span class="quoted">"Sup <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="main">≡</span> <span class="keyword1">if</span> Hi <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="keyword1">then</span> Hi <span class="keyword1">else</span> Lo"</span></span>
<span class="keyword1"><span class="command">instance</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> top_level bot_level inf_level sup_level
                        less_eq_level less_level Inf_level Sup_level<span class="main">)</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1" id="Concrete-sup_eq_Lo"><span class="command">lemma</span></span> sup_eq_Lo<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"sup <span class="free">a</span> <span class="free">b</span> <span class="main">=</span> Lo <span class="main">⟷</span> <span class="free">a</span> <span class="main">=</span> Lo <span class="main">∧</span> <span class="free">b</span> <span class="main">=</span> Lo"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sup_level<span class="main">)</span>

<span class="keyword1"><span class="command">datatype</span></span> var <span class="main">=</span> h <span class="main">|</span> h' <span class="main">|</span> l <span class="main">|</span> l'
<span class="keyword1"><span class="command">datatype</span></span> exp <span class="main">=</span> Ct <span class="quoted">nat</span> <span class="main">|</span> Var <span class="quoted">var</span> <span class="main">|</span> Plus <span class="quoted">exp</span> <span class="quoted">exp</span> <span class="main">|</span> Minus <span class="quoted">exp</span> <span class="quoted">exp</span>
<span class="keyword1"><span class="command">datatype</span></span> test <span class="main">=</span> Tr <span class="main">|</span> Eq <span class="quoted">exp</span> <span class="quoted">exp</span> <span class="main">|</span> Gt <span class="quoted">exp</span> <span class="quoted">exp</span> <span class="main">|</span> Non <span class="quoted">test</span>
<span class="keyword1"><span class="command">datatype</span></span> atom <span class="main">=</span> Assign <span class="quoted">var</span> <span class="quoted">exp</span>
<span class="keyword1"><span class="command">type_synonym</span></span> choice <span class="main">=</span> <span class="quoted"><span class="quoted">"real <span class="main">+</span> test"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> state <span class="main">=</span> <span class="quoted"><span class="quoted">"var <span class="main">⇒</span> nat"</span></span>

<span class="keyword1"><span class="command">syntax</span></span>
 <span class="quoted">"_assign"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span>  <span class="main">(</span><span class="quoted">"_ <span class="keyword1">::=</span> _"</span> <span class="main">[</span>1000<span class="main">,</span> 61<span class="main">]</span> 61<span class="main">)</span>

<span class="keyword1"><span class="command">translations</span></span>
  <span class="quoted">"<span class="free">x</span> <span class="main">::=</span> <span class="free">expr</span>"</span> <span class="main">==</span> <span class="quoted">"<span class="keyword1">CONST</span> Atm <span class="main">(</span><span class="keyword1">CONST</span> Assign <span class="free">x</span> <span class="free">expr</span><span class="main">)</span>"</span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">sec</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">sec</span> h  <span class="main">=</span> Hi"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">sec</span> h' <span class="main">=</span> Hi"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">sec</span> l  <span class="main">=</span> Lo"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">sec</span> l' <span class="main">=</span> Lo"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">eval</span> <span class="keyword2"><span class="keyword">where</span></span>
 <span class="quoted"><span class="quoted">"<span class="free">eval</span> <span class="main">(</span>Ct <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">"<span class="free">eval</span> <span class="main">(</span>Var <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">"<span class="free">eval</span> <span class="main">(</span>Plus <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="free">eval</span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">+</span> <span class="free">eval</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">"<span class="free">eval</span> <span class="main">(</span>Minus <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="free">eval</span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">-</span> <span class="free">eval</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">tval</span> <span class="keyword2"><span class="keyword">where</span></span>
 <span class="quoted"><span class="quoted">"<span class="free">tval</span> Tr <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> True"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">"<span class="free">tval</span> <span class="main">(</span>Eq <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="main">(</span>eval <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> eval <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">"<span class="free">tval</span> <span class="main">(</span>Gt <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="main">(</span>eval <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">&gt;</span> eval <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">"<span class="free">tval</span> <span class="main">(</span>Non <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">¬</span> <span class="free">tval</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">aval</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">aval</span> <span class="main">(</span>Assign <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">:=</span> eval <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">cval</span> <span class="keyword2"><span class="keyword">where</span></span>
 <span class="quoted"><span class="quoted">"<span class="free">cval</span> <span class="main">(</span>Inl <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> min <span class="main">1</span> <span class="main">(</span>max <span class="main">0</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">"<span class="free">cval</span> <span class="main">(</span>Inr <span class="free"><span class="bound"><span class="entity">tst</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> tval <span class="free"><span class="bound"><span class="entity">tst</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">indis</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>state <span class="main">*</span> state<span class="main">)</span> set"</span></span><span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">indis</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="bound">t</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">ALL</span> <span class="bound">x</span><span class="main">.</span> sec <span class="bound">x</span> <span class="main">=</span> Lo <span class="main">⟶</span> <span class="bound">s</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">t</span> <span class="bound">x</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> Example_PL<span class="main">:</span> PL_Indis <span class="quoted">aval</span> <span class="quoted">tval</span> <span class="quoted">cval</span> <span class="quoted">indis</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ch</span> <span class="main">::</span> <span class="quoted">choice</span> <span class="keyword2"><span class="keyword">and</span></span>  <span class="skolem">s</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> cval <span class="skolem">ch</span> <span class="skolem">s</span> <span class="main">∧</span> cval <span class="skolem">ch</span> <span class="skolem">s</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ch</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"equiv UNIV indis"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> refl_on_def sym_def trans_def equiv_def indis_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* The security level of expressions: *)</span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">exprSec</span> <span class="keyword2"><span class="keyword">where</span></span>
 <span class="quoted"><span class="quoted">"<span class="free">exprSec</span> <span class="main">(</span>Ct <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> Lo"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">"<span class="free">exprSec</span> <span class="main">(</span>Var <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> sec <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">"<span class="free">exprSec</span> <span class="main">(</span>Plus <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">)</span> <span class="main">=</span> sup <span class="main">(</span><span class="free">exprSec</span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">exprSec</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">"<span class="free">exprSec</span> <span class="main">(</span>Minus <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">)</span> <span class="main">=</span> sup <span class="main">(</span><span class="free">exprSec</span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">exprSec</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">)</span>"</span></span>

<span class="comment1">(* The security level of tests: *)</span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">tstSec</span> <span class="keyword2"><span class="keyword">where</span></span>
 <span class="quoted"><span class="quoted">"<span class="free">tstSec</span> Tr <span class="main">=</span> Lo"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">"<span class="free">tstSec</span> <span class="main">(</span>Eq <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">)</span> <span class="main">=</span> sup <span class="main">(</span>exprSec <span class="free"><span class="bound"><span class="entity">e1</span></span></span><span class="main">)</span> <span class="main">(</span>exprSec <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">"<span class="free">tstSec</span> <span class="main">(</span>Gt <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">)</span> <span class="main">=</span> sup <span class="main">(</span>exprSec <span class="free"><span class="bound"><span class="entity">e1</span></span></span><span class="main">)</span> <span class="main">(</span>exprSec <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">"<span class="free">tstSec</span> <span class="main">(</span>Non <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">tstSec</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span>"</span></span>

<span class="keyword1" id="Concrete-exprSec_Lo_eval_eq"><span class="command">lemma</span></span> exprSec_Lo_eval_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"exprSec <span class="free">expr</span> <span class="main">=</span> Lo <span class="main">⟹</span> <span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span> <span class="main">∈</span> indis <span class="main">⟹</span> eval <span class="free">expr</span> <span class="free">s</span> <span class="main">=</span> eval <span class="free">expr</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">expr</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> indis_def<span class="main">)</span>

<span class="keyword1" id="Concrete-compatAtmSyntactic"><span class="command">lemma</span></span> compatAtmSyntactic<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"exprSec <span class="free">expr</span> <span class="main">=</span> Lo <span class="main">∨</span> sec <span class="free">v</span> <span class="main">=</span> Hi <span class="main">⟹</span> Example_PL.compatAtm <span class="main">(</span>Assign <span class="free">v</span> <span class="free">expr</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Example_PL.compatAtm_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">expr</span></span><span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> indis_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> arg_cong2<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">(+)</span>"</span></span><span class="main"><span class="main">]</span></span> arg_cong2<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">(-)</span>"</span></span><span class="main"><span class="main">]</span></span> exprSec_Lo_eval_eq<span class="main">)</span>

<span class="keyword1" id="Concrete-presAtmSyntactic"><span class="command">lemma</span></span> presAtmSyntactic<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"sec <span class="free">v</span> <span class="main">=</span> Hi <span class="main">⟹</span> Example_PL.presAtm <span class="main">(</span>Assign <span class="free">v</span> <span class="free">expr</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Example_PL.presAtm_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> indis_def<span class="main">)</span>

<span class="keyword1" id="Concrete-compatTstSyntactic"><span class="command">lemma</span></span> compatTstSyntactic<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"tstSec <span class="free">tst</span> <span class="main">=</span> Lo <span class="main">⟹</span> Example_PL.compatTst <span class="free">tst</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Example_PL.compatTst_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">tst</span></span><span class="main">)</span>
     <span class="main">(</span><span class="operator">simp_all</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> iffI
              <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> arg_cong2<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">(=)</span>"</span></span><span class="main"><span class="main">]</span></span> arg_cong2<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">(&lt;)</span> <span class="main">::</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> bool"</span></span><span class="main"><span class="main">]</span></span> exprSec_Lo_eval_eq<span class="main">)</span>

<span class="comment1">(* Stateless choices are always compatible: *)</span>
<span class="keyword1" id="Concrete-compatPrchSyntactic"><span class="command">lemma</span></span> compatPrchSyntactic<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Example_PL.compatCh <span class="main">(</span>Inl <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Example_PL.compatCh_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="comment1">(* A test-choice is compatible iff its test is compatible: *)</span>
<span class="keyword1" id="Concrete-compatIfchSyntactic"><span class="command">lemma</span></span> compatIfchSyntactic<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Example_PL.compatCh <span class="main">(</span>Inr <span class="free">tst</span><span class="main">)</span> <span class="main">⟷</span> Example_PL.compatTst <span class="free">tst</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Example_PL.compatCh_def Example_PL.compatTst_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">Ch_half</span> <span class="main">(</span><span class="quoted">"<span class="keyword1">Ch<span class="hidden">⇩</span><sub>½</sub></span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">Ch<span class="hidden">⇩</span><sub>½</sub></span></span> <span class="main">≡</span> Ch <span class="main">(</span>Inl <span class="main">(</span><span class="main">1</span><span class="main">/</span><span class="numeral">2</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">If</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">If</span> <span class="free"><span class="bound"><span class="entity">tst</span></span></span> <span class="main">≡</span> Ch <span class="main">(</span>Inr <span class="free"><span class="bound"><span class="entity">tst</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">siso</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">≡</span> Example_PL.siso <span class="free"><span class="bound"><span class="entity">c</span></span></span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">discr</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">≡</span> Example_PL.discr <span class="free"><span class="bound"><span class="entity">c</span></span></span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">Sbis_abbrev</span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">≈s</span>"</span> 55<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="keyword1"><span class="free">≈s</span></span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c1</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">c2</span></span></span><span class="main">)</span> <span class="main">∈</span> Example_PL.Sbis"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">ZObis_abbrev</span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">≈01</span>"</span> 55<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="main"><span class="free">≈01</span></span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c1</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">c2</span></span></span><span class="main">)</span> <span class="main">∈</span> Example_PL.ZObis"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">SC_siso</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">≡</span> Example_PL.SC_siso <span class="free"><span class="bound"><span class="entity">c</span></span></span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">SC_discr</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">≡</span> Example_PL.SC_discr <span class="free"><span class="bound"><span class="entity">c</span></span></span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">SC_Sbis</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">≡</span> Example_PL.SC_Sbis <span class="free"><span class="bound"><span class="entity">c</span></span></span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">SC_ZObis</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">≡</span> Example_PL.SC_ZObis <span class="free"><span class="bound"><span class="entity">c</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"SC_discr <span class="main">(</span>h <span class="main">::=</span> Ct <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Example_PL.SC_discr.simps<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹The secure programs from the paper's Example 3›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">d0</span> <span class="main">=</span>
  h' <span class="main">::=</span> Ct <span class="main">0</span> <span class="main">;;</span>
  While <span class="main">(</span>Gt <span class="main">(</span>Var h<span class="main">)</span> <span class="main">(</span>Ct <span class="main">0</span><span class="main">)</span><span class="main">)</span>
    <span class="main">(</span><span class="keyword1">Ch<span class="hidden">⇩</span><sub>½</sub></span> <span class="main">(</span>h <span class="main">::=</span> Ct <span class="main">0</span><span class="main">)</span>
         <span class="main">(</span>h' <span class="main">::=</span> Plus <span class="main">(</span>Var h'<span class="main">)</span> <span class="main">(</span>Ct <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">d1</span> <span class="main">=</span>
  While <span class="main">(</span>Gt <span class="main">(</span>Var h<span class="main">)</span> <span class="main">(</span>Ct <span class="main">0</span><span class="main">)</span><span class="main">)</span>
    <span class="main">(</span><span class="keyword1">Ch<span class="hidden">⇩</span><sub>½</sub></span> <span class="main">(</span>h <span class="main">::=</span> Minus <span class="main">(</span>Var h<span class="main">)</span> <span class="main">(</span>Ct <span class="main">1</span><span class="main">)</span><span class="main">)</span>
         <span class="main">(</span>h <span class="main">::=</span> Plus <span class="main">(</span>Var h<span class="main">)</span> <span class="main">(</span>Ct <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">d2</span> <span class="main">=</span>
  If <span class="main">(</span>Eq <span class="main">(</span>Var l<span class="main">)</span> <span class="main">(</span>Ct <span class="main">0</span><span class="main">)</span><span class="main">)</span>
    <span class="main">(</span>l' <span class="main">::=</span> Ct <span class="main">1</span><span class="main">)</span>
    d0"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">d3</span> <span class="main">=</span>
  h <span class="main">::=</span> Ct <span class="numeral">5</span> <span class="main">;;</span>
  ParT <span class="main">[</span>d0<span class="main">,</span> <span class="main">(</span>l <span class="main">::=</span> Ct <span class="main">1</span><span class="main">)</span><span class="main">]</span>"</span></span>

<span class="comment1">(* The syntactic criteria are checked automatically: *)</span>
<span class="keyword1"><span class="command">theorem</span></span> <span class="quoted"><span class="quoted">"SC_discr d0"</span></span>
        <span class="quoted"><span class="quoted">"SC_discr d1"</span></span>
        <span class="quoted"><span class="quoted">"SC_Sbis d2"</span></span>
        <span class="quoted"><span class="quoted">"SC_ZObis d2"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Example_PL.SC_discr.simps Example_PL.SC_Sbis.simps Example_PL.SC_ZObis.simps<span class="main">)</span>

<span class="comment1">(* Alternatively, the semantic notions follow directly from the compositionality facts
used as intro rules: *)</span>
<span class="keyword1"><span class="command">theorem</span></span> <span class="quoted"><span class="quoted">"discr d0"</span></span>
        <span class="quoted"><span class="quoted">"discr d1"</span></span>
        <span class="quoted"><span class="quoted">"d2 <span class="keyword1">≈s</span> d2"</span></span>
        <span class="quoted"><span class="quoted">"d3 <span class="main">≈01</span> d3"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> compatAtmSyntactic
                   Example_PL.ZObis Example_PL.proper_intros
                   Example_PL.Atm_Sbis<span class="main">)</span>


<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div>