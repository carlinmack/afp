<div id="Antiquote_Setup">
<div class="head">
<h1>Theory Antiquote_Setup</h1>
</div>
<pre class="source"><span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">theory</span></span> Antiquote_Setup
<span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">ML_file</span></span> <span class="quoted">‹~~/src/Doc/antiquote_setup.ML›</span>

<span class="keyword2"><span class="keyword">end</span></span>
<span class="comment1">(*&gt;*)</span>
</pre>
</div><div id="files/ISABELLE_HOME/src/Doc/antiquote_setup.ML">
<div class="head">
<h1>File ‹~~/src/Doc/antiquote_setup.ML›</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:      Doc/antiquote_setup.ML
    Author:     Makarius

Auxiliary antiquotations for the Isabelle manuals.
*)</span>

<span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">Antiquote_Setup</span><span class="main">:</span> <span class="keyword2"><span class="keyword">sig</span></span> <span class="keyword2"><span class="keyword">end</span></span> <span class="main">=</span>
<span class="keyword2"><span class="keyword">struct</span></span>

<span class="comment1">(* misc utils *)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">translate</span> <span class="entity">f</span> <span class="main">=</span> Symbol.explode #&gt; map <span class="entity">f</span> #&gt; implode<span class="main">;</span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">clean_string</span> <span class="main">=</span> <span class="entity">translate</span>
  <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="inner_quoted">"_"</span> <span class="main">=&gt;</span> <span class="inner_quoted">"\\_"</span>
    <span class="main">|</span> <span class="inner_quoted">"#"</span> <span class="main">=&gt;</span> <span class="inner_quoted">"\\#"</span>
    <span class="main">|</span> <span class="inner_quoted">"$"</span> <span class="main">=&gt;</span> <span class="inner_quoted">"\\$"</span>
    <span class="main">|</span> <span class="inner_quoted">"%"</span> <span class="main">=&gt;</span> <span class="inner_quoted">"\\%"</span>
    <span class="main">|</span> <span class="inner_quoted">"&lt;"</span> <span class="main">=&gt;</span> <span class="inner_quoted">"$&lt;$"</span>
    <span class="main">|</span> <span class="inner_quoted">"&gt;"</span> <span class="main">=&gt;</span> <span class="inner_quoted">"$&gt;$"</span>
    <span class="main">|</span> <span class="inner_quoted">"{"</span> <span class="main">=&gt;</span> <span class="inner_quoted">"\\{"</span>
    <span class="main">|</span> <span class="inner_quoted">"|"</span> <span class="main">=&gt;</span> <span class="inner_quoted">"$\\mid$"</span>
    <span class="main">|</span> <span class="inner_quoted">"}"</span> <span class="main">=&gt;</span> <span class="inner_quoted">"\\}"</span>
    <span class="main">|</span> <span class="inner_quoted">"‐"</span> <span class="main">=&gt;</span> <span class="inner_quoted">"-"</span>
    <span class="main">|</span> <span class="entity">c</span> <span class="main">=&gt;</span> <span class="entity">c</span><span class="main">)</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">clean_name</span> <span class="inner_quoted">"…"</span> <span class="main">=</span> <span class="inner_quoted">"dots"</span>
  <span class="main">|</span> <span class="entity">clean_name</span> <span class="inner_quoted">".."</span> <span class="main">=</span> <span class="inner_quoted">"ddot"</span>
  <span class="main">|</span> <span class="entity">clean_name</span> <span class="inner_quoted">"."</span> <span class="main">=</span> <span class="inner_quoted">"dot"</span>
  <span class="main">|</span> <span class="entity">clean_name</span> <span class="inner_quoted">"_"</span> <span class="main">=</span> <span class="inner_quoted">"underscore"</span>
  <span class="main">|</span> <span class="entity">clean_name</span> <span class="inner_quoted">"{"</span> <span class="main">=</span> <span class="inner_quoted">"braceleft"</span>
  <span class="main">|</span> <span class="entity">clean_name</span> <span class="inner_quoted">"}"</span> <span class="main">=</span> <span class="inner_quoted">"braceright"</span>
  <span class="main">|</span> <span class="entity">clean_name</span> <span class="entity">s</span> <span class="main">=</span> <span class="entity">s</span> |&gt; <span class="entity">translate</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="inner_quoted">"_"</span> <span class="main">=&gt;</span> <span class="inner_quoted">"-"</span> <span class="main">|</span> <span class="inner_quoted">"‐"</span> <span class="main">=&gt;</span> <span class="inner_quoted">"-"</span> <span class="main">|</span> <span class="entity">c</span> <span class="main">=&gt;</span> <span class="entity">c</span><span class="main">)</span><span class="main">;</span>


<span class="comment1">(* ML text *)</span>

<span class="keyword2"><span class="keyword">local</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">ml_val</span> <span class="main">(</span><span class="entity">toks1</span><span class="main">,</span> <span class="main">[</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> ML_Lex.read <span class="inner_quoted">"fn _ =&gt; ("</span> @ <span class="entity">toks1</span> @ ML_Lex.read <span class="inner_quoted">");"</span>
  <span class="main">|</span> <span class="entity">ml_val</span> <span class="main">(</span><span class="entity">toks1</span><span class="main">,</span> <span class="entity">toks2</span><span class="main">)</span> <span class="main">=</span>
      ML_Lex.read <span class="inner_quoted">"fn _ =&gt; ("</span> @ <span class="entity">toks1</span> @ ML_Lex.read <span class="inner_quoted">" : "</span> @ <span class="entity">toks2</span> @ ML_Lex.read <span class="inner_quoted">");"</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">ml_op</span> <span class="main">(</span><span class="entity">toks1</span><span class="main">,</span> <span class="main">[</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> ML_Lex.read <span class="inner_quoted">"fn _ =&gt; (op "</span> @ <span class="entity">toks1</span> @ ML_Lex.read <span class="inner_quoted">");"</span>
  <span class="main">|</span> <span class="entity">ml_op</span> <span class="main">(</span><span class="entity">toks1</span><span class="main">,</span> <span class="entity">toks2</span><span class="main">)</span> <span class="main">=</span>
      ML_Lex.read <span class="inner_quoted">"fn _ =&gt; (op "</span> @ <span class="entity">toks1</span> @ ML_Lex.read <span class="inner_quoted">" : "</span> @ <span class="entity">toks2</span> @ ML_Lex.read <span class="inner_quoted">");"</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">ml_type</span> <span class="main">(</span><span class="entity">toks1</span><span class="main">,</span> <span class="main">[</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> ML_Lex.read <span class="inner_quoted">"val _ = NONE : ("</span> @ <span class="entity">toks1</span> @ ML_Lex.read <span class="inner_quoted">") option;"</span>
  <span class="main">|</span> <span class="entity">ml_type</span> <span class="main">(</span><span class="entity">toks1</span><span class="main">,</span> <span class="entity">toks2</span><span class="main">)</span> <span class="main">=</span>
      ML_Lex.read <span class="inner_quoted">"val _ = [NONE : ("</span> @ <span class="entity">toks1</span> @ ML_Lex.read <span class="inner_quoted">") option, NONE : ("</span> @
        <span class="entity">toks2</span> @ ML_Lex.read <span class="inner_quoted">") option];"</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">ml_exception</span> <span class="main">(</span><span class="entity">toks1</span><span class="main">,</span> <span class="main">[</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> ML_Lex.read <span class="inner_quoted">"fn _ =&gt; ("</span> @ <span class="entity">toks1</span> @ ML_Lex.read <span class="inner_quoted">" : exn);"</span>
  <span class="main">|</span> <span class="entity">ml_exception</span> <span class="main">(</span><span class="entity">toks1</span><span class="main">,</span> <span class="entity">toks2</span><span class="main">)</span> <span class="main">=</span>
      ML_Lex.read <span class="inner_quoted">"fn _ =&gt; ("</span> @ <span class="entity">toks1</span> @ ML_Lex.read <span class="inner_quoted">" : "</span> @ <span class="entity">toks2</span> @ ML_Lex.read <span class="inner_quoted">" -&gt; exn);"</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">ml_structure</span> <span class="main">(</span><span class="entity">toks</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> <span class="main">=</span>
  ML_Lex.read <span class="inner_quoted">"functor XXX() = struct structure XX = "</span> @ <span class="entity">toks</span> @ ML_Lex.read <span class="inner_quoted">" end;"</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">ml_functor</span> <span class="main">(</span>Antiquote.Text <span class="entity">tok</span> :: <span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> <span class="main">=</span>
      ML_Lex.read <span class="inner_quoted">"ML_Env.check_functor "</span> @
      ML_Lex.read <span class="main">(</span>ML_Syntax.print_string <span class="main">(</span>ML_Lex.content_of <span class="entity">tok</span><span class="main">)</span><span class="main">)</span>
  <span class="main">|</span> <span class="entity">ml_functor</span> <span class="main">_</span> <span class="main">=</span> <span class="keyword3"><span class="keyword">raise</span></span> Fail <span class="inner_quoted">"Bad ML functor specification"</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">is_name</span> <span class="main">=</span>
  ML_Lex.kind_of #&gt; <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">kind</span> <span class="main">=&gt;</span> <span class="entity">kind</span> <span class="main">=</span> ML_Lex.Ident <span class="keyword1"><span class="keyword">orelse</span></span> <span class="entity">kind</span> <span class="main">=</span> ML_Lex.Long_Ident<span class="main">)</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">ml_name</span> <span class="entity">txt</span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">case</span></span> filter <span class="entity">is_name</span> <span class="main">(</span>ML_Lex.tokenize <span class="entity">txt</span><span class="main">)</span> <span class="keyword2"><span class="keyword">of</span></span>
    <span class="entity">toks</span> <span class="keyword1"><span class="keyword">as</span></span> <span class="main">[</span><span class="main">_</span><span class="main">]</span> <span class="main">=&gt;</span> ML_Lex.flatten <span class="entity">toks</span>
  <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> error <span class="main">(</span><span class="inner_quoted">"Single ML name expected in input: "</span> ^ quote <span class="entity">txt</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">prep_ml</span> <span class="entity">source</span> <span class="main">=</span>
  <span class="main">(</span><span class="main">#</span><span class="inner_numeral">1</span> <span class="main">(</span>Input.source_content <span class="entity">source</span><span class="main">)</span><span class="main">,</span> ML_Lex.read_source <span class="entity">source</span><span class="main">)</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">index_ml</span> <span class="entity">name</span> <span class="entity">kind</span> <span class="entity">ml</span> <span class="main">=</span> <span class="entity">Thy_Output.antiquotation_raw</span> <span class="entity">name</span>
  <span class="main">(</span>Scan.lift <span class="main">(</span>Args.text_input -- Scan.option <span class="main">(</span>Args.colon |-- Args.text_input<span class="main">)</span><span class="main">)</span><span class="main">)</span>
  <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">ctxt</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">source1</span><span class="main">,</span> <span class="entity">opt_source2</span><span class="main">)</span> <span class="main">=&gt;</span>
    <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">txt1</span><span class="main">,</span> <span class="entity">toks1</span><span class="main">)</span> <span class="main">=</span> <span class="entity">prep_ml</span> <span class="entity">source1</span><span class="main">;</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">txt2</span><span class="main">,</span> <span class="entity">toks2</span><span class="main">)</span> <span class="main">=</span>
        <span class="main">(</span><span class="keyword2"><span class="keyword">case</span></span> <span class="entity">opt_source2</span> <span class="keyword2"><span class="keyword">of</span></span>
          SOME <span class="entity">source</span> <span class="main">=&gt;</span> <span class="entity">prep_ml</span> <span class="entity">source</span>
        <span class="main">|</span> NONE <span class="main">=&gt;</span> <span class="main">(</span><span class="inner_quoted">""</span><span class="main">,</span> <span class="main">[</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>

      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">txt</span> <span class="main">=</span>
        <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">txt2</span> <span class="main">=</span> <span class="inner_quoted">""</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">txt1</span>
        <span class="keyword2"><span class="keyword">else</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">kind</span> <span class="main">=</span> <span class="inner_quoted">"type"</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">txt1</span> ^ <span class="inner_quoted">" = "</span> ^ <span class="entity">txt2</span>
        <span class="keyword2"><span class="keyword">else</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">kind</span> <span class="main">=</span> <span class="inner_quoted">"exception"</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">txt1</span> ^ <span class="inner_quoted">" of "</span> ^ <span class="entity">txt2</span>
        <span class="keyword2"><span class="keyword">else</span></span> <span class="keyword2"><span class="keyword">if</span></span> Symbol_Pos.is_identifier <span class="main">(</span>Long_Name.base_name <span class="main">(</span><span class="entity">ml_name</span> <span class="entity">txt1</span><span class="main">)</span><span class="main">)</span>
        <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">txt1</span> ^ <span class="inner_quoted">": "</span> ^ <span class="entity">txt2</span>
        <span class="keyword2"><span class="keyword">else</span></span> <span class="entity">txt1</span> ^ <span class="inner_quoted">" : "</span> ^ <span class="entity">txt2</span><span class="main">;</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">txt'</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">kind</span> <span class="main">=</span> <span class="inner_quoted">""</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">txt</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="entity">kind</span> ^ <span class="inner_quoted">" "</span> ^ <span class="entity">txt</span><span class="main">;</span>

      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">pos</span> <span class="main">=</span> Input.pos_of <span class="entity">source1</span><span class="main">;</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span>
        ML_Context.eval_in <span class="main">(</span>SOME <span class="entity">ctxt</span><span class="main">)</span> ML_Compiler.flags <span class="entity">pos</span> <span class="main">(</span><span class="entity">ml</span> <span class="main">(</span><span class="entity">toks1</span><span class="main">,</span> <span class="entity">toks2</span><span class="main">)</span><span class="main">)</span>
          <span class="keyword3"><span class="keyword">handle</span></span> ERROR <span class="entity">msg</span> <span class="main">=&gt;</span> error <span class="main">(</span><span class="entity">msg</span> ^ Position.here <span class="entity">pos</span><span class="main">)</span><span class="main">;</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">kind'</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">kind</span> <span class="main">=</span> <span class="inner_quoted">""</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="inner_quoted">"ML"</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="inner_quoted">"ML "</span> ^ <span class="entity">kind</span><span class="main">;</span>
    <span class="keyword2"><span class="keyword">in</span></span>
      Latex.block
       <span class="main">[</span>Latex.string <span class="main">(</span><span class="inner_quoted">"\\indexdef{}{"</span> ^ <span class="entity">kind'</span> ^ <span class="inner_quoted">"}{"</span> ^ <span class="entity">clean_string</span> <span class="main">(</span><span class="entity">ml_name</span> <span class="entity">txt1</span><span class="main">)</span> ^ <span class="inner_quoted">"}"</span><span class="main">)</span><span class="main">,</span>
        <span class="entity">Thy_Output.verbatim</span> <span class="entity">ctxt</span> <span class="entity">txt'</span><span class="main">]</span>
    <span class="keyword2"><span class="keyword">end</span></span><span class="main">)</span><span class="main">;</span>

<span class="keyword2"><span class="keyword">in</span></span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span>
  Theory.setup
   <span class="main">(</span><span class="entity">index_ml</span> <span class="antiquoted"><span class="entity"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span>‹index_ML›</span></span> <span class="inner_quoted">""</span> <span class="entity">ml_val</span> #&gt;
    <span class="entity">index_ml</span> <span class="antiquoted"><span class="entity"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span>‹index_ML_op›</span></span> <span class="inner_quoted">"infix"</span> <span class="entity">ml_op</span> #&gt;
    <span class="entity">index_ml</span> <span class="antiquoted"><span class="entity"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span>‹index_ML_type›</span></span> <span class="inner_quoted">"type"</span> <span class="entity">ml_type</span> #&gt;
    <span class="entity">index_ml</span> <span class="antiquoted"><span class="entity"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span>‹index_ML_exception›</span></span> <span class="inner_quoted">"exception"</span> <span class="entity">ml_exception</span> #&gt;
    <span class="entity">index_ml</span> <span class="antiquoted"><span class="entity"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span>‹index_ML_structure›</span></span> <span class="inner_quoted">"structure"</span> <span class="entity">ml_structure</span> #&gt;
    <span class="entity">index_ml</span> <span class="antiquoted"><span class="entity"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span>‹index_ML_functor›</span></span> <span class="inner_quoted">"functor"</span> <span class="entity">ml_functor</span><span class="main">)</span><span class="main">;</span>

<span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>


<span class="comment1">(* named theorems *)</span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span>
  Theory.setup <span class="main">(</span><span class="entity">Thy_Output.antiquotation_raw</span> <span class="antiquoted"><span class="entity"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span>‹named_thms›</span></span>
    <span class="main">(</span>Scan.repeat <span class="main">(</span><span class="entity">Attrib.thm</span> -- Scan.lift <span class="main">(</span>Args.parens Args.name<span class="main">)</span><span class="main">)</span><span class="main">)</span>
    <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">ctxt</span> <span class="main">=&gt;</span>
      map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">thm</span><span class="main">,</span> <span class="entity">name</span><span class="main">)</span> <span class="main">=&gt;</span>
        Output.output
          <span class="main">(</span><span class="entity">Document_Antiquotation.format</span> <span class="entity">ctxt</span>
            <span class="main">(</span><span class="entity">Document_Antiquotation.delimit</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="entity">Thy_Output.pretty_thm</span> <span class="entity">ctxt</span> <span class="entity">thm</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> ^
        enclose <span class="inner_quoted">"\\rulename{"</span> <span class="inner_quoted">"}"</span> <span class="main">(</span>Output.output <span class="entity">name</span><span class="main">)</span><span class="main">)</span>
      #&gt; space_implode <span class="inner_quoted">"\\par\\smallskip%\n"</span>
      #&gt; Latex.string #&gt; single
      #&gt; <span class="entity">Thy_Output.isabelle</span> <span class="entity">ctxt</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>


<span class="comment1">(* Isabelle/Isar entities (with index) *)</span>

<span class="keyword2"><span class="keyword">local</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">no_check</span> <span class="main">(</span><span class="main">_</span><span class="main">:</span> <span class="entity">Proof.context</span><span class="main">)</span> <span class="main">(</span><span class="entity">name</span><span class="main">,</span> <span class="main">_</span><span class="main">:</span> Position.T<span class="main">)</span> <span class="main">=</span> <span class="entity">name</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">check_keyword</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="entity">name</span><span class="main">,</span> <span class="entity">pos</span><span class="main">)</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">if</span></span> Keyword.is_keyword <span class="main">(</span>Thy_Header.get_keywords' <span class="entity">ctxt</span><span class="main">)</span> <span class="entity">name</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">name</span>
  <span class="keyword2"><span class="keyword">else</span></span> error <span class="main">(</span><span class="inner_quoted">"Bad outer syntax keyword "</span> ^ quote <span class="entity">name</span> ^ Position.here <span class="entity">pos</span><span class="main">)</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">check_system_option</span> <span class="entity">ctxt</span> <span class="entity">arg</span> <span class="main">=</span>
  <span class="main">(</span>Completion.check_option <span class="main">(</span>Options.default <span class="main">(</span><span class="main">)</span><span class="main">)</span> <span class="entity">ctxt</span> <span class="entity">arg</span><span class="main">;</span> true<span class="main">)</span>
    <span class="keyword3"><span class="keyword">handle</span></span> ERROR <span class="main">_</span> <span class="main">=&gt;</span> false<span class="main">;</span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">arg</span> <span class="main">=</span> enclose <span class="inner_quoted">"{"</span> <span class="inner_quoted">"}"</span> o <span class="entity">clean_string</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">entity</span> <span class="entity">check</span> <span class="entity">markup</span> <span class="entity">binding</span> <span class="entity">index</span> <span class="main">=</span>
  <span class="entity">Thy_Output.antiquotation_raw</span>
    <span class="main">(</span><span class="entity">binding</span> |&gt; Binding.map_name <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">name</span> <span class="main">=&gt;</span> <span class="entity">name</span> ^
      <span class="main">(</span><span class="keyword2"><span class="keyword">case</span></span> <span class="entity">index</span> <span class="keyword2"><span class="keyword">of</span></span> NONE <span class="main">=&gt;</span> <span class="inner_quoted">""</span> <span class="main">|</span> SOME true <span class="main">=&gt;</span> <span class="inner_quoted">"_def"</span> <span class="main">|</span> SOME false <span class="main">=&gt;</span> <span class="inner_quoted">"_ref"</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
    <span class="main">(</span>Scan.lift <span class="main">(</span>Scan.optional <span class="main">(</span>Args.parens Args.name<span class="main">)</span> <span class="inner_quoted">""</span> -- Args.name_position<span class="main">)</span><span class="main">)</span>
    <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">ctxt</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">logic</span><span class="main">,</span> <span class="main">(</span><span class="entity">name</span><span class="main">,</span> <span class="entity">pos</span><span class="main">)</span><span class="main">)</span> <span class="main">=&gt;</span>
      <span class="keyword2"><span class="keyword">let</span></span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">kind</span> <span class="main">=</span> <span class="entity">translate</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="inner_quoted">"_"</span> <span class="main">=&gt;</span> <span class="inner_quoted">" "</span> <span class="main">|</span> <span class="entity">c</span> <span class="main">=&gt;</span> <span class="entity">c</span><span class="main">)</span> <span class="main">(</span>Binding.name_of <span class="entity">binding</span><span class="main">)</span><span class="main">;</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">hyper_name</span> <span class="main">=</span>
          <span class="inner_quoted">"{"</span> ^ Long_Name.append <span class="entity">kind</span> <span class="main">(</span>Long_Name.append <span class="entity">logic</span> <span class="main">(</span><span class="entity">clean_name</span> <span class="entity">name</span><span class="main">)</span><span class="main">)</span> ^ <span class="inner_quoted">"}"</span><span class="main">;</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">hyper</span> <span class="main">=</span>
          enclose <span class="main">(</span><span class="inner_quoted">"\\hyperlink"</span> ^ <span class="entity">hyper_name</span> ^ <span class="inner_quoted">"{"</span><span class="main">)</span> <span class="inner_quoted">"}"</span> #&gt;
          <span class="entity">index</span> <span class="main">=</span> SOME true ? enclose <span class="main">(</span><span class="inner_quoted">"\\hypertarget"</span> ^ <span class="entity">hyper_name</span> ^ <span class="inner_quoted">"{"</span><span class="main">)</span> <span class="inner_quoted">"}"</span><span class="main">;</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">idx</span> <span class="main">=</span>
          <span class="main">(</span><span class="keyword2"><span class="keyword">case</span></span> <span class="entity">index</span> <span class="keyword2"><span class="keyword">of</span></span>
            NONE <span class="main">=&gt;</span> <span class="inner_quoted">""</span>
          <span class="main">|</span> SOME <span class="entity">is_def</span> <span class="main">=&gt;</span>
              <span class="inner_quoted">"\\index"</span> ^ <span class="main">(</span><span class="keyword2"><span class="keyword">if</span></span> <span class="entity">is_def</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="inner_quoted">"def"</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="inner_quoted">"ref"</span><span class="main">)</span> ^ <span class="entity">arg</span> <span class="entity">logic</span> ^ <span class="entity">arg</span> <span class="entity">kind</span> ^ <span class="entity">arg</span> <span class="entity">name</span><span class="main">)</span><span class="main">;</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span>
          <span class="keyword2"><span class="keyword">if</span></span> Context_Position.is_reported <span class="entity">ctxt</span> <span class="entity">pos</span> <span class="keyword2"><span class="keyword">then</span></span> ignore <span class="main">(</span><span class="entity">check</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="entity">name</span><span class="main">,</span> <span class="entity">pos</span><span class="main">)</span><span class="main">)</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="main">(</span><span class="main">)</span><span class="main">;</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">latex</span> <span class="main">=</span>
          <span class="entity">idx</span> ^
          <span class="main">(</span>Output.output <span class="entity">name</span>
            |&gt; <span class="main">(</span><span class="keyword2"><span class="keyword">if</span></span> <span class="entity">markup</span> <span class="main">=</span> <span class="inner_quoted">""</span> <span class="keyword2"><span class="keyword">then</span></span> I <span class="keyword2"><span class="keyword">else</span></span> enclose <span class="main">(</span><span class="inner_quoted">"\\"</span> ^ <span class="entity">markup</span> ^ <span class="inner_quoted">"{"</span><span class="main">)</span> <span class="inner_quoted">"}"</span><span class="main">)</span>
            |&gt; <span class="entity">hyper</span> o enclose <span class="inner_quoted">"\\mbox{\\isa{"</span> <span class="inner_quoted">"}}"</span><span class="main">)</span><span class="main">;</span>
      <span class="keyword2"><span class="keyword">in</span></span> Latex.string <span class="entity">latex</span> <span class="keyword2"><span class="keyword">end</span></span><span class="main">)</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">entity_antiqs</span> <span class="entity">check</span> <span class="entity">markup</span> <span class="entity">kind</span> <span class="main">=</span>
  <span class="entity">entity</span> <span class="entity">check</span> <span class="entity">markup</span> <span class="entity">kind</span> NONE #&gt;
  <span class="entity">entity</span> <span class="entity">check</span> <span class="entity">markup</span> <span class="entity">kind</span> <span class="main">(</span>SOME true<span class="main">)</span> #&gt;
  <span class="entity">entity</span> <span class="entity">check</span> <span class="entity">markup</span> <span class="entity">kind</span> <span class="main">(</span>SOME false<span class="main">)</span><span class="main">;</span>

<span class="keyword2"><span class="keyword">in</span></span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span>
  Theory.setup
   <span class="main">(</span><span class="entity">entity_antiqs</span> <span class="entity">no_check</span> <span class="inner_quoted">""</span> <span class="antiquoted"><span class="entity"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span>‹syntax›</span></span> #&gt;
    <span class="entity">entity_antiqs</span> <span class="entity">Outer_Syntax.check_command</span> <span class="inner_quoted">"isacommand"</span> <span class="antiquoted"><span class="entity"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span>‹command›</span></span> #&gt;
    <span class="entity">entity_antiqs</span> <span class="entity">check_keyword</span> <span class="inner_quoted">"isakeyword"</span> <span class="antiquoted"><span class="entity"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span>‹keyword›</span></span> #&gt;
    <span class="entity">entity_antiqs</span> <span class="entity">check_keyword</span> <span class="inner_quoted">"isakeyword"</span> <span class="antiquoted"><span class="entity"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span>‹element›</span></span> #&gt;
    <span class="entity">entity_antiqs</span> <span class="entity">Method.check_name</span> <span class="inner_quoted">""</span> <span class="antiquoted"><span class="entity"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span>‹method›</span></span> #&gt;
    <span class="entity">entity_antiqs</span> <span class="entity">Attrib.check_name</span> <span class="inner_quoted">""</span> <span class="antiquoted"><span class="entity"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span>‹attribute›</span></span> #&gt;
    <span class="entity">entity_antiqs</span> <span class="entity">no_check</span> <span class="inner_quoted">""</span> <span class="antiquoted"><span class="entity"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span>‹fact›</span></span> #&gt;
    <span class="entity">entity_antiqs</span> <span class="entity">no_check</span> <span class="inner_quoted">""</span> <span class="antiquoted"><span class="entity"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span>‹variable›</span></span> #&gt;
    <span class="entity">entity_antiqs</span> <span class="entity">no_check</span> <span class="inner_quoted">""</span> <span class="antiquoted"><span class="entity"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span>‹case›</span></span> #&gt;
    <span class="entity">entity_antiqs</span> <span class="entity">Document_Antiquotation.check</span> <span class="inner_quoted">""</span> <span class="antiquoted"><span class="entity"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span>‹antiquotation›</span></span> #&gt;
    <span class="entity">entity_antiqs</span> <span class="entity">Document_Antiquotation.check_option</span> <span class="inner_quoted">""</span> <span class="antiquoted"><span class="entity"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span>‹antiquotation_option›</span></span> #&gt;
    <span class="entity">entity_antiqs</span> Document_Marker.check <span class="inner_quoted">""</span> <span class="antiquoted"><span class="entity"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span>‹document_marker›</span></span> #&gt;
    <span class="entity">entity_antiqs</span> <span class="entity">no_check</span> <span class="inner_quoted">"isasystem"</span> <span class="antiquoted"><span class="entity"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span>‹setting›</span></span> #&gt;
    <span class="entity">entity_antiqs</span> <span class="entity">check_system_option</span> <span class="inner_quoted">"isasystem"</span> <span class="antiquoted"><span class="entity"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span>‹system_option›</span></span> #&gt;
    <span class="entity">entity_antiqs</span> <span class="entity">no_check</span> <span class="inner_quoted">""</span> <span class="antiquoted"><span class="entity"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span>‹inference›</span></span> #&gt;
    <span class="entity">entity_antiqs</span> <span class="entity">no_check</span> <span class="inner_quoted">"isasystem"</span> <span class="antiquoted"><span class="entity"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span>‹executable›</span></span> #&gt;
    <span class="entity">entity_antiqs</span> <span class="entity">Isabelle_Tool.check</span> <span class="inner_quoted">"isatool"</span> <span class="antiquoted"><span class="entity"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span>‹tool›</span></span> #&gt;
    <span class="entity">entity_antiqs</span> ML_Context.check_antiquotation <span class="inner_quoted">""</span> <span class="antiquoted"><span class="entity"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span>‹ML_antiquotation›</span></span> #&gt;
    <span class="entity">entity_antiqs</span> <span class="main">(</span>K <span class="entity">JEdit.check_action</span><span class="main">)</span> <span class="inner_quoted">"isasystem"</span> <span class="antiquoted"><span class="entity"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span>‹action›</span></span><span class="main">)</span><span class="main">;</span>

<span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

<span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>
</pre>
</div><div id="Isabelle_Cartouche_Examples">
<div class="head">
<h1>Theory Isabelle_Cartouche_Examples</h1>
</div>
<pre class="source"><span class="comment1">(******************************************************************************
 * ISABELLE COPYRIGHT NOTICE, LICENCE AND DISCLAIMER.
 *
 * Copyright (c) 1986-2018 Contributors (in the changeset history)
 *
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are
 * met:
 *
 *     * Redistributions of source code must retain the above copyright
 *       notice, this list of conditions and the following disclaimer.
 *
 *     * Redistributions in binary form must reproduce the above
 *       copyright notice, this list of conditions and the following
 *       disclaimer in the documentation and/or other materials provided
 *       with the distribution.
 *
 *     * Neither the name of the copyright holders nor the names of its
 *       contributors may be used to endorse or promote products derived
 *       from this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 ******************************************************************************)</span>

<span class="keyword1"><span class="command">chapter</span></span><span class="quoted"><span class="plain_text">‹Part ...›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Isabelle_Cartouche_Examples
<span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">ML</span></span> <span class="quoted">‹
<span class="comment1">(*  Title:      HOL/ex/Cartouche_Examples.thy
    Author:     Makarius
*)</span>
  <span class="keyword2"><span class="keyword">local</span></span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk_char</span> <span class="main">(</span><span class="entity">f_char</span><span class="main">,</span> <span class="entity">f_cons</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> <span class="main">(</span><span class="entity">s</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> <span class="entity">accu</span> <span class="main">=</span>
        fold
          <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">c</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">accu</span><span class="main">,</span> <span class="entity">l</span><span class="main">)</span> <span class="main">=&gt;</span>
            <span class="main">(</span><span class="entity">f_char</span> <span class="entity">c</span> <span class="entity">accu</span><span class="main">,</span> <span class="entity">f_cons</span> <span class="entity">c</span> <span class="entity">l</span><span class="main">)</span><span class="main">)</span>
          <span class="main">(</span>rev <span class="main">(</span>map Char.ord <span class="main">(</span>String.explode <span class="entity">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
          <span class="entity">accu</span><span class="main">;</span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk_string</span> <span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">,</span> <span class="entity">f_nil</span><span class="main">)</span> <span class="entity">accu</span> <span class="main">[</span><span class="main">]</span> <span class="main">=</span> <span class="main">(</span><span class="entity">accu</span><span class="main">,</span> <span class="entity">f_nil</span><span class="main">)</span>
      <span class="main">|</span> <span class="entity">mk_string</span> <span class="entity">f</span> <span class="entity">accu</span> <span class="main">(</span><span class="entity">s</span> :: <span class="entity">ss</span><span class="main">)</span> <span class="main">=</span> <span class="entity">mk_char</span> <span class="entity">f</span> <span class="entity">s</span> <span class="main">(</span><span class="entity">mk_string</span> <span class="entity">f</span> <span class="entity">accu</span> <span class="entity">ss</span><span class="main">)</span><span class="main">;</span>
  <span class="keyword2"><span class="keyword">in</span></span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">string_tr</span> <span class="entity">f</span> <span class="entity">f_mk</span> <span class="entity">accu</span> <span class="entity">content</span> <span class="entity">args</span> <span class="main">=</span>
      <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">err</span> <span class="main">(</span><span class="main">)</span> <span class="main">=</span> <span class="keyword3"><span class="keyword">raise</span></span> TERM <span class="main">(</span><span class="inner_quoted">"string_tr"</span><span class="main">,</span> <span class="entity">args</span><span class="main">)</span> <span class="keyword2"><span class="keyword">in</span></span>
        <span class="main">(</span><span class="keyword2"><span class="keyword">case</span></span> <span class="entity">args</span> <span class="keyword2"><span class="keyword">of</span></span>
          <span class="main">[</span><span class="main">(</span><span class="entity">c</span> <span class="keyword1"><span class="keyword">as</span></span> Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">syntax_const</span> "_constrain"<span class="antiquote">}</span></span><span class="main">,</span> <span class="main">_</span><span class="main">)</span><span class="main">)</span> $ Free <span class="main">(</span><span class="entity">s</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> $ <span class="entity">p</span><span class="main">]</span> <span class="main">=&gt;</span>
            <span class="main">(</span><span class="keyword2"><span class="keyword">case</span></span> Term_Position.decode_position <span class="entity">p</span> <span class="keyword2"><span class="keyword">of</span></span>
              SOME <span class="main">(</span><span class="entity">pos</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">c</span> $ <span class="entity">f</span> <span class="main">(</span><span class="entity">mk_string</span> <span class="entity">f_mk</span> <span class="entity">accu</span> <span class="main">(</span><span class="entity">content</span> <span class="main">(</span><span class="entity">s</span><span class="main">,</span> <span class="entity">pos</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> $ <span class="entity">p</span>
            <span class="main">|</span> NONE <span class="main">=&gt;</span> <span class="entity">err</span> <span class="main">(</span><span class="main">)</span><span class="main">)</span>
        <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="entity">err</span> <span class="main">(</span><span class="main">)</span><span class="main">)</span>
      <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>
  <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>
›</span>

<span class="keyword1"><span class="command">syntax</span></span> <span class="quoted">"_cartouche_string"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"cartouche_position <span class="main">⇒</span> <span class="main">_</span>"</span></span>  <span class="main">(</span><span class="quoted">"_"</span><span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Isabelle_Main0">
<div class="head">
<h1>Theory Isabelle_Main0</h1>
</div>
<pre class="source"><span class="comment1">(******************************************************************************
 * A Meta-Model for the Isabelle API
 *
 * Copyright (c) 2011-2018 Université Paris-Saclay, Univ. Paris-Sud, France
 *               2013-2017 IRT SystemX, France
 *               2011-2015 Achim D. Brucker, Germany
 *               2016-2018 The University of Sheffield, UK
 *               2016-2017 Nanyang Technological University, Singapore
 *               2017-2018 Virginia Tech, USA
 *
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are
 * met:
 *
 *     * Redistributions of source code must retain the above copyright
 *       notice, this list of conditions and the following disclaimer.
 *
 *     * Redistributions in binary form must reproduce the above
 *       copyright notice, this list of conditions and the following
 *       disclaimer in the documentation and/or other materials provided
 *       with the distribution.
 *
 *     * Neither the name of the copyright holders nor the names of its
 *       contributors may be used to endorse or promote products derived
 *       from this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 ******************************************************************************)</span>

<span class="keyword1"><span class="command">theory</span></span>   Isabelle_Main0
<span class="keyword2"><span class="keyword">imports</span></span>  <span class="quoted">"<a href="Isabelle_Cartouche_Examples.html">ex/Isabelle_Cartouche_Examples</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Isabelle_code_target">
<div class="head">
<h1>Theory Isabelle_code_target</h1>
</div>
<pre class="source"><span class="comment1">(******************************************************************************
 * ISABELLE COPYRIGHT NOTICE, LICENCE AND DISCLAIMER.
 *
 * Copyright (c) 1986-2018 Contributors (in the changeset history)
 *
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are
 * met:
 *
 *     * Redistributions of source code must retain the above copyright
 *       notice, this list of conditions and the following disclaimer.
 *
 *     * Redistributions in binary form must reproduce the above
 *       copyright notice, this list of conditions and the following
 *       disclaimer in the documentation and/or other materials provided
 *       with the distribution.
 *
 *     * Neither the name of the copyright holders nor the names of its
 *       contributors may be used to endorse or promote products derived
 *       from this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 ******************************************************************************)</span>

<span class="keyword1"><span class="command">chapter</span></span><span class="quoted"><span class="plain_text">‹Part ...›</span></span>

<span class="keyword1"><span class="command">theory</span></span>  Isabelle_code_target
<span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a>
<span class="keyword2"><span class="keyword">keywords</span></span> <span class="quoted">"attach"</span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted">"lazy_code_printing"</span> <span class="quoted">"apply_code_printing"</span> <span class="quoted">"apply_code_printing_reflect"</span>
           <span class="main">::</span> thy_decl
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹beginning (lazy code printing)›</span></span>

<span class="keyword1"><span class="command">ML</span></span><span class="quoted">‹
<span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">Isabelle_Code_Target</span> <span class="main">=</span>
<span class="keyword2"><span class="keyword">struct</span></span>
<span class="comment1">(*  Title:      Tools/Code/code_target.ML
    Author:     Florian Haftmann, TU Muenchen

Generic infrastructure for target language data.
*)</span>

<span class="keyword3"><span class="keyword">open</span></span> Basic_Code_Symbol<span class="main">;</span>
<span class="keyword3"><span class="keyword">open</span></span> Basic_Code_Thingol<span class="main">;</span>



<span class="comment1">(** checking and parsing of symbols **)</span>


<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">parse_classrel_ident</span> <span class="main">=</span> Parse.class --| <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">keyword</span> "<span class="keyword2">&lt;</span>"<span class="antiquote">}</span></span></span> -- Parse.class<span class="main">;</span>


<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">parse_inst_ident</span> <span class="main">=</span> Parse.name --| <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">keyword</span> "<span class="keyword2">::</span>"<span class="antiquote">}</span></span></span> -- Parse.class<span class="main">;</span>



<span class="comment1">(** serializations and serializer **)</span>

<span class="comment1">(* serialization: abstract nonsense to cover different destinies for generated code *)</span>



<span class="comment1">(* serializers: functions producing serializations *)</span>



<span class="comment1">(** theory data **)</span>



<span class="comment1">(** serializer usage **)</span>

<span class="comment1">(* montage *)</span>



<span class="comment1">(* code generation *)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">prep_destination</span> <span class="entity">s</span> <span class="main">=</span> <span class="main">(</span><span class="main">{</span>physical <span class="main">=</span> true<span class="main">}</span><span class="main">,</span> <span class="main">(</span>Path.explode <span class="entity">s</span><span class="main">,</span> Position.none<span class="main">)</span><span class="main">)</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">export_code_cmd</span> <span class="entity">all_public</span> <span class="entity">raw_cs</span> <span class="entity">seris</span> <span class="entity">thy</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ctxt</span> <span class="main">=</span> Proof_Context.init_global <span class="entity">thy</span><span class="main">;</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">cs</span> <span class="main">=</span> <span class="entity">Code_Thingol.read_const_exprs</span> <span class="entity">ctxt</span> <span class="entity">raw_cs</span><span class="main">;</span>
  <span class="keyword2"><span class="keyword">in</span></span>
    <span class="entity">thy</span> |&gt; <span class="entity">Named_Target.theory_map</span>
      <span class="main">(</span><span class="entity">Code_Target.export_code</span> <span class="entity">all_public</span> <span class="entity">cs</span>
        <span class="main">(</span><span class="main">(</span>map o apfst o apsnd o Option.map<span class="main">)</span> <span class="entity">prep_destination</span> <span class="entity">seris</span><span class="main">)</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>



<span class="comment1">(** serializer configuration **)</span>

<span class="comment1">(* reserved symbol names *)</span>



<span class="comment1">(* checking of syntax *)</span>



<span class="comment1">(* custom symbol names *)</span>



<span class="comment1">(* custom printings *)</span>



<span class="comment1">(* concrete syntax *)</span>


<span class="comment1">(** Isar setup **)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">parse_single_symbol_pragma</span> <span class="entity">parse_keyword</span> <span class="entity">parse_isa</span> <span class="entity">parse_target</span> <span class="main">=</span>
  <span class="entity">parse_keyword</span> |-- Parse.!!! <span class="main">(</span><span class="entity">parse_isa</span> --| <span class="main">(</span><span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">keyword</span> "<span class="keyword2">⇀</span>"<span class="antiquote">}</span></span></span> || <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">keyword</span> "<span class="keyword2">=&gt;</span>"<span class="antiquote">}</span></span></span><span class="main">)</span>
    -- Parse.and_list1 <span class="main">(</span><span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">keyword</span> "<span class="keyword2">(</span>"<span class="antiquote">}</span></span></span> |-- <span class="main">(</span>Parse.name --| <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">keyword</span> "<span class="keyword2">)</span>"<span class="antiquote">}</span></span></span> -- Scan.option <span class="entity">parse_target</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">parse_symbol_pragma</span> <span class="entity">parse_const</span> <span class="entity">parse_tyco</span> <span class="entity">parse_class</span> <span class="entity">parse_classrel</span> <span class="entity">parse_inst</span> <span class="entity">parse_module</span> <span class="main">=</span>
  <span class="entity">parse_single_symbol_pragma</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">keyword</span> "<span class="keyword2">constant</span>"<span class="antiquote">}</span></span></span> Parse.term <span class="entity">parse_const</span>
    &gt;&gt; <span class="entity">Constant</span>
  || <span class="entity">parse_single_symbol_pragma</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">keyword</span> "<span class="keyword2">type_constructor</span>"<span class="antiquote">}</span></span></span> Parse.type_const <span class="entity">parse_tyco</span>
    &gt;&gt; <span class="entity">Type_Constructor</span>
  || <span class="entity">parse_single_symbol_pragma</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">keyword</span> "<span class="keyword2">type_class</span>"<span class="antiquote">}</span></span></span> Parse.class <span class="entity">parse_class</span>
    &gt;&gt; <span class="entity">Type_Class</span>
  || <span class="entity">parse_single_symbol_pragma</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">keyword</span> "<span class="keyword2">class_relation</span>"<span class="antiquote">}</span></span></span> <span class="entity">parse_classrel_ident</span> <span class="entity">parse_classrel</span>
    &gt;&gt; <span class="entity">Class_Relation</span>
  || <span class="entity">parse_single_symbol_pragma</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">keyword</span> "<span class="keyword2">class_instance</span>"<span class="antiquote">}</span></span></span> <span class="entity">parse_inst_ident</span> <span class="entity">parse_inst</span>
    &gt;&gt; <span class="entity">Class_Instance</span>
  || <span class="entity">parse_single_symbol_pragma</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">keyword</span> "<span class="keyword2">code_module</span>"<span class="antiquote">}</span></span></span> Parse.name <span class="entity">parse_module</span>
    &gt;&gt; <span class="entity">Code_Symbol.Module</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">parse_symbol_pragmas</span> <span class="entity">parse_const</span> <span class="entity">parse_tyco</span> <span class="entity">parse_class</span> <span class="entity">parse_classrel</span> <span class="entity">parse_inst</span> <span class="entity">parse_module</span> <span class="main">=</span>
  Parse.enum1 <span class="inner_quoted">"|"</span> <span class="main">(</span>Parse.group <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="inner_quoted">"code symbol pragma"</span><span class="main">)</span>
    <span class="main">(</span><span class="entity">parse_symbol_pragma</span> <span class="entity">parse_const</span> <span class="entity">parse_tyco</span> <span class="entity">parse_class</span> <span class="entity">parse_classrel</span> <span class="entity">parse_inst</span> <span class="entity">parse_module</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>

<span class="keyword2"><span class="keyword">end</span></span>
›</span>

<span class="keyword1"><span class="command">ML</span></span><span class="quoted">‹
<span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">Code_printing</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">struct</span></span>
<span class="keyword1"><span class="keyword">datatype</span></span> <span class="entity">code_printing</span> <span class="main">=</span> <span class="entity">Code_printing</span> <span class="keyword2"><span class="keyword">of</span></span>
     <span class="main">(</span>string * <span class="main">(</span>bstring * Code_Printer.raw_const_syntax option<span class="main">)</span> list<span class="main">,</span>
      string * <span class="main">(</span>bstring * Code_Printer.tyco_syntax option<span class="main">)</span> list<span class="main">,</span>
      string * <span class="main">(</span>bstring * string option<span class="main">)</span> list<span class="main">,</span>
      <span class="main">(</span>string * string<span class="main">)</span> * <span class="main">(</span>bstring * unit option<span class="main">)</span> list<span class="main">,</span>
      <span class="main">(</span>xstring * string<span class="main">)</span> * <span class="main">(</span>bstring * unit option<span class="main">)</span> list<span class="main">,</span>
      bstring * <span class="main">(</span>bstring * <span class="main">(</span>string * Code_Symbol.T list<span class="main">)</span> option<span class="main">)</span> list<span class="main">)</span>
      Code_Symbol.attr
      list

<span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">Data_code</span> <span class="main">=</span> Theory_Data
  <span class="main">(</span><span class="keyword1"><span class="keyword">type</span></span> <span class="entity">T</span> <span class="main">=</span> <span class="entity">code_printing</span> list Symtab.table
   <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">empty</span> <span class="main">=</span> Symtab.empty
   <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">extend</span> <span class="main">=</span> I
   <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">merge</span> <span class="main">=</span> Symtab.merge <span class="main">(</span>K true<span class="main">)</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">code_empty</span> <span class="main">=</span> <span class="inner_quoted">""</span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="main">)</span> <span class="main">=</span>
  <span class="entity">Outer_Syntax.command</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">command_keyword</span> <span class="keyword1">lazy_code_printing</span><span class="antiquote">}</span></span></span> <span class="inner_quoted">"declare dedicated printing for code symbols"</span>
    <span class="main">(</span><span class="entity">Isabelle_Code_Target.parse_symbol_pragmas</span> <span class="main">(</span><span class="entity">Code_Printer.parse_const_syntax</span><span class="main">)</span> <span class="main">(</span><span class="entity">Code_Printer.parse_tyco_syntax</span><span class="main">)</span>
      Parse.string <span class="main">(</span>Parse.minus &gt;&gt; K <span class="main">(</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Parse.minus &gt;&gt; K <span class="main">(</span><span class="main">)</span><span class="main">)</span>
      <span class="main">(</span>Parse.text -- Scan.optional <span class="main">(</span><span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">keyword</span> "<span class="keyword2">attach</span>"<span class="antiquote">}</span></span></span> |-- Scan.repeat1 Parse.term &gt;&gt; map <span class="entity">Code_Symbol.Constant</span><span class="main">)</span> <span class="main">[</span><span class="main">]</span><span class="main">)</span>
      &gt;&gt; <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">code</span> <span class="main">=&gt;</span>
            <span class="entity">Toplevel.theory</span> <span class="main">(</span>Data_code.map <span class="main">(</span>Symtab.map_default <span class="main">(</span><span class="entity">code_empty</span><span class="main">,</span> <span class="main">[</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">l</span> <span class="main">=&gt;</span> <span class="entity">Code_printing</span> <span class="entity">code</span> :: <span class="entity">l</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">apply_code_printing</span> <span class="entity">thy</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">case</span></span> Symtab.lookup <span class="main">(</span>Data_code.get <span class="entity">thy</span><span class="main">)</span> <span class="entity">code_empty</span> <span class="keyword2"><span class="keyword">of</span></span> SOME <span class="entity">l</span> <span class="main">=&gt;</span> rev <span class="entity">l</span> <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="main">[</span><span class="main">]</span><span class="main">)</span>
 |&gt; <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">l</span> <span class="main">=&gt;</span> fold <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">Code_printing</span> <span class="entity">l</span> <span class="main">=&gt;</span> fold <span class="entity">Code_Target.set_printings</span> <span class="entity">l</span><span class="main">)</span> <span class="entity">l</span> <span class="entity">thy</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="main">)</span> <span class="main">=</span>
  <span class="entity">Outer_Syntax.command</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">command_keyword</span> <span class="keyword1">apply_code_printing</span><span class="antiquote">}</span></span></span> <span class="inner_quoted">"apply dedicated printing for code symbols"</span>
    <span class="main">(</span>Parse.$$$ <span class="inner_quoted">"("</span> -- Parse.$$$ <span class="inner_quoted">")"</span> &gt;&gt; K <span class="main">(</span><span class="entity">Toplevel.theory</span> <span class="entity">apply_code_printing</span><span class="main">)</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">reflect_ml</span> <span class="entity">source</span> <span class="entity">thy</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">case</span></span> ML_Context.exec <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="main">)</span> <span class="main">=&gt;</span>
            ML_Context.eval_source <span class="main">(</span>ML_Compiler.verbose false ML_Compiler.flags<span class="main">)</span> <span class="entity">source</span><span class="main">)</span> <span class="main">(</span>Context.Theory <span class="entity">thy</span><span class="main">)</span> <span class="keyword2"><span class="keyword">of</span></span>
    Context.Theory <span class="entity">thy</span> <span class="main">=&gt;</span> <span class="entity">thy</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">apply_code_printing_reflect</span> <span class="entity">thy</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">case</span></span> Symtab.lookup <span class="main">(</span>Data_code.get <span class="entity">thy</span><span class="main">)</span> <span class="entity">code_empty</span> <span class="keyword2"><span class="keyword">of</span></span> SOME <span class="entity">l</span> <span class="main">=&gt;</span> rev <span class="entity">l</span> <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="main">[</span><span class="main">]</span><span class="main">)</span>
 |&gt; <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">l</span> <span class="main">=&gt;</span> fold <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">Code_printing</span> <span class="entity">l</span> <span class="main">=&gt;</span>
      fold <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">Code_Symbol.Module</span> <span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="entity">l</span><span class="main">)</span> <span class="main">=&gt;</span>
                 fold <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="inner_quoted">"SML"</span><span class="main">,</span> SOME <span class="main">(</span><span class="entity">txt</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">reflect_ml</span> <span class="main">(</span>Input.source false <span class="entity">txt</span> <span class="main">(</span>Position.none<span class="main">,</span> Position.none<span class="main">)</span><span class="main">)</span>
                        <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> I<span class="main">)</span> <span class="entity">l</span>
             <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> I<span class="main">)</span> <span class="entity">l</span><span class="main">)</span> <span class="entity">l</span> <span class="entity">thy</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="main">)</span> <span class="main">=</span>
  <span class="entity">Outer_Syntax.command</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">command_keyword</span> <span class="keyword1">apply_code_printing_reflect</span><span class="antiquote">}</span></span></span> <span class="inner_quoted">"apply dedicated printing for code symbols"</span>
    <span class="main">(</span>Parse.ML_source &gt;&gt; <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">src</span> <span class="main">=&gt;</span> <span class="entity">Toplevel.theory</span> <span class="main">(</span><span class="entity">apply_code_printing_reflect</span> o <span class="entity">reflect_ml</span> <span class="entity">src</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

›</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Isabelle_code_runtime">
<div class="head">
<h1>Theory Isabelle_code_runtime</h1>
</div>
<pre class="source"><span class="comment1">(******************************************************************************
 * ISABELLE COPYRIGHT NOTICE, LICENCE AND DISCLAIMER.
 *
 * Copyright (c) 1986-2018 Contributors (in the changeset history)
 *
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are
 * met:
 *
 *     * Redistributions of source code must retain the above copyright
 *       notice, this list of conditions and the following disclaimer.
 *
 *     * Redistributions in binary form must reproduce the above
 *       copyright notice, this list of conditions and the following
 *       disclaimer in the documentation and/or other materials provided
 *       with the distribution.
 *
 *     * Neither the name of the copyright holders nor the names of its
 *       contributors may be used to endorse or promote products derived
 *       from this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 ******************************************************************************)</span>

<span class="keyword1"><span class="command">chapter</span></span><span class="quoted"><span class="plain_text">‹Part ...›</span></span>

<span class="keyword1"><span class="command">theory</span></span>  Isabelle_code_runtime
<span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a>
  <span class="keyword2"><span class="keyword">keywords</span></span> <span class="quoted">"code_reflect'"</span> <span class="main">::</span> thy_decl
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">ML</span></span><span class="quoted">‹
<span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">Code_Runtime</span> <span class="main">=</span>
<span class="keyword2"><span class="keyword">struct</span></span>
<span class="comment1">(*  Title:      Tools/Code/code_runtime.ML
    Author:     Florian Haftmann, TU Muenchen

Runtime services building on code generation into implementation language SML.
*)</span>

<span class="keyword3"><span class="keyword">open</span></span> Basic_Code_Symbol<span class="main">;</span>
<span class="keyword3"><span class="keyword">open</span></span> Basic_Code_Thingol<span class="main">;</span>

<span class="comment1">(** evaluation **)</span>

<span class="comment1">(* technical prerequisites *)</span>


<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">trace</span> <span class="main">=</span> <span class="entity">Attrib.setup_config_bool</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">binding</span> "code_runtime_trace"<span class="antiquote">}</span></span></span> <span class="main">(</span>K false<span class="main">)</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">exec</span> <span class="entity">ctxt</span> <span class="entity">verbose</span> <span class="entity">code</span> <span class="main">=</span>
 <span class="main">(</span><span class="keyword2"><span class="keyword">if</span></span> Config.get <span class="entity">ctxt</span> <span class="entity">trace</span> <span class="keyword2"><span class="keyword">then</span></span> tracing <span class="entity">code</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="main">(</span><span class="main">)</span><span class="main">;</span>
  ML_Context.exec <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="main">)</span> <span class="main">=&gt;</span>
    ML_Compiler0.ML ML_Env.context
      <span class="main">{</span>line <span class="main">=</span> <span class="inner_numeral">0</span><span class="main">,</span> file <span class="main">=</span> <span class="inner_quoted">"generated code"</span><span class="main">,</span> verbose <span class="main">=</span> <span class="entity">verbose</span><span class="main">,</span> debug <span class="main">=</span> false<span class="main">}</span> <span class="entity">code</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>



<span class="comment1">(* evaluation into target language values *)</span>



<span class="comment1">(* evaluation for truth or nothing *)</span>



<span class="comment1">(** full static evaluation -- still with limited coverage! **)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">evaluation_code</span> <span class="entity">ctxt</span> <span class="entity">module_name</span> <span class="entity">program</span> <span class="entity">tycos</span> <span class="entity">consts</span> <span class="entity">all_public</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">thy</span> <span class="main">=</span> Proof_Context.theory_of <span class="entity">ctxt</span><span class="main">;</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">ml_modules</span><span class="main">,</span> <span class="entity">target_names</span><span class="main">)</span> <span class="main">=</span>
      <span class="entity">Code_Target.produce_code_for</span> <span class="entity">ctxt</span>
        <span class="entity">Code_Runtime.target</span> <span class="entity">module_name</span> NONE <span class="main">[</span><span class="main">]</span> <span class="entity">program</span> <span class="entity">all_public</span> <span class="main">(</span>map <span class="entity">Constant</span> <span class="entity">consts</span> @ map <span class="entity">Type_Constructor</span> <span class="entity">tycos</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ml_code</span> <span class="main">=</span> space_implode <span class="inner_quoted">"\n\n"</span> <span class="main">(</span>map snd <span class="entity">ml_modules</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">consts'</span><span class="main">,</span> <span class="entity">tycos'</span><span class="main">)</span> <span class="main">=</span> chop <span class="main">(</span>length <span class="entity">consts</span><span class="main">)</span> <span class="entity">target_names</span><span class="main">;</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">consts_map</span> <span class="main">=</span> map2 <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">const</span> <span class="main">=&gt;</span>
      <span class="keyword1"><span class="keyword">fn</span></span> NONE <span class="main">=&gt;</span>
          error <span class="main">(</span><span class="inner_quoted">"Constant "</span> ^ <span class="main">(</span>quote o <span class="entity">Code.string_of_const</span> <span class="entity">thy</span><span class="main">)</span> <span class="entity">const</span> ^
            <span class="inner_quoted">"\nhas a user-defined serialization"</span><span class="main">)</span>
       <span class="main">|</span> SOME <span class="entity">const'</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="entity">const</span><span class="main">,</span> <span class="entity">const'</span><span class="main">)</span><span class="main">)</span> <span class="entity">consts</span> <span class="entity">consts'</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">tycos_map</span> <span class="main">=</span> map2 <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">tyco</span> <span class="main">=&gt;</span>
      <span class="keyword1"><span class="keyword">fn</span></span> NONE <span class="main">=&gt;</span>
          error <span class="main">(</span><span class="inner_quoted">"Type "</span> ^ quote <span class="main">(</span>Proof_Context.markup_type <span class="entity">ctxt</span> <span class="entity">tyco</span><span class="main">)</span> ^
            <span class="inner_quoted">"\nhas a user-defined serialization"</span><span class="main">)</span>
        <span class="main">|</span> SOME <span class="entity">tyco'</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="entity">tyco</span><span class="main">,</span> <span class="entity">tyco'</span><span class="main">)</span><span class="main">)</span> <span class="entity">tycos</span> <span class="entity">tycos'</span><span class="main">;</span>
  <span class="keyword2"><span class="keyword">in</span></span> <span class="main">(</span><span class="entity">ml_code</span><span class="main">,</span> <span class="main">(</span><span class="entity">tycos_map</span><span class="main">,</span> <span class="entity">consts_map</span><span class="main">)</span><span class="main">)</span> <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>



<span class="comment1">(** code antiquotation **)</span>



<span class="comment1">(** reflection support **)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">check_datatype</span> <span class="entity">thy</span> <span class="entity">tyco</span> <span class="entity">some_consts</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">constrs</span> <span class="main">=</span> <span class="main">(</span>map fst o snd o fst o <span class="entity">Code.get_type</span> <span class="entity">thy</span><span class="main">)</span> <span class="entity">tyco</span><span class="main">;</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">some_consts</span>
     <span class="keyword2"><span class="keyword">of</span></span> SOME <span class="entity">consts</span> <span class="main">=&gt;</span>
          <span class="keyword2"><span class="keyword">let</span></span>
            <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">missing_constrs</span> <span class="main">=</span> subtract <span class="main">(</span><span class="keyword1"><span class="keyword">op</span></span> <span class="main">=</span><span class="main">)</span> <span class="entity">consts</span> <span class="entity">constrs</span><span class="main">;</span>
            <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">if</span></span> null <span class="entity">missing_constrs</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="main">[</span><span class="main">]</span>
              <span class="keyword2"><span class="keyword">else</span></span> error <span class="main">(</span><span class="inner_quoted">"Missing constructor(s) "</span> ^ commas_quote <span class="entity">missing_constrs</span>
                ^ <span class="inner_quoted">" for datatype "</span> ^ quote <span class="entity">tyco</span><span class="main">)</span><span class="main">;</span>
            <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">false_constrs</span> <span class="main">=</span> subtract <span class="main">(</span><span class="keyword1"><span class="keyword">op</span></span> <span class="main">=</span><span class="main">)</span> <span class="entity">constrs</span> <span class="entity">consts</span><span class="main">;</span>
            <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">if</span></span> null <span class="entity">false_constrs</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="main">[</span><span class="main">]</span>
              <span class="keyword2"><span class="keyword">else</span></span> error <span class="main">(</span><span class="inner_quoted">"Non-constructor(s) "</span> ^ commas_quote <span class="entity">false_constrs</span>
                ^ <span class="inner_quoted">" for datatype "</span> ^ quote <span class="entity">tyco</span><span class="main">)</span>
          <span class="keyword2"><span class="keyword">in</span></span> <span class="main">(</span><span class="main">)</span> <span class="keyword2"><span class="keyword">end</span></span>
      <span class="main">|</span> NONE <span class="main">=&gt;</span> <span class="main">(</span><span class="main">)</span><span class="main">;</span>
  <span class="keyword2"><span class="keyword">in</span></span> <span class="main">(</span><span class="entity">tyco</span><span class="main">,</span> <span class="entity">constrs</span><span class="main">)</span> <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">add_eval_tyco</span> <span class="main">(</span><span class="entity">tyco</span><span class="main">,</span> <span class="entity">tyco'</span><span class="main">)</span> <span class="entity">thy</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">k</span> <span class="main">=</span> Sign.arity_number <span class="entity">thy</span> <span class="entity">tyco</span><span class="main">;</span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">pr</span> <span class="entity">pr'</span> <span class="main">_</span> <span class="main">[</span><span class="main">]</span> <span class="main">=</span> <span class="entity">tyco'</span>
      <span class="main">|</span> <span class="entity">pr</span> <span class="entity">pr'</span> <span class="main">_</span> <span class="main">[</span><span class="entity">ty</span><span class="main">]</span> <span class="main">=</span>
          <span class="entity">Code_Printer.concat</span> <span class="main">[</span><span class="entity">pr'</span> <span class="entity">Code_Printer.BR</span> <span class="entity">ty</span><span class="main">,</span> <span class="entity">tyco'</span><span class="main">]</span>
      <span class="main">|</span> <span class="entity">pr</span> <span class="entity">pr'</span> <span class="main">_</span> <span class="entity">tys</span> <span class="main">=</span>
          <span class="entity">Code_Printer.concat</span> <span class="main">[</span><span class="entity">Code_Printer.enum</span> <span class="inner_quoted">","</span> <span class="inner_quoted">"("</span> <span class="inner_quoted">")"</span> <span class="main">(</span>map <span class="main">(</span><span class="entity">pr'</span> <span class="entity">Code_Printer.BR</span><span class="main">)</span> <span class="entity">tys</span><span class="main">)</span><span class="main">,</span> <span class="entity">tyco'</span><span class="main">]</span>
  <span class="keyword2"><span class="keyword">in</span></span>
    <span class="entity">thy</span>
    |&gt; <span class="entity">Code_Target.set_printings</span> <span class="main">(</span><span class="entity">Type_Constructor</span> <span class="main">(</span><span class="entity">tyco</span><span class="main">,</span> <span class="main">[</span><span class="main">(</span><span class="entity">Code_Runtime.target</span><span class="main">,</span> SOME <span class="main">(</span><span class="entity">k</span><span class="main">,</span> <span class="entity">pr</span><span class="main">)</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">add_eval_constr</span> <span class="main">(</span><span class="entity">const</span><span class="main">,</span> <span class="entity">const'</span><span class="main">)</span> <span class="entity">thy</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">k</span> <span class="main">=</span> <span class="entity">Code.args_number</span> <span class="entity">thy</span> <span class="entity">const</span><span class="main">;</span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">pr</span> <span class="entity">pr'</span> <span class="entity">fxy</span> <span class="entity">ts</span> <span class="main">=</span> <span class="entity">Code_Printer.brackify</span> <span class="entity">fxy</span>
      <span class="main">(</span><span class="entity">const'</span> :: the_list <span class="main">(</span><span class="entity">Code_Printer.tuplify</span> <span class="entity">pr'</span> <span class="entity">Code_Printer.BR</span> <span class="main">(</span>map fst <span class="entity">ts</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
  <span class="keyword2"><span class="keyword">in</span></span>
    <span class="entity">thy</span>
    |&gt; <span class="entity">Code_Target.set_printings</span> <span class="main">(</span><span class="entity">Constant</span> <span class="main">(</span><span class="entity">const</span><span class="main">,</span>
      <span class="main">[</span><span class="main">(</span><span class="entity">Code_Runtime.target</span><span class="main">,</span> SOME <span class="main">(</span><span class="entity">Code_Printer.simple_const_syntax</span> <span class="main">(</span><span class="entity">k</span><span class="main">,</span> <span class="entity">pr</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">add_eval_const</span> <span class="main">(</span><span class="entity">const</span><span class="main">,</span> <span class="entity">const'</span><span class="main">)</span> <span class="main">=</span> <span class="entity">Code_Target.set_printings</span> <span class="main">(</span><span class="entity">Constant</span>
  <span class="main">(</span><span class="entity">const</span><span class="main">,</span> <span class="main">[</span><span class="main">(</span><span class="entity">Code_Runtime.target</span><span class="main">,</span> SOME <span class="main">(</span><span class="entity">Code_Printer.simple_const_syntax</span> <span class="main">(</span><span class="inner_numeral">0</span><span class="main">,</span> <span class="main">(</span>K o K o K<span class="main">)</span> <span class="entity">const'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">process_reflection</span> <span class="main">(</span><span class="entity">code</span><span class="main">,</span> <span class="main">(</span><span class="entity">tyco_map</span><span class="main">,</span> <span class="main">(</span><span class="entity">constr_map</span><span class="main">,</span> <span class="entity">const_map</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="entity">module_name</span> NONE <span class="entity">thy</span> <span class="main">=</span>
      <span class="entity">thy</span>
      |&gt; <span class="entity">Code_Target.add_reserved</span> <span class="entity">Code_Runtime.target</span> <span class="entity">module_name</span>
      |&gt; Context.theory_map <span class="main">(</span><span class="entity">exec</span> <span class="main">(</span>Proof_Context.init_global <span class="entity">thy</span> <span class="comment1">(*FIXME*)</span><span class="main">)</span> true <span class="entity">code</span><span class="main">)</span>
      |&gt; fold <span class="main">(</span><span class="entity">add_eval_tyco</span> o apsnd <span class="entity">Code_Printer.str</span><span class="main">)</span> <span class="entity">tyco_map</span>
      |&gt; fold <span class="main">(</span><span class="entity">add_eval_constr</span> o apsnd <span class="entity">Code_Printer.str</span><span class="main">)</span> <span class="entity">constr_map</span>
      |&gt; fold <span class="main">(</span><span class="entity">add_eval_const</span> o apsnd <span class="entity">Code_Printer.str</span><span class="main">)</span> <span class="entity">const_map</span>
  <span class="main">|</span> <span class="entity">process_reflection</span> <span class="main">(</span><span class="entity">code</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> <span class="main">_</span> <span class="main">(</span>SOME <span class="entity">file_name</span><span class="main">)</span> <span class="entity">thy</span> <span class="main">=</span>
      <span class="keyword2"><span class="keyword">let</span></span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">preamble</span> <span class="main">=</span>
          <span class="inner_quoted">"(* Generated from "</span> ^
            Path.implode <span class="main">(</span><span class="entity">Resources.thy_path</span> <span class="main">(</span>Path.basic <span class="main">(</span>Context.theory_name <span class="entity">thy</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> ^
          <span class="inner_quoted">"; DO NOT EDIT! *)"</span><span class="main">;</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> File.write <span class="main">(</span>Path.explode <span class="entity">file_name</span><span class="main">)</span> <span class="main">(</span><span class="entity">preamble</span> ^ <span class="inner_quoted">"\n\n"</span> ^ <span class="entity">code</span><span class="main">)</span><span class="main">;</span>
      <span class="keyword2"><span class="keyword">in</span></span>
        <span class="entity">thy</span>
      <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">gen_code_reflect</span> <span class="entity">prep_type</span> <span class="entity">prep_const</span> <span class="entity">all_public</span> <span class="entity">raw_datatypes</span> <span class="entity">raw_functions</span> <span class="entity">module_name</span> <span class="entity">some_file</span> <span class="entity">thy</span>  <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ctxt</span> <span class="main">=</span> Proof_Context.init_global <span class="entity">thy</span><span class="main">;</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">datatypes</span> <span class="main">=</span> map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">raw_tyco</span><span class="main">,</span> <span class="entity">raw_cos</span><span class="main">)</span> <span class="main">=&gt;</span>
      <span class="main">(</span><span class="entity">prep_type</span> <span class="entity">ctxt</span> <span class="entity">raw_tyco</span><span class="main">,</span> <span class="main">(</span>Option.map o map<span class="main">)</span> <span class="main">(</span><span class="entity">prep_const</span> <span class="entity">thy</span><span class="main">)</span> <span class="entity">raw_cos</span><span class="main">)</span><span class="main">)</span> <span class="entity">raw_datatypes</span><span class="main">;</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">tycos</span><span class="main">,</span> <span class="entity">constrs</span><span class="main">)</span> <span class="main">=</span> map_split <span class="main">(</span>uncurry <span class="main">(</span><span class="entity">check_datatype</span> <span class="entity">thy</span><span class="main">)</span><span class="main">)</span> <span class="entity">datatypes</span>
      |&gt; apsnd flat<span class="main">;</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">functions</span> <span class="main">=</span> map <span class="main">(</span><span class="entity">prep_const</span> <span class="entity">thy</span><span class="main">)</span> <span class="entity">raw_functions</span><span class="main">;</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">consts</span> <span class="main">=</span> <span class="entity">constrs</span> @ <span class="entity">functions</span><span class="main">;</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">program</span> <span class="main">=</span> <span class="entity">Code_Thingol.consts_program</span> <span class="entity">ctxt</span> <span class="entity">consts</span><span class="main">;</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">result</span> <span class="main">=</span> <span class="entity">evaluation_code</span> <span class="entity">ctxt</span> <span class="entity">module_name</span> <span class="entity">program</span> <span class="entity">tycos</span> <span class="entity">consts</span> <span class="entity">all_public</span>
      |&gt; <span class="main">(</span>apsnd o apsnd<span class="main">)</span> <span class="main">(</span>chop <span class="main">(</span>length <span class="entity">constrs</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
  <span class="keyword2"><span class="keyword">in</span></span>
    <span class="entity">thy</span>
    |&gt; <span class="entity">process_reflection</span> <span class="entity">result</span> <span class="entity">module_name</span> <span class="entity">some_file</span>
  <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">code_reflect_cmd</span> <span class="main">=</span> <span class="entity">gen_code_reflect</span> <span class="entity">Code_Target.read_tyco</span> <span class="entity">Code.read_const</span><span class="main">;</span>


<span class="comment1">(** Isar setup **)</span>

<span class="keyword2"><span class="keyword">local</span></span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">parse_datatype</span> <span class="main">=</span>
  Parse.name --| <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">keyword</span> "<span class="keyword2">=</span>"<span class="antiquote">}</span></span></span> --
    <span class="main">(</span><span class="main">(</span><span class="main">(</span>Parse.sym_ident || Parse.string<span class="main">)</span> &gt;&gt; <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="inner_quoted">"_"</span> <span class="main">=&gt;</span> NONE <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> Scan.fail <span class="main">(</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
    || <span class="main">(</span><span class="main">(</span>Parse.term ::: <span class="main">(</span>Scan.repeat <span class="main">(</span><span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">keyword</span> "<span class="keyword2">|</span>"<span class="antiquote">}</span></span></span> |-- Parse.term<span class="main">)</span><span class="main">)</span><span class="main">)</span> &gt;&gt; SOME<span class="main">)</span><span class="main">)</span><span class="main">;</span>

<span class="keyword2"><span class="keyword">in</span></span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span>
  <span class="entity">Outer_Syntax.command</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">command_keyword</span> <span class="keyword1">code_reflect'</span><span class="antiquote">}</span></span></span>
    <span class="inner_quoted">"enrich runtime environment with generated code"</span>
    <span class="main">(</span>Scan.optional <span class="main">(</span><span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">keyword</span> "<span class="keyword2">open</span>"<span class="antiquote">}</span></span></span> |-- Scan.succeed true<span class="main">)</span> false --
     Parse.name -- Scan.optional <span class="main">(</span><span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">keyword</span> "<span class="keyword2">datatypes</span>"<span class="antiquote">}</span></span></span> |-- Parse.!!!  <span class="main">(</span><span class="entity">parse_datatype</span>
      ::: Scan.repeat <span class="main">(</span><span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">keyword</span> "<span class="keyword2">and</span>"<span class="antiquote">}</span></span></span> |-- <span class="entity">parse_datatype</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="main">]</span>
    -- Scan.optional <span class="main">(</span><span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">keyword</span> "<span class="keyword2">functions</span>"<span class="antiquote">}</span></span></span> |-- Parse.!!!  <span class="main">(</span>Scan.repeat1 Parse.name<span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="main">]</span>
    -- Scan.option <span class="main">(</span><span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">keyword</span> "<span class="keyword2">file</span>"<span class="antiquote">}</span></span></span> |-- Parse.!!! Parse.name<span class="main">)</span>
    &gt;&gt; <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="entity">all_public</span><span class="main">,</span> <span class="entity">module_name</span><span class="main">)</span><span class="main">,</span> <span class="entity">raw_datatypes</span><span class="main">)</span><span class="main">,</span> <span class="entity">raw_functions</span><span class="main">)</span><span class="main">,</span> <span class="entity">some_file</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">Toplevel.theory</span>
      <span class="main">(</span><span class="entity">code_reflect_cmd</span> <span class="entity">all_public</span> <span class="entity">raw_datatypes</span> <span class="entity">raw_functions</span> <span class="entity">module_name</span> <span class="entity">some_file</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span> <span class="comment1">(*local*)</span>

<span class="keyword2"><span class="keyword">end</span></span>
›</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Isabelle_Main1">
<div class="head">
<h1>Theory Isabelle_Main1</h1>
</div>
<pre class="source"><span class="comment1">(******************************************************************************
 * A Meta-Model for the Isabelle API
 *
 * Copyright (c) 2011-2018 Université Paris-Saclay, Univ. Paris-Sud, France
 *               2013-2017 IRT SystemX, France
 *               2011-2015 Achim D. Brucker, Germany
 *               2016-2018 The University of Sheffield, UK
 *               2016-2017 Nanyang Technological University, Singapore
 *               2017-2018 Virginia Tech, USA
 *
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are
 * met:
 *
 *     * Redistributions of source code must retain the above copyright
 *       notice, this list of conditions and the following disclaimer.
 *
 *     * Redistributions in binary form must reproduce the above
 *       copyright notice, this list of conditions and the following
 *       disclaimer in the documentation and/or other materials provided
 *       with the distribution.
 *
 *     * Neither the name of the copyright holders nor the names of its
 *       contributors may be used to endorse or promote products derived
 *       from this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 ******************************************************************************)</span>

<span class="keyword1"><span class="command">theory</span></span>   Isabelle_Main1
<span class="keyword2"><span class="keyword">imports</span></span>  <span class="quoted">"<a href="Isabelle_code_target.html">../Tools/Code/Isabelle_code_target</a>"</span>
         <span class="quoted">"<a href="Isabelle_code_runtime.html">../Tools/Code/Isabelle_code_runtime</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Isabelle_typedecl">
<div class="head">
<h1>Theory Isabelle_typedecl</h1>
</div>
<pre class="source"><span class="comment1">(******************************************************************************
 * ISABELLE COPYRIGHT NOTICE, LICENCE AND DISCLAIMER.
 *
 * Copyright (c) 1986-2018 Contributors (in the changeset history)
 *
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are
 * met:
 *
 *     * Redistributions of source code must retain the above copyright
 *       notice, this list of conditions and the following disclaimer.
 *
 *     * Redistributions in binary form must reproduce the above
 *       copyright notice, this list of conditions and the following
 *       disclaimer in the documentation and/or other materials provided
 *       with the distribution.
 *
 *     * Neither the name of the copyright holders nor the names of its
 *       contributors may be used to endorse or promote products derived
 *       from this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 ******************************************************************************)</span>

<span class="keyword1"><span class="command">chapter</span></span><span class="quoted"><span class="plain_text">‹Part ...›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Isabelle_typedecl
<span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">ML</span></span><span class="quoted">‹
<span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">Isabelle_Typedecl</span> <span class="main">=</span>
<span class="keyword2"><span class="keyword">struct</span></span>
<span class="comment1">(*  Title:      Pure/Isar/typedecl.ML
    Author:     Makarius

Type declarations (with object-logic arities) and type abbreviations.
*)</span>


<span class="comment1">(* type abbreviations *)</span>

<span class="keyword2"><span class="keyword">local</span></span>


<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">read_abbrev</span> <span class="entity">b</span> <span class="entity">ctxt</span> <span class="entity">raw_rhs</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">rhs</span> <span class="main">=</span> Proof_Context.read_typ_syntax <span class="main">(</span><span class="entity">ctxt</span> |&gt; Proof_Context.set_defsort <span class="main">[</span><span class="main">]</span><span class="main">)</span> <span class="entity">raw_rhs</span><span class="main">;</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ignored</span> <span class="main">=</span> Term.fold_atyps_sorts <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="main">[</span><span class="main">]</span><span class="main">)</span> <span class="main">=&gt;</span> I <span class="main">|</span> <span class="main">(</span><span class="entity">T</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> <span class="main">=&gt;</span> insert <span class="main">(</span><span class="keyword1"><span class="keyword">op</span></span> <span class="main">=</span><span class="main">)</span> <span class="entity">T</span><span class="main">)</span> <span class="entity">rhs</span> <span class="main">[</span><span class="main">]</span><span class="main">;</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span>
      <span class="keyword2"><span class="keyword">if</span></span> not <span class="main">(</span>null <span class="entity">ignored</span><span class="main">)</span> <span class="keyword1"><span class="keyword">andalso</span></span> Context_Position.is_visible <span class="entity">ctxt</span> <span class="keyword2"><span class="keyword">then</span></span>
        warning
          <span class="main">(</span><span class="inner_quoted">"Ignoring sort constraints in type variables(s): "</span> ^
            commas_quote <span class="main">(</span>map <span class="main">(</span>Syntax.string_of_typ <span class="entity">ctxt</span><span class="main">)</span> <span class="main">(</span>rev <span class="entity">ignored</span><span class="main">)</span><span class="main">)</span> ^
            <span class="inner_quoted">"\nin type abbreviation "</span> ^ <span class="main">(</span><span class="keyword2"><span class="keyword">case</span></span> <span class="entity">b</span> <span class="keyword2"><span class="keyword">of</span></span> NONE <span class="main">=&gt;</span> <span class="inner_quoted">""</span> <span class="main">|</span> SOME <span class="entity">b</span> <span class="main">=&gt;</span> Binding.print <span class="entity">b</span><span class="main">)</span><span class="main">)</span>
      <span class="keyword2"><span class="keyword">else</span></span> <span class="main">(</span><span class="main">)</span><span class="main">;</span>
  <span class="keyword2"><span class="keyword">in</span></span> <span class="entity">rhs</span> <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

<span class="keyword2"><span class="keyword">in</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">abbrev_cmd0</span> <span class="entity">b</span> <span class="main">=</span> <span class="entity">read_abbrev</span> <span class="entity">b</span>
                  o Proof_Context.init_global

<span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

<span class="keyword2"><span class="keyword">end</span></span>
›</span>
<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Isabelle_Main2">
<div class="head">
<h1>Theory Isabelle_Main2</h1>
</div>
<pre class="source"><span class="comment1">(******************************************************************************
 * A Meta-Model for the Isabelle API
 *
 * Copyright (c) 2011-2018 Université Paris-Saclay, Univ. Paris-Sud, France
 *               2013-2017 IRT SystemX, France
 *               2011-2015 Achim D. Brucker, Germany
 *               2016-2018 The University of Sheffield, UK
 *               2016-2017 Nanyang Technological University, Singapore
 *               2017-2018 Virginia Tech, USA
 *
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are
 * met:
 *
 *     * Redistributions of source code must retain the above copyright
 *       notice, this list of conditions and the following disclaimer.
 *
 *     * Redistributions in binary form must reproduce the above
 *       copyright notice, this list of conditions and the following
 *       disclaimer in the documentation and/or other materials provided
 *       with the distribution.
 *
 *     * Neither the name of the copyright holders nor the names of its
 *       contributors may be used to endorse or promote products derived
 *       from this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 ******************************************************************************)</span>

<span class="keyword1"><span class="command">theory</span></span>   Isabelle_Main2
<span class="keyword2"><span class="keyword">imports</span></span>  <span class="quoted">"<a href="Isabelle_typedecl.html">../Pure/Isar/Isabelle_typedecl</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Init">
<div class="head">
<h1>Theory Init</h1>
</div>
<pre class="source"><span class="comment1">(******************************************************************************
 * Citadelle
 *
 * Copyright (c) 2011-2018 Université Paris-Saclay, Univ. Paris-Sud, France
 *               2013-2017 IRT SystemX, France
 *               2011-2015 Achim D. Brucker, Germany
 *               2016-2018 The University of Sheffield, UK
 *               2016-2017 Nanyang Technological University, Singapore
 *               2017-2018 Virginia Tech, USA
 *
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are
 * met:
 *
 *     * Redistributions of source code must retain the above copyright
 *       notice, this list of conditions and the following disclaimer.
 *
 *     * Redistributions in binary form must reproduce the above
 *       copyright notice, this list of conditions and the following
 *       disclaimer in the documentation and/or other materials provided
 *       with the distribution.
 *
 *     * Neither the name of the copyright holders nor the names of its
 *       contributors may be used to endorse or promote products derived
 *       from this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 ******************************************************************************)</span>

<span class="keyword1"><span class="command">theory</span></span> Init
  <span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="Isabelle_Main0.html">isabelle_home/src/HOL/Isabelle_Main0</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹Optimization on the String Datatype›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The following types will allow to delay all concatenations on <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">"integer list"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>,
     until we reach the end. As optimization, we also consider the use of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">String.literal</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
     besides <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">"integer list"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">type_notation</span></span> natural <span class="main">(</span><span class="quoted">"<span class="keyword1">nat</span>"</span><span class="main">)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">Succ</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">+</span> <span class="main">1</span>"</span></span>

<span class="keyword1"><span class="command">datatype</span></span> string<span class="hidden">⇩</span><sub>b</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>e</sub> <span class="main">=</span> ST <span class="quoted">String.literal</span>
                   <span class="main">|</span> ST' <span class="quoted"><span class="quoted">"integer list"</span></span>
                   <span class="comment1">(* NOTE one can further optimize here
                           by adding another constructor for representing "nat"
                           (oid management) *)</span>

<span class="keyword1"><span class="command">datatype</span></span> abr_string <span class="main">=</span> <span class="comment1">(* NOTE operations in this datatype must not decrease the size of the string *)</span>
                      SS_base <span class="quoted">string<span class="hidden">⇩</span><sub>b</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>e</sub></span>
                    <span class="main">|</span> String_concatWith <span class="quoted">abr_string</span> <span class="quoted"><span class="quoted">"abr_string list"</span></span>

<span class="keyword1"><span class="command">syntax</span></span> <span class="quoted">"_string1"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⇒</span> abr_string"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">⟨</span><span class="keyword3">(</span>_<span class="keyword3">)</span><span class="keyword1">⟩</span>"</span><span class="main">)</span>
<span class="keyword1"><span class="command">translations</span></span> <span class="quoted">"<span class="main">⟨</span><span class="free">x</span><span class="main">⟩</span>"</span> <span class="main">⇌</span> <span class="quoted">"<span class="keyword1">CONST</span> SS_base <span class="main">(</span><span class="keyword1">CONST</span> ST <span class="free">x</span><span class="main">)</span>"</span>

<span class="keyword1"><span class="command">syntax</span></span> <span class="quoted">"_string3"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⇒</span> abr_string"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">≪</span><span class="keyword3">(</span>_<span class="keyword3">)</span><span class="keyword1">≫</span>"</span><span class="main">)</span>
<span class="keyword1"><span class="command">translations</span></span> <span class="quoted">"<span class="main">≪</span><span class="free">x</span><span class="main">≫</span>"</span> <span class="main">⇌</span> <span class="quoted">"<span class="keyword1">CONST</span> SS_base <span class="main">(</span><span class="keyword1">CONST</span> ST' <span class="free">x</span><span class="main">)</span>"</span>

<span class="keyword1"><span class="command">syntax</span></span> <span class="quoted">"_integer1"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⇒</span> abr_string"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">°</span><span class="keyword3">(</span>_<span class="keyword3">)</span><span class="keyword1">°</span>"</span><span class="main">)</span>
<span class="keyword1"><span class="command">translations</span></span> <span class="quoted">"<span class="main">°</span><span class="free">x</span><span class="main">°</span>"</span> <span class="main">⇌</span> <span class="quoted">"<span class="keyword1">CONST</span> SS_base <span class="main">(</span><span class="keyword1">CONST</span> ST' <span class="main">(</span><span class="main">(</span><span class="keyword1">CONST</span> Cons<span class="main">)</span> <span class="free">x</span> <span class="main">(</span><span class="keyword1">CONST</span> Nil<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span>

<span class="keyword1"><span class="command">type_notation</span></span> abr_string <span class="main">(</span><span class="quoted">"<span class="keyword1">string</span>"</span><span class="main">)</span>

<span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹Basic Extension of the Standard Library›</span></span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Polymorphic Cartouches›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹We generalize the construction of cartouches for them to be used ``polymorphically'',
     however the type inference is not automatic: 
     types of all cartouche expressions will need to be specified
     earlier before their use (we will however provide a default type).›</span></span>

<span class="keyword1"><span class="command">ML</span></span><span class="quoted">‹
<span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">Cartouche_Grammar</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">struct</span></span>
  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">list_comb_mk</span> <span class="entity">cst</span> <span class="entity">n</span> <span class="entity">c</span> <span class="main">=</span> list_comb <span class="main">(</span>Syntax.const <span class="entity">cst</span><span class="main">,</span> <span class="entity">String_Syntax.mk_bits_syntax</span> <span class="entity">n</span> <span class="entity">c</span><span class="main">)</span>
  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">nil1</span> <span class="main">=</span> Syntax.const <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_syntax</span> String.empty_literal<span class="antiquote">}</span></span>
  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">cons1</span> <span class="entity">c</span> <span class="entity">l</span> <span class="main">=</span> <span class="entity">list_comb_mk</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_syntax</span> String.Literal<span class="antiquote">}</span></span> <span class="inner_numeral">7</span> <span class="entity">c</span> $ <span class="entity">l</span>

  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">default</span> <span class="main">=</span>
    <span class="main">[</span> <span class="main">(</span> <span class="inner_quoted">"char list"</span>
      <span class="main">,</span> <span class="main">(</span> Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_syntax</span> Nil<span class="antiquote">}</span></span><span class="main">,</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">typ</span> <span class="quoted">"char list"</span><span class="antiquote">}</span></span><span class="main">)</span>
        <span class="main">,</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">c</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">l</span> <span class="main">=&gt;</span> Syntax.const <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_syntax</span> Cons<span class="antiquote">}</span></span> $ <span class="entity">list_comb_mk</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_syntax</span> Char<span class="antiquote">}</span></span> <span class="inner_numeral">8</span> <span class="entity">c</span> $ <span class="entity">l</span>
        <span class="main">,</span> snd<span class="main">)</span><span class="main">)</span>
    <span class="main">,</span> <span class="main">(</span> <span class="inner_quoted">"String.literal"</span><span class="main">,</span> <span class="main">(</span><span class="entity">nil1</span><span class="main">,</span> <span class="entity">cons1</span><span class="main">,</span> snd<span class="main">)</span><span class="main">)</span>
    <span class="main">,</span> <span class="main">(</span> <span class="inner_quoted">"abr_string"</span>
      <span class="main">,</span> <span class="main">(</span> <span class="entity">nil1</span>
        <span class="main">,</span> <span class="entity">cons1</span>
        <span class="main">,</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="entity">x</span><span class="main">)</span> <span class="main">=&gt;</span> Syntax.const <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_syntax</span> SS_base<span class="antiquote">}</span></span>
                       $ <span class="main">(</span>Syntax.const <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_syntax</span> ST<span class="antiquote">}</span></span>
                          $ <span class="entity">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">]</span>
<span class="keyword2"><span class="keyword">end</span></span>
›</span>

<span class="keyword1"><span class="command">ML</span></span><span class="quoted">‹
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">parse_translation_cartouche</span> <span class="entity">binding</span> <span class="entity">l</span> <span class="entity">f_integer</span> <span class="entity">accu</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">cartouche_type</span> <span class="main">=</span> <span class="entity">Attrib.setup_config_string</span> <span class="entity">binding</span> <span class="main">(</span>K <span class="main">(</span>fst <span class="main">(</span>hd <span class="entity">l</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
      <span class="comment1">(* if there is no type specified, by default we set the first element
         to be the default type of cartouches *)</span> <span class="keyword2"><span class="keyword">in</span></span>
  <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">ctxt</span> <span class="main">=&gt;</span>
    <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">cart_type</span> <span class="main">=</span> Config.get <span class="entity">ctxt</span> <span class="entity">cartouche_type</span> <span class="keyword2"><span class="keyword">in</span></span>
    <span class="keyword2"><span class="keyword">case</span></span> List.find <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">s</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">s</span> <span class="main">=</span> <span class="entity">cart_type</span><span class="main">)</span> <span class="entity">l</span> <span class="keyword2"><span class="keyword">of</span></span>
      NONE <span class="main">=&gt;</span> error <span class="main">(</span><span class="inner_quoted">"Unregistered return type for the cartouche: \""</span> ^ <span class="entity">cart_type</span> ^ <span class="inner_quoted">"\""</span><span class="main">)</span>
    <span class="main">|</span> SOME <span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="main">(</span><span class="entity">nil0</span><span class="main">,</span> <span class="entity">cons</span><span class="main">,</span> <span class="entity">f</span><span class="main">)</span><span class="main">)</span> <span class="main">=&gt;</span>
        <span class="entity">string_tr</span> <span class="entity">f</span> <span class="main">(</span><span class="entity">f_integer</span><span class="main">,</span> <span class="entity">cons</span><span class="main">,</span> <span class="entity">nil0</span><span class="main">)</span> <span class="entity">accu</span> <span class="main">(</span>Symbol_Pos.cartouche_content o Symbol_Pos.explode<span class="main">)</span>
    <span class="keyword2"><span class="keyword">end</span></span>
  <span class="keyword2"><span class="keyword">end</span></span>
›</span>

<span class="keyword1"><span class="command">parse_translation</span></span> <span class="quoted">‹
  <span class="main">[</span><span class="main">(</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">syntax_const</span> "_cartouche_string"<span class="antiquote">}</span></span>
   <span class="main">,</span> <span class="entity">parse_translation_cartouche</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">binding</span> cartouche_type<span class="antiquote">}</span></span></span> <span class="entity">Cartouche_Grammar.default</span> <span class="main">(</span>K I<span class="main">)</span> <span class="main">(</span><span class="main">)</span><span class="main">)</span><span class="main">]</span>
›</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹This is the special command which sets the type of subsequent cartouches.
     Note: here the given type is currently parsed as a string,
           one should extend it to be a truly ``typed'' type...›</span></span>
<span class="keyword1"><span class="command">declare</span></span><span class="main">[</span><span class="main">[</span><span class="operator">cartouche_type</span> <span class="main"><span class="main">=</span></span> <span class="quoted">"abr_string"</span><span class="main">]</span><span class="main">]</span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Operations on List›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> nsplit <span class="main">=</span> Nsplit_text <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>
                         <span class="main">|</span> Nsplit_sep <span class="tfree"><span class="quoted"><span class="tfree">'b</span></span></span>
<span class="keyword1"><span class="command">locale</span></span> L
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">map</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">map</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span> rev <span class="main">(</span>foldl <span class="main">(</span><span class="main">λ</span><span class="bound">l</span> <span class="bound">x</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">x</span> <span class="main">#</span> <span class="bound">l</span><span class="main">)</span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">flatten</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span> foldl <span class="main">(</span><span class="main">λ</span><span class="bound">acc</span> <span class="bound">l</span><span class="main">.</span> foldl <span class="main">(</span><span class="main">λ</span><span class="bound">acc</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">#</span> <span class="bound">acc</span><span class="main">)</span> <span class="bound">acc</span> <span class="main">(</span>rev <span class="bound">l</span><span class="main">)</span><span class="main">)</span> <span class="main">[]</span> <span class="main">(</span>rev <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">mapi</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span> rev <span class="main">(</span>fst <span class="main">(</span>foldl <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">l</span><span class="main">,</span><span class="bound">cpt</span><span class="main">)</span> <span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">cpt</span> <span class="bound">x</span> <span class="main">#</span> <span class="bound">l</span><span class="main">,</span> Succ <span class="bound">cpt</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">0</span><span class="main">::</span><span class="keyword1">nat</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">iter</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> foldl <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="main">()</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">maps</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> L.flatten <span class="main">(</span>L.map <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">append</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">append</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">=</span> L.flatten <span class="main">[</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">]</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">filter</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">filter</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span> rev <span class="main">(</span>foldl <span class="main">(</span><span class="main">λ</span><span class="bound">l</span> <span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">x</span> <span class="keyword1">then</span> <span class="bound">x</span> <span class="main">#</span> <span class="bound">l</span> <span class="keyword1">else</span> <span class="bound">l</span><span class="main">)</span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">rev_map</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> foldl <span class="main">(</span><span class="main">λ</span><span class="bound">l</span> <span class="bound">x</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">x</span> <span class="main">#</span> <span class="bound">l</span><span class="main">)</span> <span class="main">[]</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">mapM</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">accu</span></span></span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">accu</span><span class="main">)</span> <span class="main">=</span> List.fold <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">accu</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">let</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">accu</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">x</span> <span class="bound">accu</span> <span class="keyword1">in</span> <span class="main">(</span><span class="bound">x</span> <span class="main">#</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">accu</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">accu</span></span></span><span class="main">)</span> <span class="keyword1">in</span>
   <span class="main">(</span>rev <span class="bound">l</span><span class="main">,</span> <span class="bound">accu</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">assoc</span> <span class="free"><span class="bound"><span class="entity">x1</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span> List.fold <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x2</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span><span class="main">.</span> <span class="main">λ</span>None <span class="main">⇒</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x1</span></span></span> <span class="main">=</span> <span class="bound">x2</span> <span class="keyword1">then</span> Some <span class="bound">v</span> <span class="keyword1">else</span> None <span class="main">|</span> <span class="bound">x</span> <span class="main">⇒</span> <span class="bound">x</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> None"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">split</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">split</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span> <span class="main">(</span>L.map fst <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">,</span> L.map snd <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">upto</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">upto</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">=</span>
 <span class="main">(</span><span class="keyword1">let</span> <span class="bound">to_i</span> <span class="main">=</span> <span class="main">λ</span><span class="bound">n</span><span class="main">.</span> int_of_integer <span class="main">(</span>integer_of_natural <span class="bound">n</span><span class="main">)</span> <span class="keyword1">in</span>
  L.map <span class="main">(</span>natural_of_integer <span class="keyword1">o</span> integer_of_int<span class="main">)</span> <span class="main">(</span>List.upto <span class="main">(</span><span class="bound">to_i</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">(</span><span class="bound">to_i</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">split_at</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span>
 <span class="main">(</span><span class="keyword1">let</span> <span class="bound">f</span> <span class="main">=</span> <span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">¬</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">x</span> <span class="keyword1">in</span>
  <span class="main">(</span>takeWhile <span class="bound">f</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">,</span> <span class="keyword1">case</span> dropWhile <span class="bound">f</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="keyword1">of</span> <span class="main">[]</span> <span class="main">⇒</span> <span class="main">(</span>None<span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">|</span> <span class="bound">x</span> <span class="main">#</span> <span class="bound">xs</span> <span class="main">⇒</span> <span class="main">(</span>Some <span class="bound">x</span><span class="main">,</span> <span class="bound">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">take</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">take</span> <span class="free"><span class="bound"><span class="entity">reverse</span></span></span> <span class="free"><span class="bound"><span class="entity">lg</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">reverse</span></span></span> <span class="main">(</span>snd <span class="main">(</span>L.split <span class="main">(</span>takeWhile <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">n</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">lg</span></span></span><span class="main">)</span> <span class="main">(</span>enumerate <span class="main">0</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">reverse</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">take_last</span> <span class="main">=</span> take rev"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">take_first</span> <span class="main">=</span> take id"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">replace_gen</span> <span class="free"><span class="bound"><span class="entity">f_res</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">lby</span></span></span> <span class="main">=</span>
 <span class="main">(</span><span class="keyword1">let</span> <span class="bound">Nsplit_text</span> <span class="main">=</span> <span class="main">λ</span><span class="bound">l</span> <span class="bound">lgen</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">l</span> <span class="main">=</span> <span class="main">[]</span> <span class="keyword1">then</span> <span class="bound">lgen</span> <span class="keyword1">else</span> Nsplit_text <span class="bound">l</span> <span class="main">#</span> <span class="bound">lgen</span> <span class="keyword1">in</span>
  <span class="keyword1">case</span> List.fold
         <span class="main">(</span><span class="main">λ</span> <span class="bound">c1</span> <span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">lgen</span><span class="main">)</span><span class="main">.</span>
           <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="bound">c1</span> <span class="keyword1">then</span>
             <span class="main">(</span><span class="free"><span class="bound"><span class="entity">lby</span></span></span><span class="main">,</span> Nsplit_sep <span class="bound">c1</span> <span class="main">#</span> <span class="bound">Nsplit_text</span> <span class="bound">l</span> <span class="bound">lgen</span><span class="main">)</span>
           <span class="keyword1">else</span>
             <span class="main">(</span><span class="bound">c1</span> <span class="main">#</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">lgen</span><span class="main">)</span><span class="main">)</span>
         <span class="main">(</span>rev <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span>
         <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span>
  <span class="keyword1">of</span> <span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">lgen</span><span class="main">)</span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">f_res</span></span></span> <span class="main">(</span><span class="bound">Nsplit_text</span> <span class="bound">l</span> <span class="bound">lgen</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">nsplit_f</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="main">=</span> replace_gen id <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="main">[]</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">replace</span> <span class="main">=</span> replace_gen <span class="main">(</span>L.flatten <span class="keyword1">o</span> L.map <span class="main">(</span><span class="main">λ</span> Nsplit_text <span class="bound">l</span> <span class="main">⇒</span> <span class="bound">l</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">map_find_aux</span> <span class="keyword2"><span class="keyword">where</span></span>
   <span class="quoted"><span class="quoted">"<span class="free">map_find_aux</span> <span class="free"><span class="bound"><span class="entity">accu</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="main">[]</span> <span class="main">⇒</span> List.rev <span class="free"><span class="bound"><span class="entity">accu</span></span></span>
                         <span class="main">|</span> <span class="bound">x</span> <span class="main">#</span> <span class="bound">xs</span> <span class="main">⇒</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">x</span> <span class="keyword1">of</span> Some <span class="bound">x</span> <span class="main">⇒</span> List.fold Cons <span class="free"><span class="bound"><span class="entity">accu</span></span></span> <span class="main">(</span><span class="bound">x</span> <span class="main">#</span> <span class="bound">xs</span><span class="main">)</span>
                                                <span class="main">|</span> None <span class="main">⇒</span> <span class="free">map_find_aux</span> <span class="main">(</span><span class="bound">x</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">accu</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">xs</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">map_find</span> <span class="main">=</span> map_find_aux <span class="main">[]</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
<span class="keyword1"><span class="command">notation</span></span> L.append <span class="main">(</span><span class="keyword2"><span class="keyword">infixr</span></span> <span class="quoted">"<span class="keyword1">@@@@</span>"</span> 65<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">code</span><span class="main">]</span> <span class="main">=</span>
  <span class="comment1">― ‹def›</span>
  L.map_def
  L.flatten_def
  L.mapi_def
  L.iter_def
  L.maps_def
  L.append_def
  L.filter_def
  L.rev_map_def
  L.mapM_def
  L.assoc_def
  L.split_def
  L.upto_def
  L.split_at_def
  L.take_def
  L.take_last_def
  L.take_first_def
  L.replace_gen_def
  L.nsplit_f_def
  L.replace_def
  L.map_find_def

  <span class="comment1">― ‹fun›</span>
  L.map_find_aux.simps

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Operations on Char›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ascii_of_literal</span> <span class="main">(</span><span class="quoted">"<span class="keyword1">INT</span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
          <span class="quoted"><span class="quoted">"<span class="free">ascii_of_literal</span> <span class="main">=</span> hd <span class="keyword1">o</span> String.asciis_of_literal"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">integer_escape</span> <span class="main">::</span> integer<span class="main">)</span> <span class="main">=</span> <span class="numeral">0x09</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">ST0</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> <span class="main">≪</span><span class="main">[</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">]</span><span class="main">≫</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">ST0_base</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> ST' <span class="main">[</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Operations on String (I)›</span></span>

<span class="keyword1"><span class="command">notation</span></span> <span class="quoted">"String.asciis_of_literal"</span> <span class="main">(</span><span class="quoted">"<span class="keyword1">INTS</span>"</span><span class="main">)</span>

<span class="keyword1"><span class="command">locale</span></span> S
<span class="keyword1"><span class="command">locale</span></span> String
<span class="keyword1"><span class="command">locale</span></span> String<span class="hidden">⇩</span><sub>b</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>e</sub>

<span class="keyword1"><span class="command">definition</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> S<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="free">flatten</span> <span class="main">=</span> String_concatWith <span class="inner_cartouche">‹›</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> String<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="free">flatten</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">=</span> S.flatten <span class="main">[</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">]</span>"</span></span>
<span class="keyword1"><span class="command">notation</span></span> String.flatten <span class="main">(</span><span class="keyword2"><span class="keyword">infixr</span></span> <span class="quoted">"<span class="keyword1">@@</span>"</span> 65<span class="main">)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> String<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="free">make</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> <span class="main">≪</span>L.map <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="main">(</span>L.upto <span class="main">1</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">≫</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> String<span class="hidden">⇩</span><sub>b</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>e</sub><span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="free">map_gen</span> <span class="free"><span class="bound"><span class="entity">replace</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> ST <span class="bound">s</span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">replace</span></span></span> <span class="inner_cartouche">‹›</span> <span class="main">(</span>Some <span class="bound">s</span><span class="main">)</span> <span class="inner_cartouche">‹›</span>
                                                <span class="main">|</span> ST' <span class="bound">s</span> <span class="main">⇒</span> S.flatten <span class="main">(</span>L.map <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">fun</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> String<span class="main">)</span> <span class="entity">map_gen</span> <span class="keyword2"><span class="keyword">where</span></span>
   <span class="quoted"><span class="quoted">"<span class="free">map_gen</span> <span class="free"><span class="bound"><span class="entity">replace</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span>
     <span class="main">(</span><span class="main">λ</span> SS_base <span class="bound">s</span> <span class="main">⇒</span> String<span class="hidden">⇩</span><sub>b</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>e</sub>.map_gen <span class="free"><span class="bound"><span class="entity">replace</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="bound">s</span>
      <span class="main">|</span> String_concatWith <span class="bound">abr</span> <span class="bound">l</span> <span class="main">⇒</span> String_concatWith <span class="main">(</span><span class="free">map_gen</span> <span class="free"><span class="bound"><span class="entity">replace</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="bound">abr</span><span class="main">)</span> <span class="main">(</span>List.map <span class="main">(</span><span class="free">map_gen</span> <span class="free"><span class="bound"><span class="entity">replace</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">)</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> String<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="free">foldl_one</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">accu</span></span></span> <span class="main">=</span> foldl <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">accu</span></span></span> <span class="keyword1">o</span> <span class="keyword1">INTS</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> String<span class="hidden">⇩</span><sub>b</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>e</sub><span class="main">)</span> <span class="entity">foldl</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">foldl</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">accu</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> ST <span class="bound">s</span> <span class="main">⇒</span> String.foldl_one <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">accu</span></span></span> <span class="bound">s</span>
                                                       <span class="main">|</span> ST' <span class="bound">s</span> <span class="main">⇒</span> List.foldl <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">accu</span></span></span> <span class="bound">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">fun</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> String<span class="main">)</span> <span class="entity">foldl</span> <span class="keyword2"><span class="keyword">where</span></span>
   <span class="quoted"><span class="quoted">"<span class="free">foldl</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">accu</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span>
     <span class="main">(</span><span class="main">λ</span> SS_base <span class="bound">s</span> <span class="main">⇒</span> String<span class="hidden">⇩</span><sub>b</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>e</sub>.foldl <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">accu</span></span></span> <span class="bound">s</span>
      <span class="main">|</span> String_concatWith <span class="bound">abr</span> <span class="bound">l</span> <span class="main">⇒</span>
        <span class="main">(</span><span class="keyword1">case</span> <span class="bound">l</span> <span class="keyword1">of</span> <span class="main">[]</span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">accu</span></span></span>
                 <span class="main">|</span> <span class="bound">x</span> <span class="main">#</span> <span class="bound">xs</span> <span class="main">⇒</span> List.foldl <span class="main">(</span><span class="main">λ</span><span class="bound">accu</span><span class="main">.</span> <span class="free">foldl</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="free">foldl</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">accu</span> <span class="bound">abr</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">foldl</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">accu</span></span></span> <span class="bound">x</span><span class="main">)</span> <span class="bound">xs</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> S<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="free">replace_integers</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">s2</span></span></span> <span class="main">=</span>
  <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="main">@@</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">of</span> None <span class="main">⇒</span> <span class="inner_cartouche">‹›</span> <span class="main">|</span> Some <span class="bound">s</span> <span class="main">⇒</span> flatten <span class="main">(</span>L.map <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="keyword1">INTS</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">@@</span> <span class="free"><span class="bound"><span class="entity">s2</span></span></span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> String<span class="main">)</span> <span class="entity">map</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">map</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> map_gen <span class="main">(</span>S.replace_integers <span class="main">(</span><span class="main">λ</span><span class="bound">c</span><span class="main">.</span> <span class="main">°</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">c</span><span class="main">°</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">°</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">x</span><span class="main">°</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> String<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="free">replace_integers</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> map_gen <span class="main">(</span>S.replace_integers <span class="main">(</span><span class="main">λ</span><span class="bound">c</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">c</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> String<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="free">all</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> foldl <span class="main">(</span><span class="main">λ</span><span class="bound">b</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">b</span> <span class="main">&amp;</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">s</span><span class="main">)</span> True"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> String<span class="main">)</span> <span class="entity">length</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">length</span> <span class="main">=</span> foldl <span class="main">(</span><span class="main">λ</span><span class="bound">n</span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> Suc <span class="bound">n</span><span class="main">)</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> String<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="free">to_list</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> rev <span class="main">(</span>foldl <span class="main">(</span><span class="main">λ</span><span class="bound">l</span> <span class="bound">c</span><span class="main">.</span> <span class="bound">c</span> <span class="main">#</span> <span class="bound">l</span><span class="main">)</span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> String<span class="hidden">⇩</span><sub>b</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>e</sub><span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="free">to_list</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> ST <span class="bound">s</span> <span class="main">⇒</span> <span class="keyword1">INTS</span> <span class="bound">s</span> <span class="main">|</span> ST' <span class="bound">l</span> <span class="main">⇒</span> <span class="bound">l</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> String<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="free">meta_of_logic</span> <span class="main">=</span> String.literal_of_asciis <span class="keyword1">o</span> to_list"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> String<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="free">to_String<span class="hidden">⇩</span><sub>b</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>e</sub></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> SS_base <span class="bound">s</span> <span class="main">⇒</span> <span class="bound">s</span> <span class="main">|</span> <span class="bound">s</span> <span class="main">⇒</span> ST' <span class="main">(</span>to_list <span class="bound">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> String<span class="hidden">⇩</span><sub>b</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>e</sub><span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="free">to_String</span> <span class="main">=</span> SS_base"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> String<span class="hidden">⇩</span><sub>b</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>e</sub><span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="free">is_empty</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> ST <span class="bound">s</span> <span class="main">⇒</span> <span class="bound">s</span> <span class="main">=</span> <span class="keyword1">STR</span> <span class="inner_quoted">''''</span>
                                       <span class="main">|</span> ST' <span class="bound">s</span> <span class="main">⇒</span> <span class="bound">s</span> <span class="main">=</span> <span class="main">[]</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">fun</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> String<span class="main">)</span> <span class="entity">is_empty</span> <span class="keyword2"><span class="keyword">where</span></span>
   <span class="quoted"><span class="quoted">"<span class="free">is_empty</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> SS_base <span class="bound">s</span> <span class="main">⇒</span> String<span class="hidden">⇩</span><sub>b</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>e</sub>.is_empty <span class="bound">s</span> <span class="main">|</span> String_concatWith <span class="main"><span class="bound">_</span></span> <span class="bound">l</span> <span class="main">⇒</span> list_all <span class="free">is_empty</span> <span class="bound">l</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> String<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="free">equal</span> <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="free"><span class="bound"><span class="entity">s2</span></span></span> <span class="main">=</span> <span class="main">(</span>to_list <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="main">=</span> to_list <span class="free"><span class="bound"><span class="entity">s2</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">notation</span></span> String.equal <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">≜</span>"</span> 50<span class="main">)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> String<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="free">assoc</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span> L.assoc <span class="main">(</span>to_list <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span>L.map <span class="main">(</span>map_prod String<span class="hidden">⇩</span><sub>b</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>e</sub>.to_list id<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> String<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="free">member</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> List.member <span class="main">(</span>L.map String<span class="hidden">⇩</span><sub>b</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>e</sub>.to_list <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">(</span>to_list <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> String<span class="hidden">⇩</span><sub>b</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>e</sub><span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="free">flatten</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span> String.to_String<span class="hidden">⇩</span><sub>b</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>e</sub> <span class="main">(</span>S.flatten <span class="main">(</span>L.map to_String <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">code</span><span class="main">]</span> <span class="main">=</span>
  <span class="comment1">― ‹def›</span>
  S.flatten_def
  String.flatten_def
  String.make_def
  String<span class="hidden">⇩</span><sub>b</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>e</sub>.map_gen_def
  String.foldl_one_def
  String<span class="hidden">⇩</span><sub>b</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>e</sub>.foldl_def
  S.replace_integers_def
  String.map_def
  String.replace_integers_def
  String.all_def
  String.length_def
  String.to_list_def
  String<span class="hidden">⇩</span><sub>b</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>e</sub>.to_list_def
  String.meta_of_logic_def
  String.to_String<span class="hidden">⇩</span><sub>b</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>e</sub>_def
  String<span class="hidden">⇩</span><sub>b</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>e</sub>.to_String_def
  String<span class="hidden">⇩</span><sub>b</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>e</sub>.is_empty_def
  String.equal_def
  String.assoc_def
  String.member_def
  String<span class="hidden">⇩</span><sub>b</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>e</sub>.flatten_def

  <span class="comment1">― ‹fun›</span>
  String.map_gen.simps
  String.foldl.simps
  String.is_empty.simps

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Operations on String (II)›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">wildcard</span> <span class="main">=</span> <span class="inner_cartouche">‹_›</span>"</span></span>

<span class="keyword1"><span class="command">context</span></span> String
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">lowercase</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">n</span> <span class="main">&lt;</span> <span class="numeral">97</span> <span class="keyword1">then</span> <span class="bound">n</span> <span class="main">+</span> <span class="numeral">32</span> <span class="keyword1">else</span> <span class="bound">n</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">uppercase</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">n</span> <span class="main">&lt;</span> <span class="numeral">97</span> <span class="keyword1">then</span> <span class="bound">n</span> <span class="keyword1">else</span> <span class="bound">n</span> <span class="main">-</span> <span class="numeral">32</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">to_bold_number</span> <span class="main">=</span> replace_integers <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="main">[</span><span class="inner_cartouche">‹𝟬›</span><span class="main">,</span> <span class="inner_cartouche">‹𝟭›</span><span class="main">,</span> <span class="inner_cartouche">‹𝟮›</span><span class="main">,</span> <span class="inner_cartouche">‹𝟯›</span><span class="main">,</span> <span class="inner_cartouche">‹𝟰›</span><span class="main">,</span> <span class="inner_cartouche">‹𝟱›</span><span class="main">,</span> <span class="inner_cartouche">‹𝟲›</span><span class="main">,</span> <span class="inner_cartouche">‹𝟳›</span><span class="main">,</span> <span class="inner_cartouche">‹𝟴›</span><span class="main">,</span> <span class="inner_cartouche">‹𝟵›</span><span class="main">]</span> <span class="main">!</span> nat_of_integer <span class="main">(</span><span class="bound">n</span> <span class="main">-</span> <span class="numeral">48</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">nat_to_digit10_aux</span> <span class="keyword2"><span class="keyword">where</span></span>
   <span class="quoted"><span class="quoted">"<span class="free">nat_to_digit10_aux</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">::</span> Nat.nat<span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">&lt;</span> <span class="numeral">10</span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="keyword1">else</span> <span class="free">nat_to_digit10_aux</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="keyword1">mod</span> <span class="numeral">10</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="keyword1">div</span> <span class="numeral">10</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">nat_to_digit10</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span>
 <span class="main">(</span><span class="keyword1">let</span> <span class="bound">nat_raw_to_str</span> <span class="main">=</span> L.map <span class="main">(</span>integer_of_nat <span class="keyword1">o</span> <span class="main">(+)</span> <span class="numeral">0x30</span><span class="main">)</span> <span class="keyword1">in</span>
  <span class="main">≪</span><span class="bound">nat_raw_to_str</span> <span class="main">(</span>nat_to_digit10_aux <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">≫</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">natural_to_digit10</span> <span class="main">=</span> nat_to_digit10 <span class="keyword1">o</span> nat_of_natural"</span></span>

<span class="keyword1"><span class="command">declare</span></span><span class="main">[</span><span class="main">[</span><span class="operator">cartouche_type</span> <span class="main"><span class="main">=</span></span> <span class="quoted">"String.literal"</span><span class="main">]</span><span class="main">]</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">integer_to_digit16</span> <span class="main">=</span>
 <span class="main">(</span><span class="keyword1">let</span> <span class="bound">f</span> <span class="main">=</span> nth <span class="main">(</span><span class="keyword1">INTS</span> <span class="inner_cartouche">‹0123456789ABCDEF›</span><span class="main">)</span> <span class="keyword1">o</span> nat_of_integer <span class="keyword1">in</span>
  <span class="main">λ</span><span class="bound">n</span> <span class="main">⇒</span> <span class="main">≪</span><span class="main">[</span><span class="bound">f</span> <span class="main">(</span><span class="bound">n</span> <span class="keyword1">div</span> <span class="numeral">16</span><span class="main">)</span><span class="main">,</span> <span class="bound">f</span> <span class="main">(</span><span class="bound">n</span> <span class="keyword1">mod</span> <span class="numeral">16</span><span class="main">)</span><span class="main">]</span><span class="main">≫</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">end</span></span>
<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">code</span><span class="main">]</span> <span class="main">=</span>
  <span class="comment1">― ‹def›</span>
  String.lowercase_def
  String.uppercase_def
  String.to_bold_number_def
  String.nat_to_digit10_def
  String.natural_to_digit10_def
  String.integer_to_digit16_def

  <span class="comment1">― ‹fun›</span>
  String.nat_to_digit10_aux.simps

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">add_0</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span>
 <span class="main">(</span><span class="keyword1">let</span> <span class="bound">n</span> <span class="main">=</span> nat_of_integer <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="keyword1">in</span>
  S.flatten <span class="main">(</span>L.map <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="inner_cartouche">‹0›</span><span class="main">)</span> <span class="main">(</span>upt <span class="main">0</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">n</span> <span class="main">&lt;</span> <span class="numeral">10</span> <span class="keyword1">then</span> <span class="numeral">2</span> <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="bound">n</span> <span class="main">&lt;</span> <span class="numeral">100</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
  <span class="main">@@</span> String.nat_to_digit10 <span class="bound">n</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">declare</span></span><span class="main">[</span><span class="main">[</span><span class="operator">cartouche_type</span> <span class="main"><span class="main">=</span></span> <span class="quoted">"String.literal"</span><span class="main">]</span><span class="main">]</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">is_letter</span> <span class="main">=</span>
 <span class="main">(</span><span class="keyword1">let</span> <span class="bound">int_A</span> <span class="main">=</span> <span class="keyword1">INT</span> <span class="inner_cartouche">‹A›</span><span class="main">;</span> <span class="bound">int_Z</span> <span class="main">=</span> <span class="keyword1">INT</span> <span class="inner_cartouche">‹Z›</span><span class="main">;</span> <span class="bound">int_a</span> <span class="main">=</span> <span class="keyword1">INT</span> <span class="inner_cartouche">‹a›</span><span class="main">;</span> <span class="bound">int_z</span> <span class="main">=</span> <span class="keyword1">INT</span> <span class="inner_cartouche">‹z›</span> <span class="keyword1">in</span>
  <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">≥</span> <span class="bound">int_A</span> <span class="main">&amp;</span> <span class="bound">n</span> <span class="main">≤</span> <span class="bound">int_Z</span> <span class="main">|</span> <span class="bound">n</span> <span class="main">≥</span> <span class="bound">int_a</span> <span class="main">&amp;</span> <span class="bound">n</span> <span class="main">≤</span> <span class="bound">int_z</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">is_digit</span> <span class="main">=</span>
 <span class="main">(</span><span class="keyword1">let</span> <span class="bound">int_0</span> <span class="main">=</span> <span class="keyword1">INT</span> <span class="inner_cartouche">‹0›</span><span class="main">;</span> <span class="bound">int_9</span> <span class="main">=</span> <span class="keyword1">INT</span> <span class="inner_cartouche">‹9›</span> <span class="keyword1">in</span>
  <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">≥</span> <span class="bound">int_0</span> <span class="main">&amp;</span> <span class="bound">n</span> <span class="main">≤</span> <span class="bound">int_9</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">is_special</span> <span class="main">=</span> List.member <span class="main">(</span><span class="keyword1">INTS</span> <span class="inner_cartouche">‹ &lt;&gt;^_=-./(){}›</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">context</span></span> String
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">base255</span> <span class="main">=</span> replace_integers <span class="main">(</span><span class="main">λ</span><span class="bound">c</span><span class="main">.</span> <span class="keyword1">if</span> is_letter <span class="bound">c</span> <span class="keyword1">then</span> <span class="main">°</span><span class="bound">c</span><span class="main">°</span> <span class="keyword1">else</span> add_0 <span class="bound">c</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">declare</span></span><span class="main">[</span><span class="main">[</span><span class="operator">cartouche_type</span> <span class="main"><span class="main">=</span></span> <span class="quoted">"abr_string"</span><span class="main">]</span><span class="main">]</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">isub</span> <span class="main">=</span>
  replace_integers <span class="main">(</span><span class="keyword1">let</span> <span class="bound">is_und</span> <span class="main">=</span> List.member <span class="main">(</span><span class="keyword1">INTS</span> <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''_''</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">in</span>
                    <span class="main">(</span><span class="main">λ</span><span class="bound">c</span><span class="main">.</span> <span class="keyword1">if</span> is_letter <span class="bound">c</span> <span class="main">|</span> is_digit <span class="bound">c</span> <span class="main">|</span> <span class="bound">is_und</span> <span class="bound">c</span> <span class="keyword1">then</span> <span class="inner_cartouche">‹⇩›</span> <span class="main">@@</span> <span class="main">°</span><span class="bound">c</span><span class="main">°</span> <span class="keyword1">else</span> add_0 <span class="bound">c</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">isup</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="inner_cartouche">‹__›</span> <span class="main">@@</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>
<span class="keyword2"><span class="keyword">end</span></span>
<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">code</span><span class="main">]</span> <span class="main">=</span>
  <span class="comment1">― ‹def›</span>
  String.base255_def
  String.isub_def
  String.isup_def

<span class="keyword1"><span class="command">declare</span></span><span class="main">[</span><span class="main">[</span><span class="operator">cartouche_type</span> <span class="main"><span class="main">=</span></span> <span class="quoted">"abr_string"</span><span class="main">]</span><span class="main">]</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">text_of_str</span> <span class="free"><span class="bound"><span class="entity">str</span></span></span> <span class="main">=</span>
 <span class="main">(</span><span class="keyword1">let</span> <span class="bound">s</span> <span class="main">=</span> <span class="inner_cartouche">‹c›</span>
    <span class="main">;</span> <span class="bound">ap</span> <span class="main">=</span> <span class="inner_cartouche">‹ # ›</span> <span class="keyword1">in</span>
  S.flatten <span class="main">[</span> <span class="inner_cartouche">‹(let ›</span><span class="main">,</span> <span class="bound">s</span><span class="main">,</span> <span class="inner_cartouche">‹ = char_of :: nat ⇒ char in ›</span>
          <span class="main">,</span> String.replace_integers <span class="main">(</span><span class="main">λ</span><span class="bound">c</span><span class="main">.</span>
                                    <span class="keyword1">if</span> is_letter <span class="bound">c</span> <span class="keyword1">then</span>
                                      S.flatten <span class="main">[</span><span class="inner_cartouche">‹CHR ''›</span><span class="main">,</span><span class="main">°</span><span class="bound">c</span><span class="main">°</span><span class="main">,</span><span class="inner_cartouche">‹''›</span><span class="main">,</span><span class="bound">ap</span><span class="main">]</span>
                                    <span class="keyword1">else</span>
                                      S.flatten <span class="main">[</span><span class="bound">s</span><span class="main">,</span> <span class="inner_cartouche">‹ ›</span><span class="main">,</span>  add_0 <span class="bound">c</span><span class="main">,</span> <span class="bound">ap</span><span class="main">]</span><span class="main">)</span>
                                 <span class="free"><span class="bound"><span class="entity">str</span></span></span>
          <span class="main">,</span> <span class="inner_cartouche">‹[])›</span><span class="main">]</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">‹<span class="free">text2_of_str</span> <span class="main">=</span> String.replace_integers <span class="main">(</span><span class="main">λ</span><span class="bound">c</span><span class="main">.</span> S.flatten <span class="main">[</span><span class="inner_cartouche">‹\›</span><span class="main">,</span> <span class="inner_cartouche">‹&lt;›</span><span class="main">,</span> <span class="main">°</span><span class="bound">c</span><span class="main">°</span><span class="main">,</span> <span class="inner_cartouche">‹&gt;›</span><span class="main">]</span><span class="main">)</span>›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">textstr_of_str</span> <span class="free"><span class="bound"><span class="entity">f_flatten</span></span></span> <span class="free"><span class="bound"><span class="entity">f_integer</span></span></span> <span class="free"><span class="bound"><span class="entity">f_str</span></span></span> <span class="free"><span class="bound"><span class="entity">str</span></span></span> <span class="main">=</span>
 <span class="main">(</span><span class="keyword1">let</span> <span class="bound">str0</span> <span class="main">=</span> String.to_list <span class="free"><span class="bound"><span class="entity">str</span></span></span>
    <span class="main">;</span> <span class="bound">f_letter</span> <span class="main">=</span> <span class="main">λ</span><span class="bound">c</span><span class="main">.</span> is_letter <span class="bound">c</span> <span class="main">|</span> is_digit <span class="bound">c</span> <span class="main">|</span> is_special <span class="bound">c</span>
    <span class="main">;</span> <span class="bound">s</span> <span class="main">=</span> <span class="inner_cartouche">‹c›</span>
    <span class="main">;</span> <span class="bound">f_text</span> <span class="main">=</span> <span class="main">λ</span> Nsplit_text <span class="bound">l</span> <span class="main">⇒</span> S.flatten <span class="main">[</span><span class="free"><span class="bound"><span class="entity">f_str</span></span></span> <span class="main">(</span>S.flatten <span class="main">[</span><span class="inner_cartouche">‹STR ''›</span><span class="main">,</span><span class="main">≪</span><span class="bound">l</span><span class="main">≫</span><span class="main">,</span><span class="inner_cartouche">‹''›</span><span class="main">]</span><span class="main">)</span><span class="main">]</span>
               <span class="main">|</span> Nsplit_sep <span class="bound">c</span> <span class="main">⇒</span> S.flatten <span class="main">[</span><span class="free"><span class="bound"><span class="entity">f_integer</span></span></span> <span class="bound">c</span><span class="main">]</span>
    <span class="main">;</span> <span class="bound">str</span> <span class="main">=</span> <span class="keyword1">case</span> L.nsplit_f <span class="bound">str0</span> <span class="main">(</span>Not <span class="keyword1">o</span> <span class="bound">f_letter</span><span class="main">)</span> <span class="keyword1">of</span>
              <span class="main">[]</span> <span class="main">⇒</span> S.flatten <span class="main">[</span><span class="free"><span class="bound"><span class="entity">f_str</span></span></span> <span class="inner_cartouche">‹STR ''''›</span><span class="main">]</span>
            <span class="main">|</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span> <span class="main">⇒</span> <span class="bound">f_text</span> <span class="bound">x</span>
            <span class="main">|</span> <span class="bound">l</span> <span class="main">⇒</span> S.flatten <span class="main">(</span>L.map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="inner_cartouche">‹(›</span> <span class="main">@@</span> <span class="bound">f_text</span> <span class="bound">x</span> <span class="main">@@</span> <span class="inner_cartouche">‹) # ›</span><span class="main">)</span> <span class="bound">l</span><span class="main">)</span> <span class="main">@@</span> <span class="inner_cartouche">‹[]›</span> <span class="keyword1">in</span>
  <span class="keyword1">if</span> list_all <span class="bound">f_letter</span> <span class="bound">str0</span> <span class="keyword1">then</span>
    <span class="bound">str</span>
  <span class="keyword1">else</span>
    <span class="free"><span class="bound"><span class="entity">f_flatten</span></span></span> <span class="main">(</span>S.flatten <span class="main">[</span> <span class="inner_cartouche">‹(›</span><span class="main">,</span> <span class="bound">str</span><span class="main">,</span> <span class="inner_cartouche">‹)›</span> <span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">‹<span class="free">escape_sml</span> <span class="main">=</span> String.replace_integers <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">n</span> <span class="main">=</span> <span class="numeral">0x22</span> <span class="keyword1">then</span> <span class="inner_cartouche">‹\"›</span> <span class="keyword1">else</span> <span class="main">°</span><span class="bound">n</span><span class="main">°</span><span class="main">)</span>›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">mk_constr_name</span> <span class="free"><span class="bound"><span class="entity">name</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> S.flatten <span class="main">[</span>String.isub <span class="free"><span class="bound"><span class="entity">name</span></span></span><span class="main">,</span> <span class="inner_cartouche">‹_›</span><span class="main">,</span> String.isub <span class="bound">x</span><span class="main">]</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">mk_dot</span> <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="free"><span class="bound"><span class="entity">s2</span></span></span> <span class="main">=</span> S.flatten <span class="main">[</span><span class="inner_cartouche">‹.›</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s2</span></span></span><span class="main">]</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">mk_dot_par_gen</span> <span class="free"><span class="bound"><span class="entity">dot</span></span></span> <span class="free"><span class="bound"><span class="entity">l_s</span></span></span> <span class="main">=</span> S.flatten <span class="main">[</span><span class="free"><span class="bound"><span class="entity">dot</span></span></span><span class="main">,</span> <span class="inner_cartouche">‹(›</span><span class="main">,</span> <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">l_s</span></span></span> <span class="keyword1">of</span> <span class="main">[]</span> <span class="main">⇒</span> <span class="inner_cartouche">‹›</span> <span class="main">|</span> <span class="bound">x</span> <span class="main">#</span> <span class="bound">xs</span> <span class="main">⇒</span> S.flatten <span class="main">[</span><span class="bound">x</span><span class="main">,</span> S.flatten <span class="main">(</span>L.map <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="inner_cartouche">‹, ›</span> <span class="main">@@</span> <span class="bound">s</span><span class="main">)</span> <span class="bound">xs</span><span class="main">)</span> <span class="main">]</span><span class="main">,</span> <span class="inner_cartouche">‹)›</span><span class="main">]</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">mk_dot_par</span> <span class="free"><span class="bound"><span class="entity">dot</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> mk_dot_par_gen <span class="free"><span class="bound"><span class="entity">dot</span></span></span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">]</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">mk_dot_comment</span> <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="free"><span class="bound"><span class="entity">s2</span></span></span> <span class="free"><span class="bound"><span class="entity">s3</span></span></span> <span class="main">=</span> mk_dot <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="main">(</span>S.flatten <span class="main">[</span><span class="free"><span class="bound"><span class="entity">s2</span></span></span><span class="main">,</span> <span class="inner_cartouche">‹ /*›</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s3</span></span></span><span class="main">,</span> <span class="inner_cartouche">‹*/›</span><span class="main">]</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">hol_definition</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> S.flatten <span class="main">[</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span> <span class="inner_cartouche">‹_def›</span><span class="main">]</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">hol_split</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> S.flatten <span class="main">[</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span> <span class="inner_cartouche">‹.split›</span><span class="main">]</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Meta_Pure">
<div class="head">
<h1>Theory Meta_Pure</h1>
</div>
<pre class="source"><span class="comment1">(******************************************************************************
 * A Meta-Model for the Isabelle API
 *
 * Copyright (c) 2011-2018 Université Paris-Saclay, Univ. Paris-Sud, France
 *               2013-2017 IRT SystemX, France
 *               2011-2015 Achim D. Brucker, Germany
 *               2016-2018 The University of Sheffield, UK
 *               2016-2017 Nanyang Technological University, Singapore
 *               2017-2018 Virginia Tech, USA
 *
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are
 * met:
 *
 *     * Redistributions of source code must retain the above copyright
 *       notice, this list of conditions and the following disclaimer.
 *
 *     * Redistributions in binary form must reproduce the above
 *       copyright notice, this list of conditions and the following
 *       disclaimer in the documentation and/or other materials provided
 *       with the distribution.
 *
 *     * Neither the name of the copyright holders nor the names of its
 *       contributors may be used to endorse or promote products derived
 *       from this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 ******************************************************************************)</span>

<span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹(Pure) Term Meta-Model aka. AST definition of (Pure) Term›</span></span>

<span class="keyword1"><span class="command">theory</span></span>  Meta_Pure
<span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="Init.html">../Init</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Type Definition›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> indexname <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="keyword1">string</span> <span class="main">×</span> <span class="keyword1">nat</span>"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> <span class="quoted">"class"</span> <span class="main">=</span> <span class="quoted"><span class="keyword1">string</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> sort <span class="main">=</span> <span class="quoted"><span class="quoted">"class list"</span></span>
<span class="keyword1"><span class="command">datatype</span></span> <span class="quoted">"typ"</span> <span class="main">=</span>
  Type <span class="quoted"><span class="keyword1">string</span></span> <span class="quoted"><span class="quoted">"typ list"</span></span> <span class="main">|</span>
  TFree <span class="quoted"><span class="keyword1">string</span></span> <span class="quoted">sort</span> <span class="main">|</span>
  TVar <span class="quoted">indexname</span> <span class="quoted">sort</span>
<span class="keyword1"><span class="command">datatype</span></span> <span class="quoted">"term"</span> <span class="main">=</span>
  Const <span class="quoted"><span class="keyword1">string</span></span> <span class="quoted"><span class="quoted">"typ"</span></span> <span class="main">|</span>
  Free <span class="quoted"><span class="keyword1">string</span></span> <span class="quoted"><span class="quoted">"typ"</span></span> <span class="main">|</span>
  Var <span class="quoted">indexname</span> <span class="quoted"><span class="quoted">"typ"</span></span> <span class="main">|</span>
  Bound <span class="quoted"><span class="keyword1">nat</span></span> <span class="main">|</span>
  Abs <span class="quoted"><span class="keyword1">string</span></span> <span class="quoted"><span class="quoted">"typ"</span></span> <span class="quoted"><span class="quoted">"term"</span></span> <span class="main">|</span>
  App <span class="quoted"><span class="quoted">"term"</span></span> <span class="quoted"><span class="quoted">"term"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">$</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>"</span> 200<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Operations of Fold, Map, ..., on the Meta-Model›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">map_Const</span> <span class="keyword2"><span class="keyword">where</span></span>
   <span class="quoted"><span class="quoted">"<span class="free">map_Const</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">expr</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> Const <span class="bound">s</span> <span class="bound">ty</span> <span class="main">⇒</span> Const <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">s</span> <span class="bound">ty</span><span class="main">)</span> <span class="bound">ty</span>
                        <span class="main">|</span> Free <span class="bound">s</span> <span class="bound">ty</span> <span class="main">⇒</span> Free <span class="bound">s</span> <span class="bound">ty</span>
                        <span class="main">|</span> Var <span class="bound">i</span> <span class="bound">ty</span> <span class="main">⇒</span> Var <span class="bound">i</span> <span class="bound">ty</span>
                        <span class="main">|</span> Bound <span class="bound">n</span> <span class="main">⇒</span> Bound <span class="bound">n</span>
                        <span class="main">|</span> Abs <span class="bound">s</span> <span class="bound">ty</span> <span class="bound">term</span> <span class="main">⇒</span> Abs <span class="bound">s</span> <span class="bound">ty</span> <span class="main">(</span><span class="free">map_Const</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">term</span><span class="main">)</span>
                        <span class="main">|</span> App <span class="bound">term1</span> <span class="bound">term2</span> <span class="main">⇒</span> App <span class="main">(</span><span class="free">map_Const</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">term1</span><span class="main">)</span>
                                                         <span class="main">(</span><span class="free">map_Const</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">term2</span><span class="main">)</span><span class="main">)</span>
                        <span class="free"><span class="bound"><span class="entity">expr</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">fold_Const</span> <span class="keyword2"><span class="keyword">where</span></span>
   <span class="quoted"><span class="quoted">"<span class="free">fold_Const</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">accu</span></span></span> <span class="free"><span class="bound"><span class="entity">expr</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> Const <span class="bound">s</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">accu</span></span></span> <span class="bound">s</span> 
                              <span class="main">|</span> Abs <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span> <span class="bound">term</span> <span class="main">⇒</span> <span class="free">fold_Const</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">accu</span></span></span> <span class="bound">term</span>
                              <span class="main">|</span> App <span class="bound">term1</span> <span class="bound">term2</span> <span class="main">⇒</span> <span class="free">fold_Const</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="free">fold_Const</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">accu</span></span></span> <span class="bound">term1</span><span class="main">)</span> <span class="bound">term2</span>
                              <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">accu</span></span></span><span class="main">)</span>
                               <span class="free"><span class="bound"><span class="entity">expr</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">fold_Free</span> <span class="keyword2"><span class="keyword">where</span></span>
   <span class="quoted"><span class="quoted">"<span class="free">fold_Free</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">accu</span></span></span> <span class="free"><span class="bound"><span class="entity">expr</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> Free <span class="bound">s</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">accu</span></span></span> <span class="bound">s</span> 
                             <span class="main">|</span> Abs <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span> <span class="bound">term</span> <span class="main">⇒</span> <span class="free">fold_Free</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">accu</span></span></span> <span class="bound">term</span>
                             <span class="main">|</span> App <span class="bound">term1</span> <span class="bound">term2</span> <span class="main">⇒</span> <span class="free">fold_Free</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="free">fold_Free</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">accu</span></span></span> <span class="bound">term1</span><span class="main">)</span> <span class="bound">term2</span>
                             <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">accu</span></span></span><span class="main">)</span>
                              <span class="free"><span class="bound"><span class="entity">expr</span></span></span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Parser_init">
<div class="head">
<h1>Theory Parser_init</h1>
</div>
<pre class="source"><span class="comment1">(******************************************************************************
 * Citadelle
 *
 * Copyright (c) 2011-2018 Université Paris-Saclay, Univ. Paris-Sud, France
 *               2013-2017 IRT SystemX, France
 *               2011-2015 Achim D. Brucker, Germany
 *               2016-2018 The University of Sheffield, UK
 *               2016-2017 Nanyang Technological University, Singapore
 *               2017-2018 Virginia Tech, USA
 *
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are
 * met:
 *
 *     * Redistributions of source code must retain the above copyright
 *       notice, this list of conditions and the following disclaimer.
 *
 *     * Redistributions in binary form must reproduce the above
 *       copyright notice, this list of conditions and the following
 *       disclaimer in the documentation and/or other materials provided
 *       with the distribution.
 *
 *     * Neither the name of the copyright holders nor the names of its
 *       contributors may be used to endorse or promote products derived
 *       from this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 ******************************************************************************)</span>

<span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹Initializing the Parser›</span></span>

<span class="keyword1"><span class="command">theory</span></span>  Parser_init
<span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="Init.html">../Init</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Some Generic Combinators›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">K</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">co1</span> <span class="main">=</span> <span class="keyword1">(o)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">co2</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">x1</span></span></span> <span class="free"><span class="bound"><span class="entity">x2</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">x1</span></span></span> <span class="free"><span class="bound"><span class="entity">x2</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">co3</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">x1</span></span></span> <span class="free"><span class="bound"><span class="entity">x2</span></span></span> <span class="free"><span class="bound"><span class="entity">x3</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">x1</span></span></span> <span class="free"><span class="bound"><span class="entity">x2</span></span></span> <span class="free"><span class="bound"><span class="entity">x3</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">co4</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">x1</span></span></span> <span class="free"><span class="bound"><span class="entity">x2</span></span></span> <span class="free"><span class="bound"><span class="entity">x3</span></span></span> <span class="free"><span class="bound"><span class="entity">x4</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">x1</span></span></span> <span class="free"><span class="bound"><span class="entity">x2</span></span></span> <span class="free"><span class="bound"><span class="entity">x3</span></span></span> <span class="free"><span class="bound"><span class="entity">x4</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">co5</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">x1</span></span></span> <span class="free"><span class="bound"><span class="entity">x2</span></span></span> <span class="free"><span class="bound"><span class="entity">x3</span></span></span> <span class="free"><span class="bound"><span class="entity">x4</span></span></span> <span class="free"><span class="bound"><span class="entity">x5</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">x1</span></span></span> <span class="free"><span class="bound"><span class="entity">x2</span></span></span> <span class="free"><span class="bound"><span class="entity">x3</span></span></span> <span class="free"><span class="bound"><span class="entity">x4</span></span></span> <span class="free"><span class="bound"><span class="entity">x5</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">co6</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">x1</span></span></span> <span class="free"><span class="bound"><span class="entity">x2</span></span></span> <span class="free"><span class="bound"><span class="entity">x3</span></span></span> <span class="free"><span class="bound"><span class="entity">x4</span></span></span> <span class="free"><span class="bound"><span class="entity">x5</span></span></span> <span class="free"><span class="bound"><span class="entity">x6</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">x1</span></span></span> <span class="free"><span class="bound"><span class="entity">x2</span></span></span> <span class="free"><span class="bound"><span class="entity">x3</span></span></span> <span class="free"><span class="bound"><span class="entity">x4</span></span></span> <span class="free"><span class="bound"><span class="entity">x5</span></span></span> <span class="free"><span class="bound"><span class="entity">x6</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">co7</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">x1</span></span></span> <span class="free"><span class="bound"><span class="entity">x2</span></span></span> <span class="free"><span class="bound"><span class="entity">x3</span></span></span> <span class="free"><span class="bound"><span class="entity">x4</span></span></span> <span class="free"><span class="bound"><span class="entity">x5</span></span></span> <span class="free"><span class="bound"><span class="entity">x6</span></span></span> <span class="free"><span class="bound"><span class="entity">x7</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">x1</span></span></span> <span class="free"><span class="bound"><span class="entity">x2</span></span></span> <span class="free"><span class="bound"><span class="entity">x3</span></span></span> <span class="free"><span class="bound"><span class="entity">x4</span></span></span> <span class="free"><span class="bound"><span class="entity">x5</span></span></span> <span class="free"><span class="bound"><span class="entity">x6</span></span></span> <span class="free"><span class="bound"><span class="entity">x7</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">co8</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">x1</span></span></span> <span class="free"><span class="bound"><span class="entity">x2</span></span></span> <span class="free"><span class="bound"><span class="entity">x3</span></span></span> <span class="free"><span class="bound"><span class="entity">x4</span></span></span> <span class="free"><span class="bound"><span class="entity">x5</span></span></span> <span class="free"><span class="bound"><span class="entity">x6</span></span></span> <span class="free"><span class="bound"><span class="entity">x7</span></span></span> <span class="free"><span class="bound"><span class="entity">x8</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">x1</span></span></span> <span class="free"><span class="bound"><span class="entity">x2</span></span></span> <span class="free"><span class="bound"><span class="entity">x3</span></span></span> <span class="free"><span class="bound"><span class="entity">x4</span></span></span> <span class="free"><span class="bound"><span class="entity">x5</span></span></span> <span class="free"><span class="bound"><span class="entity">x6</span></span></span> <span class="free"><span class="bound"><span class="entity">x7</span></span></span> <span class="free"><span class="bound"><span class="entity">x8</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">co9</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">x1</span></span></span> <span class="free"><span class="bound"><span class="entity">x2</span></span></span> <span class="free"><span class="bound"><span class="entity">x3</span></span></span> <span class="free"><span class="bound"><span class="entity">x4</span></span></span> <span class="free"><span class="bound"><span class="entity">x5</span></span></span> <span class="free"><span class="bound"><span class="entity">x6</span></span></span> <span class="free"><span class="bound"><span class="entity">x7</span></span></span> <span class="free"><span class="bound"><span class="entity">x8</span></span></span> <span class="free"><span class="bound"><span class="entity">x9</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">x1</span></span></span> <span class="free"><span class="bound"><span class="entity">x2</span></span></span> <span class="free"><span class="bound"><span class="entity">x3</span></span></span> <span class="free"><span class="bound"><span class="entity">x4</span></span></span> <span class="free"><span class="bound"><span class="entity">x5</span></span></span> <span class="free"><span class="bound"><span class="entity">x6</span></span></span> <span class="free"><span class="bound"><span class="entity">x7</span></span></span> <span class="free"><span class="bound"><span class="entity">x8</span></span></span> <span class="free"><span class="bound"><span class="entity">x9</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">co10</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">x1</span></span></span> <span class="free"><span class="bound"><span class="entity">x2</span></span></span> <span class="free"><span class="bound"><span class="entity">x3</span></span></span> <span class="free"><span class="bound"><span class="entity">x4</span></span></span> <span class="free"><span class="bound"><span class="entity">x5</span></span></span> <span class="free"><span class="bound"><span class="entity">x6</span></span></span> <span class="free"><span class="bound"><span class="entity">x7</span></span></span> <span class="free"><span class="bound"><span class="entity">x8</span></span></span> <span class="free"><span class="bound"><span class="entity">x9</span></span></span> <span class="free"><span class="bound"><span class="entity">x10</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">x1</span></span></span> <span class="free"><span class="bound"><span class="entity">x2</span></span></span> <span class="free"><span class="bound"><span class="entity">x3</span></span></span> <span class="free"><span class="bound"><span class="entity">x4</span></span></span> <span class="free"><span class="bound"><span class="entity">x5</span></span></span> <span class="free"><span class="bound"><span class="entity">x6</span></span></span> <span class="free"><span class="bound"><span class="entity">x7</span></span></span> <span class="free"><span class="bound"><span class="entity">x8</span></span></span> <span class="free"><span class="bound"><span class="entity">x9</span></span></span> <span class="free"><span class="bound"><span class="entity">x10</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">co11</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">x1</span></span></span> <span class="free"><span class="bound"><span class="entity">x2</span></span></span> <span class="free"><span class="bound"><span class="entity">x3</span></span></span> <span class="free"><span class="bound"><span class="entity">x4</span></span></span> <span class="free"><span class="bound"><span class="entity">x5</span></span></span> <span class="free"><span class="bound"><span class="entity">x6</span></span></span> <span class="free"><span class="bound"><span class="entity">x7</span></span></span> <span class="free"><span class="bound"><span class="entity">x8</span></span></span> <span class="free"><span class="bound"><span class="entity">x9</span></span></span> <span class="free"><span class="bound"><span class="entity">x10</span></span></span> <span class="free"><span class="bound"><span class="entity">x11</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">x1</span></span></span> <span class="free"><span class="bound"><span class="entity">x2</span></span></span> <span class="free"><span class="bound"><span class="entity">x3</span></span></span> <span class="free"><span class="bound"><span class="entity">x4</span></span></span> <span class="free"><span class="bound"><span class="entity">x5</span></span></span> <span class="free"><span class="bound"><span class="entity">x6</span></span></span> <span class="free"><span class="bound"><span class="entity">x7</span></span></span> <span class="free"><span class="bound"><span class="entity">x8</span></span></span> <span class="free"><span class="bound"><span class="entity">x9</span></span></span> <span class="free"><span class="bound"><span class="entity">x10</span></span></span> <span class="free"><span class="bound"><span class="entity">x11</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">co12</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">x1</span></span></span> <span class="free"><span class="bound"><span class="entity">x2</span></span></span> <span class="free"><span class="bound"><span class="entity">x3</span></span></span> <span class="free"><span class="bound"><span class="entity">x4</span></span></span> <span class="free"><span class="bound"><span class="entity">x5</span></span></span> <span class="free"><span class="bound"><span class="entity">x6</span></span></span> <span class="free"><span class="bound"><span class="entity">x7</span></span></span> <span class="free"><span class="bound"><span class="entity">x8</span></span></span> <span class="free"><span class="bound"><span class="entity">x9</span></span></span> <span class="free"><span class="bound"><span class="entity">x10</span></span></span> <span class="free"><span class="bound"><span class="entity">x11</span></span></span> <span class="free"><span class="bound"><span class="entity">x12</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">x1</span></span></span> <span class="free"><span class="bound"><span class="entity">x2</span></span></span> <span class="free"><span class="bound"><span class="entity">x3</span></span></span> <span class="free"><span class="bound"><span class="entity">x4</span></span></span> <span class="free"><span class="bound"><span class="entity">x5</span></span></span> <span class="free"><span class="bound"><span class="entity">x6</span></span></span> <span class="free"><span class="bound"><span class="entity">x7</span></span></span> <span class="free"><span class="bound"><span class="entity">x8</span></span></span> <span class="free"><span class="bound"><span class="entity">x9</span></span></span> <span class="free"><span class="bound"><span class="entity">x10</span></span></span> <span class="free"><span class="bound"><span class="entity">x11</span></span></span> <span class="free"><span class="bound"><span class="entity">x12</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">co13</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">x1</span></span></span> <span class="free"><span class="bound"><span class="entity">x2</span></span></span> <span class="free"><span class="bound"><span class="entity">x3</span></span></span> <span class="free"><span class="bound"><span class="entity">x4</span></span></span> <span class="free"><span class="bound"><span class="entity">x5</span></span></span> <span class="free"><span class="bound"><span class="entity">x6</span></span></span> <span class="free"><span class="bound"><span class="entity">x7</span></span></span> <span class="free"><span class="bound"><span class="entity">x8</span></span></span> <span class="free"><span class="bound"><span class="entity">x9</span></span></span> <span class="free"><span class="bound"><span class="entity">x10</span></span></span> <span class="free"><span class="bound"><span class="entity">x11</span></span></span> <span class="free"><span class="bound"><span class="entity">x12</span></span></span> <span class="free"><span class="bound"><span class="entity">x13</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">x1</span></span></span> <span class="free"><span class="bound"><span class="entity">x2</span></span></span> <span class="free"><span class="bound"><span class="entity">x3</span></span></span> <span class="free"><span class="bound"><span class="entity">x4</span></span></span> <span class="free"><span class="bound"><span class="entity">x5</span></span></span> <span class="free"><span class="bound"><span class="entity">x6</span></span></span> <span class="free"><span class="bound"><span class="entity">x7</span></span></span> <span class="free"><span class="bound"><span class="entity">x8</span></span></span> <span class="free"><span class="bound"><span class="entity">x9</span></span></span> <span class="free"><span class="bound"><span class="entity">x10</span></span></span> <span class="free"><span class="bound"><span class="entity">x11</span></span></span> <span class="free"><span class="bound"><span class="entity">x12</span></span></span> <span class="free"><span class="bound"><span class="entity">x13</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">co14</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">x1</span></span></span> <span class="free"><span class="bound"><span class="entity">x2</span></span></span> <span class="free"><span class="bound"><span class="entity">x3</span></span></span> <span class="free"><span class="bound"><span class="entity">x4</span></span></span> <span class="free"><span class="bound"><span class="entity">x5</span></span></span> <span class="free"><span class="bound"><span class="entity">x6</span></span></span> <span class="free"><span class="bound"><span class="entity">x7</span></span></span> <span class="free"><span class="bound"><span class="entity">x8</span></span></span> <span class="free"><span class="bound"><span class="entity">x9</span></span></span> <span class="free"><span class="bound"><span class="entity">x10</span></span></span> <span class="free"><span class="bound"><span class="entity">x11</span></span></span> <span class="free"><span class="bound"><span class="entity">x12</span></span></span> <span class="free"><span class="bound"><span class="entity">x13</span></span></span> <span class="free"><span class="bound"><span class="entity">x14</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">x1</span></span></span> <span class="free"><span class="bound"><span class="entity">x2</span></span></span> <span class="free"><span class="bound"><span class="entity">x3</span></span></span> <span class="free"><span class="bound"><span class="entity">x4</span></span></span> <span class="free"><span class="bound"><span class="entity">x5</span></span></span> <span class="free"><span class="bound"><span class="entity">x6</span></span></span> <span class="free"><span class="bound"><span class="entity">x7</span></span></span> <span class="free"><span class="bound"><span class="entity">x8</span></span></span> <span class="free"><span class="bound"><span class="entity">x9</span></span></span> <span class="free"><span class="bound"><span class="entity">x10</span></span></span> <span class="free"><span class="bound"><span class="entity">x11</span></span></span> <span class="free"><span class="bound"><span class="entity">x12</span></span></span> <span class="free"><span class="bound"><span class="entity">x13</span></span></span> <span class="free"><span class="bound"><span class="entity">x14</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">co15</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">x1</span></span></span> <span class="free"><span class="bound"><span class="entity">x2</span></span></span> <span class="free"><span class="bound"><span class="entity">x3</span></span></span> <span class="free"><span class="bound"><span class="entity">x4</span></span></span> <span class="free"><span class="bound"><span class="entity">x5</span></span></span> <span class="free"><span class="bound"><span class="entity">x6</span></span></span> <span class="free"><span class="bound"><span class="entity">x7</span></span></span> <span class="free"><span class="bound"><span class="entity">x8</span></span></span> <span class="free"><span class="bound"><span class="entity">x9</span></span></span> <span class="free"><span class="bound"><span class="entity">x10</span></span></span> <span class="free"><span class="bound"><span class="entity">x11</span></span></span> <span class="free"><span class="bound"><span class="entity">x12</span></span></span> <span class="free"><span class="bound"><span class="entity">x13</span></span></span> <span class="free"><span class="bound"><span class="entity">x14</span></span></span> <span class="free"><span class="bound"><span class="entity">x15</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">x1</span></span></span> <span class="free"><span class="bound"><span class="entity">x2</span></span></span> <span class="free"><span class="bound"><span class="entity">x3</span></span></span> <span class="free"><span class="bound"><span class="entity">x4</span></span></span> <span class="free"><span class="bound"><span class="entity">x5</span></span></span> <span class="free"><span class="bound"><span class="entity">x6</span></span></span> <span class="free"><span class="bound"><span class="entity">x7</span></span></span> <span class="free"><span class="bound"><span class="entity">x8</span></span></span> <span class="free"><span class="bound"><span class="entity">x9</span></span></span> <span class="free"><span class="bound"><span class="entity">x10</span></span></span> <span class="free"><span class="bound"><span class="entity">x11</span></span></span> <span class="free"><span class="bound"><span class="entity">x12</span></span></span> <span class="free"><span class="bound"><span class="entity">x13</span></span></span> <span class="free"><span class="bound"><span class="entity">x14</span></span></span> <span class="free"><span class="bound"><span class="entity">x15</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">ap1</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">v0</span></span></span> <span class="free"><span class="bound"><span class="entity">f1</span></span></span> <span class="free"><span class="bound"><span class="entity">v1</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">v0</span></span></span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">f1</span></span></span> <span class="free"><span class="bound"><span class="entity">v1</span></span></span><span class="main">]</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">ap2</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">v0</span></span></span> <span class="free"><span class="bound"><span class="entity">f1</span></span></span> <span class="free"><span class="bound"><span class="entity">f2</span></span></span> <span class="free"><span class="bound"><span class="entity">v1</span></span></span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">v0</span></span></span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">f1</span></span></span> <span class="free"><span class="bound"><span class="entity">v1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f2</span></span></span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span><span class="main">]</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">ap3</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">v0</span></span></span> <span class="free"><span class="bound"><span class="entity">f1</span></span></span> <span class="free"><span class="bound"><span class="entity">f2</span></span></span> <span class="free"><span class="bound"><span class="entity">f3</span></span></span> <span class="free"><span class="bound"><span class="entity">v1</span></span></span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span> <span class="free"><span class="bound"><span class="entity">v3</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">v0</span></span></span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">f1</span></span></span> <span class="free"><span class="bound"><span class="entity">v1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f2</span></span></span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f3</span></span></span> <span class="free"><span class="bound"><span class="entity">v3</span></span></span><span class="main">]</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">ap4</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">v0</span></span></span> <span class="free"><span class="bound"><span class="entity">f1</span></span></span> <span class="free"><span class="bound"><span class="entity">f2</span></span></span> <span class="free"><span class="bound"><span class="entity">f3</span></span></span> <span class="free"><span class="bound"><span class="entity">f4</span></span></span> <span class="free"><span class="bound"><span class="entity">v1</span></span></span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span> <span class="free"><span class="bound"><span class="entity">v3</span></span></span> <span class="free"><span class="bound"><span class="entity">v4</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">v0</span></span></span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">f1</span></span></span> <span class="free"><span class="bound"><span class="entity">v1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f2</span></span></span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f3</span></span></span> <span class="free"><span class="bound"><span class="entity">v3</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f4</span></span></span> <span class="free"><span class="bound"><span class="entity">v4</span></span></span><span class="main">]</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">ap5</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">v0</span></span></span> <span class="free"><span class="bound"><span class="entity">f1</span></span></span> <span class="free"><span class="bound"><span class="entity">f2</span></span></span> <span class="free"><span class="bound"><span class="entity">f3</span></span></span> <span class="free"><span class="bound"><span class="entity">f4</span></span></span> <span class="free"><span class="bound"><span class="entity">f5</span></span></span> <span class="free"><span class="bound"><span class="entity">v1</span></span></span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span> <span class="free"><span class="bound"><span class="entity">v3</span></span></span> <span class="free"><span class="bound"><span class="entity">v4</span></span></span> <span class="free"><span class="bound"><span class="entity">v5</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">v0</span></span></span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">f1</span></span></span> <span class="free"><span class="bound"><span class="entity">v1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f2</span></span></span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f3</span></span></span> <span class="free"><span class="bound"><span class="entity">v3</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f4</span></span></span> <span class="free"><span class="bound"><span class="entity">v4</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f5</span></span></span> <span class="free"><span class="bound"><span class="entity">v5</span></span></span><span class="main">]</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">ap6</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">v0</span></span></span> <span class="free"><span class="bound"><span class="entity">f1</span></span></span> <span class="free"><span class="bound"><span class="entity">f2</span></span></span> <span class="free"><span class="bound"><span class="entity">f3</span></span></span> <span class="free"><span class="bound"><span class="entity">f4</span></span></span> <span class="free"><span class="bound"><span class="entity">f5</span></span></span> <span class="free"><span class="bound"><span class="entity">f6</span></span></span> <span class="free"><span class="bound"><span class="entity">v1</span></span></span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span> <span class="free"><span class="bound"><span class="entity">v3</span></span></span> <span class="free"><span class="bound"><span class="entity">v4</span></span></span> <span class="free"><span class="bound"><span class="entity">v5</span></span></span> <span class="free"><span class="bound"><span class="entity">v6</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">v0</span></span></span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">f1</span></span></span> <span class="free"><span class="bound"><span class="entity">v1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f2</span></span></span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f3</span></span></span> <span class="free"><span class="bound"><span class="entity">v3</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f4</span></span></span> <span class="free"><span class="bound"><span class="entity">v4</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f5</span></span></span> <span class="free"><span class="bound"><span class="entity">v5</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f6</span></span></span> <span class="free"><span class="bound"><span class="entity">v6</span></span></span><span class="main">]</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">ap7</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">v0</span></span></span> <span class="free"><span class="bound"><span class="entity">f1</span></span></span> <span class="free"><span class="bound"><span class="entity">f2</span></span></span> <span class="free"><span class="bound"><span class="entity">f3</span></span></span> <span class="free"><span class="bound"><span class="entity">f4</span></span></span> <span class="free"><span class="bound"><span class="entity">f5</span></span></span> <span class="free"><span class="bound"><span class="entity">f6</span></span></span> <span class="free"><span class="bound"><span class="entity">f7</span></span></span> <span class="free"><span class="bound"><span class="entity">v1</span></span></span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span> <span class="free"><span class="bound"><span class="entity">v3</span></span></span> <span class="free"><span class="bound"><span class="entity">v4</span></span></span> <span class="free"><span class="bound"><span class="entity">v5</span></span></span> <span class="free"><span class="bound"><span class="entity">v6</span></span></span> <span class="free"><span class="bound"><span class="entity">v7</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">v0</span></span></span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">f1</span></span></span> <span class="free"><span class="bound"><span class="entity">v1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f2</span></span></span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f3</span></span></span> <span class="free"><span class="bound"><span class="entity">v3</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f4</span></span></span> <span class="free"><span class="bound"><span class="entity">v4</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f5</span></span></span> <span class="free"><span class="bound"><span class="entity">v5</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f6</span></span></span> <span class="free"><span class="bound"><span class="entity">v6</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f7</span></span></span> <span class="free"><span class="bound"><span class="entity">v7</span></span></span><span class="main">]</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">ap8</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">v0</span></span></span> <span class="free"><span class="bound"><span class="entity">f1</span></span></span> <span class="free"><span class="bound"><span class="entity">f2</span></span></span> <span class="free"><span class="bound"><span class="entity">f3</span></span></span> <span class="free"><span class="bound"><span class="entity">f4</span></span></span> <span class="free"><span class="bound"><span class="entity">f5</span></span></span> <span class="free"><span class="bound"><span class="entity">f6</span></span></span> <span class="free"><span class="bound"><span class="entity">f7</span></span></span> <span class="free"><span class="bound"><span class="entity">f8</span></span></span> <span class="free"><span class="bound"><span class="entity">v1</span></span></span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span> <span class="free"><span class="bound"><span class="entity">v3</span></span></span> <span class="free"><span class="bound"><span class="entity">v4</span></span></span> <span class="free"><span class="bound"><span class="entity">v5</span></span></span> <span class="free"><span class="bound"><span class="entity">v6</span></span></span> <span class="free"><span class="bound"><span class="entity">v7</span></span></span> <span class="free"><span class="bound"><span class="entity">v8</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">v0</span></span></span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">f1</span></span></span> <span class="free"><span class="bound"><span class="entity">v1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f2</span></span></span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f3</span></span></span> <span class="free"><span class="bound"><span class="entity">v3</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f4</span></span></span> <span class="free"><span class="bound"><span class="entity">v4</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f5</span></span></span> <span class="free"><span class="bound"><span class="entity">v5</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f6</span></span></span> <span class="free"><span class="bound"><span class="entity">v6</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f7</span></span></span> <span class="free"><span class="bound"><span class="entity">v7</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f8</span></span></span> <span class="free"><span class="bound"><span class="entity">v8</span></span></span><span class="main">]</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">ap9</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">v0</span></span></span> <span class="free"><span class="bound"><span class="entity">f1</span></span></span> <span class="free"><span class="bound"><span class="entity">f2</span></span></span> <span class="free"><span class="bound"><span class="entity">f3</span></span></span> <span class="free"><span class="bound"><span class="entity">f4</span></span></span> <span class="free"><span class="bound"><span class="entity">f5</span></span></span> <span class="free"><span class="bound"><span class="entity">f6</span></span></span> <span class="free"><span class="bound"><span class="entity">f7</span></span></span> <span class="free"><span class="bound"><span class="entity">f8</span></span></span> <span class="free"><span class="bound"><span class="entity">f9</span></span></span> <span class="free"><span class="bound"><span class="entity">v1</span></span></span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span> <span class="free"><span class="bound"><span class="entity">v3</span></span></span> <span class="free"><span class="bound"><span class="entity">v4</span></span></span> <span class="free"><span class="bound"><span class="entity">v5</span></span></span> <span class="free"><span class="bound"><span class="entity">v6</span></span></span> <span class="free"><span class="bound"><span class="entity">v7</span></span></span> <span class="free"><span class="bound"><span class="entity">v8</span></span></span> <span class="free"><span class="bound"><span class="entity">v9</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">v0</span></span></span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">f1</span></span></span> <span class="free"><span class="bound"><span class="entity">v1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f2</span></span></span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f3</span></span></span> <span class="free"><span class="bound"><span class="entity">v3</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f4</span></span></span> <span class="free"><span class="bound"><span class="entity">v4</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f5</span></span></span> <span class="free"><span class="bound"><span class="entity">v5</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f6</span></span></span> <span class="free"><span class="bound"><span class="entity">v6</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f7</span></span></span> <span class="free"><span class="bound"><span class="entity">v7</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f8</span></span></span> <span class="free"><span class="bound"><span class="entity">v8</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f9</span></span></span> <span class="free"><span class="bound"><span class="entity">v9</span></span></span><span class="main">]</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">ap10</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">v0</span></span></span> <span class="free"><span class="bound"><span class="entity">f1</span></span></span> <span class="free"><span class="bound"><span class="entity">f2</span></span></span> <span class="free"><span class="bound"><span class="entity">f3</span></span></span> <span class="free"><span class="bound"><span class="entity">f4</span></span></span> <span class="free"><span class="bound"><span class="entity">f5</span></span></span> <span class="free"><span class="bound"><span class="entity">f6</span></span></span> <span class="free"><span class="bound"><span class="entity">f7</span></span></span> <span class="free"><span class="bound"><span class="entity">f8</span></span></span> <span class="free"><span class="bound"><span class="entity">f9</span></span></span> <span class="free"><span class="bound"><span class="entity">f10</span></span></span> <span class="free"><span class="bound"><span class="entity">v1</span></span></span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span> <span class="free"><span class="bound"><span class="entity">v3</span></span></span> <span class="free"><span class="bound"><span class="entity">v4</span></span></span> <span class="free"><span class="bound"><span class="entity">v5</span></span></span> <span class="free"><span class="bound"><span class="entity">v6</span></span></span> <span class="free"><span class="bound"><span class="entity">v7</span></span></span> <span class="free"><span class="bound"><span class="entity">v8</span></span></span> <span class="free"><span class="bound"><span class="entity">v9</span></span></span> <span class="free"><span class="bound"><span class="entity">v10</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">v0</span></span></span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">f1</span></span></span> <span class="free"><span class="bound"><span class="entity">v1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f2</span></span></span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f3</span></span></span> <span class="free"><span class="bound"><span class="entity">v3</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f4</span></span></span> <span class="free"><span class="bound"><span class="entity">v4</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f5</span></span></span> <span class="free"><span class="bound"><span class="entity">v5</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f6</span></span></span> <span class="free"><span class="bound"><span class="entity">v6</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f7</span></span></span> <span class="free"><span class="bound"><span class="entity">v7</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f8</span></span></span> <span class="free"><span class="bound"><span class="entity">v8</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f9</span></span></span> <span class="free"><span class="bound"><span class="entity">v9</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f10</span></span></span> <span class="free"><span class="bound"><span class="entity">v10</span></span></span><span class="main">]</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">ap11</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">v0</span></span></span> <span class="free"><span class="bound"><span class="entity">f1</span></span></span> <span class="free"><span class="bound"><span class="entity">f2</span></span></span> <span class="free"><span class="bound"><span class="entity">f3</span></span></span> <span class="free"><span class="bound"><span class="entity">f4</span></span></span> <span class="free"><span class="bound"><span class="entity">f5</span></span></span> <span class="free"><span class="bound"><span class="entity">f6</span></span></span> <span class="free"><span class="bound"><span class="entity">f7</span></span></span> <span class="free"><span class="bound"><span class="entity">f8</span></span></span> <span class="free"><span class="bound"><span class="entity">f9</span></span></span> <span class="free"><span class="bound"><span class="entity">f10</span></span></span> <span class="free"><span class="bound"><span class="entity">f11</span></span></span> <span class="free"><span class="bound"><span class="entity">v1</span></span></span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span> <span class="free"><span class="bound"><span class="entity">v3</span></span></span> <span class="free"><span class="bound"><span class="entity">v4</span></span></span> <span class="free"><span class="bound"><span class="entity">v5</span></span></span> <span class="free"><span class="bound"><span class="entity">v6</span></span></span> <span class="free"><span class="bound"><span class="entity">v7</span></span></span> <span class="free"><span class="bound"><span class="entity">v8</span></span></span> <span class="free"><span class="bound"><span class="entity">v9</span></span></span> <span class="free"><span class="bound"><span class="entity">v10</span></span></span> <span class="free"><span class="bound"><span class="entity">v11</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">v0</span></span></span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">f1</span></span></span> <span class="free"><span class="bound"><span class="entity">v1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f2</span></span></span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f3</span></span></span> <span class="free"><span class="bound"><span class="entity">v3</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f4</span></span></span> <span class="free"><span class="bound"><span class="entity">v4</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f5</span></span></span> <span class="free"><span class="bound"><span class="entity">v5</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f6</span></span></span> <span class="free"><span class="bound"><span class="entity">v6</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f7</span></span></span> <span class="free"><span class="bound"><span class="entity">v7</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f8</span></span></span> <span class="free"><span class="bound"><span class="entity">v8</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f9</span></span></span> <span class="free"><span class="bound"><span class="entity">v9</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f10</span></span></span> <span class="free"><span class="bound"><span class="entity">v10</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f11</span></span></span> <span class="free"><span class="bound"><span class="entity">v11</span></span></span><span class="main">]</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">ap12</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">v0</span></span></span> <span class="free"><span class="bound"><span class="entity">f1</span></span></span> <span class="free"><span class="bound"><span class="entity">f2</span></span></span> <span class="free"><span class="bound"><span class="entity">f3</span></span></span> <span class="free"><span class="bound"><span class="entity">f4</span></span></span> <span class="free"><span class="bound"><span class="entity">f5</span></span></span> <span class="free"><span class="bound"><span class="entity">f6</span></span></span> <span class="free"><span class="bound"><span class="entity">f7</span></span></span> <span class="free"><span class="bound"><span class="entity">f8</span></span></span> <span class="free"><span class="bound"><span class="entity">f9</span></span></span> <span class="free"><span class="bound"><span class="entity">f10</span></span></span> <span class="free"><span class="bound"><span class="entity">f11</span></span></span> <span class="free"><span class="bound"><span class="entity">f12</span></span></span> <span class="free"><span class="bound"><span class="entity">v1</span></span></span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span> <span class="free"><span class="bound"><span class="entity">v3</span></span></span> <span class="free"><span class="bound"><span class="entity">v4</span></span></span> <span class="free"><span class="bound"><span class="entity">v5</span></span></span> <span class="free"><span class="bound"><span class="entity">v6</span></span></span> <span class="free"><span class="bound"><span class="entity">v7</span></span></span> <span class="free"><span class="bound"><span class="entity">v8</span></span></span> <span class="free"><span class="bound"><span class="entity">v9</span></span></span> <span class="free"><span class="bound"><span class="entity">v10</span></span></span> <span class="free"><span class="bound"><span class="entity">v11</span></span></span> <span class="free"><span class="bound"><span class="entity">v12</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">v0</span></span></span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">f1</span></span></span> <span class="free"><span class="bound"><span class="entity">v1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f2</span></span></span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f3</span></span></span> <span class="free"><span class="bound"><span class="entity">v3</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f4</span></span></span> <span class="free"><span class="bound"><span class="entity">v4</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f5</span></span></span> <span class="free"><span class="bound"><span class="entity">v5</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f6</span></span></span> <span class="free"><span class="bound"><span class="entity">v6</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f7</span></span></span> <span class="free"><span class="bound"><span class="entity">v7</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f8</span></span></span> <span class="free"><span class="bound"><span class="entity">v8</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f9</span></span></span> <span class="free"><span class="bound"><span class="entity">v9</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f10</span></span></span> <span class="free"><span class="bound"><span class="entity">v10</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f11</span></span></span> <span class="free"><span class="bound"><span class="entity">v11</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f12</span></span></span> <span class="free"><span class="bound"><span class="entity">v12</span></span></span><span class="main">]</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">ap13</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">v0</span></span></span> <span class="free"><span class="bound"><span class="entity">f1</span></span></span> <span class="free"><span class="bound"><span class="entity">f2</span></span></span> <span class="free"><span class="bound"><span class="entity">f3</span></span></span> <span class="free"><span class="bound"><span class="entity">f4</span></span></span> <span class="free"><span class="bound"><span class="entity">f5</span></span></span> <span class="free"><span class="bound"><span class="entity">f6</span></span></span> <span class="free"><span class="bound"><span class="entity">f7</span></span></span> <span class="free"><span class="bound"><span class="entity">f8</span></span></span> <span class="free"><span class="bound"><span class="entity">f9</span></span></span> <span class="free"><span class="bound"><span class="entity">f10</span></span></span> <span class="free"><span class="bound"><span class="entity">f11</span></span></span> <span class="free"><span class="bound"><span class="entity">f12</span></span></span> <span class="free"><span class="bound"><span class="entity">f13</span></span></span> <span class="free"><span class="bound"><span class="entity">v1</span></span></span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span> <span class="free"><span class="bound"><span class="entity">v3</span></span></span> <span class="free"><span class="bound"><span class="entity">v4</span></span></span> <span class="free"><span class="bound"><span class="entity">v5</span></span></span> <span class="free"><span class="bound"><span class="entity">v6</span></span></span> <span class="free"><span class="bound"><span class="entity">v7</span></span></span> <span class="free"><span class="bound"><span class="entity">v8</span></span></span> <span class="free"><span class="bound"><span class="entity">v9</span></span></span> <span class="free"><span class="bound"><span class="entity">v10</span></span></span> <span class="free"><span class="bound"><span class="entity">v11</span></span></span> <span class="free"><span class="bound"><span class="entity">v12</span></span></span> <span class="free"><span class="bound"><span class="entity">v13</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">v0</span></span></span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">f1</span></span></span> <span class="free"><span class="bound"><span class="entity">v1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f2</span></span></span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f3</span></span></span> <span class="free"><span class="bound"><span class="entity">v3</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f4</span></span></span> <span class="free"><span class="bound"><span class="entity">v4</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f5</span></span></span> <span class="free"><span class="bound"><span class="entity">v5</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f6</span></span></span> <span class="free"><span class="bound"><span class="entity">v6</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f7</span></span></span> <span class="free"><span class="bound"><span class="entity">v7</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f8</span></span></span> <span class="free"><span class="bound"><span class="entity">v8</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f9</span></span></span> <span class="free"><span class="bound"><span class="entity">v9</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f10</span></span></span> <span class="free"><span class="bound"><span class="entity">v10</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f11</span></span></span> <span class="free"><span class="bound"><span class="entity">v11</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f12</span></span></span> <span class="free"><span class="bound"><span class="entity">v12</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f13</span></span></span> <span class="free"><span class="bound"><span class="entity">v13</span></span></span><span class="main">]</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">ap14</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">v0</span></span></span> <span class="free"><span class="bound"><span class="entity">f1</span></span></span> <span class="free"><span class="bound"><span class="entity">f2</span></span></span> <span class="free"><span class="bound"><span class="entity">f3</span></span></span> <span class="free"><span class="bound"><span class="entity">f4</span></span></span> <span class="free"><span class="bound"><span class="entity">f5</span></span></span> <span class="free"><span class="bound"><span class="entity">f6</span></span></span> <span class="free"><span class="bound"><span class="entity">f7</span></span></span> <span class="free"><span class="bound"><span class="entity">f8</span></span></span> <span class="free"><span class="bound"><span class="entity">f9</span></span></span> <span class="free"><span class="bound"><span class="entity">f10</span></span></span> <span class="free"><span class="bound"><span class="entity">f11</span></span></span> <span class="free"><span class="bound"><span class="entity">f12</span></span></span> <span class="free"><span class="bound"><span class="entity">f13</span></span></span> <span class="free"><span class="bound"><span class="entity">f14</span></span></span> <span class="free"><span class="bound"><span class="entity">v1</span></span></span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span> <span class="free"><span class="bound"><span class="entity">v3</span></span></span> <span class="free"><span class="bound"><span class="entity">v4</span></span></span> <span class="free"><span class="bound"><span class="entity">v5</span></span></span> <span class="free"><span class="bound"><span class="entity">v6</span></span></span> <span class="free"><span class="bound"><span class="entity">v7</span></span></span> <span class="free"><span class="bound"><span class="entity">v8</span></span></span> <span class="free"><span class="bound"><span class="entity">v9</span></span></span> <span class="free"><span class="bound"><span class="entity">v10</span></span></span> <span class="free"><span class="bound"><span class="entity">v11</span></span></span> <span class="free"><span class="bound"><span class="entity">v12</span></span></span> <span class="free"><span class="bound"><span class="entity">v13</span></span></span> <span class="free"><span class="bound"><span class="entity">v14</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">v0</span></span></span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">f1</span></span></span> <span class="free"><span class="bound"><span class="entity">v1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f2</span></span></span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f3</span></span></span> <span class="free"><span class="bound"><span class="entity">v3</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f4</span></span></span> <span class="free"><span class="bound"><span class="entity">v4</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f5</span></span></span> <span class="free"><span class="bound"><span class="entity">v5</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f6</span></span></span> <span class="free"><span class="bound"><span class="entity">v6</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f7</span></span></span> <span class="free"><span class="bound"><span class="entity">v7</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f8</span></span></span> <span class="free"><span class="bound"><span class="entity">v8</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f9</span></span></span> <span class="free"><span class="bound"><span class="entity">v9</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f10</span></span></span> <span class="free"><span class="bound"><span class="entity">v10</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f11</span></span></span> <span class="free"><span class="bound"><span class="entity">v11</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f12</span></span></span> <span class="free"><span class="bound"><span class="entity">v12</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f13</span></span></span> <span class="free"><span class="bound"><span class="entity">v13</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f14</span></span></span> <span class="free"><span class="bound"><span class="entity">v14</span></span></span><span class="main">]</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">ap15</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">v0</span></span></span> <span class="free"><span class="bound"><span class="entity">f1</span></span></span> <span class="free"><span class="bound"><span class="entity">f2</span></span></span> <span class="free"><span class="bound"><span class="entity">f3</span></span></span> <span class="free"><span class="bound"><span class="entity">f4</span></span></span> <span class="free"><span class="bound"><span class="entity">f5</span></span></span> <span class="free"><span class="bound"><span class="entity">f6</span></span></span> <span class="free"><span class="bound"><span class="entity">f7</span></span></span> <span class="free"><span class="bound"><span class="entity">f8</span></span></span> <span class="free"><span class="bound"><span class="entity">f9</span></span></span> <span class="free"><span class="bound"><span class="entity">f10</span></span></span> <span class="free"><span class="bound"><span class="entity">f11</span></span></span> <span class="free"><span class="bound"><span class="entity">f12</span></span></span> <span class="free"><span class="bound"><span class="entity">f13</span></span></span> <span class="free"><span class="bound"><span class="entity">f14</span></span></span> <span class="free"><span class="bound"><span class="entity">f15</span></span></span> <span class="free"><span class="bound"><span class="entity">v1</span></span></span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span> <span class="free"><span class="bound"><span class="entity">v3</span></span></span> <span class="free"><span class="bound"><span class="entity">v4</span></span></span> <span class="free"><span class="bound"><span class="entity">v5</span></span></span> <span class="free"><span class="bound"><span class="entity">v6</span></span></span> <span class="free"><span class="bound"><span class="entity">v7</span></span></span> <span class="free"><span class="bound"><span class="entity">v8</span></span></span> <span class="free"><span class="bound"><span class="entity">v9</span></span></span> <span class="free"><span class="bound"><span class="entity">v10</span></span></span> <span class="free"><span class="bound"><span class="entity">v11</span></span></span> <span class="free"><span class="bound"><span class="entity">v12</span></span></span> <span class="free"><span class="bound"><span class="entity">v13</span></span></span> <span class="free"><span class="bound"><span class="entity">v14</span></span></span> <span class="free"><span class="bound"><span class="entity">v15</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">v0</span></span></span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">f1</span></span></span> <span class="free"><span class="bound"><span class="entity">v1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f2</span></span></span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f3</span></span></span> <span class="free"><span class="bound"><span class="entity">v3</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f4</span></span></span> <span class="free"><span class="bound"><span class="entity">v4</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f5</span></span></span> <span class="free"><span class="bound"><span class="entity">v5</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f6</span></span></span> <span class="free"><span class="bound"><span class="entity">v6</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f7</span></span></span> <span class="free"><span class="bound"><span class="entity">v7</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f8</span></span></span> <span class="free"><span class="bound"><span class="entity">v8</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f9</span></span></span> <span class="free"><span class="bound"><span class="entity">v9</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f10</span></span></span> <span class="free"><span class="bound"><span class="entity">v10</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f11</span></span></span> <span class="free"><span class="bound"><span class="entity">v11</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f12</span></span></span> <span class="free"><span class="bound"><span class="entity">v12</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f13</span></span></span> <span class="free"><span class="bound"><span class="entity">v13</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f14</span></span></span> <span class="free"><span class="bound"><span class="entity">v14</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f15</span></span></span> <span class="free"><span class="bound"><span class="entity">v15</span></span></span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">ar1</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">v0</span></span></span> <span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">v0</span></span></span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">z</span></span></span><span class="main">]</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">ar2</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">v0</span></span></span> <span class="free"><span class="bound"><span class="entity">f1</span></span></span> <span class="free"><span class="bound"><span class="entity">v1</span></span></span> <span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">v0</span></span></span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">f1</span></span></span> <span class="free"><span class="bound"><span class="entity">v1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">z</span></span></span><span class="main">]</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">ar3</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">v0</span></span></span> <span class="free"><span class="bound"><span class="entity">f1</span></span></span> <span class="free"><span class="bound"><span class="entity">f2</span></span></span> <span class="free"><span class="bound"><span class="entity">v1</span></span></span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span> <span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">v0</span></span></span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">f1</span></span></span> <span class="free"><span class="bound"><span class="entity">v1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f2</span></span></span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">z</span></span></span><span class="main">]</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">ar4</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">v0</span></span></span> <span class="free"><span class="bound"><span class="entity">f1</span></span></span> <span class="free"><span class="bound"><span class="entity">f2</span></span></span> <span class="free"><span class="bound"><span class="entity">f3</span></span></span> <span class="free"><span class="bound"><span class="entity">v1</span></span></span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span> <span class="free"><span class="bound"><span class="entity">v3</span></span></span> <span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">v0</span></span></span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">f1</span></span></span> <span class="free"><span class="bound"><span class="entity">v1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f2</span></span></span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f3</span></span></span> <span class="free"><span class="bound"><span class="entity">v3</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">z</span></span></span><span class="main">]</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">ar5</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">v0</span></span></span> <span class="free"><span class="bound"><span class="entity">f1</span></span></span> <span class="free"><span class="bound"><span class="entity">f2</span></span></span> <span class="free"><span class="bound"><span class="entity">f3</span></span></span> <span class="free"><span class="bound"><span class="entity">f4</span></span></span> <span class="free"><span class="bound"><span class="entity">v1</span></span></span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span> <span class="free"><span class="bound"><span class="entity">v3</span></span></span> <span class="free"><span class="bound"><span class="entity">v4</span></span></span> <span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">v0</span></span></span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">f1</span></span></span> <span class="free"><span class="bound"><span class="entity">v1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f2</span></span></span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f3</span></span></span> <span class="free"><span class="bound"><span class="entity">v3</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f4</span></span></span> <span class="free"><span class="bound"><span class="entity">v4</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">z</span></span></span><span class="main">]</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">ar6</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">v0</span></span></span> <span class="free"><span class="bound"><span class="entity">f1</span></span></span> <span class="free"><span class="bound"><span class="entity">f2</span></span></span> <span class="free"><span class="bound"><span class="entity">f3</span></span></span> <span class="free"><span class="bound"><span class="entity">f4</span></span></span> <span class="free"><span class="bound"><span class="entity">f5</span></span></span> <span class="free"><span class="bound"><span class="entity">v1</span></span></span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span> <span class="free"><span class="bound"><span class="entity">v3</span></span></span> <span class="free"><span class="bound"><span class="entity">v4</span></span></span> <span class="free"><span class="bound"><span class="entity">v5</span></span></span> <span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">v0</span></span></span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">f1</span></span></span> <span class="free"><span class="bound"><span class="entity">v1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f2</span></span></span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f3</span></span></span> <span class="free"><span class="bound"><span class="entity">v3</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f4</span></span></span> <span class="free"><span class="bound"><span class="entity">v4</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f5</span></span></span> <span class="free"><span class="bound"><span class="entity">v5</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">z</span></span></span><span class="main">]</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">ar7</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">v0</span></span></span> <span class="free"><span class="bound"><span class="entity">f1</span></span></span> <span class="free"><span class="bound"><span class="entity">f2</span></span></span> <span class="free"><span class="bound"><span class="entity">f3</span></span></span> <span class="free"><span class="bound"><span class="entity">f4</span></span></span> <span class="free"><span class="bound"><span class="entity">f5</span></span></span> <span class="free"><span class="bound"><span class="entity">f6</span></span></span> <span class="free"><span class="bound"><span class="entity">v1</span></span></span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span> <span class="free"><span class="bound"><span class="entity">v3</span></span></span> <span class="free"><span class="bound"><span class="entity">v4</span></span></span> <span class="free"><span class="bound"><span class="entity">v5</span></span></span> <span class="free"><span class="bound"><span class="entity">v6</span></span></span> <span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">v0</span></span></span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">f1</span></span></span> <span class="free"><span class="bound"><span class="entity">v1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f2</span></span></span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f3</span></span></span> <span class="free"><span class="bound"><span class="entity">v3</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f4</span></span></span> <span class="free"><span class="bound"><span class="entity">v4</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f5</span></span></span> <span class="free"><span class="bound"><span class="entity">v5</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f6</span></span></span> <span class="free"><span class="bound"><span class="entity">v6</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">z</span></span></span><span class="main">]</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">ar8</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">v0</span></span></span> <span class="free"><span class="bound"><span class="entity">f1</span></span></span> <span class="free"><span class="bound"><span class="entity">f2</span></span></span> <span class="free"><span class="bound"><span class="entity">f3</span></span></span> <span class="free"><span class="bound"><span class="entity">f4</span></span></span> <span class="free"><span class="bound"><span class="entity">f5</span></span></span> <span class="free"><span class="bound"><span class="entity">f6</span></span></span> <span class="free"><span class="bound"><span class="entity">f7</span></span></span> <span class="free"><span class="bound"><span class="entity">v1</span></span></span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span> <span class="free"><span class="bound"><span class="entity">v3</span></span></span> <span class="free"><span class="bound"><span class="entity">v4</span></span></span> <span class="free"><span class="bound"><span class="entity">v5</span></span></span> <span class="free"><span class="bound"><span class="entity">v6</span></span></span> <span class="free"><span class="bound"><span class="entity">v7</span></span></span> <span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">v0</span></span></span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">f1</span></span></span> <span class="free"><span class="bound"><span class="entity">v1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f2</span></span></span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f3</span></span></span> <span class="free"><span class="bound"><span class="entity">v3</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f4</span></span></span> <span class="free"><span class="bound"><span class="entity">v4</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f5</span></span></span> <span class="free"><span class="bound"><span class="entity">v5</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f6</span></span></span> <span class="free"><span class="bound"><span class="entity">v6</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f7</span></span></span> <span class="free"><span class="bound"><span class="entity">v7</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">z</span></span></span><span class="main">]</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">ar9</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">v0</span></span></span> <span class="free"><span class="bound"><span class="entity">f1</span></span></span> <span class="free"><span class="bound"><span class="entity">f2</span></span></span> <span class="free"><span class="bound"><span class="entity">f3</span></span></span> <span class="free"><span class="bound"><span class="entity">f4</span></span></span> <span class="free"><span class="bound"><span class="entity">f5</span></span></span> <span class="free"><span class="bound"><span class="entity">f6</span></span></span> <span class="free"><span class="bound"><span class="entity">f7</span></span></span> <span class="free"><span class="bound"><span class="entity">f8</span></span></span> <span class="free"><span class="bound"><span class="entity">v1</span></span></span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span> <span class="free"><span class="bound"><span class="entity">v3</span></span></span> <span class="free"><span class="bound"><span class="entity">v4</span></span></span> <span class="free"><span class="bound"><span class="entity">v5</span></span></span> <span class="free"><span class="bound"><span class="entity">v6</span></span></span> <span class="free"><span class="bound"><span class="entity">v7</span></span></span> <span class="free"><span class="bound"><span class="entity">v8</span></span></span> <span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">v0</span></span></span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">f1</span></span></span> <span class="free"><span class="bound"><span class="entity">v1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f2</span></span></span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f3</span></span></span> <span class="free"><span class="bound"><span class="entity">v3</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f4</span></span></span> <span class="free"><span class="bound"><span class="entity">v4</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f5</span></span></span> <span class="free"><span class="bound"><span class="entity">v5</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f6</span></span></span> <span class="free"><span class="bound"><span class="entity">v6</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f7</span></span></span> <span class="free"><span class="bound"><span class="entity">v7</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f8</span></span></span> <span class="free"><span class="bound"><span class="entity">v8</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">z</span></span></span><span class="main">]</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">ar10</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">v0</span></span></span> <span class="free"><span class="bound"><span class="entity">f1</span></span></span> <span class="free"><span class="bound"><span class="entity">f2</span></span></span> <span class="free"><span class="bound"><span class="entity">f3</span></span></span> <span class="free"><span class="bound"><span class="entity">f4</span></span></span> <span class="free"><span class="bound"><span class="entity">f5</span></span></span> <span class="free"><span class="bound"><span class="entity">f6</span></span></span> <span class="free"><span class="bound"><span class="entity">f7</span></span></span> <span class="free"><span class="bound"><span class="entity">f8</span></span></span> <span class="free"><span class="bound"><span class="entity">f9</span></span></span> <span class="free"><span class="bound"><span class="entity">v1</span></span></span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span> <span class="free"><span class="bound"><span class="entity">v3</span></span></span> <span class="free"><span class="bound"><span class="entity">v4</span></span></span> <span class="free"><span class="bound"><span class="entity">v5</span></span></span> <span class="free"><span class="bound"><span class="entity">v6</span></span></span> <span class="free"><span class="bound"><span class="entity">v7</span></span></span> <span class="free"><span class="bound"><span class="entity">v8</span></span></span> <span class="free"><span class="bound"><span class="entity">v9</span></span></span> <span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">v0</span></span></span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">f1</span></span></span> <span class="free"><span class="bound"><span class="entity">v1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f2</span></span></span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f3</span></span></span> <span class="free"><span class="bound"><span class="entity">v3</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f4</span></span></span> <span class="free"><span class="bound"><span class="entity">v4</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f5</span></span></span> <span class="free"><span class="bound"><span class="entity">v5</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f6</span></span></span> <span class="free"><span class="bound"><span class="entity">v6</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f7</span></span></span> <span class="free"><span class="bound"><span class="entity">v7</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f8</span></span></span> <span class="free"><span class="bound"><span class="entity">v8</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f9</span></span></span> <span class="free"><span class="bound"><span class="entity">v9</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">z</span></span></span><span class="main">]</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">ar11</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">v0</span></span></span> <span class="free"><span class="bound"><span class="entity">f1</span></span></span> <span class="free"><span class="bound"><span class="entity">f2</span></span></span> <span class="free"><span class="bound"><span class="entity">f3</span></span></span> <span class="free"><span class="bound"><span class="entity">f4</span></span></span> <span class="free"><span class="bound"><span class="entity">f5</span></span></span> <span class="free"><span class="bound"><span class="entity">f6</span></span></span> <span class="free"><span class="bound"><span class="entity">f7</span></span></span> <span class="free"><span class="bound"><span class="entity">f8</span></span></span> <span class="free"><span class="bound"><span class="entity">f9</span></span></span> <span class="free"><span class="bound"><span class="entity">f10</span></span></span> <span class="free"><span class="bound"><span class="entity">v1</span></span></span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span> <span class="free"><span class="bound"><span class="entity">v3</span></span></span> <span class="free"><span class="bound"><span class="entity">v4</span></span></span> <span class="free"><span class="bound"><span class="entity">v5</span></span></span> <span class="free"><span class="bound"><span class="entity">v6</span></span></span> <span class="free"><span class="bound"><span class="entity">v7</span></span></span> <span class="free"><span class="bound"><span class="entity">v8</span></span></span> <span class="free"><span class="bound"><span class="entity">v9</span></span></span> <span class="free"><span class="bound"><span class="entity">v10</span></span></span> <span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">v0</span></span></span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">f1</span></span></span> <span class="free"><span class="bound"><span class="entity">v1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f2</span></span></span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f3</span></span></span> <span class="free"><span class="bound"><span class="entity">v3</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f4</span></span></span> <span class="free"><span class="bound"><span class="entity">v4</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f5</span></span></span> <span class="free"><span class="bound"><span class="entity">v5</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f6</span></span></span> <span class="free"><span class="bound"><span class="entity">v6</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f7</span></span></span> <span class="free"><span class="bound"><span class="entity">v7</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f8</span></span></span> <span class="free"><span class="bound"><span class="entity">v8</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f9</span></span></span> <span class="free"><span class="bound"><span class="entity">v9</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f10</span></span></span> <span class="free"><span class="bound"><span class="entity">v10</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">z</span></span></span><span class="main">]</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">ar12</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">v0</span></span></span> <span class="free"><span class="bound"><span class="entity">f1</span></span></span> <span class="free"><span class="bound"><span class="entity">f2</span></span></span> <span class="free"><span class="bound"><span class="entity">f3</span></span></span> <span class="free"><span class="bound"><span class="entity">f4</span></span></span> <span class="free"><span class="bound"><span class="entity">f5</span></span></span> <span class="free"><span class="bound"><span class="entity">f6</span></span></span> <span class="free"><span class="bound"><span class="entity">f7</span></span></span> <span class="free"><span class="bound"><span class="entity">f8</span></span></span> <span class="free"><span class="bound"><span class="entity">f9</span></span></span> <span class="free"><span class="bound"><span class="entity">f10</span></span></span> <span class="free"><span class="bound"><span class="entity">f11</span></span></span> <span class="free"><span class="bound"><span class="entity">v1</span></span></span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span> <span class="free"><span class="bound"><span class="entity">v3</span></span></span> <span class="free"><span class="bound"><span class="entity">v4</span></span></span> <span class="free"><span class="bound"><span class="entity">v5</span></span></span> <span class="free"><span class="bound"><span class="entity">v6</span></span></span> <span class="free"><span class="bound"><span class="entity">v7</span></span></span> <span class="free"><span class="bound"><span class="entity">v8</span></span></span> <span class="free"><span class="bound"><span class="entity">v9</span></span></span> <span class="free"><span class="bound"><span class="entity">v10</span></span></span> <span class="free"><span class="bound"><span class="entity">v11</span></span></span> <span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">v0</span></span></span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">f1</span></span></span> <span class="free"><span class="bound"><span class="entity">v1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f2</span></span></span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f3</span></span></span> <span class="free"><span class="bound"><span class="entity">v3</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f4</span></span></span> <span class="free"><span class="bound"><span class="entity">v4</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f5</span></span></span> <span class="free"><span class="bound"><span class="entity">v5</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f6</span></span></span> <span class="free"><span class="bound"><span class="entity">v6</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f7</span></span></span> <span class="free"><span class="bound"><span class="entity">v7</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f8</span></span></span> <span class="free"><span class="bound"><span class="entity">v8</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f9</span></span></span> <span class="free"><span class="bound"><span class="entity">v9</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f10</span></span></span> <span class="free"><span class="bound"><span class="entity">v10</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f11</span></span></span> <span class="free"><span class="bound"><span class="entity">v11</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">z</span></span></span><span class="main">]</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">ar13</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">v0</span></span></span> <span class="free"><span class="bound"><span class="entity">f1</span></span></span> <span class="free"><span class="bound"><span class="entity">f2</span></span></span> <span class="free"><span class="bound"><span class="entity">f3</span></span></span> <span class="free"><span class="bound"><span class="entity">f4</span></span></span> <span class="free"><span class="bound"><span class="entity">f5</span></span></span> <span class="free"><span class="bound"><span class="entity">f6</span></span></span> <span class="free"><span class="bound"><span class="entity">f7</span></span></span> <span class="free"><span class="bound"><span class="entity">f8</span></span></span> <span class="free"><span class="bound"><span class="entity">f9</span></span></span> <span class="free"><span class="bound"><span class="entity">f10</span></span></span> <span class="free"><span class="bound"><span class="entity">f11</span></span></span> <span class="free"><span class="bound"><span class="entity">f12</span></span></span> <span class="free"><span class="bound"><span class="entity">v1</span></span></span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span> <span class="free"><span class="bound"><span class="entity">v3</span></span></span> <span class="free"><span class="bound"><span class="entity">v4</span></span></span> <span class="free"><span class="bound"><span class="entity">v5</span></span></span> <span class="free"><span class="bound"><span class="entity">v6</span></span></span> <span class="free"><span class="bound"><span class="entity">v7</span></span></span> <span class="free"><span class="bound"><span class="entity">v8</span></span></span> <span class="free"><span class="bound"><span class="entity">v9</span></span></span> <span class="free"><span class="bound"><span class="entity">v10</span></span></span> <span class="free"><span class="bound"><span class="entity">v11</span></span></span> <span class="free"><span class="bound"><span class="entity">v12</span></span></span> <span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">v0</span></span></span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">f1</span></span></span> <span class="free"><span class="bound"><span class="entity">v1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f2</span></span></span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f3</span></span></span> <span class="free"><span class="bound"><span class="entity">v3</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f4</span></span></span> <span class="free"><span class="bound"><span class="entity">v4</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f5</span></span></span> <span class="free"><span class="bound"><span class="entity">v5</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f6</span></span></span> <span class="free"><span class="bound"><span class="entity">v6</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f7</span></span></span> <span class="free"><span class="bound"><span class="entity">v7</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f8</span></span></span> <span class="free"><span class="bound"><span class="entity">v8</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f9</span></span></span> <span class="free"><span class="bound"><span class="entity">v9</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f10</span></span></span> <span class="free"><span class="bound"><span class="entity">v10</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f11</span></span></span> <span class="free"><span class="bound"><span class="entity">v11</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f12</span></span></span> <span class="free"><span class="bound"><span class="entity">v12</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">z</span></span></span><span class="main">]</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">ar14</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">v0</span></span></span> <span class="free"><span class="bound"><span class="entity">f1</span></span></span> <span class="free"><span class="bound"><span class="entity">f2</span></span></span> <span class="free"><span class="bound"><span class="entity">f3</span></span></span> <span class="free"><span class="bound"><span class="entity">f4</span></span></span> <span class="free"><span class="bound"><span class="entity">f5</span></span></span> <span class="free"><span class="bound"><span class="entity">f6</span></span></span> <span class="free"><span class="bound"><span class="entity">f7</span></span></span> <span class="free"><span class="bound"><span class="entity">f8</span></span></span> <span class="free"><span class="bound"><span class="entity">f9</span></span></span> <span class="free"><span class="bound"><span class="entity">f10</span></span></span> <span class="free"><span class="bound"><span class="entity">f11</span></span></span> <span class="free"><span class="bound"><span class="entity">f12</span></span></span> <span class="free"><span class="bound"><span class="entity">f13</span></span></span> <span class="free"><span class="bound"><span class="entity">v1</span></span></span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span> <span class="free"><span class="bound"><span class="entity">v3</span></span></span> <span class="free"><span class="bound"><span class="entity">v4</span></span></span> <span class="free"><span class="bound"><span class="entity">v5</span></span></span> <span class="free"><span class="bound"><span class="entity">v6</span></span></span> <span class="free"><span class="bound"><span class="entity">v7</span></span></span> <span class="free"><span class="bound"><span class="entity">v8</span></span></span> <span class="free"><span class="bound"><span class="entity">v9</span></span></span> <span class="free"><span class="bound"><span class="entity">v10</span></span></span> <span class="free"><span class="bound"><span class="entity">v11</span></span></span> <span class="free"><span class="bound"><span class="entity">v12</span></span></span> <span class="free"><span class="bound"><span class="entity">v13</span></span></span> <span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">v0</span></span></span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">f1</span></span></span> <span class="free"><span class="bound"><span class="entity">v1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f2</span></span></span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f3</span></span></span> <span class="free"><span class="bound"><span class="entity">v3</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f4</span></span></span> <span class="free"><span class="bound"><span class="entity">v4</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f5</span></span></span> <span class="free"><span class="bound"><span class="entity">v5</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f6</span></span></span> <span class="free"><span class="bound"><span class="entity">v6</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f7</span></span></span> <span class="free"><span class="bound"><span class="entity">v7</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f8</span></span></span> <span class="free"><span class="bound"><span class="entity">v8</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f9</span></span></span> <span class="free"><span class="bound"><span class="entity">v9</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f10</span></span></span> <span class="free"><span class="bound"><span class="entity">v10</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f11</span></span></span> <span class="free"><span class="bound"><span class="entity">v11</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f12</span></span></span> <span class="free"><span class="bound"><span class="entity">v12</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f13</span></span></span> <span class="free"><span class="bound"><span class="entity">v13</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">z</span></span></span><span class="main">]</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">ar15</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">v0</span></span></span> <span class="free"><span class="bound"><span class="entity">f1</span></span></span> <span class="free"><span class="bound"><span class="entity">f2</span></span></span> <span class="free"><span class="bound"><span class="entity">f3</span></span></span> <span class="free"><span class="bound"><span class="entity">f4</span></span></span> <span class="free"><span class="bound"><span class="entity">f5</span></span></span> <span class="free"><span class="bound"><span class="entity">f6</span></span></span> <span class="free"><span class="bound"><span class="entity">f7</span></span></span> <span class="free"><span class="bound"><span class="entity">f8</span></span></span> <span class="free"><span class="bound"><span class="entity">f9</span></span></span> <span class="free"><span class="bound"><span class="entity">f10</span></span></span> <span class="free"><span class="bound"><span class="entity">f11</span></span></span> <span class="free"><span class="bound"><span class="entity">f12</span></span></span> <span class="free"><span class="bound"><span class="entity">f13</span></span></span> <span class="free"><span class="bound"><span class="entity">f14</span></span></span> <span class="free"><span class="bound"><span class="entity">v1</span></span></span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span> <span class="free"><span class="bound"><span class="entity">v3</span></span></span> <span class="free"><span class="bound"><span class="entity">v4</span></span></span> <span class="free"><span class="bound"><span class="entity">v5</span></span></span> <span class="free"><span class="bound"><span class="entity">v6</span></span></span> <span class="free"><span class="bound"><span class="entity">v7</span></span></span> <span class="free"><span class="bound"><span class="entity">v8</span></span></span> <span class="free"><span class="bound"><span class="entity">v9</span></span></span> <span class="free"><span class="bound"><span class="entity">v10</span></span></span> <span class="free"><span class="bound"><span class="entity">v11</span></span></span> <span class="free"><span class="bound"><span class="entity">v12</span></span></span> <span class="free"><span class="bound"><span class="entity">v13</span></span></span> <span class="free"><span class="bound"><span class="entity">v14</span></span></span> <span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">v0</span></span></span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">f1</span></span></span> <span class="free"><span class="bound"><span class="entity">v1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f2</span></span></span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f3</span></span></span> <span class="free"><span class="bound"><span class="entity">v3</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f4</span></span></span> <span class="free"><span class="bound"><span class="entity">v4</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f5</span></span></span> <span class="free"><span class="bound"><span class="entity">v5</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f6</span></span></span> <span class="free"><span class="bound"><span class="entity">v6</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f7</span></span></span> <span class="free"><span class="bound"><span class="entity">v7</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f8</span></span></span> <span class="free"><span class="bound"><span class="entity">v8</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f9</span></span></span> <span class="free"><span class="bound"><span class="entity">v9</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f10</span></span></span> <span class="free"><span class="bound"><span class="entity">v10</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f11</span></span></span> <span class="free"><span class="bound"><span class="entity">v11</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f12</span></span></span> <span class="free"><span class="bound"><span class="entity">v12</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f13</span></span></span> <span class="free"><span class="bound"><span class="entity">v13</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f14</span></span></span> <span class="free"><span class="bound"><span class="entity">v14</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">z</span></span></span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Generic Locale for Parsing›</span></span>

<span class="keyword1"><span class="command">locale</span></span> Parse <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">ext</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="keyword1">string</span> <span class="main">⇒</span> <span class="keyword1">string</span>"</span></span>

  <span class="comment1">― ‹(effective) first order›</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">of_string</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="keyword1">string</span> <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">⇒</span> <span class="keyword1">string</span> <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">of_string<span class="hidden">⇩</span><sub>b</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>e</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="keyword1">string</span> <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">⇒</span> string<span class="hidden">⇩</span><sub>b</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>e</sub> <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">of_nat</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="keyword1">string</span> <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">⇒</span> natural <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">of_unit</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">string</span> <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">⇒</span> unit <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">of_bool</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">string</span> <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">⇒</span> bool <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span>

  <span class="comment1">― ‹(simulation) higher order›</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">Of_Pair</span> <span class="free">Of_Nil</span> <span class="free">Of_Cons</span> <span class="free">Of_None</span> <span class="free">Of_Some</span> <span class="main">::</span> <span class="quoted"><span class="keyword1">string</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">of_pair</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">f1</span></span></span> <span class="free"><span class="bound"><span class="entity">f2</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">f</span><span class="main">.</span> <span class="main">λ</span><span class="main">(</span><span class="bound">c</span><span class="main">,</span> <span class="bound">d</span><span class="main">)</span> <span class="main">⇒</span> <span class="bound">f</span> <span class="bound">c</span> <span class="bound">d</span><span class="main">)</span>
  <span class="main">(</span>ap2 <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free">Of_Pair</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">f1</span></span></span> <span class="free"><span class="bound"><span class="entity">f2</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">of_list</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">f0</span><span class="main">.</span> rec_list <span class="bound">f0</span> <span class="keyword1">o</span> co1 K<span class="main">)</span>
  <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free">Of_Nil</span><span class="main">)</span>
  <span class="main">(</span>ar2 <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free">Of_Cons</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">of_option</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> rec_option
  <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free">Of_None</span><span class="main">)</span>
  <span class="main">(</span>ap1 <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free">Of_Some</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">code</span><span class="main">]</span> <span class="main">=</span>
  Parse.of_pair_def
  Parse.of_list_def
  Parse.of_option_def

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹
This theory and all the deriving one could
also be prefixed by ``print'' instead of ``parse''. 
In any case, we are converting (or printing) the above datatypes to another format, 
and finally this format will be ``parsed'' by Isabelle!›</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Parser_Pure">
<div class="head">
<h1>Theory Parser_Pure</h1>
</div>
<pre class="source"><span class="comment1">(******************************************************************************
 * A Meta-Model for the Isabelle API
 *
 * Copyright (c) 2011-2018 Université Paris-Saclay, Univ. Paris-Sud, France
 *               2013-2017 IRT SystemX, France
 *               2011-2015 Achim D. Brucker, Germany
 *               2016-2018 The University of Sheffield, UK
 *               2016-2017 Nanyang Technological University, Singapore
 *               2017-2018 Virginia Tech, USA
 *
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are
 * met:
 *
 *     * Redistributions of source code must retain the above copyright
 *       notice, this list of conditions and the following disclaimer.
 *
 *     * Redistributions in binary form must reproduce the above
 *       copyright notice, this list of conditions and the following
 *       disclaimer in the documentation and/or other materials provided
 *       with the distribution.
 *
 *     * Neither the name of the copyright holders nor the names of its
 *       contributors may be used to endorse or promote products derived
 *       from this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 ******************************************************************************)</span>

<span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹Instantiating the Parser of (Pure) Term›</span></span>

<span class="keyword1"><span class="command">theory</span></span>  Parser_Pure
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Meta_Pure.html">Meta_Pure</a>
        <a href="Parser_init.html">Parser_init</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Main›</span></span>

<span class="keyword1"><span class="command">context</span></span> Parse
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">of_pure_indexname</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">=</span> of_pair <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span><span class="free">of_string</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">of_nat</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">of_pure_class</span> <span class="main">=</span> <span class="free">of_string</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">of_pure_sort</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">=</span> of_list <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span>of_pure_class <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">of_pure_typ</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">=</span> rec_typ
  <span class="main">(</span>ap2 <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="inner_cartouche">‹Type›</span><span class="main">)</span> <span class="main">(</span><span class="free">of_string</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">(</span>of_list <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> snd<span class="main">)</span><span class="main">)</span>
  <span class="main">(</span>ap2 <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="inner_cartouche">‹TFree›</span><span class="main">)</span> <span class="main">(</span><span class="free">of_string</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">(</span>of_pure_sort <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span><span class="main">)</span>
  <span class="main">(</span>ap2 <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="inner_cartouche">‹TVar›</span><span class="main">)</span> <span class="main">(</span>of_pure_indexname <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">(</span>of_pure_sort <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">of_pure_term</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">f0</span> <span class="bound">f1</span> <span class="bound">f2</span> <span class="bound">f3</span> <span class="bound">f4</span> <span class="bound">f5</span><span class="main">.</span> rec_term <span class="bound">f0</span> <span class="bound">f1</span> <span class="bound">f2</span> <span class="bound">f3</span> <span class="main">(</span>co2 K <span class="bound">f4</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="bound">f5</span><span class="main">)</span><span class="main">)</span>
  <span class="main">(</span>ap2 <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="inner_cartouche">‹Const›</span><span class="main">)</span> <span class="main">(</span><span class="free">of_string</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">(</span>of_pure_typ <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span><span class="main">)</span>
  <span class="main">(</span>ap2 <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="inner_cartouche">‹Free›</span><span class="main">)</span> <span class="main">(</span><span class="free">of_string</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">(</span>of_pure_typ <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span><span class="main">)</span>
  <span class="main">(</span>ap2 <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="inner_cartouche">‹Var›</span><span class="main">)</span> <span class="main">(</span>of_pure_indexname <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">(</span>of_pure_typ <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span><span class="main">)</span>
  <span class="main">(</span>ap1 <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="inner_cartouche">‹Bound›</span><span class="main">)</span> <span class="main">(</span><span class="free">of_nat</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span><span class="main">)</span>
  <span class="main">(</span>ar3 <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="inner_cartouche">‹Abs›</span><span class="main">)</span> <span class="main">(</span><span class="free">of_string</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">(</span>of_pure_typ <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span><span class="main">)</span>
  <span class="main">(</span>ar2 <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="inner_cartouche">‹App›</span><span class="main">)</span> id<span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">code</span><span class="main">]</span> <span class="main">=</span>
  Parse.of_pure_indexname_def
  Parse.of_pure_class_def
  Parse.of_pure_sort_def
  Parse.of_pure_typ_def
  Parse.of_pure_term_def

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Meta_SML">
<div class="head">
<h1>Theory Meta_SML</h1>
</div>
<pre class="source"><span class="comment1">(******************************************************************************
 * A Meta-Model for the Isabelle API
 *
 * Copyright (c) 2011-2018 Université Paris-Saclay, Univ. Paris-Sud, France
 *               2013-2017 IRT SystemX, France
 *               2011-2015 Achim D. Brucker, Germany
 *               2016-2018 The University of Sheffield, UK
 *               2016-2017 Nanyang Technological University, Singapore
 *               2017-2018 Virginia Tech, USA
 *
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are
 * met:
 *
 *     * Redistributions of source code must retain the above copyright
 *       notice, this list of conditions and the following disclaimer.
 *
 *     * Redistributions in binary form must reproduce the above
 *       copyright notice, this list of conditions and the following
 *       disclaimer in the documentation and/or other materials provided
 *       with the distribution.
 *
 *     * Neither the name of the copyright holders nor the names of its
 *       contributors may be used to endorse or promote products derived
 *       from this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 ******************************************************************************)</span>

<span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹SML Meta-Model aka. AST definition of SML›</span></span>

<span class="keyword1"><span class="command">theory</span></span>  Meta_SML
<span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="Init.html">../Init</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Type Definition›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The following datatypes beginning with \verb|semi__| represent semi-concrete syntax,
       deliberately not minimal abstract syntax like (Pure) Term,
       this is for example to facilitate the pretty-printing process,
       or for manipulating recursively data-structures through an abstract and typed API.›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> semi__val_fun <span class="main">=</span> Sval
                       <span class="main">|</span> Sfun

<span class="keyword1"><span class="command">datatype</span></span> semi__term' <span class="main">=</span> SML_string <span class="quoted"><span class="keyword1">string</span></span>
                     <span class="main">|</span> SML_rewrite <span class="quoted">semi__val_fun</span> <span class="quoted">semi__term'</span> <span class="comment1">― ‹left›</span> <span class="quoted"><span class="keyword1">string</span></span> <span class="comment1">― ‹symb rewriting›</span> <span class="quoted">semi__term'</span> <span class="comment1">― ‹right›</span>
                     <span class="main">|</span> SML_basic <span class="quoted"><span class="quoted">"<span class="keyword1">string</span> list"</span></span>
                     <span class="main">|</span> SML_binop <span class="quoted">semi__term'</span> <span class="quoted"><span class="keyword1">string</span></span> <span class="quoted">semi__term'</span>
                     <span class="main">|</span> SML_annot <span class="quoted">semi__term'</span> <span class="quoted"><span class="keyword1">string</span></span> <span class="comment1">― ‹type›</span>
                     <span class="main">|</span> SML_function <span class="quoted"><span class="quoted">"<span class="main">(</span>semi__term' <span class="comment1">― ‹pattern›</span> <span class="main">×</span> semi__term' <span class="comment1">― ‹to return›</span><span class="main">)</span> list"</span></span>
                     <span class="main">|</span> SML_apply <span class="quoted">semi__term'</span> <span class="quoted"><span class="quoted">"semi__term' list"</span></span>
                     <span class="main">|</span> SML_paren <span class="quoted"><span class="keyword1">string</span></span> <span class="comment1">― ‹left›</span> <span class="quoted"><span class="keyword1">string</span></span> <span class="comment1">― ‹right›</span> <span class="quoted">semi__term'</span>
                     <span class="main">|</span> SML_let_open <span class="quoted"><span class="keyword1">string</span></span> <span class="quoted">semi__term'</span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Extending the Meta-Model›</span></span>

<span class="keyword1"><span class="command">locale</span></span> SML
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">no_type_notation</span></span> abr_string <span class="main">(</span><span class="quoted">"<span class="keyword1">string</span>"</span><span class="main">)</span> <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">string</span> <span class="main">=</span> SML_string"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">rewrite</span> <span class="main">=</span> SML_rewrite"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">basic</span> <span class="main">=</span> SML_basic"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">binop</span> <span class="main">=</span> SML_binop"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">annot</span> <span class="main">=</span> SML_annot"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">function</span> <span class="main">=</span> SML_function"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">apply</span> <span class="main">=</span> SML_apply"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">paren</span> <span class="main">=</span> SML_paren"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">let_open</span> <span class="main">=</span> SML_let_open"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">app</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> apply <span class="main">(</span>basic <span class="main">[</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">]</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">none</span> <span class="main">=</span> basic <span class="main">[</span><span class="inner_cartouche">‹NONE›</span><span class="main">]</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">some</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> app <span class="inner_cartouche">‹SOME›</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">]</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">option'</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> map_option <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="keyword1">of</span> None <span class="main">⇒</span> none <span class="main">|</span> Some <span class="bound">s</span> <span class="main">⇒</span> some <span class="bound">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">option</span> <span class="main">=</span> option' id"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">parenthesis</span> <span class="comment1">― ‹mandatory parenthesis›</span> <span class="main">=</span> paren <span class="inner_cartouche">‹(›</span> <span class="inner_cartouche">‹)›</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">binop_l</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> rev <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="keyword1">of</span> <span class="bound">x</span> <span class="main">#</span> <span class="bound">xs</span> <span class="main">⇒</span> List.fold <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> binop <span class="bound">x</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="bound">xs</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">list</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="keyword1">of</span> <span class="main">[]</span> <span class="main">⇒</span> basic <span class="main">[</span><span class="inner_cartouche">‹[]›</span><span class="main">]</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> paren <span class="inner_cartouche">‹[›</span> <span class="inner_cartouche">‹]›</span> <span class="main">(</span>binop_l <span class="inner_cartouche">‹,›</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">list'</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span> list <span class="main">(</span>L.map <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">pair</span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="main">=</span> parenthesis <span class="main">(</span>binop <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="inner_cartouche">‹,›</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">pair'</span> <span class="free"><span class="bound"><span class="entity">f1</span></span></span> <span class="free"><span class="bound"><span class="entity">f2</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">e1</span><span class="main">,</span> <span class="bound">e2</span><span class="main">)</span> <span class="main">⇒</span> parenthesis <span class="main">(</span>binop <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f1</span></span></span> <span class="bound">e1</span><span class="main">)</span> <span class="inner_cartouche">‹,›</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f2</span></span></span> <span class="bound">e2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">rewrite_val</span> <span class="main">=</span> rewrite Sval"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">rewrite_fun</span> <span class="main">=</span> rewrite Sfun"</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">code</span><span class="main">]</span> <span class="main">=</span>
  <span class="comment1">― ‹def›</span>
  SML.string_def
  SML.rewrite_def
  SML.basic_def
  SML.binop_def
  SML.annot_def
  SML.function_def
  SML.apply_def
  SML.paren_def
  SML.let_open_def
  SML.app_def
  SML.none_def
  SML.some_def
  SML.option'_def
  SML.option_def
  SML.parenthesis_def
  SML.binop_l_def
  SML.list_def
  SML.list'_def
  SML.pair_def
  SML.pair'_def
  SML.rewrite_val_def
  SML.rewrite_fun_def

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Meta_Isabelle">
<div class="head">
<h1>Theory Meta_Isabelle</h1>
</div>
<pre class="source"><span class="comment1">(******************************************************************************
 * A Meta-Model for the Isabelle API
 *
 * Copyright (c) 2011-2018 Université Paris-Saclay, Univ. Paris-Sud, France
 *               2013-2017 IRT SystemX, France
 *               2011-2015 Achim D. Brucker, Germany
 *               2016-2018 The University of Sheffield, UK
 *               2016-2017 Nanyang Technological University, Singapore
 *               2017-2018 Virginia Tech, USA
 *
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are
 * met:
 *
 *     * Redistributions of source code must retain the above copyright
 *       notice, this list of conditions and the following disclaimer.
 *
 *     * Redistributions in binary form must reproduce the above
 *       copyright notice, this list of conditions and the following
 *       disclaimer in the documentation and/or other materials provided
 *       with the distribution.
 *
 *     * Neither the name of the copyright holders nor the names of its
 *       contributors may be used to endorse or promote products derived
 *       from this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 ******************************************************************************)</span>

<span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹Isabelle Meta-Model aka. AST definition of Isabelle›</span></span>

<span class="keyword1"><span class="command">theory</span></span>  Meta_Isabelle
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Meta_Pure.html">Meta_Pure</a>
        <a href="Meta_SML.html">Meta_SML</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Type Definition›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The following datatypes beginning with \verb|semi__| represent semi-concrete syntax,
       deliberately not minimal abstract syntax like (Pure) Term,
       this is for example to facilitate the pretty-printing process,
       or for manipulating recursively data-structures through an abstract and typed API.›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> semi__typ <span class="main">=</span> Typ_apply <span class="quoted">semi__typ</span> <span class="quoted"><span class="quoted">"semi__typ list"</span></span>
                   <span class="main">|</span> Typ_apply_bin <span class="quoted"><span class="keyword1">string</span></span> <span class="comment1">― ‹binop›</span> <span class="quoted">semi__typ</span> <span class="quoted">semi__typ</span>
                   <span class="main">|</span> Typ_apply_paren <span class="quoted"><span class="keyword1">string</span></span> <span class="comment1">― ‹left›</span> <span class="quoted"><span class="keyword1">string</span></span> <span class="comment1">― ‹right›</span> <span class="quoted">semi__typ</span>
                   <span class="main">|</span> Typ_base <span class="quoted"><span class="keyword1">string</span></span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="quoted">"datatype"</span> <span class="main">=</span> Datatype <span class="quoted"><span class="keyword1">string</span></span> <span class="comment1">― ‹name›</span>
                               <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">string</span> <span class="comment1">― ‹name›</span> <span class="main">×</span> semi__typ list <span class="comment1">― ‹arguments›</span><span class="main">)</span> list"</span></span> <span class="comment1">― ‹constructors›</span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="quoted">"type_synonym"</span> <span class="main">=</span> Type_synonym <span class="quoted"><span class="keyword1">string</span></span> <span class="comment1">― ‹name›</span>
                                       <span class="quoted"><span class="quoted">"<span class="keyword1">string</span> list"</span></span> <span class="comment1">― ‹parametric variables›</span>
                                       <span class="quoted">semi__typ</span> <span class="comment1">― ‹content›</span>

<span class="keyword1"><span class="command">datatype</span></span> semi__term <span class="main">=</span> Term_rewrite <span class="quoted">semi__term</span> <span class="comment1">― ‹left›</span> <span class="quoted"><span class="keyword1">string</span></span> <span class="comment1">― ‹symb rewriting›</span> <span class="quoted">semi__term</span> <span class="comment1">― ‹right›</span>
                    <span class="main">|</span> Term_basic <span class="quoted"><span class="quoted">"<span class="keyword1">string</span> list"</span></span>
                    <span class="main">|</span> Term_annot <span class="quoted">semi__term</span> <span class="quoted">semi__typ</span>
                    <span class="main">|</span> Term_bind <span class="quoted"><span class="keyword1">string</span></span> <span class="comment1">― ‹symbol›</span> <span class="quoted">semi__term</span> <span class="comment1">― ‹arg›</span> <span class="quoted">semi__term</span>
                    <span class="main">|</span> Term_fun_case <span class="quoted"><span class="quoted">"semi__term <span class="comment1">― ‹value›</span> option"</span></span> <span class="comment1">― ‹none: function›</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>semi__term <span class="comment1">― ‹pattern›</span> <span class="main">×</span> semi__term <span class="comment1">― ‹to return›</span><span class="main">)</span> list"</span></span>
                    <span class="main">|</span> Term_apply <span class="quoted">semi__term</span> <span class="quoted"><span class="quoted">"semi__term list"</span></span>
                    <span class="main">|</span> Term_paren <span class="quoted"><span class="keyword1">string</span></span> <span class="comment1">― ‹left›</span> <span class="quoted"><span class="keyword1">string</span></span> <span class="comment1">― ‹right›</span> <span class="quoted">semi__term</span>
                    <span class="main">|</span> Term_if_then_else <span class="quoted">semi__term</span> <span class="quoted">semi__term</span> <span class="quoted">semi__term</span>
                    <span class="main">|</span> Term_term <span class="quoted"><span class="quoted">"<span class="keyword1">string</span> list"</span></span> <span class="comment1">― ‹simulate a pre-initialized context (de bruijn variables under "lam")›</span>
                                <span class="quoted"><span class="quoted">"term"</span></span> <span class="comment1">― ‹usual continuation of inner syntax term›</span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="quoted">"type_notation"</span> <span class="main">=</span> Type_notation <span class="quoted"><span class="keyword1">string</span></span> <span class="comment1">― ‹name›</span>
                                         <span class="quoted"><span class="keyword1">string</span></span> <span class="comment1">― ‹content›</span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="quoted">"instantiation"</span> <span class="main">=</span> Instantiation <span class="quoted"><span class="keyword1">string</span></span> <span class="comment1">― ‹name›</span>
                                         <span class="quoted"><span class="keyword1">string</span></span> <span class="comment1">― ‹name in definition›</span>
                                         <span class="quoted">semi__term</span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="quoted">"overloading"</span> <span class="main">=</span> Overloading <span class="quoted"><span class="keyword1">string</span></span> <span class="comment1">― ‹name consts›</span> <span class="quoted">semi__term</span>
                                     <span class="quoted"><span class="keyword1">string</span></span> <span class="comment1">― ‹name def›</span> <span class="quoted">semi__term</span> <span class="comment1">― ‹content›</span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="quoted">"consts"</span> <span class="main">=</span> Consts <span class="quoted"><span class="keyword1">string</span></span> <span class="comment1">― ‹name›</span>
                           <span class="quoted">semi__typ</span>
                           <span class="quoted"><span class="keyword1">string</span></span> <span class="comment1">― ‹expression in 'post' mixfix›</span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="quoted">"definition"</span> <span class="main">=</span> Definition <span class="quoted">semi__term</span>
                      <span class="main">|</span> Definition_where1 <span class="quoted"><span class="keyword1">string</span></span> <span class="comment1">― ‹name›</span> <span class="quoted"><span class="quoted">"semi__term <span class="comment1">― ‹syntax extension›</span> <span class="main">×</span> <span class="keyword1">nat</span> <span class="comment1">― ‹priority›</span>"</span></span> <span class="quoted">semi__term</span>
                      <span class="main">|</span> Definition_where2 <span class="quoted"><span class="keyword1">string</span></span> <span class="comment1">― ‹name›</span> <span class="quoted">semi__term</span> <span class="comment1">― ‹syntax extension›</span> <span class="quoted">semi__term</span>

<span class="keyword1"><span class="command">datatype</span></span> semi__thm_attribute <span class="main">=</span> Thm_thm <span class="quoted"><span class="keyword1">string</span></span> <span class="comment1">― ‹represents a single thm›</span>
                             <span class="main">|</span> Thm_thms <span class="quoted"><span class="keyword1">string</span></span> <span class="comment1">― ‹represents several thms›</span>
                             <span class="main">|</span> Thm_THEN <span class="quoted">semi__thm_attribute</span> <span class="quoted">semi__thm_attribute</span>
                             <span class="main">|</span> Thm_simplified <span class="quoted">semi__thm_attribute</span> <span class="quoted">semi__thm_attribute</span>
                             <span class="main">|</span> Thm_symmetric <span class="quoted">semi__thm_attribute</span>
                             <span class="main">|</span> Thm_where <span class="quoted">semi__thm_attribute</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">string</span> <span class="main">×</span> semi__term<span class="main">)</span> list"</span></span>
                             <span class="main">|</span> Thm_of <span class="quoted">semi__thm_attribute</span> <span class="quoted"><span class="quoted">"semi__term list"</span></span>
                             <span class="main">|</span> Thm_OF <span class="quoted">semi__thm_attribute</span> <span class="quoted">semi__thm_attribute</span>

<span class="keyword1"><span class="command">datatype</span></span> semi__thm <span class="main">=</span> Thms_single <span class="quoted">semi__thm_attribute</span>
                   <span class="main">|</span> Thms_mult <span class="quoted">semi__thm_attribute</span>

<span class="keyword1"><span class="command">type_synonym</span></span> semi__thm_l <span class="main">=</span> <span class="quoted"><span class="quoted">"semi__thm list"</span></span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="quoted">"lemmas"</span> <span class="main">=</span> Lemmas_simp_thm <span class="quoted">bool</span> <span class="comment1">― ‹True : simp›</span>
                                    <span class="quoted"><span class="keyword1">string</span></span> <span class="comment1">― ‹name›</span>
                                    <span class="quoted"><span class="quoted">"semi__thm_attribute list"</span></span>
                  <span class="main">|</span> Lemmas_simp_thms <span class="quoted"><span class="keyword1">string</span></span> <span class="comment1">― ‹name›</span>
                                     <span class="quoted"><span class="quoted">"<span class="keyword1">string</span> <span class="comment1">― ‹thms›</span> list"</span></span>

<span class="keyword1"><span class="command">datatype</span></span> semi__method_simp <span class="main">=</span> Method_simp_only <span class="quoted">semi__thm_l</span>
                           <span class="main">|</span> Method_simp_add_del_split <span class="quoted">semi__thm_l</span> <span class="comment1">― ‹add›</span> <span class="quoted">semi__thm_l</span> <span class="comment1">― ‹del›</span> <span class="quoted">semi__thm_l</span> <span class="comment1">― ‹split›</span>

<span class="keyword1"><span class="command">datatype</span></span> semi__method <span class="main">=</span> Method_rule <span class="quoted"><span class="quoted">"semi__thm_attribute option"</span></span>
                      <span class="main">|</span> Method_drule <span class="quoted">semi__thm_attribute</span>
                      <span class="main">|</span> Method_erule <span class="quoted">semi__thm_attribute</span>
                      <span class="main">|</span> Method_intro <span class="quoted"><span class="quoted">"semi__thm_attribute list"</span></span>
                      <span class="main">|</span> Method_elim <span class="quoted">semi__thm_attribute</span>
                      <span class="main">|</span> Method_subst <span class="quoted">bool</span> <span class="comment1">― ‹asm›</span>
                                     <span class="quoted"><span class="quoted">"<span class="keyword1">string</span> <span class="comment1">― ‹nat›</span> list"</span></span> <span class="comment1">― ‹pos›</span>
                                     <span class="quoted">semi__thm_attribute</span>
                      <span class="main">|</span> Method_insert <span class="quoted">semi__thm_l</span>
                      <span class="main">|</span> Method_plus <span class="quoted"><span class="quoted">"semi__method list"</span></span>
                      <span class="main">|</span> Method_option <span class="quoted"><span class="quoted">"semi__method list"</span></span>
                      <span class="main">|</span> Method_or <span class="quoted"><span class="quoted">"semi__method list"</span></span>
                      <span class="main">|</span> Method_one <span class="quoted">semi__method_simp</span>
                      <span class="main">|</span> Method_all <span class="quoted">semi__method_simp</span>
                      <span class="main">|</span> Method_auto_simp_add_split <span class="quoted">semi__thm_l</span> <span class="quoted"><span class="quoted">"<span class="keyword1">string</span> list"</span></span>
                      <span class="main">|</span> Method_rename_tac <span class="quoted"><span class="quoted">"<span class="keyword1">string</span> list"</span></span>
                      <span class="main">|</span> Method_case_tac <span class="quoted">semi__term</span>
                      <span class="main">|</span> Method_blast <span class="quoted"><span class="quoted">"<span class="keyword1">nat</span> option"</span></span>
                      <span class="main">|</span> Method_clarify
                      <span class="main">|</span> Method_metis <span class="quoted"><span class="quoted">"<span class="keyword1">string</span> list"</span></span> <span class="comment1">― ‹e.g. <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>no_types›</span></span> (<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>override_type_encs›</span></span>)›</span>
                                     <span class="quoted"><span class="quoted">"semi__thm_attribute list"</span></span>

<span class="keyword1"><span class="command">datatype</span></span> semi__command_final <span class="main">=</span> Command_done
                             <span class="main">|</span> Command_by <span class="quoted"><span class="quoted">"semi__method list"</span></span>
                             <span class="main">|</span> Command_sorry

<span class="keyword1"><span class="command">datatype</span></span> semi__command_state <span class="main">=</span> Command_apply_end <span class="quoted"><span class="quoted">"semi__method list"</span></span> <span class="comment1">― ‹<span class="antiquoted"><span class="operator">⬚</span><span class="raw_text">‹<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply_end</span></span></span></span> <span class="main">(</span>…<span class="main">,</span> …<span class="main">)</span>›</span></span>›</span>

<span class="keyword1"><span class="command">datatype</span></span> semi__command_proof <span class="main">=</span> Command_apply <span class="quoted"><span class="quoted">"semi__method list"</span></span> <span class="comment1">― ‹<span class="antiquoted"><span class="operator">⬚</span><span class="raw_text">‹<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span>…<span class="main">,</span> …<span class="main">)</span>›</span></span>›</span>
                             <span class="main">|</span> Command_using <span class="quoted">semi__thm_l</span> <span class="comment1">― ‹<span class="antiquoted"><span class="operator">⬚</span><span class="raw_text">‹<span class="keyword1"><span class="command">using</span></span> …›</span></span>›</span>
                             <span class="main">|</span> Command_unfolding <span class="quoted">semi__thm_l</span> <span class="comment1">― ‹<span class="antiquoted"><span class="operator">⬚</span><span class="raw_text">‹<span class="keyword1"><span class="command">unfolding</span></span> …›</span></span>›</span>
                             <span class="main">|</span> Command_let <span class="quoted">semi__term</span> <span class="comment1">― ‹name›</span> <span class="quoted">semi__term</span>
                             <span class="main">|</span> Command_have <span class="quoted"><span class="keyword1">string</span></span> <span class="comment1">― ‹name›</span>
                                            <span class="quoted">bool</span> <span class="comment1">― ‹true: add <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>[simp]›</span></span>›</span>
                                            <span class="quoted">semi__term</span>
                                            <span class="quoted">semi__command_final</span>
                             <span class="main">|</span> Command_fix_let <span class="quoted"><span class="quoted">"<span class="keyword1">string</span> list"</span></span>
                                               <span class="quoted"><span class="quoted">"<span class="main">(</span>semi__term <span class="comment1">― ‹name›</span> <span class="main">×</span> semi__term<span class="main">)</span> list"</span></span> <span class="comment1">― ‹let statements›</span> <span class="comment1">(* TODO merge recursively *)</span>
                                               <span class="quoted"><span class="quoted">"<span class="main">(</span> semi__term list <span class="comment1">― ‹<span class="antiquoted"><span class="operator">⬚</span><span class="raw_text">‹<span class="keyword3"><span class="command">show</span></span> … ⟹ … ›</span></span>›</span>
                                                <span class="main">×</span> semi__term list <span class="comment1">― ‹<span class="antiquoted"><span class="operator">⬚</span><span class="raw_text">‹<span class="keyword2"><span class="keyword">when</span></span> … …›</span></span>›</span><span class="main">)</span> option"</span></span> <span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>None ⇒ ?thesis›</span></span>›</span>
                                               <span class="quoted"><span class="quoted">"semi__command_state list"</span></span> <span class="comment1">― ‹<span class="antiquoted"><span class="operator">⬚</span><span class="raw_text">‹<span class="keyword1"><span class="command">qed</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply_end</span></span></span></span> …›</span></span>›</span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="quoted">"lemma"</span> <span class="main">=</span> Lemma <span class="quoted"><span class="keyword1">string</span></span> <span class="comment1">― ‹name›</span> <span class="quoted"><span class="quoted">"semi__term list"</span></span> <span class="comment1">― ‹specification to prove›</span>
                         <span class="quoted"><span class="quoted">"semi__method list list"</span></span> <span class="comment1">― ‹tactics: <span class="antiquoted"><span class="operator">⬚</span><span class="raw_text">‹<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span>…<span class="main">,</span> …<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> …›</span></span>›</span>
                         <span class="quoted">semi__command_final</span>
                 <span class="main">|</span> Lemma_assumes <span class="quoted"><span class="keyword1">string</span></span> <span class="comment1">― ‹name›</span>
                                 <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">string</span> <span class="comment1">― ‹name›</span> <span class="main">×</span> bool <span class="comment1">― ‹true: add <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>[simp]›</span></span>›</span> <span class="main">×</span> semi__term<span class="main">)</span> list"</span></span> <span class="comment1">― ‹specification to prove (assms)›</span>
                                 <span class="quoted">semi__term</span> <span class="comment1">― ‹specification to prove (conclusion)›</span>
                                 <span class="quoted"><span class="quoted">"semi__command_proof list"</span></span>
                                 <span class="quoted">semi__command_final</span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="quoted">"axiomatization"</span> <span class="main">=</span> Axiomatization <span class="quoted"><span class="keyword1">string</span></span> <span class="comment1">― ‹name›</span>
                                           <span class="quoted">semi__term</span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="quoted">"section"</span> <span class="main">=</span> Section <span class="quoted"><span class="keyword1">nat</span></span> <span class="comment1">― ‹nesting level›</span>
                             <span class="quoted"><span class="keyword1">string</span></span> <span class="comment1">― ‹content›</span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="quoted">"text"</span> <span class="main">=</span> Text <span class="quoted"><span class="keyword1">string</span></span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="quoted">"ML"</span> <span class="main">=</span> SML <span class="quoted">semi__term'</span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="quoted">"setup"</span> <span class="main">=</span> Setup <span class="quoted">semi__term'</span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="quoted">"thm"</span> <span class="main">=</span> Thm <span class="quoted"><span class="quoted">"semi__thm_attribute list"</span></span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="quoted">"interpretation"</span> <span class="main">=</span> Interpretation <span class="quoted"><span class="keyword1">string</span></span> <span class="comment1">― ‹name›</span>
                                           <span class="quoted"><span class="keyword1">string</span></span> <span class="comment1">― ‹locale name›</span>
                                           <span class="quoted"><span class="quoted">"semi__term list"</span></span> <span class="comment1">― ‹locale param›</span>
                                           <span class="quoted">semi__command_final</span>

<span class="keyword1"><span class="command">datatype</span></span> semi__theory <span class="main">=</span> Theory_datatype <span class="quoted"><span class="quoted">"datatype"</span></span>
                      <span class="main">|</span> Theory_type_synonym <span class="quoted"><span class="quoted">"type_synonym"</span></span>
                      <span class="main">|</span> Theory_type_notation <span class="quoted"><span class="quoted">"type_notation"</span></span>
                      <span class="main">|</span> Theory_instantiation <span class="quoted"><span class="quoted">"instantiation"</span></span>
                      <span class="main">|</span> Theory_overloading <span class="quoted"><span class="quoted">"overloading"</span></span>
                      <span class="main">|</span> Theory_consts <span class="quoted"><span class="quoted">"consts"</span></span>
                      <span class="main">|</span> Theory_definition <span class="quoted"><span class="quoted">"definition"</span></span>
                      <span class="main">|</span> Theory_lemmas <span class="quoted"><span class="quoted">"lemmas"</span></span>
                      <span class="main">|</span> Theory_lemma <span class="quoted"><span class="quoted">"lemma"</span></span>
                      <span class="main">|</span> Theory_axiomatization <span class="quoted"><span class="quoted">"axiomatization"</span></span>
                      <span class="main">|</span> Theory_section <span class="quoted"><span class="quoted">"section"</span></span>
                      <span class="main">|</span> Theory_text <span class="quoted"><span class="quoted">"text"</span></span>
                      <span class="main">|</span> Theory_ML <span class="quoted"><span class="quoted">"ML"</span></span>
                      <span class="main">|</span> Theory_setup <span class="quoted"><span class="quoted">"setup"</span></span>
                      <span class="main">|</span> Theory_thm <span class="quoted"><span class="quoted">"thm"</span></span>
                      <span class="main">|</span> Theory_interpretation <span class="quoted"><span class="quoted">"interpretation"</span></span>

<span class="keyword1"><span class="command">record</span></span> semi__locale <span class="main">=</span> 
  HolThyLocale_name <span class="main">::</span> <span class="quoted"><span class="keyword1">string</span></span>
  HolThyLocale_header <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span> <span class="main">(</span>semi__term <span class="comment1">― ‹name›</span> <span class="main">×</span> semi__typ <span class="comment1">― ‹<span class="antiquoted"><span class="operator">⬚</span><span class="raw_text">‹<span class="keyword3"><span class="command">fix</span></span>›</span></span> statement›</span><span class="main">)</span> list
                          <span class="main">×</span> <span class="main">(</span><span class="keyword1">string</span> <span class="comment1">― ‹name›</span> <span class="main">×</span> semi__term <span class="comment1">― ‹<span class="antiquoted"><span class="operator">⬚</span><span class="raw_text">‹<span class="keyword2"><span class="keyword">assumes</span></span>›</span></span> statement›</span><span class="main">)</span> option <span class="comment1">― ‹None: no <span class="antiquoted"><span class="operator">⬚</span><span class="raw_text">‹<span class="keyword2"><span class="keyword">assumes</span></span>›</span></span> to generate›</span><span class="main">)</span> list"</span></span>

<span class="keyword1"><span class="command">datatype</span></span> semi__theories <span class="main">=</span> Theories_one <span class="quoted">semi__theory</span>
                        <span class="main">|</span> Theories_locale <span class="quoted">semi__locale</span> <span class="quoted"><span class="quoted">"semi__theory list <span class="comment1">― ‹positioning comments can occur before and after this group of commands›</span> list"</span></span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Extending the Meta-Model›</span></span>

<span class="keyword1"><span class="command">locale</span></span> T
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">thm</span> <span class="main">=</span> Thm_thm"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">thms</span> <span class="main">=</span> Thm_thms"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">THEN</span> <span class="main">=</span> Thm_THEN"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">simplified</span> <span class="main">=</span> Thm_simplified"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">symmetric</span> <span class="main">=</span> Thm_symmetric"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">where</span> <span class="main">=</span> Thm_where"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">of'</span> <span class="main">=</span> Thm_of"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">OF</span> <span class="main">=</span> Thm_OF"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">OF_l</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span> List.fold <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">acc</span><span class="main">.</span> Thm_OF <span class="bound">acc</span> <span class="bound">x</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">simplified_l</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span> List.fold <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">acc</span><span class="main">.</span> Thm_simplified <span class="bound">acc</span> <span class="bound">x</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">code</span><span class="main">]</span> <span class="main">=</span>
  <span class="comment1">― ‹def›</span>
  T.thm_def
  T.thms_def
  T.THEN_def
  T.simplified_def
  T.symmetric_def
  T.where_def
  T.of'_def
  T.OF_def
  T.OF_l_def
  T.simplified_l_def

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">Opt</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> Typ_apply <span class="main">(</span>Typ_base <span class="inner_cartouche">‹option›</span><span class="main">)</span> <span class="main">[</span>Typ_base <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">]</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">Raw</span> <span class="main">=</span> Typ_base"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">Type_synonym'</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> Type_synonym <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">[]</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">Type_synonym''</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> Type_synonym <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">Term_annot'</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> Term_annot <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">(</span>Typ_base <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">Term_lambdas</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> Term_bind <span class="inner_cartouche">‹λ›</span> <span class="main">(</span>Term_basic <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">Term_lambda</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> Term_lambdas <span class="main">[</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">]</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">Term_lambdas0</span> <span class="main">=</span> Term_bind <span class="inner_cartouche">‹λ›</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">Term_lam</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> Term_lambdas0 <span class="main">(</span>Term_basic <span class="main">[</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">]</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">Term_some</span> <span class="main">=</span> Term_paren <span class="inner_cartouche">‹⌊›</span> <span class="inner_cartouche">‹⌋›</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">Term_parenthesis</span> <span class="comment1">― ‹mandatory parenthesis›</span> <span class="main">=</span> Term_paren <span class="inner_cartouche">‹(›</span> <span class="inner_cartouche">‹)›</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">Term_warning_parenthesis</span> <span class="comment1">― ‹optional parenthesis that can be removed but a warning will be raised›</span> <span class="main">=</span> Term_parenthesis"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">Term_pat</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">=</span> Term_basic <span class="main">[</span><span class="inner_cartouche">‹?›</span> <span class="main">@@</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">]</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">Term_And</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> Term_bind <span class="inner_cartouche">‹⋀›</span> <span class="main">(</span>Term_basic <span class="main">[</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">]</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">Term_exists</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> Term_bind <span class="inner_cartouche">‹∃›</span> <span class="main">(</span>Term_basic <span class="main">[</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">]</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">Term_binop</span> <span class="main">=</span> Term_rewrite"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">term_binop</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> rev <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="keyword1">of</span> <span class="bound">x</span> <span class="main">#</span> <span class="bound">xs</span> <span class="main">⇒</span> List.fold <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> Term_binop <span class="bound">x</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="bound">xs</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">term_binop'</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> rev <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="keyword1">of</span> <span class="bound">x</span> <span class="main">#</span> <span class="bound">xs</span> <span class="main">⇒</span> List.fold <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> Term_parenthesis <span class="keyword1">o</span> Term_binop <span class="bound">x</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="bound">xs</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">Term_set</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="keyword1">of</span> <span class="main">[]</span> <span class="main">⇒</span> Term_basic <span class="main">[</span><span class="inner_cartouche">‹{}›</span><span class="main">]</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> Term_paren <span class="inner_cartouche">‹{›</span> <span class="inner_cartouche">‹}›</span> <span class="main">(</span>term_binop <span class="inner_cartouche">‹,›</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">Term_list</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="keyword1">of</span> <span class="main">[]</span> <span class="main">⇒</span> Term_basic <span class="main">[</span><span class="inner_cartouche">‹[]›</span><span class="main">]</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> Term_paren <span class="inner_cartouche">‹[›</span> <span class="inner_cartouche">‹]›</span> <span class="main">(</span>term_binop <span class="inner_cartouche">‹,›</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">Term_list'</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span> Term_list <span class="main">(</span>L.map <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">Term_pair</span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="main">=</span> Term_parenthesis <span class="main">(</span>Term_binop <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="inner_cartouche">‹,›</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">Term_pair'</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="keyword1">of</span> <span class="main">[]</span> <span class="main">⇒</span> Term_basic <span class="main">[</span><span class="inner_cartouche">‹()›</span><span class="main">]</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> Term_paren <span class="inner_cartouche">‹(›</span> <span class="inner_cartouche">‹)›</span> <span class="main">(</span>term_binop <span class="inner_cartouche">‹,›</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">‹<span class="free">Term_string</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> Term_basic <span class="main">[</span>S.flatten <span class="main">[</span><span class="inner_cartouche">‹"›</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span> <span class="inner_cartouche">‹"›</span><span class="main">]</span><span class="main">]</span>›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">Term_applys0</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span> Term_parenthesis <span class="main">(</span>Term_apply <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">(</span>L.map Term_parenthesis <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">Term_applys</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span> Term_applys0 <span class="main">(</span>Term_parenthesis <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">Term_app</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> Term_applys0 <span class="main">(</span>Term_basic <span class="main">[</span><span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">]</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">Term_preunary</span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="main">=</span> Term_apply <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">]</span>"</span></span> <span class="comment1">― ‹no parenthesis and separated with one space›</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">Term_postunary</span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="main">=</span> Term_apply <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">]</span>"</span></span> <span class="comment1">― ‹no parenthesis and separated with one space›</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">Term_case</span> <span class="main">=</span> Term_fun_case <span class="keyword1">o</span> Some"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">Term_function</span> <span class="main">=</span> Term_fun_case None"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">Term_term'</span> <span class="main">=</span> Term_term <span class="main">[]</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">Lemmas_simp</span> <span class="main">=</span> Lemmas_simp_thm True"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">Lemmas_nosimp</span> <span class="main">=</span> Lemmas_simp_thm False"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">Consts_value</span> <span class="main">=</span> <span class="inner_cartouche">‹(_)›</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">Consts_raw0</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">o_arg</span></span></span> <span class="main">=</span>
       Consts <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">(</span>String.replace_integers <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">n</span> <span class="main">=</span> <span class="numeral">0x5F</span> <span class="keyword1">then</span> <span class="inner_cartouche">‹'_›</span> <span class="keyword1">else</span> <span class="main">°</span><span class="bound">n</span><span class="main">°</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">@@</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">o_arg</span></span></span> <span class="keyword1">of</span>
         None <span class="main">⇒</span> <span class="inner_cartouche">‹›</span>
       <span class="main">|</span> Some <span class="bound">arg</span> <span class="main">⇒</span>
           <span class="keyword1">let</span> <span class="bound">ap</span> <span class="main">=</span> <span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="inner_cartouche">‹'(›</span> <span class="main">@@</span> <span class="bound">s</span> <span class="main">@@</span> <span class="inner_cartouche">‹')›</span> <span class="keyword1">in</span>
           <span class="bound">ap</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">arg</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span>
                <span class="inner_cartouche">‹›</span>
              <span class="keyword1">else</span>
                Consts_value <span class="main">@@</span> <span class="main">(</span>S.flatten <span class="main">(</span>L.map <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="inner_cartouche">‹,›</span> <span class="main">@@</span> Consts_value<span class="main">)</span> <span class="main">(</span>L.upto <span class="numeral">2</span> <span class="bound">arg</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">Ty_arrow</span> <span class="main">=</span> Typ_apply_bin <span class="inner_cartouche">‹⇒›</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">Ty_times</span> <span class="main">=</span> Typ_apply_bin <span class="inner_cartouche">‹×›</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">Ty_arrow'</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> Ty_arrow <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span>Typ_base <span class="inner_cartouche">‹_›</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">Ty_paren</span> <span class="main">=</span> Typ_apply_paren <span class="inner_cartouche">‹(›</span> <span class="inner_cartouche">‹)›</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">Consts'</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> Consts_raw0 <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span>Ty_arrow <span class="main">(</span>Typ_base <span class="inner_cartouche">‹'α›</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> None"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">Overloading'</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">ty</span></span></span> <span class="main">=</span> Overloading <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>Term_annot <span class="main">(</span>Term_basic <span class="main">[</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">]</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ty</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">locale</span></span> M
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">Method_simp_add_del</span> <span class="free"><span class="bound"><span class="entity">l_a</span></span></span> <span class="free"><span class="bound"><span class="entity">l_d</span></span></span> <span class="main">=</span> Method_simp_add_del_split <span class="free"><span class="bound"><span class="entity">l_a</span></span></span> <span class="free"><span class="bound"><span class="entity">l_d</span></span></span> <span class="main">[]</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">Method_subst_l</span> <span class="main">=</span> Method_subst False"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">rule'</span> <span class="main">=</span> Method_rule None"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">rule</span> <span class="main">=</span> Method_rule <span class="keyword1">o</span> Some"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">drule</span> <span class="main">=</span> Method_drule"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">erule</span> <span class="main">=</span> Method_erule"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">intro</span> <span class="main">=</span> Method_intro"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">elim</span> <span class="main">=</span> Method_elim"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">subst_l0</span> <span class="main">=</span> Method_subst"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">subst_l</span> <span class="main">=</span> Method_subst_l"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">insert</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">insert</span> <span class="main">=</span> Method_insert <span class="keyword1">o</span> L.map Thms_single"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">plus</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">plus</span> <span class="main">=</span> Method_plus"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">option</span> <span class="main">=</span> Method_option"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">or</span> <span class="main">=</span> Method_or"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">meth_gen_simp</span> <span class="main">=</span> Method_simp_add_del <span class="main">[]</span> <span class="main">[]</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">meth_gen_simp_add2</span> <span class="free"><span class="bound"><span class="entity">l1</span></span></span> <span class="free"><span class="bound"><span class="entity">l2</span></span></span> <span class="main">=</span> Method_simp_add_del <span class="main">(</span>L.flatten <span class="main">[</span> L.map Thms_mult <span class="free"><span class="bound"><span class="entity">l1</span></span></span>
                                                    <span class="main">,</span> L.map <span class="main">(</span>Thms_single <span class="keyword1">o</span> Thm_thm<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">l2</span></span></span><span class="main">]</span><span class="main">)</span>
                                           <span class="main">[]</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">meth_gen_simp_add_del</span> <span class="free"><span class="bound"><span class="entity">l1</span></span></span> <span class="free"><span class="bound"><span class="entity">l2</span></span></span> <span class="main">=</span> Method_simp_add_del <span class="main">(</span>L.map <span class="main">(</span>Thms_single <span class="keyword1">o</span> Thm_thm<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">l1</span></span></span><span class="main">)</span>
                                              <span class="main">(</span>L.map <span class="main">(</span>Thms_single <span class="keyword1">o</span> Thm_thm<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">l2</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">meth_gen_simp_add_del_split</span> <span class="free"><span class="bound"><span class="entity">l1</span></span></span> <span class="free"><span class="bound"><span class="entity">l2</span></span></span> <span class="free"><span class="bound"><span class="entity">l3</span></span></span> <span class="main">=</span> Method_simp_add_del_split <span class="main">(</span>L.map Thms_single <span class="free"><span class="bound"><span class="entity">l1</span></span></span><span class="main">)</span>
                                                             <span class="main">(</span>L.map Thms_single <span class="free"><span class="bound"><span class="entity">l2</span></span></span><span class="main">)</span>
                                                             <span class="main">(</span>L.map Thms_single <span class="free"><span class="bound"><span class="entity">l3</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">meth_gen_simp_add_split</span> <span class="free"><span class="bound"><span class="entity">l1</span></span></span> <span class="free"><span class="bound"><span class="entity">l2</span></span></span> <span class="main">=</span> Method_simp_add_del_split <span class="main">(</span>L.map Thms_single <span class="free"><span class="bound"><span class="entity">l1</span></span></span><span class="main">)</span>
                                                      <span class="main">[]</span>
                                                      <span class="main">(</span>L.map Thms_single <span class="free"><span class="bound"><span class="entity">l2</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">meth_gen_simp_only</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span> Method_simp_only <span class="main">(</span>L.map Thms_single <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">meth_gen_simp_only'</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span> Method_simp_only <span class="main">(</span>L.map Thms_mult <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">meth_gen_simp_add0</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span> Method_simp_add_del <span class="main">(</span>L.map Thms_single <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">[]</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">simp</span> <span class="main">=</span> Method_one meth_gen_simp"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">simp_add2</span> <span class="free"><span class="bound"><span class="entity">l1</span></span></span> <span class="free"><span class="bound"><span class="entity">l2</span></span></span> <span class="main">=</span> Method_one <span class="main">(</span>meth_gen_simp_add2 <span class="free"><span class="bound"><span class="entity">l1</span></span></span> <span class="free"><span class="bound"><span class="entity">l2</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">simp_add_del</span> <span class="free"><span class="bound"><span class="entity">l1</span></span></span> <span class="free"><span class="bound"><span class="entity">l2</span></span></span> <span class="main">=</span> Method_one <span class="main">(</span>meth_gen_simp_add_del <span class="free"><span class="bound"><span class="entity">l1</span></span></span> <span class="free"><span class="bound"><span class="entity">l2</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">simp_add_del_split</span> <span class="free"><span class="bound"><span class="entity">l1</span></span></span> <span class="free"><span class="bound"><span class="entity">l2</span></span></span> <span class="free"><span class="bound"><span class="entity">l3</span></span></span> <span class="main">=</span> Method_one <span class="main">(</span>meth_gen_simp_add_del_split <span class="free"><span class="bound"><span class="entity">l1</span></span></span> <span class="free"><span class="bound"><span class="entity">l2</span></span></span> <span class="free"><span class="bound"><span class="entity">l3</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">simp_add_split</span> <span class="free"><span class="bound"><span class="entity">l1</span></span></span> <span class="free"><span class="bound"><span class="entity">l2</span></span></span> <span class="main">=</span> Method_one <span class="main">(</span>meth_gen_simp_add_split <span class="free"><span class="bound"><span class="entity">l1</span></span></span> <span class="free"><span class="bound"><span class="entity">l2</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">simp_only</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span> Method_one <span class="main">(</span>meth_gen_simp_only <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">simp_only'</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span> Method_one <span class="main">(</span>meth_gen_simp_only' <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">simp_add0</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span> Method_one <span class="main">(</span>meth_gen_simp_add0 <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">simp_add</span> <span class="main">=</span> simp_add2 <span class="main">[]</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">simp_all</span> <span class="main">=</span> Method_all meth_gen_simp"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">simp_all_add</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span> Method_all <span class="main">(</span>meth_gen_simp_add2 <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">simp_all_only</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span> Method_all <span class="main">(</span>meth_gen_simp_only <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">simp_all_only'</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span> Method_all <span class="main">(</span>meth_gen_simp_only' <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">auto_simp_add2</span> <span class="free"><span class="bound"><span class="entity">l1</span></span></span> <span class="free"><span class="bound"><span class="entity">l2</span></span></span> <span class="main">=</span> Method_auto_simp_add_split <span class="main">(</span>L.flatten <span class="main">[</span> L.map Thms_mult <span class="free"><span class="bound"><span class="entity">l1</span></span></span>
                                                                <span class="main">,</span> L.map <span class="main">(</span>Thms_single <span class="keyword1">o</span> Thm_thm<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">l2</span></span></span><span class="main">]</span><span class="main">)</span> <span class="main">[]</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">auto_simp_add_split</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span> Method_auto_simp_add_split <span class="main">(</span>L.map Thms_single <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">rename_tac</span> <span class="main">=</span> Method_rename_tac"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">case_tac</span> <span class="main">=</span> Method_case_tac"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">blast</span> <span class="main">=</span> Method_blast"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">clarify</span> <span class="main">=</span> Method_clarify"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">metis</span> <span class="main">=</span> Method_metis <span class="main">[]</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">metis0</span> <span class="main">=</span> Method_metis"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">subst_asm</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">=</span> subst_l0 <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">[</span><span class="inner_cartouche">‹0›</span><span class="main">]</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">subst</span> <span class="main">=</span> subst_l <span class="main">[</span><span class="inner_cartouche">‹0›</span><span class="main">]</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">auto_simp_add</span> <span class="main">=</span> auto_simp_add2 <span class="main">[]</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">auto</span> <span class="main">=</span> auto_simp_add <span class="main">[]</span>"</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">code</span><span class="main">]</span> <span class="main">=</span>
  <span class="comment1">― ‹def›</span>
  M.Method_simp_add_del_def
  M.Method_subst_l_def
  M.rule'_def
  M.rule_def
  M.drule_def
  M.erule_def
  M.intro_def
  M.elim_def
  M.subst_l0_def
  M.subst_l_def
  M.insert_def
  M.plus_def
  M.option_def
  M.or_def
  M.meth_gen_simp_def
  M.meth_gen_simp_add2_def
  M.meth_gen_simp_add_del_def
  M.meth_gen_simp_add_del_split_def
  M.meth_gen_simp_add_split_def
  M.meth_gen_simp_only_def
  M.meth_gen_simp_only'_def
  M.meth_gen_simp_add0_def
  M.simp_def
  M.simp_add2_def
  M.simp_add_del_def
  M.simp_add_del_split_def
  M.simp_add_split_def
  M.simp_only_def
  M.simp_only'_def
  M.simp_add0_def
  M.simp_add_def
  M.simp_all_def
  M.simp_all_add_def
  M.simp_all_only_def
  M.simp_all_only'_def
  M.auto_simp_add2_def
  M.auto_simp_add_split_def
  M.rename_tac_def
  M.case_tac_def
  M.blast_def
  M.clarify_def
  M.metis_def
  M.metis0_def
  M.subst_asm_def
  M.subst_def
  M.auto_simp_add_def
  M.auto_def

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">ty_arrow</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> rev <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="keyword1">of</span> <span class="bound">x</span> <span class="main">#</span> <span class="bound">xs</span> <span class="main">⇒</span> List.fold Ty_arrow <span class="bound">xs</span> <span class="bound">x</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">locale</span></span> C 
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">done</span> <span class="main">=</span> Command_done"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">by</span> <span class="main">=</span> Command_by"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">sorry</span> <span class="main">=</span> Command_sorry"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">apply_end</span> <span class="main">=</span> Command_apply_end"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">apply</span> <span class="main">=</span> Command_apply"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">using</span> <span class="main">=</span> Command_using <span class="keyword1">o</span> L.map Thms_single"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">unfolding</span> <span class="main">=</span> Command_unfolding <span class="keyword1">o</span> L.map Thms_single"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">let'</span> <span class="main">=</span> Command_let"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">fix_let</span> <span class="main">=</span> Command_fix_let"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">fix</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span> Command_fix_let <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">[]</span> None <span class="main">[]</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">have</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> Command_have <span class="free"><span class="bound"><span class="entity">n</span></span></span> False"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">have0</span> <span class="main">=</span> Command_have"</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">code</span><span class="main">]</span> <span class="main">=</span>
  <span class="comment1">― ‹def›</span>
  C.done_def
  C.by_def
  C.sorry_def
  C.apply_end_def
  C.apply_def
  C.using_def
  C.unfolding_def
  C.let'_def
  C.fix_let_def
  C.fix_def
  C.have_def
  C.have0_def

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">cross_abs_aux</span> <span class="keyword2"><span class="keyword">where</span></span>
   <span class="quoted"><span class="quoted">"<span class="free">cross_abs_aux</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="main">(</span>Suc <span class="bound">n</span><span class="main">,</span> Abs <span class="bound">s</span> <span class="main"><span class="bound">_</span></span> <span class="bound">t</span><span class="main">)</span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">s</span> <span class="main">(</span><span class="free">cross_abs_aux</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="bound">s</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">(</span><span class="bound">n</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>
                         <span class="main">|</span> <span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">e</span><span class="main">)</span> <span class="main">⇒</span> Term_term <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="bound">e</span><span class="main">)</span>
                         <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">cross_abs</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span> cross_abs_aux <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">[]</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Operations of Fold, Map, ..., on the Meta-Model›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">map_lemma</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> Theory_lemma <span class="bound">x</span> <span class="main">⇒</span> Theory_lemma <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">x</span><span class="main">)</span>
                           <span class="main">|</span> <span class="bound">x</span> <span class="main">⇒</span> <span class="bound">x</span><span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Printer_init">
<div class="head">
<h1>Theory Printer_init</h1>
</div>
<pre class="source"><span class="comment1">(******************************************************************************
 * Citadelle
 *
 * Copyright (c) 2011-2018 Université Paris-Saclay, Univ. Paris-Sud, France
 *               2013-2017 IRT SystemX, France
 *               2011-2015 Achim D. Brucker, Germany
 *               2016-2018 The University of Sheffield, UK
 *               2016-2017 Nanyang Technological University, Singapore
 *               2017-2018 Virginia Tech, USA
 *
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are
 * met:
 *
 *     * Redistributions of source code must retain the above copyright
 *       notice, this list of conditions and the following disclaimer.
 *
 *     * Redistributions in binary form must reproduce the above
 *       copyright notice, this list of conditions and the following
 *       disclaimer in the documentation and/or other materials provided
 *       with the distribution.
 *
 *     * Neither the name of the copyright holders nor the names of its
 *       contributors may be used to endorse or promote products derived
 *       from this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 ******************************************************************************)</span>

<span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹Initializing the Printer›</span></span>

<span class="keyword1"><span class="command">theory</span></span>  Printer_init
<span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="Init.html">../Init</a>"</span>
        <span class="quoted">"<a href="Isabelle_Main1.html">../isabelle_home/src/HOL/Isabelle_Main1</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹At the time of writing, the following target languages supported
     by Isabelle are also supported by the meta-compiler:
     Haskell, OCaml, Scala, SML.›</span></span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Kernel Code for Target Languages›</span></span>

  <span class="comment1">(* We put in 'CodeConst' functions using characters
     not allowed in a Isabelle 'code_const' expr
     (e.g. '_', '"', ...) *)</span>

<span class="keyword1"><span class="command">lazy_code_printing</span></span> <span class="keyword2"><span class="keyword">code_module</span></span> <span class="quoted">"CodeType"</span> <span class="main">⇀</span> <span class="main">(</span>Haskell<span class="main">)</span> <span class="quoted">‹
module CodeType where {
  type MlInt = Integer
; type MlMonad a = IO a
}›</span> <span class="main">|</span> <span class="keyword2"><span class="keyword">code_module</span></span> <span class="quoted">"CodeConst"</span> <span class="main">⇀</span> <span class="main">(</span>Haskell<span class="main">)</span> <span class="quoted">‹
module CodeConst where {
  import System.Directory
; import System.IO
; import qualified CodeConst.Printf

; outFile1 f file = (do
  fileExists &lt;- doesFileExist file
  if fileExists then error ("File exists " ++ file ++ "\n") else do
    h &lt;- openFile file WriteMode
    f (\pat -&gt; hPutStr h . CodeConst.Printf.sprintf1 pat)
    hClose h)

; outStand1 :: ((String -&gt; String -&gt; IO ()) -&gt; IO ()) -&gt; IO ()
; outStand1 f = f (\pat -&gt; putStr . CodeConst.Printf.sprintf1 pat)
}›</span> <span class="main">|</span> <span class="keyword2"><span class="keyword">code_module</span></span> <span class="quoted">"CodeConst.Monad"</span> <span class="main">⇀</span> <span class="main">(</span>Haskell<span class="main">)</span> <span class="quoted">‹
module CodeConst.Monad where {
  bind a = (&gt;&gt;=) a
; return :: a -&gt; IO a
; return = Prelude.return
}›</span> <span class="main">|</span> <span class="keyword2"><span class="keyword">code_module</span></span> <span class="quoted">"CodeConst.Printf"</span> <span class="main">⇀</span> <span class="main">(</span>Haskell<span class="main">)</span> <span class="quoted">‹
module CodeConst.Printf where {
  import Text.Printf
; sprintf0 = id

; sprintf1 :: PrintfArg a =&gt; String -&gt; a -&gt; String
; sprintf1 = printf

; sprintf2 :: PrintfArg a =&gt; PrintfArg b =&gt; String -&gt; a -&gt; b -&gt; String
; sprintf2 = printf

; sprintf3 :: PrintfArg a =&gt; PrintfArg b =&gt; PrintfArg c =&gt; String -&gt; a -&gt; b -&gt; c -&gt; String
; sprintf3 = printf

; sprintf4 :: PrintfArg a =&gt; PrintfArg b =&gt; PrintfArg c =&gt; PrintfArg d =&gt; String -&gt; a -&gt; b -&gt; c -&gt; d -&gt; String
; sprintf4 = printf

; sprintf5 :: PrintfArg a =&gt; PrintfArg b =&gt; PrintfArg c =&gt; PrintfArg d =&gt; PrintfArg e =&gt; String -&gt; a -&gt; b -&gt; c -&gt; d -&gt; e -&gt; String
; sprintf5 = printf
}›</span> <span class="main">|</span> <span class="keyword2"><span class="keyword">code_module</span></span> <span class="quoted">"CodeConst.String"</span> <span class="main">⇀</span> <span class="main">(</span>Haskell<span class="main">)</span> <span class="quoted">‹
module CodeConst.String where {
  concat s [] = []
; concat s (x : xs) = x ++ concatMap ((++) s) xs
}›</span> <span class="main">|</span> <span class="keyword2"><span class="keyword">code_module</span></span> <span class="quoted">"CodeConst.Sys"</span> <span class="main">⇀</span> <span class="main">(</span>Haskell<span class="main">)</span> <span class="quoted">‹
module CodeConst.Sys where {
  import System.Directory
; isDirectory2 = doesDirectoryExist
}›</span> <span class="main">|</span> <span class="keyword2"><span class="keyword">code_module</span></span> <span class="quoted">"CodeConst.To"</span> <span class="main">⇀</span> <span class="main">(</span>Haskell<span class="main">)</span> <span class="quoted">‹
module CodeConst.To where {
  nat = id
}›</span> <span class="main">|</span> <span class="keyword2"><span class="keyword">code_module</span></span> <span class="quoted">""</span> <span class="main">⇀</span> <span class="main">(</span>OCaml<span class="main">)</span> <span class="quoted">‹
module CodeType = struct
  type mlInt = int

  type 'a mlMonad = 'a option
end

module CodeConst = struct
  let outFile1 f file =
    try
      let () = if Sys.file_exists file then Printf.eprintf "File exists \"%S\"\n" file else () in
      let oc = open_out file in
      let b = f (fun s a -&gt; try Some (Printf.fprintf oc s a) with _ -&gt; None) in
      let () = close_out oc in
      b
    with _ -&gt; None

  let outStand1 f =
    f (fun s a -&gt; try Some (Printf.fprintf stdout s a) with _ -&gt; None)

  module Monad = struct
    let bind = function
        None -&gt; fun _ -&gt; None
      | Some a -&gt; fun f -&gt; f a
    let return a = Some a
  end

  module Printf = struct
    include Printf
    let sprintf0 = sprintf
    let sprintf1 = sprintf
    let sprintf2 = sprintf
    let sprintf3 = sprintf
    let sprintf4 = sprintf
    let sprintf5 = sprintf
  end

  module String = String

  module Sys = struct open Sys
    let isDirectory2 s = try Some (is_directory s) with _ -&gt; None
  end

  module To = struct
    let nat big_int x = Big_int.int_of_big_int (big_int x)
  end
end

›</span> <span class="main">|</span> <span class="keyword2"><span class="keyword">code_module</span></span> <span class="quoted">""</span> <span class="main">⇀</span> <span class="main">(</span>Scala<span class="main">)</span> <span class="quoted">‹
object CodeType {
  type mlMonad [A] = Option [A]
  type mlInt = Int
}

object CodeConst {
  def outFile1 [A] (f : (String =&gt; A =&gt; Option [Unit]) =&gt; Option [Unit], file0 : String) : Option [Unit] = {
    val file = new java.io.File (file0)
    if (file .isFile) {
      None
    } else {
      val writer = new java.io.PrintWriter (file)
      f ((fmt : String) =&gt; (s : A) =&gt; Some (writer .write (fmt .format (s))))
      Some (writer .close ())
    }
  }

  def outStand1 [A] (f : (String =&gt; A =&gt; Option [Unit]) =&gt; Option [Unit]) : Option[Unit] = {
    f ((fmt : String) =&gt; (s : A) =&gt; Some (print (fmt .format (s))))
  }

  object Monad {
    def bind [A, B] (x : Option [A], f : A =&gt; Option [B]) : Option [B] = x match {
      case None =&gt; None
      case Some (a) =&gt; f (a)
    }
    def Return [A] (a : A) = Some (a)
  }
  object Printf {
    def sprintf0 (x0 : String) = x0
    def sprintf1 [A1] (fmt : String, x1 : A1) = fmt .format (x1)
    def sprintf2 [A1, A2] (fmt : String, x1 : A1, x2 : A2) = fmt .format (x1, x2)
    def sprintf3 [A1, A2, A3] (fmt : String, x1 : A1, x2 : A2, x3 : A3) = fmt .format (x1, x2, x3)
    def sprintf4 [A1, A2, A3, A4] (fmt : String, x1 : A1, x2 : A2, x3 : A3, x4 : A4) = fmt .format (x1, x2, x3, x4)
    def sprintf5 [A1, A2, A3, A4, A5] (fmt : String, x1 : A1, x2 : A2, x3 : A3, x4 : A4, x5 : A5) = fmt .format (x1, x2, x3, x4, x5)
  }
  object String {
    def concat (s : String, l : List [String]) = l filter (_ .nonEmpty) mkString s
  }
  object Sys {
    def isDirectory2 (s : String) = Some (new java.io.File (s) .isDirectory)
  }
  object To {
    def nat [A] (f : A =&gt; BigInt, x : A) = f (x) .intValue ()
  }
}

›</span> <span class="main">|</span> <span class="keyword2"><span class="keyword">code_module</span></span> <span class="quoted">""</span> <span class="main">⇀</span> <span class="main">(</span>SML<span class="main">)</span> <span class="quoted">‹
structure CodeType = struct
  type mlInt = string
  type 'a mlMonad = 'a option
end

structure CodeConst = struct
  structure Monad = struct
    val bind = fn
        NONE =&gt; (fn _ =&gt; NONE)
      | SOME a =&gt; fn f =&gt; f a
    val return = SOME
  end

  structure Printf = struct
    local
      fun sprintf s l =
        case String.fields (fn #"%" =&gt; true | _ =&gt; false) s of
          [] =&gt; ""
        | [x] =&gt; x
        | x :: xs =&gt;
            let fun aux acc l_pat l_s =
              case l_pat of
                [] =&gt; rev acc
              | x :: xs =&gt; aux (String.extract (x, 1, NONE) :: hd l_s :: acc) xs (tl l_s) in
            String.concat (x :: aux [] xs l)
      end
    in
      fun sprintf0 s_pat = s_pat
      fun sprintf1 s_pat s1 = sprintf s_pat [s1]
      fun sprintf2 s_pat s1 s2 = sprintf s_pat [s1, s2]
      fun sprintf3 s_pat s1 s2 s3 = sprintf s_pat [s1, s2, s3]
      fun sprintf4 s_pat s1 s2 s3 s4 = sprintf s_pat [s1, s2, s3, s4]
      fun sprintf5 s_pat s1 s2 s3 s4 s5 = sprintf s_pat [s1, s2, s3, s4, s5]
    end
  end

  structure String = struct
    val concat = String.concatWith
  end

  structure Sys = struct
    val isDirectory2 = SOME o File.is_dir o Path.explode handle ERROR _ =&gt; K NONE
  end

  structure To = struct
    fun nat f = Int.toString o f
  end

  fun outFile1 f file =
    let
      val pfile = Path.explode file
      val () = if File.exists pfile then error ("File exists \"" ^ file ^ "\"\n") else ()
      val oc = Unsynchronized.ref []
      val _ = f (fn a =&gt; fn b =&gt; SOME (oc := Printf.sprintf1 a b :: (Unsynchronized.! oc))) in
      SOME (File.write_list pfile (rev (Unsynchronized.! oc))) handle _ =&gt; NONE
    end

  fun outStand1 f = outFile1 f (Unsynchronized.! stdout_file)
end

›</span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Interface with Types›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> ml_int <span class="main">=</span> ML_int
<span class="keyword1"><span class="command">code_printing</span></span> <span class="keyword2"><span class="keyword">type_constructor</span></span> ml_int <span class="main">⇀</span> <span class="main">(</span>Haskell<span class="main">)</span> <span class="quoted">"CodeType.MlInt"</span> <span class="comment1">― ‹syntax!›</span>
            <span class="main">|</span> <span class="keyword2"><span class="keyword">type_constructor</span></span> ml_int <span class="main">⇀</span> <span class="main">(</span>OCaml<span class="main">)</span> <span class="quoted">"CodeType.mlInt"</span>
            <span class="main">|</span> <span class="keyword2"><span class="keyword">type_constructor</span></span> ml_int <span class="main">⇀</span> <span class="main">(</span>Scala<span class="main">)</span> <span class="quoted">"CodeType.mlInt"</span>
            <span class="main">|</span> <span class="keyword2"><span class="keyword">type_constructor</span></span> ml_int <span class="main">⇀</span> <span class="main">(</span>SML<span class="main">)</span> <span class="quoted">"CodeType.mlInt"</span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="tfree">'a</span> ml_monad <span class="main">=</span> ML_monad <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>
<span class="keyword1"><span class="command">code_printing</span></span> <span class="keyword2"><span class="keyword">type_constructor</span></span> ml_monad <span class="main">⇀</span> <span class="main">(</span>Haskell<span class="main">)</span> <span class="quoted">"CodeType.MlMonad _"</span> <span class="comment1">― ‹syntax!›</span>
            <span class="main">|</span> <span class="keyword2"><span class="keyword">type_constructor</span></span> ml_monad <span class="main">⇀</span> <span class="main">(</span>OCaml<span class="main">)</span> <span class="quoted">"_ CodeType.mlMonad"</span>
            <span class="main">|</span> <span class="keyword2"><span class="keyword">type_constructor</span></span> ml_monad <span class="main">⇀</span> <span class="main">(</span>Scala<span class="main">)</span> <span class="quoted">"CodeType.mlMonad [_]"</span>
            <span class="main">|</span> <span class="keyword2"><span class="keyword">type_constructor</span></span> ml_monad <span class="main">⇀</span> <span class="main">(</span>SML<span class="main">)</span> <span class="quoted">"_ CodeType.mlMonad"</span>

<span class="keyword1"><span class="command">type_synonym</span></span> ml_string <span class="main">=</span> <span class="quoted">String.literal</span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Interface with Constants›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹module CodeConst›</span></span>

<span class="keyword1"><span class="command">consts</span></span> out_file1 <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>ml_string <span class="main">⇒</span> <span class="tfree">'α1</span> <span class="main">⇒</span> unit ml_monad<span class="main">)</span> <span class="comment1">― ‹fprintf›</span> <span class="main">⇒</span> unit ml_monad<span class="main">)</span> <span class="main">⇒</span> ml_string <span class="main">⇒</span> unit ml_monad"</span></span>
<span class="keyword1"><span class="command">code_printing</span></span> <span class="keyword2"><span class="keyword">constant</span></span> <span class="quoted">out_file1</span> <span class="main">⇀</span> <span class="main">(</span>Haskell<span class="main">)</span> <span class="quoted">"CodeConst.outFile1"</span>
            <span class="main">|</span> <span class="keyword2"><span class="keyword">constant</span></span> <span class="quoted">out_file1</span> <span class="main">⇀</span> <span class="main">(</span>OCaml<span class="main">)</span> <span class="quoted">"CodeConst.outFile1"</span>
            <span class="main">|</span> <span class="keyword2"><span class="keyword">constant</span></span> <span class="quoted">out_file1</span> <span class="main">⇀</span> <span class="main">(</span>Scala<span class="main">)</span> <span class="quoted">"CodeConst.outFile1"</span>
            <span class="main">|</span> <span class="keyword2"><span class="keyword">constant</span></span> <span class="quoted">out_file1</span> <span class="main">⇀</span> <span class="main">(</span>SML<span class="main">)</span> <span class="quoted">"CodeConst.outFile1"</span>

<span class="keyword1"><span class="command">consts</span></span> out_stand1 <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>ml_string <span class="main">⇒</span> <span class="tfree">'α1</span> <span class="main">⇒</span> unit ml_monad<span class="main">)</span> <span class="comment1">― ‹fprintf›</span> <span class="main">⇒</span> unit ml_monad<span class="main">)</span> <span class="main">⇒</span> unit ml_monad"</span></span>
<span class="keyword1"><span class="command">code_printing</span></span> <span class="keyword2"><span class="keyword">constant</span></span> <span class="quoted">out_stand1</span> <span class="main">⇀</span> <span class="main">(</span>Haskell<span class="main">)</span> <span class="quoted">"CodeConst.outStand1"</span>
            <span class="main">|</span> <span class="keyword2"><span class="keyword">constant</span></span> <span class="quoted">out_stand1</span> <span class="main">⇀</span> <span class="main">(</span>OCaml<span class="main">)</span> <span class="quoted">"CodeConst.outStand1"</span>
            <span class="main">|</span> <span class="keyword2"><span class="keyword">constant</span></span> <span class="quoted">out_stand1</span> <span class="main">⇀</span> <span class="main">(</span>Scala<span class="main">)</span> <span class="quoted">"CodeConst.outStand1"</span>
            <span class="main">|</span> <span class="keyword2"><span class="keyword">constant</span></span> <span class="quoted">out_stand1</span> <span class="main">⇀</span> <span class="main">(</span>SML<span class="main">)</span> <span class="quoted">"CodeConst.outStand1"</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹module Monad›</span></span>

<span class="keyword1"><span class="command">consts</span></span> bind <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ml_monad <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> ml_monad<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'b</span> ml_monad"</span></span>
<span class="keyword1"><span class="command">code_printing</span></span> <span class="keyword2"><span class="keyword">constant</span></span> <span class="quoted">bind</span> <span class="main">⇀</span> <span class="main">(</span>Haskell<span class="main">)</span> <span class="quoted">"CodeConst.Monad.bind"</span>
            <span class="main">|</span> <span class="keyword2"><span class="keyword">constant</span></span> <span class="quoted">bind</span> <span class="main">⇀</span> <span class="main">(</span>OCaml<span class="main">)</span> <span class="quoted">"CodeConst.Monad.bind"</span>
            <span class="main">|</span> <span class="keyword2"><span class="keyword">constant</span></span> <span class="quoted">bind</span> <span class="main">⇀</span> <span class="main">(</span>Scala<span class="main">)</span> <span class="quoted">"CodeConst.Monad.bind"</span>
            <span class="main">|</span> <span class="keyword2"><span class="keyword">constant</span></span> <span class="quoted">bind</span> <span class="main">⇀</span> <span class="main">(</span>SML<span class="main">)</span> <span class="quoted">"CodeConst.Monad.bind"</span>

<span class="keyword1"><span class="command">consts</span></span> return <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> ml_monad"</span></span>
<span class="keyword1"><span class="command">code_printing</span></span> <span class="keyword2"><span class="keyword">constant</span></span> <span class="quoted">return</span> <span class="main">⇀</span> <span class="main">(</span>Haskell<span class="main">)</span> <span class="quoted">"CodeConst.Monad.return"</span>
            <span class="main">|</span> <span class="keyword2"><span class="keyword">constant</span></span> <span class="quoted">return</span> <span class="main">⇀</span> <span class="main">(</span>OCaml<span class="main">)</span> <span class="quoted">"CodeConst.Monad.return"</span>
            <span class="main">|</span> <span class="keyword2"><span class="keyword">constant</span></span> <span class="quoted">return</span> <span class="main">⇀</span> <span class="main">(</span>Scala<span class="main">)</span> <span class="quoted">"CodeConst.Monad.Return"</span> <span class="comment1">― ‹syntax!›</span>
            <span class="main">|</span> <span class="keyword2"><span class="keyword">constant</span></span> <span class="quoted">return</span> <span class="main">⇀</span> <span class="main">(</span>SML<span class="main">)</span> <span class="quoted">"CodeConst.Monad.return"</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹module Printf›</span></span>

<span class="keyword1"><span class="command">consts</span></span> sprintf0 <span class="main">::</span> <span class="quoted"><span class="quoted">"ml_string <span class="main">⇒</span> ml_string"</span></span>
<span class="keyword1"><span class="command">code_printing</span></span> <span class="keyword2"><span class="keyword">constant</span></span> <span class="quoted">sprintf0</span> <span class="main">⇀</span> <span class="main">(</span>Haskell<span class="main">)</span> <span class="quoted">"CodeConst.Printf.sprintf0"</span>
            <span class="main">|</span> <span class="keyword2"><span class="keyword">constant</span></span> <span class="quoted">sprintf0</span> <span class="main">⇀</span> <span class="main">(</span>OCaml<span class="main">)</span> <span class="quoted">"CodeConst.Printf.sprintf0"</span>
            <span class="main">|</span> <span class="keyword2"><span class="keyword">constant</span></span> <span class="quoted">sprintf0</span> <span class="main">⇀</span> <span class="main">(</span>Scala<span class="main">)</span> <span class="quoted">"CodeConst.Printf.sprintf0"</span>
            <span class="main">|</span> <span class="keyword2"><span class="keyword">constant</span></span> <span class="quoted">sprintf0</span> <span class="main">⇀</span> <span class="main">(</span>SML<span class="main">)</span> <span class="quoted">"CodeConst.Printf.sprintf0"</span>

<span class="keyword1"><span class="command">consts</span></span> sprintf1 <span class="main">::</span> <span class="quoted"><span class="quoted">"ml_string <span class="main">⇒</span> <span class="tfree">'α1</span> <span class="main">⇒</span> ml_string"</span></span>
<span class="keyword1"><span class="command">code_printing</span></span> <span class="keyword2"><span class="keyword">constant</span></span> <span class="quoted">sprintf1</span> <span class="main">⇀</span> <span class="main">(</span>Haskell<span class="main">)</span> <span class="quoted">"CodeConst.Printf.sprintf1"</span>
            <span class="main">|</span> <span class="keyword2"><span class="keyword">constant</span></span> <span class="quoted">sprintf1</span> <span class="main">⇀</span> <span class="main">(</span>OCaml<span class="main">)</span> <span class="quoted">"CodeConst.Printf.sprintf1"</span>
            <span class="main">|</span> <span class="keyword2"><span class="keyword">constant</span></span> <span class="quoted">sprintf1</span> <span class="main">⇀</span> <span class="main">(</span>Scala<span class="main">)</span> <span class="quoted">"CodeConst.Printf.sprintf1"</span>
            <span class="main">|</span> <span class="keyword2"><span class="keyword">constant</span></span> <span class="quoted">sprintf1</span> <span class="main">⇀</span> <span class="main">(</span>SML<span class="main">)</span> <span class="quoted">"CodeConst.Printf.sprintf1"</span>

<span class="keyword1"><span class="command">consts</span></span> sprintf2 <span class="main">::</span> <span class="quoted"><span class="quoted">"ml_string <span class="main">⇒</span> <span class="tfree">'α1</span> <span class="main">⇒</span> <span class="tfree">'α2</span> <span class="main">⇒</span> ml_string"</span></span>
<span class="keyword1"><span class="command">code_printing</span></span> <span class="keyword2"><span class="keyword">constant</span></span> <span class="quoted">sprintf2</span> <span class="main">⇀</span> <span class="main">(</span>Haskell<span class="main">)</span> <span class="quoted">"CodeConst.Printf.sprintf2"</span>
            <span class="main">|</span> <span class="keyword2"><span class="keyword">constant</span></span> <span class="quoted">sprintf2</span> <span class="main">⇀</span> <span class="main">(</span>OCaml<span class="main">)</span> <span class="quoted">"CodeConst.Printf.sprintf2"</span>
            <span class="main">|</span> <span class="keyword2"><span class="keyword">constant</span></span> <span class="quoted">sprintf2</span> <span class="main">⇀</span> <span class="main">(</span>Scala<span class="main">)</span> <span class="quoted">"CodeConst.Printf.sprintf2"</span>
            <span class="main">|</span> <span class="keyword2"><span class="keyword">constant</span></span> <span class="quoted">sprintf2</span> <span class="main">⇀</span> <span class="main">(</span>SML<span class="main">)</span> <span class="quoted">"CodeConst.Printf.sprintf2"</span>

<span class="keyword1"><span class="command">consts</span></span> sprintf3 <span class="main">::</span> <span class="quoted"><span class="quoted">"ml_string <span class="main">⇒</span> <span class="tfree">'α1</span> <span class="main">⇒</span> <span class="tfree">'α2</span> <span class="main">⇒</span> <span class="tfree">'α3</span> <span class="main">⇒</span> ml_string"</span></span>
<span class="keyword1"><span class="command">code_printing</span></span> <span class="keyword2"><span class="keyword">constant</span></span> <span class="quoted">sprintf3</span> <span class="main">⇀</span> <span class="main">(</span>Haskell<span class="main">)</span> <span class="quoted">"CodeConst.Printf.sprintf3"</span>
            <span class="main">|</span> <span class="keyword2"><span class="keyword">constant</span></span> <span class="quoted">sprintf3</span> <span class="main">⇀</span> <span class="main">(</span>OCaml<span class="main">)</span> <span class="quoted">"CodeConst.Printf.sprintf3"</span>
            <span class="main">|</span> <span class="keyword2"><span class="keyword">constant</span></span> <span class="quoted">sprintf3</span> <span class="main">⇀</span> <span class="main">(</span>Scala<span class="main">)</span> <span class="quoted">"CodeConst.Printf.sprintf3"</span>
            <span class="main">|</span> <span class="keyword2"><span class="keyword">constant</span></span> <span class="quoted">sprintf3</span> <span class="main">⇀</span> <span class="main">(</span>SML<span class="main">)</span> <span class="quoted">"CodeConst.Printf.sprintf3"</span>

<span class="keyword1"><span class="command">consts</span></span> sprintf4 <span class="main">::</span> <span class="quoted"><span class="quoted">"ml_string <span class="main">⇒</span> <span class="tfree">'α1</span> <span class="main">⇒</span> <span class="tfree">'α2</span> <span class="main">⇒</span> <span class="tfree">'α3</span> <span class="main">⇒</span> <span class="tfree">'α4</span> <span class="main">⇒</span> ml_string"</span></span>
<span class="keyword1"><span class="command">code_printing</span></span> <span class="keyword2"><span class="keyword">constant</span></span> <span class="quoted">sprintf4</span> <span class="main">⇀</span> <span class="main">(</span>Haskell<span class="main">)</span> <span class="quoted">"CodeConst.Printf.sprintf4"</span>
            <span class="main">|</span> <span class="keyword2"><span class="keyword">constant</span></span> <span class="quoted">sprintf4</span> <span class="main">⇀</span> <span class="main">(</span>OCaml<span class="main">)</span> <span class="quoted">"CodeConst.Printf.sprintf4"</span>
            <span class="main">|</span> <span class="keyword2"><span class="keyword">constant</span></span> <span class="quoted">sprintf4</span> <span class="main">⇀</span> <span class="main">(</span>Scala<span class="main">)</span> <span class="quoted">"CodeConst.Printf.sprintf4"</span>
            <span class="main">|</span> <span class="keyword2"><span class="keyword">constant</span></span> <span class="quoted">sprintf4</span> <span class="main">⇀</span> <span class="main">(</span>SML<span class="main">)</span> <span class="quoted">"CodeConst.Printf.sprintf4"</span>

<span class="keyword1"><span class="command">consts</span></span> sprintf5 <span class="main">::</span> <span class="quoted"><span class="quoted">"ml_string <span class="main">⇒</span> <span class="tfree">'α1</span> <span class="main">⇒</span> <span class="tfree">'α2</span> <span class="main">⇒</span> <span class="tfree">'α3</span> <span class="main">⇒</span> <span class="tfree">'α4</span> <span class="main">⇒</span> <span class="tfree">'α5</span> <span class="main">⇒</span> ml_string"</span></span>
<span class="keyword1"><span class="command">code_printing</span></span> <span class="keyword2"><span class="keyword">constant</span></span> <span class="quoted">sprintf5</span> <span class="main">⇀</span> <span class="main">(</span>Haskell<span class="main">)</span> <span class="quoted">"CodeConst.Printf.sprintf5"</span>
            <span class="main">|</span> <span class="keyword2"><span class="keyword">constant</span></span> <span class="quoted">sprintf5</span> <span class="main">⇀</span> <span class="main">(</span>OCaml<span class="main">)</span> <span class="quoted">"CodeConst.Printf.sprintf5"</span>
            <span class="main">|</span> <span class="keyword2"><span class="keyword">constant</span></span> <span class="quoted">sprintf5</span> <span class="main">⇀</span> <span class="main">(</span>Scala<span class="main">)</span> <span class="quoted">"CodeConst.Printf.sprintf5"</span>
            <span class="main">|</span> <span class="keyword2"><span class="keyword">constant</span></span> <span class="quoted">sprintf5</span> <span class="main">⇀</span> <span class="main">(</span>SML<span class="main">)</span> <span class="quoted">"CodeConst.Printf.sprintf5"</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹module String›</span></span>

<span class="keyword1"><span class="command">consts</span></span> String_concat <span class="main">::</span> <span class="quoted"><span class="quoted">"ml_string <span class="main">⇒</span> ml_string list <span class="main">⇒</span> ml_string"</span></span>
<span class="keyword1"><span class="command">code_printing</span></span> <span class="keyword2"><span class="keyword">constant</span></span> <span class="quoted">String_concat</span> <span class="main">⇀</span> <span class="main">(</span>Haskell<span class="main">)</span> <span class="quoted">"CodeConst.String.concat"</span>
            <span class="main">|</span> <span class="keyword2"><span class="keyword">constant</span></span> <span class="quoted">String_concat</span> <span class="main">⇀</span> <span class="main">(</span>OCaml<span class="main">)</span> <span class="quoted">"CodeConst.String.concat"</span>
            <span class="main">|</span> <span class="keyword2"><span class="keyword">constant</span></span> <span class="quoted">String_concat</span> <span class="main">⇀</span> <span class="main">(</span>Scala<span class="main">)</span> <span class="quoted">"CodeConst.String.concat"</span>
            <span class="main">|</span> <span class="keyword2"><span class="keyword">constant</span></span> <span class="quoted">String_concat</span> <span class="main">⇀</span> <span class="main">(</span>SML<span class="main">)</span> <span class="quoted">"CodeConst.String.concat"</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹module Sys›</span></span>

<span class="keyword1"><span class="command">consts</span></span> Sys_is_directory2 <span class="main">::</span> <span class="quoted"><span class="quoted">"ml_string <span class="main">⇒</span> bool ml_monad"</span></span>
<span class="keyword1"><span class="command">code_printing</span></span> <span class="keyword2"><span class="keyword">constant</span></span> <span class="quoted">Sys_is_directory2</span> <span class="main">⇀</span> <span class="main">(</span>Haskell<span class="main">)</span> <span class="quoted">"CodeConst.Sys.isDirectory2"</span>
            <span class="main">|</span> <span class="keyword2"><span class="keyword">constant</span></span> <span class="quoted">Sys_is_directory2</span> <span class="main">⇀</span> <span class="main">(</span>OCaml<span class="main">)</span> <span class="quoted">"CodeConst.Sys.isDirectory2"</span>
            <span class="main">|</span> <span class="keyword2"><span class="keyword">constant</span></span> <span class="quoted">Sys_is_directory2</span> <span class="main">⇀</span> <span class="main">(</span>Scala<span class="main">)</span> <span class="quoted">"CodeConst.Sys.isDirectory2"</span>
            <span class="main">|</span> <span class="keyword2"><span class="keyword">constant</span></span> <span class="quoted">Sys_is_directory2</span> <span class="main">⇀</span> <span class="main">(</span>SML<span class="main">)</span> <span class="quoted">"CodeConst.Sys.isDirectory2"</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹module To›</span></span>

<span class="keyword1"><span class="command">consts</span></span> ToNat <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">nat</span> <span class="main">⇒</span> integer<span class="main">)</span> <span class="main">⇒</span> <span class="keyword1">nat</span> <span class="main">⇒</span> ml_int"</span></span>
<span class="keyword1"><span class="command">code_printing</span></span> <span class="keyword2"><span class="keyword">constant</span></span> <span class="quoted">ToNat</span> <span class="main">⇀</span> <span class="main">(</span>Haskell<span class="main">)</span> <span class="quoted">"CodeConst.To.nat"</span>
            <span class="main">|</span> <span class="keyword2"><span class="keyword">constant</span></span> <span class="quoted">ToNat</span> <span class="main">⇀</span> <span class="main">(</span>OCaml<span class="main">)</span> <span class="quoted">"CodeConst.To.nat"</span>
            <span class="main">|</span> <span class="keyword2"><span class="keyword">constant</span></span> <span class="quoted">ToNat</span> <span class="main">⇀</span> <span class="main">(</span>Scala<span class="main">)</span> <span class="quoted">"CodeConst.To.nat"</span>
            <span class="main">|</span> <span class="keyword2"><span class="keyword">constant</span></span> <span class="quoted">ToNat</span> <span class="main">⇀</span> <span class="main">(</span>SML<span class="main">)</span> <span class="quoted">"CodeConst.To.nat"</span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Some Notations (I): Raw Translations›</span></span>

<span class="keyword1"><span class="command">syntax</span></span> <span class="quoted">"_sprint0"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⇒</span> ml_string"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">sprint0</span> <span class="keyword3">(</span>_<span class="keyword3">)</span><span class="keyword1">´</span>"</span><span class="main">)</span>
<span class="keyword1"><span class="command">translations</span></span> <span class="quoted">"<span class="keyword1">sprint0</span> <span class="free">x</span><span class="main">´</span>"</span> <span class="main">⇌</span> <span class="quoted">"<span class="keyword1">CONST</span> sprintf0 <span class="free">x</span>"</span>

<span class="keyword1"><span class="command">syntax</span></span> <span class="quoted">"_sprint1"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> ml_string"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">sprint1</span> <span class="keyword3">(</span>_<span class="keyword3">)</span><span class="keyword1">´</span>"</span><span class="main">)</span>
<span class="keyword1"><span class="command">translations</span></span> <span class="quoted">"<span class="keyword1">sprint1</span> <span class="free">x</span><span class="main">´</span>"</span> <span class="main">⇌</span> <span class="quoted">"<span class="keyword1">CONST</span> sprintf1 <span class="free">x</span>"</span>

<span class="keyword1"><span class="command">syntax</span></span> <span class="quoted">"_sprint2"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> ml_string"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">sprint2</span> <span class="keyword3">(</span>_<span class="keyword3">)</span><span class="keyword1">´</span>"</span><span class="main">)</span>
<span class="keyword1"><span class="command">translations</span></span> <span class="quoted">"<span class="keyword1">sprint2</span> <span class="free">x</span><span class="main">´</span>"</span> <span class="main">⇌</span> <span class="quoted">"<span class="keyword1">CONST</span> sprintf2 <span class="free">x</span>"</span>

<span class="keyword1"><span class="command">syntax</span></span> <span class="quoted">"_sprint3"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> ml_string"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">sprint3</span> <span class="keyword3">(</span>_<span class="keyword3">)</span><span class="keyword1">´</span>"</span><span class="main">)</span>
<span class="keyword1"><span class="command">translations</span></span> <span class="quoted">"<span class="keyword1">sprint3</span> <span class="free">x</span><span class="main">´</span>"</span> <span class="main">⇌</span> <span class="quoted">"<span class="keyword1">CONST</span> sprintf3 <span class="free">x</span>"</span>

<span class="keyword1"><span class="command">syntax</span></span> <span class="quoted">"_sprint4"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> ml_string"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">sprint4</span> <span class="keyword3">(</span>_<span class="keyword3">)</span><span class="keyword1">´</span>"</span><span class="main">)</span>
<span class="keyword1"><span class="command">translations</span></span> <span class="quoted">"<span class="keyword1">sprint4</span> <span class="free">x</span><span class="main">´</span>"</span> <span class="main">⇌</span> <span class="quoted">"<span class="keyword1">CONST</span> sprintf4 <span class="free">x</span>"</span>

<span class="keyword1"><span class="command">syntax</span></span> <span class="quoted">"_sprint5"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> ml_string"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">sprint5</span> <span class="keyword3">(</span>_<span class="keyword3">)</span><span class="keyword1">´</span>"</span><span class="main">)</span>
<span class="keyword1"><span class="command">translations</span></span> <span class="quoted">"<span class="keyword1">sprint5</span> <span class="free">x</span><span class="main">´</span>"</span> <span class="main">⇌</span> <span class="quoted">"<span class="keyword1">CONST</span> sprintf5 <span class="free">x</span>"</span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Some Notations (II): Polymorphic Cartouches›</span></span>

<span class="keyword1"><span class="command">syntax</span></span> <span class="quoted">"_cartouche_string'"</span> <span class="main">::</span> <span class="quoted">String.literal</span>
<span class="keyword1"><span class="command">translations</span></span> <span class="quoted">"_cartouche_string"</span> <span class="main">⇌</span> <span class="quoted">"_cartouche_string'"</span>

<span class="keyword1"><span class="command">parse_translation</span></span> <span class="quoted">‹
  <span class="main">[</span><span class="main">(</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">syntax_const</span> "_cartouche_string'"<span class="antiquote">}</span></span>
   <span class="main">,</span> <span class="entity">parse_translation_cartouche</span>
       <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">binding</span> cartouche_type'<span class="antiquote">}</span></span></span>
       <span class="main">(</span><span class="main">(</span> <span class="inner_quoted">"fun<span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>f</sub>"</span>
        <span class="main">,</span> <span class="main">(</span> <span class="entity">Cartouche_Grammar.nil1</span>
          <span class="main">,</span> <span class="entity">Cartouche_Grammar.cons1</span>
          <span class="main">,</span> <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">f</span> <span class="entity">c</span> <span class="entity">x</span> <span class="main">=</span> Syntax.const <span class="entity">c</span> $ <span class="entity">x</span> <span class="keyword2"><span class="keyword">in</span></span>
            <span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="inner_numeral">0</span><span class="main">,</span> <span class="entity">x</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">x</span>
             <span class="main">|</span> <span class="main">(</span><span class="inner_numeral">1</span><span class="main">,</span> <span class="entity">x</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">f</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_syntax</span> sprintf1<span class="antiquote">}</span></span> <span class="entity">x</span>
             <span class="main">|</span> <span class="main">(</span><span class="inner_numeral">2</span><span class="main">,</span> <span class="entity">x</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">f</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_syntax</span> sprintf2<span class="antiquote">}</span></span> <span class="entity">x</span>
             <span class="main">|</span> <span class="main">(</span><span class="inner_numeral">3</span><span class="main">,</span> <span class="entity">x</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">f</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_syntax</span> sprintf3<span class="antiquote">}</span></span> <span class="entity">x</span>
             <span class="main">|</span> <span class="main">(</span><span class="inner_numeral">4</span><span class="main">,</span> <span class="entity">x</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">f</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_syntax</span> sprintf4<span class="antiquote">}</span></span> <span class="entity">x</span>
             <span class="main">|</span> <span class="main">(</span><span class="inner_numeral">5</span><span class="main">,</span> <span class="entity">x</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">f</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_syntax</span> sprintf5<span class="antiquote">}</span></span> <span class="entity">x</span>
            <span class="keyword2"><span class="keyword">end</span></span><span class="main">)</span><span class="main">)</span>
        :: <span class="entity">Cartouche_Grammar.default</span><span class="main">)</span>
       <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="inner_numeral">37</span> <span class="comment1">― ‹<span class="antiquoted"><span class="operator">▩</span><span class="raw_text">‹#"%"›</span></span>›</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">x</span> <span class="main">=&gt;</span> <span class="entity">x</span> + <span class="inner_numeral">1</span><span class="main">)</span>
         <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> I<span class="main">)</span>
       <span class="inner_numeral">0</span><span class="main">)</span><span class="main">]</span>
›</span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Generic Locale for Printing›</span></span>

<span class="keyword1"><span class="command">locale</span></span> Print <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">To_string</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="keyword1">string</span> <span class="main">⇒</span> ml_string"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">To_nat</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="keyword1">nat</span> <span class="main">⇒</span> ml_int"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword1"><span class="command">declare</span></span><span class="main">[</span><span class="main">[</span><span class="operator">cartouche_type'</span> <span class="main"><span class="main">=</span></span> <span class="quoted">"fun<span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>f</sub>"</span><span class="main">]</span><span class="main">]</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹As remark, printing functions (like <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">sprintf5</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>...) are currently 
weakly typed in Isabelle, we will continue the typing using the type system of target languages.›</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Printer_Pure">
<div class="head">
<h1>Theory Printer_Pure</h1>
</div>
<pre class="source"><span class="comment1">(******************************************************************************
 * A Meta-Model for the Isabelle API
 *
 * Copyright (c) 2011-2018 Université Paris-Saclay, Univ. Paris-Sud, France
 *               2013-2017 IRT SystemX, France
 *               2011-2015 Achim D. Brucker, Germany
 *               2016-2018 The University of Sheffield, UK
 *               2016-2017 Nanyang Technological University, Singapore
 *               2017-2018 Virginia Tech, USA
 *
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are
 * met:
 *
 *     * Redistributions of source code must retain the above copyright
 *       notice, this list of conditions and the following disclaimer.
 *
 *     * Redistributions in binary form must reproduce the above
 *       copyright notice, this list of conditions and the following
 *       disclaimer in the documentation and/or other materials provided
 *       with the distribution.
 *
 *     * Neither the name of the copyright holders nor the names of its
 *       contributors may be used to endorse or promote products derived
 *       from this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 ******************************************************************************)</span>

<span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹Instantiating the Printer for (Pure) Term›</span></span>

<span class="keyword1"><span class="command">theory</span></span>  Printer_Pure
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Meta_Pure.html">Meta_Pure</a>
        <a href="Printer_init.html">Printer_init</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">context</span></span> Print
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">of_pure_term</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">of_pure_term</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span>
    Const <span class="bound">s</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="free">To_string</span> <span class="bound">s</span>
  <span class="main">|</span> Free <span class="bound">s</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="free">To_string</span> <span class="bound">s</span>
  <span class="main">|</span> App <span class="bound">t1</span> <span class="bound">t2</span> <span class="main">⇒</span> <span class="inner_cartouche">‹(%s) (%s)›</span> <span class="main">(</span><span class="free">of_pure_term</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="bound">t1</span><span class="main">)</span> <span class="main">(</span><span class="free">of_pure_term</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="bound">t2</span><span class="main">)</span>
  <span class="main">|</span> Abs <span class="bound">s</span> <span class="main"><span class="bound">_</span></span> <span class="bound">t</span> <span class="main">⇒</span>
      <span class="keyword1">let</span> <span class="bound">s</span> <span class="main">=</span> <span class="free">To_string</span> <span class="bound">s</span> <span class="keyword1">in</span>
      <span class="inner_cartouche">‹(λ %s. %s)›</span> <span class="bound">s</span> <span class="main">(</span><span class="free">of_pure_term</span> <span class="main">(</span><span class="bound">s</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="bound">t</span><span class="main">)</span>
  <span class="main">|</span> Bound <span class="bound">n</span> <span class="main">⇒</span> <span class="inner_cartouche">‹%s›</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">!</span> nat_of_natural <span class="bound">n</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">code</span><span class="main">]</span> <span class="main">=</span>
  <span class="comment1">― ‹def›</span>
  <span class="comment1">― ‹fun›</span>
  Print.of_pure_term.simps

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Printer_SML">
<div class="head">
<h1>Theory Printer_SML</h1>
</div>
<pre class="source"><span class="comment1">(******************************************************************************
 * A Meta-Model for the Isabelle API
 *
 * Copyright (c) 2011-2018 Université Paris-Saclay, Univ. Paris-Sud, France
 *               2013-2017 IRT SystemX, France
 *               2011-2015 Achim D. Brucker, Germany
 *               2016-2018 The University of Sheffield, UK
 *               2016-2017 Nanyang Technological University, Singapore
 *               2017-2018 Virginia Tech, USA
 *
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are
 * met:
 *
 *     * Redistributions of source code must retain the above copyright
 *       notice, this list of conditions and the following disclaimer.
 *
 *     * Redistributions in binary form must reproduce the above
 *       copyright notice, this list of conditions and the following
 *       disclaimer in the documentation and/or other materials provided
 *       with the distribution.
 *
 *     * Neither the name of the copyright holders nor the names of its
 *       contributors may be used to endorse or promote products derived
 *       from this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 ******************************************************************************)</span>

<span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹Instantiating the Printer for SML›</span></span>

<span class="keyword1"><span class="command">theory</span></span>  Printer_SML
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Meta_SML.html">Meta_SML</a>
        <a href="Printer_init.html">Printer_init</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">context</span></span> Print
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">of_semi__val_fun</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> Sval <span class="main">⇒</span> <span class="inner_cartouche">‹val›</span>
                                <span class="main">|</span> Sfun <span class="main">⇒</span> <span class="inner_cartouche">‹fun›</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">of_semi__term'</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">‹<span class="free">of_semi__term'</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span>
    SML_string <span class="bound">s</span> <span class="main">⇒</span> <span class="inner_cartouche">‹"%s"›</span> <span class="main">(</span><span class="free">To_string</span> <span class="main">(</span>escape_sml <span class="bound">s</span><span class="main">)</span><span class="main">)</span>
  <span class="main">|</span> SML_rewrite <span class="bound">val_fun</span> <span class="bound">e1</span> <span class="bound">symb</span> <span class="bound">e2</span> <span class="main">⇒</span> <span class="inner_cartouche">‹%s %s %s %s›</span> <span class="main">(</span>of_semi__val_fun <span class="bound">val_fun</span><span class="main">)</span> <span class="main">(</span><span class="free">of_semi__term'</span> <span class="bound">e1</span><span class="main">)</span> <span class="main">(</span><span class="free">To_string</span> <span class="bound">symb</span><span class="main">)</span> <span class="main">(</span><span class="free">of_semi__term'</span> <span class="bound">e2</span><span class="main">)</span>
  <span class="main">|</span> SML_basic <span class="bound">l</span> <span class="main">⇒</span> <span class="inner_cartouche">‹%s›</span> <span class="main">(</span>String_concat <span class="inner_cartouche">‹ ›</span> <span class="main">(</span>L.map <span class="free">To_string</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span>
  <span class="main">|</span> SML_binop <span class="bound">e1</span> <span class="bound">s</span> <span class="bound">e2</span> <span class="main">⇒</span> <span class="inner_cartouche">‹%s %s %s›</span> <span class="main">(</span><span class="free">of_semi__term'</span> <span class="bound">e1</span><span class="main">)</span> <span class="main">(</span><span class="free">of_semi__term'</span> <span class="main">(</span>SML_basic <span class="main">[</span><span class="bound">s</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">of_semi__term'</span> <span class="bound">e2</span><span class="main">)</span>
  <span class="main">|</span> SML_annot <span class="bound">e</span> <span class="bound">s</span> <span class="main">⇒</span> <span class="inner_cartouche">‹(%s:%s)›</span> <span class="main">(</span><span class="free">of_semi__term'</span> <span class="bound">e</span><span class="main">)</span> <span class="main">(</span><span class="free">To_string</span> <span class="bound">s</span><span class="main">)</span>
  <span class="main">|</span> SML_function <span class="bound">l</span> <span class="main">⇒</span> <span class="inner_cartouche">‹(fn %s)›</span> <span class="main">(</span>String_concat <span class="inner_cartouche">‹
    | ›</span> <span class="main">(</span>List.map <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">s1</span><span class="main">,</span> <span class="bound">s2</span><span class="main">)</span> <span class="main">⇒</span> <span class="inner_cartouche">‹%s =&gt; %s›</span> <span class="main">(</span><span class="free">of_semi__term'</span> <span class="bound">s1</span><span class="main">)</span> <span class="main">(</span><span class="free">of_semi__term'</span> <span class="bound">s2</span><span class="main">)</span><span class="main">)</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span>
  <span class="main">|</span> SML_apply <span class="bound">e</span> <span class="bound">l</span> <span class="main">⇒</span> <span class="inner_cartouche">‹(%s %s)›</span> <span class="main">(</span><span class="free">of_semi__term'</span> <span class="bound">e</span><span class="main">)</span> <span class="main">(</span>String_concat <span class="inner_cartouche">‹ ›</span> <span class="main">(</span>List.map <span class="main">(</span><span class="main">λ</span> <span class="bound">e</span> <span class="main">⇒</span> <span class="inner_cartouche">‹(%s)›</span> <span class="main">(</span><span class="free">of_semi__term'</span> <span class="bound">e</span><span class="main">)</span><span class="main">)</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span>
  <span class="main">|</span> SML_paren <span class="bound">p_left</span> <span class="bound">p_right</span> <span class="bound">e</span> <span class="main">⇒</span> <span class="inner_cartouche">‹%s%s%s›</span> <span class="main">(</span><span class="free">To_string</span> <span class="bound">p_left</span><span class="main">)</span> <span class="main">(</span><span class="free">of_semi__term'</span> <span class="bound">e</span><span class="main">)</span> <span class="main">(</span><span class="free">To_string</span> <span class="bound">p_right</span><span class="main">)</span>
  <span class="main">|</span> SML_let_open <span class="bound">s</span> <span class="bound">e</span> <span class="main">⇒</span> <span class="inner_cartouche">‹let open %s in %s end›</span> <span class="main">(</span><span class="free">To_string</span> <span class="bound">s</span><span class="main">)</span> <span class="main">(</span><span class="free">of_semi__term'</span> <span class="bound">e</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span>›</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">code</span><span class="main">]</span> <span class="main">=</span>
  <span class="comment1">― ‹def›</span>
  Print.of_semi__val_fun_def
  <span class="comment1">― ‹fun›</span>
  Print.of_semi__term'.simps

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Printer_Isabelle">
<div class="head">
<h1>Theory Printer_Isabelle</h1>
</div>
<pre class="source"><span class="comment1">(******************************************************************************
 * A Meta-Model for the Isabelle API
 *
 * Copyright (c) 2011-2018 Université Paris-Saclay, Univ. Paris-Sud, France
 *               2013-2017 IRT SystemX, France
 *               2011-2015 Achim D. Brucker, Germany
 *               2016-2018 The University of Sheffield, UK
 *               2016-2017 Nanyang Technological University, Singapore
 *               2017-2018 Virginia Tech, USA
 *
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are
 * met:
 *
 *     * Redistributions of source code must retain the above copyright
 *       notice, this list of conditions and the following disclaimer.
 *
 *     * Redistributions in binary form must reproduce the above
 *       copyright notice, this list of conditions and the following
 *       disclaimer in the documentation and/or other materials provided
 *       with the distribution.
 *
 *     * Neither the name of the copyright holders nor the names of its
 *       contributors may be used to endorse or promote products derived
 *       from this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 ******************************************************************************)</span>

<span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹Instantiating the Printer for Isabelle›</span></span>

<span class="keyword1"><span class="command">theory</span></span>  Printer_Isabelle
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Meta_Isabelle.html">Meta_Isabelle</a>
        <a href="Printer_Pure.html">Printer_Pure</a>
        <a href="Printer_SML.html">Printer_SML</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">context</span></span> Print
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">of_semi__typ</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">of_semi__typ</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span>
    Typ_base <span class="bound">s</span> <span class="main">⇒</span> <span class="free">To_string</span> <span class="bound">s</span>
  <span class="main">|</span> Typ_apply <span class="bound">name</span> <span class="bound">l</span> <span class="main">⇒</span> <span class="inner_cartouche">‹%s %s›</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">s</span> <span class="main">=</span> String_concat <span class="inner_cartouche">‹, ›</span> <span class="main">(</span>List.map <span class="free">of_semi__typ</span> <span class="bound">l</span><span class="main">)</span> <span class="keyword1">in</span>
                                 <span class="keyword1">case</span> <span class="bound">l</span> <span class="keyword1">of</span> <span class="main">[</span><span class="main"><span class="bound">_</span></span><span class="main">]</span> <span class="main">⇒</span> <span class="bound">s</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="inner_cartouche">‹(%s)›</span> <span class="bound">s</span><span class="main">)</span>
                                <span class="main">(</span><span class="free">of_semi__typ</span> <span class="bound">name</span><span class="main">)</span>
  <span class="main">|</span> Typ_apply_bin <span class="bound">s</span> <span class="bound">ty1</span> <span class="bound">ty2</span> <span class="main">⇒</span> <span class="inner_cartouche">‹%s %s %s›</span> <span class="main">(</span><span class="free">of_semi__typ</span> <span class="bound">ty1</span><span class="main">)</span> <span class="main">(</span><span class="free">To_string</span> <span class="bound">s</span><span class="main">)</span> <span class="main">(</span><span class="free">of_semi__typ</span> <span class="bound">ty2</span><span class="main">)</span>
  <span class="main">|</span> Typ_apply_paren <span class="bound">s1</span> <span class="bound">s2</span> <span class="bound">ty</span> <span class="main">⇒</span> <span class="inner_cartouche">‹%s%s%s›</span> <span class="main">(</span><span class="free">To_string</span> <span class="bound">s1</span><span class="main">)</span> <span class="main">(</span><span class="free">of_semi__typ</span> <span class="bound">ty</span><span class="main">)</span> <span class="main">(</span><span class="free">To_string</span> <span class="bound">s2</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">of_datatype</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> Datatype <span class="bound">n</span> <span class="bound">l</span> <span class="main">⇒</span>
  <span class="inner_cartouche">‹datatype %s = %s›</span>
    <span class="main">(</span><span class="free">To_string</span> <span class="bound">n</span><span class="main">)</span>
    <span class="main">(</span>String_concat <span class="inner_cartouche">‹
                        | ›</span>
      <span class="main">(</span>L.map
        <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">n</span><span class="main">,</span><span class="bound">l</span><span class="main">)</span><span class="main">.</span>
         <span class="inner_cartouche">‹%s %s›</span>
           <span class="main">(</span><span class="free">To_string</span> <span class="bound">n</span><span class="main">)</span>
           <span class="main">(</span>String_concat <span class="inner_cartouche">‹ ›</span> <span class="main">(</span>L.map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="inner_cartouche">‹\"%s\"›</span> <span class="main">(</span>of_semi__typ <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="bound">l</span><span class="main">)</span> <span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">of_type_synonym</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> Type_synonym <span class="bound">n</span> <span class="bound">v</span> <span class="bound">l</span> <span class="main">⇒</span>
  <span class="inner_cartouche">‹type_synonym %s = \"%s\"›</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">v</span> <span class="main">=</span> <span class="main">[]</span> <span class="keyword1">then</span> 
                                <span class="free">To_string</span> <span class="bound">n</span>
                              <span class="keyword1">else</span>
                                of_semi__typ <span class="main">(</span>Typ_apply <span class="main">(</span>Typ_base <span class="bound">n</span><span class="main">)</span> <span class="main">(</span>L.map Typ_base <span class="bound">v</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
                             <span class="main">(</span>of_semi__typ <span class="bound">l</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">of_semi__term</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">of_semi__term</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span>
    Term_rewrite <span class="bound">e1</span> <span class="bound">symb</span> <span class="bound">e2</span> <span class="main">⇒</span> <span class="inner_cartouche">‹%s %s %s›</span> <span class="main">(</span><span class="free">of_semi__term</span> <span class="bound">e1</span><span class="main">)</span> <span class="main">(</span><span class="free">To_string</span> <span class="bound">symb</span><span class="main">)</span> <span class="main">(</span><span class="free">of_semi__term</span> <span class="bound">e2</span><span class="main">)</span>
  <span class="main">|</span> Term_basic <span class="bound">l</span> <span class="main">⇒</span> <span class="inner_cartouche">‹%s›</span> <span class="main">(</span>String_concat <span class="inner_cartouche">‹ ›</span> <span class="main">(</span>L.map <span class="free">To_string</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span>
  <span class="main">|</span> Term_annot <span class="bound">e</span> <span class="bound">s</span> <span class="main">⇒</span> <span class="inner_cartouche">‹(%s::%s)›</span> <span class="main">(</span><span class="free">of_semi__term</span> <span class="bound">e</span><span class="main">)</span> <span class="main">(</span>of_semi__typ <span class="bound">s</span><span class="main">)</span>
  <span class="main">|</span> Term_bind <span class="bound">symb</span> <span class="bound">e1</span> <span class="bound">e2</span> <span class="main">⇒</span> <span class="inner_cartouche">‹(%s%s. %s)›</span> <span class="main">(</span><span class="free">To_string</span> <span class="bound">symb</span><span class="main">)</span> <span class="main">(</span><span class="free">of_semi__term</span> <span class="bound">e1</span><span class="main">)</span> <span class="main">(</span><span class="free">of_semi__term</span> <span class="bound">e2</span><span class="main">)</span>
  <span class="main">|</span> Term_fun_case <span class="bound">e_case</span> <span class="bound">l</span> <span class="main">⇒</span> <span class="inner_cartouche">‹(%s %s)›</span>
      <span class="main">(</span><span class="keyword1">case</span> <span class="bound">e_case</span> <span class="keyword1">of</span> None <span class="main">⇒</span> <span class="inner_cartouche">‹λ›</span>
                    <span class="main">|</span> Some <span class="bound">e</span> <span class="main">⇒</span> <span class="inner_cartouche">‹case %s of›</span> <span class="main">(</span><span class="free">of_semi__term</span> <span class="bound">e</span><span class="main">)</span><span class="main">)</span>
      <span class="main">(</span>String_concat <span class="inner_cartouche">‹
    | ›</span> <span class="main">(</span>List.map <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">s1</span><span class="main">,</span> <span class="bound">s2</span><span class="main">)</span> <span class="main">⇒</span> <span class="inner_cartouche">‹%s ⇒ %s›</span> <span class="main">(</span><span class="free">of_semi__term</span> <span class="bound">s1</span><span class="main">)</span> <span class="main">(</span><span class="free">of_semi__term</span> <span class="bound">s2</span><span class="main">)</span><span class="main">)</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span>
  <span class="main">|</span> Term_apply <span class="bound">e</span> <span class="bound">l</span> <span class="main">⇒</span> <span class="inner_cartouche">‹%s %s›</span> <span class="main">(</span><span class="free">of_semi__term</span> <span class="bound">e</span><span class="main">)</span> <span class="main">(</span>String_concat <span class="inner_cartouche">‹ ›</span> <span class="main">(</span>List.map <span class="main">(</span><span class="main">λ</span> <span class="bound">e</span> <span class="main">⇒</span> <span class="inner_cartouche">‹%s›</span> <span class="main">(</span><span class="free">of_semi__term</span> <span class="bound">e</span><span class="main">)</span><span class="main">)</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span>
  <span class="main">|</span> Term_paren <span class="bound">p_left</span> <span class="bound">p_right</span> <span class="bound">e</span> <span class="main">⇒</span> <span class="inner_cartouche">‹%s%s%s›</span> <span class="main">(</span><span class="free">To_string</span> <span class="bound">p_left</span><span class="main">)</span> <span class="main">(</span><span class="free">of_semi__term</span> <span class="bound">e</span><span class="main">)</span> <span class="main">(</span><span class="free">To_string</span> <span class="bound">p_right</span><span class="main">)</span>
  <span class="main">|</span> Term_if_then_else <span class="bound">e_if</span> <span class="bound">e_then</span> <span class="bound">e_else</span> <span class="main">⇒</span> <span class="inner_cartouche">‹if %s then %s else %s›</span> <span class="main">(</span><span class="free">of_semi__term</span> <span class="bound">e_if</span><span class="main">)</span> <span class="main">(</span><span class="free">of_semi__term</span> <span class="bound">e_then</span><span class="main">)</span> <span class="main">(</span><span class="free">of_semi__term</span> <span class="bound">e_else</span><span class="main">)</span>
  <span class="main">|</span> Term_term <span class="bound">l</span> <span class="bound">pure</span> <span class="main">⇒</span> of_pure_term <span class="main">(</span>L.map <span class="free">To_string</span> <span class="bound">l</span><span class="main">)</span> <span class="bound">pure</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">of_type_notation</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> Type_notation <span class="bound">n</span> <span class="bound">e</span> <span class="main">⇒</span>
  <span class="inner_cartouche">‹type_notation %s (\"%s\")›</span> <span class="main">(</span><span class="free">To_string</span> <span class="bound">n</span><span class="main">)</span> <span class="main">(</span><span class="free">To_string</span> <span class="bound">e</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">of_instantiation</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> Instantiation <span class="bound">n</span> <span class="bound">n_def</span> <span class="bound">expr</span> <span class="main">⇒</span>
  <span class="keyword1">let</span> <span class="bound">name</span> <span class="main">=</span> <span class="free">To_string</span> <span class="bound">n</span> <span class="keyword1">in</span>
  <span class="inner_cartouche">‹instantiation %s :: object
begin
  definition %s_%s_def : \"%s\"
  instance ..
end›</span>
    <span class="bound">name</span>
    <span class="main">(</span><span class="free">To_string</span> <span class="bound">n_def</span><span class="main">)</span>
    <span class="bound">name</span>
    <span class="main">(</span>of_semi__term <span class="bound">expr</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">of_overloading</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> Overloading <span class="bound">n_c</span> <span class="bound">e_c</span> <span class="bound">n</span> <span class="bound">e</span> <span class="main">⇒</span>
  <span class="inner_cartouche">‹overloading %s ≡ \"%s\"
begin
  definition %s : \"%s\"
end›</span> <span class="main">(</span><span class="free">To_string</span> <span class="bound">n_c</span><span class="main">)</span> <span class="main">(</span>of_semi__term <span class="bound">e_c</span><span class="main">)</span> <span class="main">(</span><span class="free">To_string</span> <span class="bound">n</span><span class="main">)</span> <span class="main">(</span>of_semi__term <span class="bound">e</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">of_consts</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> Consts <span class="bound">n</span> <span class="bound">ty</span> <span class="bound">symb</span> <span class="main">⇒</span>
  <span class="inner_cartouche">‹consts %s :: \"%s\" (\"%s %s\")›</span> <span class="main">(</span><span class="free">To_string</span> <span class="bound">n</span><span class="main">)</span> <span class="main">(</span>of_semi__typ <span class="bound">ty</span><span class="main">)</span> <span class="main">(</span><span class="free">To_string</span> Consts_value<span class="main">)</span> <span class="main">(</span><span class="free">To_string</span> <span class="bound">symb</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">of_definition</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span>
    Definition <span class="bound">e</span> <span class="main">⇒</span> <span class="inner_cartouche">‹definition \"%s\"›</span> <span class="main">(</span>of_semi__term <span class="bound">e</span><span class="main">)</span>
  <span class="main">|</span> Definition_where1 <span class="bound">name</span> <span class="main">(</span><span class="bound">abbrev</span><span class="main">,</span> <span class="bound">prio</span><span class="main">)</span> <span class="bound">e</span> <span class="main">⇒</span> <span class="inner_cartouche">‹definition %s (\"(1%s)\" %d)
  where \"%s\"›</span> <span class="main">(</span><span class="free">To_string</span> <span class="bound">name</span><span class="main">)</span> <span class="main">(</span>of_semi__term <span class="bound">abbrev</span><span class="main">)</span> <span class="main">(</span><span class="free">To_nat</span> <span class="bound">prio</span><span class="main">)</span> <span class="main">(</span>of_semi__term <span class="bound">e</span><span class="main">)</span>
  <span class="main">|</span> Definition_where2 <span class="bound">name</span> <span class="bound">abbrev</span> <span class="bound">e</span> <span class="main">⇒</span> <span class="inner_cartouche">‹definition %s (\"%s\")
  where \"%s\"›</span> <span class="main">(</span><span class="free">To_string</span> <span class="bound">name</span><span class="main">)</span> <span class="main">(</span>of_semi__term <span class="bound">abbrev</span><span class="main">)</span> <span class="main">(</span>of_semi__term <span class="bound">e</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">of_semi__thm_attribute_aux_gen</span> <span class="main">::</span> String.literal <span class="main">×</span> String.literal <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">lacc</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> 
 <span class="main">(</span><span class="keyword1">let</span> <span class="bound">s_base</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span> <span class="bound">lacc</span><span class="main">.</span> <span class="inner_cartouche">‹%s[%s]›</span> <span class="main">(</span><span class="free">To_string</span> <span class="bound">s</span><span class="main">)</span> <span class="main">(</span>String_concat <span class="inner_cartouche">‹, ›</span> <span class="main">(</span>L.map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span><span class="main">.</span> <span class="inner_cartouche">‹%s %s›</span> <span class="bound">s</span> <span class="bound">x</span><span class="main">)</span> <span class="bound">lacc</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">in</span>
  <span class="bound">s_base</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">lacc</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">of_semi__thm_attribute_aux_gen_where</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span> 
 <span class="main">(</span><span class="inner_cartouche">‹where›</span><span class="main">,</span> String_concat <span class="inner_cartouche">‹ and ›</span> <span class="main">(</span>L.map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">var</span><span class="main">,</span> <span class="bound">expr</span><span class="main">)</span><span class="main">.</span> <span class="inner_cartouche">‹%s = \"%s\"›</span>
                                                          <span class="main">(</span><span class="free">To_string</span> <span class="bound">var</span><span class="main">)</span>
                                                          <span class="main">(</span>of_semi__term <span class="bound">expr</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">of_semi__thm_attribute_aux_gen_of</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span>
 <span class="main">(</span><span class="inner_cartouche">‹of›</span><span class="main">,</span> String_concat <span class="inner_cartouche">‹ ›</span> <span class="main">(</span>L.map <span class="main">(</span><span class="main">λ</span><span class="bound">expr</span><span class="main">.</span> <span class="inner_cartouche">‹\"%s\"›</span> <span class="main">(</span>of_semi__term <span class="bound">expr</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="comment1">(* NOTE all 'let' declarations can be put at the beginning *)</span>
   <span class="comment1">(*let f_where = (λl. (‹where›, String_concat ‹ and ›
                                        (L.map (λ(var, expr). ‹%s = \"%s\"›
                                                        (To_string var)
                                                        (of_semi__term expr)) l)))
     ; f_of = (λl. (‹of›, String_concat ‹ ›
                                  (L.map (λexpr. ‹\"%s\"›
                                                        (of_semi__term expr)) l)))
     ; f_symmetric = (‹symmetric›, ‹›)
     ; s_base = (λs lacc. ‹%s[%s]› (To_string s) (String_concat ‹, › (L.map (λ(s, x). ‹%s %s› s x) lacc))) in
   *)</span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">of_semi__thm_attribute_aux</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">of_semi__thm_attribute_aux</span> <span class="free"><span class="bound"><span class="entity">lacc</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span>
  <span class="main">(</span><span class="main">λ</span> Thm_thm <span class="bound">s</span> <span class="main">⇒</span> <span class="free">To_string</span> <span class="bound">s</span>
   <span class="main">|</span> Thm_thms <span class="bound">s</span> <span class="main">⇒</span> <span class="free">To_string</span> <span class="bound">s</span>

   <span class="main">|</span> Thm_THEN <span class="main">(</span>Thm_thm <span class="bound">s</span><span class="main">)</span> <span class="bound">e2</span> <span class="main">⇒</span> of_semi__thm_attribute_aux_gen <span class="main">(</span><span class="inner_cartouche">‹THEN›</span><span class="main">,</span> <span class="free">of_semi__thm_attribute_aux</span> <span class="main">[]</span> <span class="bound">e2</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">lacc</span></span></span> <span class="bound">s</span>
   <span class="main">|</span> Thm_THEN <span class="main">(</span>Thm_thms <span class="bound">s</span><span class="main">)</span> <span class="bound">e2</span> <span class="main">⇒</span> of_semi__thm_attribute_aux_gen <span class="main">(</span><span class="inner_cartouche">‹THEN›</span><span class="main">,</span> <span class="free">of_semi__thm_attribute_aux</span> <span class="main">[]</span> <span class="bound">e2</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">lacc</span></span></span> <span class="bound">s</span>
   <span class="main">|</span> Thm_THEN <span class="bound">e1</span> <span class="bound">e2</span> <span class="main">⇒</span> <span class="free">of_semi__thm_attribute_aux</span> <span class="main">(</span><span class="main">(</span><span class="inner_cartouche">‹THEN›</span><span class="main">,</span> <span class="free">of_semi__thm_attribute_aux</span> <span class="main">[]</span> <span class="bound">e2</span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">lacc</span></span></span><span class="main">)</span> <span class="bound">e1</span>

   <span class="main">|</span> Thm_simplified <span class="main">(</span>Thm_thm <span class="bound">s</span><span class="main">)</span> <span class="bound">e2</span> <span class="main">⇒</span> of_semi__thm_attribute_aux_gen <span class="main">(</span><span class="inner_cartouche">‹simplified›</span><span class="main">,</span> <span class="free">of_semi__thm_attribute_aux</span> <span class="main">[]</span> <span class="bound">e2</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">lacc</span></span></span> <span class="bound">s</span>
   <span class="main">|</span> Thm_simplified <span class="main">(</span>Thm_thms <span class="bound">s</span><span class="main">)</span> <span class="bound">e2</span> <span class="main">⇒</span> of_semi__thm_attribute_aux_gen <span class="main">(</span><span class="inner_cartouche">‹simplified›</span><span class="main">,</span> <span class="free">of_semi__thm_attribute_aux</span> <span class="main">[]</span> <span class="bound">e2</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">lacc</span></span></span> <span class="bound">s</span>
   <span class="main">|</span> Thm_simplified <span class="bound">e1</span> <span class="bound">e2</span> <span class="main">⇒</span> <span class="free">of_semi__thm_attribute_aux</span> <span class="main">(</span><span class="main">(</span><span class="inner_cartouche">‹simplified›</span><span class="main">,</span> <span class="free">of_semi__thm_attribute_aux</span> <span class="main">[]</span> <span class="bound">e2</span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">lacc</span></span></span><span class="main">)</span> <span class="bound">e1</span>

   <span class="main">|</span> Thm_symmetric <span class="main">(</span>Thm_thm <span class="bound">s</span><span class="main">)</span> <span class="main">⇒</span> of_semi__thm_attribute_aux_gen <span class="main">(</span><span class="inner_cartouche">‹symmetric›</span><span class="main">,</span> <span class="inner_cartouche">‹›</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">lacc</span></span></span> <span class="bound">s</span> 
   <span class="main">|</span> Thm_symmetric <span class="main">(</span>Thm_thms <span class="bound">s</span><span class="main">)</span> <span class="main">⇒</span> of_semi__thm_attribute_aux_gen <span class="main">(</span><span class="inner_cartouche">‹symmetric›</span><span class="main">,</span> <span class="inner_cartouche">‹›</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">lacc</span></span></span> <span class="bound">s</span>
   <span class="main">|</span> Thm_symmetric <span class="bound">e1</span> <span class="main">⇒</span> <span class="free">of_semi__thm_attribute_aux</span> <span class="main">(</span><span class="main">(</span><span class="inner_cartouche">‹symmetric›</span><span class="main">,</span> <span class="inner_cartouche">‹›</span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">lacc</span></span></span><span class="main">)</span> <span class="bound">e1</span>

   <span class="main">|</span> Thm_where <span class="main">(</span>Thm_thm <span class="bound">s</span><span class="main">)</span> <span class="bound">l</span> <span class="main">⇒</span> of_semi__thm_attribute_aux_gen <span class="main">(</span>of_semi__thm_attribute_aux_gen_where <span class="bound">l</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">lacc</span></span></span> <span class="bound">s</span>
   <span class="main">|</span> Thm_where <span class="main">(</span>Thm_thms <span class="bound">s</span><span class="main">)</span> <span class="bound">l</span> <span class="main">⇒</span> of_semi__thm_attribute_aux_gen <span class="main">(</span>of_semi__thm_attribute_aux_gen_where <span class="bound">l</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">lacc</span></span></span> <span class="bound">s</span>
   <span class="main">|</span> Thm_where <span class="bound">e1</span> <span class="bound">l</span> <span class="main">⇒</span> <span class="free">of_semi__thm_attribute_aux</span> <span class="main">(</span>of_semi__thm_attribute_aux_gen_where <span class="bound">l</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">lacc</span></span></span><span class="main">)</span> <span class="bound">e1</span>

   <span class="main">|</span> Thm_of <span class="main">(</span>Thm_thm <span class="bound">s</span><span class="main">)</span> <span class="bound">l</span> <span class="main">⇒</span> of_semi__thm_attribute_aux_gen <span class="main">(</span>of_semi__thm_attribute_aux_gen_of <span class="bound">l</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">lacc</span></span></span> <span class="bound">s</span>
   <span class="main">|</span> Thm_of <span class="main">(</span>Thm_thms <span class="bound">s</span><span class="main">)</span> <span class="bound">l</span> <span class="main">⇒</span> of_semi__thm_attribute_aux_gen <span class="main">(</span>of_semi__thm_attribute_aux_gen_of <span class="bound">l</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">lacc</span></span></span> <span class="bound">s</span>
   <span class="main">|</span> Thm_of <span class="bound">e1</span> <span class="bound">l</span> <span class="main">⇒</span> <span class="free">of_semi__thm_attribute_aux</span> <span class="main">(</span>of_semi__thm_attribute_aux_gen_of <span class="bound">l</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">lacc</span></span></span><span class="main">)</span> <span class="bound">e1</span>

   <span class="main">|</span> Thm_OF <span class="main">(</span>Thm_thm <span class="bound">s</span><span class="main">)</span> <span class="bound">e2</span> <span class="main">⇒</span> of_semi__thm_attribute_aux_gen <span class="main">(</span><span class="inner_cartouche">‹OF›</span><span class="main">,</span> <span class="free">of_semi__thm_attribute_aux</span> <span class="main">[]</span> <span class="bound">e2</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">lacc</span></span></span> <span class="bound">s</span>
   <span class="main">|</span> Thm_OF <span class="main">(</span>Thm_thms <span class="bound">s</span><span class="main">)</span> <span class="bound">e2</span> <span class="main">⇒</span> of_semi__thm_attribute_aux_gen <span class="main">(</span><span class="inner_cartouche">‹OF›</span><span class="main">,</span> <span class="free">of_semi__thm_attribute_aux</span> <span class="main">[]</span> <span class="bound">e2</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">lacc</span></span></span> <span class="bound">s</span>
   <span class="main">|</span> Thm_OF <span class="bound">e1</span> <span class="bound">e2</span> <span class="main">⇒</span> <span class="free">of_semi__thm_attribute_aux</span> <span class="main">(</span><span class="main">(</span><span class="inner_cartouche">‹OF›</span><span class="main">,</span> <span class="free">of_semi__thm_attribute_aux</span> <span class="main">[]</span> <span class="bound">e2</span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">lacc</span></span></span><span class="main">)</span> <span class="bound">e1</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">of_semi__thm_attribute</span> <span class="main">=</span> of_semi__thm_attribute_aux <span class="main">[]</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">of_semi__thm</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> Thms_single <span class="bound">thy</span> <span class="main">⇒</span> of_semi__thm_attribute <span class="bound">thy</span>
                         <span class="main">|</span> Thms_mult <span class="bound">thy</span> <span class="main">⇒</span> of_semi__thm_attribute <span class="bound">thy</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">of_semi__thm_attribute_l</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span> String_concat <span class="inner_cartouche">‹
                            ›</span> <span class="main">(</span>L.map of_semi__thm_attribute <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">of_semi__thm_attribute_l1</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span> String_concat <span class="inner_cartouche">‹ ›</span> <span class="main">(</span>L.map of_semi__thm_attribute <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">of_semi__thm_l</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span> String_concat <span class="inner_cartouche">‹ ›</span> <span class="main">(</span>L.map of_semi__thm <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">of_lemmas</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> Lemmas_simp_thm <span class="bound">simp</span> <span class="bound">s</span> <span class="bound">l</span> <span class="main">⇒</span>
  <span class="inner_cartouche">‹lemmas%s%s = %s›</span>
    <span class="main">(</span><span class="keyword1">if</span> String.is_empty <span class="bound">s</span> <span class="keyword1">then</span> <span class="inner_cartouche">‹›</span> <span class="keyword1">else</span> <span class="inner_cartouche">‹ %s›</span> <span class="main">(</span><span class="free">To_string</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span>
    <span class="main">(</span><span class="keyword1">if</span> <span class="bound">simp</span> <span class="keyword1">then</span> <span class="inner_cartouche">‹[simp,code_unfold]›</span> <span class="keyword1">else</span> <span class="inner_cartouche">‹›</span><span class="main">)</span>
    <span class="main">(</span>of_semi__thm_attribute_l <span class="bound">l</span><span class="main">)</span>
                           <span class="main">|</span> Lemmas_simp_thms <span class="bound">s</span> <span class="bound">l</span> <span class="main">⇒</span>
  <span class="inner_cartouche">‹lemmas%s [simp,code_unfold] = %s›</span>
    <span class="main">(</span><span class="keyword1">if</span> String.is_empty <span class="bound">s</span> <span class="keyword1">then</span> <span class="inner_cartouche">‹›</span> <span class="keyword1">else</span> <span class="inner_cartouche">‹ %s›</span> <span class="main">(</span><span class="free">To_string</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span>
    <span class="main">(</span>String_concat <span class="inner_cartouche">‹
                            ›</span> <span class="main">(</span>L.map <span class="free">To_string</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">of_semi__attrib_genA</span> <span class="main">::</span> <span class="main">(</span>semi__thm list <span class="main">⇒</span> String.literal<span class="main">)</span>
   <span class="main">⇒</span> String.literal <span class="main">⇒</span> semi__thm list <span class="main">⇒</span> String.literal<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">attr</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span> <span class="comment1">― ‹error reflection: to be merged›</span>
 <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span> <span class="main">[]</span> <span class="keyword1">then</span>
    <span class="inner_cartouche">‹›</span>
  <span class="keyword1">else</span>
    <span class="inner_cartouche">‹ %s: %s›</span> <span class="free"><span class="bound"><span class="entity">attr</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">of_semi__attrib_genB</span> <span class="main">::</span> <span class="main">(</span><span class="keyword1">string</span> list <span class="main">⇒</span> String.literal<span class="main">)</span>
   <span class="main">⇒</span> String.literal <span class="main">⇒</span> <span class="keyword1">string</span> list <span class="main">⇒</span> String.literal<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">attr</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span> <span class="comment1">― ‹error reflection: to be merged›</span>
 <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span> <span class="main">[]</span> <span class="keyword1">then</span>
    <span class="inner_cartouche">‹›</span>
  <span class="keyword1">else</span>
    <span class="inner_cartouche">‹ %s: %s›</span> <span class="free"><span class="bound"><span class="entity">attr</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">of_semi__attrib</span> <span class="main">=</span> of_semi__attrib_genA of_semi__thm_l"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">of_semi__attrib1</span> <span class="main">=</span> of_semi__attrib_genB <span class="main">(</span><span class="main">λ</span><span class="bound">l</span><span class="main">.</span> String_concat <span class="inner_cartouche">‹ ›</span> <span class="main">(</span>L.map <span class="free">To_string</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">of_semi__method_simp</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">::</span> <span class="comment1">― ‹polymorphism weakening needed by <span class="antiquoted"><span class="operator">⬚</span><span class="raw_text">‹<span class="keyword1"><span class="command">code_reflect</span></span>›</span></span>›</span>
                                       String.literal<span class="main">)</span> <span class="main">=</span>
 <span class="main">(</span><span class="main">λ</span> Method_simp_only <span class="bound">l</span> <span class="main">⇒</span> <span class="inner_cartouche">‹%s only: %s›</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span>of_semi__thm_l <span class="bound">l</span><span class="main">)</span>
  <span class="main">|</span> Method_simp_add_del_split <span class="bound">l1</span> <span class="bound">l2</span> <span class="main">[]</span> <span class="main">⇒</span> <span class="inner_cartouche">‹%s%s%s›</span>
      <span class="free"><span class="bound"><span class="entity">s</span></span></span>
      <span class="main">(</span>of_semi__attrib <span class="inner_cartouche">‹add›</span> <span class="bound">l1</span><span class="main">)</span>
      <span class="main">(</span>of_semi__attrib <span class="inner_cartouche">‹del›</span> <span class="bound">l2</span><span class="main">)</span>
  <span class="main">|</span> Method_simp_add_del_split <span class="bound">l1</span> <span class="bound">l2</span> <span class="bound">l3</span> <span class="main">⇒</span> <span class="inner_cartouche">‹%s%s%s%s›</span>
      <span class="free"><span class="bound"><span class="entity">s</span></span></span>
      <span class="main">(</span>of_semi__attrib <span class="inner_cartouche">‹add›</span> <span class="bound">l1</span><span class="main">)</span>
      <span class="main">(</span>of_semi__attrib <span class="inner_cartouche">‹del›</span> <span class="bound">l2</span><span class="main">)</span>
      <span class="main">(</span>of_semi__attrib <span class="inner_cartouche">‹split›</span> <span class="bound">l3</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">of_semi__method</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">of_semi__method</span> <span class="free"><span class="bound"><span class="entity">expr</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span>
    Method_rule <span class="bound">o_s</span> <span class="main">⇒</span> <span class="inner_cartouche">‹rule%s›</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">o_s</span> <span class="keyword1">of</span> None <span class="main">⇒</span> <span class="inner_cartouche">‹›</span>
                                           <span class="main">|</span> Some <span class="bound">s</span> <span class="main">⇒</span> <span class="inner_cartouche">‹ %s›</span> <span class="main">(</span>of_semi__thm_attribute <span class="bound">s</span><span class="main">)</span><span class="main">)</span>
  <span class="main">|</span> Method_drule <span class="bound">s</span> <span class="main">⇒</span> <span class="inner_cartouche">‹drule %s›</span> <span class="main">(</span>of_semi__thm_attribute <span class="bound">s</span><span class="main">)</span>
  <span class="main">|</span> Method_erule <span class="bound">s</span> <span class="main">⇒</span> <span class="inner_cartouche">‹erule %s›</span> <span class="main">(</span>of_semi__thm_attribute <span class="bound">s</span><span class="main">)</span>
  <span class="main">|</span> Method_intro <span class="bound">l</span> <span class="main">⇒</span> <span class="inner_cartouche">‹intro %s›</span> <span class="main">(</span>of_semi__thm_attribute_l1 <span class="bound">l</span><span class="main">)</span>
  <span class="main">|</span> Method_elim <span class="bound">s</span> <span class="main">⇒</span> <span class="inner_cartouche">‹elim %s›</span> <span class="main">(</span>of_semi__thm_attribute <span class="bound">s</span><span class="main">)</span>
  <span class="main">|</span> Method_subst <span class="bound">asm</span> <span class="bound">l</span> <span class="bound">s</span> <span class="main">=&gt;</span>
      <span class="keyword1">let</span> <span class="bound">s_asm</span> <span class="main">=</span> <span class="keyword1">if</span> <span class="bound">asm</span> <span class="keyword1">then</span> <span class="inner_cartouche">‹(asm) ›</span> <span class="keyword1">else</span> <span class="inner_cartouche">‹›</span> <span class="keyword1">in</span>
      <span class="keyword1">if</span> L.map String.meta_of_logic <span class="bound">l</span> <span class="main">=</span> <span class="main">[</span><span class="keyword1">STR</span> <span class="inner_quoted">''0''</span><span class="main">]</span> <span class="keyword1">then</span>
        <span class="inner_cartouche">‹subst %s%s›</span> <span class="bound">s_asm</span> <span class="main">(</span>of_semi__thm_attribute <span class="bound">s</span><span class="main">)</span>
      <span class="keyword1">else</span>
        <span class="inner_cartouche">‹subst %s(%s) %s›</span> <span class="bound">s_asm</span> <span class="main">(</span>String_concat <span class="inner_cartouche">‹ ›</span> <span class="main">(</span>L.map <span class="free">To_string</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>of_semi__thm_attribute <span class="bound">s</span><span class="main">)</span>
  <span class="main">|</span> Method_insert <span class="bound">l</span> <span class="main">=&gt;</span> <span class="inner_cartouche">‹insert %s›</span> <span class="main">(</span>of_semi__thm_l <span class="bound">l</span><span class="main">)</span>
  <span class="main">|</span> Method_plus <span class="bound">t</span> <span class="main">⇒</span> <span class="inner_cartouche">‹(%s)+›</span> <span class="main">(</span>String_concat <span class="inner_cartouche">‹, ›</span> <span class="main">(</span>List.map <span class="free">of_semi__method</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>
  <span class="main">|</span> Method_option <span class="bound">t</span> <span class="main">⇒</span> <span class="inner_cartouche">‹(%s)?›</span> <span class="main">(</span>String_concat <span class="inner_cartouche">‹, ›</span> <span class="main">(</span>List.map <span class="free">of_semi__method</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>
  <span class="main">|</span> Method_or <span class="bound">t</span> <span class="main">⇒</span> <span class="inner_cartouche">‹(%s)›</span> <span class="main">(</span>String_concat <span class="inner_cartouche">‹ | ›</span> <span class="main">(</span>List.map <span class="free">of_semi__method</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>
  <span class="main">|</span> Method_one <span class="bound">s</span> <span class="main">⇒</span> of_semi__method_simp <span class="inner_cartouche">‹simp›</span> <span class="bound">s</span>
  <span class="main">|</span> Method_all <span class="bound">s</span> <span class="main">⇒</span> of_semi__method_simp <span class="inner_cartouche">‹simp_all›</span> <span class="bound">s</span>
  <span class="main">|</span> Method_auto_simp_add_split <span class="bound">l_simp</span> <span class="bound">l_split</span> <span class="main">⇒</span> <span class="inner_cartouche">‹auto%s%s›</span>
      <span class="main">(</span>of_semi__attrib <span class="inner_cartouche">‹simp›</span> <span class="bound">l_simp</span><span class="main">)</span>
      <span class="main">(</span>of_semi__attrib1 <span class="inner_cartouche">‹split›</span> <span class="bound">l_split</span><span class="main">)</span>
  <span class="main">|</span> Method_rename_tac <span class="bound">l</span> <span class="main">⇒</span> <span class="inner_cartouche">‹rename_tac %s›</span> <span class="main">(</span>String_concat <span class="inner_cartouche">‹ ›</span> <span class="main">(</span>L.map <span class="free">To_string</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span>
  <span class="main">|</span> Method_case_tac <span class="bound">e</span> <span class="main">⇒</span> <span class="inner_cartouche">‹case_tac \"%s\"›</span> <span class="main">(</span>of_semi__term <span class="bound">e</span><span class="main">)</span>
  <span class="main">|</span> Method_blast None <span class="main">⇒</span> <span class="inner_cartouche">‹blast›</span>
  <span class="main">|</span> Method_blast <span class="main">(</span>Some <span class="bound">n</span><span class="main">)</span> <span class="main">⇒</span> <span class="inner_cartouche">‹blast %d›</span> <span class="main">(</span><span class="free">To_nat</span> <span class="bound">n</span><span class="main">)</span>
  <span class="main">|</span> Method_clarify <span class="main">⇒</span> <span class="inner_cartouche">‹clarify›</span>
  <span class="main">|</span> Method_metis <span class="bound">l_opt</span> <span class="bound">l</span> <span class="main">⇒</span> <span class="inner_cartouche">‹metis %s%s›</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">l_opt</span> <span class="main">=</span> <span class="main">[]</span> <span class="keyword1">then</span> <span class="inner_cartouche">‹›</span>
                                          <span class="keyword1">else</span>
                                            <span class="inner_cartouche">‹(%s) ›</span> <span class="main">(</span>String_concat <span class="inner_cartouche">‹, ›</span> <span class="main">(</span>L.map <span class="free">To_string</span> <span class="bound">l_opt</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>of_semi__thm_attribute_l1 <span class="bound">l</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">expr</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">of_semi__command_final</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> Command_done <span class="main">⇒</span> <span class="inner_cartouche">‹done›</span>
                                      <span class="main">|</span> Command_by <span class="bound">l_apply</span> <span class="main">⇒</span> <span class="inner_cartouche">‹by(%s)›</span> <span class="main">(</span>String_concat <span class="inner_cartouche">‹, ›</span> <span class="main">(</span>L.map of_semi__method <span class="bound">l_apply</span><span class="main">)</span><span class="main">)</span>
                                      <span class="main">|</span> Command_sorry <span class="main">⇒</span> <span class="inner_cartouche">‹sorry›</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">of_semi__command_state</span> <span class="main">=</span> <span class="main">(</span>
  <span class="main">λ</span> Command_apply_end <span class="main">[]</span> <span class="main">⇒</span> <span class="inner_cartouche">‹›</span>
  <span class="main">|</span> Command_apply_end <span class="bound">l_apply</span> <span class="main">⇒</span> <span class="inner_cartouche">‹  apply_end(%s)
›</span> <span class="main">(</span>String_concat <span class="inner_cartouche">‹, ›</span> <span class="main">(</span>L.map of_semi__method <span class="bound">l_apply</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">‹<span class="free">of_semi__command_proof</span> <span class="main">=</span> <span class="main">(</span>
  <span class="keyword1">let</span> <span class="bound">thesis</span> <span class="main">=</span> <span class="inner_cartouche">‹?thesis›</span>
    <span class="main">;</span> <span class="bound">scope_thesis_gen</span> <span class="main">=</span> <span class="main">λ</span><span class="bound">proof</span> <span class="bound">show</span> <span class="bound">when</span><span class="main">.</span> <span class="inner_cartouche">‹  proof - %s show %s%s
›</span> <span class="bound">proof</span>
  <span class="bound">show</span>
  <span class="main">(</span><span class="keyword1">if</span> <span class="bound">when</span> <span class="main">=</span> <span class="main">[]</span> <span class="keyword1">then</span>
     <span class="inner_cartouche">‹›</span>
   <span class="keyword1">else</span>
     <span class="inner_cartouche">‹ when %s›</span> <span class="main">(</span>String_concat <span class="inner_cartouche">‹ ›</span> <span class="main">(</span>L.map <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="inner_cartouche">‹"%s"›</span> <span class="main">(</span>of_semi__term <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="bound">when</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
    <span class="main">;</span> <span class="bound">scope_thesis</span> <span class="main">=</span> <span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">scope_thesis_gen</span> <span class="bound">s</span> <span class="bound">thesis</span> <span class="main">[]</span> <span class="keyword1">in</span>
  <span class="main">λ</span> Command_apply <span class="main">[]</span> <span class="main">⇒</span> <span class="inner_cartouche">‹›</span>
  <span class="main">|</span> Command_apply <span class="bound">l_apply</span> <span class="main">⇒</span> <span class="inner_cartouche">‹  apply(%s)
›</span> <span class="main">(</span>String_concat <span class="inner_cartouche">‹, ›</span> <span class="main">(</span>L.map of_semi__method <span class="bound">l_apply</span><span class="main">)</span><span class="main">)</span>
  <span class="main">|</span> Command_using <span class="bound">l</span> <span class="main">⇒</span> <span class="inner_cartouche">‹  using %s
›</span> <span class="main">(</span>of_semi__thm_l <span class="bound">l</span><span class="main">)</span>
  <span class="main">|</span> Command_unfolding <span class="bound">l</span> <span class="main">⇒</span> <span class="inner_cartouche">‹  unfolding %s
›</span> <span class="main">(</span>of_semi__thm_l <span class="bound">l</span><span class="main">)</span>
  <span class="main">|</span> Command_let <span class="bound">e_name</span> <span class="bound">e_body</span> <span class="main">⇒</span> <span class="bound">scope_thesis</span> <span class="main">(</span><span class="inner_cartouche">‹let %s = "%s"›</span> <span class="main">(</span>of_semi__term <span class="bound">e_name</span><span class="main">)</span> <span class="main">(</span>of_semi__term <span class="bound">e_body</span><span class="main">)</span><span class="main">)</span>
  <span class="main">|</span> Command_have <span class="bound">n</span> <span class="bound">b</span> <span class="bound">e</span> <span class="bound">e_last</span> <span class="main">⇒</span> <span class="bound">scope_thesis</span> <span class="main">(</span><span class="inner_cartouche">‹have %s%s: "%s" %s›</span> <span class="main">(</span><span class="free">To_string</span> <span class="bound">n</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">b</span> <span class="keyword1">then</span> <span class="inner_cartouche">‹[simp]›</span> <span class="keyword1">else</span> <span class="inner_cartouche">‹›</span><span class="main">)</span> <span class="main">(</span>of_semi__term <span class="bound">e</span><span class="main">)</span> <span class="main">(</span>of_semi__command_final <span class="bound">e_last</span><span class="main">)</span><span class="main">)</span>
  <span class="main">|</span> Command_fix_let <span class="bound">l</span> <span class="bound">l_let</span> <span class="bound">o_show</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span>
      <span class="bound">scope_thesis_gen</span>
        <span class="main">(</span><span class="inner_cartouche">‹fix %s%s›</span> <span class="main">(</span>String_concat <span class="inner_cartouche">‹ ›</span> <span class="main">(</span>L.map <span class="free">To_string</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span>
                    <span class="main">(</span>String_concat <span class="inner_cartouche">‹
›</span>                                  <span class="main">(</span>L.map
                                     <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">e_name</span><span class="main">,</span> <span class="bound">e_body</span><span class="main">)</span><span class="main">.</span>
                                       <span class="inner_cartouche">‹          let %s = "%s"›</span> <span class="main">(</span>of_semi__term <span class="bound">e_name</span><span class="main">)</span> <span class="main">(</span>of_semi__term <span class="bound">e_body</span><span class="main">)</span><span class="main">)</span>
                                     <span class="bound">l_let</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
        <span class="main">(</span><span class="keyword1">case</span> <span class="bound">o_show</span> <span class="keyword1">of</span> None <span class="main">⇒</span> <span class="bound">thesis</span>
                      <span class="main">|</span> Some <span class="main">(</span><span class="bound">l_show</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">⇒</span> <span class="inner_cartouche">‹"%s"›</span> <span class="main">(</span>String_concat <span class="inner_cartouche">‹ ⟹ ›</span> <span class="main">(</span>L.map of_semi__term <span class="bound">l_show</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
        <span class="main">(</span><span class="keyword1">case</span> <span class="bound">o_show</span> <span class="keyword1">of</span> None <span class="main">⇒</span> <span class="main">[]</span> <span class="main">|</span> Some <span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">l_when</span><span class="main">)</span> <span class="main">⇒</span> <span class="bound">l_when</span><span class="main">)</span><span class="main">)</span>›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">of_lemma</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span>
 <span class="main">(</span><span class="main">λ</span> Lemma <span class="bound">n</span> <span class="bound">l_spec</span> <span class="bound">l_apply</span> <span class="bound">tactic_last</span> <span class="main">⇒</span>
    <span class="inner_cartouche">‹lemma %s : \"%s\"
%s%s›</span>
      <span class="main">(</span><span class="free">To_string</span> <span class="bound">n</span><span class="main">)</span>
      <span class="main">(</span>String_concat <span class="inner_cartouche">‹ ⟹ ›</span> <span class="main">(</span>L.map of_semi__term <span class="bound">l_spec</span><span class="main">)</span><span class="main">)</span>
      <span class="main">(</span>String_concat <span class="inner_cartouche">‹›</span> <span class="main">(</span>L.map <span class="main">(</span><span class="main">λ</span> <span class="main">[]</span> <span class="main">⇒</span> <span class="inner_cartouche">‹›</span> <span class="main">|</span> <span class="bound">l_apply</span> <span class="main">⇒</span> <span class="inner_cartouche">‹  apply(%s)
›</span>
                                                          <span class="main">(</span>String_concat <span class="inner_cartouche">‹, ›</span> <span class="main">(</span>L.map of_semi__method <span class="bound">l_apply</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
                               <span class="bound">l_apply</span><span class="main">)</span><span class="main">)</span>
      <span class="main">(</span>of_semi__command_final <span class="bound">tactic_last</span><span class="main">)</span>
  <span class="main">|</span> Lemma_assumes <span class="bound">n</span> <span class="bound">l_spec</span> <span class="bound">concl</span> <span class="bound">l_apply</span> <span class="bound">tactic_last</span> <span class="main">⇒</span>
    <span class="inner_cartouche">‹lemma %s : %s
%s%s %s›</span>
      <span class="main">(</span><span class="free">To_string</span> <span class="bound">n</span><span class="main">)</span>
      <span class="main">(</span>String_concat <span class="inner_cartouche">‹›</span> <span class="main">(</span>L.map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">n</span><span class="main">,</span> <span class="bound">b</span><span class="main">,</span> <span class="bound">e</span><span class="main">)</span><span class="main">.</span>
          <span class="inner_cartouche">‹
assumes %s\"%s\"›</span>
            <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">n</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">if</span> <span class="bound">b</span> <span class="keyword1">then</span> <span class="main">(</span><span class="inner_cartouche">‹%s[simp]›</span> <span class="main">(</span><span class="free">To_string</span> <span class="bound">n</span><span class="main">)</span><span class="main">,</span> False<span class="main">)</span> <span class="keyword1">else</span> <span class="main">(</span><span class="free">To_string</span> <span class="bound">n</span><span class="main">,</span> String.is_empty <span class="bound">n</span><span class="main">)</span> <span class="keyword1">in</span>
             <span class="keyword1">if</span> <span class="bound">b</span> <span class="keyword1">then</span> <span class="inner_cartouche">‹›</span> <span class="keyword1">else</span> <span class="inner_cartouche">‹%s: ›</span> <span class="bound">n</span><span class="main">)</span>
            <span class="main">(</span>of_semi__term <span class="bound">e</span><span class="main">)</span><span class="main">)</span> <span class="bound">l_spec</span>
       <span class="main">@@@@</span>
       <span class="main">[</span><span class="inner_cartouche">‹
shows \"%s\"›</span> <span class="main">(</span>of_semi__term <span class="bound">concl</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>
      <span class="main">(</span>String_concat <span class="inner_cartouche">‹›</span> <span class="main">(</span>L.map of_semi__command_proof <span class="bound">l_apply</span><span class="main">)</span><span class="main">)</span>
      <span class="main">(</span>of_semi__command_final <span class="bound">tactic_last</span><span class="main">)</span>
      <span class="main">(</span>String_concat <span class="inner_cartouche">‹ ›</span>
        <span class="main">(</span>L.map
          <span class="main">(</span><span class="main">λ</span><span class="bound">l_apply_e</span><span class="main">.</span>
            <span class="inner_cartouche">‹%sqed›</span>
              <span class="main">(</span><span class="keyword1">if</span> <span class="bound">l_apply_e</span> <span class="main">=</span> <span class="main">[]</span> <span class="keyword1">then</span>
                 <span class="inner_cartouche">‹›</span>
               <span class="keyword1">else</span>
                 <span class="inner_cartouche">‹
%s ›</span>
                   <span class="main">(</span>String_concat <span class="inner_cartouche">‹›</span> <span class="main">(</span>L.map of_semi__command_state <span class="bound">l_apply_e</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
          <span class="main">(</span>List.map_filter
            <span class="main">(</span><span class="main">λ</span> Command_let <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> Some <span class="main">[]</span> <span class="main">|</span> Command_have <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> Some <span class="main">[]</span> <span class="main">|</span> Command_fix_let <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span> <span class="bound">l</span> <span class="main">⇒</span> Some <span class="bound">l</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> None<span class="main">)</span>
            <span class="main">(</span>rev <span class="bound">l_apply</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">of_axiomatization</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> Axiomatization <span class="bound">n</span> <span class="bound">e</span> <span class="main">⇒</span> <span class="inner_cartouche">‹axiomatization where %s:
\"%s\"›</span> <span class="main">(</span><span class="free">To_string</span> <span class="bound">n</span><span class="main">)</span> <span class="main">(</span>of_semi__term <span class="bound">e</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">of_section</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> Section <span class="bound">n</span> <span class="bound">section_title</span> <span class="main">⇒</span>
    <span class="inner_cartouche">‹%s ‹%s››</span>
      <span class="main">(</span><span class="inner_cartouche">‹%ssection›</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">n</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="inner_cartouche">‹›</span>
                    <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="bound">n</span> <span class="main">=</span> <span class="main">1</span> <span class="keyword1">then</span> <span class="inner_cartouche">‹sub›</span>
                    <span class="keyword1">else</span> <span class="inner_cartouche">‹subsub›</span><span class="main">)</span><span class="main">)</span>
      <span class="main">(</span><span class="free">To_string</span> <span class="bound">section_title</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">of_text</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> Text <span class="bound">s</span> <span class="main">⇒</span> <span class="inner_cartouche">‹text ‹%s››</span> <span class="main">(</span><span class="free">To_string</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">of_ML</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> SML <span class="bound">e</span> <span class="main">⇒</span> <span class="inner_cartouche">‹ML ‹%s››</span> <span class="main">(</span>of_semi__term' <span class="bound">e</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">of_setup</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> Setup <span class="bound">e</span> <span class="main">⇒</span> <span class="inner_cartouche">‹setup ‹%s››</span> <span class="main">(</span>of_semi__term' <span class="bound">e</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">of_thm</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> Thm <span class="bound">thm</span> <span class="main">⇒</span> <span class="inner_cartouche">‹thm %s›</span> <span class="main">(</span>of_semi__thm_attribute_l1 <span class="bound">thm</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">‹<span class="free">of_interpretation</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> Interpretation <span class="bound">n</span> <span class="bound">loc_n</span> <span class="bound">loc_param</span> <span class="bound">tac</span> <span class="main">⇒</span>
  <span class="inner_cartouche">‹interpretation %s: %s%s
%s›</span> <span class="main">(</span><span class="free">To_string</span> <span class="bound">n</span><span class="main">)</span>
    <span class="main">(</span><span class="free">To_string</span> <span class="bound">loc_n</span><span class="main">)</span>
    <span class="main">(</span>String_concat <span class="inner_cartouche">‹›</span> <span class="main">(</span>L.map <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="inner_cartouche">‹ "%s"›</span> <span class="main">(</span>of_semi__term <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="bound">loc_param</span><span class="main">)</span><span class="main">)</span>
    <span class="main">(</span>of_semi__command_final <span class="bound">tac</span><span class="main">)</span><span class="main">)</span>›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">of_semi__theory</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">=</span>
 <span class="main">(</span><span class="main">λ</span> Theory_datatype <span class="bound">dataty</span> <span class="main">⇒</span> of_datatype <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="bound">dataty</span>
  <span class="main">|</span> Theory_type_synonym <span class="bound">ty_synonym</span> <span class="main">⇒</span> of_type_synonym <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="bound">ty_synonym</span>
  <span class="main">|</span> Theory_type_notation <span class="bound">ty_notation</span> <span class="main">⇒</span> of_type_notation <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="bound">ty_notation</span>
  <span class="main">|</span> Theory_instantiation <span class="bound">instantiation_class</span> <span class="main">⇒</span> of_instantiation <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="bound">instantiation_class</span>
  <span class="main">|</span> Theory_overloading <span class="bound">overloading</span> <span class="main">⇒</span> of_overloading <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="bound">overloading</span>
  <span class="main">|</span> Theory_consts <span class="bound">consts_class</span> <span class="main">⇒</span> of_consts <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="bound">consts_class</span>
  <span class="main">|</span> Theory_definition <span class="bound">definition_hol</span> <span class="main">⇒</span> of_definition <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="bound">definition_hol</span>
  <span class="main">|</span> Theory_lemmas <span class="bound">lemmas_simp</span> <span class="main">⇒</span> of_lemmas <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="bound">lemmas_simp</span>
  <span class="main">|</span> Theory_lemma <span class="bound">lemma_by</span> <span class="main">⇒</span> of_lemma <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="bound">lemma_by</span>
  <span class="main">|</span> Theory_axiomatization <span class="bound">axiom</span> <span class="main">⇒</span> of_axiomatization <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="bound">axiom</span>
  <span class="main">|</span> Theory_section <span class="bound">section_title</span> <span class="main">⇒</span> of_section <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="bound">section_title</span>
  <span class="main">|</span> Theory_text <span class="bound">text</span> <span class="main">⇒</span> of_text <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="bound">text</span>
  <span class="main">|</span> Theory_ML <span class="bound">ml</span> <span class="main">⇒</span> of_ML <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="bound">ml</span>
  <span class="main">|</span> Theory_setup <span class="bound">setup</span> <span class="main">⇒</span> of_setup <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="bound">setup</span>
  <span class="main">|</span> Theory_thm <span class="bound">thm</span> <span class="main">⇒</span> of_thm <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="bound">thm</span>
  <span class="main">|</span> Theory_interpretation <span class="bound">thm</span> <span class="main">⇒</span> of_interpretation <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="bound">thm</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">String_concat_map</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span> String_concat <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span>L.map <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">‹<span class="free">of_semi__theories</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">=</span>
 <span class="main">(</span><span class="main">λ</span> Theories_one <span class="bound">t</span> <span class="main">⇒</span> of_semi__theory <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="bound">t</span>
  <span class="main">|</span> Theories_locale <span class="bound">data</span> <span class="bound">l</span> <span class="main">⇒</span> 
      <span class="inner_cartouche">‹locale %s =
%s
begin
%s
end›</span>   <span class="main">(</span><span class="free">To_string</span> <span class="main">(</span>HolThyLocale_name <span class="bound">data</span><span class="main">)</span><span class="main">)</span>
        <span class="main">(</span>String_concat_map
           <span class="inner_cartouche">‹
›</span>
           <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">l_fix</span><span class="main">,</span> <span class="bound">o_assum</span><span class="main">)</span><span class="main">.</span>
                <span class="inner_cartouche">‹%s%s›</span> <span class="main">(</span>String_concat_map <span class="inner_cartouche">‹
›</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">e</span><span class="main">,</span> <span class="bound">ty</span><span class="main">)</span><span class="main">.</span> <span class="inner_cartouche">‹fixes "%s" :: "%s"›</span> <span class="main">(</span>of_semi__term <span class="bound">e</span><span class="main">)</span> <span class="main">(</span>of_semi__typ <span class="bound">ty</span><span class="main">)</span><span class="main">)</span> <span class="bound">l_fix</span><span class="main">)</span>
                                <span class="main">(</span><span class="keyword1">case</span> <span class="bound">o_assum</span> <span class="keyword1">of</span> None <span class="main">⇒</span> <span class="inner_cartouche">‹›</span>
                                               <span class="main">|</span> Some <span class="main">(</span><span class="bound">name</span><span class="main">,</span> <span class="bound">e</span><span class="main">)</span> <span class="main">⇒</span> <span class="inner_cartouche">‹
assumes %s: "%s"›</span> <span class="main">(</span><span class="free">To_string</span> <span class="bound">name</span><span class="main">)</span> <span class="main">(</span>of_semi__term <span class="bound">e</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
           <span class="main">(</span>HolThyLocale_header <span class="bound">data</span><span class="main">)</span><span class="main">)</span>
        <span class="main">(</span>String_concat_map <span class="inner_cartouche">‹

›</span> <span class="main">(</span>String_concat_map <span class="inner_cartouche">‹

›</span> <span class="main">(</span>of_semi__theory <span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">)</span><span class="main">)</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span>›</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">code</span><span class="main">]</span> <span class="main">=</span>
  <span class="comment1">― ‹def›</span>
  Print.of_datatype_def
  Print.of_type_synonym_def
  Print.of_type_notation_def
  Print.of_instantiation_def
  Print.of_overloading_def
  Print.of_consts_def
  Print.of_definition_def
  Print.of_semi__thm_attribute_aux_gen_def
  Print.of_semi__thm_attribute_aux_gen_where_def
  Print.of_semi__thm_attribute_aux_gen_of_def
  Print.of_semi__thm_attribute_def
  Print.of_semi__thm_def
  Print.of_semi__thm_attribute_l_def
  Print.of_semi__thm_attribute_l1_def
  Print.of_semi__thm_l_def
  Print.of_lemmas_def
  Print.of_semi__attrib_genA_def
  Print.of_semi__attrib_genB_def
  Print.of_semi__attrib_def
  Print.of_semi__attrib1_def
  Print.of_semi__method_simp_def
  Print.of_semi__command_final_def
  Print.of_semi__command_state_def
  Print.of_semi__command_proof_def
  Print.of_lemma_def
  Print.of_axiomatization_def
  Print.of_section_def
  Print.of_text_def
  Print.of_ML_def
  Print.of_setup_def
  Print.of_thm_def
  Print.of_interpretation_def
  Print.of_semi__theory_def
  Print.String_concat_map_def
  Print.of_semi__theories_def

  <span class="comment1">― ‹fun›</span>
  Print.of_semi__typ.simps
  Print.of_semi__term.simps
  Print.of_semi__thm_attribute_aux.simps
  Print.of_semi__method.simps

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Toy_Library_Static">
<div class="head">
<h1>Theory Toy_Library_Static</h1>
</div>
<pre class="source"><span class="comment1">(******************************************************************************
 * Citadelle
 *
 * Copyright (c) 2011-2018 Université Paris-Saclay, Univ. Paris-Sud, France
 *               2013-2017 IRT SystemX, France
 *               2011-2015 Achim D. Brucker, Germany
 *               2016-2018 The University of Sheffield, UK
 *               2016-2017 Nanyang Technological University, Singapore
 *               2017-2018 Virginia Tech, USA
 *
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are
 * met:
 *
 *     * Redistributions of source code must retain the above copyright
 *       notice, this list of conditions and the following disclaimer.
 *
 *     * Redistributions in binary form must reproduce the above
 *       copyright notice, this list of conditions and the following
 *       disclaimer in the documentation and/or other materials provided
 *       with the distribution.
 *
 *     * Neither the name of the copyright holders nor the names of its
 *       contributors may be used to endorse or promote products derived
 *       from this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 ******************************************************************************)</span>

<span class="keyword1"><span class="command">chapter</span></span><span class="quoted"><span class="plain_text">‹Toy Libraries Static›</span></span>
<span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹Main Common Static Libraries›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Toy_Library_Static
<span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹In case there are functions planned to be at the same time used by the compiler
(by the translating step) and 
also used by generated files, then these functions can be defined in this file.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">map_of_list</span> <span class="main">=</span> <span class="main">(</span>foldl <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">map</span><span class="main">.</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span> <span class="main">,</span> <span class="bound">l1</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">case</span> <span class="main">(</span><span class="bound">map</span> <span class="main">(</span><span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">of</span> None <span class="main">⇒</span> <span class="main">(</span><span class="bound">map</span> <span class="main">(</span><span class="bound">x</span> <span class="main">↦</span> <span class="bound">l1</span><span class="main">)</span><span class="main">)</span>
    <span class="main">|</span> Some <span class="bound">l0</span> <span class="main">⇒</span> <span class="main">(</span><span class="bound">map</span> <span class="main">(</span><span class="bound">x</span> <span class="main">↦</span> <span class="main">(</span>concat <span class="main">(</span><span class="main">[</span><span class="bound">l0</span> <span class="main">,</span> <span class="bound">l1</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Map.empty<span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">choose_0</span> <span class="main">=</span> fst"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">choose_1</span> <span class="main">=</span> snd"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">deref_assocs_list</span> <span class="free"><span class="bound"><span class="entity">to_from</span></span></span> <span class="free"><span class="bound"><span class="entity">oid</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">=</span>
  concat <span class="main">(</span>map <span class="main">(</span>choose_1 <span class="keyword1">o</span> <span class="free"><span class="bound"><span class="entity">to_from</span></span></span><span class="main">)</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> List.member <span class="main">(</span>choose_0 <span class="main">(</span><span class="free"><span class="bound"><span class="entity">to_from</span></span></span> <span class="bound">p</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">oid</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Init_rbt">
<div class="head">
<h1>Theory Init_rbt</h1>
</div>
<pre class="source"><span class="comment1">(******************************************************************************
 * Citadelle
 *
 * Copyright (c) 2011-2018 Université Paris-Saclay, Univ. Paris-Sud, France
 *               2013-2017 IRT SystemX, France
 *               2011-2015 Achim D. Brucker, Germany
 *               2016-2018 The University of Sheffield, UK
 *               2016-2017 Nanyang Technological University, Singapore
 *               2017-2018 Virginia Tech, USA
 *
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are
 * met:
 *
 *     * Redistributions of source code must retain the above copyright
 *       notice, this list of conditions and the following disclaimer.
 *
 *     * Redistributions in binary form must reproduce the above
 *       copyright notice, this list of conditions and the following
 *       disclaimer in the documentation and/or other materials provided
 *       with the distribution.
 *
 *     * Neither the name of the copyright holders nor the names of its
 *       contributors may be used to endorse or promote products derived
 *       from this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 ******************************************************************************)</span>

<span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹Basic Extension of the Standard Library (Depending on RBT)›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Init_rbt
<span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="Init.html">../../Init</a>"</span>
        <span class="quoted">"<a href="../../HOL/HOL-Library/RBT.html">HOL-Library.RBT</a>"</span>
        <span class="quoted">"<a href="../../HOL/HOL-Library/Char_ord.html">HOL-Library.Char_ord</a>"</span>
        <span class="quoted">"<a href="../../HOL/HOL-Library/List_Lexorder.html">HOL-Library.List_Lexorder</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">locale</span></span> RBT
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">modify_def</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">rbt</span></span></span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">case</span> RBT.lookup <span class="free"><span class="bound"><span class="entity">rbt</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1">of</span> None <span class="main">⇒</span> RBT.insert <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">rbt</span></span></span>
                      <span class="main">|</span> Some <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> RBT.map_entry <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">rbt</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">lookup2</span> <span class="free"><span class="bound"><span class="entity">rbt</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x1</span><span class="main">,</span> <span class="bound">x2</span><span class="main">)</span><span class="main">.</span> Option.bind <span class="main">(</span>RBT.lookup <span class="free"><span class="bound"><span class="entity">rbt</span></span></span> <span class="bound">x1</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">rbt</span><span class="main">.</span> RBT.lookup <span class="bound">rbt</span> <span class="bound">x2</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">insert2</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x1</span><span class="main">,</span> <span class="bound">x2</span><span class="main">)</span> <span class="bound">v</span><span class="main">.</span> RBT.modify_def RBT.empty <span class="bound">x1</span> <span class="main">(</span>RBT.insert <span class="bound">x2</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">end</span></span>
<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">code</span><span class="main">]</span> <span class="main">=</span>
  <span class="comment1">― ‹def›</span>
  RBT.modify_def_def
  RBT.lookup2_def
  RBT.insert2_def

<span class="keyword1"><span class="command">context</span></span> L
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">unique</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span> List.map_filter id <span class="main">(</span>fst
  <span class="main">(</span>mapM
    <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">cpt</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span> <span class="bound">rbt</span><span class="main">.</span> 
      <span class="keyword1">let</span> <span class="bound">f_cpt</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">cpt</span> <span class="keyword1">in</span>
      <span class="keyword1">if</span> RBT.lookup <span class="bound">rbt</span> <span class="bound">f_cpt</span> <span class="main">=</span> None <span class="keyword1">then</span>
        <span class="main">(</span>Some <span class="main">(</span><span class="bound">cpt</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span><span class="main">,</span> RBT.insert <span class="bound">f_cpt</span> <span class="main">()</span> <span class="bound">rbt</span><span class="main">)</span>
      <span class="keyword1">else</span> 
        <span class="main">(</span>None<span class="main">,</span> <span class="bound">rbt</span><span class="main">)</span><span class="main">)</span>
    <span class="free"><span class="bound"><span class="entity">l</span></span></span>
    RBT.empty<span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">end</span></span>
<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">code</span><span class="main">]</span> <span class="main">=</span>
  <span class="comment1">― ‹def›</span>
  L.unique_def

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Meta_Toy">
<div class="head">
<h1>Theory Meta_Toy</h1>
</div>
<pre class="source"><span class="comment1">(******************************************************************************
 * HOL-TOY
 *
 * Copyright (c) 2011-2018 Université Paris-Saclay, Univ. Paris-Sud, France
 *               2013-2017 IRT SystemX, France
 *               2011-2015 Achim D. Brucker, Germany
 *               2016-2018 The University of Sheffield, UK
 *               2016-2017 Nanyang Technological University, Singapore
 *               2017-2018 Virginia Tech, USA
 *
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are
 * met:
 *
 *     * Redistributions of source code must retain the above copyright
 *       notice, this list of conditions and the following disclaimer.
 *
 *     * Redistributions in binary form must reproduce the above
 *       copyright notice, this list of conditions and the following
 *       disclaimer in the documentation and/or other materials provided
 *       with the distribution.
 *
 *     * Neither the name of the copyright holders nor the names of its
 *       contributors may be used to endorse or promote products derived
 *       from this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 ******************************************************************************)</span>

<span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹Toy Meta-Model aka. AST definition of Toy (I)›</span></span>

<span class="keyword1"><span class="command">theory</span></span>  Meta_Toy
<span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="Meta_Pure.html">../../../meta_isabelle/Meta_Pure</a>"</span>
        <span class="quoted">"<a href="Init_rbt.html">../Init_rbt</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Type Definition›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> toy_collection <span class="main">=</span> Set
                        <span class="main">|</span> Sequence
                        <span class="main">|</span> Ordered0 <span class="comment1">― ‹ordered set›</span>
                        <span class="main">|</span> Subsets0 <span class="comment1">― ‹binding›</span>
                        <span class="main">|</span> Union0
                        <span class="main">|</span> Redefines0 <span class="comment1">― ‹binding›</span>
                        <span class="main">|</span> Derived0 <span class="comment1">― ‹string›</span>
                        <span class="main">|</span> Qualifier0 <span class="comment1">― ‹binding <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>× use_toyty›</span></span>›</span>
                        <span class="main">|</span> Nonunique0 <span class="comment1">― ‹bag›</span>

<span class="keyword1"><span class="command">datatype</span></span> toy_multiplicity_single <span class="main">=</span> Mult_nat <span class="quoted"><span class="keyword1">nat</span></span>
                                 <span class="main">|</span> Mult_star
                                 <span class="main">|</span> Mult_infinity

<span class="keyword1"><span class="command">record</span></span> toy_multiplicity <span class="main">=</span> TyMult <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>toy_multiplicity_single <span class="main">×</span> toy_multiplicity_single option<span class="main">)</span> list"</span></span>
                          TyRole <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="keyword1">string</span> option"</span></span>
                          TyCollect <span class="main">::</span> <span class="quoted"><span class="quoted">"toy_collection list"</span></span> <span class="comment1">― ‹return type of the accessor (constrained by the above multiplicity)›</span>

<span class="keyword1"><span class="command">record</span></span> toy_ty_class_node <span class="main">=</span>  TyObjN_ass_switch <span class="main">::</span> <span class="quoted"><span class="keyword1">nat</span></span>
                            TyObjN_role_multip <span class="main">::</span> <span class="quoted">toy_multiplicity</span>
                            TyObjN_role_ty <span class="main">::</span> <span class="quoted"><span class="keyword1">string</span></span>
<span class="keyword1"><span class="command">record</span></span> toy_ty_class <span class="main">=</span>       TyObj_name <span class="main">::</span> <span class="quoted"><span class="keyword1">string</span></span>
                            TyObj_ass_id <span class="main">::</span> <span class="quoted"><span class="keyword1">nat</span></span>
                            TyObj_ass_arity <span class="main">::</span> <span class="quoted"><span class="keyword1">nat</span></span>
                            TyObj_from <span class="main">::</span> <span class="quoted">toy_ty_class_node</span>
                            TyObj_to <span class="main">::</span> <span class="quoted">toy_ty_class_node</span>
<span class="keyword1"><span class="command">datatype</span></span> toy_ty_obj_core <span class="main">=</span>  ToyTyCore_pre <span class="quoted"><span class="keyword1">string</span></span> <span class="comment1">― ‹class name, untyped›</span> <span class="comment1">(* FIXME perform the typing separately *)</span>
                          <span class="main">|</span> ToyTyCore <span class="quoted">toy_ty_class</span> <span class="comment1">― ‹class name, typed›</span>
<span class="keyword1"><span class="command">datatype</span></span> toy_ty_obj <span class="main">=</span>       ToyTyObj  <span class="quoted">toy_ty_obj_core</span>
                                     <span class="quoted"><span class="quoted">"toy_ty_obj_core list <span class="comment1">― ‹the <span class="antiquoted"><span class="operator">⬚</span><span class="raw_text">‹<span class="keyword2"><span class="keyword">and</span></span>›</span></span> semantics›</span>
                                                           list <span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>x # …›</span></span> means <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>x &lt; …›</span></span>›</span>"</span></span> <span class="comment1">― ‹superclass›</span>
<span class="keyword1"><span class="command">datatype</span></span> toy_ty <span class="main">=</span>           ToyTy_base_void <span class="comment1">(* NOTE can be merged in a generic tuple *)</span>
                          <span class="main">|</span> ToyTy_base_boolean
                          <span class="main">|</span> ToyTy_base_integer
                          <span class="main">|</span> ToyTy_base_unlimitednatural
                          <span class="main">|</span> ToyTy_base_real
                          <span class="main">|</span> ToyTy_base_string
                          <span class="main">|</span> ToyTy_object <span class="quoted">toy_ty_obj</span>
                          <span class="main">|</span> ToyTy_collection <span class="quoted">toy_multiplicity</span> <span class="quoted">toy_ty</span>
                          <span class="main">|</span> ToyTy_pair <span class="quoted">toy_ty</span> <span class="quoted">toy_ty</span> <span class="comment1">(* NOTE can be merged in a generic tuple *)</span>
                          <span class="main">|</span> ToyTy_binding <span class="quoted"><span class="quoted">"<span class="keyword1">string</span> option <span class="comment1">― ‹name›</span> <span class="main">×</span> toy_ty"</span></span> <span class="comment1">(* NOTE can be merged in a generic tuple *)</span>
                          <span class="main">|</span> ToyTy_arrow <span class="quoted">toy_ty</span> <span class="quoted">toy_ty</span>
                          <span class="main">|</span> ToyTy_class_syn <span class="quoted"><span class="keyword1">string</span></span>
                          <span class="main">|</span> ToyTy_enum <span class="quoted"><span class="keyword1">string</span></span>
                          <span class="main">|</span> ToyTy_raw <span class="quoted"><span class="keyword1">string</span></span> <span class="comment1">― ‹denoting raw HOL-type›</span> <span class="comment1">(* FIXME to be removed *)</span>


<span class="keyword1"><span class="command">datatype</span></span> toy_association_type <span class="main">=</span> ToyAssTy_native_attribute
                              <span class="main">|</span> ToyAssTy_association
                              <span class="main">|</span> ToyAssTy_composition
                              <span class="main">|</span> ToyAssTy_aggregation
<span class="keyword1"><span class="command">datatype</span></span> toy_association_relation <span class="main">=</span> ToyAssRel <span class="quoted"><span class="quoted">"<span class="main">(</span>toy_ty_obj <span class="main">×</span> toy_multiplicity<span class="main">)</span> list"</span></span>
<span class="keyword1"><span class="command">record</span></span> toy_association <span class="main">=</span>        ToyAss_type     <span class="main">::</span> <span class="quoted">toy_association_type</span>
                                ToyAss_relation <span class="main">::</span> <span class="quoted">toy_association_relation</span>

<span class="keyword1"><span class="command">datatype</span></span> toy_ctxt_prefix <span class="main">=</span> ToyCtxtPre <span class="main">|</span> ToyCtxtPost

<span class="keyword1"><span class="command">datatype</span></span> toy_ctxt_term <span class="main">=</span> T_pure <span class="quoted"><span class="quoted">"term"</span></span>
                       <span class="main">|</span> T_to_be_parsed <span class="quoted"><span class="keyword1">string</span></span> <span class="comment1">― ‹raw, it includes extra quoting characters like DEL (char 127)›</span>
                                        <span class="quoted"><span class="keyword1">string</span></span> <span class="comment1">― ‹same string but escaped without those quoting characters›</span>
                       <span class="main">|</span> T_lambda <span class="quoted"><span class="keyword1">string</span></span> <span class="quoted">toy_ctxt_term</span>
<span class="keyword1"><span class="command">datatype</span></span> toy_prop <span class="main">=</span> ToyProp_ctxt <span class="quoted"><span class="quoted">"<span class="keyword1">string</span> option"</span></span> <span class="comment1">― ‹name›</span> <span class="quoted">toy_ctxt_term</span>
                  <span class="comment1">(*| ToyProp_rel toy_ty_obj (* states that the constraint should be true *)
                  | ToyProp_ass toy_association_relation (* states the relation as true *)*)</span>
<span class="keyword1"><span class="command">datatype</span></span> toy_ctxt_term_inv <span class="main">=</span> T_inv <span class="quoted">bool</span> <span class="comment1">― ‹True: existential›</span> <span class="quoted">toy_prop</span>
<span class="keyword1"><span class="command">datatype</span></span> toy_ctxt_term_pp <span class="main">=</span> T_pp <span class="quoted">toy_ctxt_prefix</span> <span class="quoted">toy_prop</span>
                          <span class="main">|</span> T_invariant <span class="quoted">toy_ctxt_term_inv</span>

<span class="keyword1"><span class="command">record</span></span> toy_ctxt_pre_post <span class="main">=</span> Ctxt_fun_name <span class="main">::</span> <span class="quoted"><span class="keyword1">string</span></span> <span class="comment1">― ‹function name›</span>
                           Ctxt_fun_ty <span class="main">::</span> <span class="quoted">toy_ty</span>
                           Ctxt_expr <span class="main">::</span> <span class="quoted"><span class="quoted">"toy_ctxt_term_pp list"</span></span>

<span class="keyword1"><span class="command">datatype</span></span> toy_ctxt_clause <span class="main">=</span> Ctxt_pp <span class="quoted">toy_ctxt_pre_post</span>
                         <span class="main">|</span> Ctxt_inv <span class="quoted">toy_ctxt_term_inv</span>
<span class="keyword1"><span class="command">record</span></span> toy_ctxt <span class="main">=</span> Ctxt_param <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="keyword1">string</span> list"</span></span> <span class="comment1">― ‹param›</span>
                  Ctxt_ty <span class="main">::</span> <span class="quoted">toy_ty_obj</span>
                  Ctxt_clause <span class="main">::</span> <span class="quoted"><span class="quoted">"toy_ctxt_clause list"</span></span>

<span class="keyword1"><span class="command">datatype</span></span> toy_class <span class="main">=</span>   ToyClass
                         <span class="quoted"><span class="keyword1">string</span></span> <span class="comment1">― ‹name of the class›</span>
                         <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">string</span> <span class="comment1">― ‹name›</span> <span class="main">×</span> toy_ty<span class="main">)</span> list"</span></span> <span class="comment1">― ‹attribute›</span>
                         <span class="quoted"><span class="quoted">"toy_class list"</span></span> <span class="comment1">― ‹link to subclasses›</span>

<span class="keyword1"><span class="command">record</span></span> toy_class_raw <span class="main">=</span> ClassRaw_name <span class="main">::</span> <span class="quoted">toy_ty_obj</span>
                       ClassRaw_own <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">string</span> <span class="comment1">― ‹name›</span> <span class="main">×</span> toy_ty<span class="main">)</span> list"</span></span> <span class="comment1">― ‹attribute›</span>
                       ClassRaw_clause <span class="main">::</span> <span class="quoted"><span class="quoted">"toy_ctxt_clause list"</span></span>
                       ClassRaw_abstract <span class="main">::</span> <span class="quoted">bool</span> <span class="comment1">― ‹True: abstract›</span>

<span class="keyword1"><span class="command">datatype</span></span> toy_ass_class <span class="main">=</span> ToyAssClass <span class="quoted">toy_association</span>
                                     <span class="quoted">toy_class_raw</span>

<span class="keyword1"><span class="command">datatype</span></span> toy_class_synonym <span class="main">=</span> ToyClassSynonym <span class="quoted"><span class="keyword1">string</span></span> <span class="comment1">― ‹name alias›</span> <span class="quoted">toy_ty</span>

<span class="keyword1"><span class="command">datatype</span></span> toy_enum <span class="main">=</span> ToyEnum <span class="quoted"><span class="keyword1">string</span></span> <span class="comment1">― ‹name›</span> <span class="quoted"><span class="quoted">"<span class="keyword1">string</span> <span class="comment1">― ‹constructor name›</span> list"</span></span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Extending the Meta-Model›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">T_lambdas</span> <span class="main">=</span> List.fold T_lambda"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">TyObjN_role_name</span> <span class="main">=</span> TyRole <span class="keyword1">o</span> TyObjN_role_multip"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">ToyTy_class</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> ToyTy_object <span class="main">(</span>ToyTyObj <span class="main">(</span>ToyTyCore <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="main">[]</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">ToyTy_class_pre</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> ToyTy_object <span class="main">(</span>ToyTyObj <span class="main">(</span>ToyTyCore_pre <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="main">[]</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">ToyAss_relation'</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> ToyAss_relation <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="keyword1">of</span> ToyAssRel <span class="bound">l</span> <span class="main">⇒</span> <span class="bound">l</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">fold_pair_var</span> <span class="keyword2"><span class="keyword">where</span></span>
   <span class="quoted"><span class="quoted">"<span class="free">fold_pair_var</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">accu</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">of</span>
    ToyTy_pair <span class="bound">t1</span> <span class="bound">t2</span> <span class="main">⇒</span> Option.bind <span class="main">(</span><span class="free">fold_pair_var</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">t1</span> <span class="free"><span class="bound"><span class="entity">accu</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">fold_pair_var</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">t2</span><span class="main">)</span>
  <span class="main">|</span> ToyTy_binding <span class="main">(</span>Some <span class="bound">v</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span> <span class="main">⇒</span> <span class="free">fold_pair_var</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">t</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">accu</span></span></span><span class="main">)</span>
  <span class="main">|</span> ToyTy_binding <span class="main">(</span>None<span class="main">,</span> <span class="bound">t</span><span class="main">)</span> <span class="main">⇒</span> <span class="free">fold_pair_var</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">t</span> <span class="free"><span class="bound"><span class="entity">accu</span></span></span>
  <span class="main">|</span> ToyTy_collection <span class="main"><span class="bound">_</span></span> <span class="bound">t</span> <span class="main">⇒</span> <span class="free">fold_pair_var</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">t</span> <span class="free"><span class="bound"><span class="entity">accu</span></span></span>
  <span class="main">|</span> ToyTy_arrow <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> None
  <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> Some <span class="free"><span class="bound"><span class="entity">accu</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">Ctxt_fun_ty_arg</span> <span class="free"><span class="bound"><span class="entity">ctxt</span></span></span> <span class="main">=</span>
 <span class="main">(</span><span class="keyword1">case</span> 
    fold_pair_var
      Cons
      <span class="main">(</span><span class="keyword1">case</span> Ctxt_fun_ty <span class="free"><span class="bound"><span class="entity">ctxt</span></span></span> <span class="keyword1">of</span> ToyTy_arrow <span class="bound">t</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="bound">t</span>
                              <span class="main">|</span> <span class="bound">t</span> <span class="main">⇒</span> <span class="bound">t</span><span class="main">)</span>
      <span class="main">[]</span>
  <span class="keyword1">of</span> Some <span class="bound">l</span> <span class="main">⇒</span> rev <span class="bound">l</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">Ctxt_fun_ty_out</span> <span class="free"><span class="bound"><span class="entity">ctxt</span></span></span> <span class="main">=</span>
 <span class="main">(</span><span class="keyword1">case</span> Ctxt_fun_ty <span class="free"><span class="bound"><span class="entity">ctxt</span></span></span> <span class="keyword1">of</span> ToyTy_arrow <span class="main"><span class="bound">_</span></span> <span class="bound">t</span> <span class="main">⇒</span> Some <span class="bound">t</span>
                         <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> None<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">map_pre_post</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> 
             Ctxt_clause_update
               <span class="main">(</span>L.map 
                  <span class="main">(</span><span class="main">λ</span> Ctxt_pp <span class="bound">ctxt</span> <span class="main">⇒</span>
                     Ctxt_pp <span class="main">(</span>Ctxt_expr_update
                               <span class="main">(</span>L.map
                                  <span class="main">(</span><span class="main">λ</span> T_pp <span class="bound">pref</span> <span class="main">(</span>ToyProp_ctxt <span class="bound">n</span> <span class="bound">e</span><span class="main">)</span> <span class="main">⇒</span>
                                     T_pp <span class="bound">pref</span> <span class="main">(</span>ToyProp_ctxt <span class="bound">n</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">pref</span> <span class="bound">ctxt</span> <span class="bound">e</span><span class="main">)</span><span class="main">)</span>
                                   <span class="main">|</span> <span class="bound">x</span> <span class="main">⇒</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>
                               <span class="bound">ctxt</span><span class="main">)</span>
                   <span class="main">|</span> <span class="bound">x</span> <span class="main">⇒</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">map_invariant</span> <span class="free"><span class="bound"><span class="entity">f_inv</span></span></span> <span class="main">=</span>
             Ctxt_clause_update
               <span class="main">(</span>L.map 
                  <span class="main">(</span><span class="main">λ</span> Ctxt_pp <span class="bound">ctxt</span> <span class="main">⇒</span>
                     Ctxt_pp <span class="main">(</span>Ctxt_expr_update
                               <span class="main">(</span>L.map
                                 <span class="main">(</span><span class="main">λ</span> T_invariant <span class="bound">ctxt</span> <span class="main">⇒</span> T_invariant <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f_inv</span></span></span> <span class="bound">ctxt</span><span class="main">)</span>
                                  <span class="main">|</span> <span class="bound">x</span> <span class="main">⇒</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>
                               <span class="bound">ctxt</span><span class="main">)</span>
                   <span class="main">|</span> Ctxt_inv <span class="bound">ctxt</span> <span class="main">⇒</span> Ctxt_inv <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f_inv</span></span></span> <span class="bound">ctxt</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">remove_binding</span> <span class="keyword2"><span class="keyword">where</span></span>
   <span class="quoted"><span class="quoted">"<span class="free">remove_binding</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> ToyTy_collection <span class="bound">m</span> <span class="bound">ty</span> <span class="main">⇒</span> ToyTy_collection <span class="bound">m</span> <span class="main">(</span><span class="free">remove_binding</span> <span class="bound">ty</span><span class="main">)</span>
                        <span class="main">|</span> ToyTy_pair <span class="bound">ty1</span> <span class="bound">ty2</span> <span class="main">⇒</span> ToyTy_pair <span class="main">(</span><span class="free">remove_binding</span> <span class="bound">ty1</span><span class="main">)</span> <span class="main">(</span><span class="free">remove_binding</span> <span class="bound">ty2</span><span class="main">)</span>
                        <span class="main">|</span> ToyTy_binding <span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">ty</span><span class="main">)</span> <span class="main">⇒</span> <span class="free">remove_binding</span> <span class="bound">ty</span>
                        <span class="main">|</span> ToyTy_arrow <span class="bound">ty1</span> <span class="bound">ty2</span> <span class="main">⇒</span> ToyTy_arrow <span class="main">(</span><span class="free">remove_binding</span> <span class="bound">ty1</span><span class="main">)</span> <span class="main">(</span><span class="free">remove_binding</span> <span class="bound">ty2</span><span class="main">)</span>
                        <span class="main">|</span> <span class="bound">x</span> <span class="main">⇒</span> <span class="bound">x</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span>"</span></span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Class Translation Preliminaries›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">const_oid</span> <span class="main">=</span> <span class="inner_cartouche">‹oid›</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">var_ty_list</span> <span class="main">=</span> <span class="inner_cartouche">‹list›</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">var_ty_prod</span> <span class="main">=</span> <span class="inner_cartouche">‹prod›</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">const_toyany</span> <span class="main">=</span> <span class="inner_cartouche">‹ToyAny›</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">single_multip</span> <span class="main">=</span> 
  List.list_all <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> Some <span class="main">(</span>Mult_nat <span class="bound">n</span><span class="main">)</span><span class="main">)</span> <span class="main">⇒</span> <span class="bound">n</span> <span class="main">≤</span> <span class="main">1</span>
                 <span class="main">|</span> <span class="main">(</span>Mult_nat <span class="bound">n</span><span class="main">,</span> None<span class="main">)</span> <span class="main">⇒</span> <span class="bound">n</span> <span class="main">≤</span> <span class="main">1</span>
                 <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> False<span class="main">)</span> <span class="keyword1">o</span> TyMult"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">fold_max_aux</span> <span class="keyword2"><span class="keyword">where</span></span>
   <span class="quoted"><span class="quoted">"<span class="free">fold_max_aux</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">l_acc</span></span></span> <span class="free"><span class="bound"><span class="entity">accu</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="keyword1">of</span>
      <span class="main">[]</span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">accu</span></span></span>
    <span class="main">|</span> <span class="bound">x</span> <span class="main">#</span> <span class="bound">xs</span> <span class="main">⇒</span> <span class="free">fold_max_aux</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">xs</span> <span class="main">(</span><span class="bound">x</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">l_acc</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">x</span> <span class="main">(</span>L.flatten <span class="main">[</span>rev <span class="free"><span class="bound"><span class="entity">l_acc</span></span></span><span class="main">,</span> <span class="bound">xs</span><span class="main">]</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">accu</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">fold_max</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span> fold_max_aux <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>L.mapi Pair <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">[]</span>"</span></span>

<span class="keyword1"><span class="command">locale</span></span> RBTS
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">lookup</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> RBT.lookup <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">(</span>String.to_list <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">insert</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">insert</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> RBT.insert <span class="main">(</span>String.to_list <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">map_entry</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> RBT.map_entry <span class="main">(</span>String.to_list <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">modify_def</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> RBT.modify_def <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">(</span>String.to_list <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">keys</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">=</span> L.map <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">≪</span><span class="bound">s</span><span class="main">≫</span><span class="main">)</span> <span class="main">(</span>RBT.keys <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">lookup2</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">k1</span><span class="main">,</span> <span class="bound">k2</span><span class="main">)</span><span class="main">.</span> RBT.lookup2 <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">(</span>String.to_list <span class="bound">k1</span><span class="main">,</span> String.to_list <span class="bound">k2</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">insert2</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">k1</span><span class="main">,</span> <span class="bound">k2</span><span class="main">)</span><span class="main">.</span> RBT.insert2 <span class="main">(</span>String.to_list <span class="bound">k1</span><span class="main">,</span> String.to_list <span class="bound">k2</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">fold</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">fold</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> RBT.fold <span class="main">(</span><span class="main">λ</span><span class="bound">c</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">≪</span><span class="bound">c</span><span class="main">≫</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">entries</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">=</span> L.map <span class="main">(</span>map_prod <span class="main">(</span><span class="main">λ</span><span class="bound">c</span><span class="main">.</span> <span class="main">≪</span><span class="bound">c</span><span class="main">≫</span><span class="main">)</span> id<span class="main">)</span> <span class="main">(</span>RBT.entries <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">end</span></span>
<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">code</span><span class="main">]</span> <span class="main">=</span>
  <span class="comment1">― ‹def›</span>
  RBTS.lookup_def
  RBTS.insert_def
  RBTS.map_entry_def
  RBTS.modify_def_def
  RBTS.keys_def
  RBTS.lookup2_def
  RBTS.insert2_def
  RBTS.fold_def
  RBTS.entries_def

<span class="keyword1"><span class="command">syntax</span></span> <span class="quoted">"_rbt_lookup"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span>"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">lookup</span>"</span><span class="main">)</span> <span class="keyword1"><span class="command">translations</span></span> <span class="quoted">"<span class="keyword1">lookup</span>"</span> <span class="main">⇌</span> <span class="quoted">"<span class="keyword1">CONST</span> RBTS.lookup"</span>
<span class="keyword1"><span class="command">syntax</span></span> <span class="quoted">"_rbt_insert"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span>"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">insert</span>"</span><span class="main">)</span> <span class="keyword1"><span class="command">translations</span></span> <span class="quoted">"<span class="keyword1">insert</span>"</span> <span class="main">⇌</span> <span class="quoted">"<span class="keyword1">CONST</span> RBTS.insert"</span>
<span class="keyword1"><span class="command">syntax</span></span> <span class="quoted">"_rbt_map_entry"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span>"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">map'_entry</span>"</span><span class="main">)</span> <span class="keyword1"><span class="command">translations</span></span> <span class="quoted">"<span class="keyword1">map_entry</span>"</span> <span class="main">⇌</span> <span class="quoted">"<span class="keyword1">CONST</span> RBTS.map_entry"</span>
<span class="keyword1"><span class="command">syntax</span></span> <span class="quoted">"_rbt_modify_def"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span>"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">modify'_def</span>"</span><span class="main">)</span> <span class="keyword1"><span class="command">translations</span></span> <span class="quoted">"<span class="keyword1">modify_def</span>"</span> <span class="main">⇌</span> <span class="quoted">"<span class="keyword1">CONST</span> RBTS.modify_def"</span>
<span class="keyword1"><span class="command">syntax</span></span> <span class="quoted">"_rbt_keys"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span>"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">keys</span>"</span><span class="main">)</span> <span class="keyword1"><span class="command">translations</span></span> <span class="quoted">"<span class="keyword1">keys</span>"</span> <span class="main">⇌</span> <span class="quoted">"<span class="keyword1">CONST</span> RBTS.keys"</span>
<span class="keyword1"><span class="command">syntax</span></span> <span class="quoted">"_rbt_lookup2"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span>"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">lookup2</span>"</span><span class="main">)</span> <span class="keyword1"><span class="command">translations</span></span> <span class="quoted">"<span class="keyword1">lookup2</span>"</span> <span class="main">⇌</span> <span class="quoted">"<span class="keyword1">CONST</span> RBTS.lookup2"</span>
<span class="keyword1"><span class="command">syntax</span></span> <span class="quoted">"_rbt_insert2"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span>"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">insert2</span>"</span><span class="main">)</span> <span class="keyword1"><span class="command">translations</span></span> <span class="quoted">"<span class="keyword1">insert2</span>"</span> <span class="main">⇌</span> <span class="quoted">"<span class="keyword1">CONST</span> RBTS.insert2"</span>
<span class="keyword1"><span class="command">syntax</span></span> <span class="quoted">"_rbt_fold"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span>"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">fold</span>"</span><span class="main">)</span> <span class="keyword1"><span class="command">translations</span></span> <span class="quoted">"<span class="keyword1">fold</span>"</span> <span class="main">⇌</span> <span class="quoted">"<span class="keyword1">CONST</span> RBTS.fold"</span>
<span class="keyword1"><span class="command">syntax</span></span> <span class="quoted">"_rbt_entries"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span>"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">entries</span>"</span><span class="main">)</span> <span class="keyword1"><span class="command">translations</span></span> <span class="quoted">"<span class="keyword1">entries</span>"</span> <span class="main">⇌</span> <span class="quoted">"<span class="keyword1">CONST</span> RBTS.entries"</span>

<span class="keyword1"><span class="command">function</span></span> <span class="main">(</span>sequential<span class="main">)</span> <span class="entity">class_unflat_aux</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="comment1">(* (* FIXME replace with this simplified form *)
   "class_unflat_aux rbt rbt_inv rbt_cycle r =
   (case lookup rbt_cycle r of (None ― ‹cycle detection›) ⇒
      ToyClass
        r
        (case lookup rbt r of Some l ⇒ l)
        (L.map
          (class_unflat_aux rbt rbt_inv (insert r () rbt_cycle))
          (case lookup rbt_inv r of None ⇒ [] | Some l ⇒ l)))"
*)</span>
   <span class="quoted"><span class="quoted">"<span class="free">class_unflat_aux</span> <span class="free"><span class="bound"><span class="entity">rbt</span></span></span> <span class="free"><span class="bound"><span class="entity">rbt_inv</span></span></span> <span class="free"><span class="bound"><span class="entity">rbt_cycle</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span>
   <span class="main">(</span><span class="keyword1">case</span> <span class="keyword1">lookup</span> <span class="free"><span class="bound"><span class="entity">rbt_inv</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">of</span>
  None <span class="main">⇒</span>
<span class="main">(</span><span class="keyword1">case</span> <span class="keyword1">lookup</span> <span class="free"><span class="bound"><span class="entity">rbt_cycle</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">of</span> <span class="main">(</span>None <span class="comment1">― ‹cycle detection›</span><span class="main">)</span> <span class="main">⇒</span>
      ToyClass
        <span class="free"><span class="bound"><span class="entity">r</span></span></span>
        <span class="main">(</span><span class="keyword1">case</span> <span class="keyword1">lookup</span> <span class="free"><span class="bound"><span class="entity">rbt</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">of</span> Some <span class="bound">l</span> <span class="main">⇒</span> <span class="bound">l</span><span class="main">)</span>
        <span class="main">(</span> <span class="main">(</span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
<span class="main">|</span> Some <span class="bound">l</span> <span class="main">⇒</span>
<span class="main">(</span><span class="keyword1">case</span> <span class="keyword1">lookup</span> <span class="free"><span class="bound"><span class="entity">rbt_cycle</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">of</span> <span class="main">(</span>None <span class="comment1">― ‹cycle detection›</span><span class="main">)</span> <span class="main">⇒</span>
      ToyClass
        <span class="free"><span class="bound"><span class="entity">r</span></span></span>
        <span class="main">(</span><span class="keyword1">case</span> <span class="keyword1">lookup</span> <span class="free"><span class="bound"><span class="entity">rbt</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">of</span> Some <span class="bound">l</span> <span class="main">⇒</span> <span class="bound">l</span><span class="main">)</span>
        <span class="main">(</span>L.map
          <span class="main">(</span><span class="free">class_unflat_aux</span> <span class="free"><span class="bound"><span class="entity">rbt</span></span></span> <span class="free"><span class="bound"><span class="entity">rbt_inv</span></span></span> <span class="main">(</span><span class="keyword1">insert</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">()</span> <span class="free"><span class="bound"><span class="entity">rbt_cycle</span></span></span><span class="main">)</span><span class="main">)</span>
          <span class="main">(</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">pat_completeness</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">termination</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
 <span class="keyword1"><span class="command">have</span></span> arith_diff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a1</span> <span class="bound">a2</span> <span class="main">(</span><span class="bound">b</span> <span class="main">::</span> Nat.nat<span class="main">)</span><span class="main">.</span> <span class="bound">a1</span> <span class="main">=</span> <span class="bound">a2</span> <span class="main">⟹</span> <span class="bound">a1</span> <span class="main">&gt;</span> <span class="bound">b</span> <span class="main">⟹</span> <span class="bound">a1</span> <span class="main">-</span> <span class="main">(</span><span class="bound">b</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">&lt;</span> <span class="bound">a2</span> <span class="main">-</span> <span class="bound">b</span>"</span></span>
 <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>

 <span class="keyword1"><span class="command">have</span></span> arith_less<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="main">(</span><span class="bound">a</span><span class="main">::</span> Nat.nat<span class="main">)</span> <span class="bound">b</span> <span class="bound">c</span><span class="main">.</span> <span class="bound">b</span> <span class="main">≥</span> max <span class="main">(</span><span class="bound">a</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="bound">c</span> <span class="main">⟹</span> <span class="bound">a</span> <span class="main">&lt;</span> <span class="bound">b</span>"</span></span>
 <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>

 <span class="keyword1"><span class="command">have</span></span> rbt_length<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">rbt_cycle</span> <span class="bound">r</span> <span class="bound">v</span><span class="main">.</span> RBT.lookup <span class="bound">rbt_cycle</span> <span class="bound">r</span> <span class="main">=</span> None <span class="main">⟹</span>
     length <span class="main">(</span>RBT.keys <span class="main">(</span>RBT.insert <span class="bound">r</span> <span class="bound">v</span> <span class="bound">rbt_cycle</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> length <span class="main">(</span>RBT.keys <span class="bound">rbt_cycle</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> distinct_card<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">rule</span> distinct_keys<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> lookup_keys<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> card_insert_if domIff finite_dom_lookup<span class="main">)</span>

 <span class="keyword1"><span class="command">have</span></span> rbt_fold_union''<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ab</span> <span class="bound">a</span> <span class="bound">x</span> <span class="bound">k</span><span class="main">.</span> dom <span class="main">(</span><span class="main">λ</span><span class="bound">b</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">b</span> <span class="main">=</span> <span class="bound">ab</span> <span class="keyword1">then</span> Some <span class="bound">a</span> <span class="keyword1">else</span> <span class="bound">k</span> <span class="bound">b</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="bound">ab</span><span class="main">}</span> <span class="main">∪</span> dom <span class="bound">k</span>"</span></span>
 <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

 <span class="keyword1"><span class="command">have</span></span> rbt_fold_union'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">l</span> <span class="bound">rbt_inv</span> <span class="bound">a</span><span class="main">.</span>
       dom <span class="main">(</span>RBT.lookup <span class="main">(</span>List.fold <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">k</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> RBT.insert <span class="bound">k</span> <span class="bound">a</span><span class="main">)</span> <span class="bound">l</span> <span class="bound">rbt_inv</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
       dom <span class="main">(</span>map_of <span class="bound">l</span><span class="main">)</span> <span class="main">∪</span> dom <span class="main">(</span>RBT.lookup <span class="bound">rbt_inv</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> P <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">rbt_inv</span> <span class="main">.</span> dom <span class="main">(</span>RBT.lookup <span class="main">(</span>List.fold <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">k</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> RBT.insert <span class="bound">k</span> <span class="improper">a</span><span class="main">)</span> <span class="improper">l</span> <span class="bound">rbt_inv</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
       dom <span class="main">(</span>map_of <span class="improper">l</span><span class="main">)</span> <span class="main">∪</span> dom <span class="main">(</span>RBT.lookup <span class="bound">rbt_inv</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induct_tac</span> <span class="quoted"><span class="improper"><span class="quoted"><span class="improper">l</span></span></span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> allI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">aa</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rbt_fold_union''<span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

 <span class="keyword1"><span class="command">have</span></span> rbt_fold_union<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">rbt_cycle</span> <span class="bound">rbt_inv</span> <span class="bound">a</span><span class="main">.</span>
   dom <span class="main">(</span>RBT.lookup <span class="main">(</span>RBT.fold <span class="main">(</span><span class="main">λ</span><span class="bound">k</span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> RBT.insert <span class="bound">k</span> <span class="bound">a</span><span class="main">)</span> <span class="bound">rbt_cycle</span> <span class="bound">rbt_inv</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
   dom <span class="main">(</span>RBT.lookup <span class="bound">rbt_cycle</span><span class="main">)</span> <span class="main">∪</span> dom <span class="main">(</span>RBT.lookup <span class="bound">rbt_inv</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fold_fold<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> map_of_entries<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> rbt_fold_union'<span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

 <span class="keyword1"><span class="command">have</span></span> rbt_fold_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">rbt_cycle</span> <span class="bound">rbt_inv</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">.</span>
   dom <span class="main">(</span>RBT.lookup <span class="main">(</span>RBT.fold <span class="main">(</span><span class="main">λ</span><span class="bound">k</span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> RBT.insert <span class="bound">k</span> <span class="bound">a</span><span class="main">)</span> <span class="bound">rbt_cycle</span> <span class="bound">rbt_inv</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
   dom <span class="main">(</span>RBT.lookup <span class="main">(</span>RBT.fold <span class="main">(</span><span class="main">λ</span><span class="bound">k</span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> RBT.insert <span class="bound">k</span> <span class="bound">b</span><span class="main">)</span> <span class="bound">rbt_inv</span> <span class="bound">rbt_cycle</span><span class="main">)</span><span class="main">)</span>"</span></span>
 <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rbt_fold_union Un_commute<span class="main">)</span>

 <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?len</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> length <span class="main">(</span>RBT.keys <span class="bound">x</span><span class="main">)</span>"</span></span>
 <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?len_merge</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">rbt_cycle</span> <span class="bound">rbt_inv</span><span class="main">.</span> <span class="var">?len</span> <span class="main">(</span>RBT.fold <span class="main">(</span><span class="main">λ</span><span class="bound">k</span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> RBT.insert <span class="bound">k</span> <span class="main">[]</span><span class="main">)</span> <span class="bound">rbt_cycle</span> <span class="bound">rbt_inv</span><span class="main">)</span>"</span></span>

 <span class="keyword1"><span class="command">have</span></span> rbt_fold_large<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">rbt_cycle</span> <span class="bound">rbt_inv</span><span class="main">.</span> <span class="var">?len_merge</span> <span class="bound">rbt_cycle</span> <span class="bound">rbt_inv</span> <span class="main">≥</span> max <span class="main">(</span><span class="var">?len</span> <span class="bound">rbt_cycle</span><span class="main">)</span> <span class="main">(</span><span class="var">?len</span> <span class="bound">rbt_inv</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2 3<span class="main"><span class="main">)</span></span> distinct_card<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">rule</span> distinct_keys<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> lookup_keys<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> card_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rbt_fold_union<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

 <span class="keyword1"><span class="command">have</span></span> rbt_fold_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">rbt_cycle</span> <span class="bound">rbt_inv</span> <span class="bound">r</span> <span class="bound">a</span><span class="main">.</span>
     RBT.lookup <span class="bound">rbt_inv</span> <span class="bound">r</span> <span class="main">=</span> Some <span class="bound">a</span> <span class="main">⟹</span>
     <span class="var">?len_merge</span> <span class="main">(</span>RBT.insert <span class="bound">r</span> <span class="main">()</span> <span class="bound">rbt_cycle</span><span class="main">)</span> <span class="bound">rbt_inv</span> <span class="main">=</span> <span class="var">?len_merge</span> <span class="bound">rbt_cycle</span> <span class="bound">rbt_inv</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> distinct_card<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">rule</span> distinct_keys<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> lookup_keys<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rbt_fold_union<span class="main">)</span>
 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Un_insert_right insert_dom<span class="main">)</span>

 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">relation</span> <span class="quoted"><span class="quoted">"measure <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">rbt_inv</span><span class="main">,</span> <span class="bound">rbt_cycle</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span>
                           <span class="var">?len_merge</span> <span class="bound">rbt_cycle</span> <span class="bound">rbt_inv</span> <span class="main">-</span> <span class="var">?len</span> <span class="bound">rbt_cycle</span><span class="main">)</span>"</span></span>
       <span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> RBTS.lookup_def RBTS.insert_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> rbt_length<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> arith_diff<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> rbt_fold_eq<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> arith_less<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> rbt_length<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> rbt_fold_large<span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">ty_obj_to_string</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span>ToyTyObj <span class="main">(</span>ToyTyCore_pre <span class="bound">s</span><span class="main">)</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">cl_name_to_string</span> <span class="main">=</span> ty_obj_to_string <span class="keyword1">o</span> ClassRaw_name"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">class_unflat</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">l_class</span><span class="main">,</span> <span class="bound">l_ass</span><span class="main">)</span><span class="main">.</span>
  <span class="keyword1">let</span> <span class="bound">l</span> <span class="main">=</span>
    <span class="keyword1">let</span> <span class="bound">const_toyany'</span> <span class="main">=</span> ToyTyCore_pre const_toyany
      <span class="main">;</span> <span class="bound">rbt</span> <span class="main">=</span> <span class="comment1">― ‹fold classes:›</span>
              <span class="comment1">― ‹set <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>ToyAny›</span></span> as default inherited class (for all classes linking to zero inherited classes)›</span>
              <span class="keyword1">insert</span>
                const_toyany
                <span class="main">(</span>toy_class_raw.make <span class="main">(</span>ToyTyObj <span class="bound">const_toyany'</span> <span class="main">[]</span><span class="main">)</span> <span class="main">[]</span> <span class="main">[]</span> False<span class="main">)</span>
                <span class="main">(</span>List.fold
                  <span class="main">(</span><span class="main">λ</span> <span class="bound">cflat</span> <span class="main">⇒</span>
                    <span class="keyword1">insert</span> <span class="main">(</span>cl_name_to_string <span class="bound">cflat</span><span class="main">)</span> <span class="main">(</span><span class="bound">cflat</span> <span class="main">⦇</span> ClassRaw_name <span class="main">:=</span> <span class="keyword1">case</span> ClassRaw_name <span class="bound">cflat</span> <span class="keyword1">of</span> ToyTyObj <span class="bound">n</span> <span class="main">[]</span> <span class="main">⇒</span> ToyTyObj <span class="bound">n</span> <span class="main">[</span><span class="main">[</span><span class="bound">const_toyany'</span><span class="main">]</span><span class="main">]</span> <span class="main">|</span> <span class="bound">x</span> <span class="main">⇒</span> <span class="bound">x</span> <span class="main">⦈</span><span class="main">)</span><span class="main">)</span>
                  <span class="bound">l_class</span>
                  RBT.empty<span class="main">)</span> <span class="keyword1">in</span>
    <span class="comment1">― ‹fold associations:›</span>
    <span class="comment1">― ‹add remaining 'object' attributes›</span>
    L.map snd <span class="main">(</span><span class="keyword1">entries</span> <span class="main">(</span>List.fold <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">ass_oid</span><span class="main">,</span> <span class="bound">ass</span><span class="main">)</span> <span class="main">⇒</span>
      <span class="keyword1">let</span> <span class="bound">l_rel</span> <span class="main">=</span> ToyAss_relation' <span class="bound">ass</span> <span class="keyword1">in</span>
      fold_max
        <span class="main">(</span><span class="keyword1">let</span> <span class="bound">n_rel</span> <span class="main">=</span> natural_of_nat <span class="main">(</span>List.length <span class="bound">l_rel</span><span class="main">)</span> <span class="keyword1">in</span>
         <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">cpt_to</span><span class="main">,</span> <span class="main">(</span><span class="bound">name_to</span><span class="main">,</span> <span class="bound">category_to</span><span class="main">)</span><span class="main">)</span><span class="main">.</span>
           <span class="keyword1">case</span> TyRole <span class="bound">category_to</span> <span class="keyword1">of</span>
             Some <span class="bound">role_to</span> <span class="main">⇒</span>
               List.fold <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">cpt_from</span><span class="main">,</span> <span class="main">(</span><span class="bound">name_from</span><span class="main">,</span> <span class="bound">mult_from</span><span class="main">)</span><span class="main">)</span><span class="main">.</span>
                 <span class="keyword1">let</span> <span class="bound">name_from</span> <span class="main">=</span> ty_obj_to_string <span class="bound">name_from</span> <span class="keyword1">in</span>
                 <span class="keyword1">map_entry</span> <span class="bound">name_from</span> <span class="main">(</span><span class="main">λ</span><span class="bound">cflat</span><span class="main">.</span> <span class="bound">cflat</span> <span class="main">⦇</span> ClassRaw_own <span class="main">:=</span> <span class="main">(</span><span class="bound">role_to</span><span class="main">,</span>
                   ToyTy_class <span class="main">(</span>toy_ty_class_ext const_oid <span class="bound">ass_oid</span> <span class="bound">n_rel</span>
                     <span class="main">(</span>toy_ty_class_node_ext <span class="bound">cpt_from</span> <span class="bound">mult_from</span> <span class="bound">name_from</span> <span class="main">()</span><span class="main">)</span>
                     <span class="main">(</span>toy_ty_class_node_ext <span class="bound">cpt_to</span> <span class="bound">category_to</span> <span class="main">(</span>ty_obj_to_string <span class="bound">name_to</span><span class="main">)</span> <span class="main">()</span><span class="main">)</span>
                     <span class="main">()</span><span class="main">)</span><span class="main">)</span> <span class="main">#</span> ClassRaw_own <span class="bound">cflat</span> <span class="main">⦈</span><span class="main">)</span><span class="main">)</span>
           <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> id<span class="main">)</span><span class="main">)</span>
        <span class="bound">l_rel</span><span class="main">)</span> <span class="main">(</span>L.mapi Pair <span class="bound">l_ass</span><span class="main">)</span> <span class="bound">rbt</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">in</span>
  class_unflat_aux
    <span class="main">(</span>List.fold <span class="main">(</span><span class="main">λ</span> <span class="bound">cflat</span><span class="main">.</span> <span class="keyword1">insert</span> <span class="main">(</span>cl_name_to_string <span class="bound">cflat</span><span class="main">)</span> <span class="main">(</span>L.map <span class="main">(</span>map_prod id remove_binding<span class="main">)</span> <span class="main">(</span>ClassRaw_own <span class="bound">cflat</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="bound">l</span> RBT.empty<span class="main">)</span>
    <span class="main">(</span>List.fold
      <span class="main">(</span><span class="main">λ</span> <span class="bound">cflat</span><span class="main">.</span>
        <span class="keyword1">case</span> ClassRaw_name <span class="bound">cflat</span> <span class="keyword1">of</span>
          ToyTyObj <span class="bound">n</span> <span class="main">[]</span> <span class="main">⇒</span> id
        <span class="main">|</span> ToyTyObj <span class="bound">n</span> <span class="bound">l</span> <span class="main">⇒</span> <span class="keyword1">case</span> rev <span class="main">(</span><span class="main">[</span><span class="bound">n</span><span class="main">]</span> <span class="main">#</span> <span class="bound">l</span><span class="main">)</span> <span class="keyword1">of</span> <span class="bound">x0</span> <span class="main">#</span> <span class="bound">xs</span> <span class="main">⇒</span> <span class="main">λ</span><span class="bound">rbt</span><span class="main">.</span> 
            snd <span class="main">(</span>List.fold
                  <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span> <span class="main">(</span><span class="bound">x0</span><span class="main">,</span> <span class="bound">rbt</span><span class="main">)</span><span class="main">.</span>
                    <span class="main">(</span><span class="bound">x</span><span class="main">,</span> List.fold <span class="main">(</span><span class="main">λ</span> ToyTyCore_pre <span class="bound">k</span> <span class="main">⇒</span> <span class="keyword1">modify_def</span> <span class="main">[]</span> <span class="bound">k</span> <span class="main">(</span><span class="main">λ</span><span class="bound">l</span><span class="main">.</span> L.flatten <span class="main">[</span>L.map <span class="main">(</span><span class="main">λ</span>ToyTyCore_pre <span class="bound">s</span> <span class="main">⇒</span> <span class="bound">s</span><span class="main">)</span> <span class="bound">x</span><span class="main">,</span> <span class="bound">l</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>
                                  <span class="bound">x0</span>
                                  <span class="bound">rbt</span><span class="main">)</span><span class="main">)</span>
                  <span class="bound">xs</span>
                  <span class="main">(</span><span class="bound">x0</span><span class="main">,</span> <span class="bound">rbt</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
      <span class="bound">l</span>
      RBT.empty<span class="main">)</span>
    RBT.empty
    const_toyany<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">apply_optim_ass_arity</span> <span class="free"><span class="bound"><span class="entity">ty_obj</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">if</span> TyObj_ass_arity <span class="free"><span class="bound"><span class="entity">ty_obj</span></span></span> <span class="main">≤</span> <span class="numeral">2</span> <span class="keyword1">then</span> None
   <span class="keyword1">else</span> Some <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">is_higher_order</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> ToyTy_collection <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> True <span class="main">|</span> ToyTy_pair <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> True <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> False<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">parse_ty_raw</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> ToyTy_raw <span class="bound">s</span> <span class="main">⇒</span> <span class="keyword1">if</span> <span class="bound">s</span> <span class="main">=</span> <span class="inner_cartouche">‹int›</span> <span class="keyword1">then</span> ToyTy_base_integer <span class="keyword1">else</span> ToyTy_raw <span class="bound">s</span>
                            <span class="main">|</span> <span class="bound">x</span> <span class="main">⇒</span> <span class="bound">x</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">is_sequence</span> <span class="main">=</span> list_ex <span class="main">(</span><span class="main">λ</span> Sequence <span class="main">⇒</span> True <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> False<span class="main">)</span> <span class="keyword1">o</span> TyCollect"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">str_of_ty</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">str_of_ty</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span>
 <span class="main">(</span><span class="main">λ</span> ToyTy_base_void <span class="main">⇒</span> <span class="inner_cartouche">‹Void›</span>
  <span class="main">|</span> ToyTy_base_boolean <span class="main">⇒</span> <span class="inner_cartouche">‹Boolean›</span>
  <span class="main">|</span> ToyTy_base_integer <span class="main">⇒</span> <span class="inner_cartouche">‹Integer›</span>
  <span class="main">|</span> ToyTy_base_unlimitednatural <span class="main">⇒</span> <span class="inner_cartouche">‹UnlimitedNatural›</span>
  <span class="main">|</span> ToyTy_base_real <span class="main">⇒</span> <span class="inner_cartouche">‹Real›</span>
  <span class="main">|</span> ToyTy_base_string <span class="main">⇒</span> <span class="inner_cartouche">‹String›</span>
  <span class="main">|</span> ToyTy_object <span class="main">(</span>ToyTyObj <span class="main">(</span>ToyTyCore_pre <span class="bound">s</span><span class="main">)</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">⇒</span> <span class="bound">s</span>
  <span class="comment1">⌦‹| ToyTy_object (ToyTyObj (ToyTyCore ty_obj) _)›</span>
  <span class="main">|</span> ToyTy_collection <span class="bound">t</span> <span class="bound">toy_ty</span> <span class="main">⇒</span> <span class="main">(</span><span class="keyword1">if</span> is_sequence <span class="bound">t</span> <span class="keyword1">then</span>
                                    S.flatten <span class="main">[</span><span class="inner_cartouche">‹Sequence(›</span><span class="main">,</span> <span class="free">str_of_ty</span> <span class="bound">toy_ty</span><span class="main">,</span><span class="inner_cartouche">‹)›</span><span class="main">]</span>
                                  <span class="keyword1">else</span>
                                    S.flatten <span class="main">[</span><span class="inner_cartouche">‹Set(›</span><span class="main">,</span> <span class="free">str_of_ty</span> <span class="bound">toy_ty</span><span class="main">,</span><span class="inner_cartouche">‹)›</span><span class="main">]</span><span class="main">)</span>
  <span class="main">|</span> ToyTy_pair <span class="bound">toy_ty1</span> <span class="bound">toy_ty2</span> <span class="main">⇒</span> S.flatten <span class="main">[</span><span class="inner_cartouche">‹Pair(›</span><span class="main">,</span> <span class="free">str_of_ty</span> <span class="bound">toy_ty1</span><span class="main">,</span> <span class="inner_cartouche">‹,›</span><span class="main">,</span> <span class="free">str_of_ty</span> <span class="bound">toy_ty2</span><span class="main">,</span><span class="inner_cartouche">‹)›</span><span class="main">]</span>
  <span class="main">|</span> ToyTy_binding <span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">toy_ty</span><span class="main">)</span> <span class="main">⇒</span> <span class="free">str_of_ty</span> <span class="bound">toy_ty</span>
  <span class="main">|</span> ToyTy_class_syn <span class="bound">s</span> <span class="main">⇒</span> <span class="bound">s</span>
  <span class="main">|</span> ToyTy_enum <span class="bound">s</span> <span class="main">⇒</span> <span class="bound">s</span>
  <span class="main">|</span> ToyTy_raw <span class="bound">s</span> <span class="main">⇒</span> S.flatten <span class="main">[</span><span class="inner_cartouche">‹´›</span><span class="main">,</span> <span class="bound">s</span><span class="main">,</span> <span class="inner_cartouche">‹´›</span><span class="main">]</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">ty_void</span> <span class="main">=</span> str_of_ty ToyTy_base_void"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">ty_boolean</span> <span class="main">=</span> str_of_ty ToyTy_base_boolean"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">ty_integer</span> <span class="main">=</span> str_of_ty ToyTy_base_integer"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">ty_unlimitednatural</span> <span class="main">=</span> str_of_ty ToyTy_base_unlimitednatural"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">ty_real</span> <span class="main">=</span> str_of_ty ToyTy_base_real"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">ty_string</span> <span class="main">=</span> str_of_ty ToyTy_base_string"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">pref_ty_enum</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="inner_cartouche">‹ty_enum›</span> <span class="main">@@</span> String.isub <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">pref_ty_syn</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="inner_cartouche">‹ty_syn›</span> <span class="main">@@</span> String.isub <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">pref_constr_enum</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="inner_cartouche">‹constr›</span> <span class="main">@@</span> String.isub <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">str_hol_of_ty_all</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">str_hol_of_ty_all</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span>
 <span class="main">(</span><span class="main">λ</span> ToyTy_base_void <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="inner_cartouche">‹unit›</span>
  <span class="main">|</span> ToyTy_base_boolean <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="inner_cartouche">‹bool›</span>
  <span class="main">|</span> ToyTy_base_integer <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="inner_cartouche">‹int›</span>
  <span class="main">|</span> ToyTy_base_unlimitednatural <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="inner_cartouche">‹nat›</span>
  <span class="main">|</span> ToyTy_base_real <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="inner_cartouche">‹real›</span>
  <span class="main">|</span> ToyTy_base_string <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="inner_cartouche">‹string›</span>
  <span class="main">|</span> ToyTy_object <span class="main">(</span>ToyTyObj <span class="main">(</span>ToyTyCore_pre <span class="bound">s</span><span class="main">)</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> const_oid
  <span class="main">|</span> ToyTy_object <span class="main">(</span>ToyTyObj <span class="main">(</span>ToyTyCore <span class="bound">ty_obj</span><span class="main">)</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> var_ty_list<span class="main">)</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span>TyObj_name <span class="bound">ty_obj</span><span class="main">)</span><span class="main">]</span>
  <span class="main">|</span> ToyTy_collection <span class="main"><span class="bound">_</span></span> <span class="bound">ty</span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> var_ty_list<span class="main">)</span> <span class="main">[</span><span class="free">str_hol_of_ty_all</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="bound">ty</span><span class="main">]</span>
  <span class="main">|</span> ToyTy_pair <span class="bound">ty1</span> <span class="bound">ty2</span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> var_ty_prod<span class="main">)</span> <span class="main">[</span><span class="free">str_hol_of_ty_all</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="bound">ty1</span><span class="main">,</span> <span class="free">str_hol_of_ty_all</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="bound">ty2</span><span class="main">]</span>
  <span class="main">|</span> ToyTy_binding <span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span> <span class="main">⇒</span> <span class="free">str_hol_of_ty_all</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="bound">t</span>
  <span class="main">|</span> ToyTy_class_syn <span class="bound">s</span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span>pref_ty_syn <span class="bound">s</span><span class="main">)</span>
  <span class="main">|</span> ToyTy_enum <span class="bound">s</span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span>pref_ty_enum <span class="bound">s</span><span class="main">)</span>
  <span class="main">|</span> ToyTy_raw <span class="bound">s</span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="bound">s</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">get_class_hierarchy_strict_aux</span> <span class="keyword2"><span class="keyword">where</span></span>
   <span class="quoted"><span class="quoted">"<span class="free">get_class_hierarchy_strict_aux</span> <span class="free"><span class="bound"><span class="entity">dataty</span></span></span> <span class="free"><span class="bound"><span class="entity">l_res</span></span></span> <span class="main">=</span>
   <span class="main">(</span>List.fold
     <span class="main">(</span><span class="main">λ</span> ToyClass <span class="bound">name</span> <span class="bound">l_attr</span> <span class="bound">dataty</span> <span class="main">⇒</span> <span class="main">λ</span> <span class="bound">l_res</span><span class="main">.</span>
       <span class="free">get_class_hierarchy_strict_aux</span> <span class="bound">dataty</span> <span class="main">(</span>ToyClass <span class="bound">name</span> <span class="bound">l_attr</span> <span class="bound">dataty</span> <span class="main">#</span> <span class="bound">l_res</span><span class="main">)</span><span class="main">)</span>
     <span class="free"><span class="bound"><span class="entity">dataty</span></span></span>
     <span class="free"><span class="bound"><span class="entity">l_res</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">get_class_hierarchy_strict</span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">=</span> get_class_hierarchy_strict_aux <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">[]</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">get_class_hierarchy'_aux</span> <span class="keyword2"><span class="keyword">where</span></span>
   <span class="quoted"><span class="quoted">"<span class="free">get_class_hierarchy'_aux</span> <span class="free"><span class="bound"><span class="entity">l_res</span></span></span> <span class="main">(</span>ToyClass <span class="free"><span class="bound"><span class="entity">name</span></span></span> <span class="free"><span class="bound"><span class="entity">l_attr</span></span></span> <span class="free"><span class="bound"><span class="entity">dataty</span></span></span><span class="main">)</span> <span class="main">=</span>
   <span class="main">(</span><span class="keyword1">let</span> <span class="bound">l_res</span> <span class="main">=</span> ToyClass <span class="free"><span class="bound"><span class="entity">name</span></span></span> <span class="free"><span class="bound"><span class="entity">l_attr</span></span></span> <span class="free"><span class="bound"><span class="entity">dataty</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">l_res</span></span></span> <span class="keyword1">in</span>
    <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">dataty</span></span></span> <span class="keyword1">of</span> <span class="main">[]</span> <span class="main">⇒</span> rev <span class="bound">l_res</span>
                 <span class="main">|</span> <span class="bound">dataty</span> <span class="main">⇒</span> List.fold <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">acc</span><span class="main">.</span> <span class="free">get_class_hierarchy'_aux</span> <span class="bound">acc</span> <span class="bound">x</span><span class="main">)</span> <span class="bound">dataty</span> <span class="bound">l_res</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">get_class_hierarchy'</span> <span class="main">=</span> get_class_hierarchy'_aux <span class="main">[]</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">get_class_hierarchy</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> L.map <span class="main">(</span><span class="main">λ</span> ToyClass <span class="bound">n</span> <span class="bound">l</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="main">(</span><span class="bound">n</span><span class="main">,</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>get_class_hierarchy' <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">var_in_pre_state</span> <span class="main">=</span> <span class="inner_cartouche">‹in_pre_state›</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">var_in_post_state</span> <span class="main">=</span> <span class="inner_cartouche">‹in_post_state›</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">var_at_when_hol_post</span> <span class="main">=</span> <span class="inner_cartouche">‹›</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">var_at_when_hol_pre</span> <span class="main">=</span> <span class="inner_cartouche">‹at_pre›</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">var_at_when_toy_post</span> <span class="main">=</span> <span class="inner_cartouche">‹›</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">var_at_when_toy_pre</span> <span class="main">=</span> <span class="inner_cartouche">‹@pre›</span>"</span></span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="tfree">'a</span> tmp_sub <span class="main">=</span> Tsub <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>
<span class="keyword1"><span class="command">record</span></span> <span class="tfree">'a</span> inheritance <span class="main">=</span>
  Inh <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>
  Inh_sib <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'a</span> list <span class="comment1">― ‹flat version of the 1st component›</span><span class="main">)</span> list"</span></span> <span class="comment1">― ‹sibling›</span>
  Inh_sib_unflat <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list"</span></span> <span class="comment1">― ‹sibling›</span>
<span class="keyword1"><span class="command">datatype</span></span> <span class="tfree">'a</span> tmp_inh <span class="main">=</span> Tinh <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>
<span class="keyword1"><span class="command">datatype</span></span> <span class="tfree">'a</span> tmp_univ <span class="main">=</span> Tuniv <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">of_inh</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span>Tinh <span class="bound">l</span> <span class="main">⇒</span> <span class="bound">l</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">of_linh</span> <span class="main">=</span> L.map Inh"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">of_sub</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span>Tsub <span class="bound">l</span> <span class="main">⇒</span> <span class="bound">l</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">of_univ</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span>Tuniv <span class="bound">l</span> <span class="main">⇒</span> <span class="bound">l</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">map_inh</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span>Tinh <span class="bound">l</span> <span class="main">⇒</span> Tinh <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">fold_class_gen_aux</span> <span class="keyword2"><span class="keyword">where</span></span>
   <span class="quoted"><span class="quoted">"<span class="free">fold_class_gen_aux</span> <span class="free"><span class="bound"><span class="entity">l_inh</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">accu</span></span></span> <span class="main">(</span>ToyClass <span class="free"><span class="bound"><span class="entity">name</span></span></span> <span class="free"><span class="bound"><span class="entity">l_attr</span></span></span> <span class="free"><span class="bound"><span class="entity">dataty</span></span></span><span class="main">)</span> <span class="main">=</span>
 <span class="main">(</span><span class="keyword1">let</span> <span class="bound">accu</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">@@</span> String.isub <span class="free"><span class="bound"><span class="entity">name</span></span></span><span class="main">)</span>
               <span class="free"><span class="bound"><span class="entity">name</span></span></span>
               <span class="free"><span class="bound"><span class="entity">l_attr</span></span></span>
               <span class="main">(</span>Tinh <span class="free"><span class="bound"><span class="entity">l_inh</span></span></span><span class="main">)</span>
               <span class="main">(</span>Tsub <span class="main">(</span>get_class_hierarchy_strict <span class="free"><span class="bound"><span class="entity">dataty</span></span></span><span class="main">)</span><span class="main">)</span> <span class="comment1">― ‹order: bfs or dfs (modulo reversing)›</span>
               <span class="free"><span class="bound"><span class="entity">dataty</span></span></span>
               <span class="free"><span class="bound"><span class="entity">accu</span></span></span> <span class="keyword1">in</span>
  <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">dataty</span></span></span> <span class="keyword1">of</span> <span class="main">[]</span> <span class="main">⇒</span> <span class="bound">accu</span>
               <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span>
    fst <span class="main">(</span>List.fold
       <span class="main">(</span><span class="main">λ</span> <span class="bound">node</span> <span class="main">(</span><span class="bound">accu</span><span class="main">,</span> <span class="bound">l_inh_l</span><span class="main">,</span> <span class="bound">l_inh_r</span><span class="main">)</span><span class="main">.</span>
         <span class="main">(</span> <span class="free">fold_class_gen_aux</span>
             <span class="main">(</span> <span class="main">⦇</span> Inh <span class="main">=</span> ToyClass <span class="free"><span class="bound"><span class="entity">name</span></span></span> <span class="free"><span class="bound"><span class="entity">l_attr</span></span></span> <span class="free"><span class="bound"><span class="entity">dataty</span></span></span>
               <span class="main">,</span> Inh_sib <span class="main">=</span> L.flatten <span class="main">(</span>L.map <span class="main">(</span>L.map <span class="main">(</span><span class="main">λ</span><span class="bound">l</span><span class="main">.</span> <span class="main">(</span><span class="bound">l</span><span class="main">,</span> get_class_hierarchy' <span class="bound">l</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="bound">l_inh_l</span><span class="main">,</span> tl <span class="bound">l_inh_r</span><span class="main">]</span><span class="main">)</span>
               <span class="main">,</span> Inh_sib_unflat <span class="main">=</span> L.flatten <span class="main">[</span><span class="bound">l_inh_l</span><span class="main">,</span> tl <span class="bound">l_inh_r</span><span class="main">]</span> <span class="main">⦈</span>
             <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">l_inh</span></span></span><span class="main">)</span>
             <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">accu</span> <span class="bound">node</span>
         <span class="main">,</span> hd <span class="bound">l_inh_r</span> <span class="main">#</span> <span class="bound">l_inh_l</span>
         <span class="main">,</span> tl <span class="bound">l_inh_r</span><span class="main">)</span><span class="main">)</span>
      <span class="free"><span class="bound"><span class="entity">dataty</span></span></span>
      <span class="main">(</span><span class="bound">accu</span><span class="main">,</span> <span class="main">[]</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">dataty</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">fold_class_gen</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">accu</span></span></span> <span class="free"><span class="bound"><span class="entity">expr</span></span></span> <span class="main">=</span>
 <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">l_res</span><span class="main">,</span> <span class="bound">accu</span><span class="main">)</span> <span class="main">=</span>
    fold_class_gen_aux
      <span class="main">[]</span>
      <span class="main">(</span><span class="main">λ</span> <span class="bound">isub_name</span> <span class="bound">name</span> <span class="bound">l_attr</span> <span class="bound">l_inh</span> <span class="bound">l_subtree</span> <span class="bound">next_dataty</span> <span class="main">(</span><span class="bound">l_res</span><span class="main">,</span> <span class="bound">accu</span><span class="main">)</span><span class="main">.</span>
        <span class="keyword1">let</span> <span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="bound">accu</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">isub_name</span> <span class="bound">name</span> <span class="bound">l_attr</span> <span class="bound">l_inh</span> <span class="bound">l_subtree</span> <span class="bound">next_dataty</span> <span class="bound">accu</span> <span class="keyword1">in</span>
        <span class="main">(</span><span class="bound">r</span> <span class="main">#</span> <span class="bound">l_res</span><span class="main">,</span> <span class="bound">accu</span><span class="main">)</span><span class="main">)</span>
      <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">accu</span></span></span><span class="main">)</span>
      <span class="free"><span class="bound"><span class="entity">expr</span></span></span> <span class="keyword1">in</span>
  <span class="main">(</span>L.flatten <span class="bound">l_res</span><span class="main">,</span> <span class="bound">accu</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">map_class_gen</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> fst <span class="keyword1">o</span> fold_class_gen
  <span class="main">(</span><span class="main">λ</span> <span class="bound">isub_name</span> <span class="bound">name</span> <span class="bound">l_attr</span> <span class="bound">l_inh</span> <span class="bound">l_subtree</span> <span class="bound">last_d</span><span class="main">.</span> <span class="main">λ</span> <span class="main">()</span> <span class="main">⇒</span>
    <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">isub_name</span> <span class="bound">name</span> <span class="bound">l_attr</span> <span class="bound">l_inh</span> <span class="bound">l_subtree</span> <span class="bound">last_d</span><span class="main">,</span> <span class="main">()</span><span class="main">)</span><span class="main">)</span> <span class="main">()</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">add_hierarchy''''</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">isub_name</span> <span class="bound">name</span> <span class="bound">l_attr</span> <span class="bound">l_inh</span> <span class="bound">l_subtree</span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">isub_name</span> <span class="bound">name</span> <span class="main">(</span>Tuniv <span class="main">(</span>get_class_hierarchy <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">)</span> <span class="bound">l_attr</span> <span class="main">(</span>map_inh <span class="main">(</span>L.map <span class="main">(</span><span class="main">λ</span> ToyClass <span class="main"><span class="bound">_</span></span> <span class="bound">l</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="bound">l</span><span class="main">)</span> <span class="keyword1">o</span> of_linh<span class="main">)</span> <span class="bound">l_inh</span><span class="main">)</span> <span class="bound">l_subtree</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">map_class</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> map_class_gen <span class="main">(</span><span class="main">λ</span><span class="bound">isub_name</span> <span class="bound">name</span> <span class="bound">l_attr</span> <span class="bound">l_inh</span> <span class="bound">l_subtree</span> <span class="bound">next_dataty</span><span class="main">.</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">isub_name</span> <span class="bound">name</span> <span class="bound">l_attr</span> <span class="bound">l_inh</span> <span class="main">(</span>Tsub <span class="main">(</span>L.map <span class="main">(</span><span class="main">λ</span> ToyClass <span class="bound">n</span> <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="bound">n</span><span class="main">)</span> <span class="main">(</span>of_sub <span class="bound">l_subtree</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="bound">next_dataty</span><span class="main">]</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">fold_class</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> fold_class_gen <span class="main">(</span><span class="main">λ</span><span class="bound">isub_name</span> <span class="bound">name</span> <span class="bound">l_attr</span> <span class="bound">l_inh</span> <span class="bound">l_subtree</span> <span class="bound">next_dataty</span> <span class="bound">accu</span><span class="main">.</span> <span class="keyword1">let</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">accu</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">isub_name</span> <span class="bound">name</span> <span class="bound">l_attr</span> <span class="main">(</span>map_inh of_linh <span class="bound">l_inh</span><span class="main">)</span> <span class="main">(</span>Tsub <span class="main">(</span>L.map <span class="main">(</span><span class="main">λ</span> ToyClass <span class="bound">n</span> <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="bound">n</span><span class="main">)</span> <span class="main">(</span>of_sub <span class="bound">l_subtree</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="bound">next_dataty</span> <span class="bound">accu</span> <span class="keyword1">in</span> <span class="main">(</span><span class="main">[</span><span class="bound">x</span><span class="main">]</span><span class="main">,</span> <span class="bound">accu</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">map_class_gen_h''''</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> map_class_gen <span class="main">(</span>add_hierarchy'''' <span class="main">(</span><span class="main">λ</span><span class="bound">isub_name</span> <span class="bound">name</span> <span class="bound">l_inherited</span> <span class="bound">l_attr</span> <span class="bound">l_inh</span> <span class="bound">l_subtree</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">isub_name</span> <span class="bound">name</span> <span class="bound">l_inherited</span> <span class="bound">l_attr</span> <span class="bound">l_inh</span> <span class="main">(</span>Tsub <span class="main">(</span>L.map <span class="main">(</span><span class="main">λ</span> ToyClass <span class="bound">n</span> <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="bound">n</span><span class="main">)</span> <span class="main">(</span>of_sub <span class="bound">l_subtree</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">class_arity</span> <span class="main">=</span> RBT.keys <span class="keyword1">o</span> <span class="main">(</span><span class="main">λ</span><span class="bound">l</span><span class="main">.</span> List.fold <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> RBT.insert <span class="bound">x</span> <span class="main">()</span><span class="main">)</span> <span class="bound">l</span> RBT.empty<span class="main">)</span> <span class="keyword1">o</span>
  L.flatten <span class="keyword1">o</span> L.flatten <span class="keyword1">o</span> map_class <span class="main">(</span><span class="main">λ</span> <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span> <span class="bound">l_attr</span> <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">.</span>
    L.map <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> ToyTy_object <span class="main">(</span>ToyTyObj <span class="main">(</span>ToyTyCore <span class="bound">ty_obj</span><span class="main">)</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">[</span>TyObj_ass_arity <span class="bound">ty_obj</span><span class="main">]</span>
              <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="main">[]</span><span class="main">)</span> <span class="bound">l_attr</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">map_class_inh</span> <span class="free"><span class="bound"><span class="entity">l_inherited</span></span></span> <span class="main">=</span> L.map <span class="main">(</span><span class="main">λ</span> ToyClass <span class="main"><span class="bound">_</span></span> <span class="bound">l</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="bound">l</span><span class="main">)</span> <span class="main">(</span>of_inh <span class="main">(</span>map_inh of_linh <span class="free"><span class="bound"><span class="entity">l_inherited</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Meta_Toy_extended">
<div class="head">
<h1>Theory Meta_Toy_extended</h1>
</div>
<pre class="source"><span class="comment1">(******************************************************************************
 * HOL-TOY
 *
 * Copyright (c) 2011-2018 Université Paris-Saclay, Univ. Paris-Sud, France
 *               2013-2017 IRT SystemX, France
 *               2011-2015 Achim D. Brucker, Germany
 *               2016-2018 The University of Sheffield, UK
 *               2016-2017 Nanyang Technological University, Singapore
 *               2017-2018 Virginia Tech, USA
 *
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are
 * met:
 *
 *     * Redistributions of source code must retain the above copyright
 *       notice, this list of conditions and the following disclaimer.
 *
 *     * Redistributions in binary form must reproduce the above
 *       copyright notice, this list of conditions and the following
 *       disclaimer in the documentation and/or other materials provided
 *       with the distribution.
 *
 *     * Neither the name of the copyright holders nor the names of its
 *       contributors may be used to endorse or promote products derived
 *       from this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 ******************************************************************************)</span>

<span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹Toy Meta-Model aka. AST definition of Toy (II)›</span></span>

<span class="keyword1"><span class="command">theory</span></span>  Meta_Toy_extended
<span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="Init.html">../../../Init</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Type Definition›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> internal_oid <span class="main">=</span> Oid <span class="quoted"><span class="keyword1">nat</span></span>
<span class="keyword1"><span class="command">datatype</span></span> internal_oids <span class="main">=</span> Oids <span class="quoted"><span class="keyword1">nat</span></span> <span class="comment1">― ‹start›</span>
                              <span class="quoted"><span class="keyword1">nat</span></span> <span class="comment1">― ‹oid for assoc (incremented from start)›</span>
                              <span class="quoted"><span class="keyword1">nat</span></span> <span class="comment1">― ‹oid for inh (incremented from start)›</span>

<span class="keyword1"><span class="command">datatype</span></span> toy_def_base <span class="main">=</span> ToyDefInteger <span class="quoted"><span class="quoted">"<span class="keyword1">string</span>"</span></span> <span class="comment1">― ‹integer digit›</span>
                      <span class="main">|</span> ToyDefReal <span class="quoted"><span class="quoted">"<span class="keyword1">string</span> <span class="comment1">― ‹integer digit (left)›</span> <span class="main">×</span> <span class="keyword1">string</span> <span class="comment1">― ‹integer digit (right)›</span>"</span></span>
                      <span class="main">|</span> ToyDefString <span class="quoted"><span class="quoted">"<span class="keyword1">string</span>"</span></span>

<span class="keyword1"><span class="command">datatype</span></span> toy_data_shallow <span class="main">=</span> ShallB_term <span class="quoted">toy_def_base</span>
                          <span class="main">|</span> ShallB_str <span class="quoted"><span class="keyword1">string</span></span> <span class="comment1">― ‹binding›</span>
                          <span class="main">|</span> ShallB_self <span class="quoted">internal_oid</span>
                          <span class="main">|</span> ShallB_list <span class="quoted"><span class="quoted">"toy_data_shallow list"</span></span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="tfree">'a</span> toy_list_attr <span class="main">=</span> ToyAttrNoCast <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span> <span class="comment1">― ‹inh, own›</span>
                          <span class="main">|</span> ToyAttrCast
                              <span class="quoted"><span class="keyword1">string</span></span> <span class="comment1">― ‹cast from›</span>
                              <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> toy_list_attr"</span></span> <span class="comment1">― ‹cast entity›</span>
                              <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span> <span class="comment1">― ‹inh, own›</span>

<span class="keyword1"><span class="command">record</span></span> toy_instance_single <span class="main">=</span> Inst_name <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="keyword1">string</span> option"</span></span> <span class="comment1">― ‹None: fresh name to be generated›</span>
                             Inst_ty <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="keyword1">string</span> option"</span></span> <span class="comment1">― ‹type›</span>
                             Inst_attr <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>  <span class="main">(</span><span class="keyword1">string</span> <span class="comment1">― ‹pre state›</span> <span class="main">×</span> <span class="keyword1">string</span> <span class="comment1">― ‹post state›</span><span class="main">)</span> option
                                               <span class="comment1">― ‹state used when <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>toy_data_shallow›</span></span> is an object variable (for retrieving its oid)›</span>
                                             <span class="main">×</span> <span class="keyword1">string</span> <span class="comment1">― ‹name›</span>
                                             <span class="main">×</span> toy_data_shallow<span class="main">)</span> list<span class="main">)</span> <span class="comment1">― ‹inh and own›</span>
                                           toy_list_attr"</span></span>

<span class="keyword1"><span class="command">datatype</span></span> toy_instance <span class="main">=</span> ToyInstance <span class="quoted"><span class="quoted">"toy_instance_single list"</span></span> <span class="comment1">― ‹mutual recursive›</span>

<span class="keyword1"><span class="command">datatype</span></span> toy_def_base_l <span class="main">=</span> ToyDefBase <span class="quoted"><span class="quoted">"toy_def_base list"</span></span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="tfree">'a</span> toy_def_state_core <span class="main">=</span> ToyDefCoreAdd <span class="quoted">toy_instance_single</span>
                               <span class="main">|</span> ToyDefCoreBinding <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>

<span class="keyword1"><span class="command">datatype</span></span> toy_def_state <span class="main">=</span> ToyDefSt  <span class="quoted"><span class="keyword1">string</span></span> <span class="comment1">― ‹name›</span>
                                  <span class="quoted"><span class="quoted">"<span class="keyword1">string</span> <span class="comment1">― ‹name›</span> toy_def_state_core list"</span></span>

<span class="keyword1"><span class="command">datatype</span></span> toy_def_pp_core <span class="main">=</span> ToyDefPPCoreAdd <span class="quoted"><span class="quoted">"<span class="keyword1">string</span> <span class="comment1">― ‹name›</span> toy_def_state_core list"</span></span>
                         <span class="main">|</span> ToyDefPPCoreBinding <span class="quoted"><span class="keyword1">string</span></span> <span class="comment1">― ‹name›</span>

<span class="keyword1"><span class="command">datatype</span></span> toy_def_pre_post <span class="main">=</span> ToyDefPP
                              <span class="quoted"><span class="quoted">"<span class="keyword1">string</span> option"</span></span> <span class="comment1">― ‹None: fresh name to be generated›</span>
                              <span class="quoted">toy_def_pp_core</span> <span class="comment1">― ‹pre›</span>
                              <span class="quoted"><span class="quoted">"toy_def_pp_core option"</span></span> <span class="comment1">― ‹post›</span> <span class="comment1">― ‹None: same as pre›</span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Object ID Management›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">oidInit</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> Oid <span class="bound">n</span> <span class="main">⇒</span> Oids <span class="bound">n</span> <span class="bound">n</span> <span class="bound">n</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">oidSucAssoc</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> Oids <span class="bound">n1</span> <span class="bound">n2</span> <span class="bound">n3</span> <span class="main">⇒</span> Oids <span class="bound">n1</span> <span class="main">(</span>Succ <span class="bound">n2</span><span class="main">)</span> <span class="main">(</span>Succ <span class="bound">n3</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">oidSucInh</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> Oids <span class="bound">n1</span> <span class="bound">n2</span> <span class="bound">n3</span> <span class="main">⇒</span> Oids <span class="bound">n1</span> <span class="bound">n2</span> <span class="main">(</span>Succ <span class="bound">n3</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">oidGetAssoc</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> Oids <span class="main"><span class="bound">_</span></span> <span class="bound">n</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> Oid <span class="bound">n</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">oidGetInh</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> Oids <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span> <span class="bound">n</span> <span class="main">⇒</span> Oid <span class="bound">n</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">oidReinitAll</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span>Oids <span class="bound">n1</span> <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> Oids <span class="bound">n1</span> <span class="bound">n1</span> <span class="bound">n1</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">oidReinitInh</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span>Oids <span class="bound">n1</span> <span class="bound">n2</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> Oids <span class="bound">n1</span> <span class="bound">n2</span> <span class="bound">n2</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Operations of Fold, Map, ..., on the Meta-Model›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">toy_instance_single_empty</span> <span class="main">=</span> <span class="main">⦇</span> Inst_name <span class="main">=</span> None<span class="main">,</span> Inst_ty <span class="main">=</span> None<span class="main">,</span> Inst_attr <span class="main">=</span> ToyAttrNoCast <span class="main">[]</span> <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">map_data_shallow_self</span> <span class="keyword2"><span class="keyword">where</span></span>
   <span class="quoted"><span class="quoted">"<span class="free">map_data_shallow_self</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> ShallB_self <span class="bound">s</span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">s</span>
                                 <span class="main">|</span> ShallB_list <span class="bound">l</span> <span class="main">⇒</span> ShallB_list <span class="main">(</span>List.map <span class="main">(</span><span class="free">map_data_shallow_self</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="bound">l</span><span class="main">)</span>
                                 <span class="main">|</span> <span class="bound">x</span> <span class="main">⇒</span> <span class="bound">x</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">map_list_attr</span> <span class="keyword2"><span class="keyword">where</span></span>
   <span class="quoted"><span class="quoted">"<span class="free">map_list_attr</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> 
     <span class="main">(</span><span class="main">λ</span> ToyAttrNoCast <span class="bound">x</span> <span class="main">⇒</span> ToyAttrNoCast <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">x</span><span class="main">)</span>
      <span class="main">|</span> ToyAttrCast <span class="bound">c_from</span> <span class="bound">l_attr</span> <span class="bound">x</span> <span class="main">⇒</span> ToyAttrCast <span class="bound">c_from</span> <span class="main">(</span><span class="free">map_list_attr</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">l_attr</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">map_instance_single</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">toyi</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">toyi</span></span></span> <span class="main">⦇</span> Inst_attr <span class="main">:=</span> map_list_attr <span class="main">(</span>L.map <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="main">(</span>Inst_attr <span class="free"><span class="bound"><span class="entity">toyi</span></span></span><span class="main">)</span> <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">fold_list_attr</span> <span class="keyword2"><span class="keyword">where</span></span>
   <span class="quoted"><span class="quoted">"<span class="free">fold_list_attr</span> <span class="free"><span class="bound"><span class="entity">cast_from</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">l_attr</span></span></span> <span class="free"><span class="bound"><span class="entity">accu</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">l_attr</span></span></span> <span class="keyword1">of</span>
        ToyAttrNoCast <span class="bound">x</span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">cast_from</span></span></span> <span class="bound">x</span> <span class="free"><span class="bound"><span class="entity">accu</span></span></span>
      <span class="main">|</span> ToyAttrCast <span class="bound">c_from</span> <span class="bound">l_attr</span> <span class="bound">x</span> <span class="main">⇒</span> <span class="free">fold_list_attr</span> <span class="main">(</span>Some <span class="bound">c_from</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">l_attr</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">cast_from</span></span></span> <span class="bound">x</span> <span class="free"><span class="bound"><span class="entity">accu</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">inst_ty0</span> <span class="free"><span class="bound"><span class="entity">toyi</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> Inst_ty <span class="free"><span class="bound"><span class="entity">toyi</span></span></span> <span class="keyword1">of</span> Some <span class="bound">ty</span> <span class="main">⇒</span> Some <span class="bound">ty</span>
                                                <span class="main">|</span> None <span class="main">⇒</span> <span class="main">(</span><span class="keyword1">case</span> Inst_attr <span class="free"><span class="bound"><span class="entity">toyi</span></span></span> <span class="keyword1">of</span> ToyAttrCast <span class="bound">ty</span> <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> Some <span class="bound">ty</span>
                                                                                <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> None<span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">inst_ty</span> <span class="free"><span class="bound"><span class="entity">toyi</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> inst_ty0 <span class="free"><span class="bound"><span class="entity">toyi</span></span></span> <span class="keyword1">of</span> Some <span class="bound">ty</span> <span class="main">⇒</span> <span class="bound">ty</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">fold_instance_single</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">toyi</span></span></span> <span class="main">=</span> fold_list_attr <span class="main">(</span>inst_ty0 <span class="free"><span class="bound"><span class="entity">toyi</span></span></span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span> Some <span class="bound">x</span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span>Inst_attr <span class="free"><span class="bound"><span class="entity">toyi</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">fold_instance_single'</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">toyi</span></span></span> <span class="main">=</span> fold_list_attr <span class="main">(</span>Inst_ty <span class="free"><span class="bound"><span class="entity">toyi</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>Inst_attr <span class="free"><span class="bound"><span class="entity">toyi</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Meta_META">
<div class="head">
<h1>Theory Meta_META</h1>
</div>
<pre class="source"><span class="comment1">(******************************************************************************
 * Citadelle
 *
 * Copyright (c) 2011-2018 Université Paris-Saclay, Univ. Paris-Sud, France
 *               2013-2017 IRT SystemX, France
 *               2011-2015 Achim D. Brucker, Germany
 *               2016-2018 The University of Sheffield, UK
 *               2016-2017 Nanyang Technological University, Singapore
 *               2017-2018 Virginia Tech, USA
 *
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are
 * met:
 *
 *     * Redistributions of source code must retain the above copyright
 *       notice, this list of conditions and the following disclaimer.
 *
 *     * Redistributions in binary form must reproduce the above
 *       copyright notice, this list of conditions and the following
 *       disclaimer in the documentation and/or other materials provided
 *       with the distribution.
 *
 *     * Neither the name of the copyright holders nor the names of its
 *       contributors may be used to endorse or promote products derived
 *       from this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 ******************************************************************************)</span>

<span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹Regrouping Together All Existing Meta-Models›</span></span>

<span class="keyword1"><span class="command">theory</span></span>  Meta_META
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Meta_Toy.html">Meta_Toy</a>
        <a href="Meta_Toy_extended.html">Meta_Toy_extended</a>
        <span class="quoted">"<a href="Meta_Isabelle.html">../../../meta_isabelle/Meta_Isabelle</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹A Basic Meta-Model›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The following basic Meta-Model is an empty Meta-Model.›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Most of the Meta-Model we have defined (in particular those defined in Toy)
     can be used in exceptional situations 
     for requiring an eager or lazy interactive evaluation of already encountered Meta-Models.
     This is also the case for this basic Meta-Model.›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> toy_flush_all <span class="main">=</span> ToyFlushAll

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹The META Meta-Model (I)›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> floor <span class="main">=</span> Floor1 <span class="main">|</span> Floor2 <span class="main">|</span> Floor3 <span class="comment1">(* NOTE nat can be used *)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹
Meta-Models can be seen as arranged in a semantic tower with several floors.
By default, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">Floor1</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> corresponds to the first level we are situating by default,
then a subsequent meta-evaluation would jump to a deeper floor,
to <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">Floor2</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, then <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">Floor3</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>...›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹
It is not mandatory to jump to a floor superior than the one we currently are.
The important point is to be sure that all jumps will ultimately terminate.›</span></span>

<span class="comment1">(* *)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹
Most of the following constructors are preceded by an additional
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">floor</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> field, which explicitly indicates the intended associated semantic to consider
during the meta-embedding to Isabelle.
In case no <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">floor</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is precised, we fix it to be <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">Floor1</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> by default.›</span></span>

<span class="comment1">(* le meta-model de "tout le monde" - frederic. *)</span>
<span class="keyword1"><span class="command">datatype</span></span> all_meta_embedding <span class="main">=</span> META_enum <span class="quoted">toy_enum</span>
                            <span class="main">|</span> META_class_raw <span class="quoted">floor</span> <span class="quoted">toy_class_raw</span>
                            <span class="main">|</span> META_association <span class="quoted">toy_association</span>
                            <span class="main">|</span> META_ass_class <span class="quoted">floor</span> <span class="quoted">toy_ass_class</span>
                            <span class="main">|</span> META_ctxt <span class="quoted">floor</span> <span class="quoted">toy_ctxt</span>
                            <span class="main">|</span> META_class_synonym <span class="quoted">toy_class_synonym</span>
                            <span class="main">|</span> META_instance <span class="quoted">toy_instance</span>
                            <span class="main">|</span> META_def_base_l <span class="quoted">toy_def_base_l</span>
                            <span class="main">|</span> META_def_state <span class="quoted">floor</span> <span class="quoted">toy_def_state</span>
                            <span class="main">|</span> META_def_pre_post <span class="quoted">floor</span> <span class="quoted">toy_def_pre_post</span>
                            <span class="main">|</span> META_flush_all <span class="quoted">toy_flush_all</span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Main Compiling Environment›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The environment constitutes the main data-structure carried by all monadic translations.›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> generation_semantics_toy <span class="main">=</span> Gen_only_design <span class="main">|</span> Gen_only_analysis <span class="main">|</span> Gen_default
<span class="keyword1"><span class="command">datatype</span></span> generation_lemma_mode <span class="main">=</span> Gen_sorry <span class="main">|</span> Gen_no_dirty

<span class="keyword1"><span class="command">record</span></span> compiler_env_config <span class="main">=</span>  D_output_disable_thy <span class="main">::</span> <span class="quoted">bool</span>
                              D_output_header_thy <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">string</span> <span class="comment1">― ‹theory›</span>
                                                      <span class="main">×</span> <span class="keyword1">string</span> list <span class="comment1">― ‹imports›</span>
                                                      <span class="main">×</span> <span class="keyword1">string</span> <span class="comment1">― ‹import optional (compiler bootstrap)›</span><span class="main">)</span> option"</span></span>
                              D_toy_oid_start <span class="main">::</span> <span class="quoted">internal_oids</span>
                              D_output_position <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="keyword1">nat</span> <span class="main">×</span> <span class="keyword1">nat</span>"</span></span>
                              D_toy_semantics <span class="main">::</span> <span class="quoted">generation_semantics_toy</span>
                              D_input_class <span class="main">::</span> <span class="quoted"><span class="quoted">"toy_class option"</span></span>
                                               <span class="comment1">― ‹last class considered for the generation›</span>
                              D_input_meta <span class="main">::</span> <span class="quoted"><span class="quoted">"all_meta_embedding list"</span></span>
                              D_input_instance <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>string<span class="hidden">⇩</span><sub>b</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>e</sub> <span class="comment1">― ‹name (as key for rbt)›</span>
                                                   <span class="main">×</span> toy_instance_single
                                                   <span class="main">×</span> internal_oids<span class="main">)</span> list"</span></span>
                                                  <span class="comment1">― ‹instance namespace environment›</span>
                              D_input_state <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>string<span class="hidden">⇩</span><sub>b</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>e</sub> <span class="comment1">― ‹name (as key for rbt)›</span>
                                                <span class="main">×</span> <span class="main">(</span>internal_oids
                                                <span class="main">×</span> <span class="main">(</span><span class="keyword1">string</span> <span class="comment1">― ‹name›</span>
                                                  <span class="main">×</span> toy_instance_single <span class="comment1">― ‹alias›</span><span class="main">)</span>
                                                  toy_def_state_core<span class="main">)</span> list<span class="main">)</span> list"</span></span>
                                               <span class="comment1">― ‹state namespace environment›</span>
                              D_output_header_force <span class="main">::</span> <span class="quoted">bool</span> <span class="comment1">― ‹true : the header should import the compiler for bootstrapping›</span>
                              D_output_auto_bootstrap <span class="main">::</span> <span class="quoted">bool</span> <span class="comment1">― ‹true : add the generation_syntax command›</span>
                              D_toy_accessor <span class="main">::</span> <span class="quoted"><span class="quoted">" string<span class="hidden">⇩</span><sub>b</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>e</sub> <span class="comment1">― ‹name of the constant added›</span> list <span class="comment1">― ‹pre›</span>
                                                <span class="main">×</span> string<span class="hidden">⇩</span><sub>b</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>e</sub> <span class="comment1">― ‹name of the constant added›</span> list <span class="comment1">― ‹post›</span>"</span></span>
                              D_toy_HO_type <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>string<span class="hidden">⇩</span><sub>b</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>e</sub> <span class="comment1">― ‹raw HOL name (as key for rbt)›</span><span class="main">)</span> list"</span></span>
                              D_output_sorry_dirty <span class="main">::</span> <span class="quoted"><span class="quoted">"generation_lemma_mode option <span class="main">×</span> bool <span class="comment1">― ‹dirty›</span>"</span></span> <span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>Some Gen_sorry›</span></span> or <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>None›</span></span> and <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>{dirty}›</span></span>: activate sorry mode for skipping proofs›</span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Operations of Fold, Map, ..., on the Meta-Model›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">ignore_meta_header</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> META_class_raw Floor1 <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> True
                                  <span class="main">|</span> META_ass_class Floor1 <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> True
                                  <span class="main">|</span> META_ctxt Floor1 <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> True
                                  <span class="main">|</span> META_def_state Floor1 <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> True
                                  <span class="main">|</span> META_def_pre_post Floor1 <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> True
                                  <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> False<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">map2_ctxt_term</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span>
 <span class="main">(</span><span class="keyword1">let</span> <span class="bound">f_prop</span> <span class="main">=</span> <span class="main">λ</span> ToyProp_ctxt <span class="bound">n</span> <span class="bound">prop</span> <span class="main">⇒</span> ToyProp_ctxt <span class="bound">n</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">prop</span><span class="main">)</span>
    <span class="main">;</span> <span class="bound">f_inva</span> <span class="main">=</span> <span class="main">λ</span> T_inv <span class="bound">b</span> <span class="bound">prop</span> <span class="main">⇒</span> T_inv <span class="bound">b</span> <span class="main">(</span><span class="bound">f_prop</span> <span class="bound">prop</span><span class="main">)</span> <span class="keyword1">in</span>
  <span class="main">λ</span> META_ctxt Floor2 <span class="bound">c</span> <span class="main">⇒</span>
    META_ctxt Floor2
      <span class="main">(</span>Ctxt_clause_update
        <span class="main">(</span>L.map <span class="main">(</span><span class="main">λ</span> Ctxt_pp <span class="bound">pp</span> <span class="main">⇒</span> Ctxt_pp <span class="main">(</span>Ctxt_expr_update <span class="main">(</span>L.map <span class="main">(</span><span class="main">λ</span> T_pp <span class="bound">pref</span> <span class="bound">prop</span> <span class="main">⇒</span> T_pp <span class="bound">pref</span> <span class="main">(</span><span class="bound">f_prop</span> <span class="bound">prop</span><span class="main">)</span>
                                                                        <span class="main">|</span> T_invariant <span class="bound">inva</span> <span class="main">⇒</span> T_invariant <span class="main">(</span><span class="bound">f_inva</span> <span class="bound">inva</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="bound">pp</span><span class="main">)</span>
                   <span class="main">|</span> Ctxt_inv <span class="bound">l_inv</span> <span class="main">⇒</span> Ctxt_inv <span class="main">(</span><span class="bound">f_inva</span> <span class="bound">l_inv</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="bound">c</span><span class="main">)</span>
  <span class="main">|</span> <span class="bound">x</span> <span class="main">⇒</span> <span class="bound">x</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">compiler_env_config_more_map</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">toy</span></span></span> <span class="main">=</span>
            compiler_env_config.extend  <span class="main">(</span>compiler_env_config.truncate <span class="free"><span class="bound"><span class="entity">toy</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>compiler_env_config.more <span class="free"><span class="bound"><span class="entity">toy</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹The META Meta-Model (II)›</span></span>
<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹Type Definition›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹
For bootstrapping the environment through the jumps to another semantic floor, we additionally
consider the environment as a Meta-Model.›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> boot_generation_syntax <span class="main">=</span> Boot_generation_syntax <span class="quoted">generation_semantics_toy</span>
<span class="keyword1"><span class="command">datatype</span></span> boot_setup_env <span class="main">=</span> Boot_setup_env <span class="quoted">compiler_env_config</span>

<span class="keyword1"><span class="command">datatype</span></span> all_meta <span class="main">=</span> <span class="comment1">― ‹pure Isabelle›</span>
                    META_semi__theories <span class="quoted">semi__theories</span>

                    <span class="comment1">― ‹bootstrapping embedded languages›</span>
                  <span class="main">|</span> META_boot_generation_syntax <span class="quoted">boot_generation_syntax</span>
                  <span class="main">|</span> META_boot_setup_env <span class="quoted">boot_setup_env</span>
                  <span class="main">|</span> META_all_meta_embedding <span class="quoted">all_meta_embedding</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹As remark, the Isabelle Meta-Model represented by <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">semi__theories</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> can be merged
with the previous META Meta-Model <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">all_meta_embedding</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. 
However a corresponding parser and printer would then be required.›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹Extending the Meta-Model›</span></span>

<span class="keyword1"><span class="command">locale</span></span> O <span class="comment1">― ‹outer syntax›</span>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> META_semi__theories <span class="keyword1">o</span> Theories_one <span class="keyword1">o</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">datatype</span> <span class="main">=</span> i Theory_datatype"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">type_synonym</span> <span class="main">=</span> i Theory_type_synonym"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">type_notation</span> <span class="main">=</span> i Theory_type_notation"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">instantiation</span> <span class="main">=</span> i Theory_instantiation"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">overloading</span> <span class="main">=</span> i Theory_overloading"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">consts</span> <span class="main">=</span> i Theory_consts"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">definition</span> <span class="main">=</span> i Theory_definition"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">lemmas</span> <span class="main">=</span> i Theory_lemmas"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">lemma</span> <span class="main">=</span> i Theory_lemma"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">axiomatization</span> <span class="main">=</span> i Theory_axiomatization"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">section</span> <span class="main">=</span> i Theory_section"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">text</span> <span class="main">=</span> i Theory_text"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">ML</span> <span class="main">=</span> i Theory_ML"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">setup</span> <span class="main">=</span> i Theory_setup"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">thm</span> <span class="main">=</span> i Theory_thm"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">interpretation</span> <span class="main">=</span> i Theory_interpretation"</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">code</span><span class="main">]</span> <span class="main">=</span>
  <span class="comment1">― ‹def›</span>
  O.i_def
  O.datatype_def
  O.type_synonym_def
  O.type_notation_def
  O.instantiation_def
  O.overloading_def
  O.consts_def
  O.definition_def
  O.lemmas_def
  O.lemma_def
  O.axiomatization_def
  O.section_def
  O.text_def
  O.ML_def
  O.setup_def
  O.thm_def
  O.interpretation_def

<span class="keyword1"><span class="command">locale</span></span> O'
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">datatype</span> <span class="main">=</span> Theory_datatype"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">type_synonym</span> <span class="main">=</span> Theory_type_synonym"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">type_notation</span> <span class="main">=</span> Theory_type_notation"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">instantiation</span> <span class="main">=</span> Theory_instantiation"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">overloading</span> <span class="main">=</span> Theory_overloading"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">consts</span> <span class="main">=</span> Theory_consts"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">definition</span> <span class="main">=</span> Theory_definition"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">lemmas</span> <span class="main">=</span> Theory_lemmas"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">lemma</span> <span class="main">=</span> Theory_lemma"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">axiomatization</span> <span class="main">=</span> Theory_axiomatization"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">section</span> <span class="main">=</span> Theory_section"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">text</span> <span class="main">=</span> Theory_text"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">ML</span> <span class="main">=</span> Theory_ML"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">setup</span> <span class="main">=</span> Theory_setup"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">thm</span> <span class="main">=</span> Theory_thm"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">interpretation</span> <span class="main">=</span> Theory_interpretation"</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">code</span><span class="main">]</span> <span class="main">=</span>
  <span class="comment1">― ‹def›</span>
  O'.datatype_def
  O'.type_synonym_def
  O'.type_notation_def
  O'.instantiation_def
  O'.overloading_def
  O'.consts_def
  O'.definition_def
  O'.lemmas_def
  O'.lemma_def
  O'.axiomatization_def
  O'.section_def
  O'.text_def
  O'.ML_def
  O'.setup_def
  O'.thm_def
  O'.interpretation_def

<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹Operations of Fold, Map, ..., on the Meta-Model›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">map_semi__theory</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> META_semi__theories <span class="main">(</span>Theories_one <span class="bound">x</span><span class="main">)</span> <span class="main">⇒</span> META_semi__theories <span class="main">(</span>Theories_one <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>
                                  <span class="main">|</span> META_semi__theories <span class="main">(</span>Theories_locale <span class="bound">data</span> <span class="bound">l</span><span class="main">)</span> <span class="main">⇒</span> META_semi__theories <span class="main">(</span>Theories_locale <span class="bound">data</span> <span class="main">(</span>L.map <span class="main">(</span>L.map <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span>
                                  <span class="main">|</span> <span class="bound">x</span> <span class="main">⇒</span> <span class="bound">x</span><span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Core_init">
<div class="head">
<h1>Theory Core_init</h1>
</div>
<pre class="source"><span class="comment1">(******************************************************************************
 * Citadelle
 *
 * Copyright (c) 2011-2018 Université Paris-Saclay, Univ. Paris-Sud, France
 *               2013-2017 IRT SystemX, France
 *               2011-2015 Achim D. Brucker, Germany
 *               2016-2018 The University of Sheffield, UK
 *               2016-2017 Nanyang Technological University, Singapore
 *               2017-2018 Virginia Tech, USA
 *
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are
 * met:
 *
 *     * Redistributions of source code must retain the above copyright
 *       notice, this list of conditions and the following disclaimer.
 *
 *     * Redistributions in binary form must reproduce the above
 *       copyright notice, this list of conditions and the following
 *       disclaimer in the documentation and/or other materials provided
 *       with the distribution.
 *
 *     * Neither the name of the copyright holders nor the names of its
 *       contributors may be used to endorse or promote products derived
 *       from this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 ******************************************************************************)</span>

<span class="keyword1"><span class="command">chapter</span></span><span class="quoted"><span class="plain_text">‹Translating Meta-Models›</span></span>
<span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹General Environment for the Translation: Introduction›</span></span>

<span class="keyword1"><span class="command">theory</span></span>  Core_init
<span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="Toy_Library_Static.html">../../Toy_Library_Static</a>"</span>
        <span class="quoted">"<a href="Meta_META.html">../meta_toy/Meta_META</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹This file regroups common utilities used by the embedding functions of Toy in Isabelle.›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> opt_attr_type <span class="main">=</span> OptInh <span class="main">|</span> OptOwn
<span class="keyword1"><span class="command">datatype</span></span> opt_ident <span class="main">=</span> OptIdent <span class="quoted"><span class="keyword1">nat</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> internal_oid <span class="main">::</span> <span class="quoted">linorder</span>
<span class="keyword2"><span class="keyword">begin</span></span>
 <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">n_of_internal_oid</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> Oid <span class="bound">n</span> <span class="main">⇒</span> <span class="bound">n</span><span class="main">)</span>"</span></span>
 <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">⟷</span> n_of_internal_oid <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">≤</span> n_of_internal_oid <span class="free"><span class="bound"><span class="entity">m</span></span></span>"</span></span>
 <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">⟷</span> n_of_internal_oid <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">&lt;</span> n_of_internal_oid <span class="free"><span class="bound"><span class="entity">m</span></span></span>"</span></span>
 <span class="keyword1"><span class="command">instance</span></span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">standard</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> less_eq_internal_oid_def less_imp_le less_internal_oid_def not_less<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> less_eq_internal_oid_def order_refl<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> less_eq_internal_oid_def order.trans<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> less_eq_internal_oid_def n_of_internal_oid_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="improper">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="improper">y</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> le_cases less_eq_internal_oid_def<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword2"><span class="keyword">end</span></span>



<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">var_oid_uniq</span> <span class="main">=</span> <span class="inner_cartouche">‹oid›</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">var_deref_assocs_list</span> <span class="main">=</span> <span class="inner_cartouche">‹deref_assocs_list›</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">var_inst_assoc</span> <span class="main">=</span> <span class="inner_cartouche">‹inst_assoc›</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">var_choose</span> <span class="main">=</span> <span class="inner_cartouche">‹choose›</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">var_switch</span> <span class="main">=</span> <span class="inner_cartouche">‹switch›</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">var_assocs</span> <span class="main">=</span> <span class="inner_cartouche">‹assocs›</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">var_map_of_list</span> <span class="main">=</span> <span class="inner_cartouche">‹map_of_list›</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">var_self</span> <span class="main">=</span> <span class="inner_cartouche">‹self›</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">var_result</span> <span class="main">=</span> <span class="inner_cartouche">‹result›</span>"</span></span>


<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">find_class_ass</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">=</span>
 <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">l_class</span><span class="main">,</span> <span class="bound">l_all_meta</span><span class="main">)</span> <span class="main">=</span>
    partition <span class="main">(</span><span class="keyword1">let</span> <span class="bound">f</span> <span class="main">=</span> <span class="main">λ</span><span class="bound">class</span><span class="main">.</span> ClassRaw_clause <span class="bound">class</span> <span class="main">=</span> <span class="main">[]</span> <span class="keyword1">in</span>
               <span class="main">λ</span> META_class_raw Floor1 <span class="bound">class</span> <span class="main">⇒</span> <span class="bound">f</span> <span class="bound">class</span>
               <span class="main">|</span> META_association <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> True
               <span class="main">|</span> META_ass_class Floor1 <span class="main">(</span>ToyAssClass <span class="main"><span class="bound">_</span></span> <span class="bound">class</span><span class="main">)</span> <span class="main">⇒</span> <span class="bound">f</span> <span class="bound">class</span>
               <span class="main">|</span> META_class_synonym <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> True
               <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> False<span class="main">)</span> <span class="main">(</span>rev <span class="main">(</span>D_input_meta <span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">)</span><span class="main">)</span> <span class="keyword1">in</span>
  <span class="main">(</span> L.flatten <span class="main">[</span><span class="bound">l_class</span><span class="main">,</span> List.map_filter <span class="main">(</span><span class="keyword1">let</span> <span class="bound">f</span> <span class="main">=</span> <span class="main">λ</span><span class="bound">class</span><span class="main">.</span> <span class="bound">class</span> <span class="main">⦇</span> ClassRaw_clause <span class="main">:=</span> <span class="main">[]</span> <span class="main">⦈</span> <span class="keyword1">in</span>
                                       <span class="main">λ</span> META_class_raw Floor1 <span class="bound">c</span> <span class="main">⇒</span> Some <span class="main">(</span>META_class_raw Floor1 <span class="main">(</span><span class="bound">f</span> <span class="bound">c</span><span class="main">)</span><span class="main">)</span>
                                       <span class="main">|</span> META_ass_class Floor1 <span class="main">(</span>ToyAssClass <span class="bound">ass</span> <span class="bound">class</span><span class="main">)</span> <span class="main">⇒</span> Some <span class="main">(</span>META_ass_class Floor1 <span class="main">(</span>ToyAssClass <span class="bound">ass</span> <span class="main">(</span><span class="bound">f</span> <span class="bound">class</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
                                       <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> None<span class="main">)</span> <span class="bound">l_all_meta</span><span class="main">]</span>
  <span class="main">,</span> L.flatten <span class="main">(</span>L.map
      <span class="main">(</span><span class="keyword1">let</span> <span class="bound">f</span> <span class="main">=</span> <span class="main">λ</span><span class="bound">class</span><span class="main">.</span> <span class="main">[</span> META_ctxt Floor1 <span class="main">(</span>toy_ctxt_ext <span class="main">[]</span> <span class="main">(</span>ClassRaw_name <span class="bound">class</span><span class="main">)</span> <span class="main">(</span>ClassRaw_clause <span class="bound">class</span><span class="main">)</span> <span class="main">()</span><span class="main">)</span> <span class="main">]</span> <span class="keyword1">in</span>
       <span class="main">λ</span> META_class_raw Floor1 <span class="bound">class</span> <span class="main">⇒</span> <span class="bound">f</span> <span class="bound">class</span>
       <span class="main">|</span> META_ass_class Floor1 <span class="main">(</span>ToyAssClass <span class="main"><span class="bound">_</span></span> <span class="bound">class</span><span class="main">)</span> <span class="main">⇒</span> <span class="bound">f</span> <span class="bound">class</span>
       <span class="main">|</span> <span class="bound">x</span> <span class="main">⇒</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span><span class="main">)</span> <span class="bound">l_all_meta</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">map_enum_syn</span> <span class="free"><span class="bound"><span class="entity">l_enum</span></span></span> <span class="free"><span class="bound"><span class="entity">l_syn</span></span></span> <span class="main">=</span>
 <span class="main">(</span><span class="main">λ</span> ToyTy_object <span class="main">(</span>ToyTyObj <span class="main">(</span>ToyTyCore_pre <span class="bound">s</span><span class="main">)</span> <span class="main">[]</span><span class="main">)</span> <span class="main">⇒</span> 
      <span class="keyword1">if</span> list_ex <span class="main">(</span><span class="main">λ</span><span class="bound">syn</span><span class="main">.</span> <span class="bound">s</span> <span class="main">≜</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">syn</span> <span class="keyword1">of</span> ToyClassSynonym <span class="bound">n</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">l_syn</span></span></span> <span class="keyword1">then</span>
        ToyTy_class_syn <span class="bound">s</span>
      <span class="keyword1">else</span> <span class="keyword1">if</span> list_ex <span class="main">(</span><span class="main">λ</span><span class="bound">enum</span><span class="main">.</span> <span class="bound">s</span> <span class="main">≜</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">enum</span> <span class="keyword1">of</span> ToyEnum <span class="bound">n</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">l_enum</span></span></span> <span class="keyword1">then</span>
        ToyTy_enum <span class="bound">s</span>
      <span class="keyword1">else</span>
        ToyTy_object <span class="main">(</span>ToyTyObj <span class="main">(</span>ToyTyCore_pre <span class="bound">s</span><span class="main">)</span> <span class="main">[]</span><span class="main">)</span>
  <span class="main">|</span> <span class="bound">x</span> <span class="main">⇒</span> <span class="bound">x</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">arrange_ass</span> <span class="free"><span class="bound"><span class="entity">with_aggreg</span></span></span> <span class="free"><span class="bound"><span class="entity">with_optim_ass</span></span></span> <span class="free"><span class="bound"><span class="entity">l_c</span></span></span> <span class="free"><span class="bound"><span class="entity">l_enum</span></span></span> <span class="main">=</span>
   <span class="main">(</span><span class="keyword1">let</span> <span class="bound">l_syn</span> <span class="main">=</span> List.map_filter <span class="main">(</span><span class="main">λ</span> META_class_synonym <span class="bound">e</span> <span class="main">⇒</span> Some <span class="bound">e</span>
                                 <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> None<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">l_c</span></span></span>
      <span class="main">;</span> <span class="bound">l_class</span> <span class="main">=</span> List.map_filter <span class="main">(</span><span class="main">λ</span> META_class_raw Floor1 <span class="bound">cflat</span> <span class="main">⇒</span> Some <span class="bound">cflat</span>
                                   <span class="main">|</span> META_ass_class Floor1 <span class="main">(</span>ToyAssClass <span class="main"><span class="bound">_</span></span> <span class="bound">cflat</span><span class="main">)</span> <span class="main">⇒</span> Some <span class="bound">cflat</span>
                                   <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> None<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">l_c</span></span></span>
      <span class="main">;</span> <span class="bound">l_class</span> <span class="main">=</span> <span class="comment1">― ‹map classes: change the (enumeration) type of every attributes to <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>raw›</span></span>›</span>
                  <span class="comment1">― ‹instead of the default <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>object›</span></span> type›</span>
        L.map
          <span class="main">(</span><span class="main">λ</span> <span class="bound">cflat</span> <span class="main">⇒</span>
            <span class="bound">cflat</span> <span class="main">⦇</span> ClassRaw_own <span class="main">:=</span>
                      L.map <span class="main">(</span>map_prod id <span class="main">(</span>map_enum_syn <span class="free"><span class="bound"><span class="entity">l_enum</span></span></span> <span class="bound">l_syn</span><span class="main">)</span><span class="main">)</span>
                               <span class="main">(</span>ClassRaw_own <span class="bound">cflat</span><span class="main">)</span> <span class="main">⦈</span><span class="main">)</span> <span class="bound">l_class</span>
    <span class="main">;</span> <span class="bound">l_ass</span> <span class="main">=</span> List.map_filter <span class="main">(</span><span class="main">λ</span> META_association <span class="bound">ass</span> <span class="main">⇒</span> Some <span class="bound">ass</span>
                                 <span class="main">|</span> META_ass_class Floor1 <span class="main">(</span>ToyAssClass <span class="bound">ass</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">⇒</span> Some <span class="bound">ass</span>
                                 <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> None<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">l_c</span></span></span>
      <span class="main">;</span> <span class="bound">ToyMult</span> <span class="main">=</span> <span class="main">λ</span><span class="bound">l</span> <span class="bound">set</span><span class="main">.</span> toy_multiplicity_ext <span class="bound">l</span> None <span class="bound">set</span> <span class="main">()</span>
      <span class="main">;</span> <span class="main">(</span><span class="bound">l_class</span><span class="main">,</span> <span class="bound">l_ass0</span><span class="main">)</span> <span class="main">=</span> 
          <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">with_optim_ass</span></span></span> <span class="keyword1">then</span>
            <span class="comment1">― ‹move from classes to associations:›</span>
            <span class="comment1">― ‹attributes of object types›</span>
            <span class="comment1">― ‹+ those constructed with at most 1 recursive call to <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>ToyTy_collection›</span></span>›</span>
            map_prod rev rev <span class="main">(</span>List.fold
                  <span class="main">(</span><span class="main">λ</span><span class="bound">c</span> <span class="main">(</span><span class="bound">l_class</span><span class="main">,</span> <span class="bound">l_ass</span><span class="main">)</span><span class="main">.</span>
                    <span class="keyword1">let</span> <span class="bound">default</span> <span class="main">=</span> <span class="main">[</span>Set<span class="main">]</span>
                      <span class="main">;</span> <span class="bound">f</span> <span class="main">=</span> <span class="main">λ</span><span class="bound">role</span> <span class="bound">t</span> <span class="bound">mult_out</span><span class="main">.</span> <span class="main">⦇</span> ToyAss_type <span class="main">=</span> ToyAssTy_native_attribute
                                              <span class="main">,</span> ToyAss_relation <span class="main">=</span> ToyAssRel <span class="main">[</span><span class="main">(</span>ClassRaw_name <span class="bound">c</span><span class="main">,</span> <span class="bound">ToyMult</span> <span class="main">[</span><span class="main">(</span>Mult_star<span class="main">,</span> None<span class="main">)</span><span class="main">]</span> <span class="bound">default</span><span class="main">)</span>
                                                                            <span class="main">,</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">mult_out</span> <span class="main">⦇</span> TyRole <span class="main">:=</span> Some <span class="bound">role</span> <span class="main">⦈</span><span class="main">)</span><span class="main">]</span> <span class="main">⦈</span>
                      <span class="main">;</span> <span class="main">(</span><span class="bound">l_own</span><span class="main">,</span> <span class="bound">l_ass</span><span class="main">)</span> <span class="main">=</span>
                        List.fold <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">role</span><span class="main">,</span> ToyTy_object <span class="bound">t</span><span class="main">)</span> <span class="main">⇒</span>
                                          <span class="main">λ</span> <span class="main">(</span><span class="bound">l_own</span><span class="main">,</span> <span class="bound">l</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">l_own</span><span class="main">,</span> <span class="bound">f</span> <span class="bound">role</span> <span class="bound">t</span> <span class="main">(</span><span class="bound">ToyMult</span> <span class="main">[</span><span class="main">(</span>Mult_nat <span class="main">0</span><span class="main">,</span> Some <span class="main">(</span>Mult_nat <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">]</span> <span class="bound">default</span><span class="main">)</span> <span class="main">#</span> <span class="bound">l</span><span class="main">)</span>
                                   <span class="main">|</span> <span class="main">(</span><span class="bound">role</span><span class="main">,</span> ToyTy_collection <span class="bound">mult</span> <span class="main">(</span>ToyTy_object <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">⇒</span>
                                          <span class="main">λ</span> <span class="main">(</span><span class="bound">l_own</span><span class="main">,</span> <span class="bound">l</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">l_own</span><span class="main">,</span> <span class="bound">f</span> <span class="bound">role</span> <span class="bound">t</span> <span class="bound">mult</span> <span class="main">#</span> <span class="bound">l</span><span class="main">)</span>
                                   <span class="main">|</span> <span class="bound">x</span> <span class="main">⇒</span> <span class="main">λ</span> <span class="main">(</span><span class="bound">l_own</span><span class="main">,</span> <span class="bound">l</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span> <span class="main">#</span> <span class="bound">l_own</span><span class="main">,</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span>
                                  <span class="main">(</span>ClassRaw_own <span class="bound">c</span><span class="main">)</span>
                                  <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="bound">l_ass</span><span class="main">)</span> <span class="keyword1">in</span>
                    <span class="main">(</span><span class="bound">c</span> <span class="main">⦇</span> ClassRaw_own <span class="main">:=</span> rev <span class="bound">l_own</span> <span class="main">⦈</span> <span class="main">#</span> <span class="bound">l_class</span><span class="main">,</span> <span class="bound">l_ass</span><span class="main">)</span><span class="main">)</span>
                  <span class="bound">l_class</span>
                  <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span>
          <span class="keyword1">else</span>
            <span class="main">(</span><span class="bound">l_class</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span>
      <span class="main">;</span> <span class="main">(</span><span class="bound">l_class</span><span class="main">,</span> <span class="bound">l_ass</span><span class="main">)</span> <span class="main">=</span>
          <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">with_aggreg</span></span></span> <span class="keyword1">then</span>
            <span class="comment1">― ‹move from associations to classes:›</span>
            <span class="comment1">― ‹attributes of aggregation form›</span>
            map_prod rev rev <span class="main">(</span>List.fold
            <span class="main">(</span><span class="main">λ</span><span class="bound">ass</span> <span class="main">(</span><span class="bound">l_class</span><span class="main">,</span> <span class="bound">l_ass</span><span class="main">)</span><span class="main">.</span>
              <span class="keyword1">if</span> ToyAss_type <span class="bound">ass</span> <span class="main">=</span> ToyAssTy_aggregation <span class="keyword1">then</span>
                <span class="main">(</span> fold_max
                    <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">cpt_to</span><span class="main">,</span> <span class="main">(</span><span class="bound">name_to</span><span class="main">,</span> <span class="bound">category_to</span><span class="main">)</span><span class="main">)</span><span class="main">.</span>
                      <span class="keyword1">case</span> TyRole <span class="bound">category_to</span> <span class="keyword1">of</span>
                        Some <span class="bound">role_to</span> <span class="main">⇒</span>
                        List.fold <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">cpt_from</span><span class="main">,</span> <span class="main">(</span><span class="bound">name_from</span><span class="main">,</span> <span class="bound">multip_from</span><span class="main">)</span><span class="main">)</span><span class="main">.</span>
                          L.map_find <span class="main">(</span><span class="main">λ</span><span class="bound">cflat</span><span class="main">.</span>
                            <span class="keyword1">if</span> cl_name_to_string <span class="bound">cflat</span> <span class="main">≜</span> ty_obj_to_string <span class="bound">name_from</span> <span class="keyword1">then</span>
                              Some <span class="main">(</span><span class="bound">cflat</span> <span class="main">⦇</span> ClassRaw_own <span class="main">:=</span>
                                              L.flatten <span class="main">[</span> ClassRaw_own <span class="bound">cflat</span>
                                                           <span class="main">,</span> <span class="main">[</span><span class="main">(</span><span class="bound">role_to</span><span class="main">,</span> <span class="keyword1">let</span> <span class="bound">ty</span> <span class="main">=</span> ToyTy_object <span class="bound">name_to</span> <span class="keyword1">in</span>
                                                                        <span class="keyword1">if</span> single_multip <span class="bound">category_to</span> <span class="keyword1">then</span> 
                                                                          <span class="bound">ty</span>
                                                                        <span class="keyword1">else</span>
                                                                          ToyTy_collection <span class="bound">category_to</span> <span class="bound">ty</span><span class="main">)</span><span class="main">]</span><span class="main">]</span> <span class="main">⦈</span><span class="main">)</span>
                            <span class="keyword1">else</span> None<span class="main">)</span><span class="main">)</span>
                     <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> id<span class="main">)</span>
                    <span class="main">(</span>ToyAss_relation' <span class="bound">ass</span><span class="main">)</span>
                    <span class="bound">l_class</span>
                <span class="main">,</span> <span class="bound">l_ass</span><span class="main">)</span>
              <span class="keyword1">else</span>
                <span class="main">(</span><span class="bound">l_class</span><span class="main">,</span> <span class="bound">ass</span> <span class="main">#</span> <span class="bound">l_ass</span><span class="main">)</span><span class="main">)</span> <span class="bound">l_ass</span> <span class="main">(</span><span class="bound">l_class</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span>
          <span class="keyword1">else</span>
            <span class="main">(</span><span class="bound">l_class</span><span class="main">,</span> <span class="bound">l_ass</span><span class="main">)</span> <span class="keyword1">in</span>
    <span class="main">(</span> <span class="bound">l_class</span>
    <span class="main">,</span> L.flatten <span class="main">[</span><span class="bound">l_ass</span><span class="main">,</span> <span class="bound">l_ass0</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">datatype_name</span> <span class="main">=</span> <span class="inner_cartouche">‹ty›</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">datatype_ext_name</span> <span class="main">=</span> datatype_name <span class="main">@@</span> <span class="inner_cartouche">‹ℰ𝒳𝒯›</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">datatype_constr_name</span> <span class="main">=</span> <span class="inner_cartouche">‹mk›</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">datatype_ext_constr_name</span> <span class="main">=</span> datatype_constr_name <span class="main">@@</span> <span class="inner_cartouche">‹ℰ𝒳𝒯›</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">datatype_in</span> <span class="main">=</span> <span class="inner_cartouche">‹in›</span>"</span></span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Main Combinators for the Translation›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹
As general remark, all the future translating steps 
(e.g., that will occur in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">file</span></span> ‹Floor1_access.thy›<span class="antiquote"><span class="antiquote">}</span></span></span></span>)
will extensively use Isabelle expressions,
represented by its Meta-Model, for example lots of functions will use <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Term_app"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>...
So the overall can be simplified by the use of polymorphic cartouches.
It looks feasible to add a new front-end for cartouches in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">theory</span></span> <a href="Init.html"></a><a href="Init.html">Isabelle_Meta_Model.Init</a><span class="antiquote"><span class="antiquote">}</span></span></span></span>
supporting the use of Isabelle syntax in cartouches,
then we could obtain at the end a parsed Isabelle Meta-Model in Isabelle.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">start_map</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> L.mapM <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">acc</span><span class="main">.</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">x</span><span class="main">,</span> <span class="bound">acc</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">start_map'''</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">fl</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">env</span><span class="main">.</span>
  <span class="keyword1">let</span> <span class="bound">design_analysis</span> <span class="main">=</span> D_toy_semantics <span class="bound">env</span>
    <span class="main">;</span> <span class="bound">base_attr</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">design_analysis</span> <span class="main">=</span> Gen_only_design <span class="keyword1">then</span> id <span class="keyword1">else</span> L.filter <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> ToyTy_object <span class="main">(</span>ToyTyObj <span class="main">(</span>ToyTyCore <span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">)</span> <span class="main">⇒</span> False <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> True<span class="main">)</span><span class="main">)</span>
    <span class="main">;</span> <span class="bound">base_attr'</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">l_attr</span><span class="main">,</span> <span class="bound">l_inh</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">base_attr</span> <span class="bound">l_attr</span><span class="main">,</span> L.map <span class="bound">base_attr</span> <span class="bound">l_inh</span><span class="main">)</span><span class="main">)</span>
    <span class="main">;</span> <span class="bound">base_attr''</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">l_attr</span><span class="main">,</span> <span class="bound">l_inh</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">base_attr</span> <span class="bound">l_attr</span><span class="main">,</span> <span class="bound">base_attr</span> <span class="bound">l_inh</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">in</span>
  start_map <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">fl</span></span></span> <span class="bound">design_analysis</span> <span class="bound">base_attr</span> <span class="bound">base_attr'</span> <span class="bound">base_attr''</span><span class="main">)</span> <span class="bound">env</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">start_map''</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">fl</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> start_map''' <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">fl</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">start_map''''</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">fl</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">env</span><span class="main">.</span> start_map <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">fl</span></span></span> <span class="main">(</span>D_toy_semantics <span class="bound">env</span><span class="main">)</span><span class="main">)</span> <span class="bound">env</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">bootstrap_floor</span> <span class="free"><span class="bound"><span class="entity">f_x</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">=</span>
 <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">env</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">f_x</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">env</span></span></span>
    <span class="main">;</span> <span class="bound">l_setup</span> <span class="main">=</span> META_boot_setup_env <span class="main">(</span>Boot_setup_env <span class="main">(</span><span class="bound">env</span> <span class="main">⦇</span> D_output_disable_thy <span class="main">:=</span> True
                                                        <span class="main">,</span> D_output_header_thy <span class="main">:=</span> None
                                                        <span class="main">,</span> D_output_position <span class="main">:=</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span> <span class="main">⦈</span><span class="main">)</span> <span class="main">)</span>
                <span class="main">#</span> <span class="bound">l</span>
    <span class="main">;</span> <span class="bound">l</span> <span class="main">=</span> <span class="keyword1">if</span> <span class="keyword1">case</span> D_input_meta <span class="bound">env</span> <span class="keyword1">of</span> <span class="main">[]</span> <span class="main">⇒</span> True <span class="main">|</span> <span class="bound">x</span> <span class="main">#</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> ignore_meta_header <span class="bound">x</span> <span class="keyword1">then</span>
            <span class="bound">l</span>
          <span class="keyword1">else</span>
            <span class="bound">l_setup</span> <span class="keyword1">in</span>
  <span class="main">(</span> <span class="keyword1">if</span> D_output_auto_bootstrap <span class="bound">env</span> <span class="keyword1">then</span>
      <span class="bound">l</span>
    <span class="keyword1">else</span>
      META_boot_generation_syntax <span class="main">(</span>Boot_generation_syntax <span class="main">(</span>D_toy_semantics <span class="bound">env</span><span class="main">)</span><span class="main">)</span>
      <span class="main">#</span> <span class="bound">l_setup</span>
  <span class="main">,</span> <span class="bound">env</span> <span class="main">⦇</span> D_output_auto_bootstrap <span class="main">:=</span> True <span class="main">⦈</span> <span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">wrap_toyty</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="inner_cartouche">‹⋅›</span> <span class="main">@@</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">Term_annot_toy</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> Term_annot' <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">(</span>wrap_toyty <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">Term_toyset</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="keyword1">of</span> <span class="main">[]</span> <span class="main">⇒</span> Term_basic <span class="main">[</span><span class="inner_cartouche">‹Set{}›</span><span class="main">]</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> Term_paren <span class="inner_cartouche">‹Set{›</span> <span class="inner_cartouche">‹}›</span> <span class="main">(</span>term_binop <span class="inner_cartouche">‹,›</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">Term_oid</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span>Oid <span class="bound">n</span> <span class="main">⇒</span> Term_basic <span class="main">[</span><span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">@@</span> String.natural_to_digit10 <span class="bound">n</span><span class="main">]</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Preliminaries on: Enumeration›</span></span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Preliminaries on: Infrastructure›</span></span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Preliminaries on: Accessor›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">print_access_oid_uniq_name'</span> <span class="free"><span class="bound"><span class="entity">name_from_nat</span></span></span> <span class="free"><span class="bound"><span class="entity">isub_name</span></span></span> <span class="free"><span class="bound"><span class="entity">attr</span></span></span> <span class="main">=</span> S.flatten <span class="main">[</span> <span class="free"><span class="bound"><span class="entity">isub_name</span></span></span> var_oid_uniq<span class="main">,</span> <span class="inner_cartouche">‹_›</span><span class="main">,</span> String.natural_to_digit10 <span class="free"><span class="bound"><span class="entity">name_from_nat</span></span></span><span class="main">,</span> <span class="inner_cartouche">‹_›</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">attr</span></span></span> <span class="main">]</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">print_access_oid_uniq_name</span> <span class="free"><span class="bound"><span class="entity">name_from_nat</span></span></span> <span class="free"><span class="bound"><span class="entity">isub_name</span></span></span> <span class="free"><span class="bound"><span class="entity">attr</span></span></span> <span class="main">=</span> print_access_oid_uniq_name' <span class="free"><span class="bound"><span class="entity">name_from_nat</span></span></span> <span class="free"><span class="bound"><span class="entity">isub_name</span></span></span> <span class="main">(</span>String.isup <span class="free"><span class="bound"><span class="entity">attr</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">print_access_choose_name</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">=</span>
  S.flatten <span class="main">[</span>var_switch<span class="main">,</span> String.isub <span class="main">(</span>String.natural_to_digit10 <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">,</span> <span class="inner_cartouche">‹_›</span><span class="main">,</span> String.natural_to_digit10 <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">,</span> String.natural_to_digit10 <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Preliminaries on: Example (Floor 1)›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> reporting <span class="main">=</span> Warning
                   <span class="main">|</span> Error
                   <span class="main">|</span> Writeln

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Preliminaries on: Example (Floor 2)›</span></span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Preliminaries on: Context›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">make_ctxt_free_var</span> <span class="free"><span class="bound"><span class="entity">pref</span></span></span> <span class="free"><span class="bound"><span class="entity">ctxt</span></span></span> <span class="main">=</span>
 <span class="main">(</span>var_self <span class="main">#</span> L.flatten <span class="main">[</span> L.map fst <span class="main">(</span>Ctxt_fun_ty_arg <span class="free"><span class="bound"><span class="entity">ctxt</span></span></span><span class="main">)</span>
                          <span class="main">,</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">pref</span></span></span> <span class="main">=</span> ToyCtxtPre <span class="keyword1">then</span> <span class="main">[]</span> <span class="keyword1">else</span> <span class="main">[</span>var_result<span class="main">]</span> <span class="main">]</span><span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Floor1_infra">
<div class="head">
<h1>Theory Floor1_infra</h1>
</div>
<pre class="source"><span class="comment1">(******************************************************************************
 * HOL-TOY
 *
 * Copyright (c) 2011-2018 Université Paris-Saclay, Univ. Paris-Sud, France
 *               2013-2017 IRT SystemX, France
 *               2011-2015 Achim D. Brucker, Germany
 *               2016-2018 The University of Sheffield, UK
 *               2016-2017 Nanyang Technological University, Singapore
 *               2017-2018 Virginia Tech, USA
 *
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are
 * met:
 *
 *     * Redistributions of source code must retain the above copyright
 *       notice, this list of conditions and the following disclaimer.
 *
 *     * Redistributions in binary form must reproduce the above
 *       copyright notice, this list of conditions and the following
 *       disclaimer in the documentation and/or other materials provided
 *       with the distribution.
 *
 *     * Neither the name of the copyright holders nor the names of its
 *       contributors may be used to endorse or promote products derived
 *       from this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 ******************************************************************************)</span>

<span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹Main Translation for: Infrastructure›</span></span>

<span class="keyword1"><span class="command">theory</span></span>  Floor1_infra
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Core_init.html">Core_init</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">print_infra_datatype_class</span> <span class="main">=</span> start_map'' O.datatype <span class="keyword1">o</span> <span class="main">(</span><span class="main">λ</span><span class="bound">expr</span> <span class="main"><span class="bound">_</span></span> <span class="bound">base_attr'</span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> map_class_gen_h''''
  <span class="main">(</span><span class="main">λ</span><span class="bound">isub_name</span> <span class="bound">name</span> <span class="main"><span class="bound">_</span></span> <span class="bound">l_attr</span> <span class="bound">l_inherited</span> <span class="bound">l_cons</span><span class="main">.</span>
    <span class="keyword1">let</span> <span class="main">(</span><span class="bound">l_attr</span><span class="main">,</span> <span class="bound">l_inherited</span><span class="main">)</span> <span class="main">=</span> <span class="bound">base_attr'</span> <span class="main">(</span><span class="bound">l_attr</span><span class="main">,</span> of_inh <span class="bound">l_inherited</span><span class="main">)</span>
      <span class="main">;</span> <span class="bound">map_ty</span> <span class="main">=</span> L.map <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> Typ_apply <span class="main">(</span>Typ_base <span class="inner_cartouche">‹option›</span><span class="main">)</span> <span class="main">[</span>str_hol_of_ty_all Typ_apply Typ_base <span class="bound">x</span><span class="main">]</span><span class="main">)</span> <span class="keyword1">o</span> snd<span class="main">)</span> <span class="keyword1">in</span>
    <span class="main">[</span> Datatype
        <span class="main">(</span><span class="bound">isub_name</span> datatype_ext_name<span class="main">)</span>
        <span class="main">(</span>  <span class="main">(</span>L.rev_map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span> datatype_ext_constr_name <span class="main">@@</span> mk_constr_name <span class="bound">name</span> <span class="bound">x</span>
                         <span class="main">,</span> <span class="main">[</span>Raw <span class="main">(</span>datatype_name <span class="main">@@</span> String.isub <span class="bound">x</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>of_sub <span class="bound">l_cons</span><span class="main">)</span><span class="main">)</span>
        <span class="main">@@@@</span> <span class="main">[</span><span class="main">(</span><span class="bound">isub_name</span> datatype_ext_constr_name<span class="main">,</span> Raw const_oid <span class="main">#</span> L.maps <span class="bound">map_ty</span> <span class="bound">l_inherited</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>
    <span class="main">,</span> Datatype
        <span class="main">(</span><span class="bound">isub_name</span> datatype_name<span class="main">)</span>
        <span class="main">[</span> <span class="main">(</span><span class="bound">isub_name</span> datatype_constr_name<span class="main">,</span> Raw <span class="main">(</span><span class="bound">isub_name</span> datatype_ext_name<span class="main">)</span> <span class="main">#</span> <span class="bound">map_ty</span> <span class="bound">l_attr</span> <span class="main">)</span> <span class="main">]</span> <span class="main">]</span><span class="main">)</span> <span class="bound">expr</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">print_infra_datatype_universe</span> <span class="free"><span class="bound"><span class="entity">expr</span></span></span> <span class="main">=</span> start_map O.datatype
  <span class="main">[</span> Datatype <span class="inner_cartouche">‹𝔄›</span>
      <span class="main">(</span>map_class <span class="main">(</span><span class="main">λ</span><span class="bound">isub_name</span> <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">(</span><span class="bound">isub_name</span> datatype_in<span class="main">,</span> <span class="main">[</span>Raw <span class="main">(</span><span class="bound">isub_name</span> datatype_name<span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">expr</span></span></span><span class="main">)</span> <span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">print_infra_type_synonym_class_higher</span> <span class="free"><span class="bound"><span class="entity">expr</span></span></span> <span class="main">=</span> start_map O.type_synonym
 <span class="main">(</span><span class="keyword1">let</span> <span class="bound">option</span> <span class="main">=</span> Typ_apply_paren <span class="inner_cartouche">‹⟨›</span> <span class="inner_cartouche">‹⟩<span class="hidden">⇩</span><sub>⊥</sub>›</span> <span class="keyword1">in</span>
  L.flatten
    <span class="main">(</span>map_class
      <span class="main">(</span><span class="main">λ</span><span class="bound">isub_name</span> <span class="bound">name</span> <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">.</span>
        <span class="main">[</span> Type_synonym' <span class="bound">name</span>
                       <span class="main">(</span><span class="bound">option</span> <span class="main">(</span><span class="bound">option</span> <span class="main">(</span>Typ_base <span class="main">(</span><span class="bound">isub_name</span> datatype_name<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
        <span class="comment1">⌦‹, Type_synonym' name (Typ_apply_paren ‹⋅› ‹› (Typ_base (name @@ ‹'›)))›</span><span class="main">]</span><span class="main">)</span>
      <span class="free"><span class="bound"><span class="entity">expr</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Floor1_access">
<div class="head">
<h1>Theory Floor1_access</h1>
</div>
<pre class="source"><span class="comment1">(******************************************************************************
 * HOL-TOY
 *
 * Copyright (c) 2011-2018 Université Paris-Saclay, Univ. Paris-Sud, France
 *               2013-2017 IRT SystemX, France
 *               2011-2015 Achim D. Brucker, Germany
 *               2016-2018 The University of Sheffield, UK
 *               2016-2017 Nanyang Technological University, Singapore
 *               2017-2018 Virginia Tech, USA
 *
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are
 * met:
 *
 *     * Redistributions of source code must retain the above copyright
 *       notice, this list of conditions and the following disclaimer.
 *
 *     * Redistributions in binary form must reproduce the above
 *       copyright notice, this list of conditions and the following
 *       disclaimer in the documentation and/or other materials provided
 *       with the distribution.
 *
 *     * Neither the name of the copyright holders nor the names of its
 *       contributors may be used to endorse or promote products derived
 *       from this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 ******************************************************************************)</span>

<span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹Main Translation for: Accessor›</span></span>

<span class="keyword1"><span class="command">theory</span></span>  Floor1_access
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Core_init.html">Core_init</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">print_access_oid_uniq_gen</span> <span class="free"><span class="bound"><span class="entity">Thy_def</span></span></span> <span class="free"><span class="bound"><span class="entity">D_toy_oid_start_upd</span></span></span> <span class="free"><span class="bound"><span class="entity">def_rewrite</span></span></span> <span class="main">=</span>
  <span class="main">(</span><span class="main">λ</span><span class="bound">expr</span> <span class="bound">env</span><span class="main">.</span>
      <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">oid_start</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>L.map <span class="free"><span class="bound"><span class="entity">Thy_def</span></span></span> <span class="bound">l</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">D_toy_oid_start_upd</span></span></span> <span class="bound">env</span> <span class="bound">oid_start</span><span class="main">)</span><span class="main">)</span>
      <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="main">(</span><span class="bound">acc</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> fold_class <span class="main">(</span><span class="main">λ</span><span class="bound">isub_name</span> <span class="bound">name</span> <span class="bound">l_attr</span> <span class="bound">l_inh</span> <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span> <span class="bound">cpt</span><span class="main">.</span>
         <span class="keyword1">let</span> <span class="bound">l_inh</span> <span class="main">=</span> L.map <span class="main">(</span><span class="main">λ</span> ToyClass <span class="main"><span class="bound">_</span></span> <span class="bound">l</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="bound">l</span><span class="main">)</span> <span class="main">(</span>of_inh <span class="bound">l_inh</span><span class="main">)</span> <span class="keyword1">in</span>
         <span class="keyword1">let</span> <span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">cpt</span><span class="main">)</span> <span class="main">=</span> L.mapM <span class="main">(</span>L.mapM
           <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">attr</span><span class="main">,</span> ToyTy_object <span class="main">(</span>ToyTyObj <span class="main">(</span>ToyTyCore <span class="bound">ty_obj</span><span class="main">)</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">)</span> <span class="main">⇒</span>
                                            <span class="main">(</span><span class="keyword1">let</span> <span class="bound">obj_oid</span> <span class="main">=</span> TyObj_ass_id <span class="bound">ty_obj</span>
                                               <span class="main">;</span> <span class="bound">obj_name_from_nat</span> <span class="main">=</span> TyObjN_ass_switch <span class="main">(</span>TyObj_from <span class="bound">ty_obj</span><span class="main">)</span> <span class="keyword1">in</span> <span class="main">λ</span><span class="main">(</span><span class="bound">cpt</span><span class="main">,</span> <span class="bound">rbt</span><span class="main">)</span> <span class="main">⇒</span>
             <span class="keyword1">let</span> <span class="main">(</span><span class="bound">cpt_obj</span><span class="main">,</span> <span class="bound">cpt_rbt</span><span class="main">)</span> <span class="main">=</span>
               <span class="keyword1">case</span> RBT.lookup <span class="bound">rbt</span> <span class="bound">obj_oid</span> <span class="keyword1">of</span>
                 None <span class="main">⇒</span> <span class="main">(</span><span class="bound">cpt</span><span class="main">,</span> oidSucAssoc <span class="bound">cpt</span><span class="main">,</span> RBT.insert <span class="bound">obj_oid</span> <span class="bound">cpt</span> <span class="bound">rbt</span><span class="main">)</span>
               <span class="main">|</span> Some <span class="bound">cpt_obj</span> <span class="main">⇒</span> <span class="main">(</span><span class="bound">cpt_obj</span><span class="main">,</span> <span class="bound">cpt</span><span class="main">,</span> <span class="bound">rbt</span><span class="main">)</span> <span class="keyword1">in</span>
             <span class="main">(</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">def_rewrite</span></span></span> <span class="bound">obj_name_from_nat</span> <span class="bound">name</span> <span class="bound">isub_name</span> <span class="bound">attr</span> <span class="main">(</span>oidGetAssoc <span class="bound">cpt_obj</span><span class="main">)</span><span class="main">]</span>
             <span class="main">,</span> <span class="bound">cpt_rbt</span><span class="main">)</span><span class="main">)</span>
            <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="main">λ</span><span class="bound">cpt</span><span class="main">.</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="bound">cpt</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
           <span class="main">(</span><span class="bound">l_attr</span> <span class="main">#</span> <span class="bound">l_inh</span><span class="main">)</span> <span class="bound">cpt</span> <span class="keyword1">in</span>
         <span class="main">(</span>L.flatten <span class="main">(</span>L.flatten <span class="bound">l</span><span class="main">)</span><span class="main">,</span> <span class="bound">cpt</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>D_toy_oid_start <span class="bound">env</span><span class="main">,</span> RBT.empty<span class="main">)</span> <span class="bound">expr</span> <span class="keyword1">in</span>
       <span class="main">(</span>L.flatten <span class="bound">l</span><span class="main">,</span> <span class="bound">acc</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">print_access_oid_uniq</span> <span class="main">=</span>
  print_access_oid_uniq_gen
    O.definition
    <span class="main">(</span><span class="main">λ</span><span class="bound">env</span> <span class="bound">oid_start</span><span class="main">.</span> <span class="bound">env</span> <span class="main">⦇</span> D_toy_oid_start <span class="main">:=</span> <span class="bound">oid_start</span> <span class="main">⦈</span><span class="main">)</span>
    <span class="main">(</span><span class="main">λ</span><span class="bound">obj_name_from_nat</span> <span class="main"><span class="bound">_</span></span> <span class="bound">isub_name</span> <span class="bound">attr</span> <span class="bound">cpt_obj</span><span class="main">.</span>
      Definition <span class="main">(</span>Term_rewrite
                   <span class="main">(</span>Term_basic <span class="main">[</span>print_access_oid_uniq_name <span class="bound">obj_name_from_nat</span> <span class="bound">isub_name</span> <span class="bound">attr</span><span class="main">]</span><span class="main">)</span>
                   <span class="inner_cartouche">‹=›</span>
                   <span class="main">(</span>Term_oid <span class="inner_cartouche">‹›</span> <span class="bound">cpt_obj</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">print_access_choose_switch</span>
              <span class="free"><span class="bound"><span class="entity">lets</span></span></span> <span class="free"><span class="bound"><span class="entity">mk_var</span></span></span> <span class="free"><span class="bound"><span class="entity">expr</span></span></span>
              <span class="free"><span class="bound"><span class="entity">print_access_choose_n</span></span></span>
              <span class="free"><span class="bound"><span class="entity">sexpr_list</span></span></span> <span class="free"><span class="bound"><span class="entity">sexpr_function</span></span></span> <span class="free"><span class="bound"><span class="entity">sexpr_pair</span></span></span> <span class="main">=</span>
  L.flatten
       <span class="main">(</span>L.map
          <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span>
           <span class="keyword1">let</span> <span class="bound">l</span> <span class="main">=</span> L.upto <span class="main">0</span> <span class="main">(</span><span class="bound">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">in</span>
           L.map <span class="main">(</span><span class="keyword1">let</span> <span class="bound">l</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">sexpr_list</span></span></span> <span class="main">(</span>L.map <span class="free"><span class="bound"><span class="entity">mk_var</span></span></span> <span class="bound">l</span><span class="main">)</span> <span class="keyword1">in</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="bound">j</span><span class="main">)</span><span class="main">.</span>
             <span class="main">(</span><span class="free"><span class="bound"><span class="entity">lets</span></span></span>
                <span class="main">(</span><span class="free"><span class="bound"><span class="entity">print_access_choose_n</span></span></span> <span class="bound">n</span> <span class="bound">i</span> <span class="bound">j</span><span class="main">)</span>
                <span class="main">(</span><span class="free"><span class="bound"><span class="entity">sexpr_function</span></span></span> <span class="main">[</span><span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">sexpr_pair</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">mk_var</span></span></span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">mk_var</span></span></span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
             <span class="main">(</span><span class="main">(</span>L.flatten <span class="keyword1">o</span> L.flatten<span class="main">)</span> <span class="main">(</span>L.map <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> L.map <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">i</span> <span class="main">=</span> <span class="bound">j</span> <span class="keyword1">then</span> <span class="main">[]</span> <span class="keyword1">else</span> <span class="main">[</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">j</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="bound">l</span><span class="main">)</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
          <span class="main">(</span>class_arity <span class="free"><span class="bound"><span class="entity">expr</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">print_access_choose</span> <span class="main">=</span> start_map'''' O.definition <span class="keyword1">o</span> <span class="main">(</span><span class="main">λ</span><span class="bound">expr</span> <span class="main"><span class="bound">_</span></span><span class="main">.</span>
  <span class="main">(</span><span class="keyword1">let</span> <span class="bound">a</span> <span class="main">=</span> <span class="main">λ</span><span class="bound">f</span> <span class="bound">x</span><span class="main">.</span> Term_app <span class="bound">f</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span>
     <span class="main">;</span> <span class="bound">b</span> <span class="main">=</span> <span class="main">λ</span><span class="bound">s</span><span class="main">.</span> Term_basic <span class="main">[</span><span class="bound">s</span><span class="main">]</span>
     <span class="main">;</span> <span class="bound">lets</span> <span class="main">=</span> <span class="main">λ</span><span class="bound">var</span> <span class="bound">exp</span><span class="main">.</span> Definition <span class="main">(</span>Term_rewrite <span class="main">(</span>Term_basic <span class="main">[</span><span class="bound">var</span><span class="main">]</span><span class="main">)</span> <span class="inner_cartouche">‹=›</span> <span class="bound">exp</span><span class="main">)</span>
     <span class="main">;</span> <span class="bound">lets'</span> <span class="main">=</span> <span class="main">λ</span><span class="bound">var</span> <span class="bound">exp</span><span class="main">.</span> Definition <span class="main">(</span>Term_rewrite <span class="main">(</span>Term_basic <span class="main">[</span><span class="bound">var</span><span class="main">]</span><span class="main">)</span> <span class="inner_cartouche">‹=›</span> <span class="main">(</span><span class="bound">b</span> <span class="bound">exp</span><span class="main">)</span><span class="main">)</span>
     <span class="main">;</span> <span class="bound">lets''</span> <span class="main">=</span> <span class="main">λ</span><span class="bound">var</span> <span class="bound">exp</span><span class="main">.</span> Definition <span class="main">(</span>Term_rewrite <span class="main">(</span>Term_basic <span class="main">[</span><span class="bound">var</span><span class="main">]</span><span class="main">)</span> <span class="inner_cartouche">‹=›</span> <span class="main">(</span>Term_lam <span class="inner_cartouche">‹l›</span> <span class="main">(</span><span class="main">λ</span><span class="bound">var_l</span><span class="main">.</span> Term_binop <span class="main">(</span><span class="bound">b</span> <span class="bound">var_l</span><span class="main">)</span> <span class="inner_cartouche">‹!›</span> <span class="main">(</span><span class="bound">b</span> <span class="bound">exp</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
     <span class="main">;</span> <span class="main"><span class="bound">_</span></span><span class="comment1">― ‹(ignored)›</span> <span class="main">=</span>
        <span class="keyword1">let</span> <span class="bound">l_flatten</span> <span class="main">=</span> <span class="inner_cartouche">‹L.flatten›</span> <span class="keyword1">in</span>
        <span class="main">[</span> <span class="bound">lets</span> <span class="bound">l_flatten</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">fun_foldl</span> <span class="main">=</span> <span class="main">λ</span><span class="bound">f</span> <span class="bound">base</span><span class="main">.</span>
                             Term_lam <span class="inner_cartouche">‹l›</span> <span class="main">(</span><span class="main">λ</span><span class="bound">var_l</span><span class="main">.</span> Term_app <span class="inner_cartouche">‹foldl›</span> <span class="main">[</span>Term_lam <span class="inner_cartouche">‹acc›</span> <span class="bound">f</span><span class="main">,</span> <span class="bound">base</span><span class="main">,</span> <span class="bound">a</span> <span class="inner_cartouche">‹rev›</span> <span class="main">(</span><span class="bound">b</span> <span class="bound">var_l</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="keyword1">in</span>
                           <span class="bound">fun_foldl</span> <span class="main">(</span><span class="main">λ</span><span class="bound">var_acc</span><span class="main">.</span>
                             <span class="bound">fun_foldl</span> <span class="main">(</span><span class="main">λ</span><span class="bound">var_acc</span><span class="main">.</span>
                               Term_lam <span class="inner_cartouche">‹l›</span> <span class="main">(</span><span class="main">λ</span><span class="bound">var_l</span><span class="main">.</span> Term_app <span class="inner_cartouche">‹Cons›</span> <span class="main">(</span>L.map <span class="bound">b</span> <span class="main">[</span><span class="bound">var_l</span><span class="main">,</span> <span class="bound">var_acc</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="bound">b</span> <span class="bound">var_acc</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="bound">b</span> <span class="inner_cartouche">‹Nil›</span><span class="main">)</span><span class="main">)</span>
        <span class="main">,</span> <span class="bound">lets</span> var_map_of_list <span class="main">(</span>Term_app <span class="inner_cartouche">‹foldl›</span>
            <span class="main">[</span> Term_lam <span class="inner_cartouche">‹map›</span> <span class="main">(</span><span class="main">λ</span><span class="bound">var_map</span><span class="main">.</span>
                <span class="keyword1">let</span> <span class="bound">var_x</span> <span class="main">=</span> <span class="inner_cartouche">‹x›</span>
                  <span class="main">;</span> <span class="bound">var_l0</span> <span class="main">=</span> <span class="inner_cartouche">‹l0›</span>
                  <span class="main">;</span> <span class="bound">var_l1</span> <span class="main">=</span> <span class="inner_cartouche">‹l1›</span>
                  <span class="main">;</span> <span class="bound">f_map</span> <span class="main">=</span> <span class="bound">a</span> <span class="bound">var_map</span> <span class="keyword1">in</span>
                Term_lambdas0 <span class="main">(</span>Term_pair <span class="main">(</span><span class="bound">b</span> <span class="bound">var_x</span><span class="main">)</span> <span class="main">(</span><span class="bound">b</span> <span class="bound">var_l1</span><span class="main">)</span><span class="main">)</span>
                  <span class="main">(</span>Term_case <span class="main">(</span><span class="bound">f_map</span> <span class="main">(</span><span class="bound">b</span> <span class="bound">var_x</span><span class="main">)</span><span class="main">)</span>
                    <span class="main">(</span>L.map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">pat</span><span class="main">,</span> <span class="bound">e</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">pat</span><span class="main">,</span> <span class="bound">f_map</span> <span class="main">(</span>Term_binop <span class="main">(</span><span class="bound">b</span> <span class="bound">var_x</span><span class="main">)</span> <span class="inner_cartouche">‹↦›</span> <span class="bound">e</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
                      <span class="main">[</span> <span class="main">(</span><span class="bound">b</span> <span class="inner_cartouche">‹None›</span><span class="main">,</span> <span class="bound">b</span> <span class="bound">var_l1</span><span class="main">)</span>
                      <span class="main">,</span> <span class="main">(</span>Term_some <span class="main">(</span><span class="bound">b</span> <span class="bound">var_l0</span><span class="main">)</span><span class="main">,</span> <span class="bound">a</span> <span class="bound">l_flatten</span> <span class="main">(</span>Term_list <span class="main">(</span>L.map <span class="bound">b</span> <span class="main">[</span><span class="bound">var_l0</span><span class="main">,</span> <span class="bound">var_l1</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
            <span class="main">,</span> <span class="bound">b</span> <span class="inner_cartouche">‹Map.empty›</span><span class="main">]</span><span class="main">)</span><span class="main">]</span> <span class="keyword1">in</span>
  L.flatten
  <span class="main">[</span> <span class="keyword1">let</span> <span class="bound">a</span> <span class="main">=</span> <span class="main">λ</span><span class="bound">f</span> <span class="bound">x</span><span class="main">.</span> Term_app <span class="bound">f</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span>
      <span class="main">;</span> <span class="bound">b</span> <span class="main">=</span> <span class="main">λ</span><span class="bound">s</span><span class="main">.</span> Term_basic <span class="main">[</span><span class="bound">s</span><span class="main">]</span>
      <span class="main">;</span> <span class="bound">lets</span> <span class="main">=</span> <span class="main">λ</span><span class="bound">var</span> <span class="bound">exp</span><span class="main">.</span> Definition <span class="main">(</span>Term_rewrite <span class="main">(</span>Term_basic <span class="main">[</span><span class="bound">var</span><span class="main">]</span><span class="main">)</span> <span class="inner_cartouche">‹=›</span> <span class="bound">exp</span><span class="main">)</span>
      <span class="main">;</span> <span class="bound">mk_var</span> <span class="main">=</span> <span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="bound">b</span> <span class="main">(</span>S.flatten <span class="main">[</span><span class="inner_cartouche">‹x›</span><span class="main">,</span> String.natural_to_digit10 <span class="bound">i</span><span class="main">]</span><span class="main">)</span> <span class="keyword1">in</span>
    print_access_choose_switch
      <span class="bound">lets</span> <span class="bound">mk_var</span> <span class="bound">expr</span>
      print_access_choose_name
      Term_list Term_function Term_pair
  <span class="main">,</span> <span class="main">[]</span><span class="main">]</span> <span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Floor1_examp">
<div class="head">
<h1>Theory Floor1_examp</h1>
</div>
<pre class="source"><span class="comment1">(******************************************************************************
 * HOL-TOY
 *
 * Copyright (c) 2011-2018 Université Paris-Saclay, Univ. Paris-Sud, France
 *               2013-2017 IRT SystemX, France
 *               2011-2015 Achim D. Brucker, Germany
 *               2016-2018 The University of Sheffield, UK
 *               2016-2017 Nanyang Technological University, Singapore
 *               2017-2018 Virginia Tech, USA
 *
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are
 * met:
 *
 *     * Redistributions of source code must retain the above copyright
 *       notice, this list of conditions and the following disclaimer.
 *
 *     * Redistributions in binary form must reproduce the above
 *       copyright notice, this list of conditions and the following
 *       disclaimer in the documentation and/or other materials provided
 *       with the distribution.
 *
 *     * Neither the name of the copyright holders nor the names of its
 *       contributors may be used to endorse or promote products derived
 *       from this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 ******************************************************************************)</span>

<span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹Main Translation for: Example (Floor 1)›</span></span>

<span class="keyword1"><span class="command">theory</span></span>  Floor1_examp
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Core_init.html">Core_init</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">list_bind</span> <span class="free"><span class="bound"><span class="entity">f0</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span>
 <span class="main">(</span><span class="keyword1">let</span> <span class="bound">l</span> <span class="main">=</span> L.map <span class="free"><span class="bound"><span class="entity">f0</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="keyword1">in</span>
  <span class="keyword1">if</span> list_ex <span class="main">(</span><span class="main">λ</span> None <span class="main">⇒</span> True <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> False<span class="main">)</span> <span class="bound">l</span> <span class="keyword1">then</span>
    None
  <span class="keyword1">else</span>
    Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>List.map_filter id <span class="bound">l</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">rbt_of_class</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">let</span> <span class="bound">rbt</span> <span class="main">=</span> <span class="main">(</span>snd <span class="keyword1">o</span> fold_class_gen <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span> <span class="bound">name</span> <span class="bound">l_attr</span> <span class="bound">l_inh</span> <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span> <span class="bound">rbt</span><span class="main">.</span>
     <span class="main">(</span> <span class="main">[</span><span class="main">()</span><span class="main">]</span>
     <span class="main">,</span> <span class="keyword1">modify_def</span> <span class="main">(</span>RBT.empty<span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="bound">name</span>
         <span class="main">(</span><span class="keyword1">let</span> <span class="bound">f_fold</span> <span class="main">=</span> <span class="main">λ</span><span class="bound">tag</span> <span class="bound">l</span> <span class="bound">rbt</span><span class="main">.</span>
            <span class="keyword1">let</span> <span class="main">(</span><span class="bound">rbt</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">n</span><span class="main">)</span> <span class="main">=</span> List.fold
                                   <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">name_attr</span><span class="main">,</span> <span class="bound">ty</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">λ</span><span class="main">(</span><span class="bound">rbt</span><span class="main">,</span> <span class="bound">cpt</span><span class="main">,</span> <span class="bound">l_obj</span><span class="main">)</span><span class="main">.</span>
                                     <span class="main">(</span><span class="keyword1">insert</span> <span class="bound">name_attr</span> <span class="main">(</span><span class="bound">ty</span><span class="main">,</span> <span class="bound">tag</span><span class="main">,</span> OptIdent <span class="bound">cpt</span><span class="main">)</span> <span class="bound">rbt</span><span class="main">,</span> Succ <span class="bound">cpt</span><span class="main">,</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">ty</span> <span class="keyword1">of</span> ToyTy_object <span class="main">(</span>ToyTyObj <span class="main">(</span>ToyTyCore <span class="bound">ty_obj</span><span class="main">)</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">⇒</span> Some <span class="bound">ty_obj</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> None<span class="main">)</span> <span class="main">#</span> <span class="bound">l_obj</span><span class="main">)</span><span class="main">)</span>
                                   <span class="bound">l</span>
                                   <span class="main">(</span><span class="bound">rbt</span><span class="main">,</span> <span class="main">0</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="keyword1">in</span>
            <span class="main">(</span><span class="bound">rbt</span><span class="main">,</span> <span class="main">(</span><span class="bound">tag</span><span class="main">,</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">in</span>
          <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">rbt</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span>
           <span class="keyword1">let</span> <span class="main">(</span><span class="bound">rbt</span><span class="main">,</span> <span class="bound">info_own</span><span class="main">)</span> <span class="main">=</span> <span class="bound">f_fold</span> OptOwn <span class="bound">l_attr</span> <span class="bound">rbt</span> <span class="keyword1">in</span>
           <span class="keyword1">let</span> <span class="main">(</span><span class="bound">rbt</span><span class="main">,</span> <span class="bound">info_inh</span><span class="main">)</span> <span class="main">=</span> <span class="bound">f_fold</span> OptInh <span class="main">(</span>L.flatten <span class="main">(</span>map_class_inh <span class="bound">l_inh</span><span class="main">)</span><span class="main">)</span> <span class="bound">rbt</span> <span class="keyword1">in</span>
           <span class="main">(</span><span class="bound">rbt</span><span class="main">,</span> <span class="main">[</span><span class="bound">info_own</span><span class="main">,</span> <span class="bound">info_inh</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
         <span class="bound">rbt</span><span class="main">)</span><span class="main">)</span> RBT.empty<span class="main">)</span> <span class="main">(</span><span class="keyword1">case</span> D_input_class <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="keyword1">of</span> Some <span class="bound">c</span> <span class="main">⇒</span> <span class="bound">c</span><span class="main">)</span> <span class="keyword1">in</span>
   <span class="main">(</span><span class="main">λ</span><span class="bound">name</span><span class="main">.</span>
     <span class="keyword1">let</span> <span class="bound">rbt</span> <span class="main">=</span> <span class="keyword1">lookup</span> <span class="bound">rbt</span> <span class="bound">name</span> <span class="keyword1">in</span>
     <span class="main">(</span> <span class="bound">rbt</span> <span class="main">=</span> None
     <span class="main">,</span> <span class="main">λ</span> <span class="bound">name_attr</span><span class="main">.</span>
        Option.bind <span class="bound">rbt</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">rbt</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="keyword1">lookup</span> <span class="bound">rbt</span> <span class="bound">name_attr</span><span class="main">)</span>
     <span class="main">,</span> <span class="main">λ</span> <span class="bound">v</span><span class="main">.</span> Option.bind <span class="bound">rbt</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">l</span><span class="main">)</span><span class="main">.</span>
        map_option <span class="main">(</span><span class="main">λ</span><span class="bound">l</span> <span class="bound">f</span> <span class="bound">accu</span><span class="main">.</span>
          <span class="keyword1">let</span> <span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">accu</span><span class="main">)</span> <span class="main">=</span>
            List.fold
              <span class="main">(</span><span class="keyword1">let</span> <span class="bound">f_fold</span> <span class="main">=</span> <span class="main">λ</span><span class="bound">b</span> <span class="main">(</span><span class="bound">n</span><span class="main">,</span> <span class="bound">accu</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>Succ <span class="bound">n</span><span class="main">,</span> <span class="bound">f</span> <span class="bound">b</span> <span class="bound">n</span> <span class="bound">accu</span><span class="main">)</span> <span class="keyword1">in</span>
               <span class="keyword1">if</span> D_toy_semantics <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">=</span> Gen_only_design <span class="keyword1">then</span>
                 <span class="bound">f_fold</span>
               <span class="keyword1">else</span>
                 <span class="main">λ</span> Some <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">n</span><span class="main">,</span> <span class="bound">accu</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>Succ <span class="bound">n</span><span class="main">,</span> <span class="bound">accu</span><span class="main">)</span><span class="main">)</span>
                 <span class="main">|</span> None <span class="main">⇒</span> <span class="bound">f_fold</span> None<span class="main">)</span> <span class="main">(</span>rev <span class="bound">l</span><span class="main">)</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="bound">accu</span><span class="main">)</span> <span class="keyword1">in</span>
          <span class="bound">accu</span><span class="main">)</span> <span class="main">(</span>L.assoc <span class="bound">v</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">inst_name</span> <span class="free"><span class="bound"><span class="entity">toyi</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> Inst_name <span class="free"><span class="bound"><span class="entity">toyi</span></span></span> <span class="keyword1">of</span> Some <span class="bound">n</span> <span class="main">⇒</span> <span class="bound">n</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">init_map_class</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">rbt_nat</span><span class="main">,</span> <span class="bound">rbt_str</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">=</span>
     List.fold
       <span class="main">(</span><span class="main">λ</span> <span class="bound">toyi</span> <span class="main">(</span><span class="bound">rbt_nat</span><span class="main">,</span> <span class="bound">rbt_str</span><span class="main">,</span> <span class="bound">oid_start</span><span class="main">,</span> <span class="bound">accu</span><span class="main">)</span><span class="main">.</span>
         <span class="main">(</span> RBT.insert <span class="main">(</span>Oid <span class="bound">accu</span><span class="main">)</span> <span class="bound">oid_start</span> <span class="bound">rbt_nat</span>
         <span class="main">,</span> <span class="keyword1">insert</span> <span class="main">(</span>inst_name <span class="bound">toyi</span><span class="main">)</span> <span class="bound">oid_start</span> <span class="bound">rbt_str</span>
         <span class="main">,</span> oidSucInh <span class="bound">oid_start</span>
         <span class="main">,</span> Succ <span class="bound">accu</span><span class="main">)</span><span class="main">)</span>
       <span class="free"><span class="bound"><span class="entity">l</span></span></span>
       <span class="main">(</span> RBT.empty
       <span class="main">,</span> RBT.bulkload <span class="main">(</span>L.map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">k</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>String<span class="hidden">⇩</span><sub>b</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>e</sub>.to_list <span class="bound">k</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>D_input_instance <span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">)</span><span class="main">)</span>
       <span class="main">,</span> D_toy_oid_start <span class="free"><span class="bound"><span class="entity">env</span></span></span>
       <span class="main">,</span> <span class="main">0</span><span class="main">)</span> <span class="keyword1">in</span>
   <span class="main">(</span>rbt_of_class <span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">,</span> RBT.lookup <span class="bound">rbt_nat</span><span class="main">,</span> <span class="keyword1">lookup</span> <span class="bound">rbt_str</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">print_examp_def_st_assoc_build_rbt_gen</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">rbt</span></span></span> <span class="free"><span class="bound"><span class="entity">map_self</span></span></span> <span class="free"><span class="bound"><span class="entity">map_username</span></span></span> <span class="free"><span class="bound"><span class="entity">l_assoc</span></span></span> <span class="main">=</span>
  List.fold
     <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">toyi</span><span class="main">,</span> <span class="bound">cpt</span><span class="main">)</span><span class="main">.</span> fold_instance_single
       <span class="main">(</span><span class="main">λ</span> <span class="bound">ty</span> <span class="bound">l_attr</span><span class="main">.</span>
         <span class="keyword1">let</span> <span class="main">(</span><span class="bound">f_attr_ty</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">rbt</span></span></span> <span class="bound">ty</span> <span class="keyword1">in</span>
         <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">ty</span>
         <span class="main">(</span>List.fold <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">name_attr</span><span class="main">,</span> <span class="bound">shall</span><span class="main">)</span><span class="main">.</span>
           <span class="keyword1">case</span> <span class="bound">f_attr_ty</span> <span class="bound">name_attr</span> <span class="keyword1">of</span>
             Some <span class="main">(</span>ToyTy_object <span class="main">(</span>ToyTyObj <span class="main">(</span>ToyTyCore <span class="bound">ty_obj</span><span class="main">)</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">⇒</span>
               <span class="keyword1">modify_def</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="bound">ty_obj</span><span class="main">)</span> <span class="bound">name_attr</span>
               <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">accu</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">case</span> <span class="keyword1">let</span> <span class="bound">find_map</span> <span class="main">=</span> <span class="main">λ</span> ShallB_str <span class="bound">s</span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">map_username</span></span></span> <span class="bound">s</span> <span class="main">|</span> ShallB_self <span class="bound">s</span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">map_self</span></span></span> <span class="bound">s</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> None <span class="keyword1">in</span>
                                 <span class="keyword1">case</span> <span class="bound">shall</span> <span class="keyword1">of</span>
                                   ShallB_list <span class="bound">l</span> <span class="main">⇒</span> <span class="keyword1">if</span> list_ex <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">find_map</span> <span class="bound">x</span> <span class="main">=</span> None<span class="main">)</span> <span class="bound">l</span> <span class="keyword1">then</span>
                                                      None
                                                    <span class="keyword1">else</span>
                                                      Some <span class="main">(</span>List.map_filter <span class="bound">find_map</span> <span class="bound">l</span><span class="main">)</span>
                                 <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> map_option <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span><span class="bound">find_map</span> <span class="bound">shall</span><span class="main">)</span> <span class="keyword1">of</span>
                      None <span class="main">⇒</span> <span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">accu</span><span class="main">)</span>
                    <span class="main">|</span> Some <span class="bound">oid</span> <span class="main">⇒</span> <span class="main">(</span>L.map <span class="main">(</span>L.map oidGetInh<span class="main">)</span> <span class="main">[</span><span class="main">[</span><span class="bound">cpt</span><span class="main">]</span><span class="main">,</span> <span class="bound">oid</span><span class="main">]</span> <span class="main">#</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">accu</span><span class="main">)</span><span class="main">)</span>
           <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> id<span class="main">)</span> <span class="bound">l_attr</span><span class="main">)</span><span class="main">)</span> <span class="bound">toyi</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">l_assoc</span></span></span> RBT.empty"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">print_examp_def_st_assoc_build_rbt</span> <span class="main">=</span> print_examp_def_st_assoc_build_rbt_gen <span class="main">(</span><span class="keyword1">modify_def</span> RBT.empty<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">print_examp_def_st_assoc</span> <span class="free"><span class="bound"><span class="entity">rbt</span></span></span> <span class="free"><span class="bound"><span class="entity">map_self</span></span></span> <span class="free"><span class="bound"><span class="entity">map_username</span></span></span> <span class="free"><span class="bound"><span class="entity">l_assoc</span></span></span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">let</span> <span class="bound">b</span> <span class="main">=</span> <span class="main">λ</span><span class="bound">s</span><span class="main">.</span> Term_basic <span class="main">[</span><span class="bound">s</span><span class="main">]</span>
     <span class="main">;</span> <span class="bound">rbt</span> <span class="main">=</span> print_examp_def_st_assoc_build_rbt <span class="free"><span class="bound"><span class="entity">rbt</span></span></span> <span class="free"><span class="bound"><span class="entity">map_self</span></span></span> <span class="free"><span class="bound"><span class="entity">map_username</span></span></span> <span class="free"><span class="bound"><span class="entity">l_assoc</span></span></span> <span class="keyword1">in</span>
   Term_app var_map_of_list <span class="main">[</span>Term_list <span class="main">(</span><span class="keyword1">fold</span> <span class="main">(</span><span class="main">λ</span><span class="bound">name</span><span class="main">.</span> <span class="keyword1">fold</span> <span class="main">(</span><span class="main">λ</span><span class="bound">name_attr</span> <span class="main">(</span><span class="bound">l_attr</span><span class="main">,</span> <span class="bound">ty_obj</span><span class="main">)</span> <span class="bound">l_cons</span><span class="main">.</span>
         <span class="keyword1">let</span> <span class="bound">cpt_from</span> <span class="main">=</span> TyObjN_ass_switch <span class="main">(</span>TyObj_from <span class="bound">ty_obj</span><span class="main">)</span> <span class="keyword1">in</span>
         Term_pair
           <span class="main">(</span>Term_basic <span class="main">[</span>print_access_oid_uniq_name <span class="bound">cpt_from</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">@@</span> String.isub <span class="bound">name</span><span class="main">)</span> <span class="bound">name_attr</span><span class="main">]</span><span class="main">)</span>
           <span class="main">(</span>Term_app <span class="inner_cartouche">‹List.map›</span>
             <span class="main">[</span> Term_binop <span class="main">(</span><span class="keyword1">let</span> <span class="bound">var_x</span> <span class="main">=</span> <span class="inner_cartouche">‹x›</span>
                             <span class="main">;</span> <span class="bound">var_y</span> <span class="main">=</span> <span class="inner_cartouche">‹y›</span> <span class="keyword1">in</span>
                           Term_lambdas0
                             <span class="main">(</span>Term_pair <span class="main">(</span><span class="bound">b</span> <span class="bound">var_x</span><span class="main">)</span> <span class="main">(</span><span class="bound">b</span> <span class="bound">var_y</span><span class="main">)</span><span class="main">)</span>
                             <span class="main">(</span>Term_list <span class="main">[</span><span class="bound">b</span> <span class="bound">var_x</span><span class="main">,</span> <span class="bound">b</span> <span class="bound">var_y</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>
                          <span class="inner_cartouche">‹o›</span>
                          <span class="main">(</span><span class="bound">b</span> <span class="main">(</span>print_access_choose_name
                                <span class="main">(</span>TyObj_ass_arity <span class="bound">ty_obj</span><span class="main">)</span>
                                <span class="bound">cpt_from</span>
                                <span class="main">(</span>TyObjN_ass_switch <span class="main">(</span>TyObj_to <span class="bound">ty_obj</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
             <span class="main">,</span> Term_list' <span class="main">(</span>Term_list' <span class="main">(</span>Term_list' <span class="main">(</span>Term_oid var_oid_uniq<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="bound">l_attr</span> <span class="main">]</span><span class="main">)</span>
         <span class="main">#</span> <span class="bound">l_cons</span><span class="main">)</span><span class="main">)</span> <span class="bound">rbt</span> <span class="main">[]</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">print_examp_instance_oid</span> <span class="free"><span class="bound"><span class="entity">thy_definition_hol</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">=</span> <span class="main">(</span>L.map <span class="free"><span class="bound"><span class="entity">thy_definition_hol</span></span></span> <span class="keyword1">o</span> L.flatten<span class="main">)</span>
 <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">f1</span><span class="main">,</span> <span class="bound">f2</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">var_oid</span> <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="bound">var_oid</span><span class="main">,</span> <span class="main">λ</span> <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span> <span class="bound">cpt</span><span class="main">.</span> Term_oid <span class="inner_cartouche">‹›</span> <span class="main">(</span>oidGetInh <span class="bound">cpt</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">in</span>
  L.map <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">toyi</span><span class="main">,</span> <span class="bound">cpt</span><span class="main">)</span><span class="main">.</span>
    <span class="keyword1">if</span> List.fold <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">cpt0</span><span class="main">)</span> <span class="bound">b</span><span class="main">.</span> <span class="bound">b</span> <span class="main">|</span> oidGetInh <span class="bound">cpt0</span> <span class="main">=</span> oidGetInh <span class="bound">cpt</span><span class="main">)</span> <span class="main">(</span>D_input_instance <span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">)</span> False <span class="keyword1">then</span>
      <span class="main">[]</span>
    <span class="keyword1">else</span>
      <span class="keyword1">let</span> <span class="bound">var_oid</span> <span class="main">=</span> Term_oid var_oid_uniq <span class="main">(</span>oidGetInh <span class="bound">cpt</span><span class="main">)</span>
        <span class="main">;</span> <span class="bound">isub_name</span> <span class="main">=</span> <span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">@@</span> String.isub <span class="main">(</span>inst_ty <span class="bound">toyi</span><span class="main">)</span> <span class="keyword1">in</span>
      <span class="main">[</span>Definition <span class="main">(</span>Term_rewrite <span class="main">(</span><span class="bound">f1</span> <span class="bound">var_oid</span> <span class="bound">isub_name</span> <span class="bound">toyi</span><span class="main">)</span> <span class="inner_cartouche">‹=›</span> <span class="main">(</span><span class="bound">f2</span> <span class="bound">toyi</span> <span class="bound">isub_name</span> <span class="bound">cpt</span><span class="main">)</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">check_export_code</span> <span class="free"><span class="bound"><span class="entity">f_writeln</span></span></span> <span class="free"><span class="bound"><span class="entity">f_warning</span></span></span> <span class="free"><span class="bound"><span class="entity">f_error</span></span></span> <span class="free"><span class="bound"><span class="entity">f_raise</span></span></span> <span class="free"><span class="bound"><span class="entity">l_report</span></span></span> <span class="free"><span class="bound"><span class="entity">msg_last</span></span></span> <span class="main">=</span>
 <span class="main">(</span><span class="keyword1">let</span> <span class="bound">l_err</span> <span class="main">=</span>
        List.fold
          <span class="main">(</span><span class="main">λ</span> <span class="main">(</span>Writeln<span class="main">,</span> <span class="bound">s</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">λ</span><span class="bound">acc</span><span class="main">.</span> <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">f_writeln</span></span></span> <span class="bound">s</span> <span class="keyword1">of</span> <span class="main">()</span> <span class="main">⇒</span> <span class="bound">acc</span>
           <span class="main">|</span> <span class="main">(</span>Warning<span class="main">,</span> <span class="bound">s</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">λ</span><span class="bound">acc</span><span class="main">.</span> <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">f_warning</span></span></span> <span class="bound">s</span> <span class="keyword1">of</span> <span class="main">()</span> <span class="main">⇒</span> <span class="bound">acc</span>
           <span class="main">|</span> <span class="main">(</span>Error<span class="main">,</span> <span class="bound">s</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">λ</span><span class="bound">acc</span><span class="main">.</span> <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">f_error</span></span></span> <span class="bound">s</span> <span class="keyword1">of</span> <span class="main">()</span> <span class="main">⇒</span> <span class="bound">s</span> <span class="main">#</span> <span class="bound">acc</span><span class="main">)</span>
          <span class="free"><span class="bound"><span class="entity">l_report</span></span></span>
          <span class="main">[]</span> <span class="keyword1">in</span>
  <span class="keyword1">if</span> <span class="bound">l_err</span> <span class="main">=</span> <span class="main">[]</span> <span class="keyword1">then</span>
    <span class="main">()</span>
  <span class="keyword1">else</span>
    <span class="free"><span class="bound"><span class="entity">f_raise</span></span></span> <span class="main">(</span>String.nat_to_digit10 <span class="main">(</span>length <span class="bound">l_err</span><span class="main">)</span> <span class="main">@@</span> <span class="free"><span class="bound"><span class="entity">msg_last</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">print_examp_instance_defassoc_gen</span> <span class="free"><span class="bound"><span class="entity">name</span></span></span> <span class="free"><span class="bound"><span class="entity">l_toyi</span></span></span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">=</span>
 <span class="main">(</span><span class="keyword1">case</span> D_toy_semantics <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="keyword1">of</span> Gen_only_analysis <span class="main">⇒</span> <span class="main">[]</span> <span class="main">|</span> Gen_default <span class="main">⇒</span> <span class="main">[]</span> <span class="main">|</span> Gen_only_design <span class="main">⇒</span>
  <span class="keyword1">let</span> <span class="bound">a</span> <span class="main">=</span> <span class="main">λ</span><span class="bound">f</span> <span class="bound">x</span><span class="main">.</span> Term_app <span class="bound">f</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span>
    <span class="main">;</span> <span class="bound">b</span> <span class="main">=</span> <span class="main">λ</span><span class="bound">s</span><span class="main">.</span> Term_basic <span class="main">[</span><span class="bound">s</span><span class="main">]</span>
    <span class="main">;</span> <span class="main">(</span><span class="bound">rbt</span> <span class="main">::</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span> <span class="main">×</span> <span class="main">_</span> <span class="main">×</span> <span class="main">(</span><span class="main">_</span> <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span><span class="main">_</span> <span class="main">⇒</span> natural <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">(</span>toy_ty <span class="main">×</span> toy_data_shallow<span class="main">)</span> option list<span class="main">)</span> <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span><span class="main">)</span> option<span class="main">)</span>
      <span class="main">,</span> <span class="main">(</span><span class="bound">map_self</span><span class="main">,</span> <span class="bound">map_username</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
        init_map_class <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">(</span>fst <span class="main">(</span>L.split <span class="free"><span class="bound"><span class="entity">l_toyi</span></span></span><span class="main">)</span><span class="main">)</span>
    <span class="main">;</span> <span class="bound">l_toyi</span> <span class="main">=</span> <span class="keyword1">if</span> list_ex <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">toyi</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> inst_ty0 <span class="bound">toyi</span> <span class="main">=</span> None<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">l_toyi</span></span></span> <span class="keyword1">then</span> <span class="main">[]</span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">l_toyi</span></span></span> <span class="keyword1">in</span>
  <span class="main">[</span>Definition
     <span class="main">(</span>Term_rewrite <span class="free"><span class="bound"><span class="entity">name</span></span></span>
     <span class="inner_cartouche">‹=›</span>
     <span class="main">(</span><span class="keyword1">let</span> <span class="bound">var_oid_class</span> <span class="main">=</span> <span class="inner_cartouche">‹oid_class›</span>
        <span class="main">;</span> <span class="bound">var_to_from</span> <span class="main">=</span> <span class="inner_cartouche">‹to_from›</span>
        <span class="main">;</span> <span class="bound">var_oid</span> <span class="main">=</span> <span class="inner_cartouche">‹oid›</span>
        <span class="main">;</span> <span class="bound">a_l</span> <span class="main">=</span> <span class="main">λ</span><span class="bound">s</span><span class="main">.</span> Typ_apply <span class="main">(</span>Typ_base var_ty_list<span class="main">)</span> <span class="main">[</span><span class="bound">s</span><span class="main">]</span> <span class="keyword1">in</span>
      Term_lambdas
        <span class="main">[</span><span class="bound">var_oid_class</span><span class="main">,</span> <span class="bound">var_to_from</span><span class="main">,</span> <span class="bound">var_oid</span><span class="main">]</span>
        <span class="main">(</span>Term_annot <span class="main">(</span>Term_case
          <span class="main">(</span>Term_app var_deref_assocs_list
            <span class="main">[</span> Term_annot <span class="main">(</span><span class="bound">b</span> <span class="bound">var_to_from</span><span class="main">)</span> <span class="main">(</span>Ty_arrow
                                            <span class="main">(</span><span class="bound">a_l</span> <span class="main">(</span><span class="bound">a_l</span> <span class="main">(</span>Typ_base const_oid<span class="main">)</span><span class="main">)</span><span class="main">)</span>
                                            <span class="main">(</span><span class="keyword1">let</span> <span class="bound">t</span> <span class="main">=</span> <span class="bound">a_l</span> <span class="main">(</span>Typ_base const_oid<span class="main">)</span> <span class="keyword1">in</span>
                                             Ty_times <span class="bound">t</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>
            <span class="main">,</span> Term_annot' <span class="main">(</span><span class="bound">b</span> <span class="bound">var_oid</span><span class="main">)</span> const_oid
            <span class="main">,</span> <span class="bound">a</span> <span class="inner_cartouche">‹drop›</span>
              <span class="main">(</span>Term_applys <span class="main">(</span>print_examp_def_st_assoc <span class="main">(</span>snd <span class="keyword1">o</span> <span class="bound">rbt</span><span class="main">)</span> <span class="bound">map_self</span> <span class="bound">map_username</span> <span class="bound">l_toyi</span><span class="main">)</span>
                           <span class="main">[</span>Term_annot' <span class="main">(</span><span class="bound">b</span> <span class="bound">var_oid_class</span><span class="main">)</span> const_oid<span class="main">]</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>
          <span class="main">[</span> <span class="main">(</span><span class="bound">b</span> <span class="inner_cartouche">‹Nil›</span><span class="main">,</span> <span class="bound">b</span> <span class="inner_cartouche">‹None›</span><span class="main">)</span>
          <span class="main">,</span> <span class="keyword1">let</span> <span class="bound">b_l</span> <span class="main">=</span> <span class="bound">b</span> <span class="inner_cartouche">‹l›</span> <span class="keyword1">in</span>
            <span class="main">(</span><span class="bound">b_l</span><span class="main">,</span> <span class="bound">a</span> <span class="inner_cartouche">‹Some›</span> <span class="bound">b_l</span><span class="main">)</span><span class="main">]</span> <span class="main">)</span> <span class="main">(</span>Typ_apply <span class="main">(</span>Typ_base <span class="inner_cartouche">‹option›</span><span class="main">)</span> <span class="main">[</span><span class="bound">a_l</span> <span class="main">(</span>Typ_base const_oid<span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">print_examp_instance_defassoc</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> ToyInstance <span class="bound">l</span> <span class="main">⇒</span> <span class="main">λ</span> <span class="bound">env</span><span class="main">.</span>
  <span class="keyword1">let</span> <span class="bound">l</span> <span class="main">=</span> L.flatten <span class="main">(</span>fst <span class="main">(</span>L.mapM <span class="main">(</span><span class="main">λ</span><span class="bound">toyi</span> <span class="bound">cpt</span><span class="main">.</span> <span class="main">(</span><span class="main">[</span><span class="main">(</span><span class="bound">toyi</span><span class="main">,</span> <span class="bound">cpt</span><span class="main">)</span><span class="main">]</span><span class="main">,</span> oidSucInh <span class="bound">cpt</span><span class="main">)</span><span class="main">)</span> <span class="bound">l</span> <span class="main">(</span>D_toy_oid_start <span class="bound">env</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">in</span>
  <span class="main">(</span><span class="main">λ</span><span class="bound">l_res</span><span class="main">.</span>
    <span class="main">(</span> print_examp_instance_oid O.definition <span class="bound">l</span> <span class="bound">env</span>
      <span class="main">@@@@</span> L.map O.definition <span class="bound">l_res</span>
    <span class="main">,</span> <span class="bound">env</span><span class="main">)</span><span class="main">)</span>
  <span class="main">(</span>print_examp_instance_defassoc_gen
    <span class="main">(</span>Term_oid var_inst_assoc <span class="main">(</span>oidGetInh <span class="main">(</span>D_toy_oid_start <span class="bound">env</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
    <span class="bound">l</span>
    <span class="bound">env</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">print_examp_instance_name</span> <span class="main">=</span> id"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">print_examp_instance</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> ToyInstance <span class="bound">l</span> <span class="main">⇒</span> <span class="main">λ</span> <span class="bound">env</span><span class="main">.</span>
 <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="main">(</span><span class="bound">l_res</span><span class="main">,</span> <span class="bound">oid_start</span><span class="main">)</span><span class="main">,</span> <span class="bound">instance_rbt</span><span class="main">)</span><span class="main">.</span>
    <span class="main">(</span><span class="main">(</span>L.map O.definition <span class="keyword1">o</span> L.flatten<span class="main">)</span> <span class="bound">l_res</span><span class="main">,</span> <span class="bound">env</span> <span class="main">⦇</span> D_toy_oid_start <span class="main">:=</span> <span class="bound">oid_start</span><span class="main">,</span> D_input_instance <span class="main">:=</span> <span class="bound">instance_rbt</span> <span class="main">⦈</span><span class="main">)</span><span class="main">)</span>
  <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span> <span class="bound">rbt</span> <span class="main">::</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span> <span class="main">×</span> <span class="main">_</span> <span class="main">×</span> <span class="main">(</span><span class="main">_</span> <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span><span class="main">_</span> <span class="main">⇒</span> <span class="keyword1">nat</span> <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span>
                <span class="main">(</span>toy_ty_class option <span class="main">×</span>
                  <span class="main">(</span>toy_ty <span class="main">×</span> <span class="main">(</span><span class="keyword1">string</span> <span class="main">×</span> <span class="keyword1">string</span><span class="main">)</span> option <span class="main">×</span> toy_data_shallow<span class="main">)</span> option<span class="main">)</span> list<span class="main">)</span> option<span class="main">)</span>
       <span class="main">,</span> <span class="main">(</span><span class="bound">map_self</span><span class="main">,</span> <span class="bound">map_username</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> init_map_class <span class="bound">env</span> <span class="bound">l</span>
     <span class="main">;</span> <span class="bound">a</span> <span class="main">=</span> <span class="main">λ</span><span class="bound">f</span> <span class="bound">x</span><span class="main">.</span> Term_app <span class="bound">f</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span>
     <span class="main">;</span> <span class="bound">b</span> <span class="main">=</span> <span class="main">λ</span><span class="bound">s</span><span class="main">.</span> Term_basic <span class="main">[</span><span class="bound">s</span><span class="main">]</span> <span class="keyword1">in</span>
   <span class="main">(</span> <span class="keyword1">let</span> <span class="bound">var_inst_ass</span> <span class="main">=</span> <span class="inner_cartouche">‹inst_assoc›</span> <span class="keyword1">in</span>
     L.mapM
       <span class="main">(</span><span class="main">λ</span> <span class="bound">toyi</span> <span class="bound">cpt</span><span class="main">.</span>
         <span class="main">(</span> <span class="main">[]</span>
         <span class="main">,</span> oidSucInh <span class="bound">cpt</span><span class="main">)</span><span class="main">)</span>
       <span class="bound">l</span>
       <span class="main">(</span>D_toy_oid_start <span class="bound">env</span><span class="main">)</span>
   <span class="main">,</span> List.fold <span class="main">(</span><span class="main">λ</span><span class="bound">toyi</span> <span class="bound">instance_rbt</span><span class="main">.</span>
       <span class="keyword1">let</span> <span class="bound">n</span> <span class="main">=</span> inst_name <span class="bound">toyi</span> <span class="keyword1">in</span>
       <span class="main">(</span>String.to_String<span class="hidden">⇩</span><sub>b</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>e</sub> <span class="bound">n</span><span class="main">,</span> <span class="bound">toyi</span><span class="main">,</span> <span class="keyword1">case</span> <span class="bound">map_username</span> <span class="bound">n</span> <span class="keyword1">of</span> Some <span class="bound">oid</span> <span class="main">⇒</span> <span class="bound">oid</span><span class="main">)</span> <span class="main">#</span> <span class="bound">instance_rbt</span><span class="main">)</span> <span class="bound">l</span> <span class="main">(</span>D_input_instance <span class="bound">env</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">print_examp_def_st1</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> ToyDefSt <span class="bound">name</span> <span class="bound">l</span> <span class="main">⇒</span> bootstrap_floor
  <span class="main">(</span><span class="main">λ</span><span class="bound">l</span> <span class="bound">env</span><span class="main">.</span> <span class="main">(</span>L.flatten <span class="main">[</span><span class="bound">l</span><span class="main">]</span><span class="main">,</span> <span class="bound">env</span><span class="main">)</span><span class="main">)</span>
  <span class="main">(</span>L.map META_all_meta_embedding
     <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">=</span> List.fold <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">pos</span><span class="main">,</span> <span class="bound">core</span><span class="main">)</span> <span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">n</span><span class="main">)</span><span class="main">.</span>
                                          <span class="main">(</span><span class="main">(</span><span class="bound">pos</span><span class="main">,</span> <span class="bound">pos</span> <span class="main">-</span> <span class="bound">n</span><span class="main">,</span> <span class="bound">core</span><span class="main">)</span> <span class="main">#</span> <span class="bound">l</span><span class="main">,</span> 
                                            <span class="keyword1">case</span> <span class="bound">core</span> <span class="keyword1">of</span> ToyDefCoreAdd <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="bound">n</span>
                                            <span class="main">|</span> ToyDefCoreBinding <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> Succ <span class="bound">n</span><span class="main">)</span><span class="main">)</span>
                                 <span class="main">(</span>L.mapi Pair <span class="bound">l</span><span class="main">)</span>
                                 <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span>
        <span class="main">;</span> <span class="main">(</span><span class="bound">l_inst</span><span class="main">,</span> <span class="bound">l_defst</span><span class="main">)</span> <span class="main">=</span>
        List.fold <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">pos</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">,</span> ToyDefCoreAdd <span class="bound">toyi</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">λ</span><span class="main">(</span><span class="bound">l_inst</span><span class="main">,</span> <span class="bound">l_defst</span><span class="main">)</span><span class="main">.</span>
                     <span class="keyword1">let</span> <span class="bound">i_name</span> <span class="main">=</span> <span class="keyword1">case</span> Inst_name <span class="bound">toyi</span> <span class="keyword1">of</span> Some <span class="bound">x</span> <span class="main">⇒</span> <span class="bound">x</span> <span class="main">|</span> None <span class="main">⇒</span> S.flatten <span class="main">[</span><span class="bound">name</span><span class="main">,</span> <span class="inner_cartouche">‹_object›</span><span class="main">,</span> String.natural_to_digit10 <span class="bound">pos</span><span class="main">]</span> <span class="keyword1">in</span>
                       <span class="main">(</span> map_instance_single <span class="main">(</span>map_prod id <span class="main">(</span>map_prod id <span class="main">(</span>map_data_shallow_self <span class="main">(</span><span class="main">λ</span>Oid <span class="bound">self</span> <span class="main">⇒</span>
                           <span class="main">(</span><span class="keyword1">case</span> L.assoc <span class="bound">self</span> <span class="bound">l</span> <span class="keyword1">of</span>
                              Some <span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> ToyDefCoreBinding <span class="bound">name</span><span class="main">)</span> <span class="main">⇒</span> ShallB_str <span class="bound">name</span>
                            <span class="main">|</span> Some <span class="main">(</span><span class="bound">p</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">⇒</span> ShallB_self <span class="main">(</span>Oid <span class="bound">p</span><span class="main">)</span>
                            <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> ShallB_list <span class="main">[]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="bound">toyi</span> 
                         <span class="main">⦇</span> Inst_name <span class="main">:=</span> Some <span class="bound">i_name</span> <span class="main">⦈</span>
                       <span class="main">#</span> <span class="bound">l_inst</span>
                       <span class="main">,</span> ToyDefCoreBinding <span class="bound">i_name</span> <span class="main">#</span> <span class="bound">l_defst</span><span class="main">)</span>
                   <span class="main">|</span> <span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">,</span> ToyDefCoreBinding <span class="bound">name</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">λ</span><span class="main">(</span><span class="bound">l_inst</span><span class="main">,</span> <span class="bound">l_defst</span><span class="main">)</span><span class="main">.</span>
                       <span class="main">(</span> <span class="bound">l_inst</span>
                       <span class="main">,</span> ToyDefCoreBinding <span class="bound">name</span> <span class="main">#</span> <span class="bound">l_defst</span><span class="main">)</span><span class="main">)</span>
                  <span class="bound">l</span>
                  <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> 
        <span class="main">;</span> <span class="bound">l</span> <span class="main">=</span> <span class="main">[</span> META_def_state Floor2 <span class="main">(</span>ToyDefSt <span class="bound">name</span> <span class="bound">l_defst</span><span class="main">)</span> <span class="main">]</span> <span class="keyword1">in</span>
      <span class="keyword1">if</span> <span class="bound">l_inst</span> <span class="main">=</span> <span class="main">[]</span> <span class="keyword1">then</span>
        <span class="bound">l</span>
      <span class="keyword1">else</span>
        META_instance <span class="main">(</span>ToyInstance <span class="bound">l_inst</span><span class="main">)</span> <span class="main">#</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">print_pre_post</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> ToyDefPP <span class="bound">name</span> <span class="bound">s_pre</span> <span class="bound">s_post</span> <span class="main">⇒</span> bootstrap_floor
  <span class="main">(</span><span class="main">λ</span><span class="bound">f</span> <span class="bound">env</span><span class="main">.</span> <span class="main">(</span>L.flatten <span class="main">[</span><span class="bound">f</span> <span class="bound">env</span><span class="main">]</span><span class="main">,</span> <span class="bound">env</span><span class="main">)</span><span class="main">)</span>
  <span class="main">(</span><span class="main">λ</span><span class="bound">env</span><span class="main">.</span>
    <span class="keyword1">let</span> <span class="bound">pref_name</span> <span class="main">=</span> <span class="keyword1">case</span> <span class="bound">name</span> <span class="keyword1">of</span> Some <span class="bound">n</span> <span class="main">⇒</span> <span class="bound">n</span>
                               <span class="main">|</span> None <span class="main">⇒</span> <span class="inner_cartouche">‹WFF_›</span> <span class="main">@@</span> String.nat_to_digit10 <span class="main">(</span>length <span class="main">(</span>D_input_meta <span class="bound">env</span><span class="main">)</span><span class="main">)</span>
      <span class="main">;</span> <span class="bound">f_comp</span> <span class="main">=</span> <span class="main">λ</span>None <span class="main">⇒</span> id <span class="main">|</span> Some <span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">f</span><span class="main">)</span> <span class="main">⇒</span> <span class="bound">f</span>
      <span class="main">;</span> <span class="bound">f_conv</span> <span class="main">=</span> <span class="main">λ</span><span class="bound">msg</span><span class="main">.</span>
          <span class="main">λ</span> ToyDefPPCoreAdd <span class="bound">toy_def_state</span> <span class="main">⇒</span>
              <span class="keyword1">let</span> <span class="bound">n</span> <span class="main">=</span> <span class="bound">pref_name</span> <span class="main">@@</span> <span class="bound">msg</span> <span class="keyword1">in</span>
              <span class="main">(</span>ToyDefPPCoreBinding <span class="bound">n</span><span class="main">,</span> Cons <span class="main">(</span>META_def_state Floor1 <span class="main">(</span>ToyDefSt <span class="bound">n</span> <span class="bound">toy_def_state</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
          <span class="main">|</span> <span class="bound">s</span> <span class="main">⇒</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span> id<span class="main">)</span> <span class="keyword1">in</span>
    L.map
      META_all_meta_embedding
      <span class="main">(</span><span class="keyword1">let</span> <span class="bound">o_pre</span> <span class="main">=</span> Some <span class="main">(</span><span class="bound">f_conv</span> <span class="inner_cartouche">‹_pre›</span> <span class="bound">s_pre</span><span class="main">)</span>
         <span class="main">;</span> <span class="bound">o_post</span> <span class="main">=</span> map_option <span class="main">(</span><span class="bound">f_conv</span> <span class="inner_cartouche">‹_post›</span><span class="main">)</span> <span class="bound">s_post</span> <span class="keyword1">in</span>
       <span class="main">(</span><span class="bound">f_comp</span> <span class="bound">o_pre</span> <span class="keyword1">o</span> <span class="bound">f_comp</span> <span class="bound">o_post</span><span class="main">)</span>
         <span class="main">[</span> META_def_pre_post Floor2 <span class="main">(</span>ToyDefPP <span class="bound">name</span>
                                             <span class="main">(</span><span class="keyword1">case</span> <span class="bound">o_pre</span> <span class="keyword1">of</span> Some <span class="main">(</span><span class="bound">n</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">⇒</span> <span class="bound">n</span><span class="main">)</span>
                                             <span class="main">(</span>map_option fst <span class="bound">o_post</span><span class="main">)</span><span class="main">)</span> <span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Floor2_examp">
<div class="head">
<h1>Theory Floor2_examp</h1>
</div>
<pre class="source"><span class="comment1">(******************************************************************************
 * HOL-TOY
 *
 * Copyright (c) 2011-2018 Université Paris-Saclay, Univ. Paris-Sud, France
 *               2013-2017 IRT SystemX, France
 *               2011-2015 Achim D. Brucker, Germany
 *               2016-2018 The University of Sheffield, UK
 *               2016-2017 Nanyang Technological University, Singapore
 *               2017-2018 Virginia Tech, USA
 *
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are
 * met:
 *
 *     * Redistributions of source code must retain the above copyright
 *       notice, this list of conditions and the following disclaimer.
 *
 *     * Redistributions in binary form must reproduce the above
 *       copyright notice, this list of conditions and the following
 *       disclaimer in the documentation and/or other materials provided
 *       with the distribution.
 *
 *     * Neither the name of the copyright holders nor the names of its
 *       contributors may be used to endorse or promote products derived
 *       from this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 ******************************************************************************)</span>

<span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹Main Translation for: Example (Floor 2)›</span></span>

<span class="keyword1"><span class="command">theory</span></span>  Floor2_examp
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Floor1_examp.html">Floor1_examp</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">print_examp_def_st_locale_distinct</span> <span class="main">=</span> <span class="inner_cartouche">‹distinct_oid›</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">print_examp_def_st_locale_metis</span> <span class="main">=</span> M.metis <span class="main">(</span>L.map T.thm <span class="main">[</span>print_examp_def_st_locale_distinct<span class="main">,</span> <span class="inner_cartouche">‹distinct_length_2_or_more›</span><span class="main">]</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">print_examp_def_st_locale_aux</span> <span class="free"><span class="bound"><span class="entity">f_toyi</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span> 
 <span class="main">(</span><span class="keyword1">let</span> <span class="bound">b</span> <span class="main">=</span> <span class="main">λ</span><span class="bound">s</span><span class="main">.</span> Term_basic <span class="main">[</span><span class="bound">s</span><span class="main">]</span> <span class="keyword1">in</span>
  map_prod
    id
    L.flatten
    <span class="main">(</span>L.split
      <span class="main">(</span>L.map
        <span class="main">(</span><span class="main">λ</span> <span class="bound">name</span><span class="main">.</span>
           <span class="keyword1">let</span> <span class="main">(</span><span class="bound">toyi</span><span class="main">,</span> <span class="bound">cpt</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">f_toyi</span></span></span> <span class="bound">name</span> 
             <span class="main">;</span> <span class="bound">n</span> <span class="main">=</span> inst_name <span class="bound">toyi</span>
             <span class="main">;</span> <span class="bound">ty</span> <span class="main">=</span> inst_ty <span class="bound">toyi</span>
             <span class="main">;</span> <span class="bound">f</span> <span class="main">=</span> <span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">@@</span> String.isub <span class="bound">ty</span>
             <span class="main">;</span> <span class="bound">name_pers</span> <span class="main">=</span> print_examp_instance_name <span class="bound">f</span> <span class="bound">n</span> <span class="keyword1">in</span>
           <span class="main">(</span> Term_oid var_oid_uniq <span class="main">(</span>oidGetInh <span class="bound">cpt</span><span class="main">)</span>
           <span class="main">,</span> <span class="main">[</span> <span class="main">(</span> <span class="main">[</span><span class="main">(</span><span class="bound">b</span> <span class="bound">name_pers</span><span class="main">,</span> Typ_base <span class="main">(</span><span class="bound">f</span> datatype_name<span class="main">)</span><span class="main">)</span><span class="main">]</span><span class="main">,</span> None<span class="main">)</span>
             <span class="main">,</span> <span class="main">(</span> <span class="main">[</span><span class="main">(</span><span class="bound">b</span> <span class="bound">n</span><span class="main">,</span> Typ_base <span class="main">(</span>wrap_toyty <span class="bound">ty</span><span class="main">)</span><span class="main">)</span><span class="main">]</span>
               <span class="main">,</span> Some <span class="main">(</span>hol_definition <span class="bound">n</span><span class="main">,</span> Term_rewrite <span class="main">(</span><span class="bound">b</span> <span class="bound">n</span><span class="main">)</span> <span class="inner_cartouche">‹=›</span> <span class="main">(</span>Term_lambda wildcard <span class="main">(</span>Term_some <span class="main">(</span>Term_some <span class="main">(</span><span class="bound">b</span> <span class="bound">name_pers</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">]</span><span class="main">)</span><span class="main">)</span>
        <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">print_examp_def_st_locale_make</span> <span class="free"><span class="bound"><span class="entity">f_name</span></span></span> <span class="free"><span class="bound"><span class="entity">f_toyi</span></span></span> <span class="free"><span class="bound"><span class="entity">f_spec</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span>
 <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">oid</span><span class="main">,</span> <span class="bound">l_fix_assum</span><span class="main">)</span> <span class="main">=</span> print_examp_def_st_locale_aux <span class="free"><span class="bound"><span class="entity">f_toyi</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span>
    <span class="main">;</span> <span class="bound">ty_n</span> <span class="main">=</span> <span class="inner_cartouche">‹nat›</span> <span class="keyword1">in</span>
  <span class="main">⦇</span> HolThyLocale_name <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">f_name</span></span></span>
  <span class="main">,</span> HolThyLocale_header <span class="main">=</span> L.flatten
                            <span class="main">[</span> <span class="main">[</span> <span class="main">(</span> L.map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> Typ_base <span class="bound">ty_n</span><span class="main">)</span><span class="main">)</span> <span class="bound">oid</span>
                                <span class="main">,</span> Some <span class="main">(</span> print_examp_def_st_locale_distinct
                                       <span class="main">,</span> Term_app <span class="inner_cartouche">‹distinct›</span> <span class="main">[</span><span class="keyword1">let</span> <span class="bound">e</span> <span class="main">=</span> Term_list <span class="bound">oid</span> <span class="keyword1">in</span>
                                                                <span class="keyword1">if</span> <span class="bound">oid</span> <span class="main">=</span> <span class="main">[]</span> <span class="keyword1">then</span> Term_annot' <span class="bound">e</span> <span class="main">(</span><span class="bound">ty_n</span> <span class="main">@@</span> <span class="inner_cartouche">‹ list›</span><span class="main">)</span> <span class="keyword1">else</span> <span class="bound">e</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">]</span>
                            <span class="main">,</span> <span class="bound">l_fix_assum</span>
                            <span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f_spec</span></span></span> <span class="main">]</span> <span class="main">⦈</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">print_examp_def_st_locale_name</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="inner_cartouche">‹state_›</span> <span class="main">@@</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">print_examp_def_st_locale</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> ToyDefSt <span class="bound">n</span> <span class="bound">l</span> <span class="main">⇒</span> <span class="main">λ</span><span class="bound">env</span><span class="main">.</span>
 <span class="main">(</span><span class="main">λ</span><span class="bound">d</span><span class="main">.</span> <span class="main">(</span><span class="bound">d</span><span class="main">,</span> <span class="bound">env</span><span class="main">)</span><span class="main">)</span>
  <span class="main">(</span>print_examp_def_st_locale_make
    <span class="main">(</span><span class="inner_cartouche">‹state_›</span> <span class="main">@@</span> <span class="bound">n</span><span class="main">)</span>
    <span class="main">(</span><span class="main">λ</span> ToyDefCoreBinding <span class="bound">name</span> <span class="main">⇒</span> <span class="keyword1">case</span> String.assoc <span class="bound">name</span> <span class="main">(</span>D_input_instance <span class="bound">env</span><span class="main">)</span> <span class="keyword1">of</span> Some <span class="bound">n</span> <span class="main">⇒</span> <span class="bound">n</span><span class="main">)</span>
    <span class="main">[]</span>
    <span class="bound">l</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">print_examp_def_st_mapsto_gen</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span>
  L.map
    <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">cpt</span><span class="main">,</span> <span class="bound">ocore</span><span class="main">)</span><span class="main">.</span>
        <span class="keyword1">let</span> <span class="bound">b</span> <span class="main">=</span> <span class="main">λ</span><span class="bound">s</span><span class="main">.</span> Term_basic <span class="main">[</span><span class="bound">s</span><span class="main">]</span>
          <span class="main">;</span> <span class="main">(</span><span class="bound">toyi</span><span class="main">,</span> <span class="bound">exp</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">case</span> <span class="bound">ocore</span> <span class="keyword1">of</span>
               ToyDefCoreBinding <span class="main">(</span><span class="bound">name</span><span class="main">,</span> <span class="bound">toyi</span><span class="main">)</span> <span class="main">⇒</span>
                 <span class="main">(</span><span class="bound">toyi</span><span class="main">,</span> Some <span class="main">(</span><span class="bound">b</span> <span class="main">(</span>print_examp_instance_name <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">@@</span> String.isub <span class="main">(</span>inst_ty <span class="bound">toyi</span><span class="main">)</span><span class="main">)</span> <span class="bound">name</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">in</span>
        <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="bound">cpt</span><span class="main">,</span> <span class="bound">ocore</span><span class="main">)</span> <span class="bound">toyi</span> <span class="bound">exp</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">print_examp_def_st_mapsto</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span> list_bind id id
 <span class="main">(</span>print_examp_def_st_mapsto_gen
    <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">cpt</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="bound">toyi</span><span class="main">.</span> map_option <span class="main">(</span><span class="main">λ</span><span class="bound">exp</span><span class="main">.</span>
      Term_binop <span class="main">(</span>Term_oid var_oid_uniq <span class="main">(</span>oidGetInh <span class="bound">cpt</span><span class="main">)</span><span class="main">)</span> <span class="inner_cartouche">‹↦›</span> <span class="main">(</span>Term_app <span class="main">(</span>datatype_in <span class="main">@@</span> String.isub <span class="main">(</span>inst_ty <span class="bound">toyi</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="bound">exp</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
    <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">print_examp_def_st2</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> ToyDefSt <span class="bound">name</span> <span class="bound">l</span> <span class="main">⇒</span> <span class="main">λ</span><span class="bound">env</span><span class="main">.</span>
 <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">l_st</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>L.map O'.definition <span class="bound">l</span><span class="main">,</span> <span class="bound">env</span> <span class="main">⦇</span> D_input_state <span class="main">:=</span> <span class="main">(</span>String.to_String<span class="hidden">⇩</span><sub>b</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>e</sub> <span class="bound">name</span><span class="main">,</span> <span class="bound">l_st</span><span class="main">)</span> <span class="main">#</span> D_input_state <span class="bound">env</span> <span class="main">⦈</span><span class="main">)</span><span class="main">)</span>
  <span class="main">(</span><span class="keyword1">let</span> <span class="bound">b</span> <span class="main">=</span> <span class="main">λ</span><span class="bound">s</span><span class="main">.</span> Term_basic <span class="main">[</span><span class="bound">s</span><span class="main">]</span>
     <span class="main">;</span> <span class="bound">l</span> <span class="main">=</span> L.map <span class="main">(</span><span class="main">λ</span> ToyDefCoreBinding <span class="bound">name</span> <span class="main">⇒</span> map_option <span class="main">(</span>Pair <span class="bound">name</span><span class="main">)</span> <span class="main">(</span>String.assoc <span class="bound">name</span> <span class="main">(</span>D_input_instance <span class="bound">env</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="bound">l</span>
     <span class="main">;</span> <span class="main">(</span><span class="bound">rbt</span><span class="main">,</span> <span class="main">(</span><span class="bound">map_self</span><span class="main">,</span> <span class="bound">map_username</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
         <span class="main">(</span>init_map_class 
           <span class="main">(</span><span class="bound">env</span> <span class="main">⦇</span> D_toy_oid_start <span class="main">:=</span> oidReinitInh <span class="main">(</span>D_toy_oid_start <span class="bound">env</span><span class="main">)</span> <span class="main">⦈</span><span class="main">)</span>
           <span class="main">(</span>L.map <span class="main">(</span><span class="main">λ</span> Some <span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">toyi</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">⇒</span> <span class="bound">toyi</span> <span class="main">|</span> None <span class="main">⇒</span> toy_instance_single_empty<span class="main">)</span> <span class="bound">l</span><span class="main">)</span>
          <span class="main">::</span> <span class="main">(</span><span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span> <span class="main">×</span> <span class="main">_</span> <span class="main">×</span> <span class="main">(</span><span class="main">_</span> <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span><span class="main">_</span> <span class="main">⇒</span> <span class="keyword1">nat</span> <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">_</span>
                        <span class="main">⇒</span> <span class="main">(</span>toy_ty_class option <span class="main">×</span> <span class="main">(</span>toy_ty <span class="main">×</span> toy_data_shallow<span class="main">)</span> option<span class="main">)</span> list<span class="main">)</span> option<span class="main">)</span><span class="main">)</span> <span class="main">×</span> <span class="main">_</span> <span class="main">×</span> <span class="main">_</span><span class="main">)</span>
     <span class="main">;</span> <span class="main">(</span><span class="bound">l_st</span><span class="main">,</span> <span class="bound">l_assoc</span><span class="main">)</span> <span class="main">=</span> L.mapM <span class="main">(</span><span class="main">λ</span> <span class="bound">o_n</span> <span class="bound">l_assoc</span><span class="main">.</span>
           <span class="keyword1">case</span> <span class="bound">o_n</span> <span class="keyword1">of</span>
              Some <span class="main">(</span><span class="bound">name</span><span class="main">,</span> <span class="bound">toyi</span><span class="main">,</span> <span class="bound">cpt</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="main">[</span><span class="main">(</span><span class="bound">cpt</span><span class="main">,</span> ToyDefCoreBinding <span class="main">(</span><span class="bound">name</span><span class="main">,</span> <span class="bound">toyi</span><span class="main">)</span><span class="main">)</span><span class="main">]</span><span class="main">,</span> <span class="main">(</span><span class="bound">toyi</span><span class="main">,</span> <span class="bound">cpt</span><span class="main">)</span> <span class="main">#</span> <span class="bound">l_assoc</span><span class="main">)</span>
            <span class="main">|</span> None <span class="main">⇒</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="bound">l_assoc</span><span class="main">)</span><span class="main">)</span> <span class="bound">l</span> <span class="main">[]</span>
     <span class="main">;</span> <span class="bound">l_st</span> <span class="main">=</span> L.unique oidGetInh <span class="main">(</span>L.flatten <span class="bound">l_st</span><span class="main">)</span> <span class="keyword1">in</span>

   <span class="main">(</span> <span class="main">[</span> Definition <span class="main">(</span>Term_rewrite <span class="main">(</span><span class="bound">b</span> <span class="bound">name</span><span class="main">)</span> <span class="inner_cartouche">‹=›</span> <span class="main">(</span>Term_app <span class="inner_cartouche">‹state.make›</span>
        <span class="main">(</span> Term_app <span class="inner_cartouche">‹Map.empty›</span> <span class="main">(</span><span class="keyword1">case</span> print_examp_def_st_mapsto <span class="bound">l_st</span> <span class="keyword1">of</span> None <span class="main">⇒</span> <span class="main">[]</span> <span class="main">|</span> Some <span class="bound">l</span> <span class="main">⇒</span> <span class="bound">l</span><span class="main">)</span>
        <span class="main">#</span> <span class="main">[</span> print_examp_def_st_assoc <span class="main">(</span>snd <span class="keyword1">o</span> <span class="bound">rbt</span><span class="main">)</span> <span class="bound">map_self</span> <span class="bound">map_username</span> <span class="bound">l_assoc</span> <span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">]</span>
   <span class="main">,</span> <span class="bound">l_st</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">print_examp_def_st_perm_name</span> <span class="free"><span class="bound"><span class="entity">name</span></span></span> <span class="main">=</span> S.flatten <span class="main">[</span><span class="inner_cartouche">‹perm_›</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">name</span></span></span><span class="main">]</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">print_examp_def_st_perm</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="main"><span class="bound">_</span></span> <span class="bound">env</span><span class="main">.</span>
 <span class="main">(</span><span class="main">λ</span> <span class="bound">l</span><span class="main">.</span> <span class="main">(</span>L.map O'.lemma <span class="bound">l</span><span class="main">,</span> <span class="bound">env</span><span class="main">)</span><span class="main">)</span>
  <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">name</span><span class="main">,</span> <span class="bound">l_st</span><span class="main">)</span> <span class="main">=</span> map_prod String<span class="hidden">⇩</span><sub>b</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>e</sub>.to_String id <span class="main">(</span>hd <span class="main">(</span>D_input_state <span class="bound">env</span><span class="main">)</span><span class="main">)</span>
     <span class="main">;</span> <span class="bound">expr_app</span> <span class="main">=</span> print_examp_def_st_mapsto <span class="main">(</span>rev <span class="bound">l_st</span><span class="main">)</span>
     <span class="main">;</span> <span class="bound">b</span> <span class="main">=</span> <span class="main">λ</span><span class="bound">s</span><span class="main">.</span> Term_basic <span class="main">[</span><span class="bound">s</span><span class="main">]</span>
     <span class="main">;</span> <span class="bound">d</span> <span class="main">=</span> hol_definition
     <span class="main">;</span> <span class="main">(</span><span class="bound">l_app</span><span class="main">,</span> <span class="bound">l_last</span><span class="main">)</span> <span class="main">=</span>
         <span class="keyword1">case</span> <span class="bound">l_st</span> <span class="keyword1">of</span> <span class="main">[]</span> <span class="main">⇒</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> C.by <span class="main">[</span>M.simp_add <span class="main">[</span><span class="bound">d</span> <span class="bound">name</span><span class="main">]</span><span class="main">]</span><span class="main">)</span>
         <span class="main">|</span> <span class="main">[</span><span class="main"><span class="bound">_</span></span><span class="main">]</span> <span class="main">⇒</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> C.by <span class="main">[</span>M.simp_add <span class="main">[</span><span class="bound">d</span> <span class="bound">name</span><span class="main">]</span><span class="main">]</span><span class="main">)</span>
         <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span>
           <span class="main">(</span> <span class="main">[</span> M.simp_add <span class="main">[</span><span class="bound">d</span> <span class="bound">name</span><span class="main">]</span><span class="main">]</span>
             <span class="main">#</span> L.flatten <span class="main">(</span>L.map <span class="main">(</span><span class="main">λ</span><span class="bound">i_max</span><span class="main">.</span> L.map <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="main">[</span>M.subst_l <span class="main">(</span>L.map String.nat_to_digit10 <span class="main">[</span><span class="bound">i_max</span> <span class="main">-</span> <span class="bound">i</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span>T.thm <span class="inner_cartouche">‹fun_upd_twist›</span><span class="main">)</span><span class="main">,</span> print_examp_def_st_locale_metis<span class="main">]</span><span class="main">)</span> <span class="main">(</span>List.upt <span class="main">0</span> <span class="bound">i_max</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>List.upt <span class="main">1</span> <span class="main">(</span>List.length <span class="bound">l_st</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
           <span class="main">,</span> C.by <span class="main">[</span>M.simp<span class="main">]</span><span class="main">)</span> <span class="keyword1">in</span>
   <span class="keyword1">case</span> <span class="bound">expr_app</span> <span class="keyword1">of</span> None <span class="main">⇒</span> <span class="main">[]</span> <span class="main">|</span> Some <span class="bound">expr_app</span> <span class="main">⇒</span>
   <span class="main">[</span> Lemma
       <span class="main">(</span>print_examp_def_st_perm_name <span class="bound">name</span><span class="main">)</span>
       <span class="main">[</span>Term_rewrite <span class="main">(</span><span class="bound">b</span> <span class="bound">name</span><span class="main">)</span> <span class="inner_cartouche">‹=›</span> <span class="main">(</span>Term_app <span class="inner_cartouche">‹state.make›</span>
          <span class="main">(</span>Term_app <span class="inner_cartouche">‹Map.empty›</span> <span class="bound">expr_app</span> <span class="main">#</span> <span class="main">[</span>Term_app var_assocs <span class="main">[</span><span class="bound">b</span> <span class="bound">name</span><span class="main">]</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">]</span>
       <span class="bound">l_app</span>
       <span class="bound">l_last</span> <span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">merge_unique_gen</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span> List.fold <span class="main">(</span>List.fold <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">x</span> <span class="keyword1">of</span> Some <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span> <span class="main">⇒</span> RBT.insert <span class="bound">x</span> <span class="bound">v</span> <span class="main">|</span> None <span class="main">⇒</span> id<span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> RBT.empty"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">merge_unique</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span> RBT.entries <span class="main">(</span>merge_unique_gen <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">merge_unique'</span> <span class="main">=</span> L.map snd <span class="keyword1">o</span> merge_unique <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> Some <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">o</span> oidGetInh<span class="main">)</span> <span class="bound">a</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">get_state</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> ToyDefPP <span class="main"><span class="bound">_</span></span> <span class="bound">s_pre</span> <span class="bound">s_post</span> <span class="main">⇒</span> <span class="main">λ</span> <span class="bound">env</span><span class="main">.</span> 
  <span class="keyword1">let</span> <span class="bound">get_state</span> <span class="main">=</span> <span class="keyword1">let</span> <span class="bound">l_st</span> <span class="main">=</span> D_input_state <span class="bound">env</span> <span class="keyword1">in</span> <span class="main">λ</span>ToyDefPPCoreBinding <span class="bound">s</span> <span class="main">⇒</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="keyword1">case</span> String.assoc <span class="bound">s</span> <span class="bound">l_st</span> <span class="keyword1">of</span> None <span class="main">⇒</span> <span class="main">[]</span> <span class="main">|</span> Some <span class="bound">l</span> <span class="main">⇒</span> <span class="bound">l</span><span class="main">)</span>
    <span class="main">;</span> <span class="main">(</span><span class="bound">s_pre</span><span class="main">,</span> <span class="bound">l_pre</span><span class="main">)</span> <span class="main">=</span> <span class="bound">get_state</span> <span class="bound">s_pre</span>
    <span class="main">;</span> <span class="main">(</span><span class="bound">s_post</span><span class="main">,</span> <span class="bound">l_post</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">case</span> <span class="bound">s_post</span> <span class="keyword1">of</span> None <span class="main">⇒</span> <span class="main">(</span><span class="bound">s_pre</span><span class="main">,</span> <span class="bound">l_pre</span><span class="main">)</span> <span class="main">|</span> Some <span class="bound">s_post</span> <span class="main">⇒</span> <span class="bound">get_state</span> <span class="bound">s_post</span> <span class="keyword1">in</span>
  <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="bound">s_pre</span><span class="main">,</span> <span class="bound">l_pre</span><span class="main">)</span>
    <span class="main">(</span><span class="bound">s_post</span><span class="main">,</span> <span class="bound">l_post</span><span class="main">)</span>
    <span class="main">(</span><span class="main">(</span><span class="bound">s_pre</span><span class="main">,</span> <span class="bound">l_pre</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">s_pre</span> <span class="main">≜</span> <span class="bound">s_post</span> <span class="keyword1">then</span>
                         <span class="main">[]</span>
                       <span class="keyword1">else</span>
                         <span class="main">[</span> <span class="main">(</span><span class="bound">s_post</span><span class="main">,</span> <span class="bound">l_post</span><span class="main">)</span> <span class="main">]</span><span class="main">)</span><span class="main">)</span>
    <span class="bound">env</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">print_pre_post_locale_aux</span> <span class="free"><span class="bound"><span class="entity">f_toyi</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span>
 <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">oid</span><span class="main">,</span> <span class="bound">l_fix_assum</span><span class="main">)</span> <span class="main">=</span> print_examp_def_st_locale_aux <span class="free"><span class="bound"><span class="entity">f_toyi</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="keyword1">in</span>
  L.flatten <span class="main">[</span><span class="bound">oid</span><span class="main">,</span> L.flatten <span class="main">(</span>L.map <span class="main">(</span>L.map fst <span class="keyword1">o</span> fst<span class="main">)</span> <span class="bound">l_fix_assum</span><span class="main">)</span> <span class="main">]</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">print_pre_post_locale</span> <span class="main">=</span> get_state <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">s_pre</span><span class="main">,</span> <span class="bound">l_pre</span><span class="main">)</span> <span class="main">(</span><span class="bound">s_post</span><span class="main">,</span> <span class="bound">l_post</span><span class="main">)</span> <span class="bound">l_pre_post</span><span class="main">.</span> Pair
 <span class="main">(</span><span class="keyword1">let</span> <span class="bound">f_toyi</span> <span class="main">=</span> <span class="main">λ</span><span class="main">(</span><span class="bound">cpt</span><span class="main">,</span> ToyDefCoreBinding <span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">toyi</span><span class="main">)</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="bound">toyi</span><span class="main">,</span> <span class="bound">cpt</span><span class="main">)</span> <span class="keyword1">in</span>
  print_examp_def_st_locale_make
    <span class="main">(</span><span class="inner_cartouche">‹pre_post_›</span> <span class="main">@@</span> <span class="bound">s_pre</span> <span class="main">@@</span> <span class="inner_cartouche">‹_›</span> <span class="main">@@</span> <span class="bound">s_post</span><span class="main">)</span>
    <span class="bound">f_toyi</span>
    <span class="main">(</span>L.map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">l</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> Some <span class="main">(</span><span class="bound">s</span><span class="main">,</span> Term_app
                                        <span class="main">(</span>print_examp_def_st_locale_name <span class="bound">s</span><span class="main">)</span>
                                        <span class="main">(</span>print_pre_post_locale_aux <span class="bound">f_toyi</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
              <span class="bound">l_pre_post</span><span class="main">)</span>
    <span class="main">(</span>merge_unique' <span class="main">[</span><span class="bound">l_pre</span><span class="main">,</span> <span class="bound">l_post</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">print_pre_post_interp</span> <span class="main">=</span> get_state <span class="main">(</span><span class="main">λ</span> <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">.</span>
 Pair <span class="keyword1">o</span> L.map O'.interpretation <span class="keyword1">o</span> L.map
  <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">l</span><span class="main">)</span><span class="main">.</span>
    <span class="keyword1">let</span> <span class="bound">n</span> <span class="main">=</span> print_examp_def_st_locale_name <span class="bound">s</span> <span class="keyword1">in</span>
    Interpretation <span class="bound">n</span> <span class="bound">n</span> <span class="main">(</span>print_pre_post_locale_aux <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">cpt</span><span class="main">,</span> ToyDefCoreBinding <span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">toyi</span><span class="main">)</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="bound">toyi</span><span class="main">,</span> <span class="bound">cpt</span><span class="main">)</span><span class="main">)</span> <span class="bound">l</span><span class="main">)</span> <span class="main">(</span>C.by <span class="main">[</span>M.rule <span class="main">(</span>T.thm <span class="bound">s</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">print_pre_post_def_state'</span> <span class="main">=</span> get_state <span class="main">(</span><span class="main">λ</span> <span class="bound">pre</span> <span class="bound">post</span> <span class="main"><span class="bound">_</span></span><span class="main">.</span>
 <span class="main">(</span>Pair <span class="keyword1">o</span> L.map O'.definition<span class="main">)</span>
 <span class="main">(</span>L.map
  <span class="main">(</span><span class="keyword1">let</span> <span class="bound">a</span> <span class="main">=</span> <span class="main">λ</span><span class="bound">f</span> <span class="bound">x</span><span class="main">.</span> Term_app <span class="bound">f</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span>
     <span class="main">;</span> <span class="bound">b</span> <span class="main">=</span> <span class="main">λ</span><span class="bound">s</span><span class="main">.</span> Term_basic <span class="main">[</span><span class="bound">s</span><span class="main">]</span>
     <span class="main">;</span> <span class="bound">heap</span> <span class="main">=</span> <span class="inner_cartouche">‹heap›</span> <span class="keyword1">in</span>
   <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span>
    Definition <span class="main">(</span>Term_rewrite <span class="main">(</span><span class="bound">b</span> <span class="main">(</span><span class="bound">heap</span> <span class="main">@@</span> <span class="inner_cartouche">‹_›</span> <span class="main">@@</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span>
                <span class="inner_cartouche">‹=›</span>
                <span class="main">(</span><span class="bound">a</span> <span class="bound">heap</span> <span class="main">(</span><span class="bound">b</span> <span class="main">(</span>print_examp_def_st_locale_name <span class="bound">s</span> <span class="main">@@</span> <span class="inner_cartouche">‹.›</span> <span class="main">@@</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
  <span class="main">[</span> <span class="bound">pre</span><span class="main">,</span> <span class="bound">post</span> <span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Floor1_ctxt">
<div class="head">
<h1>Theory Floor1_ctxt</h1>
</div>
<pre class="source"><span class="comment1">(******************************************************************************
 * HOL-TOY
 *
 * Copyright (c) 2011-2018 Université Paris-Saclay, Univ. Paris-Sud, France
 *               2013-2017 IRT SystemX, France
 *               2011-2015 Achim D. Brucker, Germany
 *               2016-2018 The University of Sheffield, UK
 *               2016-2017 Nanyang Technological University, Singapore
 *               2017-2018 Virginia Tech, USA
 *
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are
 * met:
 *
 *     * Redistributions of source code must retain the above copyright
 *       notice, this list of conditions and the following disclaimer.
 *
 *     * Redistributions in binary form must reproduce the above
 *       copyright notice, this list of conditions and the following
 *       disclaimer in the documentation and/or other materials provided
 *       with the distribution.
 *
 *     * Neither the name of the copyright holders nor the names of its
 *       contributors may be used to endorse or promote products derived
 *       from this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 ******************************************************************************)</span>

<span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹Main Translation for: Context›</span></span>

<span class="keyword1"><span class="command">theory</span></span>  Floor1_ctxt
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Core_init.html">Core_init</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">print_ctxt_const</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">=</span>
 <span class="main">(</span>map_prod <span class="main">(</span>map_prod id <span class="main">(</span>rev <span class="keyword1">o</span> L.map O.type_synonym<span class="main">)</span><span class="main">)</span> <span class="main">(</span>rev <span class="keyword1">o</span> L.map O.consts<span class="main">)</span>
    <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">print_ctxt</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">ctxt</span><span class="main">.</span> bootstrap_floor
  <span class="main">(</span><span class="main">λ</span><span class="bound">l</span> <span class="bound">env</span><span class="main">.</span>
    <span class="keyword1">let</span> <span class="main">(</span><span class="main">(</span><span class="bound">env</span><span class="main">,</span> <span class="bound">l_isab_ty</span><span class="main">)</span><span class="main">,</span> <span class="bound">l_isab</span><span class="main">)</span> <span class="main">=</span> print_ctxt_const <span class="bound">ctxt</span> <span class="bound">env</span> <span class="keyword1">in</span>
    <span class="main">(</span>L.flatten <span class="main">[</span><span class="bound">l_isab_ty</span><span class="main">,</span> <span class="bound">l_isab</span><span class="main">,</span> <span class="bound">l</span><span class="main">]</span><span class="main">,</span> <span class="bound">env</span><span class="main">)</span><span class="main">)</span>
  <span class="main">[</span> META_all_meta_embedding <span class="main">(</span>META_ctxt Floor2
      <span class="main">(</span>map_invariant <span class="main">(</span><span class="main">λ</span>T_inv <span class="bound">b</span> <span class="main">(</span>ToyProp_ctxt <span class="bound">n</span> <span class="bound">p</span><span class="main">)</span> <span class="main">⇒</span>
                       T_inv <span class="bound">b</span> <span class="main">(</span>ToyProp_ctxt <span class="bound">n</span> <span class="main">(</span>T_lambdas <span class="main">(</span>Ctxt_param <span class="bound">ctxt</span> <span class="main">@@@@</span> <span class="main">[</span>var_self<span class="main">]</span><span class="main">)</span> <span class="bound">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
                     <span class="main">(</span>map_pre_post <span class="main">(</span><span class="main">λ</span><span class="bound">pref</span> <span class="bound">ctxt</span><span class="main">.</span> T_lambdas <span class="main">(</span>make_ctxt_free_var <span class="bound">pref</span> <span class="bound">ctxt</span><span class="main">)</span><span class="main">)</span>
                                   <span class="bound">ctxt</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">]</span><span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Core">
<div class="head">
<h1>Theory Core</h1>
</div>
<pre class="source"><span class="comment1">(******************************************************************************
 * Citadelle
 *
 * Copyright (c) 2011-2018 Université Paris-Saclay, Univ. Paris-Sud, France
 *               2013-2017 IRT SystemX, France
 *               2011-2015 Achim D. Brucker, Germany
 *               2016-2018 The University of Sheffield, UK
 *               2016-2017 Nanyang Technological University, Singapore
 *               2017-2018 Virginia Tech, USA
 *
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are
 * met:
 *
 *     * Redistributions of source code must retain the above copyright
 *       notice, this list of conditions and the following disclaimer.
 *
 *     * Redistributions in binary form must reproduce the above
 *       copyright notice, this list of conditions and the following
 *       disclaimer in the documentation and/or other materials provided
 *       with the distribution.
 *
 *     * Neither the name of the copyright holders nor the names of its
 *       contributors may be used to endorse or promote products derived
 *       from this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 ******************************************************************************)</span>

<span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹General Environment for the Translation: Conclusion›</span></span>

<span class="keyword1"><span class="command">theory</span></span>  Core
<span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="Floor1_infra.html">core/Floor1_infra</a>"</span>
        <span class="quoted">"<a href="Floor1_access.html">core/Floor1_access</a>"</span>
        <span class="quoted">"<a href="Floor1_examp.html">core/Floor1_examp</a>"</span>
        <span class="quoted">"<a href="Floor2_examp.html">core/Floor2_examp</a>"</span>
        <span class="quoted">"<a href="Floor1_ctxt.html">core/Floor1_ctxt</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Preliminaries›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> embedding <span class="main">=</span> Embed_theories <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> all_meta list <span class="main">×</span> <span class="tfree">'b</span><span class="main">)</span> list"</span></span>
                            <span class="main">|</span> Embed_locale <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> semi__locale <span class="main">×</span> <span class="tfree">'b</span>"</span></span>
                                           <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> semi__theory list <span class="main">×</span> <span class="tfree">'b</span><span class="main">)</span> list"</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'a</span> embedding' <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> compiler_env_config<span class="main">)</span> embedding"</span></span> <span class="comment1">― ‹polymorphism weakening needed by <span class="antiquoted"><span class="operator">⬚</span><span class="raw_text">‹<span class="keyword1"><span class="command">code_reflect</span></span>›</span></span>›</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">L_fold</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span>
 <span class="main">(</span><span class="main">λ</span> Embed_theories <span class="bound">l</span> <span class="main">⇒</span> List.fold <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">l</span>
  <span class="main">|</span> Embed_locale <span class="bound">loc_data</span> <span class="bound">l</span> <span class="main">⇒</span>
      <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span>
          <span class="keyword1">let</span> <span class="main">(</span><span class="bound">loc_data</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span> <span class="main">=</span> <span class="bound">loc_data</span> <span class="bound">a</span> <span class="bound">b</span>
            <span class="main">;</span> <span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span> <span class="main">=</span> List.fold <span class="main">(</span><span class="main">λ</span><span class="bound">f0</span><span class="main">.</span> <span class="main">λ</span><span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span> <span class="main">⇒</span> <span class="keyword1">let</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span> <span class="main">=</span> <span class="bound">f0</span> <span class="bound">a</span> <span class="bound">b</span> <span class="keyword1">in</span> <span class="main">(</span><span class="bound">x</span> <span class="main">#</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span><span class="main">)</span> <span class="bound">l</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span> <span class="keyword1">in</span>
          <span class="main">(</span><span class="main">[</span>META_semi__theories <span class="main">(</span>Theories_locale <span class="bound">loc_data</span> <span class="main">(</span>rev <span class="bound">l</span><span class="main">)</span><span class="main">)</span><span class="main">]</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Assembling Translations›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">txt</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> start_map'''' O.text <span class="keyword1">o</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span> <span class="bound">design_analysis</span><span class="main">.</span> <span class="main">[</span>Text <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">design_analysis</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">txt'</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> txt <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">txt''</span> <span class="main">=</span> txt' <span class="keyword1">o</span> S.flatten"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">thy_class</span> <span class="main">::</span>
  <span class="comment1">― ‹polymorphism weakening needed by <span class="antiquoted"><span class="operator">⬚</span><span class="raw_text">‹<span class="keyword1"><span class="command">code_reflect</span></span>›</span></span>›</span>
  <span class="quoted"><span class="quoted">"<span class="main">_</span> embedding'"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">‹<span class="free">thy_class</span> <span class="main">=</span>
  Embed_theories
          <span class="main">[</span> txt'' <span class="main">[</span> <span class="inner_cartouche">‹
  For certain concepts like classes and class-types, only a generic
  definition for its resulting semantics can be given. Generic means,
  there is a function outside HOL that ``compiles'' a concrete,
  closed-world class diagram into a ``theory'' of this data model,
  consisting of a bunch of definitions for classes, accessors, method,
  casts, and tests for actual types, as well as proofs for the
  fundamental properties of these operations in this concrete data
  model. ›</span> <span class="main">]</span>
          <span class="main">,</span> txt'' <span class="main">[</span> <span class="inner_cartouche">‹
   Our data universe  consists in the concrete class diagram just of node's,
and implicitly of the class object. Each class implies the existence of a class
type defined for the corresponding object representations as follows: ›</span> <span class="main">]</span>
          <span class="main">,</span> print_infra_datatype_class
          <span class="main">,</span> txt'' <span class="main">[</span> <span class="inner_cartouche">‹
   Now, we construct a concrete ``universe of ToyAny types'' by injection into a
sum type containing the class types. This type of ToyAny will be used as instance
for all respective type-variables. ›</span> <span class="main">]</span>
          <span class="main">,</span> print_infra_datatype_universe
          <span class="main">,</span> txt'' <span class="main">[</span> <span class="inner_cartouche">‹
   Having fixed the object universe, we can introduce type synonyms that exactly correspond
to Toy types. Again, we exploit that our representation of Toy is a ``shallow embedding'' with a
one-to-one correspondance of Toy-types to types of the meta-language HOL. ›</span> <span class="main">]</span>
          <span class="main">,</span> print_infra_type_synonym_class_higher
          <span class="main">,</span> print_access_oid_uniq
          <span class="main">,</span> print_access_choose <span class="main">]</span>›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">thy_enum_flat</span> <span class="main">=</span> Embed_theories <span class="main">[]</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">thy_enum</span> <span class="main">=</span> Embed_theories <span class="main">[]</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">thy_class_synonym</span> <span class="main">=</span> Embed_theories <span class="main">[]</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">thy_class_flat</span> <span class="main">=</span> Embed_theories <span class="main">[]</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">thy_association</span> <span class="main">=</span> Embed_theories <span class="main">[]</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">thy_instance</span> <span class="main">=</span> Embed_theories 
                             <span class="main">[</span> print_examp_instance_defassoc
                             <span class="main">,</span> print_examp_instance <span class="main">]</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">thy_def_base_l</span> <span class="main">=</span> Embed_theories <span class="main">[]</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">thy_def_state</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> Floor1 <span class="main">⇒</span> Embed_theories 
                                           <span class="main">[</span> Floor1_examp.print_examp_def_st1 <span class="main">]</span>
                             <span class="main">|</span> Floor2 <span class="main">⇒</span> Embed_locale
                                           Floor2_examp.print_examp_def_st_locale
                                           <span class="main">[</span> Floor2_examp.print_examp_def_st2
                                           <span class="main">,</span> Floor2_examp.print_examp_def_st_perm <span class="main">]</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">thy_def_pre_post</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> Floor1 <span class="main">⇒</span> Embed_theories 
                                              <span class="main">[</span> Floor1_examp.print_pre_post <span class="main">]</span>
                                <span class="main">|</span> Floor2 <span class="main">⇒</span> Embed_locale
                                              Floor2_examp.print_pre_post_locale
                                              <span class="main">[</span> Floor2_examp.print_pre_post_interp
                                              <span class="main">,</span> Floor2_examp.print_pre_post_def_state' <span class="main">]</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">thy_ctxt</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> Floor1 <span class="main">⇒</span> Embed_theories 
                                      <span class="main">[</span> Floor1_ctxt.print_ctxt <span class="main">]</span>
                        <span class="main">|</span> Floor2 <span class="main">⇒</span> Embed_theories 
                                      <span class="main">[]</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">thy_flush_all</span> <span class="main">=</span> Embed_theories <span class="main">[]</span>"</span></span>
<span class="comment1">(* NOTE typechecking functions can be put at the end, however checking already defined constants can be done earlier *)</span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Combinators Folding the Compiling Environment›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">compiler_env_config_empty</span> <span class="free"><span class="bound"><span class="entity">output_disable_thy</span></span></span> <span class="free"><span class="bound"><span class="entity">output_header_thy</span></span></span> <span class="free"><span class="bound"><span class="entity">oid_start</span></span></span> <span class="free"><span class="bound"><span class="entity">design_analysis</span></span></span> <span class="free"><span class="bound"><span class="entity">sorry_dirty</span></span></span> <span class="main">=</span>
  compiler_env_config.make
    <span class="free"><span class="bound"><span class="entity">output_disable_thy</span></span></span>
    <span class="free"><span class="bound"><span class="entity">output_header_thy</span></span></span>
    <span class="free"><span class="bound"><span class="entity">oid_start</span></span></span>
    <span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span>
    <span class="free"><span class="bound"><span class="entity">design_analysis</span></span></span>
    None <span class="main">[]</span> <span class="main">[]</span> <span class="main">[]</span> False False <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">[]</span>
    <span class="free"><span class="bound"><span class="entity">sorry_dirty</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">compiler_env_config_reset_no_env</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">=</span>
  compiler_env_config_empty
    <span class="main">(</span>D_output_disable_thy <span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">)</span>
    <span class="main">(</span>D_output_header_thy <span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">)</span>
    <span class="main">(</span>oidReinitAll <span class="main">(</span>D_toy_oid_start <span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">)</span><span class="main">)</span>
    <span class="main">(</span>D_toy_semantics <span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">)</span>
    <span class="main">(</span>D_output_sorry_dirty <span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">)</span>
    <span class="main">⦇</span> D_input_meta <span class="main">:=</span> D_input_meta <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">compiler_env_config_reset_all</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">let</span> <span class="bound">env</span> <span class="main">=</span> compiler_env_config_reset_no_env <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="keyword1">in</span>
   <span class="main">(</span> <span class="bound">env</span> <span class="main">⦇</span> D_input_meta <span class="main">:=</span> <span class="main">[]</span> <span class="main">⦈</span>
   <span class="main">,</span> <span class="keyword1">let</span> <span class="main">(</span><span class="bound">l_class</span><span class="main">,</span> <span class="bound">l_env</span><span class="main">)</span> <span class="main">=</span> find_class_ass <span class="bound">env</span> <span class="keyword1">in</span>
     L.flatten
       <span class="main">[</span> <span class="bound">l_class</span>
       <span class="main">,</span> List.filter <span class="main">(</span><span class="main">λ</span> META_flush_all <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> False <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> True<span class="main">)</span> <span class="bound">l_env</span>
       <span class="main">,</span> <span class="main">[</span>META_flush_all ToyFlushAll<span class="main">]</span> <span class="main">]</span> <span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">compiler_env_config_update</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">=</span>
  <span class="comment1">― ‹WARNING The semantics of the meta-embedded language is not intended to be reset here (like <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>oid_start›</span></span>), only syntactic configurations of the compiler (path, etc...)›</span>
  <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">env</span></span></span>
    <span class="main">⦇</span> D_output_disable_thy <span class="main">:=</span> D_output_disable_thy <span class="free"><span class="bound"><span class="entity">env</span></span></span>
    <span class="main">,</span> D_output_header_thy <span class="main">:=</span> D_output_header_thy <span class="free"><span class="bound"><span class="entity">env</span></span></span>
    <span class="main">,</span> D_toy_semantics <span class="main">:=</span> D_toy_semantics <span class="free"><span class="bound"><span class="entity">env</span></span></span>
    <span class="main">,</span> D_output_sorry_dirty <span class="main">:=</span> D_output_sorry_dirty <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">fold_thy0</span> <span class="free"><span class="bound"><span class="entity">meta</span></span></span> <span class="free"><span class="bound"><span class="entity">thy_object0</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span>
  L_fold <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="main">(</span><span class="bound">acc1</span><span class="main">,</span> <span class="bound">acc2</span><span class="main">)</span><span class="main">.</span>
    <span class="keyword1">let</span> <span class="main">(</span><span class="bound">sorry</span><span class="main">,</span> <span class="bound">dirty</span><span class="main">)</span> <span class="main">=</span> D_output_sorry_dirty <span class="bound">acc1</span>
      <span class="main">;</span> <span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">acc1</span><span class="main">)</span> <span class="main">=</span> <span class="bound">x</span> <span class="free"><span class="bound"><span class="entity">meta</span></span></span> <span class="bound">acc1</span> <span class="keyword1">in</span>
    <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">sorry</span> <span class="main">=</span> Some Gen_sorry <span class="main">|</span> <span class="bound">sorry</span> <span class="main">=</span> None <span class="main">&amp;</span> <span class="bound">dirty</span> <span class="keyword1">then</span>
          L.map <span class="main">(</span>map_semi__theory <span class="main">(</span>map_lemma <span class="main">(</span><span class="main">λ</span> Lemma <span class="bound">n</span> <span class="bound">spec</span> <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> Lemma <span class="bound">n</span> <span class="bound">spec</span> <span class="main">[]</span> C.sorry
                                                <span class="main">|</span> Lemma_assumes <span class="bound">n</span> <span class="bound">spec1</span> <span class="bound">spec2</span> <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> Lemma_assumes <span class="bound">n</span> <span class="bound">spec1</span> <span class="bound">spec2</span> <span class="main">[]</span> C.sorry<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="bound">l</span>
        <span class="keyword1">else</span>
          <span class="bound">l</span><span class="main">)</span> <span class="bound">acc1</span> <span class="bound">acc2</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">thy_object0</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">comp_env_input_class_rm</span> <span class="free"><span class="bound"><span class="entity">f_fold</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">env_accu</span></span></span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">env</span><span class="main">,</span> <span class="bound">accu</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">f_fold</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">env_accu</span></span></span> <span class="keyword1">in</span>
   <span class="main">(</span><span class="bound">env</span> <span class="main">⦇</span> D_input_class <span class="main">:=</span> None <span class="main">⦈</span><span class="main">,</span> <span class="bound">accu</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">comp_env_save</span> <span class="free"><span class="bound"><span class="entity">ast</span></span></span> <span class="free"><span class="bound"><span class="entity">f_fold</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">env_accu</span></span></span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">env</span><span class="main">,</span> <span class="bound">accu</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">f_fold</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">env_accu</span></span></span> <span class="keyword1">in</span>
   <span class="main">(</span><span class="bound">env</span> <span class="main">⦇</span> D_input_meta <span class="main">:=</span> <span class="free"><span class="bound"><span class="entity">ast</span></span></span> <span class="main">#</span> D_input_meta <span class="bound">env</span> <span class="main">⦈</span><span class="main">,</span> <span class="bound">accu</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">comp_env_input_class_mk</span> <span class="free"><span class="bound"><span class="entity">f_try</span></span></span> <span class="free"><span class="bound"><span class="entity">f_accu_reset</span></span></span> <span class="free"><span class="bound"><span class="entity">f_fold</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span>
  <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">env</span><span class="main">,</span> <span class="bound">accu</span><span class="main">)</span><span class="main">.</span>
    <span class="free"><span class="bound"><span class="entity">f_fold</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span>
      <span class="main">(</span><span class="keyword1">case</span> D_input_class <span class="bound">env</span> <span class="keyword1">of</span> Some <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="main">(</span><span class="bound">env</span><span class="main">,</span> <span class="bound">accu</span><span class="main">)</span> <span class="main">|</span> None <span class="main">⇒</span>
       <span class="keyword1">let</span> <span class="main">(</span><span class="bound">l_class</span><span class="main">,</span> <span class="bound">l_env</span><span class="main">)</span> <span class="main">=</span> find_class_ass <span class="bound">env</span>
         <span class="main">;</span> <span class="main">(</span><span class="bound">l_enum</span><span class="main">,</span> <span class="bound">l_env</span><span class="main">)</span> <span class="main">=</span> partition <span class="main">(</span><span class="main">λ</span>META_enum <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> True <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> False<span class="main">)</span> <span class="bound">l_env</span> <span class="keyword1">in</span>
       <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f_try</span></span></span> <span class="main">(</span><span class="main">λ</span> <span class="main">()</span> <span class="main">⇒</span>
         <span class="keyword1">let</span> <span class="bound">D_input_meta0</span> <span class="main">=</span> D_input_meta <span class="bound">env</span>
           <span class="main">;</span> <span class="main">(</span><span class="bound">env</span><span class="main">,</span> <span class="bound">accu</span><span class="main">)</span> <span class="main">=</span>
               <span class="keyword1">let</span> <span class="bound">meta</span> <span class="main">=</span> class_unflat <span class="main">(</span>arrange_ass True <span class="main">(</span>D_toy_semantics <span class="bound">env</span> <span class="main">≠</span> Gen_default<span class="main">)</span> <span class="bound">l_class</span> <span class="main">(</span>L.map <span class="main">(</span><span class="main">λ</span> META_enum <span class="bound">e</span> <span class="main">⇒</span> <span class="bound">e</span><span class="main">)</span> <span class="bound">l_enum</span><span class="main">)</span><span class="main">)</span>
                 <span class="main">;</span> <span class="main">(</span><span class="bound">env</span><span class="main">,</span> <span class="bound">accu</span><span class="main">)</span> <span class="main">=</span> List.fold <span class="main">(</span><span class="main">λ</span> <span class="bound">ast</span><span class="main">.</span> comp_env_save <span class="bound">ast</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">ast</span> <span class="keyword1">of</span> META_enum <span class="bound">meta</span> <span class="main">⇒</span> fold_thy0 <span class="bound">meta</span> thy_enum<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span>
                                           <span class="bound">l_enum</span>
                                           <span class="main">(</span><span class="keyword1">let</span> <span class="bound">env</span> <span class="main">=</span> compiler_env_config_reset_no_env <span class="bound">env</span> <span class="keyword1">in</span>
                                            <span class="main">(</span><span class="bound">env</span> <span class="main">⦇</span> D_input_meta <span class="main">:=</span> List.filter <span class="main">(</span><span class="main">λ</span> META_enum <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> False <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> True<span class="main">)</span> <span class="main">(</span>D_input_meta <span class="bound">env</span><span class="main">)</span> <span class="main">⦈</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f_accu_reset</span></span></span> <span class="bound">env</span> <span class="bound">accu</span><span class="main">)</span><span class="main">)</span>
                 <span class="main">;</span> <span class="main">(</span><span class="bound">env</span><span class="main">,</span> <span class="bound">accu</span><span class="main">)</span> <span class="main">=</span> fold_thy0 <span class="bound">meta</span> thy_class <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="bound">env</span><span class="main">,</span> <span class="bound">accu</span><span class="main">)</span> <span class="keyword1">in</span>
               <span class="main">(</span><span class="bound">env</span> <span class="main">⦇</span> D_input_class <span class="main">:=</span> Some <span class="bound">meta</span> <span class="main">⦈</span><span class="main">,</span> <span class="bound">accu</span><span class="main">)</span>
           <span class="main">;</span> <span class="main">(</span><span class="bound">env</span><span class="main">,</span> <span class="bound">accu</span><span class="main">)</span> <span class="main">=</span>
               List.fold
                 <span class="main">(</span><span class="main">λ</span><span class="bound">ast</span><span class="main">.</span> comp_env_save <span class="bound">ast</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">ast</span> <span class="keyword1">of</span>
                     META_instance <span class="bound">meta</span> <span class="main">⇒</span> fold_thy0 <span class="bound">meta</span> thy_instance
                   <span class="main">|</span> META_def_base_l <span class="bound">meta</span> <span class="main">⇒</span> fold_thy0 <span class="bound">meta</span> thy_def_base_l
                   <span class="main">|</span> META_def_state <span class="bound">floor</span> <span class="bound">meta</span> <span class="main">⇒</span> fold_thy0 <span class="bound">meta</span> <span class="main">(</span>thy_def_state <span class="bound">floor</span><span class="main">)</span>
                   <span class="main">|</span> META_def_pre_post <span class="bound">floor</span> <span class="bound">meta</span> <span class="main">⇒</span> fold_thy0 <span class="bound">meta</span> <span class="main">(</span>thy_def_pre_post <span class="bound">floor</span><span class="main">)</span>
                   <span class="main">|</span> META_ctxt <span class="bound">floor</span> <span class="bound">meta</span> <span class="main">⇒</span> fold_thy0 <span class="bound">meta</span> <span class="main">(</span>thy_ctxt <span class="bound">floor</span><span class="main">)</span>
                   <span class="main">|</span> META_flush_all <span class="bound">meta</span> <span class="main">⇒</span> fold_thy0 <span class="bound">meta</span> thy_flush_all<span class="main">)</span>
                        <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span>
                 <span class="bound">l_env</span>
                 <span class="main">(</span><span class="bound">env</span> <span class="main">⦇</span> D_input_meta <span class="main">:=</span> L.flatten <span class="main">[</span><span class="bound">l_class</span><span class="main">,</span> <span class="bound">l_enum</span><span class="main">]</span> <span class="main">⦈</span><span class="main">,</span> <span class="bound">accu</span><span class="main">)</span> <span class="keyword1">in</span>
          <span class="main">(</span><span class="bound">env</span> <span class="main">⦇</span> D_input_meta <span class="main">:=</span> <span class="bound">D_input_meta0</span> <span class="main">⦈</span><span class="main">,</span> <span class="bound">accu</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">comp_env_input_class_bind</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span>
  List.fold <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">fold_thy'</span> <span class="free"><span class="bound"><span class="entity">f_try</span></span></span> <span class="free"><span class="bound"><span class="entity">f_accu_reset</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span>
 <span class="main">(</span><span class="keyword1">let</span> <span class="bound">comp_env_input_class_mk</span> <span class="main">=</span> comp_env_input_class_mk <span class="free"><span class="bound"><span class="entity">f_try</span></span></span> <span class="free"><span class="bound"><span class="entity">f_accu_reset</span></span></span> <span class="keyword1">in</span>
  List.fold <span class="main">(</span><span class="main">λ</span> <span class="bound">ast</span><span class="main">.</span>
    comp_env_save <span class="bound">ast</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">ast</span> <span class="keyword1">of</span>
     META_enum <span class="bound">meta</span> <span class="main">⇒</span> comp_env_input_class_rm <span class="main">(</span>fold_thy0 <span class="bound">meta</span> thy_enum_flat<span class="main">)</span>
   <span class="main">|</span> META_class_raw Floor1 <span class="bound">meta</span> <span class="main">⇒</span> comp_env_input_class_rm <span class="main">(</span>fold_thy0 <span class="bound">meta</span> thy_class_flat<span class="main">)</span>
   <span class="main">|</span> META_association <span class="bound">meta</span> <span class="main">⇒</span> comp_env_input_class_rm <span class="main">(</span>fold_thy0 <span class="bound">meta</span> thy_association<span class="main">)</span>
   <span class="main">|</span> META_ass_class Floor1 <span class="main">(</span>ToyAssClass <span class="bound">meta_ass</span> <span class="bound">meta_class</span><span class="main">)</span> <span class="main">⇒</span>
       comp_env_input_class_rm <span class="main">(</span>comp_env_input_class_bind <span class="main">[</span> fold_thy0 <span class="bound">meta_ass</span> thy_association
                                                      <span class="main">,</span> fold_thy0 <span class="bound">meta_class</span> thy_class_flat <span class="main">]</span><span class="main">)</span>
   <span class="main">|</span> META_class_synonym <span class="bound">meta</span> <span class="main">⇒</span> comp_env_input_class_rm <span class="main">(</span>fold_thy0 <span class="bound">meta</span> thy_class_synonym<span class="main">)</span>
   <span class="main">|</span> META_instance <span class="bound">meta</span> <span class="main">⇒</span> <span class="bound">comp_env_input_class_mk</span> <span class="main">(</span>fold_thy0 <span class="bound">meta</span> thy_instance<span class="main">)</span>
   <span class="main">|</span> META_def_base_l <span class="bound">meta</span> <span class="main">⇒</span> fold_thy0 <span class="bound">meta</span> thy_def_base_l
   <span class="main">|</span> META_def_state <span class="bound">floor</span> <span class="bound">meta</span> <span class="main">⇒</span> <span class="bound">comp_env_input_class_mk</span> <span class="main">(</span>fold_thy0 <span class="bound">meta</span> <span class="main">(</span>thy_def_state <span class="bound">floor</span><span class="main">)</span><span class="main">)</span>
   <span class="main">|</span> META_def_pre_post <span class="bound">floor</span> <span class="bound">meta</span> <span class="main">⇒</span> fold_thy0 <span class="bound">meta</span> <span class="main">(</span>thy_def_pre_post <span class="bound">floor</span><span class="main">)</span>
   <span class="main">|</span> META_ctxt <span class="bound">floor</span> <span class="bound">meta</span> <span class="main">⇒</span> <span class="bound">comp_env_input_class_mk</span> <span class="main">(</span>fold_thy0 <span class="bound">meta</span> <span class="main">(</span>thy_ctxt <span class="bound">floor</span><span class="main">)</span><span class="main">)</span>
   <span class="main">|</span> META_flush_all <span class="bound">meta</span> <span class="main">⇒</span> <span class="bound">comp_env_input_class_mk</span> <span class="main">(</span>fold_thy0 <span class="bound">meta</span> thy_flush_all<span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">fold_thy_shallow</span> <span class="free"><span class="bound"><span class="entity">f_try</span></span></span> <span class="free"><span class="bound"><span class="entity">f_accu_reset</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> 
  fold_thy'
    <span class="free"><span class="bound"><span class="entity">f_try</span></span></span>
    <span class="free"><span class="bound"><span class="entity">f_accu_reset</span></span></span>
    <span class="main">(</span><span class="main">λ</span><span class="bound">l</span> <span class="bound">acc1</span><span class="main">.</span>
      map_prod <span class="main">(</span><span class="main">λ</span> <span class="bound">env</span><span class="main">.</span> <span class="bound">env</span> <span class="main">⦇</span> D_input_meta <span class="main">:=</span> D_input_meta <span class="bound">acc1</span> <span class="main">⦈</span><span class="main">)</span> id
      <span class="keyword1">o</span> List.fold <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="bound">l</span>
      <span class="keyword1">o</span> Pair <span class="bound">acc1</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">fold_thy_deep</span> <span class="free"><span class="bound"><span class="entity">obj</span></span></span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">case</span> fold_thy'
          <span class="main">(</span><span class="main">λ</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="main">()</span><span class="main">)</span>
          <span class="main">(</span><span class="main">λ</span><span class="bound">env</span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> D_output_position <span class="bound">env</span><span class="main">)</span>
          <span class="main">(</span><span class="main">λ</span><span class="bound">l</span> <span class="bound">acc1</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">cpt</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">acc1</span><span class="main">,</span> <span class="main">(</span>Succ <span class="bound">i</span><span class="main">,</span> natural_of_nat <span class="main">(</span>List.length <span class="bound">l</span><span class="main">)</span> <span class="main">+</span> <span class="bound">cpt</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
          <span class="free"><span class="bound"><span class="entity">obj</span></span></span>
          <span class="main">(</span><span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">,</span> D_output_position <span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">)</span> <span class="keyword1">of</span>
    <span class="main">(</span><span class="bound">env</span><span class="main">,</span> <span class="bound">output_position</span><span class="main">)</span> <span class="main">⇒</span> <span class="bound">env</span> <span class="main">⦇</span> D_output_position <span class="main">:=</span> <span class="bound">output_position</span> <span class="main">⦈</span><span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Parser_Toy">
<div class="head">
<h1>Theory Parser_Toy</h1>
</div>
<pre class="source"><span class="comment1">(******************************************************************************
 * HOL-TOY
 *
 * Copyright (c) 2011-2018 Université Paris-Saclay, Univ. Paris-Sud, France
 *               2013-2017 IRT SystemX, France
 *               2011-2015 Achim D. Brucker, Germany
 *               2016-2018 The University of Sheffield, UK
 *               2016-2017 Nanyang Technological University, Singapore
 *               2017-2018 Virginia Tech, USA
 *
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are
 * met:
 *
 *     * Redistributions of source code must retain the above copyright
 *       notice, this list of conditions and the following disclaimer.
 *
 *     * Redistributions in binary form must reproduce the above
 *       copyright notice, this list of conditions and the following
 *       disclaimer in the documentation and/or other materials provided
 *       with the distribution.
 *
 *     * Neither the name of the copyright holders nor the names of its
 *       contributors may be used to endorse or promote products derived
 *       from this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 ******************************************************************************)</span>

<span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹Instantiating the Parser of Toy (I)›</span></span>

<span class="keyword1"><span class="command">theory</span></span>  Parser_Toy
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Meta_Toy.html">Meta_Toy</a>
        <span class="quoted">"<a href="Parser_Pure.html">../../../meta_isabelle/Parser_Pure</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Building Recursors for Records›</span></span> <span class="comment1">(* NOTE part to be automated *)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">toy_multiplicity_rec0</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">toy</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span>
  <span class="main">(</span>TyMult <span class="free"><span class="bound"><span class="entity">toy</span></span></span><span class="main">)</span>
  <span class="main">(</span>TyRole <span class="free"><span class="bound"><span class="entity">toy</span></span></span><span class="main">)</span>
  <span class="main">(</span>TyCollect <span class="free"><span class="bound"><span class="entity">toy</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">toy_multiplicity_rec</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">toy</span></span></span> <span class="main">=</span> toy_multiplicity_rec0 <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">toy</span></span></span>
  <span class="main">(</span>toy_multiplicity.more <span class="free"><span class="bound"><span class="entity">toy</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">toy_ty_class_node_rec0</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">toy</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span>
  <span class="main">(</span>TyObjN_ass_switch <span class="free"><span class="bound"><span class="entity">toy</span></span></span><span class="main">)</span>
  <span class="main">(</span>TyObjN_role_multip <span class="free"><span class="bound"><span class="entity">toy</span></span></span><span class="main">)</span>
  <span class="main">(</span>TyObjN_role_ty <span class="free"><span class="bound"><span class="entity">toy</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">toy_ty_class_node_rec</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">toy</span></span></span> <span class="main">=</span> toy_ty_class_node_rec0 <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">toy</span></span></span>
  <span class="main">(</span>toy_ty_class_node.more <span class="free"><span class="bound"><span class="entity">toy</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">toy_ty_class_rec0</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">toy</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span>
  <span class="main">(</span>TyObj_name <span class="free"><span class="bound"><span class="entity">toy</span></span></span><span class="main">)</span>
  <span class="main">(</span>TyObj_ass_id <span class="free"><span class="bound"><span class="entity">toy</span></span></span><span class="main">)</span>
  <span class="main">(</span>TyObj_ass_arity <span class="free"><span class="bound"><span class="entity">toy</span></span></span><span class="main">)</span>
  <span class="main">(</span>TyObj_from <span class="free"><span class="bound"><span class="entity">toy</span></span></span><span class="main">)</span>
  <span class="main">(</span>TyObj_to <span class="free"><span class="bound"><span class="entity">toy</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">toy_ty_class_rec</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">toy</span></span></span> <span class="main">=</span> toy_ty_class_rec0 <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">toy</span></span></span>
  <span class="main">(</span>toy_ty_class.more <span class="free"><span class="bound"><span class="entity">toy</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">toy_class_raw_rec0</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">toy</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span>
  <span class="main">(</span>ClassRaw_name <span class="free"><span class="bound"><span class="entity">toy</span></span></span><span class="main">)</span>
  <span class="main">(</span>ClassRaw_own <span class="free"><span class="bound"><span class="entity">toy</span></span></span><span class="main">)</span>
  <span class="main">(</span>ClassRaw_clause <span class="free"><span class="bound"><span class="entity">toy</span></span></span><span class="main">)</span>
  <span class="main">(</span>ClassRaw_abstract <span class="free"><span class="bound"><span class="entity">toy</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">toy_class_raw_rec</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">toy</span></span></span> <span class="main">=</span> toy_class_raw_rec0 <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">toy</span></span></span>
  <span class="main">(</span>toy_class_raw.more <span class="free"><span class="bound"><span class="entity">toy</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">toy_association_rec0</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">toy</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span>
  <span class="main">(</span>ToyAss_type <span class="free"><span class="bound"><span class="entity">toy</span></span></span><span class="main">)</span>
  <span class="main">(</span>ToyAss_relation <span class="free"><span class="bound"><span class="entity">toy</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">toy_association_rec</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">toy</span></span></span> <span class="main">=</span> toy_association_rec0 <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">toy</span></span></span>
  <span class="main">(</span>toy_association.more <span class="free"><span class="bound"><span class="entity">toy</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">toy_ctxt_pre_post_rec0</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">toy</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span>
  <span class="main">(</span>Ctxt_fun_name <span class="free"><span class="bound"><span class="entity">toy</span></span></span><span class="main">)</span>
  <span class="main">(</span>Ctxt_fun_ty <span class="free"><span class="bound"><span class="entity">toy</span></span></span><span class="main">)</span>
  <span class="main">(</span>Ctxt_expr <span class="free"><span class="bound"><span class="entity">toy</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">toy_ctxt_pre_post_rec</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">toy</span></span></span> <span class="main">=</span> toy_ctxt_pre_post_rec0 <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">toy</span></span></span>
  <span class="main">(</span>toy_ctxt_pre_post.more <span class="free"><span class="bound"><span class="entity">toy</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">toy_ctxt_rec0</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">toy</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span>
  <span class="main">(</span>Ctxt_param <span class="free"><span class="bound"><span class="entity">toy</span></span></span><span class="main">)</span>
  <span class="main">(</span>Ctxt_ty <span class="free"><span class="bound"><span class="entity">toy</span></span></span><span class="main">)</span>
  <span class="main">(</span>Ctxt_clause <span class="free"><span class="bound"><span class="entity">toy</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">toy_ctxt_rec</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">toy</span></span></span> <span class="main">=</span> toy_ctxt_rec0 <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">toy</span></span></span>
  <span class="main">(</span>toy_ctxt.more <span class="free"><span class="bound"><span class="entity">toy</span></span></span><span class="main">)</span>"</span></span>

<span class="comment1">(* *)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"toy_class_raw.extend <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">toy</span> <span class="bound">v</span><span class="main">.</span> toy_class_raw_rec0 <span class="main">(</span>co4 <span class="main">(</span><span class="main">λ</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="bound">v</span><span class="main">)</span> toy_class_raw_ext<span class="main">)</span> <span class="bound">toy</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">intro</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> toy_class_raw_rec0_def
                        toy_class_raw.extend_def
                        co4_def K_def<span class="main">)</span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"toy_class_raw.make <span class="main">=</span> co4 <span class="main">(</span><span class="main">λ</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="main">()</span><span class="main">)</span> toy_class_raw_ext"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">intro</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> toy_class_raw.make_def
                        co4_def<span class="main">)</span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"toy_class_raw.truncate <span class="main">=</span> toy_class_raw_rec <span class="main">(</span>co4 K toy_class_raw.make<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">intro</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> toy_class_raw_rec0_def
                        toy_class_raw_rec_def
                        toy_class_raw.truncate_def
                        toy_class_raw.make_def
                        co4_def K_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"toy_association.extend <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">toy</span> <span class="bound">v</span><span class="main">.</span> toy_association_rec0 <span class="main">(</span>co2 <span class="main">(</span><span class="main">λ</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="bound">v</span><span class="main">)</span> toy_association_ext<span class="main">)</span> <span class="bound">toy</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">intro</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> toy_association_rec0_def
                        toy_association.extend_def
                        co2_def K_def<span class="main">)</span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"toy_association.make <span class="main">=</span> co2 <span class="main">(</span><span class="main">λ</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="main">()</span><span class="main">)</span> toy_association_ext"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">intro</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> toy_association.make_def
                        co2_def<span class="main">)</span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"toy_association.truncate <span class="main">=</span> toy_association_rec <span class="main">(</span>co2 K toy_association.make<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">intro</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> toy_association_rec0_def
                        toy_association_rec_def
                        toy_association.truncate_def
                        toy_association.make_def
                        co2_def K_def<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Main›</span></span>

<span class="keyword1"><span class="command">context</span></span> Parse
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">of_toy_collection</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">=</span> rec_toy_collection
  <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="inner_cartouche">‹Set›</span><span class="main">)</span>
  <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="inner_cartouche">‹Sequence›</span><span class="main">)</span>
  <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="inner_cartouche">‹Ordered0›</span><span class="main">)</span>
  <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="inner_cartouche">‹Subsets0›</span><span class="main">)</span>
  <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="inner_cartouche">‹Union0›</span><span class="main">)</span>
  <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="inner_cartouche">‹Redefines0›</span><span class="main">)</span>
  <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="inner_cartouche">‹Derived0›</span><span class="main">)</span>
  <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="inner_cartouche">‹Qualifier0›</span><span class="main">)</span>
  <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="inner_cartouche">‹Nonunique0›</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">of_toy_multiplicity_single</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">=</span> rec_toy_multiplicity_single
  <span class="main">(</span>ap1 <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="inner_cartouche">‹Mult_nat›</span><span class="main">)</span> <span class="main">(</span><span class="free">of_nat</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span><span class="main">)</span>
  <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="inner_cartouche">‹Mult_star›</span><span class="main">)</span>
  <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="inner_cartouche">‹Mult_infinity›</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">of_toy_multiplicity</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> toy_multiplicity_rec
  <span class="main">(</span>ap4 <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span><span class="free">ext</span> <span class="inner_cartouche">‹toy_multiplicity_ext›</span><span class="main">)</span><span class="main">)</span>
    <span class="main">(</span>of_list <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span>of_pair <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span>of_toy_multiplicity_single <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">(</span>of_option <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span>of_toy_multiplicity_single <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
    <span class="main">(</span>of_option <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span><span class="free">of_string</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span><span class="main">)</span>
    <span class="main">(</span>of_list <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span>of_toy_collection <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span><span class="main">)</span>
    <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">of_toy_ty_class_node</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> toy_ty_class_node_rec
  <span class="main">(</span>ap4 <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span><span class="free">ext</span> <span class="inner_cartouche">‹toy_ty_class_node_ext›</span><span class="main">)</span><span class="main">)</span>
    <span class="main">(</span><span class="free">of_nat</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span>
    <span class="main">(</span>of_toy_multiplicity <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span>K <span class="free">of_unit</span><span class="main">)</span><span class="main">)</span>
    <span class="main">(</span><span class="free">of_string</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span>
    <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">of_toy_ty_class</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> toy_ty_class_rec
  <span class="main">(</span>ap6 <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span><span class="free">ext</span> <span class="inner_cartouche">‹toy_ty_class_ext›</span><span class="main">)</span><span class="main">)</span>
    <span class="main">(</span><span class="free">of_string</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span>
    <span class="main">(</span><span class="free">of_nat</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span>
    <span class="main">(</span><span class="free">of_nat</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span>
    <span class="main">(</span>of_toy_ty_class_node <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span>K <span class="free">of_unit</span><span class="main">)</span><span class="main">)</span>
    <span class="main">(</span>of_toy_ty_class_node <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span>K <span class="free">of_unit</span><span class="main">)</span><span class="main">)</span>
    <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">of_toy_ty_obj_core</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">=</span> rec_toy_ty_obj_core
  <span class="main">(</span>ap1 <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="inner_cartouche">‹ToyTyCore_pre›</span><span class="main">)</span> <span class="main">(</span><span class="free">of_string</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span><span class="main">)</span>
  <span class="main">(</span>ap1 <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="inner_cartouche">‹ToyTyCore›</span><span class="main">)</span> <span class="main">(</span>of_toy_ty_class <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span>K <span class="free">of_unit</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">of_toy_ty_obj</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">=</span> rec_toy_ty_obj
  <span class="main">(</span>ap2 <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="inner_cartouche">‹ToyTyObj›</span><span class="main">)</span> <span class="main">(</span>of_toy_ty_obj_core <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">(</span>of_list <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span>of_list <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span>of_toy_ty_obj_core <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">of_toy_ty</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">f1</span> <span class="bound">f2</span> <span class="bound">f3</span> <span class="bound">f4</span> <span class="bound">f5</span> <span class="bound">f6</span> <span class="bound">f7</span> <span class="bound">f8</span> <span class="bound">f9</span> <span class="bound">f10</span> <span class="bound">f11</span> <span class="bound">f12</span> <span class="bound">f13</span> <span class="bound">f14</span> <span class="bound">f15</span><span class="main">.</span>
                                    rec_toy_ty <span class="bound">f1</span> <span class="bound">f2</span> <span class="bound">f3</span> <span class="bound">f4</span> <span class="bound">f5</span> <span class="bound">f6</span>
                                               <span class="bound">f7</span> <span class="main">(</span>K <span class="keyword1">o</span> <span class="bound">f8</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="bound">f9</span><span class="main">)</span> <span class="main">(</span><span class="bound">f10</span> <span class="keyword1">o</span> map_prod id snd<span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="bound">f11</span><span class="main">)</span> <span class="bound">f12</span> <span class="bound">f13</span> <span class="bound">f14</span> <span class="bound">f15</span><span class="main">)</span>
  <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="inner_cartouche">‹ToyTy_base_void›</span><span class="main">)</span>
  <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="inner_cartouche">‹ToyTy_base_boolean›</span><span class="main">)</span>
  <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="inner_cartouche">‹ToyTy_base_integer›</span><span class="main">)</span>
  <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="inner_cartouche">‹ToyTy_base_unlimitednatural›</span><span class="main">)</span>
  <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="inner_cartouche">‹ToyTy_base_real›</span><span class="main">)</span>
  <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="inner_cartouche">‹ToyTy_base_string›</span><span class="main">)</span>
  <span class="main">(</span>ap1 <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="inner_cartouche">‹ToyTy_object›</span><span class="main">)</span> <span class="main">(</span>of_toy_ty_obj <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span><span class="main">)</span>
  <span class="main">(</span>ar2 <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="inner_cartouche">‹ToyTy_collection›</span><span class="main">)</span> <span class="main">(</span>of_toy_multiplicity <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span>K <span class="free">of_unit</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
  <span class="main">(</span>ar2 <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="inner_cartouche">‹ToyTy_pair›</span><span class="main">)</span> id<span class="main">)</span>
  <span class="main">(</span>ap1 <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="inner_cartouche">‹ToyTy_binding›</span><span class="main">)</span> <span class="main">(</span>of_pair <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span>of_option <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span><span class="free">of_string</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span><span class="main">)</span> id<span class="main">)</span><span class="main">)</span>
  <span class="main">(</span>ar2 <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="inner_cartouche">‹ToyTy_arrow›</span><span class="main">)</span> id<span class="main">)</span>
  <span class="main">(</span>ap1 <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="inner_cartouche">‹ToyTy_class_syn›</span><span class="main">)</span> <span class="main">(</span><span class="free">of_string</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span><span class="main">)</span>
  <span class="main">(</span>ap1 <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="inner_cartouche">‹ToyTy_enum›</span><span class="main">)</span> <span class="main">(</span><span class="free">of_string</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span><span class="main">)</span>
  <span class="main">(</span>ap1 <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="inner_cartouche">‹ToyTy_raw›</span><span class="main">)</span> <span class="main">(</span><span class="free">of_string</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">of_toy_association_type</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">=</span> rec_toy_association_type
  <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="inner_cartouche">‹ToyAssTy_native_attribute›</span><span class="main">)</span>
  <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="inner_cartouche">‹ToyAssTy_association›</span><span class="main">)</span>
  <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="inner_cartouche">‹ToyAssTy_composition›</span><span class="main">)</span>
  <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="inner_cartouche">‹ToyAssTy_aggregation›</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">of_toy_association_relation</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">=</span> rec_toy_association_relation
  <span class="main">(</span>ap1 <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="inner_cartouche">‹ToyAssRel›</span><span class="main">)</span>
    <span class="main">(</span>of_list <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span>of_pair <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span>of_toy_ty_obj <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">(</span>of_toy_multiplicity <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span>K <span class="free">of_unit</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">of_toy_association</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> toy_association_rec
  <span class="main">(</span>ap3 <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span><span class="free">ext</span> <span class="inner_cartouche">‹toy_association_ext›</span><span class="main">)</span><span class="main">)</span>
    <span class="main">(</span>of_toy_association_type <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span>
    <span class="main">(</span>of_toy_association_relation <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span>
    <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">of_toy_ctxt_prefix</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">=</span> rec_toy_ctxt_prefix
  <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="inner_cartouche">‹ToyCtxtPre›</span><span class="main">)</span>
  <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="inner_cartouche">‹ToyCtxtPost›</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">of_toy_ctxt_term</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">f0</span> <span class="bound">f1</span> <span class="bound">f2</span><span class="main">.</span> rec_toy_ctxt_term <span class="bound">f0</span> <span class="bound">f1</span> <span class="main">(</span>co1 K <span class="bound">f2</span><span class="main">)</span><span class="main">)</span>
  <span class="main">(</span>ap1 <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="inner_cartouche">‹T_pure›</span><span class="main">)</span> <span class="main">(</span>of_pure_term <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span><span class="main">)</span>
  <span class="main">(</span>ap2 <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="inner_cartouche">‹T_to_be_parsed›</span><span class="main">)</span> <span class="main">(</span><span class="free">of_string</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">of_string</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span><span class="main">)</span>
  <span class="main">(</span>ar2 <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="inner_cartouche">‹T_lambda›</span><span class="main">)</span> <span class="main">(</span><span class="free">of_string</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">of_toy_prop</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">=</span> rec_toy_prop
  <span class="main">(</span>ap2 <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="inner_cartouche">‹ToyProp_ctxt›</span><span class="main">)</span> <span class="main">(</span>of_option <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span><span class="free">of_string</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>of_toy_ctxt_term <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">of_toy_ctxt_term_inv</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">=</span> rec_toy_ctxt_term_inv
  <span class="main">(</span>ap2 <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="inner_cartouche">‹T_inv›</span><span class="main">)</span> <span class="main">(</span><span class="free">of_bool</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">(</span>of_toy_prop <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">of_toy_ctxt_term_pp</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">=</span> rec_toy_ctxt_term_pp
  <span class="main">(</span>ap2 <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="inner_cartouche">‹T_pp›</span><span class="main">)</span> <span class="main">(</span>of_toy_ctxt_prefix <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">(</span>of_toy_prop <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span><span class="main">)</span>
  <span class="main">(</span>ap1 <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="inner_cartouche">‹T_invariant›</span><span class="main">)</span> <span class="main">(</span>of_toy_ctxt_term_inv <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">of_toy_ctxt_pre_post</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> toy_ctxt_pre_post_rec
  <span class="main">(</span>ap4 <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span><span class="free">ext</span> <span class="inner_cartouche">‹toy_ctxt_pre_post_ext›</span><span class="main">)</span><span class="main">)</span>
    <span class="main">(</span><span class="free">of_string</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span>
    <span class="main">(</span>of_toy_ty <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span>
    <span class="main">(</span>of_list <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span>of_toy_ctxt_term_pp <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span><span class="main">)</span>
    <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">of_toy_ctxt_clause</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">=</span> rec_toy_ctxt_clause
  <span class="main">(</span>ap1 <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="inner_cartouche">‹Ctxt_pp›</span><span class="main">)</span> <span class="main">(</span>of_toy_ctxt_pre_post <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span>K <span class="free">of_unit</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
  <span class="main">(</span>ap1 <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="inner_cartouche">‹Ctxt_inv›</span><span class="main">)</span> <span class="main">(</span>of_toy_ctxt_term_inv <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">of_toy_ctxt</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> toy_ctxt_rec
  <span class="main">(</span>ap4 <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span><span class="free">ext</span> <span class="inner_cartouche">‹toy_ctxt_ext›</span><span class="main">)</span><span class="main">)</span>
    <span class="main">(</span>of_list <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span><span class="free">of_string</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span><span class="main">)</span>
    <span class="main">(</span>of_toy_ty_obj <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span>
    <span class="main">(</span>of_list <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span>of_toy_ctxt_clause <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span><span class="main">)</span>
    <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">of_toy_class</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">f0</span> <span class="bound">f1</span> <span class="bound">f2</span> <span class="bound">f3</span><span class="main">.</span> rec_toy_class <span class="main">(</span>ap3 <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="bound">f0</span> <span class="bound">f1</span> <span class="bound">f2</span> <span class="bound">f3</span><span class="main">)</span><span class="main">)</span>
  <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="inner_cartouche">‹ToyClass›</span><span class="main">)</span>
    <span class="main">(</span><span class="free">of_string</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span>
    <span class="main">(</span>of_list <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span>of_pair <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span><span class="free">of_string</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">(</span>of_toy_ty <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
    <span class="main">(</span>of_list <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> snd<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">of_toy_class_raw</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> toy_class_raw_rec
  <span class="main">(</span>ap5 <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span><span class="free">ext</span> <span class="inner_cartouche">‹toy_class_raw_ext›</span><span class="main">)</span><span class="main">)</span>
    <span class="main">(</span>of_toy_ty_obj <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span>
    <span class="main">(</span>of_list <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span>of_pair <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span><span class="free">of_string</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">(</span>of_toy_ty <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
    <span class="main">(</span>of_list <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span>of_toy_ctxt_clause <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span><span class="main">)</span>
    <span class="main">(</span><span class="free">of_bool</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span>
    <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">of_toy_ass_class</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">=</span> rec_toy_ass_class
  <span class="main">(</span>ap2 <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="inner_cartouche">‹ToyAssClass›</span><span class="main">)</span>
    <span class="main">(</span>of_toy_association <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span>K <span class="free">of_unit</span><span class="main">)</span><span class="main">)</span>
    <span class="main">(</span>of_toy_class_raw <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span>K <span class="free">of_unit</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">of_toy_class_synonym</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">=</span> rec_toy_class_synonym
  <span class="main">(</span>ap2 <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="inner_cartouche">‹ToyClassSynonym›</span><span class="main">)</span>
    <span class="main">(</span><span class="free">of_string</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span>
    <span class="main">(</span>of_toy_ty <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">of_toy_enum</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">=</span> rec_toy_enum
  <span class="main">(</span>ap2 <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="inner_cartouche">‹ToyEnum›</span><span class="main">)</span>
    <span class="main">(</span><span class="free">of_string</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span>
    <span class="main">(</span>of_list <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span><span class="free">of_string</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">code</span><span class="main">]</span> <span class="main">=</span>
  Parse.of_toy_collection_def
  Parse.of_toy_multiplicity_single_def
  Parse.of_toy_multiplicity_def
  Parse.of_toy_ty_class_node_def
  Parse.of_toy_ty_class_def
  Parse.of_toy_ty_obj_core_def
  Parse.of_toy_ty_obj_def
  Parse.of_toy_ty_def
  Parse.of_toy_association_type_def
  Parse.of_toy_association_relation_def
  Parse.of_toy_association_def
  Parse.of_toy_ctxt_prefix_def
  Parse.of_toy_ctxt_term_def
  Parse.of_toy_prop_def
  Parse.of_toy_ctxt_term_inv_def
  Parse.of_toy_ctxt_term_pp_def
  Parse.of_toy_ctxt_pre_post_def
  Parse.of_toy_ctxt_clause_def
  Parse.of_toy_ctxt_def
  Parse.of_toy_class_def
  Parse.of_toy_class_raw_def
  Parse.of_toy_ass_class_def
  Parse.of_toy_class_synonym_def
  Parse.of_toy_enum_def

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Parser_Toy_extended">
<div class="head">
<h1>Theory Parser_Toy_extended</h1>
</div>
<pre class="source"><span class="comment1">(******************************************************************************
 * HOL-TOY
 *
 * Copyright (c) 2011-2018 Université Paris-Saclay, Univ. Paris-Sud, France
 *               2013-2017 IRT SystemX, France
 *               2011-2015 Achim D. Brucker, Germany
 *               2016-2018 The University of Sheffield, UK
 *               2016-2017 Nanyang Technological University, Singapore
 *               2017-2018 Virginia Tech, USA
 *
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are
 * met:
 *
 *     * Redistributions of source code must retain the above copyright
 *       notice, this list of conditions and the following disclaimer.
 *
 *     * Redistributions in binary form must reproduce the above
 *       copyright notice, this list of conditions and the following
 *       disclaimer in the documentation and/or other materials provided
 *       with the distribution.
 *
 *     * Neither the name of the copyright holders nor the names of its
 *       contributors may be used to endorse or promote products derived
 *       from this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 ******************************************************************************)</span>

<span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹Instantiating the Parser of Toy (II)›</span></span>

<span class="keyword1"><span class="command">theory</span></span>  Parser_Toy_extended
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Meta_Toy_extended.html">Meta_Toy_extended</a>
        <span class="quoted">"<a href="Parser_init.html">../../../meta_isabelle/Parser_init</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Building Recursors for Records›</span></span> <span class="comment1">(* NOTE part to be automated *)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">toy_instance_single_rec0</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">toy</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span>
  <span class="main">(</span>Inst_name <span class="free"><span class="bound"><span class="entity">toy</span></span></span><span class="main">)</span>
  <span class="main">(</span>Inst_ty <span class="free"><span class="bound"><span class="entity">toy</span></span></span><span class="main">)</span>
  <span class="main">(</span>Inst_attr <span class="free"><span class="bound"><span class="entity">toy</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">toy_instance_single_rec</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">toy</span></span></span> <span class="main">=</span> toy_instance_single_rec0 <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">toy</span></span></span>
  <span class="main">(</span>toy_instance_single.more <span class="free"><span class="bound"><span class="entity">toy</span></span></span><span class="main">)</span>"</span></span>

<span class="comment1">(* *)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"toy_instance_single.extend <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">toy</span> <span class="bound">v</span><span class="main">.</span> toy_instance_single_rec0 <span class="main">(</span>co3 <span class="main">(</span><span class="main">λ</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="bound">v</span><span class="main">)</span> toy_instance_single_ext<span class="main">)</span> <span class="bound">toy</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">intro</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> toy_instance_single_rec0_def
                        toy_instance_single.extend_def
                        co3_def K_def<span class="main">)</span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"toy_instance_single.make <span class="main">=</span> co3 <span class="main">(</span><span class="main">λ</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="main">()</span><span class="main">)</span> toy_instance_single_ext"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">intro</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> toy_instance_single.make_def
                        co3_def<span class="main">)</span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"toy_instance_single.truncate <span class="main">=</span> toy_instance_single_rec <span class="main">(</span>co3 K toy_instance_single.make<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">intro</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> toy_instance_single_rec0_def
                        toy_instance_single_rec_def
                        toy_instance_single.truncate_def
                        toy_instance_single.make_def
                        co3_def K_def<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Main›</span></span>

<span class="keyword1"><span class="command">context</span></span> Parse
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">of_internal_oid</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">=</span> rec_internal_oid
  <span class="main">(</span>ap1 <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="inner_cartouche">‹Oid›</span><span class="main">)</span> <span class="main">(</span><span class="free">of_nat</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">of_internal_oids</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">=</span> rec_internal_oids
  <span class="main">(</span>ap3 <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="inner_cartouche">‹Oids›</span><span class="main">)</span>
    <span class="main">(</span><span class="free">of_nat</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span>
    <span class="main">(</span><span class="free">of_nat</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span>
    <span class="main">(</span><span class="free">of_nat</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">of_toy_def_base</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">=</span> rec_toy_def_base
  <span class="main">(</span>ap1 <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="inner_cartouche">‹ToyDefInteger›</span><span class="main">)</span> <span class="main">(</span><span class="free">of_string</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span><span class="main">)</span>
  <span class="main">(</span>ap1 <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="inner_cartouche">‹ToyDefReal›</span><span class="main">)</span> <span class="main">(</span>of_pair <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span><span class="free">of_string</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">of_string</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
  <span class="main">(</span>ap1 <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="inner_cartouche">‹ToyDefString›</span><span class="main">)</span> <span class="main">(</span><span class="free">of_string</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">of_toy_data_shallow</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">=</span> rec_toy_data_shallow
  <span class="main">(</span>ap1 <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="inner_cartouche">‹ShallB_term›</span><span class="main">)</span> <span class="main">(</span>of_toy_def_base <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span><span class="main">)</span>
  <span class="main">(</span>ap1 <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="inner_cartouche">‹ShallB_str›</span><span class="main">)</span> <span class="main">(</span><span class="free">of_string</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span><span class="main">)</span>
  <span class="main">(</span>ap1 <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="inner_cartouche">‹ShallB_self›</span><span class="main">)</span> <span class="main">(</span>of_internal_oid <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span><span class="main">)</span>
  <span class="main">(</span>ap1 <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="inner_cartouche">‹ShallB_list›</span><span class="main">)</span> <span class="main">(</span>of_list <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> snd<span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">of_toy_list_attr</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">f0</span><span class="main">.</span> co4 <span class="main">(</span><span class="main">λ</span><span class="bound">f1</span><span class="main">.</span> rec_toy_list_attr <span class="bound">f0</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span> <span class="main"><span class="bound">_</span></span> <span class="bound">a</span> <span class="bound">rec</span><span class="main">.</span> <span class="bound">f1</span> <span class="bound">s</span> <span class="bound">rec</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>ap3 <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span><span class="main">)</span>
  <span class="main">(</span>ap1 <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="inner_cartouche">‹ToyAttrNoCast›</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span>
  <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="inner_cartouche">‹ToyAttrCast›</span><span class="main">)</span>
    <span class="main">(</span><span class="free">of_string</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span>
    id
    <span class="free"><span class="bound"><span class="entity">f</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">of_toy_instance_single</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> toy_instance_single_rec
  <span class="main">(</span>ap4 <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span><span class="free">ext</span> <span class="inner_cartouche">‹toy_instance_single_ext›</span><span class="main">)</span><span class="main">)</span>
    <span class="main">(</span>of_option <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span><span class="free">of_string</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span><span class="main">)</span>
    <span class="main">(</span>of_option <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span><span class="free">of_string</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span><span class="main">)</span>
    <span class="main">(</span>of_toy_list_attr <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span>of_list <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span>of_pair <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span>of_option <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span>of_pair <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span><span class="free">of_string</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">of_string</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>of_pair <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span><span class="free">of_string</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">(</span>of_toy_data_shallow <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
    <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">of_toy_instance</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">=</span> rec_toy_instance
  <span class="main">(</span>ap1 <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="inner_cartouche">‹ToyInstance›</span><span class="main">)</span>
    <span class="main">(</span>of_list <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span>of_toy_instance_single <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span>K <span class="free">of_unit</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">of_toy_def_base_l</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">=</span> rec_toy_def_base_l
  <span class="main">(</span>ap1 <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="inner_cartouche">‹ToyDefBase›</span><span class="main">)</span> <span class="main">(</span>of_list <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span>of_toy_def_base <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">of_toy_def_state_core</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> rec_toy_def_state_core
  <span class="main">(</span>ap1 <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="inner_cartouche">‹ToyDefCoreAdd›</span><span class="main">)</span> <span class="main">(</span>of_toy_instance_single <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span>K <span class="free">of_unit</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
  <span class="main">(</span>ap1 <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="inner_cartouche">‹ToyDefCoreBinding›</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">of_toy_def_state</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">=</span> rec_toy_def_state
  <span class="main">(</span>ap2 <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="inner_cartouche">‹ToyDefSt›</span><span class="main">)</span> <span class="main">(</span><span class="free">of_string</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">(</span>of_list <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span>of_toy_def_state_core <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span><span class="free">of_string</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">of_toy_def_pp_core</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">=</span> rec_toy_def_pp_core
  <span class="main">(</span>ap1 <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="inner_cartouche">‹ToyDefPPCoreAdd›</span><span class="main">)</span> <span class="main">(</span>of_list <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span>of_toy_def_state_core <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span><span class="free">of_string</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
  <span class="main">(</span>ap1 <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="inner_cartouche">‹ToyDefPPCoreBinding›</span><span class="main">)</span> <span class="main">(</span><span class="free">of_string</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">of_toy_def_pre_post</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">=</span> rec_toy_def_pre_post
  <span class="main">(</span>ap3 <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="inner_cartouche">‹ToyDefPP›</span><span class="main">)</span>
    <span class="main">(</span>of_option <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span><span class="free">of_string</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span><span class="main">)</span>
    <span class="main">(</span>of_toy_def_pp_core <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span>
    <span class="main">(</span>of_option <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span>of_toy_def_pp_core <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">code</span><span class="main">]</span> <span class="main">=</span>
  Parse.of_internal_oid_def
  Parse.of_internal_oids_def
  Parse.of_toy_def_base_def
  Parse.of_toy_data_shallow_def
  Parse.of_toy_list_attr_def
  Parse.of_toy_instance_single_def
  Parse.of_toy_instance_def
  Parse.of_toy_def_base_l_def
  Parse.of_toy_def_state_core_def
  Parse.of_toy_def_state_def
  Parse.of_toy_def_pp_core_def
  Parse.of_toy_def_pre_post_def

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Parser_META">
<div class="head">
<h1>Theory Parser_META</h1>
</div>
<pre class="source"><span class="comment1">(******************************************************************************
 * Citadelle
 *
 * Copyright (c) 2011-2018 Université Paris-Saclay, Univ. Paris-Sud, France
 *               2013-2017 IRT SystemX, France
 *               2011-2015 Achim D. Brucker, Germany
 *               2016-2018 The University of Sheffield, UK
 *               2016-2017 Nanyang Technological University, Singapore
 *               2017-2018 Virginia Tech, USA
 *
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are
 * met:
 *
 *     * Redistributions of source code must retain the above copyright
 *       notice, this list of conditions and the following disclaimer.
 *
 *     * Redistributions in binary form must reproduce the above
 *       copyright notice, this list of conditions and the following
 *       disclaimer in the documentation and/or other materials provided
 *       with the distribution.
 *
 *     * Neither the name of the copyright holders nor the names of its
 *       contributors may be used to endorse or promote products derived
 *       from this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 ******************************************************************************)</span>

<span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹Instantiating the Parser of META›</span></span>

<span class="keyword1"><span class="command">theory</span></span>  Parser_META
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Meta_META.html">Meta_META</a>
        <a href="Parser_Toy.html">Parser_Toy</a>
        <a href="Parser_Toy_extended.html">Parser_Toy_extended</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Building Recursors for Records›</span></span> <span class="comment1">(* NOTE part to be automated *)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">compiler_env_config_rec0</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span>
  <span class="main">(</span>D_output_disable_thy <span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">)</span>
  <span class="main">(</span>D_output_header_thy <span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">)</span>
  <span class="main">(</span>D_toy_oid_start <span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">)</span>
  <span class="main">(</span>D_output_position <span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">)</span>
  <span class="main">(</span>D_toy_semantics <span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">)</span>
  <span class="main">(</span>D_input_class <span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">)</span>
  <span class="main">(</span>D_input_meta <span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">)</span>
  <span class="main">(</span>D_input_instance <span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">)</span>
  <span class="main">(</span>D_input_state <span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">)</span>
  <span class="main">(</span>D_output_header_force <span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">)</span>
  <span class="main">(</span>D_output_auto_bootstrap <span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">)</span>
  <span class="main">(</span>D_toy_accessor <span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">)</span>
  <span class="main">(</span>D_toy_HO_type <span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">)</span>
  <span class="main">(</span>D_output_sorry_dirty <span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">compiler_env_config_rec</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">=</span> compiler_env_config_rec0 <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">env</span></span></span>
  <span class="main">(</span>compiler_env_config.more <span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">)</span>"</span></span>

<span class="comment1">(* *)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"compiler_env_config.extend <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">env</span> <span class="bound">v</span><span class="main">.</span> compiler_env_config_rec0 <span class="main">(</span>co14 <span class="main">(</span><span class="main">λ</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="bound">v</span><span class="main">)</span> compiler_env_config_ext<span class="main">)</span> <span class="bound">env</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">intro</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> compiler_env_config_rec0_def
                        compiler_env_config.extend_def
                        co14_def K_def<span class="main">)</span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"compiler_env_config.make <span class="main">=</span> co14 <span class="main">(</span><span class="main">λ</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="main">()</span><span class="main">)</span> compiler_env_config_ext"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">intro</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> compiler_env_config.make_def
                        co14_def<span class="main">)</span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"compiler_env_config.truncate <span class="main">=</span> compiler_env_config_rec <span class="main">(</span>co14 K compiler_env_config.make<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">intro</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> compiler_env_config_rec0_def
                        compiler_env_config_rec_def
                        compiler_env_config.truncate_def
                        compiler_env_config.make_def
                        co14_def K_def<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Main›</span></span>

<span class="keyword1"><span class="command">context</span></span> Parse
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">of_toy_flush_all</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">=</span> rec_toy_flush_all
  <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="inner_cartouche">‹ToyFlushAll›</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">of_floor</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">=</span> rec_floor
  <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="inner_cartouche">‹Floor1›</span><span class="main">)</span>
  <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="inner_cartouche">‹Floor2›</span><span class="main">)</span>
  <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="inner_cartouche">‹Floor3›</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">of_all_meta_embedding</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">=</span> rec_all_meta_embedding
  <span class="main">(</span>ap1 <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="inner_cartouche">‹META_enum›</span><span class="main">)</span> <span class="main">(</span>of_toy_enum <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span><span class="main">)</span>
  <span class="main">(</span>ap2 <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="inner_cartouche">‹META_class_raw›</span><span class="main">)</span> <span class="main">(</span>of_floor <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">(</span>of_toy_class_raw <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span>K <span class="free">of_unit</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
  <span class="main">(</span>ap1 <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="inner_cartouche">‹META_association›</span><span class="main">)</span> <span class="main">(</span>of_toy_association <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span>K <span class="free">of_unit</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
  <span class="main">(</span>ap2 <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="inner_cartouche">‹META_ass_class›</span><span class="main">)</span> <span class="main">(</span>of_floor <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">(</span>of_toy_ass_class <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span><span class="main">)</span>
  <span class="main">(</span>ap2 <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="inner_cartouche">‹META_ctxt›</span><span class="main">)</span> <span class="main">(</span>of_floor <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">(</span>of_toy_ctxt <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span>K <span class="free">of_unit</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>

  <span class="main">(</span>ap1 <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="inner_cartouche">‹META_class_synonym›</span><span class="main">)</span> <span class="main">(</span>of_toy_class_synonym <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span><span class="main">)</span>
  <span class="main">(</span>ap1 <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="inner_cartouche">‹META_instance›</span><span class="main">)</span> <span class="main">(</span>of_toy_instance <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span><span class="main">)</span>
  <span class="main">(</span>ap1 <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="inner_cartouche">‹META_def_base_l›</span><span class="main">)</span> <span class="main">(</span>of_toy_def_base_l <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span><span class="main">)</span>
  <span class="main">(</span>ap2 <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="inner_cartouche">‹META_def_state›</span><span class="main">)</span> <span class="main">(</span>of_floor <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">(</span>of_toy_def_state <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span><span class="main">)</span>
  <span class="main">(</span>ap2 <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="inner_cartouche">‹META_def_pre_post›</span><span class="main">)</span> <span class="main">(</span>of_floor <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">(</span>of_toy_def_pre_post <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span><span class="main">)</span>
  <span class="main">(</span>ap1 <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="inner_cartouche">‹META_flush_all›</span><span class="main">)</span> <span class="main">(</span>of_toy_flush_all <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">of_generation_semantics_toy</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">=</span> rec_generation_semantics_toy
  <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="inner_cartouche">‹Gen_only_design›</span><span class="main">)</span>
  <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="inner_cartouche">‹Gen_only_analysis›</span><span class="main">)</span>
  <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="inner_cartouche">‹Gen_default›</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">of_generation_lemma_mode</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">=</span> rec_generation_lemma_mode
  <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="inner_cartouche">‹Gen_sorry›</span><span class="main">)</span>
  <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="inner_cartouche">‹Gen_no_dirty›</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">of_compiler_env_config</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> compiler_env_config_rec
  <span class="main">(</span>ap15 <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span><span class="free">ext</span> <span class="inner_cartouche">‹compiler_env_config_ext›</span><span class="main">)</span><span class="main">)</span>
    <span class="main">(</span><span class="free">of_bool</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span>
    <span class="main">(</span>of_option <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span>of_pair <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span><span class="free">of_string</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">(</span>of_pair <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span>of_list <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span><span class="free">of_string</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">of_string</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
    <span class="main">(</span>of_internal_oids <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span>
    <span class="main">(</span>of_pair <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span><span class="free">of_nat</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">of_nat</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span><span class="main">)</span>
    <span class="main">(</span>of_generation_semantics_toy <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span>
    <span class="main">(</span>of_option <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span>of_toy_class <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span><span class="main">)</span>
    <span class="main">(</span>of_list <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span>of_all_meta_embedding <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span><span class="main">)</span>
    <span class="main">(</span>of_list <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span>of_pair <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span><span class="free">of_string<span class="hidden">⇩</span><sub>b</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>e</sub></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">(</span>of_pair <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span>of_toy_instance_single <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span>K <span class="free">of_unit</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>of_internal_oids <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
    <span class="main">(</span>of_list <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span>of_pair <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span><span class="free">of_string<span class="hidden">⇩</span><sub>b</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>e</sub></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">(</span>of_list <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span>of_pair <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span>of_internal_oids <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">(</span>of_toy_def_state_core <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span>of_pair <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span><span class="free">of_string</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">(</span>of_toy_instance_single <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span>  <span class="main">(</span>K <span class="free">of_unit</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
    <span class="main">(</span><span class="free">of_bool</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span>
    <span class="main">(</span><span class="free">of_bool</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span>
    <span class="main">(</span>of_pair <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span>of_list <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span><span class="free">of_string<span class="hidden">⇩</span><sub>b</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>e</sub></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>of_list <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span><span class="free">of_string<span class="hidden">⇩</span><sub>b</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>e</sub></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
    <span class="main">(</span>of_list <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span><span class="free">of_string<span class="hidden">⇩</span><sub>b</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>e</sub></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span><span class="main">)</span>
    <span class="main">(</span>of_pair <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span>of_option <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span>of_generation_lemma_mode <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">of_bool</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span><span class="main">)</span>
    <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">code</span><span class="main">]</span> <span class="main">=</span>
  Parse.of_toy_flush_all_def
  Parse.of_floor_def
  Parse.of_all_meta_embedding_def
  Parse.of_generation_semantics_toy_def
  Parse.of_generation_lemma_mode_def
  Parse.of_compiler_env_config_def

<span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹Finalizing the Parser›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹It should be feasible to invent a meta-command (e.g., <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>datatype'›</span></span></span></span>)
to automatically generate the previous recursors in <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Parse›</span></span></span></span>.

Otherwise as an extra check, one can also overload polymorphic cartouches in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">theory</span></span> <a href="Init.html"></a><a href="Init.html">Isabelle_Meta_Model.Init</a><span class="antiquote"><span class="antiquote">}</span></span></span></span>
to really check that all the given constructor exists at the time of editing
(similarly as writing <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">verbatim</span></span> <span class="raw_text"><span class="raw_text">"@{term ...}"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>,
when it is embedded in a <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">verbatim</span></span> <span class="raw_text"><span class="raw_text">"text"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> command).›</span></span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Isabelle Syntax›</span></span>

<span class="keyword1"><span class="command">locale</span></span> Parse_Isabelle
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">Of_Pair</span> <span class="main">=</span> <span class="inner_cartouche">‹Pair›</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">Of_Nil</span> <span class="main">=</span> <span class="inner_cartouche">‹Nil›</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">Of_Cons</span> <span class="main">=</span> <span class="inner_cartouche">‹Cons›</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">Of_None</span> <span class="main">=</span> <span class="inner_cartouche">‹None›</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">Of_Some</span> <span class="main">=</span> <span class="inner_cartouche">‹Some›</span>"</span></span>

<span class="comment1">― ‹recursor types›</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">of_pair</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">f1</span></span></span> <span class="free"><span class="bound"><span class="entity">f2</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">f</span><span class="main">.</span> <span class="main">λ</span><span class="main">(</span><span class="bound">c</span><span class="main">,</span> <span class="bound">d</span><span class="main">)</span> <span class="main">⇒</span> <span class="bound">f</span> <span class="bound">c</span> <span class="bound">d</span><span class="main">)</span>
  <span class="main">(</span>ap2 <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> Of_Pair<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">f1</span></span></span> <span class="free"><span class="bound"><span class="entity">f2</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">of_list</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">f0</span><span class="main">.</span> rec_list <span class="bound">f0</span> <span class="keyword1">o</span> co1 K<span class="main">)</span>
  <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> Of_Nil<span class="main">)</span>
  <span class="main">(</span>ar2 <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> Of_Cons<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">of_option</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> rec_option
  <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> Of_None<span class="main">)</span>
  <span class="main">(</span>ap1 <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> Of_Some<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span>"</span></span>

<span class="comment1">― ‹ground types›</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">of_unit</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">=</span> case_unit
  <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="inner_cartouche">‹()›</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">of_bool</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">of_bool</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">=</span> case_bool
  <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="inner_cartouche">‹True›</span><span class="main">)</span>
  <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="inner_cartouche">‹False›</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">of_string_gen</span> <span class="free"><span class="bound"><span class="entity">s_flatten</span></span></span> <span class="free"><span class="bound"><span class="entity">s_st0</span></span></span> <span class="free"><span class="bound"><span class="entity">s_st</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> 
  <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">s</span> <span class="main">=</span> textstr_of_str <span class="main">(</span><span class="main">λ</span><span class="bound">c</span><span class="main">.</span> <span class="inner_cartouche">‹(›</span> <span class="main">@@</span> <span class="free"><span class="bound"><span class="entity">s_flatten</span></span></span> <span class="main">@@</span> <span class="inner_cartouche">‹ ›</span> <span class="main">@@</span> <span class="bound">c</span> <span class="main">@@</span> <span class="inner_cartouche">‹)›</span><span class="main">)</span>
                            <span class="main">(</span><span class="main">λ</span><span class="bound">c</span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">s_st0</span></span></span> <span class="main">(</span>S.flatten <span class="main">[</span><span class="inner_cartouche">‹ 0x›</span><span class="main">,</span> String.integer_to_digit16 <span class="bound">c</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>
                            <span class="main">(</span><span class="main">λ</span><span class="bound">c</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">s_st</span></span></span> <span class="main">(</span>S.flatten <span class="main">[</span><span class="inner_cartouche">‹ (›</span><span class="main">,</span> <span class="bound">c</span><span class="main">,</span> <span class="inner_cartouche">‹)›</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>
                            <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">in</span>
     S.flatten <span class="main">[</span> <span class="inner_cartouche">‹(›</span><span class="main">,</span> <span class="bound">s</span><span class="main">,</span> <span class="inner_cartouche">‹)›</span> <span class="main">]</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">of_string</span> <span class="main">=</span> of_string_gen <span class="inner_cartouche">‹Init.S.flatten›</span>
                                          <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> S.flatten <span class="main">[</span><span class="inner_cartouche">‹(Init.ST0›</span><span class="main">,</span> <span class="bound">s</span><span class="main">,</span> <span class="inner_cartouche">‹)›</span><span class="main">]</span><span class="main">)</span>
                                          <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> S.flatten <span class="main">[</span><span class="inner_cartouche">‹(Init.abr_string.SS_base (Init.string<span class="hidden">⇩</span><sub>b</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>e</sub>.ST›</span><span class="main">,</span> <span class="bound">s</span><span class="main">,</span> <span class="inner_cartouche">‹))›</span><span class="main">]</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">of_string<span class="hidden">⇩</span><sub>b</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>e</sub></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> of_string_gen <span class="inner_cartouche">‹Init.String<span class="hidden">⇩</span><sub>b</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>e</sub>.flatten›</span>
                                                   <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> S.flatten <span class="main">[</span><span class="inner_cartouche">‹(Init.ST0_base›</span><span class="main">,</span> <span class="bound">s</span><span class="main">,</span> <span class="inner_cartouche">‹)›</span><span class="main">]</span><span class="main">)</span>
                                                   <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> S.flatten <span class="main">[</span><span class="inner_cartouche">‹(Init.string<span class="hidden">⇩</span><sub>b</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>e</sub>.ST›</span><span class="main">,</span> <span class="bound">s</span><span class="main">,</span> <span class="inner_cartouche">‹)›</span><span class="main">]</span><span class="main">)</span>
                                                   <span class="free"><span class="bound"><span class="entity">a</span></span></span>
                                                   <span class="free"><span class="bound"><span class="entity">b</span></span></span>
                                                   <span class="main">(</span>String<span class="hidden">⇩</span><sub>b</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>e</sub>.to_String <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">of_nat</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">of_nat</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">o</span> String.natural_to_digit10"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> Parse_Isabelle <span class="main">&lt;</span> Parse <span class="quoted"><span class="quoted">"id"</span></span>
                              <span class="quoted">Parse_Isabelle.of_string</span>
                              <span class="quoted">Parse_Isabelle.of_string<span class="hidden">⇩</span><sub>b</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>e</sub></span>
                              <span class="quoted">Parse_Isabelle.of_nat</span>
                              <span class="quoted">Parse_Isabelle.of_unit</span>
                              <span class="quoted">Parse_Isabelle.of_bool</span>
                              <span class="quoted">Parse_Isabelle.Of_Pair</span>
                              <span class="quoted">Parse_Isabelle.Of_Nil</span>
                              <span class="quoted">Parse_Isabelle.Of_Cons</span>
                              <span class="quoted">Parse_Isabelle.Of_None</span>
                              <span class="quoted">Parse_Isabelle.Of_Some</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">context</span></span> Parse_Isabelle <span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">compiler_env_config</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">=</span>
    of_compiler_env_config <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span><span class="main">λ</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">.</span>
      of_pair <span class="bound">a</span> <span class="bound">b</span>
        <span class="main">(</span>of_list <span class="bound">a</span> <span class="bound">b</span> <span class="main">(</span>of_all_meta_embedding <span class="bound">a</span> <span class="bound">b</span><span class="main">)</span><span class="main">)</span>
        <span class="main">(</span>of_option <span class="bound">a</span> <span class="bound">b</span> <span class="main">(</span>of_string <span class="bound">a</span> <span class="bound">b</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">isabelle_of_compiler_env_config</span> <span class="main">=</span> Parse_Isabelle.compiler_env_config"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">code</span><span class="main">]</span> <span class="main">=</span>
  Parse_Isabelle.Of_Pair_def
  Parse_Isabelle.Of_Nil_def
  Parse_Isabelle.Of_Cons_def
  Parse_Isabelle.Of_None_def
  Parse_Isabelle.Of_Some_def
  Parse_Isabelle.of_pair_def
  Parse_Isabelle.of_list_def
  Parse_Isabelle.of_option_def
  Parse_Isabelle.of_unit_def
  Parse_Isabelle.of_bool_def
  Parse_Isabelle.of_string_gen_def
  Parse_Isabelle.of_string_def
  Parse_Isabelle.of_string<span class="hidden">⇩</span><sub>b</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>e</sub>_def
  Parse_Isabelle.of_nat_def

  Parse_Isabelle.compiler_env_config_def

<span class="comment1">(* *)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">isabelle_apply</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span> S.flatten <span class="main">[</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span> S.flatten <span class="main">(</span>L.map <span class="main">(</span><span class="main">λ</span> <span class="bound">s</span><span class="main">.</span> S.flatten <span class="main">[</span><span class="inner_cartouche">‹ (›</span><span class="main">,</span> <span class="bound">s</span><span class="main">,</span> <span class="inner_cartouche">‹)›</span><span class="main">]</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹SML Syntax›</span></span>

<span class="keyword1"><span class="command">locale</span></span> Parse_SML
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">Of_Pair</span> <span class="main">=</span> <span class="inner_cartouche">‹I›</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">Of_Nil</span> <span class="main">=</span> <span class="inner_cartouche">‹nil›</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">Of_Cons</span> <span class="main">=</span> <span class="inner_cartouche">‹uncurry cons›</span>"</span></span> <span class="comment1">(* val cons2 = uncurry cons *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">Of_None</span> <span class="main">=</span> <span class="inner_cartouche">‹NONE›</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">Of_Some</span> <span class="main">=</span> <span class="inner_cartouche">‹SOME›</span>"</span></span>

<span class="comment1">(* *)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">of_pair</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">f1</span></span></span> <span class="free"><span class="bound"><span class="entity">f2</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">f</span><span class="main">.</span> <span class="main">λ</span><span class="main">(</span><span class="bound">c</span><span class="main">,</span> <span class="bound">d</span><span class="main">)</span> <span class="main">⇒</span> <span class="bound">f</span> <span class="bound">c</span> <span class="bound">d</span><span class="main">)</span>
  <span class="main">(</span>ap2 <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> Of_Pair<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">f1</span></span></span> <span class="free"><span class="bound"><span class="entity">f2</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">of_list</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">f0</span><span class="main">.</span> rec_list <span class="bound">f0</span> <span class="keyword1">o</span> co1 K<span class="main">)</span>
  <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> Of_Nil<span class="main">)</span>
  <span class="main">(</span>ar2 <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> Of_Cons<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">of_option</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> rec_option
  <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> Of_None<span class="main">)</span>
  <span class="main">(</span>ap1 <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> Of_Some<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span>"</span></span>

<span class="comment1">(* *)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">of_unit</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">=</span> case_unit
  <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="inner_cartouche">‹()›</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">of_bool</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">of_bool</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">=</span> case_bool
  <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="inner_cartouche">‹true›</span><span class="main">)</span>
  <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="inner_cartouche">‹false›</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">‹<span class="free">sml_escape</span> <span class="main">=</span>
  String.replace_integers <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">=</span> <span class="numeral">0x0A</span> <span class="keyword1">then</span> <span class="inner_cartouche">‹\n›</span>
                               <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">=</span> <span class="numeral">0x05</span> <span class="keyword1">then</span> <span class="inner_cartouche">‹\005›</span>
                               <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">=</span> <span class="numeral">0x06</span> <span class="keyword1">then</span> <span class="inner_cartouche">‹\006›</span>
                               <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">=</span> <span class="numeral">0x7F</span> <span class="keyword1">then</span> <span class="inner_cartouche">‹\127›</span>
                               <span class="keyword1">else</span> <span class="main">°</span><span class="bound">x</span><span class="main">°</span><span class="main">)</span>›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">‹<span class="free">of_string</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">=</span>
 <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span>S.flatten <span class="main">[</span> <span class="inner_cartouche">‹(META.SS_base (META.ST "›</span>
                  <span class="main">,</span> sml_escape <span class="bound">x</span>
                  <span class="main">,</span> <span class="inner_cartouche">‹"))›</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">‹<span class="free">of_string<span class="hidden">⇩</span><sub>b</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>e</sub></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">=</span>
 <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span>S.flatten <span class="main">[</span> <span class="inner_cartouche">‹(META.ST "›</span>
                  <span class="main">,</span> sml_escape <span class="main">(</span>String<span class="hidden">⇩</span><sub>b</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>e</sub>.to_String <span class="bound">x</span><span class="main">)</span>
                  <span class="main">,</span> <span class="inner_cartouche">‹")›</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">of_nat</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">of_nat</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span>S.flatten <span class="main">[</span><span class="inner_cartouche">‹(Code_Numeral.natural_of_integer ›</span><span class="main">,</span> String.natural_to_digit10 <span class="bound">x</span><span class="main">,</span> <span class="inner_cartouche">‹)›</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> Parse_SML <span class="main">&lt;</span> Parse <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">c</span><span class="main">.</span> <span class="keyword1">case</span> String.to_list <span class="bound">c</span> <span class="keyword1">of</span> <span class="bound">x</span> <span class="main">#</span> <span class="bound">xs</span> <span class="main">⇒</span> S.flatten <span class="main">[</span>String.uppercase <span class="main">≪</span><span class="main">[</span><span class="bound">x</span><span class="main">]</span><span class="main">≫</span><span class="main">,</span> <span class="main">≪</span><span class="bound">xs</span><span class="main">≫</span><span class="main">]</span>"</span></span>
                         <span class="quoted">Parse_SML.of_string</span>
                         <span class="quoted">Parse_SML.of_string<span class="hidden">⇩</span><sub>b</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>e</sub></span>
                         <span class="quoted">Parse_SML.of_nat</span>
                         <span class="quoted">Parse_SML.of_unit</span>
                         <span class="quoted">Parse_SML.of_bool</span>
                         <span class="quoted">Parse_SML.Of_Pair</span>
                         <span class="quoted">Parse_SML.Of_Nil</span>
                         <span class="quoted">Parse_SML.Of_Cons</span>
                         <span class="quoted">Parse_SML.Of_None</span>
                         <span class="quoted">Parse_SML.Of_Some</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">context</span></span> Parse_SML <span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">compiler_env_config</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">=</span> of_compiler_env_config <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span><span class="main">λ</span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> of_unit<span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">sml_of_compiler_env_config</span> <span class="main">=</span> Parse_SML.compiler_env_config"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">code</span><span class="main">]</span> <span class="main">=</span>
  Parse_SML.Of_Pair_def
  Parse_SML.Of_Nil_def
  Parse_SML.Of_Cons_def
  Parse_SML.Of_None_def
  Parse_SML.Of_Some_def

  Parse_SML.of_pair_def
  Parse_SML.of_list_def
  Parse_SML.of_option_def
  Parse_SML.of_unit_def
  Parse_SML.of_bool_def
  Parse_SML.of_string_def
  Parse_SML.of_string<span class="hidden">⇩</span><sub>b</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>e</sub>_def
  Parse_SML.of_nat_def

  Parse_SML.sml_escape_def
  Parse_SML.compiler_env_config_def

<span class="comment1">(* *)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">sml_apply</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span> S.flatten <span class="main">[</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span> <span class="inner_cartouche">‹ (›</span><span class="main">,</span> <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="keyword1">of</span> <span class="bound">x</span> <span class="main">#</span> <span class="bound">xs</span> <span class="main">⇒</span> S.flatten <span class="main">[</span><span class="bound">x</span><span class="main">,</span> S.flatten <span class="main">(</span>L.map <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> S.flatten <span class="main">[</span><span class="inner_cartouche">‹, ›</span><span class="main">,</span> <span class="bound">s</span><span class="main">]</span><span class="main">)</span> <span class="bound">xs</span><span class="main">)</span><span class="main">]</span><span class="main">,</span> <span class="inner_cartouche">‹)›</span> <span class="main">]</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Printer_Toy">
<div class="head">
<h1>Theory Printer_Toy</h1>
</div>
<pre class="source"><span class="comment1">(******************************************************************************
 * HOL-TOY
 *
 * Copyright (c) 2011-2018 Université Paris-Saclay, Univ. Paris-Sud, France
 *               2013-2017 IRT SystemX, France
 *               2011-2015 Achim D. Brucker, Germany
 *               2016-2018 The University of Sheffield, UK
 *               2016-2017 Nanyang Technological University, Singapore
 *               2017-2018 Virginia Tech, USA
 *
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are
 * met:
 *
 *     * Redistributions of source code must retain the above copyright
 *       notice, this list of conditions and the following disclaimer.
 *
 *     * Redistributions in binary form must reproduce the above
 *       copyright notice, this list of conditions and the following
 *       disclaimer in the documentation and/or other materials provided
 *       with the distribution.
 *
 *     * Neither the name of the copyright holders nor the names of its
 *       contributors may be used to endorse or promote products derived
 *       from this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 ******************************************************************************)</span>

<span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹Instantiating the Printer for Toy (I)›</span></span>

<span class="keyword1"><span class="command">theory</span></span>  Printer_Toy
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Meta_Toy.html">Meta_Toy</a>
        <span class="quoted">"<a href="Printer_Pure.html">../../../meta_isabelle/Printer_Pure</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">context</span></span> Print
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">declare</span></span><span class="main">[</span><span class="main">[</span><span class="operator">cartouche_type'</span> <span class="main"><span class="main">=</span></span> <span class="quoted">"abr_string"</span><span class="main">]</span><span class="main">]</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">concatWith</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span>
 <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span> <span class="main">[]</span> <span class="keyword1">then</span>
    id
  <span class="keyword1">else</span>
    <span class="keyword1">sprint2</span> <span class="keyword1">STR</span> <span class="inner_quoted">''(%s. (%s))''</span><span class="main">´</span> <span class="main">(</span><span class="free">To_string</span> <span class="main">(</span>String_concatWith <span class="inner_cartouche">‹ ›</span> <span class="main">(</span><span class="inner_cartouche">‹λ›</span> <span class="main">#</span> rev <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">declare</span></span><span class="main">[</span><span class="main">[</span><span class="operator">cartouche_type'</span> <span class="main"><span class="main">=</span></span> <span class="quoted">"fun<span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>f</sub>"</span><span class="main">]</span><span class="main">]</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">of_ctxt2_term_aux</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">of_ctxt2_term_aux</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span>
 <span class="main">(</span><span class="main">λ</span> T_pure <span class="bound">pure</span> <span class="main">⇒</span> concatWith <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">(</span>of_pure_term <span class="main">[]</span> <span class="bound">pure</span><span class="main">)</span>
  <span class="main">|</span> T_to_be_parsed <span class="main"><span class="bound">_</span></span> <span class="bound">s</span> <span class="main">⇒</span> concatWith <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">(</span><span class="free">To_string</span> <span class="bound">s</span><span class="main">)</span>
  <span class="main">|</span> T_lambda <span class="bound">s</span> <span class="bound">c</span> <span class="main">⇒</span> <span class="free">of_ctxt2_term_aux</span> <span class="main">(</span><span class="bound">s</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="bound">c</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">of_ctxt2_term</span> <span class="main">=</span> of_ctxt2_term_aux <span class="main">[]</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">‹<span class="free">of_toy_ctxt</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">floor</span></span></span> <span class="main">::</span> <span class="comment1">― ‹polymorphism weakening needed by <span class="antiquoted"><span class="operator">⬚</span><span class="raw_text">‹<span class="keyword1"><span class="command">code_reflect</span></span>›</span></span>›</span>
                                     String.literal<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ctxt</span></span></span> <span class="main">=</span> 
 <span class="main">(</span><span class="keyword1">let</span> <span class="bound">f_inv</span> <span class="main">=</span> <span class="main">λ</span> T_inv <span class="bound">b</span> <span class="main">(</span>ToyProp_ctxt <span class="bound">n</span> <span class="bound">s</span><span class="main">)</span> <span class="main">⇒</span> <span class="inner_cartouche">‹  %sInv %s : "%s"›</span>
              <span class="main">(</span><span class="keyword1">if</span> <span class="bound">b</span> <span class="keyword1">then</span> <span class="inner_cartouche">‹Existential›</span> <span class="keyword1">else</span> <span class="inner_cartouche">‹›</span><span class="main">)</span>
              <span class="main">(</span><span class="keyword1">case</span> <span class="bound">n</span> <span class="keyword1">of</span> None <span class="main">⇒</span> <span class="inner_cartouche">‹›</span> <span class="main">|</span> Some <span class="bound">s</span> <span class="main">⇒</span> <span class="free">To_string</span> <span class="bound">s</span><span class="main">)</span>
              <span class="main">(</span>of_ctxt2_term <span class="bound">s</span><span class="main">)</span> <span class="keyword1">in</span>
  <span class="inner_cartouche">‹Context%s %s%s %s›</span>
        <span class="free"><span class="bound"><span class="entity">floor</span></span></span>
        <span class="main">(</span><span class="keyword1">case</span> Ctxt_param <span class="free"><span class="bound"><span class="entity">ctxt</span></span></span> <span class="keyword1">of</span>
           <span class="main">[]</span> <span class="main">⇒</span> <span class="inner_cartouche">‹›</span>
         <span class="main">|</span> <span class="bound">l</span> <span class="main">⇒</span> <span class="inner_cartouche">‹%s : ›</span> <span class="main">(</span>String_concat <span class="inner_cartouche">‹, ›</span> <span class="main">(</span>L.map <span class="free">To_string</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
        <span class="main">(</span><span class="free">To_string</span> <span class="main">(</span>ty_obj_to_string <span class="main">(</span>Ctxt_ty <span class="free"><span class="bound"><span class="entity">ctxt</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
        <span class="main">(</span>String_concat <span class="inner_cartouche">‹
›</span> <span class="main">(</span>L.map <span class="main">(</span><span class="main">λ</span> Ctxt_pp <span class="bound">ctxt</span> <span class="main">⇒</span>
                <span class="inner_cartouche">‹:: %s (%s) %s
%s›</span>
        <span class="main">(</span><span class="free">To_string</span> <span class="main">(</span>Ctxt_fun_name <span class="bound">ctxt</span><span class="main">)</span><span class="main">)</span>
        <span class="main">(</span>String_concat <span class="inner_cartouche">‹, ›</span>
          <span class="main">(</span>L.map
            <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">ty</span><span class="main">)</span><span class="main">.</span> <span class="inner_cartouche">‹%s : %s›</span> <span class="main">(</span><span class="free">To_string</span> <span class="bound">s</span><span class="main">)</span> <span class="main">(</span><span class="free">To_string</span> <span class="main">(</span>str_of_ty <span class="bound">ty</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
            <span class="main">(</span>Ctxt_fun_ty_arg <span class="bound">ctxt</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
        <span class="main">(</span><span class="keyword1">case</span> Ctxt_fun_ty_out <span class="bound">ctxt</span> <span class="keyword1">of</span> None <span class="main">⇒</span> <span class="inner_cartouche">‹›</span>
                                    <span class="main">|</span> Some <span class="bound">ty</span> <span class="main">⇒</span> <span class="inner_cartouche">‹: %s›</span> <span class="main">(</span><span class="free">To_string</span> <span class="main">(</span>str_of_ty <span class="bound">ty</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
        <span class="main">(</span>String_concat <span class="inner_cartouche">‹
›</span>
          <span class="main">(</span>L.map
            <span class="main">(</span><span class="main">λ</span> T_pp <span class="bound">pref</span> <span class="main">(</span>ToyProp_ctxt <span class="bound">n</span> <span class="bound">s</span><span class="main">)</span> <span class="main">⇒</span> <span class="inner_cartouche">‹  %s %s: "%s"›</span>
                <span class="main">(</span><span class="keyword1">case</span> <span class="bound">pref</span> <span class="keyword1">of</span> ToyCtxtPre <span class="main">⇒</span> <span class="inner_cartouche">‹Pre›</span>
                            <span class="main">|</span> ToyCtxtPost <span class="main">⇒</span> <span class="inner_cartouche">‹Post›</span><span class="main">)</span>
                <span class="main">(</span><span class="keyword1">case</span> <span class="bound">n</span> <span class="keyword1">of</span> None <span class="main">⇒</span> <span class="inner_cartouche">‹›</span> <span class="main">|</span> Some <span class="bound">s</span> <span class="main">⇒</span> <span class="free">To_string</span> <span class="bound">s</span><span class="main">)</span>
                <span class="main">(</span>of_ctxt2_term <span class="bound">s</span><span class="main">)</span>
             <span class="main">|</span> T_invariant <span class="bound">inva</span> <span class="main">⇒</span> <span class="bound">f_inv</span> <span class="bound">inva</span><span class="main">)</span>
            <span class="main">(</span>Ctxt_expr <span class="bound">ctxt</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
          <span class="main">|</span> Ctxt_inv <span class="bound">inva</span> <span class="main">⇒</span> <span class="bound">f_inv</span> <span class="bound">inva</span><span class="main">)</span>
         <span class="main">(</span>Ctxt_clause <span class="free"><span class="bound"><span class="entity">ctxt</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>›</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">code</span><span class="main">]</span> <span class="main">=</span>
  <span class="comment1">― ‹def›</span>
  Print.concatWith_def
  Print.of_ctxt2_term_def
  Print.of_toy_ctxt_def
  <span class="comment1">― ‹fun›</span>
  Print.of_ctxt2_term_aux.simps

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Printer_Toy_extended">
<div class="head">
<h1>Theory Printer_Toy_extended</h1>
</div>
<pre class="source"><span class="comment1">(******************************************************************************
 * HOL-TOY
 *
 * Copyright (c) 2011-2018 Université Paris-Saclay, Univ. Paris-Sud, France
 *               2013-2017 IRT SystemX, France
 *               2011-2015 Achim D. Brucker, Germany
 *               2016-2018 The University of Sheffield, UK
 *               2016-2017 Nanyang Technological University, Singapore
 *               2017-2018 Virginia Tech, USA
 *
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are
 * met:
 *
 *     * Redistributions of source code must retain the above copyright
 *       notice, this list of conditions and the following disclaimer.
 *
 *     * Redistributions in binary form must reproduce the above
 *       copyright notice, this list of conditions and the following
 *       disclaimer in the documentation and/or other materials provided
 *       with the distribution.
 *
 *     * Neither the name of the copyright holders nor the names of its
 *       contributors may be used to endorse or promote products derived
 *       from this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 ******************************************************************************)</span>

<span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹Instantiating the Printer for Toy (II)›</span></span>

<span class="keyword1"><span class="command">theory</span></span>  Printer_Toy_extended
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Meta_Toy_extended.html">Meta_Toy_extended</a>
        <a href="Printer_Toy.html">Printer_Toy</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">context</span></span> Print
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">To_oid</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span>Oid <span class="bound">n</span> <span class="main">⇒</span> <span class="free">To_nat</span> <span class="bound">n</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">‹<span class="free">of_toy_def_base</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> ToyDefInteger <span class="bound">i</span> <span class="main">⇒</span> <span class="free">To_string</span> <span class="bound">i</span>
                                <span class="main">|</span> ToyDefReal <span class="main">(</span><span class="bound">i1</span><span class="main">,</span> <span class="bound">i2</span><span class="main">)</span> <span class="main">⇒</span> <span class="inner_cartouche">‹%s.%s›</span> <span class="main">(</span><span class="free">To_string</span> <span class="bound">i1</span><span class="main">)</span> <span class="main">(</span><span class="free">To_string</span> <span class="bound">i2</span><span class="main">)</span>
                                <span class="main">|</span> ToyDefString <span class="bound">s</span> <span class="main">⇒</span> <span class="inner_cartouche">‹"%s"›</span> <span class="main">(</span><span class="free">To_string</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span>›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">of_toy_data_shallow</span> <span class="keyword2"><span class="keyword">where</span></span>
   <span class="quoted"><span class="quoted">"<span class="free">of_toy_data_shallow</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> ShallB_term <span class="bound">b</span> <span class="main">⇒</span> of_toy_def_base <span class="bound">b</span>
                             <span class="main">|</span> ShallB_str <span class="bound">s</span> <span class="main">⇒</span> <span class="free">To_string</span> <span class="bound">s</span>
                             <span class="main">|</span> ShallB_self <span class="bound">s</span> <span class="main">⇒</span> <span class="inner_cartouche">‹self %d›</span> <span class="main">(</span>To_oid <span class="bound">s</span><span class="main">)</span>
                             <span class="main">|</span> ShallB_list <span class="bound">l</span> <span class="main">⇒</span> <span class="inner_cartouche">‹[ %s ]›</span> <span class="main">(</span>String_concat <span class="inner_cartouche">‹, ›</span> <span class="main">(</span>List.map <span class="free">of_toy_data_shallow</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">of_toy_list_attr</span> <span class="keyword2"><span class="keyword">where</span></span>
   <span class="quoted"><span class="quoted">"<span class="free">of_toy_list_attr</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> ToyAttrNoCast <span class="bound">x</span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">x</span>
                            <span class="main">|</span> ToyAttrCast <span class="bound">ty</span> <span class="main">(</span>ToyAttrNoCast <span class="bound">x</span><span class="main">)</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="inner_cartouche">‹(%s :: %s)›</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free">To_string</span> <span class="bound">ty</span><span class="main">)</span>
                            <span class="main">|</span> ToyAttrCast <span class="bound">ty</span> <span class="bound">l</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="inner_cartouche">‹%s → toyAsType( %s )›</span> <span class="main">(</span><span class="free">of_toy_list_attr</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">l</span><span class="main">)</span> <span class="main">(</span><span class="free">To_string</span> <span class="bound">ty</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">‹<span class="free">of_toy_instance_single</span> <span class="free"><span class="bound"><span class="entity">toyi</span></span></span> <span class="main">=</span>
 <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">s_left</span><span class="main">,</span> <span class="bound">s_right</span><span class="main">)</span> <span class="main">=</span>
    <span class="keyword1">case</span> Inst_name <span class="free"><span class="bound"><span class="entity">toyi</span></span></span> <span class="keyword1">of</span>
      None <span class="main">⇒</span> <span class="main">(</span><span class="keyword1">case</span> Inst_ty <span class="free"><span class="bound"><span class="entity">toyi</span></span></span> <span class="keyword1">of</span> Some <span class="bound">ty</span> <span class="main">⇒</span> <span class="main">(</span><span class="inner_cartouche">‹(›</span><span class="main">,</span> <span class="inner_cartouche">‹ :: %s)›</span> <span class="main">(</span><span class="free">To_string</span> <span class="bound">ty</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
    <span class="main">|</span> Some <span class="bound">s</span> <span class="main">⇒</span>
        <span class="main">(</span> <span class="inner_cartouche">‹%s%s = ›</span>
            <span class="main">(</span><span class="free">To_string</span> <span class="bound">s</span><span class="main">)</span>
            <span class="main">(</span><span class="keyword1">case</span> Inst_ty <span class="free"><span class="bound"><span class="entity">toyi</span></span></span> <span class="keyword1">of</span> None <span class="main">⇒</span> <span class="inner_cartouche">‹›</span> <span class="main">|</span> Some <span class="bound">ty</span> <span class="main">⇒</span> <span class="inner_cartouche">‹ :: %s›</span> <span class="main">(</span><span class="free">To_string</span> <span class="bound">ty</span><span class="main">)</span><span class="main">)</span>
        <span class="main">,</span> <span class="inner_cartouche">‹›</span><span class="main">)</span> <span class="keyword1">in</span>
  <span class="inner_cartouche">‹%s%s%s›</span>
    <span class="bound">s_left</span>
    <span class="main">(</span>of_toy_list_attr
      <span class="main">(</span><span class="main">λ</span><span class="bound">l</span><span class="main">.</span> <span class="inner_cartouche">‹[ %s ]›</span>
             <span class="main">(</span>String_concat <span class="inner_cartouche">‹, ›</span>
               <span class="main">(</span>L.map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">pre_post</span><span class="main">,</span> <span class="bound">attr</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span><span class="main">.</span>
                            <span class="inner_cartouche">‹%s"%s" = %s›</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">pre_post</span> <span class="keyword1">of</span> None <span class="main">⇒</span> <span class="inner_cartouche">‹›</span>
                                                          <span class="main">|</span> Some <span class="main">(</span><span class="bound">s1</span><span class="main">,</span> <span class="bound">s2</span><span class="main">)</span> <span class="main">⇒</span> <span class="inner_cartouche">‹("%s", "%s") |= ›</span> <span class="main">(</span><span class="free">To_string</span> <span class="bound">s1</span><span class="main">)</span> <span class="main">(</span><span class="free">To_string</span> <span class="bound">s2</span><span class="main">)</span><span class="main">)</span>
                                          <span class="main">(</span><span class="free">To_string</span> <span class="bound">attr</span><span class="main">)</span>
                                          <span class="main">(</span>of_toy_data_shallow <span class="bound">v</span><span class="main">)</span><span class="main">)</span>
                         <span class="bound">l</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
      <span class="main">(</span>Inst_attr <span class="free"><span class="bound"><span class="entity">toyi</span></span></span><span class="main">)</span><span class="main">)</span>
    <span class="bound">s_right</span><span class="main">)</span>›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">of_toy_instance</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> ToyInstance <span class="bound">l</span> <span class="main">⇒</span>
  <span class="inner_cartouche">‹Instance %s›</span> <span class="main">(</span>String_concat <span class="inner_cartouche">‹
     and ›</span> <span class="main">(</span>L.map of_toy_instance_single <span class="bound">l</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">of_toy_def_state_core</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span>
  String_concat <span class="inner_cartouche">‹, ›</span> <span class="main">(</span>L.map <span class="main">(</span><span class="main">λ</span> ToyDefCoreBinding <span class="bound">s</span> <span class="main">⇒</span> <span class="free">To_string</span> <span class="bound">s</span>
                             <span class="main">|</span> ToyDefCoreAdd <span class="bound">toyi</span> <span class="main">⇒</span> of_toy_instance_single <span class="bound">toyi</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">of_toy_def_state</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">floor</span></span></span> <span class="main">::</span> <span class="comment1">― ‹polymorphism weakening needed by <span class="antiquoted"><span class="operator">⬚</span><span class="raw_text">‹<span class="keyword1"><span class="command">code_reflect</span></span>›</span></span>›</span>
                                         String.literal<span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> ToyDefSt <span class="bound">n</span> <span class="bound">l</span> <span class="main">⇒</span> 
  <span class="inner_cartouche">‹State%s %s = [ %s ]›</span>
    <span class="free"><span class="bound"><span class="entity">floor</span></span></span>
    <span class="main">(</span><span class="free">To_string</span> <span class="bound">n</span><span class="main">)</span>
    <span class="main">(</span>of_toy_def_state_core <span class="bound">l</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">of_toy_def_pp_core</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> ToyDefPPCoreBinding <span class="bound">s</span> <span class="main">⇒</span> <span class="free">To_string</span> <span class="bound">s</span>
                                  <span class="main">|</span> ToyDefPPCoreAdd <span class="bound">l</span> <span class="main">⇒</span> <span class="inner_cartouche">‹[ %s ]›</span> <span class="main">(</span>of_toy_def_state_core <span class="bound">l</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">of_toy_def_pre_post</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">floor</span></span></span> <span class="main">::</span> <span class="comment1">― ‹polymorphism weakening needed by <span class="antiquoted"><span class="operator">⬚</span><span class="raw_text">‹<span class="keyword1"><span class="command">code_reflect</span></span>›</span></span>›</span>
                                            String.literal<span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> ToyDefPP <span class="bound">n</span> <span class="bound">s_pre</span> <span class="bound">s_post</span> <span class="main">⇒</span>
  <span class="inner_cartouche">‹PrePost%s %s%s%s›</span>
    <span class="free"><span class="bound"><span class="entity">floor</span></span></span>
    <span class="main">(</span><span class="keyword1">case</span> <span class="bound">n</span> <span class="keyword1">of</span> None <span class="main">⇒</span> <span class="inner_cartouche">‹›</span> <span class="main">|</span> Some <span class="bound">n</span> <span class="main">⇒</span> <span class="inner_cartouche">‹%s = ›</span> <span class="main">(</span><span class="free">To_string</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span>
    <span class="main">(</span>of_toy_def_pp_core <span class="bound">s_pre</span><span class="main">)</span>
    <span class="main">(</span><span class="keyword1">case</span> <span class="bound">s_post</span> <span class="keyword1">of</span> None <span class="main">⇒</span> <span class="inner_cartouche">‹›</span> <span class="main">|</span> Some <span class="bound">s_post</span> <span class="main">⇒</span> <span class="inner_cartouche">‹ %s›</span> <span class="main">(</span>of_toy_def_pp_core <span class="bound">s_post</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">code</span><span class="main">]</span> <span class="main">=</span>
  <span class="comment1">― ‹def›</span>
  Print.To_oid_def
  Print.of_toy_def_base_def
  Print.of_toy_instance_single_def
  Print.of_toy_instance_def
  Print.of_toy_def_state_core_def
  Print.of_toy_def_state_def
  Print.of_toy_def_pp_core_def
  Print.of_toy_def_pre_post_def

  <span class="comment1">― ‹fun›</span>
  Print.of_toy_list_attr.simps
  Print.of_toy_data_shallow.simps

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Printer_META">
<div class="head">
<h1>Theory Printer_META</h1>
</div>
<pre class="source"><span class="comment1">(******************************************************************************
 * Citadelle
 *
 * Copyright (c) 2011-2018 Université Paris-Saclay, Univ. Paris-Sud, France
 *               2013-2017 IRT SystemX, France
 *               2011-2015 Achim D. Brucker, Germany
 *               2016-2018 The University of Sheffield, UK
 *               2016-2017 Nanyang Technological University, Singapore
 *               2017-2018 Virginia Tech, USA
 *
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are
 * met:
 *
 *     * Redistributions of source code must retain the above copyright
 *       notice, this list of conditions and the following disclaimer.
 *
 *     * Redistributions in binary form must reproduce the above
 *       copyright notice, this list of conditions and the following
 *       disclaimer in the documentation and/or other materials provided
 *       with the distribution.
 *
 *     * Neither the name of the copyright holders nor the names of its
 *       contributors may be used to endorse or promote products derived
 *       from this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 ******************************************************************************)</span>

<span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹Instantiating the Printer for META›</span></span>

<span class="keyword1"><span class="command">theory</span></span>  Printer_META
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Parser_META.html">Parser_META</a>
        <span class="quoted">"<a href="Printer_Isabelle.html">../../../meta_isabelle/Printer_Isabelle</a>"</span>
        <a href="Printer_Toy_extended.html">Printer_Toy_extended</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">context</span></span> Print
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">of<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>v</sub>_section</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">=</span>
 <span class="main">(</span><span class="keyword1">if</span> D_output_disable_thy <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="keyword1">then</span>
    <span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="inner_cartouche">‹›</span>
  <span class="keyword1">else</span>
    of_section <span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">of<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>v</sub>_semi__theory</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">=</span>
            <span class="main">(</span><span class="main">λ</span> Theory_section <span class="bound">section_title</span> <span class="main">⇒</span> of<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>v</sub>_section <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="bound">section_title</span>
             <span class="main">|</span> <span class="bound">x</span> <span class="main">⇒</span> of_semi__theory <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="bound">x</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">‹<span class="free">of<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>v</sub>_semi__theories</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">=</span>
 <span class="main">(</span><span class="main">λ</span> Theories_one <span class="bound">t</span> <span class="main">⇒</span> of<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>v</sub>_semi__theory <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="bound">t</span>
  <span class="main">|</span> Theories_locale <span class="bound">data</span> <span class="bound">l</span> <span class="main">⇒</span> 
      <span class="inner_cartouche">‹locale %s =
%s
begin
%s
end›</span>   <span class="main">(</span><span class="free">To_string</span> <span class="main">(</span>HolThyLocale_name <span class="bound">data</span><span class="main">)</span><span class="main">)</span>
        <span class="main">(</span>String_concat_map
           <span class="inner_cartouche">‹
›</span>
           <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">l_fix</span><span class="main">,</span> <span class="bound">o_assum</span><span class="main">)</span><span class="main">.</span>
                <span class="inner_cartouche">‹%s%s›</span> <span class="main">(</span>String_concat_map <span class="inner_cartouche">‹
›</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">e</span><span class="main">,</span> <span class="bound">ty</span><span class="main">)</span><span class="main">.</span> <span class="inner_cartouche">‹fixes "%s" :: "%s"›</span> <span class="main">(</span>of_semi__term <span class="bound">e</span><span class="main">)</span> <span class="main">(</span>of_semi__typ <span class="bound">ty</span><span class="main">)</span><span class="main">)</span> <span class="bound">l_fix</span><span class="main">)</span>
                                <span class="main">(</span><span class="keyword1">case</span> <span class="bound">o_assum</span> <span class="keyword1">of</span> None <span class="main">⇒</span> <span class="inner_cartouche">‹›</span>
                                               <span class="main">|</span> Some <span class="main">(</span><span class="bound">name</span><span class="main">,</span> <span class="bound">e</span><span class="main">)</span> <span class="main">⇒</span> <span class="inner_cartouche">‹
assumes %s: "%s"›</span> <span class="main">(</span><span class="free">To_string</span> <span class="bound">name</span><span class="main">)</span> <span class="main">(</span>of_semi__term <span class="bound">e</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
           <span class="main">(</span>HolThyLocale_header <span class="bound">data</span><span class="main">)</span><span class="main">)</span>
        <span class="main">(</span>String_concat_map <span class="inner_cartouche">‹

›</span> <span class="main">(</span>String_concat_map <span class="inner_cartouche">‹

›</span> <span class="main">(</span>of<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>v</sub>_semi__theory <span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">)</span><span class="main">)</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span>›</span></span>

<span class="comment1">(* *)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">of_floor</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> Floor1 <span class="main">⇒</span> <span class="inner_cartouche">‹›</span> <span class="main">|</span> Floor2 <span class="main">⇒</span> <span class="inner_cartouche">‹[shallow]›</span> <span class="main">|</span> Floor3 <span class="main">⇒</span> <span class="inner_cartouche">‹[shallow_shallow]›</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">of_all_meta_embedding</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">=</span>
 <span class="main">(</span><span class="main">λ</span> META_ctxt <span class="bound">floor</span> <span class="bound">ctxt</span> <span class="main">⇒</span> of_toy_ctxt <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">(</span>of_floor <span class="bound">floor</span><span class="main">)</span> <span class="bound">ctxt</span>
  <span class="main">|</span> META_instance <span class="bound">i</span> <span class="main">⇒</span> of_toy_instance <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="bound">i</span>
  <span class="main">|</span> META_def_state <span class="bound">floor</span> <span class="bound">s</span> <span class="main">⇒</span> of_toy_def_state <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">(</span>of_floor <span class="bound">floor</span><span class="main">)</span> <span class="bound">s</span>
  <span class="main">|</span> META_def_pre_post <span class="bound">floor</span> <span class="bound">p</span> <span class="main">⇒</span> of_toy_def_pre_post <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">(</span>of_floor <span class="bound">floor</span><span class="main">)</span> <span class="bound">p</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">of_boot_generation_syntax</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> Boot_generation_syntax <span class="bound">mode</span> <span class="main">⇒</span>
  <span class="inner_cartouche">‹generation_syntax [ shallow%s ]›</span>
    <span class="main">(</span><span class="keyword1">let</span> <span class="bound">f</span> <span class="main">=</span> <span class="inner_cartouche">‹ (generation_semantics [ %s ])›</span> <span class="keyword1">in</span>
     <span class="keyword1">case</span> <span class="bound">mode</span> <span class="keyword1">of</span> Gen_only_design <span class="main">⇒</span> <span class="bound">f</span> <span class="inner_cartouche">‹design›</span>
                <span class="main">|</span> Gen_only_analysis <span class="main">⇒</span> <span class="bound">f</span> <span class="inner_cartouche">‹analysis›</span>
                <span class="main">|</span> Gen_default <span class="main">⇒</span> <span class="inner_cartouche">‹›</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">declare</span></span><span class="main">[</span><span class="main">[</span><span class="operator">cartouche_type'</span> <span class="main"><span class="main">=</span></span> <span class="quoted">"abr_string"</span><span class="main">]</span><span class="main">]</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">of_boot_setup_env</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> Boot_setup_env <span class="bound">e</span> <span class="main">⇒</span>
  of_setup
    <span class="free"><span class="bound"><span class="entity">env</span></span></span>
    <span class="main">(</span>Setup
      <span class="main">(</span>SML.app
        <span class="inner_cartouche">‹Generation_mode.update_compiler_config›</span>
        <span class="main">[</span> SML.app
            <span class="inner_cartouche">‹K›</span>
            <span class="main">[</span> SML_let_open
                <span class="inner_cartouche">‹META›</span>
                <span class="main">(</span><span class="comment1">― ‹Instead of using›</span>
                 <span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>sml_of_compiler_env_config SML_apply (λx. SML_basic [x]) e›</span></span>›</span>
                 <span class="comment1">― ‹the following allows to 'automatically' return an uncurried expression:›</span>
                 SML_basic <span class="main">[</span>sml_of_compiler_env_config sml_apply id <span class="bound">e</span><span class="main">]</span><span class="main">)</span><span class="main">]</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">declare</span></span><span class="main">[</span><span class="main">[</span><span class="operator">cartouche_type'</span> <span class="main"><span class="main">=</span></span> <span class="quoted">"fun<span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>f</sub>"</span><span class="main">]</span><span class="main">]</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">of_all_meta</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span>
    META_semi__theories <span class="bound">thy</span> <span class="main">⇒</span> of<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>v</sub>_semi__theories <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="bound">thy</span>
  <span class="main">|</span> META_boot_generation_syntax <span class="bound">generation_syntax</span> <span class="main">⇒</span> of_boot_generation_syntax <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="bound">generation_syntax</span>
  <span class="main">|</span> META_boot_setup_env <span class="bound">setup_env</span> <span class="main">⇒</span> of_boot_setup_env <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="bound">setup_env</span>
  <span class="main">|</span> META_all_meta_embedding <span class="bound">all_meta_embedding</span> <span class="main">⇒</span> of_all_meta_embedding <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="bound">all_meta_embedding</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">of_all_meta_lists</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="free"><span class="bound"><span class="entity">l_thy</span></span></span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">th_beg</span><span class="main">,</span> <span class="bound">th_end</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">case</span> D_output_header_thy <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="keyword1">of</span> None <span class="main">⇒</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span>
   <span class="main">|</span> Some <span class="main">(</span><span class="bound">name</span><span class="main">,</span> <span class="bound">fic_import</span><span class="main">,</span> <span class="bound">fic_import_boot</span><span class="main">)</span> <span class="main">⇒</span>
       <span class="main">(</span> <span class="main">[</span> <span class="inner_cartouche">‹theory %s imports %s begin›</span>
             <span class="main">(</span><span class="free">To_string</span> <span class="bound">name</span><span class="main">)</span>
             <span class="main">(</span>of_semi__term <span class="main">(</span>term_binop <span class="main">⟨</span><span class="keyword1">STR</span> <span class="inner_quoted">'' ''</span><span class="main">⟩</span>
                                        <span class="main">(</span>L.map Term_string
                                               <span class="main">(</span><span class="bound">fic_import</span> <span class="main">@@@@</span> <span class="main">(</span><span class="keyword1">if</span> D_output_header_force <span class="free"><span class="bound"><span class="entity">env</span></span></span>
                                                                  <span class="main">|</span> D_output_auto_bootstrap <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="keyword1">then</span>
                                                                   <span class="main">[</span><span class="bound">fic_import_boot</span><span class="main">]</span>
                                                                 <span class="keyword1">else</span>
                                                                   <span class="main">[]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">]</span>
       <span class="main">,</span> <span class="main">[</span> <span class="inner_cartouche">‹›</span><span class="main">,</span> <span class="inner_cartouche">‹end›</span> <span class="main">]</span><span class="main">)</span> <span class="keyword1">in</span>
  L.flatten
        <span class="main">[</span> <span class="bound">th_beg</span>
        <span class="main">,</span> L.flatten <span class="main">(</span>fst <span class="main">(</span>L.mapM <span class="main">(</span><span class="main">λ</span><span class="bound">l</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">cpt</span><span class="main">)</span><span class="main">.</span>
            <span class="keyword1">let</span> <span class="main">(</span><span class="bound">l_thy</span><span class="main">,</span> <span class="bound">lg</span><span class="main">)</span> <span class="main">=</span> L.mapM <span class="main">(</span><span class="main">λ</span><span class="bound">l</span> <span class="bound">n</span><span class="main">.</span> <span class="main">(</span>of_all_meta <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="bound">l</span><span class="main">,</span> Succ <span class="bound">n</span><span class="main">)</span><span class="main">)</span> <span class="bound">l</span> <span class="main">0</span> <span class="keyword1">in</span>
            <span class="main">(</span><span class="main">(</span> <span class="inner_cartouche">‹›</span>
             <span class="main">#</span> <span class="inner_cartouche">‹%s(* %d ************************************ %d + %d *)›</span>
                 <span class="main">(</span><span class="free">To_string</span> <span class="main">(</span><span class="keyword1">if</span> compiler_env_config.more <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="keyword1">then</span> <span class="main">⟨</span><span class="keyword1">STR</span> <span class="inner_quoted">''''</span><span class="main">⟩</span> <span class="keyword1">else</span> <span class="main">°</span>integer_escape<span class="main">°</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">To_nat</span> <span class="main">(</span>Succ <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">To_nat</span> <span class="bound">cpt</span><span class="main">)</span> <span class="main">(</span><span class="free">To_nat</span> <span class="bound">lg</span><span class="main">)</span>
             <span class="main">#</span> <span class="bound">l_thy</span><span class="main">)</span><span class="main">,</span> Succ <span class="bound">i</span><span class="main">,</span> <span class="bound">cpt</span> <span class="main">+</span> <span class="bound">lg</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">l_thy</span></span></span> <span class="main">(</span>D_output_position <span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
        <span class="main">,</span> <span class="bound">th_end</span> <span class="main">]</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">code</span><span class="main">]</span> <span class="main">=</span>
  <span class="comment1">― ‹def›</span>
  Print.of<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>v</sub>_section_def
  Print.of<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>v</sub>_semi__theory_def
  Print.of<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>v</sub>_semi__theories_def
  Print.of_floor_def
  Print.of_all_meta_embedding_def
  Print.of_boot_generation_syntax_def
  Print.of_boot_setup_env_def
  Print.of_all_meta_def
  Print.of_all_meta_lists_def

  <span class="comment1">― ‹fun›</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Printer">
<div class="head">
<h1>Theory Printer</h1>
</div>
<pre class="source"><span class="comment1">(******************************************************************************
 * Citadelle
 *
 * Copyright (c) 2011-2018 Université Paris-Saclay, Univ. Paris-Sud, France
 *               2013-2017 IRT SystemX, France
 *               2011-2015 Achim D. Brucker, Germany
 *               2016-2018 The University of Sheffield, UK
 *               2016-2017 Nanyang Technological University, Singapore
 *               2017-2018 Virginia Tech, USA
 *
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are
 * met:
 *
 *     * Redistributions of source code must retain the above copyright
 *       notice, this list of conditions and the following disclaimer.
 *
 *     * Redistributions in binary form must reproduce the above
 *       copyright notice, this list of conditions and the following
 *       disclaimer in the documentation and/or other materials provided
 *       with the distribution.
 *
 *     * Neither the name of the copyright holders nor the names of its
 *       contributors may be used to endorse or promote products derived
 *       from this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 ******************************************************************************)</span>

<span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹Finalizing the Printer›</span></span>

<span class="keyword1"><span class="command">theory</span></span>  Printer
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Core.html">Core</a>
        <span class="quoted">"<a href="Printer_META.html">meta_toy/Printer_META</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">List_iterM</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span>
  List.fold <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">m</span><span class="main">.</span> bind <span class="bound">m</span> <span class="main">(</span><span class="main">λ</span> <span class="main">()</span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">(</span>return <span class="main">()</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">context</span></span> Print
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">declare</span></span><span class="main">[</span><span class="main">[</span><span class="operator">cartouche_type'</span> <span class="main"><span class="main">=</span></span> <span class="quoted">"String.literal"</span><span class="main">]</span><span class="main">]</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">write_file</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">=</span> <span class="main">(</span>
  <span class="keyword1">let</span> <span class="main">(</span><span class="bound">l_thy</span><span class="main">,</span> <span class="bound">Sys_argv</span><span class="main">)</span> <span class="main">=</span> compiler_env_config.more <span class="free"><span class="bound"><span class="entity">env</span></span></span>
    <span class="main">;</span> <span class="main">(</span><span class="bound">is_file</span><span class="main">,</span> <span class="bound">f_output</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">case</span> <span class="main">(</span>D_output_header_thy <span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">,</span> <span class="bound">Sys_argv</span><span class="main">)</span>
     <span class="keyword1">of</span> <span class="main">(</span>Some <span class="main">(</span><span class="bound">file_out</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">,</span> Some <span class="bound">dir</span><span class="main">)</span> <span class="main">⇒</span>
          <span class="keyword1">let</span> <span class="bound">dir</span> <span class="main">=</span> <span class="free">To_string</span> <span class="bound">dir</span> <span class="keyword1">in</span>
          <span class="main">(</span>True<span class="main">,</span> <span class="main">λ</span><span class="bound">f</span><span class="main">.</span> bind <span class="main">(</span>Sys_is_directory2 <span class="bound">dir</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">Sys_is_directory2_dir</span><span class="main">.</span>
                     out_file1 <span class="bound">f</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">Sys_is_directory2_dir</span> <span class="keyword1">then</span> <span class="keyword1">sprint2</span> <span class="inner_cartouche">‹%s/%s.thy›</span><span class="main">´</span> <span class="bound">dir</span> <span class="main">(</span><span class="free">To_string</span> <span class="bound">file_out</span><span class="main">)</span> <span class="keyword1">else</span> <span class="bound">dir</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
      <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="main">(</span>False<span class="main">,</span> out_stand1<span class="main">)</span> <span class="keyword1">in</span>
  <span class="bound">f_output</span>
    <span class="main">(</span><span class="main">λ</span><span class="bound">fprintf1</span><span class="main">.</span>
      List_iterM <span class="main">(</span><span class="bound">fprintf1</span> <span class="inner_cartouche">‹%s
›</span>                             <span class="main">)</span>
        <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">env</span><span class="main">,</span> <span class="bound">l</span><span class="main">)</span> <span class="main">=</span>
           fold_thy'
             <span class="main">(</span><span class="main">λ</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="main">()</span><span class="main">)</span>
             <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">[]</span><span class="main">)</span>
             <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">acc1</span> <span class="bound">acc2</span><span class="main">.</span> <span class="main">(</span><span class="bound">acc1</span><span class="main">,</span> Cons <span class="bound">x</span> <span class="bound">acc2</span><span class="main">)</span><span class="main">)</span>
             <span class="bound">l_thy</span>
             <span class="main">(</span>compiler_env_config.truncate <span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="keyword1">in</span>
         of_all_meta_lists <span class="main">(</span>compiler_env_config_more_map <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="bound">is_file</span><span class="main">)</span> <span class="bound">env</span><span class="main">)</span> <span class="main">(</span>rev <span class="bound">l</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">write_file</span> <span class="main">=</span> Print.write_file String.meta_of_logic <span class="main">(</span>ToNat integer_of_natural<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">code</span><span class="main">]</span> <span class="main">=</span>
  <span class="comment1">― ‹def›</span>
  Print.write_file_def

  <span class="comment1">― ‹fun›</span>

<span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹Miscellaneous: Garbage Collection of Notations›</span></span>

<span class="keyword1"><span class="command">no_type_notation</span></span> natural <span class="main">(</span><span class="quoted">"<span class="keyword1">nat</span>"</span><span class="main">)</span>
<span class="keyword1"><span class="command">no_type_notation</span></span> abr_string <span class="main">(</span><span class="quoted">"<span class="keyword1">string</span>"</span><span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Generator_static">
<div class="head">
<h1>Theory Generator_static</h1>
</div>
<pre class="source"><span class="comment1">(******************************************************************************
 * Citadelle
 *
 * Copyright (c) 2011-2018 Université Paris-Saclay, Univ. Paris-Sud, France
 *               2013-2017 IRT SystemX, France
 *               2011-2015 Achim D. Brucker, Germany
 *               2016-2018 The University of Sheffield, UK
 *               2016-2017 Nanyang Technological University, Singapore
 *               2017-2018 Virginia Tech, USA
 *
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are
 * met:
 *
 *     * Redistributions of source code must retain the above copyright
 *       notice, this list of conditions and the following disclaimer.
 *
 *     * Redistributions in binary form must reproduce the above
 *       copyright notice, this list of conditions and the following
 *       disclaimer in the documentation and/or other materials provided
 *       with the distribution.
 *
 *     * Neither the name of the copyright holders nor the names of its
 *       contributors may be used to endorse or promote products derived
 *       from this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 ******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹We present two solutions for obtaining an Isabelle file.›</span></span>

<span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹Static Meta Embedding with Exportation›</span></span>

<span class="keyword1"><span class="command">theory</span></span>  Generator_static
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Printer.html">Printer</a> <span class="quoted">"<a href="Antiquote_Setup.html">../../Antiquote_Setup</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">declare</span></span><span class="main">[</span><span class="main">[</span><span class="operator">cartouche_type'</span> <span class="main"><span class="main">=</span></span> <span class="quoted">"abr_string"</span><span class="main">]</span><span class="main">]</span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹In the ``static'' solution: the user manually generates
the Isabelle file after writing by hand a Toy input to translate.
The input is not written with the syntax of the Toy Language,
but with raw Isabelle constructors.›</span></span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Giving an Input to Translate›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">Design</span> <span class="main">=</span>
 <span class="main">(</span><span class="keyword1">let</span> <span class="bound">n</span> <span class="main">=</span> <span class="main">λ</span><span class="bound">n1</span> <span class="bound">n2</span><span class="main">.</span> ToyTyObj <span class="main">(</span>ToyTyCore_pre <span class="bound">n1</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">n2</span> <span class="keyword1">of</span> None <span class="main">⇒</span> <span class="main">[]</span> <span class="main">|</span> Some <span class="bound">n2</span> <span class="main">⇒</span> <span class="main">[</span><span class="main">[</span>ToyTyCore_pre <span class="bound">n2</span><span class="main">]</span><span class="main">]</span><span class="main">)</span>
    <span class="main">;</span> <span class="bound">mk</span> <span class="main">=</span> <span class="main">λ</span><span class="bound">n</span> <span class="bound">l</span><span class="main">.</span> toy_class_raw.make <span class="bound">n</span> <span class="bound">l</span> <span class="main">[]</span> False <span class="keyword1">in</span>
  <span class="main">[</span> <span class="bound">mk</span> <span class="main">(</span><span class="bound">n</span> <span class="inner_cartouche">‹Galaxy›</span> None<span class="main">)</span> <span class="main">[</span><span class="main">(</span><span class="inner_cartouche">‹sound›</span><span class="main">,</span> ToyTy_raw <span class="inner_cartouche">‹unit›</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="inner_cartouche">‹moving›</span><span class="main">,</span> ToyTy_raw <span class="inner_cartouche">‹bool›</span><span class="main">)</span><span class="main">]</span>
  <span class="main">,</span> <span class="bound">mk</span> <span class="main">(</span><span class="bound">n</span> <span class="inner_cartouche">‹Planet›</span> <span class="main">(</span>Some <span class="inner_cartouche">‹Galaxy›</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="main">(</span><span class="inner_cartouche">‹weight›</span><span class="main">,</span> ToyTy_raw <span class="inner_cartouche">‹nat›</span><span class="main">)</span><span class="main">]</span>
  <span class="main">,</span> <span class="bound">mk</span> <span class="main">(</span><span class="bound">n</span> <span class="inner_cartouche">‹Person›</span> <span class="main">(</span>Some <span class="inner_cartouche">‹Planet›</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="main">(</span><span class="inner_cartouche">‹salary›</span><span class="main">,</span> ToyTy_raw <span class="inner_cartouche">‹int›</span><span class="main">)</span><span class="main">]</span> <span class="main">]</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Since we are in a Isabelle session, at this time, it becomes possible to inspect with
the command <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">command</span></span> value<span class="antiquote"><span class="antiquote">}</span></span></span></span> the result of the translations applied with <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">Design</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
A suitable environment should nevertheless be provided,
one can typically experiment this by copying-pasting the following environment
initialized in the above <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>main›</span></span></span></span>:›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">main</span> <span class="main">=</span>
 <span class="main">(</span><span class="keyword1">let</span> <span class="bound">n</span> <span class="main">=</span> <span class="main">λ</span><span class="bound">n1</span><span class="main">.</span> ToyTyObj <span class="main">(</span>ToyTyCore_pre <span class="bound">n1</span><span class="main">)</span> <span class="main">[]</span>
    <span class="main">;</span> <span class="bound">ToyMult</span> <span class="main">=</span> <span class="main">λ</span><span class="bound">m</span> <span class="bound">r</span><span class="main">.</span> toy_multiplicity.make <span class="main">[</span><span class="bound">m</span><span class="main">]</span> <span class="bound">r</span> <span class="main">[</span>Set<span class="main">]</span> <span class="keyword1">in</span>
  write_file
   <span class="main">(</span>compiler_env_config.extend
     <span class="main">(</span>compiler_env_config_empty True None <span class="main">(</span>oidInit <span class="main">(</span>Oid <span class="main">0</span><span class="main">)</span><span class="main">)</span> Gen_only_design <span class="main">(</span>None<span class="main">,</span> False<span class="main">)</span>
        <span class="main">⦇</span> D_output_disable_thy <span class="main">:=</span> False
        <span class="main">,</span> D_output_header_thy <span class="main">:=</span> Some <span class="main">(</span><span class="inner_cartouche">‹Design_generated›</span>
                                      <span class="main">,</span><span class="main">[</span><span class="inner_cartouche">‹../Toy_Library›</span><span class="main">]</span>
                                      <span class="main">,</span><span class="inner_cartouche">‹../embedding/Generator_dynamic_sequential›</span><span class="main">)</span> <span class="main">⦈</span><span class="main">)</span>
     <span class="main">(</span> L.map <span class="main">(</span>META_class_raw Floor1<span class="main">)</span> Design
       <span class="main">@@@@</span> <span class="main">[</span> META_association <span class="main">(</span>toy_association.make
                                  ToyAssTy_association
                                  <span class="main">(</span>ToyAssRel <span class="main">[</span> <span class="main">(</span><span class="bound">n</span> <span class="inner_cartouche">‹Person›</span><span class="main">,</span> <span class="bound">ToyMult</span> <span class="main">(</span>Mult_star<span class="main">,</span> None<span class="main">)</span> None<span class="main">)</span>
                                             <span class="main">,</span> <span class="main">(</span><span class="bound">n</span> <span class="inner_cartouche">‹Person›</span><span class="main">,</span> <span class="bound">ToyMult</span> <span class="main">(</span>Mult_nat <span class="main">0</span><span class="main">,</span> Some <span class="main">(</span>Mult_nat <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Some <span class="inner_cartouche">‹boss›</span><span class="main">)</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>
          <span class="main">,</span> META_flush_all ToyFlushAll<span class="main">]</span>
     <span class="main">,</span> None<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Statically Executing the Exportation›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">verbatim</span></span> <span class="raw_text"><span class="raw_text">"apply_code_printing ()"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> \\
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">verbatim</span></span> <span class="raw_text"><span class="raw_text">"export_code main"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> \\
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">verbatim</span></span> <span class="raw_text"><span class="raw_text">"  (* in Haskell *)"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> \\
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">verbatim</span></span> <span class="raw_text"><span class="raw_text">"  (* in OCaml module_name M *)"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> \\
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">verbatim</span></span> <span class="raw_text"><span class="raw_text">"  (* in Scala module_name M *)"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> \\
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">verbatim</span></span> <span class="raw_text"><span class="raw_text">"  (* in SML   module_name M *)"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹After the exportation and executing the exported, we obtain an Isabelle \verb|.thy| file
containing the generated code associated to the above input.›</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Generator_dynamic_sequential">
<div class="head">
<h1>Theory Generator_dynamic_sequential</h1>
</div>
<pre class="source"><span class="comment1">(******************************************************************************
 * Citadelle
 *
 * Copyright (c) 2011-2018 Université Paris-Saclay, Univ. Paris-Sud, France
 *               2013-2017 IRT SystemX, France
 *               2011-2015 Achim D. Brucker, Germany
 *               2016-2018 The University of Sheffield, UK
 *               2016-2017 Nanyang Technological University, Singapore
 *               2017-2018 Virginia Tech, USA
 *
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are
 * met:
 *
 *     * Redistributions of source code must retain the above copyright
 *       notice, this list of conditions and the following disclaimer.
 *
 *     * Redistributions in binary form must reproduce the above
 *       copyright notice, this list of conditions and the following
 *       disclaimer in the documentation and/or other materials provided
 *       with the distribution.
 *
 *     * Neither the name of the copyright holders nor the names of its
 *       contributors may be used to endorse or promote products derived
 *       from this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 ******************************************************************************)</span>

<span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹Dynamic Meta Embedding with Reflection›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Generator_dynamic_sequential
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Printer.html">Printer</a>
        <span class="quoted">"<a href="Isabelle_Main2.html">../../isabelle_home/src/HOL/Isabelle_Main2</a>"</span>
<span class="comment1">(*&lt;*)</span>
  <span class="keyword2"><span class="keyword">keywords</span></span> <span class="comment1">(* Toy language *)</span>
           <span class="quoted">"Between"</span>
           <span class="quoted">"Attributes"</span> <span class="quoted">"Operations"</span> <span class="quoted">"Constraints"</span>
           <span class="quoted">"Role"</span>
           <span class="quoted">"Ordered"</span> <span class="quoted">"Subsets"</span> <span class="quoted">"Union"</span> <span class="quoted">"Redefines"</span> <span class="quoted">"Derived"</span> <span class="quoted">"Qualifier"</span>
           <span class="quoted">"Existential"</span> <span class="quoted">"Inv"</span> <span class="quoted">"Pre"</span> <span class="quoted">"Post"</span>
           <span class="quoted">"self"</span>
           <span class="quoted">"Nonunique"</span> <span class="quoted">"Sequence_"</span>

           <span class="comment1">(* Isabelle syntax *)</span>
           <span class="quoted">"output_directory"</span>
           <span class="quoted">"THEORY"</span> <span class="quoted">"IMPORTS"</span> <span class="quoted">"SECTION"</span> <span class="quoted">"SORRY"</span> <span class="quoted">"no_dirty"</span>
           <span class="quoted">"deep"</span> <span class="quoted">"shallow"</span> <span class="quoted">"syntax_print"</span> <span class="quoted">"skip_export"</span>
           <span class="quoted">"generation_semantics"</span>
           <span class="quoted">"flush_all"</span>

           <span class="comment1">(* Isabelle semantics (parameterizing the semantics of Toy language) *)</span>
           <span class="quoted">"design"</span> <span class="quoted">"analysis"</span> <span class="quoted">"oid_start"</span>

       <span class="keyword2"><span class="keyword">and</span></span> <span class="comment1">(* Toy language *)</span>
           <span class="quoted">"Enum"</span>
           <span class="quoted">"Abstract_class"</span> <span class="quoted">"Class"</span>
           <span class="quoted">"Association"</span> <span class="quoted">"Composition"</span> <span class="quoted">"Aggregation"</span>
           <span class="quoted">"Abstract_associationclass"</span> <span class="quoted">"Associationclass"</span>
           <span class="quoted">"Context"</span>
           <span class="quoted">"End"</span> <span class="quoted">"Instance"</span> <span class="quoted">"BaseType"</span> <span class="quoted">"State"</span> <span class="quoted">"PrePost"</span>

           <span class="comment1">(* Isabelle syntax *)</span>
           <span class="quoted">"generation_syntax"</span>

           <span class="main">::</span> thy_decl
<span class="comment1">(*&gt;*)</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹In the ``dynamic'' solution: the exportation is automatically handled inside Isabelle/jEdit.
Inputs are provided using the syntax of the Toy Language, and in output
we basically have two options:
\begin{itemize}
\item The first is to generate an Isabelle file for inspection or debugging.
The generated file can interactively be loaded in Isabelle/jEdit, or saved to the hard disk.
This mode is called the ``deep exportation'' mode or shortly the ``deep'' mode.
The aim is to maximally automate the process one is manually performing in
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">file</span></span> ‹Generator_static.thy›<span class="antiquote"><span class="antiquote">}</span></span></span></span>.
\item On the other hand, it is also possible to directly execute
in Isabelle/jEdit the generated file from the random access memory.
This mode corresponds to the ``shallow reflection'' mode or shortly ``shallow'' mode.
\end{itemize}
In both modes, the reflection is necessary since the main part used by both
was defined at Isabelle side.
As a consequence, experimentations in ``deep'' and ``shallow'' are performed
without leaving the editing session, in the same as the one the meta-compiler is actually running.›</span></span>

<span class="keyword1"><span class="command">apply_code_printing_reflect</span></span> <span class="quoted">‹
  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">stdout_file</span> <span class="main">=</span> Unsynchronized.ref <span class="inner_quoted">""</span>
›</span> <span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹This variable is not used in this theory (only in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">file</span></span> ‹Generator_static.thy›<span class="antiquote"><span class="antiquote">}</span></span></span></span>),
       but needed for well typechecking the reflected SML code.›</span></span>

<span class="keyword1"><span class="command">code_reflect'</span></span> <span class="keyword2"><span class="keyword">open</span></span> META
   <span class="keyword2"><span class="keyword">functions</span></span> <span class="comment1">(* executing the compiler as monadic combinators for deep and shallow *)</span>
             fold_thy_deep fold_thy_shallow

             <span class="comment1">(* printing the HOL AST to (shallow Isabelle) string *)</span>
             write_file

             <span class="comment1">(* manipulating the compiling environment *)</span>
             compiler_env_config_reset_all
             compiler_env_config_update
             oidInit
             D_output_header_thy_update
             map2_ctxt_term
             check_export_code

             <span class="comment1">(* printing the TOY AST to (deep Isabelle) string *)</span>
             isabelle_apply isabelle_of_compiler_env_config

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Interface Between the Reflected and the Native›</span></span>

<span class="keyword1"><span class="command">ML</span></span><span class="quoted">‹
 <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">To_string0</span> <span class="main">=</span> META.meta_of_logic
›</span>

<span class="keyword1"><span class="command">ML</span></span><span class="quoted">‹
<span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">From</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">struct</span></span>
 <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">string</span> <span class="main">=</span> META.SS_base o META.ST
 <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">binding</span> <span class="main">=</span> <span class="entity">string</span> o Binding.name_of
 <span class="comment1">(*fun term ctxt s = string (XML.content_of (YXML.parse_body (Syntax.string_of_term ctxt s)))*)</span>
 <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">internal_oid</span> <span class="main">=</span> META.Oid o Code_Numeral.natural_of_integer
 <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">option</span> <span class="main">=</span> Option.map
 <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">list</span> <span class="main">=</span> List.map
 <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">pair</span> <span class="entity">f1</span> <span class="entity">f2</span> <span class="main">(</span><span class="entity">x</span><span class="main">,</span> <span class="entity">y</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="entity">f1</span> <span class="entity">x</span><span class="main">,</span> <span class="entity">f2</span> <span class="entity">y</span><span class="main">)</span>
 <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">pair3</span> <span class="entity">f1</span> <span class="entity">f2</span> <span class="entity">f3</span> <span class="main">(</span><span class="entity">x</span><span class="main">,</span> <span class="entity">y</span><span class="main">,</span> <span class="entity">z</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="entity">f1</span> <span class="entity">x</span><span class="main">,</span> <span class="entity">f2</span> <span class="entity">y</span><span class="main">,</span> <span class="entity">f3</span> <span class="entity">z</span><span class="main">)</span>

 <span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">Pure</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">struct</span></span>
 <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">indexname</span> <span class="main">=</span> <span class="entity">pair</span> <span class="entity">string</span> Code_Numeral.natural_of_integer
 <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">class</span> <span class="main">=</span> <span class="entity">string</span>
 <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">sort</span> <span class="main">=</span> <span class="entity">list</span> <span class="entity">class</span>
 <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">typ</span> <span class="entity">e</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span>
     Type <span class="main">(</span><span class="entity">s</span><span class="main">,</span> <span class="entity">l</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="main">(</span>META.Type o <span class="entity">pair</span> <span class="entity">string</span> <span class="main">(</span><span class="entity">list</span> <span class="entity">typ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="entity">s</span><span class="main">,</span> <span class="entity">l</span><span class="main">)</span>
   <span class="main">|</span> TFree <span class="main">(</span><span class="entity">s</span><span class="main">,</span> <span class="entity">s0</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="main">(</span>META.TFree o <span class="entity">pair</span> <span class="entity">string</span> <span class="entity">sort</span><span class="main">)</span> <span class="main">(</span><span class="entity">s</span><span class="main">,</span> <span class="entity">s0</span><span class="main">)</span>
   <span class="main">|</span> TVar <span class="main">(</span><span class="entity">i</span><span class="main">,</span> <span class="entity">s0</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="main">(</span>META.TVar o <span class="entity">pair</span> <span class="entity">indexname</span> <span class="entity">sort</span><span class="main">)</span> <span class="main">(</span><span class="entity">i</span><span class="main">,</span> <span class="entity">s0</span><span class="main">)</span>
  <span class="main">)</span> <span class="entity">e</span>
 <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">term</span> <span class="entity">e</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span>
     Const <span class="main">(</span><span class="entity">s</span><span class="main">,</span> <span class="entity">t</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="main">(</span>META.Const o <span class="entity">pair</span> <span class="entity">string</span> <span class="entity">typ</span><span class="main">)</span> <span class="main">(</span><span class="entity">s</span><span class="main">,</span> <span class="entity">t</span><span class="main">)</span>
   <span class="main">|</span> Free <span class="main">(</span><span class="entity">s</span><span class="main">,</span> <span class="entity">t</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="main">(</span>META.Free o <span class="entity">pair</span> <span class="entity">string</span> <span class="entity">typ</span><span class="main">)</span> <span class="main">(</span><span class="entity">s</span><span class="main">,</span> <span class="entity">t</span><span class="main">)</span>
   <span class="main">|</span> Var <span class="main">(</span><span class="entity">i</span><span class="main">,</span> <span class="entity">t</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="main">(</span>META.Var o <span class="entity">pair</span> <span class="entity">indexname</span> <span class="entity">typ</span><span class="main">)</span> <span class="main">(</span><span class="entity">i</span><span class="main">,</span> <span class="entity">t</span><span class="main">)</span>
   <span class="main">|</span> Bound <span class="entity">i</span> <span class="main">=&gt;</span> <span class="main">(</span>META.Bound o Code_Numeral.natural_of_integer<span class="main">)</span> <span class="entity">i</span>
   <span class="main">|</span> Abs <span class="main">(</span><span class="entity">s</span><span class="main">,</span> <span class="entity">ty</span><span class="main">,</span> <span class="entity">t</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="main">(</span>META.Abs o <span class="entity">pair3</span> <span class="entity">string</span> <span class="entity">typ</span> <span class="entity">term</span><span class="main">)</span> <span class="main">(</span><span class="entity">s</span><span class="main">,</span> <span class="entity">ty</span><span class="main">,</span> <span class="entity">t</span><span class="main">)</span>
   <span class="main">|</span> <span class="keyword1"><span class="keyword">op</span></span> $ <span class="main">(</span><span class="entity">term1</span><span class="main">,</span> <span class="entity">term2</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="main">(</span>META.App o <span class="entity">pair</span> <span class="entity">term</span> <span class="entity">term</span><span class="main">)</span> <span class="main">(</span><span class="entity">term1</span><span class="main">,</span> <span class="entity">term2</span><span class="main">)</span>
  <span class="main">)</span> <span class="entity">e</span>
 <span class="keyword2"><span class="keyword">end</span></span>

 <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">toy_ctxt_term</span> <span class="entity">thy</span> <span class="entity">expr</span> <span class="main">=</span>
   META.T_pure <span class="main">(</span><span class="entity">Pure.term</span> <span class="main">(</span>Syntax.read_term <span class="main">(</span>Proof_Context.init_global <span class="entity">thy</span><span class="main">)</span> <span class="entity">expr</span><span class="main">)</span><span class="main">)</span>
<span class="keyword2"><span class="keyword">end</span></span>
›</span>

<span class="keyword1"><span class="command">ML</span></span><span class="quoted">‹<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">List_mapi</span> <span class="entity">f</span> <span class="main">=</span> META.mapi <span class="main">(</span><span class="entity">f</span> o Code_Numeral.integer_of_natural<span class="main">)</span>›</span>

<span class="keyword1"><span class="command">ML</span></span><span class="quoted">‹
<span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">Ty'</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">struct</span></span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">check</span> <span class="entity">l_oid</span> <span class="entity">l</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">Mp</span> <span class="main">=</span> META.map_prod
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">Me</span> <span class="main">=</span> String.explode
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">Mi</span> <span class="main">=</span> String.implode
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">Ml</span> <span class="main">=</span> map <span class="keyword2"><span class="keyword">in</span></span>
  META.check_export_code
    <span class="main">(</span>writeln o <span class="entity">Mi</span><span class="main">)</span>
    <span class="main">(</span>warning o <span class="entity">Mi</span><span class="main">)</span>
    <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">s</span> <span class="main">=&gt;</span> writeln <span class="main">(</span>Markup.markup <span class="main">(</span>Markup.bad <span class="main">(</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="entity">Mi</span> <span class="entity">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
    <span class="main">(</span>error o <span class="entity">To_string0</span><span class="main">)</span>
    <span class="main">(</span><span class="entity">Ml</span> <span class="main">(</span><span class="entity">Mp</span> I <span class="entity">Me</span><span class="main">)</span> <span class="entity">l_oid</span><span class="main">)</span>
    <span class="main">(</span><span class="main">(</span>META.SS_base o META.ST<span class="main">)</span> <span class="entity">l</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">end</span></span>
<span class="keyword2"><span class="keyword">end</span></span>
›</span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Binding of the Reflected API to the Native API›</span></span>

<span class="keyword1"><span class="command">ML</span></span><span class="quoted">‹
<span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">META_overload</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">struct</span></span>
  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">of_semi__typ</span> <span class="main">=</span> META.of_semi_typ <span class="entity">To_string0</span>
  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">of_semi__term</span> <span class="main">=</span> META.of_semi_terma <span class="entity">To_string0</span>
  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">of_semi__term'</span> <span class="main">=</span> META.of_semi_term <span class="entity">To_string0</span>
  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">fold</span> <span class="main">=</span> fold
<span class="keyword2"><span class="keyword">end</span></span>
›</span>

<span class="keyword1"><span class="command">ML</span></span><span class="quoted">‹
<span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">Bind_Isabelle</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">struct</span></span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">To_binding</span> <span class="entity">s</span> <span class="main">=</span> Binding.make <span class="main">(</span><span class="entity">s</span><span class="main">,</span> Position.none<span class="main">)</span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">To_sbinding</span> <span class="main">=</span> <span class="entity">To_binding</span> o <span class="entity">To_string0</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">semi__method_simp</span> <span class="entity">g</span> <span class="entity">f</span> <span class="main">=</span> <span class="entity">Method.Basic</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">ctxt</span> <span class="main">=&gt;</span> <span class="entity">SIMPLE_METHOD</span> <span class="main">(</span><span class="entity">g</span> <span class="main">(</span><span class="entity">asm_full_simp_tac</span> <span class="main">(</span><span class="entity">f</span> <span class="entity">ctxt</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">semi__method_simp_one</span> <span class="main">=</span> <span class="entity">semi__method_simp</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">f</span> <span class="main">=&gt;</span> <span class="entity">f</span> <span class="inner_numeral">1</span><span class="main">)</span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">semi__method_simp_all</span> <span class="main">=</span> <span class="entity">semi__method_simp</span> <span class="main">(</span>CHANGED_PROP o <span class="entity">PARALLEL_ALLGOALS</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">datatype</span></span> <span class="entity">semi__thm'</span> <span class="main">=</span> <span class="entity">Thms_single'</span> <span class="keyword2"><span class="keyword">of</span></span> thm
                    <span class="main">|</span> <span class="entity">Thms_mult'</span> <span class="keyword2"><span class="keyword">of</span></span> thm list

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">semi__thm_attribute</span> <span class="entity">ctxt</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword3"><span class="keyword">open</span></span> META <span class="keyword3"><span class="keyword">open</span></span> META_overload <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">S</span> <span class="main">=</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">Thms_single'</span> <span class="entity">t</span> <span class="main">=&gt;</span> <span class="entity">t</span>
                                                         <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">M</span> <span class="main">=</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">Thms_mult'</span> <span class="entity">t</span> <span class="main">=&gt;</span> <span class="entity">t</span> <span class="keyword2"><span class="keyword">in</span></span>
 <span class="keyword1"><span class="keyword">fn</span></span> Thm_thm <span class="entity">s</span> <span class="main">=&gt;</span> <span class="entity">Thms_single'</span> <span class="main">(</span>Proof_Context.get_thm <span class="entity">ctxt</span> <span class="main">(</span><span class="entity">To_string0</span> <span class="entity">s</span><span class="main">)</span><span class="main">)</span>
  <span class="main">|</span> Thm_thms <span class="entity">s</span> <span class="main">=&gt;</span> <span class="entity">Thms_mult'</span> <span class="main">(</span>Proof_Context.get_thms <span class="entity">ctxt</span> <span class="main">(</span><span class="entity">To_string0</span> <span class="entity">s</span><span class="main">)</span><span class="main">)</span>
  <span class="main">|</span> Thm_THEN <span class="main">(</span><span class="entity">e1</span><span class="main">,</span> <span class="entity">e2</span><span class="main">)</span> <span class="main">=&gt;</span>
      <span class="main">(</span><span class="keyword2"><span class="keyword">case</span></span> <span class="main">(</span><span class="entity">semi__thm_attribute</span> <span class="entity">ctxt</span> <span class="entity">e1</span><span class="main">,</span> <span class="entity">semi__thm_attribute</span> <span class="entity">ctxt</span> <span class="entity">e2</span><span class="main">)</span> <span class="keyword2"><span class="keyword">of</span></span>
         <span class="main">(</span><span class="entity">Thms_single'</span> <span class="entity">e1</span><span class="main">,</span> <span class="entity">Thms_single'</span> <span class="entity">e2</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">Thms_single'</span> <span class="main">(</span><span class="entity">e1</span> RSN <span class="main">(</span><span class="inner_numeral">1</span><span class="main">,</span> <span class="entity">e2</span><span class="main">)</span><span class="main">)</span>
       <span class="main">|</span> <span class="main">(</span><span class="entity">Thms_mult'</span> <span class="entity">e1</span><span class="main">,</span> <span class="entity">Thms_mult'</span> <span class="entity">e2</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">Thms_mult'</span> <span class="main">(</span><span class="entity">e1</span> RLN <span class="main">(</span><span class="inner_numeral">1</span><span class="main">,</span> <span class="entity">e2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
  <span class="main">|</span> Thm_simplified <span class="main">(</span><span class="entity">e1</span><span class="main">,</span> <span class="entity">e2</span><span class="main">)</span> <span class="main">=&gt;</span>
      <span class="entity">Thms_single'</span> <span class="main">(</span><span class="entity">asm_full_simplify</span> <span class="main">(</span>clear_simpset <span class="entity">ctxt</span> addsimps <span class="main">[</span><span class="entity">S</span> <span class="main">(</span><span class="entity">semi__thm_attribute</span> <span class="entity">ctxt</span> <span class="entity">e2</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>
                                      <span class="main">(</span><span class="entity">S</span> <span class="main">(</span><span class="entity">semi__thm_attribute</span> <span class="entity">ctxt</span> <span class="entity">e1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
  <span class="main">|</span> Thm_OF <span class="main">(</span><span class="entity">e1</span><span class="main">,</span> <span class="entity">e2</span><span class="main">)</span> <span class="main">=&gt;</span>
      <span class="entity">Thms_single'</span> <span class="main">(</span><span class="main">[</span><span class="entity">S</span> <span class="main">(</span><span class="entity">semi__thm_attribute</span> <span class="entity">ctxt</span> <span class="entity">e2</span><span class="main">)</span><span class="main">]</span> MRS <span class="main">(</span><span class="entity">S</span> <span class="main">(</span><span class="entity">semi__thm_attribute</span> <span class="entity">ctxt</span> <span class="entity">e1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
  <span class="main">|</span> Thm_where <span class="main">(</span><span class="entity">nth</span><span class="main">,</span> <span class="entity">l</span><span class="main">)</span> <span class="main">=&gt;</span>
      <span class="entity">Thms_single'</span> <span class="main">(</span><span class="entity">Rule_Insts.where_rule</span>
                      <span class="entity">ctxt</span>
                      <span class="main">(</span>List.map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">var</span><span class="main">,</span> <span class="entity">expr</span><span class="main">)</span> <span class="main">=&gt;</span>
                                   <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="entity">To_string0</span> <span class="entity">var</span><span class="main">,</span> <span class="inner_numeral">0</span><span class="main">)</span><span class="main">,</span> Position.none<span class="main">)</span><span class="main">,</span> <span class="entity">of_semi__term</span> <span class="entity">expr</span><span class="main">)</span><span class="main">)</span> <span class="entity">l</span><span class="main">)</span>
                      <span class="main">[</span><span class="main">]</span>
                      <span class="main">(</span><span class="entity">S</span> <span class="main">(</span><span class="entity">semi__thm_attribute</span> <span class="entity">ctxt</span> <span class="entity">nth</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
  <span class="main">|</span> Thm_symmetric <span class="entity">e1</span> <span class="main">=&gt;</span>
      <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">e2</span> <span class="main">=</span> <span class="entity">S</span> <span class="main">(</span><span class="entity">semi__thm_attribute</span> <span class="entity">ctxt</span> <span class="main">(</span>Thm_thm <span class="main">(</span><span class="entity">From.string</span> <span class="inner_quoted">"sym"</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword2"><span class="keyword">in</span></span>
        <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">semi__thm_attribute</span> <span class="entity">ctxt</span> <span class="entity">e1</span> <span class="keyword2"><span class="keyword">of</span></span>
          <span class="entity">Thms_single'</span> <span class="entity">e1</span> <span class="main">=&gt;</span> <span class="entity">Thms_single'</span> <span class="main">(</span><span class="entity">e1</span> RSN <span class="main">(</span><span class="inner_numeral">1</span><span class="main">,</span> <span class="entity">e2</span><span class="main">)</span><span class="main">)</span>
        <span class="main">|</span> <span class="entity">Thms_mult'</span> <span class="entity">e1</span> <span class="main">=&gt;</span> <span class="entity">Thms_mult'</span> <span class="main">(</span><span class="entity">e1</span> RLN <span class="main">(</span><span class="inner_numeral">1</span><span class="main">,</span> <span class="main">[</span><span class="entity">e2</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>
      <span class="keyword2"><span class="keyword">end</span></span>
  <span class="main">|</span> Thm_of <span class="main">(</span><span class="entity">nth</span><span class="main">,</span> <span class="entity">l</span><span class="main">)</span> <span class="main">=&gt;</span>
      <span class="entity">Thms_single'</span> <span class="main">(</span><span class="entity">Rule_Insts.of_rule</span>
                     <span class="entity">ctxt</span>
                     <span class="main">(</span>List.map <span class="main">(</span>SOME o <span class="entity">of_semi__term</span><span class="main">)</span> <span class="entity">l</span><span class="main">,</span> <span class="main">[</span><span class="main">]</span><span class="main">)</span>
                     <span class="main">[</span><span class="main">]</span>
                     <span class="main">(</span><span class="entity">S</span> <span class="main">(</span><span class="entity">semi__thm_attribute</span> <span class="entity">ctxt</span> <span class="entity">nth</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">semi__thm_attribute_single</span> <span class="entity">ctxt</span> <span class="entity">s</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">case</span></span> <span class="main">(</span><span class="entity">semi__thm_attribute</span> <span class="entity">ctxt</span> <span class="entity">s</span><span class="main">)</span> <span class="keyword2"><span class="keyword">of</span></span> <span class="entity">Thms_single'</span> <span class="entity">t</span> <span class="main">=&gt;</span> <span class="entity">t</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">semi__thm_mult</span> <span class="entity">ctxt</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">f</span> <span class="entity">thy</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">case</span></span> <span class="main">(</span><span class="entity">semi__thm_attribute</span> <span class="entity">ctxt</span> <span class="entity">thy</span><span class="main">)</span> <span class="keyword2"><span class="keyword">of</span></span> <span class="entity">Thms_mult'</span> <span class="entity">t</span> <span class="main">=&gt;</span> <span class="entity">t</span>
                                                  <span class="main">|</span> <span class="entity">Thms_single'</span> <span class="entity">t</span> <span class="main">=&gt;</span> <span class="main">[</span><span class="entity">t</span><span class="main">]</span> <span class="keyword2"><span class="keyword">in</span></span>
  <span class="keyword1"><span class="keyword">fn</span></span> META.Thms_single <span class="entity">thy</span> <span class="main">=&gt;</span> <span class="entity">f</span> <span class="entity">thy</span>
   <span class="main">|</span> META.Thms_mult <span class="entity">thy</span> <span class="main">=&gt;</span> <span class="entity">f</span> <span class="entity">thy</span>
  <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">semi__thm_mult_l</span> <span class="entity">ctxt</span> <span class="entity">l</span> <span class="main">=</span> List.concat <span class="main">(</span>map <span class="main">(</span><span class="entity">semi__thm_mult</span> <span class="entity">ctxt</span><span class="main">)</span> <span class="entity">l</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">semi__method_simp_only</span> <span class="entity">l</span> <span class="entity">ctxt</span> <span class="main">=</span> clear_simpset <span class="entity">ctxt</span> addsimps <span class="main">(</span><span class="entity">semi__thm_mult_l</span> <span class="entity">ctxt</span> <span class="entity">l</span><span class="main">)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">semi__method_simp_add_del_split</span> <span class="main">(</span><span class="entity">l_add</span><span class="main">,</span> <span class="entity">l_del</span><span class="main">,</span> <span class="entity">l_split</span><span class="main">)</span> <span class="entity">ctxt</span> <span class="main">=</span>
  fold <span class="entity">Splitter.add_split</span> <span class="main">(</span><span class="entity">semi__thm_mult_l</span> <span class="entity">ctxt</span> <span class="entity">l_split</span><span class="main">)</span>
                          <span class="main">(</span><span class="entity">ctxt</span> addsimps <span class="main">(</span><span class="entity">semi__thm_mult_l</span> <span class="entity">ctxt</span> <span class="entity">l_add</span><span class="main">)</span>
                                delsimps <span class="main">(</span><span class="entity">semi__thm_mult_l</span> <span class="entity">ctxt</span> <span class="entity">l_del</span><span class="main">)</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">semi__method</span> <span class="entity">expr</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword3"><span class="keyword">open</span></span> META <span class="keyword3"><span class="keyword">open</span></span> Method <span class="keyword3"><span class="keyword">open</span></span> META_overload <span class="keyword2"><span class="keyword">in</span></span> <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">expr</span> <span class="keyword2"><span class="keyword">of</span></span>
    Method_rule <span class="entity">o_s</span> <span class="main">=&gt;</span> <span class="entity">Basic</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">ctxt</span> <span class="main">=&gt;</span>
      <span class="entity">METHOD</span> <span class="main">(</span>HEADGOAL o <span class="entity">Classical.rule_tac</span>
                           <span class="entity">ctxt</span>
                           <span class="main">(</span><span class="keyword2"><span class="keyword">case</span></span> <span class="entity">o_s</span> <span class="keyword2"><span class="keyword">of</span></span> NONE <span class="main">=&gt;</span> <span class="main">[</span><span class="main">]</span>
                                      <span class="main">|</span> SOME <span class="entity">s</span> <span class="main">=&gt;</span> <span class="main">[</span><span class="entity">semi__thm_attribute_single</span> <span class="entity">ctxt</span> <span class="entity">s</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
  <span class="main">|</span> Method_drule <span class="entity">s</span> <span class="main">=&gt;</span> <span class="entity">Basic</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">ctxt</span> <span class="main">=&gt;</span> <span class="entity">drule</span> <span class="entity">ctxt</span> <span class="inner_numeral">0</span> <span class="main">[</span><span class="entity">semi__thm_attribute_single</span> <span class="entity">ctxt</span> <span class="entity">s</span><span class="main">]</span><span class="main">)</span>
  <span class="main">|</span> Method_erule <span class="entity">s</span> <span class="main">=&gt;</span> <span class="entity">Basic</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">ctxt</span> <span class="main">=&gt;</span> <span class="entity">erule</span> <span class="entity">ctxt</span> <span class="inner_numeral">0</span> <span class="main">[</span><span class="entity">semi__thm_attribute_single</span> <span class="entity">ctxt</span> <span class="entity">s</span><span class="main">]</span><span class="main">)</span>
  <span class="main">|</span> Method_elim <span class="entity">s</span> <span class="main">=&gt;</span> <span class="entity">Basic</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">ctxt</span> <span class="main">=&gt;</span> <span class="entity">elim</span> <span class="entity">ctxt</span> <span class="main">[</span><span class="entity">semi__thm_attribute_single</span> <span class="entity">ctxt</span> <span class="entity">s</span><span class="main">]</span><span class="main">)</span>
  <span class="main">|</span> Method_intro <span class="entity">l</span> <span class="main">=&gt;</span> <span class="entity">Basic</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">ctxt</span> <span class="main">=&gt;</span> <span class="entity">intro</span> <span class="entity">ctxt</span> <span class="main">(</span>map <span class="main">(</span><span class="entity">semi__thm_attribute_single</span> <span class="entity">ctxt</span><span class="main">)</span> <span class="entity">l</span><span class="main">)</span><span class="main">)</span>
  <span class="main">|</span> Method_subst <span class="main">(</span><span class="entity">asm</span><span class="main">,</span> <span class="entity">l</span><span class="main">,</span> <span class="entity">s</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">Basic</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">ctxt</span> <span class="main">=&gt;</span>
      <span class="entity">SIMPLE_METHOD'</span> <span class="main">(</span><span class="main">(</span><span class="keyword2"><span class="keyword">if</span></span> <span class="entity">asm</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">EqSubst.eqsubst_asm_tac</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="entity">EqSubst.eqsubst_tac</span><span class="main">)</span>
                        <span class="entity">ctxt</span>
                        <span class="main">(</span>map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">s</span> <span class="main">=&gt;</span> <span class="keyword2"><span class="keyword">case</span></span> Int.fromString <span class="main">(</span><span class="entity">To_string0</span> <span class="entity">s</span><span class="main">)</span> <span class="keyword2"><span class="keyword">of</span></span>
                                        SOME <span class="entity">i</span> <span class="main">=&gt;</span> <span class="entity">i</span><span class="main">)</span> <span class="entity">l</span><span class="main">)</span>
                        <span class="main">[</span><span class="entity">semi__thm_attribute_single</span> <span class="entity">ctxt</span> <span class="entity">s</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>
  <span class="main">|</span> Method_insert <span class="entity">l</span> <span class="main">=&gt;</span> <span class="entity">Basic</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">ctxt</span> <span class="main">=&gt;</span> <span class="entity">insert</span> <span class="main">(</span><span class="entity">semi__thm_mult_l</span> <span class="entity">ctxt</span> <span class="entity">l</span><span class="main">)</span><span class="main">)</span>
  <span class="main">|</span> Method_plus <span class="entity">t</span> <span class="main">=&gt;</span> <span class="entity">Combinator</span> <span class="main">(</span> <span class="entity">no_combinator_info</span>
                                <span class="main">,</span> <span class="entity">Repeat1</span>
                                <span class="main">,</span> <span class="main">[</span><span class="entity">Combinator</span> <span class="main">(</span><span class="entity">no_combinator_info</span><span class="main">,</span> <span class="entity">Then</span><span class="main">,</span> List.map <span class="entity">semi__method</span> <span class="entity">t</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>
  <span class="main">|</span> Method_option <span class="entity">t</span> <span class="main">=&gt;</span> <span class="entity">Combinator</span> <span class="main">(</span> <span class="entity">no_combinator_info</span>
                                  <span class="main">,</span> <span class="entity">Try</span>
                                  <span class="main">,</span> <span class="main">[</span><span class="entity">Combinator</span> <span class="main">(</span><span class="entity">no_combinator_info</span><span class="main">,</span> <span class="entity">Then</span><span class="main">,</span> List.map <span class="entity">semi__method</span> <span class="entity">t</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>
  <span class="main">|</span> Method_or <span class="entity">t</span> <span class="main">=&gt;</span> <span class="entity">Combinator</span> <span class="main">(</span><span class="entity">no_combinator_info</span><span class="main">,</span> <span class="entity">Orelse</span><span class="main">,</span> List.map <span class="entity">semi__method</span> <span class="entity">t</span><span class="main">)</span>
  <span class="main">|</span> Method_one <span class="main">(</span>Method_simp_only <span class="entity">l</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">semi__method_simp_one</span> <span class="main">(</span><span class="entity">semi__method_simp_only</span> <span class="entity">l</span><span class="main">)</span>
  <span class="main">|</span> Method_one <span class="main">(</span>Method_simp_add_del_split <span class="entity">l</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">semi__method_simp_one</span> <span class="main">(</span><span class="entity">semi__method_simp_add_del_split</span> <span class="entity">l</span><span class="main">)</span>
  <span class="main">|</span> Method_all <span class="main">(</span>Method_simp_only <span class="entity">l</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">semi__method_simp_all</span> <span class="main">(</span><span class="entity">semi__method_simp_only</span> <span class="entity">l</span><span class="main">)</span>
  <span class="main">|</span> Method_all <span class="main">(</span>Method_simp_add_del_split <span class="entity">l</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">semi__method_simp_all</span> <span class="main">(</span><span class="entity">semi__method_simp_add_del_split</span> <span class="entity">l</span><span class="main">)</span>
  <span class="main">|</span> Method_auto_simp_add_split <span class="main">(</span><span class="entity">l_simp</span><span class="main">,</span> <span class="entity">l_split</span><span class="main">)</span> <span class="main">=&gt;</span>
      <span class="entity">Basic</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">ctxt</span> <span class="main">=&gt;</span> <span class="entity">SIMPLE_METHOD</span> <span class="main">(</span><span class="entity">auto_tac</span> <span class="main">(</span><span class="entity">fold</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">f</span><span class="main">,</span> <span class="entity">l</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">fold</span> <span class="entity">f</span> <span class="entity">l</span><span class="main">)</span>
              <span class="main">[</span><span class="main">(</span><span class="entity">Simplifier.add_simp</span><span class="main">,</span> <span class="entity">semi__thm_mult_l</span> <span class="entity">ctxt</span> <span class="entity">l_simp</span><span class="main">)</span>
              <span class="main">,</span><span class="main">(</span><span class="entity">Splitter.add_split</span><span class="main">,</span> List.map <span class="main">(</span>Proof_Context.get_thm <span class="entity">ctxt</span> o <span class="entity">To_string0</span><span class="main">)</span> <span class="entity">l_split</span><span class="main">)</span><span class="main">]</span>
              <span class="entity">ctxt</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
  <span class="main">|</span> Method_rename_tac <span class="entity">l</span> <span class="main">=&gt;</span> <span class="entity">Basic</span> <span class="main">(</span>K <span class="main">(</span><span class="entity">SIMPLE_METHOD'</span> <span class="main">(</span>Tactic.rename_tac <span class="main">(</span>List.map <span class="entity">To_string0</span> <span class="entity">l</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
  <span class="main">|</span> Method_case_tac <span class="entity">e</span> <span class="main">=&gt;</span>
      <span class="entity">Basic</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">ctxt</span> <span class="main">=&gt;</span> <span class="entity">SIMPLE_METHOD'</span> <span class="main">(</span><span class="entity">Induct_Tacs.case_tac</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="entity">of_semi__term</span> <span class="entity">e</span><span class="main">)</span> <span class="main">[</span><span class="main">]</span> NONE<span class="main">)</span><span class="main">)</span>
  <span class="main">|</span> Method_blast <span class="entity">n</span> <span class="main">=&gt;</span>
      <span class="entity">Basic</span> <span class="main">(</span><span class="keyword2"><span class="keyword">case</span></span> <span class="entity">n</span> <span class="keyword2"><span class="keyword">of</span></span> NONE <span class="main">=&gt;</span> <span class="entity">SIMPLE_METHOD'</span> o <span class="entity">blast_tac</span>
                     <span class="main">|</span> SOME <span class="entity">lim</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">ctxt</span> <span class="main">=&gt;</span> <span class="entity">SIMPLE_METHOD'</span> <span class="main">(</span><span class="entity">depth_tac</span> <span class="entity">ctxt</span> <span class="main">(</span>Code_Numeral.integer_of_natural <span class="entity">lim</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
  <span class="main">|</span> Method_clarify <span class="main">=&gt;</span> <span class="entity">Basic</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">ctxt</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="entity">SIMPLE_METHOD'</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">i</span> <span class="main">=&gt;</span> CHANGED_PROP <span class="main">(</span><span class="entity">clarify_tac</span> <span class="entity">ctxt</span> <span class="entity">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
  <span class="main">|</span> Method_metis <span class="main">(</span><span class="entity">l_opt</span><span class="main">,</span> <span class="entity">l</span><span class="main">)</span> <span class="main">=&gt;</span>
      <span class="entity">Basic</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">ctxt</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="entity">METHOD</span> oo <span class="entity">Metis_Tactic.metis_method</span><span class="main">)</span>
                          <span class="main">(</span> <span class="main">(</span><span class="keyword2"><span class="keyword">if</span></span> <span class="entity">l_opt</span> <span class="main">=</span> <span class="main">[</span><span class="main">]</span> <span class="keyword2"><span class="keyword">then</span></span> NONE <span class="keyword2"><span class="keyword">else</span></span> SOME <span class="main">(</span>map <span class="entity">To_string0</span> <span class="entity">l_opt</span><span class="main">)</span><span class="main">,</span> NONE<span class="main">)</span>
                          <span class="main">,</span> map <span class="main">(</span><span class="entity">semi__thm_attribute_single</span> <span class="entity">ctxt</span><span class="main">)</span> <span class="entity">l</span><span class="main">)</span>
                          <span class="entity">ctxt</span><span class="main">)</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">then_tactic</span> <span class="entity">l</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword3"><span class="keyword">open</span></span> Method <span class="keyword2"><span class="keyword">in</span></span>
  <span class="main">(</span><span class="entity">Combinator</span> <span class="main">(</span><span class="entity">no_combinator_info</span><span class="main">,</span> <span class="entity">Then</span><span class="main">,</span> map <span class="entity">semi__method</span> <span class="entity">l</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>Position.none<span class="main">,</span> Position.none<span class="main">)</span><span class="main">)</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">local_terminal_proof</span> <span class="entity">o_by</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword3"><span class="keyword">open</span></span> META <span class="keyword2"><span class="keyword">in</span></span> <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">o_by</span> <span class="keyword2"><span class="keyword">of</span></span>
   Command_done <span class="main">=&gt;</span> <span class="entity">Proof.local_done_proof</span>
 <span class="main">|</span> Command_sorry <span class="main">=&gt;</span> <span class="entity">Proof.local_skip_proof</span> true
 <span class="main">|</span> Command_by <span class="entity">l_apply</span> <span class="main">=&gt;</span> <span class="entity">Proof.local_terminal_proof</span> <span class="main">(</span><span class="entity">then_tactic</span> <span class="entity">l_apply</span><span class="main">,</span> NONE<span class="main">)</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">global_terminal_proof</span> <span class="entity">o_by</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword3"><span class="keyword">open</span></span> META <span class="keyword2"><span class="keyword">in</span></span> <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">o_by</span> <span class="keyword2"><span class="keyword">of</span></span>
   Command_done <span class="main">=&gt;</span> <span class="entity">Proof.global_done_proof</span>
 <span class="main">|</span> Command_sorry <span class="main">=&gt;</span> <span class="entity">Proof.global_skip_proof</span> true
 <span class="main">|</span> Command_by <span class="entity">l_apply</span> <span class="main">=&gt;</span> <span class="entity">Proof.global_terminal_proof</span> <span class="main">(</span><span class="entity">then_tactic</span> <span class="entity">l_apply</span><span class="main">,</span> NONE<span class="main">)</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">proof_show_gen</span> <span class="entity">f</span> <span class="main">(</span><span class="entity">thes</span><span class="main">,</span> <span class="entity">thes_when</span><span class="main">)</span> <span class="entity">st</span> <span class="main">=</span> <span class="entity">st</span>
  |&gt; <span class="entity">Proof.proof</span>
       <span class="main">(</span>SOME <span class="main">(</span> <span class="entity">Method.Source</span> <span class="main">[</span>Token.make_string <span class="main">(</span><span class="inner_quoted">"-"</span><span class="main">,</span> Position.none<span class="main">)</span><span class="main">]</span>
             <span class="main">,</span> <span class="main">(</span>Position.none<span class="main">,</span> Position.none<span class="main">)</span><span class="main">)</span><span class="main">)</span>
  |&gt; Seq.the_result <span class="inner_quoted">""</span>
  |&gt; <span class="entity">f</span>
  |&gt; <span class="entity">Proof.show_cmd</span>
       <span class="main">(</span><span class="entity">thes_when</span> <span class="main">=</span> <span class="main">[</span><span class="main">]</span><span class="main">)</span>
       NONE
       <span class="main">(</span>K I<span class="main">)</span>
       <span class="main">[</span><span class="main">]</span>
       <span class="main">(</span><span class="keyword2"><span class="keyword">if</span></span> <span class="entity">thes_when</span> <span class="main">=</span> <span class="main">[</span><span class="main">]</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="main">[</span><span class="main">]</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="main">[</span><span class="main">(</span>Binding.empty_atts<span class="main">,</span> map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">t</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="entity">t</span><span class="main">,</span> <span class="main">[</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="entity">thes_when</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>
       <span class="main">[</span><span class="main">(</span>Binding.empty_atts<span class="main">,</span> <span class="main">[</span><span class="main">(</span><span class="entity">thes</span><span class="main">,</span> <span class="main">[</span><span class="main">]</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">]</span>
       true
  |&gt; snd

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">semi__command_state</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword3"><span class="keyword">open</span></span> META_overload <span class="keyword2"><span class="keyword">in</span></span>
  <span class="keyword1"><span class="keyword">fn</span></span> META.Command_apply_end <span class="entity">l</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">st</span> <span class="main">=&gt;</span> <span class="entity">st</span> |&gt; <span class="entity">Proof.apply_end</span> <span class="main">(</span><span class="entity">then_tactic</span> <span class="entity">l</span><span class="main">)</span>
                                              |&gt; Seq.the_result <span class="inner_quoted">""</span><span class="main">)</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">semi__command_proof</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword3"><span class="keyword">open</span></span> META_overload
                        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">thesis</span> <span class="main">=</span> <span class="inner_quoted">"?thesis"</span>
                        <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">proof_show</span> <span class="entity">f</span> <span class="main">=</span> <span class="entity">proof_show_gen</span> <span class="entity">f</span> <span class="main">(</span><span class="entity">thesis</span><span class="main">,</span> <span class="main">[</span><span class="main">]</span><span class="main">)</span> <span class="keyword2"><span class="keyword">in</span></span>
  <span class="keyword1"><span class="keyword">fn</span></span> META.Command_apply <span class="entity">l</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">st</span> <span class="main">=&gt;</span> <span class="entity">st</span> |&gt; <span class="entity">Proof.apply</span> <span class="main">(</span><span class="entity">then_tactic</span> <span class="entity">l</span><span class="main">)</span>
                                          |&gt; Seq.the_result <span class="inner_quoted">""</span><span class="main">)</span>
   <span class="main">|</span> META.Command_using <span class="entity">l</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">st</span> <span class="main">=&gt;</span>
       <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ctxt</span> <span class="main">=</span> <span class="entity">Proof.context_of</span> <span class="entity">st</span> <span class="keyword2"><span class="keyword">in</span></span>
       <span class="entity">Proof.using</span> <span class="main">[</span>map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">s</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="main">[</span> <span class="entity">s</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="entity">semi__thm_mult_l</span> <span class="entity">ctxt</span> <span class="entity">l</span><span class="main">)</span><span class="main">]</span> <span class="entity">st</span>
       <span class="keyword2"><span class="keyword">end</span></span><span class="main">)</span>
   <span class="main">|</span> META.Command_unfolding <span class="entity">l</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">st</span> <span class="main">=&gt;</span>
       <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ctxt</span> <span class="main">=</span> <span class="entity">Proof.context_of</span> <span class="entity">st</span> <span class="keyword2"><span class="keyword">in</span></span>
       <span class="entity">Proof.unfolding</span> <span class="main">[</span>map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">s</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="main">[</span><span class="entity">s</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="entity">semi__thm_mult_l</span> <span class="entity">ctxt</span> <span class="entity">l</span><span class="main">)</span><span class="main">]</span> <span class="entity">st</span>
       <span class="keyword2"><span class="keyword">end</span></span><span class="main">)</span>
   <span class="main">|</span> META.Command_let <span class="main">(</span><span class="entity">e1</span><span class="main">,</span> <span class="entity">e2</span><span class="main">)</span> <span class="main">=&gt;</span>
       <span class="entity">proof_show</span> <span class="main">(</span><span class="entity">Proof.let_bind_cmd</span> <span class="main">[</span><span class="main">(</span><span class="main">[</span><span class="entity">of_semi__term</span> <span class="entity">e1</span><span class="main">]</span><span class="main">,</span> <span class="entity">of_semi__term</span> <span class="entity">e2</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>
   <span class="main">|</span> META.Command_have <span class="main">(</span><span class="entity">n</span><span class="main">,</span> <span class="entity">b</span><span class="main">,</span> <span class="entity">e</span><span class="main">,</span> <span class="entity">e_pr</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">proof_show</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">st</span> <span class="main">=&gt;</span> <span class="entity">st</span>
       |&gt; <span class="entity">Proof.have_cmd</span> true NONE <span class="main">(</span>K I<span class="main">)</span> <span class="main">[</span><span class="main">]</span> <span class="main">[</span><span class="main">]</span>
                         <span class="main">[</span><span class="main">(</span> <span class="main">(</span><span class="entity">To_sbinding</span> <span class="entity">n</span><span class="main">,</span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">b</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="main">[</span><span class="main">[</span>Token.make_string <span class="main">(</span><span class="inner_quoted">"simp"</span><span class="main">,</span> Position.none<span class="main">)</span><span class="main">]</span><span class="main">]</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="main">[</span><span class="main">]</span><span class="main">)</span>
                          <span class="main">,</span> <span class="main">[</span><span class="main">(</span><span class="entity">of_semi__term</span> <span class="entity">e</span><span class="main">,</span> <span class="main">[</span><span class="main">]</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">]</span>
                         true
       |&gt; snd
       |&gt; <span class="entity">local_terminal_proof</span> <span class="entity">e_pr</span><span class="main">)</span>
   <span class="main">|</span> META.Command_fix_let <span class="main">(</span><span class="entity">l</span><span class="main">,</span> <span class="entity">l_let</span><span class="main">,</span> <span class="entity">o_exp</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> <span class="main">=&gt;</span>
       <span class="entity">proof_show_gen</span> <span class="main">(</span> <span class="entity">fold</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">e1</span><span class="main">,</span> <span class="entity">e2</span><span class="main">)</span> <span class="main">=&gt;</span>
                                <span class="entity">Proof.let_bind_cmd</span> <span class="main">[</span><span class="main">(</span><span class="main">[</span><span class="entity">of_semi__term</span> <span class="entity">e1</span><span class="main">]</span><span class="main">,</span> <span class="entity">of_semi__term</span> <span class="entity">e2</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>
                             <span class="entity">l_let</span>
                      o <span class="entity">Proof.fix_cmd</span> <span class="main">(</span>List.map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">i</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="entity">To_sbinding</span> <span class="entity">i</span><span class="main">,</span> NONE<span class="main">,</span> NoSyn<span class="main">)</span><span class="main">)</span> <span class="entity">l</span><span class="main">)</span><span class="main">)</span>
                      <span class="main">(</span> <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">o_exp</span> <span class="keyword2"><span class="keyword">of</span></span> NONE <span class="main">=&gt;</span> <span class="entity">thesis</span> <span class="main">|</span> SOME <span class="main">(</span><span class="entity">l_spec</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> <span class="main">=&gt;</span>
                         <span class="main">(</span>String.concatWith <span class="main">(</span><span class="inner_quoted">" ⟹ "</span><span class="main">)</span>
                                            <span class="main">(</span>List.map <span class="entity">of_semi__term</span> <span class="entity">l_spec</span><span class="main">)</span><span class="main">)</span>
                      <span class="main">,</span> <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">o_exp</span> <span class="keyword2"><span class="keyword">of</span></span> NONE <span class="main">=&gt;</span> <span class="main">[</span><span class="main">]</span> <span class="main">|</span> SOME <span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="entity">l_when</span><span class="main">)</span> <span class="main">=&gt;</span> List.map <span class="entity">of_semi__term</span> <span class="entity">l_when</span><span class="main">)</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">semi__theory</span> <span class="entity">in_theory</span> <span class="entity">in_local</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword3"><span class="keyword">open</span></span> META <span class="keyword3"><span class="keyword">open</span></span> META_overload <span class="keyword2"><span class="keyword">in</span></span> <span class="comment1">(*let val f = *)</span><span class="keyword1"><span class="keyword">fn</span></span>
  Theory_datatype <span class="main">(</span>Datatype <span class="main">(</span><span class="entity">n</span><span class="main">,</span> <span class="entity">l</span><span class="main">)</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">in_local</span>
   <span class="main">(</span><span class="entity">BNF_FP_Def_Sugar.co_datatype_cmd</span>
      <span class="entity">BNF_Util.Least_FP</span>
      <span class="entity">BNF_LFP.construct_lfp</span>
      <span class="main">(</span><span class="entity">Ctr_Sugar.default_ctr_options_cmd</span><span class="main">,</span>
       <span class="main">[</span><span class="main">(</span> <span class="main">(</span> <span class="main">(</span> <span class="main">(</span><span class="main">(</span><span class="main">[</span><span class="main">]</span><span class="main">,</span> <span class="entity">To_sbinding</span> <span class="entity">n</span><span class="main">)</span><span class="main">,</span> NoSyn<span class="main">)</span>
            <span class="main">,</span> List.map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">n</span><span class="main">,</span> <span class="entity">l</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="main">(</span> <span class="main">(</span> <span class="main">(</span><span class="entity">To_binding</span> <span class="inner_quoted">""</span><span class="main">,</span> <span class="entity">To_sbinding</span> <span class="entity">n</span><span class="main">)</span>
                                       <span class="main">,</span> List.map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">s</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="entity">To_binding</span> <span class="inner_quoted">""</span><span class="main">,</span> <span class="entity">of_semi__typ</span> <span class="entity">s</span><span class="main">)</span><span class="main">)</span> <span class="entity">l</span><span class="main">)</span>
                                     <span class="main">,</span> NoSyn<span class="main">)</span><span class="main">)</span> <span class="entity">l</span><span class="main">)</span>
          <span class="main">,</span> <span class="main">(</span><span class="entity">To_binding</span> <span class="inner_quoted">""</span><span class="main">,</span> <span class="entity">To_binding</span> <span class="inner_quoted">""</span><span class="main">,</span> <span class="entity">To_binding</span> <span class="inner_quoted">""</span><span class="main">)</span><span class="main">)</span>
        <span class="main">,</span> <span class="main">[</span><span class="main">]</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>
<span class="main">|</span> Theory_type_synonym <span class="main">(</span>Type_synonym <span class="main">(</span><span class="entity">n</span><span class="main">,</span> <span class="entity">v</span><span class="main">,</span> <span class="entity">l</span><span class="main">)</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">in_theory</span>
   <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">thy</span> <span class="main">=&gt;</span>
     <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">s_bind</span> <span class="main">=</span> <span class="entity">To_sbinding</span> <span class="entity">n</span> <span class="keyword2"><span class="keyword">in</span></span>
     <span class="main">(</span>snd o <span class="entity">Typedecl.abbrev_global</span>
              <span class="main">(</span><span class="entity">s_bind</span><span class="main">,</span> map <span class="entity">To_string0</span> <span class="entity">v</span><span class="main">,</span> NoSyn<span class="main">)</span>
              <span class="main">(</span><span class="entity">Isabelle_Typedecl.abbrev_cmd0</span> <span class="main">(</span>SOME <span class="entity">s_bind</span><span class="main">)</span> <span class="entity">thy</span> <span class="main">(</span><span class="entity">of_semi__typ</span> <span class="entity">l</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="entity">thy</span>
     <span class="keyword2"><span class="keyword">end</span></span><span class="main">)</span>
<span class="main">|</span> Theory_type_notation <span class="main">(</span>Type_notation <span class="main">(</span><span class="entity">n</span><span class="main">,</span> <span class="entity">e</span><span class="main">)</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">in_local</span>
   <span class="main">(</span><span class="entity">Specification.type_notation_cmd</span> true <span class="main">(</span><span class="inner_quoted">""</span><span class="main">,</span> true<span class="main">)</span> <span class="main">[</span><span class="main">(</span><span class="entity">To_string0</span> <span class="entity">n</span><span class="main">,</span> Mixfix <span class="main">(</span>Input.string <span class="main">(</span><span class="entity">To_string0</span> <span class="entity">e</span><span class="main">)</span><span class="main">,</span> <span class="main">[</span><span class="main">]</span><span class="main">,</span> <span class="inner_numeral">1000</span><span class="main">,</span> Position.no_range<span class="main">)</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>
<span class="main">|</span> Theory_instantiation <span class="main">(</span>Instantiation <span class="main">(</span><span class="entity">n</span><span class="main">,</span> <span class="entity">n_def</span><span class="main">,</span> <span class="entity">expr</span><span class="main">)</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">in_theory</span>
   <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">thy</span> <span class="main">=&gt;</span>
     <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">name</span> <span class="main">=</span> <span class="entity">To_string0</span> <span class="entity">n</span>
         <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">tycos</span> <span class="main">=</span>
           <span class="main">[</span> <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> Term.Type <span class="main">(</span><span class="entity">s</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="entity">Isabelle_Typedecl.abbrev_cmd0</span> NONE <span class="entity">thy</span> <span class="entity">name</span><span class="main">)</span> <span class="keyword2"><span class="keyword">in</span></span> <span class="entity">s</span> <span class="keyword2"><span class="keyword">end</span></span> <span class="main">]</span> <span class="keyword2"><span class="keyword">in</span></span>
    <span class="entity">thy</span>
    |&gt; <span class="entity">Class.instantiation</span> <span class="main">(</span><span class="entity">tycos</span><span class="main">,</span> <span class="main">[</span><span class="main">]</span><span class="main">,</span> Syntax.read_sort <span class="main">(</span>Proof_Context.init_global <span class="entity">thy</span><span class="main">)</span> <span class="inner_quoted">"object"</span><span class="main">)</span>
    |&gt; fold_map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">thy</span> <span class="main">=&gt;</span>
        <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="entity">ty</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="entity">thy</span><span class="main">)</span> <span class="main">=</span> <span class="entity">Specification.definition_cmd</span>
                                       NONE <span class="main">[</span><span class="main">]</span> <span class="main">[</span><span class="main">]</span>
                                       <span class="main">(</span><span class="main">(</span><span class="entity">To_binding</span> <span class="main">(</span><span class="entity">To_string0</span> <span class="entity">n_def</span> ^ <span class="inner_quoted">"_"</span> ^ <span class="entity">name</span> ^ <span class="inner_quoted">"_def"</span><span class="main">)</span><span class="main">,</span> <span class="main">[</span><span class="main">]</span><span class="main">)</span>
                                         <span class="main">,</span> <span class="entity">of_semi__term</span> <span class="entity">expr</span><span class="main">)</span> false <span class="entity">thy</span> <span class="keyword2"><span class="keyword">in</span></span>
         <span class="main">(</span><span class="entity">ty</span><span class="main">,</span> <span class="entity">thy</span><span class="main">)</span>
        <span class="keyword2"><span class="keyword">end</span></span><span class="main">)</span> <span class="entity">tycos</span>
    |-&gt; <span class="entity">Class.prove_instantiation_exit_result</span> <span class="main">(</span>map o Morphism.thm<span class="main">)</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">ctxt</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">thms</span> <span class="main">=&gt;</span>
         <span class="entity">Class.intro_classes_tac</span> <span class="entity">ctxt</span> <span class="main">[</span><span class="main">]</span> THEN ALLGOALS <span class="main">(</span>Proof_Context.fact_tac <span class="entity">ctxt</span> <span class="entity">thms</span><span class="main">)</span><span class="main">)</span>
    |-&gt; K I
     <span class="keyword2"><span class="keyword">end</span></span><span class="main">)</span>
<span class="main">|</span> Theory_overloading <span class="main">(</span>Overloading <span class="main">(</span><span class="entity">n_c</span><span class="main">,</span> <span class="entity">e_c</span><span class="main">,</span> <span class="entity">n</span><span class="main">,</span> <span class="entity">e</span><span class="main">)</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">in_theory</span>
   <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">thy</span> <span class="main">=&gt;</span> <span class="entity">thy</span>
    |&gt; <span class="entity">Overloading.overloading_cmd</span> <span class="main">[</span><span class="main">(</span><span class="entity">To_string0</span> <span class="entity">n_c</span><span class="main">,</span> <span class="entity">of_semi__term</span> <span class="entity">e_c</span><span class="main">,</span> true<span class="main">)</span><span class="main">]</span>
    |&gt; snd o <span class="entity">Specification.definition_cmd</span> NONE <span class="main">[</span><span class="main">]</span> <span class="main">[</span><span class="main">]</span> <span class="main">(</span><span class="main">(</span><span class="entity">To_sbinding</span> <span class="entity">n</span><span class="main">,</span> <span class="main">[</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> <span class="entity">of_semi__term</span> <span class="entity">e</span><span class="main">)</span> false
    |&gt; Local_Theory.exit_global<span class="main">)</span>
<span class="main">|</span> Theory_consts <span class="main">(</span>Consts <span class="main">(</span><span class="entity">n</span><span class="main">,</span> <span class="entity">ty</span><span class="main">,</span> <span class="entity">symb</span><span class="main">)</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">in_theory</span>
   <span class="main">(</span>Sign.add_consts_cmd <span class="main">[</span><span class="main">(</span> <span class="entity">To_sbinding</span> <span class="entity">n</span>
                        <span class="main">,</span> <span class="entity">of_semi__typ</span> <span class="entity">ty</span>
                        <span class="main">,</span> Mixfix <span class="main">(</span>Input.string <span class="main">(</span><span class="inner_quoted">"(_) "</span> ^ <span class="entity">To_string0</span> <span class="entity">symb</span><span class="main">)</span><span class="main">,</span> <span class="main">[</span><span class="main">]</span><span class="main">,</span> <span class="inner_numeral">1000</span><span class="main">,</span> Position.no_range<span class="main">)</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>
<span class="main">|</span> Theory_definition <span class="entity">def</span> <span class="main">=&gt;</span> <span class="entity">in_local</span>
    <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">def</span><span class="main">,</span> <span class="entity">e</span><span class="main">)</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">def</span> <span class="keyword2"><span class="keyword">of</span></span>
        Definition <span class="entity">e</span> <span class="main">=&gt;</span> <span class="main">(</span>NONE<span class="main">,</span> <span class="entity">e</span><span class="main">)</span>
      <span class="main">|</span> Definition_where1 <span class="main">(</span><span class="entity">name</span><span class="main">,</span> <span class="main">(</span><span class="entity">abbrev</span><span class="main">,</span> <span class="entity">prio</span><span class="main">)</span><span class="main">,</span> <span class="entity">e</span><span class="main">)</span> <span class="main">=&gt;</span>
          <span class="main">(</span>SOME <span class="main">(</span> <span class="entity">To_sbinding</span> <span class="entity">name</span>
                <span class="main">,</span> NONE
                <span class="main">,</span> Mixfix <span class="main">(</span>Input.string <span class="main">(</span><span class="inner_quoted">"(1"</span> ^ <span class="entity">of_semi__term</span> <span class="entity">abbrev</span> ^ <span class="inner_quoted">")"</span><span class="main">)</span><span class="main">,</span> <span class="main">[</span><span class="main">]</span><span class="main">,</span> Code_Numeral.integer_of_natural <span class="entity">prio</span><span class="main">,</span> Position.no_range<span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="entity">e</span><span class="main">)</span>
      <span class="main">|</span> Definition_where2 <span class="main">(</span><span class="entity">name</span><span class="main">,</span> <span class="entity">abbrev</span><span class="main">,</span> <span class="entity">e</span><span class="main">)</span> <span class="main">=&gt;</span>
          <span class="main">(</span>SOME <span class="main">(</span> <span class="entity">To_sbinding</span> <span class="entity">name</span>
                <span class="main">,</span> NONE
                <span class="main">,</span> Mixfix <span class="main">(</span>Input.string <span class="main">(</span><span class="inner_quoted">"("</span> ^ <span class="entity">of_semi__term</span> <span class="entity">abbrev</span> ^ <span class="inner_quoted">")"</span><span class="main">)</span><span class="main">,</span> <span class="main">[</span><span class="main">]</span><span class="main">,</span> <span class="inner_numeral">1000</span><span class="main">,</span> Position.no_range<span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="entity">e</span><span class="main">)</span> <span class="keyword2"><span class="keyword">in</span></span>
    <span class="main">(</span>snd o <span class="entity">Specification.definition_cmd</span> <span class="entity">def</span> <span class="main">[</span><span class="main">]</span> <span class="main">[</span><span class="main">]</span> <span class="main">(</span>Binding.empty_atts<span class="main">,</span> <span class="entity">of_semi__term</span> <span class="entity">e</span><span class="main">)</span> false<span class="main">)</span>
    <span class="keyword2"><span class="keyword">end</span></span>
<span class="main">|</span> Theory_lemmas <span class="main">(</span>Lemmas_simp_thm <span class="main">(</span><span class="entity">simp</span><span class="main">,</span> <span class="entity">s</span><span class="main">,</span> <span class="entity">l</span><span class="main">)</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">in_local</span>
   <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">lthy</span> <span class="main">=&gt;</span> <span class="main">(</span>snd o <span class="entity">Specification.theorems</span> Thm.theoremK
      <span class="main">[</span><span class="main">(</span><span class="main">(</span><span class="entity">To_sbinding</span> <span class="entity">s</span><span class="main">,</span> List.map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">s</span> <span class="main">=&gt;</span> <span class="entity">Attrib.check_src</span> <span class="entity">lthy</span> <span class="main">[</span>Token.make_string <span class="main">(</span><span class="entity">s</span><span class="main">,</span> Position.none<span class="main">)</span><span class="main">]</span><span class="main">)</span>
                          <span class="main">(</span><span class="keyword2"><span class="keyword">if</span></span> <span class="entity">simp</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="main">[</span><span class="inner_quoted">"simp"</span><span class="main">,</span> <span class="inner_quoted">"code_unfold"</span><span class="main">]</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="main">[</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
        List.map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">x</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="main">[</span><span class="entity">semi__thm_attribute_single</span> <span class="entity">lthy</span> <span class="entity">x</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="entity">l</span><span class="main">)</span><span class="main">]</span>
      <span class="main">[</span><span class="main">]</span>
      false<span class="main">)</span> <span class="entity">lthy</span><span class="main">)</span>
<span class="main">|</span> Theory_lemmas <span class="main">(</span>Lemmas_simp_thms <span class="main">(</span><span class="entity">s</span><span class="main">,</span> <span class="entity">l</span><span class="main">)</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">in_local</span>
   <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">lthy</span> <span class="main">=&gt;</span> <span class="main">(</span>snd o <span class="entity">Specification.theorems</span> Thm.theoremK
      <span class="main">[</span><span class="main">(</span><span class="main">(</span><span class="entity">To_sbinding</span> <span class="entity">s</span><span class="main">,</span> List.map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">s</span> <span class="main">=&gt;</span> <span class="entity">Attrib.check_src</span> <span class="entity">lthy</span> <span class="main">[</span>Token.make_string <span class="main">(</span><span class="entity">s</span><span class="main">,</span> Position.none<span class="main">)</span><span class="main">]</span><span class="main">)</span>
                          <span class="main">[</span><span class="inner_quoted">"simp"</span><span class="main">,</span> <span class="inner_quoted">"code_unfold"</span><span class="main">]</span><span class="main">)</span><span class="main">,</span>
        List.map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">x</span> <span class="main">=&gt;</span> <span class="main">(</span>Proof_Context.get_thms <span class="entity">lthy</span> <span class="main">(</span><span class="entity">To_string0</span> <span class="entity">x</span><span class="main">)</span><span class="main">,</span> <span class="main">[</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="entity">l</span><span class="main">)</span><span class="main">]</span>
      <span class="main">[</span><span class="main">]</span>
      false<span class="main">)</span> <span class="entity">lthy</span><span class="main">)</span>
<span class="main">|</span> Theory_lemma <span class="main">(</span>Lemma <span class="main">(</span><span class="entity">n</span><span class="main">,</span> <span class="entity">l_spec</span><span class="main">,</span> <span class="entity">l_apply</span><span class="main">,</span> <span class="entity">o_by</span><span class="main">)</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">in_local</span>
   <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">lthy</span> <span class="main">=&gt;</span>
           <span class="entity">Specification.theorem_cmd</span> true Thm.theoremK NONE <span class="main">(</span>K I<span class="main">)</span>
             Binding.empty_atts <span class="main">[</span><span class="main">]</span> <span class="main">[</span><span class="main">]</span> <span class="main">(</span><span class="entity">Element.Shows</span> <span class="main">[</span><span class="main">(</span><span class="main">(</span><span class="entity">To_sbinding</span> <span class="entity">n</span><span class="main">,</span> <span class="main">[</span><span class="main">]</span><span class="main">)</span>
                                                       <span class="main">,</span><span class="main">[</span><span class="main">(</span><span class="main">(</span>String.concatWith <span class="main">(</span><span class="inner_quoted">" ⟹ "</span><span class="main">)</span>
                                                             <span class="main">(</span>List.map <span class="entity">of_semi__term</span> <span class="entity">l_spec</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="main">[</span><span class="main">]</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>
             false <span class="entity">lthy</span>
        |&gt; <span class="entity">fold</span> <span class="main">(</span><span class="entity">semi__command_proof</span> o META.Command_apply<span class="main">)</span> <span class="entity">l_apply</span>
        |&gt; <span class="entity">global_terminal_proof</span> <span class="entity">o_by</span><span class="main">)</span>
<span class="main">|</span> Theory_lemma <span class="main">(</span>Lemma_assumes <span class="main">(</span><span class="entity">n</span><span class="main">,</span> <span class="entity">l_spec</span><span class="main">,</span> <span class="entity">concl</span><span class="main">,</span> <span class="entity">l_apply</span><span class="main">,</span> <span class="entity">o_by</span><span class="main">)</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">in_local</span>
   <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">lthy</span> <span class="main">=&gt;</span> <span class="entity">lthy</span>
        |&gt; <span class="entity">Specification.theorem_cmd</span> true Thm.theoremK NONE <span class="main">(</span>K I<span class="main">)</span>
             <span class="main">(</span><span class="entity">To_sbinding</span> <span class="entity">n</span><span class="main">,</span> <span class="main">[</span><span class="main">]</span><span class="main">)</span>
             <span class="main">[</span><span class="main">]</span>
             <span class="main">(</span>List.map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">n</span><span class="main">,</span> <span class="main">(</span><span class="entity">b</span><span class="main">,</span> <span class="entity">e</span><span class="main">)</span><span class="main">)</span> <span class="main">=&gt;</span>
                         <span class="entity">Element.Assumes</span> <span class="main">[</span><span class="main">(</span> <span class="main">(</span> <span class="entity">To_sbinding</span> <span class="entity">n</span>
                                            <span class="main">,</span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">b</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="main">[</span><span class="main">[</span>Token.make_string <span class="main">(</span><span class="inner_quoted">"simp"</span><span class="main">,</span> Position.none<span class="main">)</span><span class="main">]</span><span class="main">]</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="main">[</span><span class="main">]</span><span class="main">)</span>
                                          <span class="main">,</span> <span class="main">[</span><span class="main">(</span><span class="entity">of_semi__term</span> <span class="entity">e</span><span class="main">,</span> <span class="main">[</span><span class="main">]</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>
                       <span class="entity">l_spec</span><span class="main">)</span>
             <span class="main">(</span><span class="entity">Element.Shows</span> <span class="main">[</span><span class="main">(</span>Binding.empty_atts<span class="main">,</span> <span class="main">[</span><span class="main">(</span><span class="entity">of_semi__term</span> <span class="entity">concl</span><span class="main">,</span> <span class="main">[</span><span class="main">]</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>
             false
        |&gt; <span class="entity">fold</span> <span class="entity">semi__command_proof</span> <span class="entity">l_apply</span>
        |&gt; <span class="main">(</span><span class="keyword2"><span class="keyword">case</span></span> map_filter <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> META.Command_let <span class="main">_</span> <span class="main">=&gt;</span> SOME <span class="main">[</span><span class="main">]</span>
                              <span class="main">|</span> META.Command_have <span class="main">_</span> <span class="main">=&gt;</span> SOME <span class="main">[</span><span class="main">]</span>
                              <span class="main">|</span> META.Command_fix_let <span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">,</span> <span class="entity">l</span><span class="main">)</span> <span class="main">=&gt;</span> SOME <span class="entity">l</span>
                              <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> NONE<span class="main">)</span>
                            <span class="main">(</span>rev <span class="entity">l_apply</span><span class="main">)</span> <span class="keyword2"><span class="keyword">of</span></span>
              <span class="main">[</span><span class="main">]</span> <span class="main">=&gt;</span> <span class="entity">global_terminal_proof</span> <span class="entity">o_by</span>
            <span class="main">|</span> <span class="main">_</span> :: <span class="entity">l</span> <span class="main">=&gt;</span> <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">arg</span> <span class="main">=</span> <span class="main">(</span>NONE<span class="main">,</span> true<span class="main">)</span> <span class="keyword2"><span class="keyword">in</span></span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">st</span> <span class="main">=&gt;</span> <span class="entity">st</span>
              |&gt; <span class="entity">local_terminal_proof</span> <span class="entity">o_by</span>
              |&gt; <span class="entity">fold</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">l</span> <span class="main">=&gt;</span> <span class="entity">fold</span> <span class="entity">semi__command_state</span> <span class="entity">l</span> o <span class="entity">Proof.local_qed</span> <span class="entity">arg</span><span class="main">)</span> <span class="entity">l</span>
              |&gt; <span class="entity">Proof.global_qed</span> <span class="entity">arg</span> <span class="keyword2"><span class="keyword">end</span></span><span class="main">)</span><span class="main">)</span>
<span class="main">|</span> Theory_axiomatization <span class="main">(</span>Axiomatization <span class="main">(</span><span class="entity">n</span><span class="main">,</span> <span class="entity">e</span><span class="main">)</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">in_theory</span>
   <span class="main">(</span><span class="main">#</span><span class="inner_numeral">2</span> o <span class="entity">Specification.axiomatization_cmd</span> <span class="main">[</span><span class="main">]</span> <span class="main">[</span><span class="main">]</span> <span class="main">[</span><span class="main">]</span> <span class="main">[</span><span class="main">(</span><span class="main">(</span><span class="entity">To_sbinding</span> <span class="entity">n</span><span class="main">,</span> <span class="main">[</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> <span class="entity">of_semi__term</span> <span class="entity">e</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>
<span class="main">|</span> Theory_section <span class="main">_</span> <span class="main">=&gt;</span> <span class="entity">in_theory</span> I
<span class="main">|</span> Theory_text <span class="main">_</span> <span class="main">=&gt;</span> <span class="entity">in_theory</span> I
<span class="main">|</span> Theory_ML <span class="main">(</span>SML <span class="entity">ml</span><span class="main">)</span> <span class="main">=&gt;</span>
    <span class="entity">in_theory</span> <span class="main">(</span><span class="entity">Code_printing.reflect_ml</span> <span class="main">(</span>Input.source false <span class="main">(</span><span class="entity">of_semi__term'</span> <span class="entity">ml</span><span class="main">)</span>
                                                            <span class="main">(</span>Position.none<span class="main">,</span> Position.none<span class="main">)</span><span class="main">)</span><span class="main">)</span>
<span class="main">|</span> Theory_setup <span class="main">(</span>Setup <span class="entity">ml</span><span class="main">)</span> <span class="main">=&gt;</span>
    <span class="entity">in_theory</span> <span class="main">(</span><span class="entity">Isar_Cmd.setup</span> <span class="main">(</span>Input.source false <span class="main">(</span><span class="entity">of_semi__term'</span> <span class="entity">ml</span><span class="main">)</span>
                                                  <span class="main">(</span>Position.none<span class="main">,</span> Position.none<span class="main">)</span><span class="main">)</span><span class="main">)</span>
<span class="main">|</span> Theory_thm <span class="main">(</span>Thm <span class="entity">thm</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">in_local</span>
   <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">lthy</span> <span class="main">=&gt;</span>
    <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="main">)</span> <span class="main">=</span>
      writeln
        <span class="main">(</span>Pretty.string_of
          <span class="main">(</span>Proof_Context.pretty_fact <span class="entity">lthy</span> <span class="main">(</span><span class="inner_quoted">""</span><span class="main">,</span> List.map <span class="main">(</span><span class="entity">semi__thm_attribute_single</span> <span class="entity">lthy</span><span class="main">)</span> <span class="entity">thm</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword2"><span class="keyword">in</span></span>
    <span class="entity">lthy</span>
    <span class="keyword2"><span class="keyword">end</span></span><span class="main">)</span>
<span class="main">|</span> Theory_interpretation <span class="main">(</span>Interpretation <span class="main">(</span><span class="entity">n</span><span class="main">,</span> <span class="entity">loc_n</span><span class="main">,</span> <span class="entity">loc_param</span><span class="main">,</span> <span class="entity">o_by</span><span class="main">)</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">in_local</span>
   <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">lthy</span> <span class="main">=&gt;</span> <span class="entity">lthy</span>
    |&gt; <span class="entity">Interpretation.interpretation_cmd</span> <span class="main">(</span> <span class="main">[</span> <span class="main">(</span> <span class="main">(</span><span class="entity">To_string0</span> <span class="entity">loc_n</span><span class="main">,</span> Position.none<span class="main">)</span>
                                         <span class="main">,</span> <span class="main">(</span> <span class="main">(</span><span class="entity">To_string0</span> <span class="entity">n</span><span class="main">,</span> true<span class="main">)</span>
                                           <span class="main">,</span> <span class="main">(</span><span class="keyword2"><span class="keyword">if</span></span> <span class="entity">loc_param</span> <span class="main">=</span> <span class="main">[</span><span class="main">]</span> <span class="keyword2"><span class="keyword">then</span></span>
                                               <span class="entity">Expression.Named</span> <span class="main">[</span><span class="main">]</span>
                                             <span class="keyword2"><span class="keyword">else</span></span>
                                               <span class="entity">Expression.Positional</span> <span class="main">(</span>map <span class="main">(</span>SOME o <span class="entity">of_semi__term</span><span class="main">)</span>
                                                                          <span class="entity">loc_param</span><span class="main">)</span><span class="main">,</span> <span class="main">[</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">]</span>
                                     <span class="main">,</span> <span class="main">[</span><span class="main">]</span><span class="main">)</span>
    |&gt; <span class="entity">global_terminal_proof</span> <span class="entity">o_by</span><span class="main">)</span>
<span class="comment1">(*in fn t =&gt; fn thy =&gt; f t thy handle ERROR s =&gt; (warning s; thy)
 end*)</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">Bind_META</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">struct</span></span> <span class="keyword3"><span class="keyword">open</span></span> <span class="entity">Bind_Isabelle</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">all_meta</span> <span class="entity">aux</span> <span class="entity">ret</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword3"><span class="keyword">open</span></span> META <span class="keyword3"><span class="keyword">open</span></span> META_overload <span class="keyword2"><span class="keyword">in</span></span> <span class="keyword1"><span class="keyword">fn</span></span>
  META_semi_theories <span class="entity">thy</span> <span class="main">=&gt;</span>
    <span class="entity">ret</span> o <span class="main">(</span><span class="keyword2"><span class="keyword">case</span></span> <span class="entity">thy</span> <span class="keyword2"><span class="keyword">of</span></span>
       Theories_one <span class="entity">thy</span> <span class="main">=&gt;</span> <span class="entity">semi__theory</span> I <span class="entity">Named_Target.theory_map</span> <span class="entity">thy</span>
     <span class="main">|</span> Theories_locale <span class="main">(</span><span class="entity">data</span><span class="main">,</span> <span class="entity">l</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">thy</span> <span class="main">=&gt;</span> <span class="entity">thy</span>
       |&gt; <span class="main">(</span>   <span class="entity">Expression.add_locale_cmd</span>
                <span class="main">(</span><span class="entity">To_sbinding</span> <span class="main">(</span>META.holThyLocale_name <span class="entity">data</span><span class="main">)</span><span class="main">)</span>
                Binding.empty
                <span class="main">[</span><span class="main">]</span>
                <span class="main">(</span><span class="main">[</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span><span class="main">]</span><span class="main">)</span>
                <span class="main">(</span>List.concat
                  <span class="main">(</span>map
                    <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">fixes</span><span class="main">,</span> <span class="entity">assumes</span><span class="main">)</span> <span class="main">=&gt;</span> List.concat
                      <span class="main">[</span> map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">e</span><span class="main">,</span><span class="entity">ty</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">Element.Fixes</span> <span class="main">[</span><span class="main">(</span> <span class="entity">To_binding</span> <span class="main">(</span><span class="entity">of_semi__term</span> <span class="entity">e</span><span class="main">)</span>
                                                         <span class="main">,</span> SOME <span class="main">(</span><span class="entity">of_semi__typ</span> <span class="entity">ty</span><span class="main">)</span>
                                                         <span class="main">,</span> NoSyn<span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="entity">fixes</span>
                      <span class="main">,</span> <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">assumes</span> <span class="keyword2"><span class="keyword">of</span></span> NONE <span class="main">=&gt;</span> <span class="main">[</span><span class="main">]</span>
                                      <span class="main">|</span> SOME <span class="main">(</span><span class="entity">n</span><span class="main">,</span> <span class="entity">e</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="main">[</span><span class="entity">Element.Assumes</span> <span class="main">[</span><span class="main">(</span> <span class="main">(</span><span class="entity">To_sbinding</span> <span class="entity">n</span><span class="main">,</span> <span class="main">[</span><span class="main">]</span><span class="main">)</span>
                                                                         <span class="main">,</span> <span class="main">[</span><span class="main">(</span><span class="entity">of_semi__term</span> <span class="entity">e</span><span class="main">,</span> <span class="main">[</span><span class="main">]</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">]</span><span class="main">]</span><span class="main">]</span><span class="main">)</span>
                    <span class="main">(</span>META.holThyLocale_header <span class="entity">data</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
           #&gt; snd<span class="main">)</span>
       |&gt; <span class="entity">fold</span> <span class="main">(</span><span class="entity">fold</span> <span class="main">(</span><span class="entity">semi__theory</span> Local_Theory.background_theory
                                   <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">f</span> <span class="main">=&gt;</span>
                                     Local_Theory.new_group
                                     #&gt; <span class="entity">f</span>
                                     #&gt; Local_Theory.reset_group
                                     #&gt; <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">lthy</span> <span class="main">=&gt;</span>
                                          <span class="main">#</span><span class="inner_numeral">1</span> <span class="main">(</span><span class="entity">Target_Context.switch_named_cmd</span> NONE <span class="main">(</span>Context.Proof <span class="entity">lthy</span><span class="main">)</span><span class="main">)</span> <span class="entity">lthy</span>
                                          |&gt; Context.the_proof<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="entity">l</span>
       |&gt; Local_Theory.exit_global<span class="main">)</span>
<span class="main">|</span> META_boot_generation_syntax <span class="main">_</span> <span class="main">=&gt;</span> <span class="entity">ret</span> o I
<span class="main">|</span> META_boot_setup_env <span class="main">_</span> <span class="main">=&gt;</span> <span class="entity">ret</span> o I
<span class="main">|</span> META_all_meta_embedding <span class="entity">meta</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">thy</span> <span class="main">=&gt;</span>
  <span class="entity">aux</span>
    <span class="main">(</span>map2_ctxt_term
      <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> T_pure <span class="entity">x</span> <span class="main">=&gt;</span> T_pure <span class="entity">x</span>
        <span class="main">|</span> <span class="entity">e</span> <span class="main">=&gt;</span>
          <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">aux</span> <span class="entity">e</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">e</span> <span class="keyword2"><span class="keyword">of</span></span>
            T_to_be_parsed <span class="main">(</span><span class="entity">s</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> <span class="main">=&gt;</span> SOME <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">t</span> <span class="main">=</span> Syntax.read_term <span class="main">(</span>Proof_Context.init_global <span class="entity">thy</span><span class="main">)</span>
                                                                       <span class="main">(</span><span class="entity">To_string0</span> <span class="entity">s</span><span class="main">)</span> <span class="keyword2"><span class="keyword">in</span></span>
                                          <span class="main">(</span><span class="entity">t</span><span class="main">,</span> Term.add_frees <span class="entity">t</span> <span class="main">[</span><span class="main">]</span><span class="main">)</span>
                                          <span class="keyword2"><span class="keyword">end</span></span>
          <span class="main">|</span> T_lambda <span class="main">(</span><span class="entity">a</span><span class="main">,</span> <span class="entity">e</span><span class="main">)</span> <span class="main">=&gt;</span>
            Option.map
              <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">e</span><span class="main">,</span> <span class="entity">l_free</span><span class="main">)</span> <span class="main">=&gt;</span>
               <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">a</span> <span class="main">=</span> <span class="entity">To_string0</span> <span class="entity">a</span>
                   <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">t</span><span class="main">,</span> <span class="entity">l_free</span><span class="main">)</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">case</span></span> List.partition <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">x</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">x</span> <span class="main">=</span> <span class="entity">a</span><span class="main">)</span> <span class="entity">l_free</span> <span class="keyword2"><span class="keyword">of</span></span>
                                       <span class="main">(</span><span class="main">[</span><span class="main">]</span><span class="main">,</span> <span class="entity">l_free</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="main">(</span>Term.TFree <span class="main">(</span><span class="inner_quoted">"'a"</span><span class="main">,</span> <span class="main">[</span><span class="inner_quoted">"HOL.type"</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> <span class="entity">l_free</span><span class="main">)</span>
                                     <span class="main">|</span> <span class="main">(</span><span class="main">[</span><span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="entity">t</span><span class="main">)</span><span class="main">]</span><span class="main">,</span> <span class="entity">l_free</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="entity">t</span><span class="main">,</span> <span class="entity">l_free</span><span class="main">)</span> <span class="keyword2"><span class="keyword">in</span></span>
               <span class="main">(</span>lambda <span class="main">(</span>Term.Free <span class="main">(</span><span class="entity">a</span><span class="main">,</span> <span class="entity">t</span><span class="main">)</span><span class="main">)</span> <span class="entity">e</span><span class="main">,</span> <span class="entity">l_free</span><span class="main">)</span>
               <span class="keyword2"><span class="keyword">end</span></span><span class="main">)</span>
              <span class="main">(</span><span class="entity">aux</span> <span class="entity">e</span><span class="main">)</span>
          <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> NONE <span class="keyword2"><span class="keyword">in</span></span>
          <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">aux</span> <span class="entity">e</span> <span class="keyword2"><span class="keyword">of</span></span>
            NONE <span class="main">=&gt;</span> error <span class="inner_quoted">"nested pure expression not expected"</span>
          <span class="main">|</span> SOME <span class="main">(</span><span class="entity">e</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> <span class="main">=&gt;</span> META.T_pure <span class="main">(</span><span class="entity">From.Pure.term</span> <span class="entity">e</span><span class="main">)</span>
          <span class="keyword2"><span class="keyword">end</span></span><span class="main">)</span> <span class="entity">meta</span><span class="main">)</span> <span class="entity">thy</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
›</span>
<span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Directives of Compilation for Target Languages›</span></span>

<span class="keyword1"><span class="command">ML</span></span><span class="quoted">‹
<span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">Deep0</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">struct</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">apply_hs_code_identifiers</span> <span class="entity">ml_module</span> <span class="entity">thy</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mod_hs</span> <span class="main">(</span><span class="entity">fic</span><span class="main">,</span> <span class="entity">ml_module</span><span class="main">)</span> <span class="main">=</span> <span class="entity">Code_Symbol.Module</span> <span class="main">(</span><span class="entity">fic</span><span class="main">,</span> <span class="main">[</span><span class="main">(</span><span class="inner_quoted">"Haskell"</span><span class="main">,</span> SOME <span class="entity">ml_module</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="keyword2"><span class="keyword">in</span></span>
  fold <span class="main">(</span><span class="entity">Code_Target.set_identifiers</span> o <span class="entity">mod_hs</span><span class="main">)</span>
    <span class="main">(</span>map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">x</span> <span class="main">=&gt;</span> <span class="main">(</span>Context.theory_name <span class="entity">x</span><span class="main">,</span> <span class="entity">ml_module</span><span class="main">)</span><span class="main">)</span>
         <span class="comment1">(* list of .hs files that will be merged together in "ml_module" *)</span>
         <span class="main">(</span> <span class="entity">thy</span>
           :: <span class="comment1">(* we over-approximate the set of compiler files *)</span>
              Context.ancestors_of <span class="entity">thy</span><span class="main">)</span><span class="main">)</span> <span class="entity">thy</span> <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">default_key</span> <span class="main">=</span> <span class="inner_quoted">""</span>

<span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">Export_code_env</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">struct</span></span>
  <span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">Isabelle</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">struct</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">function</span> <span class="main">=</span> <span class="inner_quoted">"write_file"</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">argument_main</span> <span class="main">=</span> <span class="inner_quoted">"main"</span>
  <span class="keyword2"><span class="keyword">end</span></span>

  <span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">Haskell</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">struct</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">function</span> <span class="main">=</span> <span class="inner_quoted">"Function"</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">argument</span> <span class="main">=</span> <span class="inner_quoted">"Argument"</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">main</span> <span class="main">=</span> <span class="inner_quoted">"Main"</span>
    <span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">Filename</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">struct</span></span>
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">hs_function</span> <span class="entity">ext</span> <span class="main">=</span> <span class="entity">function</span> ^ <span class="inner_quoted">"."</span> ^ <span class="entity">ext</span>
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">hs_argument</span> <span class="entity">ext</span> <span class="main">=</span> <span class="entity">argument</span> ^ <span class="inner_quoted">"."</span> ^ <span class="entity">ext</span>
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">hs_main</span> <span class="entity">ext</span> <span class="main">=</span> <span class="entity">main</span> ^ <span class="inner_quoted">"."</span> ^ <span class="entity">ext</span>
    <span class="keyword2"><span class="keyword">end</span></span>
  <span class="keyword2"><span class="keyword">end</span></span>

  <span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">OCaml</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">struct</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">make</span> <span class="main">=</span> <span class="inner_quoted">"write"</span>
    <span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">Filename</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">struct</span></span>
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">function</span> <span class="entity">ext</span> <span class="main">=</span> <span class="inner_quoted">"function."</span> ^ <span class="entity">ext</span>
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">argument</span> <span class="entity">ext</span> <span class="main">=</span> <span class="inner_quoted">"argument."</span> ^ <span class="entity">ext</span>
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">main_fic</span> <span class="entity">ext</span> <span class="main">=</span> <span class="inner_quoted">"main."</span> ^ <span class="entity">ext</span>
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">makefile</span> <span class="entity">ext</span> <span class="main">=</span> <span class="entity">make</span> ^ <span class="inner_quoted">"."</span> ^ <span class="entity">ext</span>
    <span class="keyword2"><span class="keyword">end</span></span>
  <span class="keyword2"><span class="keyword">end</span></span>

  <span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">Scala</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">struct</span></span>
    <span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">Filename</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">struct</span></span>
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">function</span> <span class="entity">ext</span> <span class="main">=</span> <span class="inner_quoted">"Function."</span> ^ <span class="entity">ext</span>
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">argument</span> <span class="entity">ext</span> <span class="main">=</span> <span class="inner_quoted">"Argument."</span> ^ <span class="entity">ext</span>
    <span class="keyword2"><span class="keyword">end</span></span>
  <span class="keyword2"><span class="keyword">end</span></span>

  <span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">SML</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">struct</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">main</span> <span class="main">=</span> <span class="inner_quoted">"Run"</span>
    <span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">Filename</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">struct</span></span>
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">function</span> <span class="entity">ext</span> <span class="main">=</span> <span class="inner_quoted">"Function."</span> ^ <span class="entity">ext</span>
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">argument</span> <span class="entity">ext</span> <span class="main">=</span> <span class="inner_quoted">"Argument."</span> ^ <span class="entity">ext</span>
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">stdout</span> <span class="entity">ext</span> <span class="main">=</span> <span class="inner_quoted">"Stdout."</span> ^ <span class="entity">ext</span>
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">main_fic</span> <span class="entity">ext</span> <span class="main">=</span> <span class="entity">main</span> ^ <span class="inner_quoted">"."</span> ^ <span class="entity">ext</span>
    <span class="keyword2"><span class="keyword">end</span></span>
  <span class="keyword2"><span class="keyword">end</span></span>

  <span class="keyword1"><span class="keyword">datatype</span></span> <span class="entity">file_input</span> <span class="main">=</span> <span class="entity">File</span>
                      <span class="main">|</span> <span class="entity">Directory</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">compile</span> <span class="entity">l</span> <span class="entity">cmd</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">l</span><span class="main">,</span> <span class="entity">rc</span><span class="main">)</span> <span class="main">=</span> fold <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">cmd</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">l</span><span class="main">,</span> <span class="inner_numeral">0</span><span class="main">)</span> <span class="main">=&gt;</span>
                                         <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="main">{</span><span class="entity">out</span><span class="main">,</span> <span class="entity">err</span><span class="main">,</span> <span class="entity">rc</span><span class="main">,</span> <span class="main">...</span><span class="main">}</span> <span class="main">=</span> <span class="entity">Bash.process</span> <span class="entity">cmd</span> <span class="keyword2"><span class="keyword">in</span></span>
                                         <span class="main">(</span><span class="main">(</span><span class="entity">out</span><span class="main">,</span> <span class="entity">err</span><span class="main">)</span> :: <span class="entity">l</span><span class="main">,</span> <span class="entity">rc</span><span class="main">)</span> <span class="keyword2"><span class="keyword">end</span></span>
                                     <span class="main">|</span> <span class="entity">x</span> <span class="main">=&gt;</span> <span class="entity">x</span><span class="main">)</span><span class="main">)</span> <span class="entity">l</span> <span class="main">(</span><span class="main">[</span><span class="main">]</span><span class="main">,</span> <span class="inner_numeral">0</span><span class="main">)</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">l</span> <span class="main">=</span> rev <span class="entity">l</span> <span class="keyword2"><span class="keyword">in</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">rc</span> <span class="main">=</span> <span class="inner_numeral">0</span> <span class="keyword2"><span class="keyword">then</span></span>
    <span class="main">(</span><span class="entity">l</span><span class="main">,</span> <span class="entity">Isabelle_System.bash_output</span> <span class="entity">cmd</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">else</span></span>
    <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="main">)</span> <span class="main">=</span> fold <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">out</span><span class="main">,</span> <span class="entity">err</span><span class="main">)</span> <span class="main">=&gt;</span> K <span class="main">(</span>warning <span class="entity">err</span><span class="main">;</span> writeln <span class="entity">out</span><span class="main">)</span><span class="main">)</span> <span class="entity">l</span> <span class="main">(</span><span class="main">)</span> <span class="keyword2"><span class="keyword">in</span></span>
    error <span class="inner_quoted">"Compilation failed"</span>
    <span class="keyword2"><span class="keyword">end</span></span>
  <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">check</span> <span class="main">=</span>
  fold <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">cmd</span><span class="main">,</span> <span class="entity">msg</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="main">)</span> <span class="main">=&gt;</span>
    <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">out</span><span class="main">,</span> <span class="entity">rc</span><span class="main">)</span> <span class="main">=</span> <span class="entity">Isabelle_System.bash_output</span> <span class="entity">cmd</span> <span class="keyword2"><span class="keyword">in</span></span>
    <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">rc</span> <span class="main">=</span> <span class="inner_numeral">0</span> <span class="keyword2"><span class="keyword">then</span></span>
      <span class="main">(</span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">else</span></span>
      <span class="main">(</span> writeln <span class="entity">out</span>
      <span class="main">;</span> error <span class="entity">msg</span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">end</span></span><span class="main">)</span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">compiler</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword3"><span class="keyword">open</span></span> <span class="entity">Export_code_env</span> <span class="keyword2"><span class="keyword">in</span></span>
  <span class="main">[</span> <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ml_ext</span> <span class="main">=</span> <span class="inner_quoted">"hs"</span> <span class="keyword2"><span class="keyword">in</span></span>
    <span class="main">(</span> <span class="inner_quoted">"Haskell"</span><span class="main">,</span> <span class="entity">ml_ext</span><span class="main">,</span> <span class="entity">Directory</span><span class="main">,</span> <span class="entity">Haskell.Filename.hs_function</span>
    <span class="main">,</span> <span class="entity">check</span> <span class="main">[</span><span class="main">(</span><span class="inner_quoted">"ghc --version"</span><span class="main">,</span> <span class="inner_quoted">"ghc is not installed (required for compiling a Haskell project)"</span><span class="main">)</span><span class="main">]</span>
    <span class="main">,</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">mk_fic</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">ml_module</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">mk_free</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">thy</span> <span class="main">=&gt;</span>
        File.write <span class="main">(</span><span class="entity">mk_fic</span> <span class="main">(</span><span class="inner_quoted">"Main."</span> ^ <span class="entity">ml_ext</span><span class="main">)</span><span class="main">)</span>
          <span class="main">(</span>String.concatWith <span class="inner_quoted">"; "</span> <span class="main">[</span> <span class="inner_quoted">"import qualified Unsafe.Coerce"</span>
                         <span class="main">,</span> <span class="inner_quoted">"import qualified "</span> ^ <span class="entity">Haskell.function</span>
                         <span class="main">,</span> <span class="inner_quoted">"import qualified "</span> ^ <span class="entity">Haskell.argument</span>
                         <span class="main">,</span> <span class="inner_quoted">"main :: IO ()"</span>
                         <span class="main">,</span> <span class="inner_quoted">"main = "</span> ^ <span class="entity">Haskell.function</span> ^ <span class="inner_quoted">"."</span> ^ <span class="entity">Isabelle.function</span> ^
                           <span class="inner_quoted">" (Unsafe.Coerce.unsafeCoerce "</span> ^ <span class="entity">Haskell.argument</span> ^ <span class="inner_quoted">"."</span> ^
                           <span class="entity">mk_free</span> <span class="main">(</span>Proof_Context.init_global <span class="entity">thy</span><span class="main">)</span>
                                   <span class="entity">Isabelle.argument_main</span> <span class="main">(</span><span class="main">[</span><span class="main">]</span><span class="main">:</span> <span class="main">(</span>string * string<span class="main">)</span> list<span class="main">)</span> ^
                           <span class="inner_quoted">")"</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>
    <span class="main">,</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">tmp_export_code</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">tmp_file</span> <span class="main">=&gt;</span>
        <span class="entity">compile</span> <span class="main">[</span> <span class="inner_quoted">"mv "</span> ^ <span class="entity">tmp_file</span> ^ <span class="inner_quoted">"/"</span> ^ <span class="entity">Haskell.Filename.hs_argument</span> <span class="entity">ml_ext</span> ^ <span class="inner_quoted">" "</span> ^
                          Path.implode <span class="entity">tmp_export_code</span>
                <span class="main">,</span> <span class="inner_quoted">"cd "</span> ^ Path.implode <span class="entity">tmp_export_code</span> ^
                  <span class="inner_quoted">" &amp;&amp; ghc -outputdir _build "</span> ^ <span class="entity">Haskell.Filename.hs_main</span> <span class="entity">ml_ext</span> <span class="main">]</span>
                <span class="main">(</span>Path.implode <span class="main">(</span>Path.append <span class="entity">tmp_export_code</span> <span class="main">(</span>Path.make <span class="main">[</span><span class="entity">Haskell.main</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">end</span></span>
  <span class="main">,</span> <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ml_ext</span> <span class="main">=</span> <span class="inner_quoted">"ml"</span> <span class="keyword2"><span class="keyword">in</span></span>
    <span class="main">(</span> <span class="inner_quoted">"OCaml"</span><span class="main">,</span> <span class="entity">ml_ext</span><span class="main">,</span> <span class="entity">File</span><span class="main">,</span> <span class="entity">OCaml.Filename.function</span>
    <span class="main">,</span> <span class="entity">check</span> <span class="main">[</span><span class="main">(</span><span class="inner_quoted">"ocp-build -version"</span><span class="main">,</span> <span class="inner_quoted">"ocp-build is not installed (required for compiling an OCaml project)"</span><span class="main">)</span>
            <span class="main">,</span><span class="main">(</span><span class="inner_quoted">"ocamlopt -version"</span><span class="main">,</span> <span class="inner_quoted">"ocamlopt is not installed (required for compiling an OCaml project)"</span><span class="main">)</span><span class="main">]</span>
    <span class="main">,</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">mk_fic</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">ml_module</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">mk_free</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">thy</span> <span class="main">=&gt;</span>
        <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="main">)</span> <span class="main">=</span>
          File.write
            <span class="main">(</span><span class="entity">mk_fic</span> <span class="main">(</span><span class="entity">OCaml.Filename.makefile</span> <span class="inner_quoted">"ocp"</span><span class="main">)</span><span class="main">)</span>
            <span class="main">(</span>String.concat
              <span class="main">[</span> <span class="inner_quoted">"comp += \"-g\" link += \"-g\" "</span>
              <span class="main">,</span> <span class="inner_quoted">"begin generated = true begin library \"nums\" end end "</span>
              <span class="main">,</span> <span class="inner_quoted">"begin program \""</span><span class="main">,</span> <span class="entity">OCaml.make</span><span class="main">,</span> <span class="inner_quoted">"\" sort = true files = [ \""</span><span class="main">,</span> <span class="entity">OCaml.Filename.function</span> <span class="entity">ml_ext</span>
              <span class="main">,</span> <span class="inner_quoted">"\" \""</span><span class="main">,</span> <span class="entity">OCaml.Filename.argument</span> <span class="entity">ml_ext</span>
              <span class="main">,</span> <span class="inner_quoted">"\" \""</span><span class="main">,</span> <span class="entity">OCaml.Filename.main_fic</span> <span class="entity">ml_ext</span>
              <span class="main">,</span> <span class="inner_quoted">"\" ]"</span>
              <span class="main">,</span> <span class="inner_quoted">"requires = [\"nums\"] "</span>
              <span class="main">,</span> <span class="inner_quoted">"end"</span> <span class="main">]</span><span class="main">)</span> <span class="keyword2"><span class="keyword">in</span></span>
        File.write <span class="main">(</span><span class="entity">mk_fic</span> <span class="main">(</span><span class="entity">OCaml.Filename.main_fic</span> <span class="entity">ml_ext</span><span class="main">)</span><span class="main">)</span>
          <span class="main">(</span><span class="inner_quoted">"let _ = Function."</span> ^ <span class="entity">ml_module</span> ^ <span class="inner_quoted">"."</span> ^ <span class="entity">Isabelle.function</span> ^
           <span class="inner_quoted">" (Obj.magic (Argument."</span> ^ <span class="entity">ml_module</span> ^ <span class="inner_quoted">"."</span> ^
           <span class="entity">mk_free</span> <span class="main">(</span>Proof_Context.init_global <span class="entity">thy</span><span class="main">)</span>
                   <span class="entity">Isabelle.argument_main</span>
                   <span class="main">(</span><span class="main">[</span><span class="main">]</span><span class="main">:</span> <span class="main">(</span>string * string<span class="main">)</span> list<span class="main">)</span> ^ <span class="inner_quoted">"))"</span><span class="main">)</span>
        <span class="keyword2"><span class="keyword">end</span></span>
    <span class="main">,</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">tmp_export_code</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">tmp_file</span> <span class="main">=&gt;</span>
        <span class="entity">compile</span>
          <span class="main">[</span> <span class="inner_quoted">"mv "</span> ^ <span class="entity">tmp_file</span> ^ <span class="inner_quoted">" "</span> ^
              Path.implode <span class="main">(</span>Path.append <span class="entity">tmp_export_code</span> <span class="main">(</span>Path.make <span class="main">[</span><span class="entity">OCaml.Filename.argument</span> <span class="entity">ml_ext</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>
          <span class="main">,</span> <span class="inner_quoted">"cd "</span> ^ Path.implode <span class="entity">tmp_export_code</span> ^
            <span class="inner_quoted">" &amp;&amp; ocp-build -init -scan -no-bytecode 2&gt;&amp;1"</span> <span class="main">]</span>
          <span class="main">(</span>Path.implode <span class="main">(</span>Path.append <span class="entity">tmp_export_code</span> <span class="main">(</span>Path.make <span class="main">[</span> <span class="inner_quoted">"_obuild"</span>
                                                                <span class="main">,</span> <span class="entity">OCaml.make</span>
                                                                <span class="main">,</span> <span class="entity">OCaml.make</span> ^ <span class="inner_quoted">".asm"</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">end</span></span>
  <span class="main">,</span> <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ml_ext</span> <span class="main">=</span> <span class="inner_quoted">"scala"</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ml_module</span> <span class="main">=</span> Unsynchronized.ref <span class="main">(</span><span class="inner_quoted">""</span><span class="main">,</span> <span class="inner_quoted">""</span><span class="main">)</span> <span class="keyword2"><span class="keyword">in</span></span>
    <span class="main">(</span> <span class="inner_quoted">"Scala"</span><span class="main">,</span> <span class="entity">ml_ext</span><span class="main">,</span> <span class="entity">File</span><span class="main">,</span> <span class="entity">Scala.Filename.function</span>
    <span class="main">,</span> <span class="entity">check</span> <span class="main">[</span><span class="main">(</span><span class="inner_quoted">"scala -e 0"</span><span class="main">,</span> <span class="inner_quoted">"scala is not installed (required for compiling a Scala project)"</span><span class="main">)</span><span class="main">]</span>
    <span class="main">,</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">ml_mod</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">mk_free</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">thy</span> <span class="main">=&gt;</span>
        <span class="entity">ml_module</span> := <span class="main">(</span><span class="entity">ml_mod</span><span class="main">,</span> <span class="entity">mk_free</span> <span class="main">(</span>Proof_Context.init_global <span class="entity">thy</span><span class="main">)</span>
                                      <span class="entity">Isabelle.argument_main</span>
                                      <span class="main">(</span><span class="main">[</span><span class="main">]</span><span class="main">:</span> <span class="main">(</span>string * string<span class="main">)</span> list<span class="main">)</span><span class="main">)</span><span class="main">)</span>
    <span class="main">,</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">tmp_export_code</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">tmp_file</span> <span class="main">=&gt;</span>
        <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">l</span> <span class="main">=</span> File.read_lines <span class="main">(</span>Path.explode <span class="entity">tmp_file</span><span class="main">)</span>
            <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">ml_module</span><span class="main">,</span> <span class="entity">ml_main</span><span class="main">)</span> <span class="main">=</span> Unsynchronized.! <span class="entity">ml_module</span>
            <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="main">)</span> <span class="main">=</span>
              File.write_list
               <span class="main">(</span>Path.append <span class="entity">tmp_export_code</span> <span class="main">(</span>Path.make <span class="main">[</span><span class="entity">Scala.Filename.argument</span> <span class="entity">ml_ext</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>
               <span class="main">(</span>List.map
                 <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">s</span> <span class="main">=&gt;</span> <span class="entity">s</span> ^ <span class="inner_quoted">"\n"</span><span class="main">)</span>
                 <span class="main">(</span><span class="inner_quoted">"object "</span> ^ <span class="entity">ml_module</span> ^ <span class="inner_quoted">" { def main (__ : Array [String]) = "</span> ^
                  <span class="entity">ml_module</span> ^ <span class="inner_quoted">"."</span> ^ <span class="entity">Isabelle.function</span> ^ <span class="inner_quoted">" ("</span> ^ <span class="entity">ml_module</span> ^ <span class="inner_quoted">"."</span> ^ <span class="entity">ml_main</span> ^ <span class="inner_quoted">")"</span>
                  :: <span class="entity">l</span> @ <span class="main">[</span><span class="inner_quoted">"}"</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="keyword2"><span class="keyword">in</span></span>
        <span class="entity">compile</span> <span class="main">[</span><span class="main">]</span>
          <span class="main">(</span><span class="inner_quoted">"scala -nowarn "</span> ^ Path.implode <span class="main">(</span>Path.append <span class="entity">tmp_export_code</span>
                                                        <span class="main">(</span>Path.make <span class="main">[</span><span class="entity">Scala.Filename.argument</span> <span class="entity">ml_ext</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
        <span class="keyword2"><span class="keyword">end</span></span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">end</span></span>
  <span class="main">,</span> <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ml_ext_thy</span> <span class="main">=</span> <span class="inner_quoted">"thy"</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ml_ext_ml</span> <span class="main">=</span> <span class="inner_quoted">"ML"</span> <span class="keyword2"><span class="keyword">in</span></span>
    <span class="main">(</span> <span class="inner_quoted">"SML"</span><span class="main">,</span> <span class="entity">ml_ext_ml</span><span class="main">,</span> <span class="entity">File</span><span class="main">,</span> <span class="entity">SML.Filename.function</span>
    <span class="main">,</span> <span class="entity">check</span> <span class="main">[</span> <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">isa</span> <span class="main">=</span> <span class="inner_quoted">"isabelle"</span> <span class="keyword2"><span class="keyword">in</span></span>
              <span class="main">(</span> Path.implode <span class="main">(</span>Path.expand <span class="main">(</span>Path.append <span class="main">(</span>Path.variable <span class="inner_quoted">"ISABELLE_HOME"</span><span class="main">)</span> <span class="main">(</span>Path.make <span class="main">[</span><span class="inner_quoted">"bin"</span><span class="main">,</span> <span class="entity">isa</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> ^ <span class="inner_quoted">" version"</span>
              <span class="main">,</span> <span class="entity">isa</span> ^ <span class="inner_quoted">" is not installed (required for compiling a SML project)"</span><span class="main">)</span>
              <span class="keyword2"><span class="keyword">end</span></span> <span class="main">]</span>
    <span class="main">,</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">mk_fic</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">ml_module</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">mk_free</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">thy</span> <span class="main">=&gt;</span>
         <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">esc_star</span> <span class="main">=</span> <span class="inner_quoted">"*"</span>
             <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">ml</span> <span class="entity">l</span> <span class="main">=</span>
               List.concat
               <span class="main">[</span> <span class="main">[</span> <span class="inner_quoted">"ML{"</span> ^ <span class="entity">esc_star</span> <span class="main">]</span>
               <span class="main">,</span> map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">s</span> <span class="main">=&gt;</span> <span class="entity">s</span> ^ <span class="inner_quoted">";"</span><span class="main">)</span> <span class="entity">l</span>
               <span class="main">,</span> <span class="main">[</span> <span class="entity">esc_star</span> ^ <span class="inner_quoted">"}"</span><span class="main">]</span> <span class="main">]</span>
             <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="main">)</span> <span class="main">=</span>
               <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">fic</span> <span class="main">=</span> <span class="entity">mk_fic</span> <span class="main">(</span><span class="entity">SML.Filename.function</span> <span class="entity">ml_ext_ml</span><span class="main">)</span> <span class="keyword2"><span class="keyword">in</span></span>
               <span class="comment1">(* replace ("\\" ^ "&lt;") by ("\\\060") in 'fic' *)</span>
               File.write_list <span class="entity">fic</span>
                 <span class="main">(</span>map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">s</span> <span class="main">=&gt;</span>
                         <span class="main">(</span><span class="keyword2"><span class="keyword">if</span></span> <span class="entity">s</span> <span class="main">=</span> <span class="inner_quoted">""</span> <span class="keyword2"><span class="keyword">then</span></span>
                           <span class="inner_quoted">""</span>
                         <span class="keyword2"><span class="keyword">else</span></span>
                           String.concatWith <span class="inner_quoted">"\\"</span>
                             <span class="main">(</span>map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">s</span> <span class="main">=&gt;</span>
                                     <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">l</span> <span class="main">=</span> String.size <span class="entity">s</span> <span class="keyword2"><span class="keyword">in</span></span>
                                     <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">l</span> &gt; <span class="inner_numeral">0</span> <span class="keyword1"><span class="keyword">andalso</span></span> String.sub <span class="main">(</span><span class="entity">s</span><span class="main">,</span><span class="inner_numeral">0</span><span class="main">)</span> <span class="main">=</span> <span class="inner_quoted">#"&lt;"</span> <span class="keyword2"><span class="keyword">then</span></span>
                                       <span class="inner_quoted">"\\060"</span> ^ String.substring <span class="main">(</span><span class="entity">s</span><span class="main">,</span> <span class="inner_numeral">1</span><span class="main">,</span> String.size <span class="entity">s</span> - <span class="inner_numeral">1</span><span class="main">)</span>
                                     <span class="keyword2"><span class="keyword">else</span></span>
                                       <span class="entity">s</span> <span class="keyword2"><span class="keyword">end</span></span><span class="main">)</span>
                                  <span class="main">(</span>String.fields <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">c</span> <span class="main">=&gt;</span> <span class="entity">c</span> <span class="main">=</span> <span class="inner_quoted">#"\\"</span><span class="main">)</span> <span class="entity">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> ^ <span class="inner_quoted">"\n"</span><span class="main">)</span>
                      <span class="main">(</span>File.read_lines <span class="entity">fic</span><span class="main">)</span><span class="main">)</span>
               <span class="keyword2"><span class="keyword">end</span></span> <span class="keyword2"><span class="keyword">in</span></span>
         File.write_list <span class="main">(</span><span class="entity">mk_fic</span> <span class="main">(</span><span class="entity">SML.Filename.main_fic</span> <span class="entity">ml_ext_thy</span><span class="main">)</span><span class="main">)</span>
           <span class="main">(</span>map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">s</span> <span class="main">=&gt;</span> <span class="entity">s</span> ^ <span class="inner_quoted">"\n"</span><span class="main">)</span> <span class="main">(</span>List.concat
             <span class="main">[</span> <span class="main">[</span> <span class="inner_quoted">"theory "</span> ^ <span class="entity">SML.main</span>
               <span class="main">,</span> <span class="inner_quoted">"imports Main"</span>
               <span class="main">,</span> <span class="inner_quoted">"begin"</span>
               <span class="main">,</span> <span class="inner_quoted">"declare [[ML_print_depth = 500]]"</span>
                 <span class="comment1">(* any large number so that @{make_string} displays all the expression *)</span> <span class="main">]</span>
             <span class="main">,</span> <span class="entity">ml</span> <span class="main">[</span> <span class="inner_quoted">"val stdout_file = Unsynchronized.ref (File.read (Path.make [\""</span> ^
                      <span class="entity">SML.Filename.stdout</span> <span class="entity">ml_ext_ml</span> ^ <span class="inner_quoted">"\"]))"</span>
                  <span class="main">,</span> <span class="inner_quoted">"use \""</span> ^ <span class="entity">SML.Filename.argument</span> <span class="entity">ml_ext_ml</span> ^ <span class="inner_quoted">"\""</span> <span class="main">]</span>
             <span class="main">,</span> <span class="entity">ml</span> <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">arg</span> <span class="main">=</span> <span class="inner_quoted">"argument"</span> <span class="keyword2"><span class="keyword">in</span></span>
                  <span class="main">[</span> <span class="inner_quoted">"val "</span> ^ <span class="entity">arg</span> ^ <span class="inner_quoted">" = XML.content_of (YXML.parse_body (@{make_string} ("</span> ^
                    <span class="entity">ml_module</span> ^ <span class="inner_quoted">"."</span> ^
                    <span class="entity">mk_free</span> <span class="main">(</span>Proof_Context.init_global <span class="entity">thy</span><span class="main">)</span>
                            <span class="entity">Isabelle.argument_main</span>
                            <span class="main">(</span><span class="main">[</span><span class="main">]</span><span class="main">:</span> <span class="main">(</span>string * string<span class="main">)</span> list<span class="main">)</span> ^ <span class="inner_quoted">")))"</span>
                  <span class="main">,</span> <span class="inner_quoted">"use \""</span> ^ <span class="entity">SML.Filename.function</span> <span class="entity">ml_ext_ml</span> ^ <span class="inner_quoted">"\""</span>
                  <span class="main">,</span> <span class="inner_quoted">"ML_Context.eval_source (ML_Compiler.verbose false ML_Compiler.flags) (Input.source false (\"let open "</span> ^
                      <span class="entity">ml_module</span> ^ <span class="inner_quoted">" in "</span> ^ <span class="entity">Isabelle.function</span> ^ <span class="inner_quoted">" (\" ^ "</span> ^ <span class="entity">arg</span> ^
                      <span class="inner_quoted">" ^ \") end\") (Position.none, Position.none) )"</span> <span class="main">]</span>
                  <span class="keyword2"><span class="keyword">end</span></span>
             <span class="main">,</span> <span class="main">[</span> <span class="inner_quoted">"end"</span> <span class="main">]</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>
         <span class="keyword2"><span class="keyword">end</span></span>
    <span class="main">,</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">tmp_export_code</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">tmp_file</span> <span class="main">=&gt;</span>
        <span class="keyword2"><span class="keyword">let</span></span>
            <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">stdout_file</span> <span class="main">=</span> <span class="entity">Isabelle_System.create_tmp_path</span> <span class="inner_quoted">"stdout_file"</span> <span class="inner_quoted">"thy"</span>
            <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="main">)</span> <span class="main">=</span> File.write <span class="main">(</span>Path.append <span class="entity">tmp_export_code</span> <span class="main">(</span>Path.make <span class="main">[</span><span class="entity">SML.Filename.stdout</span> <span class="entity">ml_ext_ml</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>
                                <span class="main">(</span>Path.implode <span class="main">(</span>Path.expand <span class="entity">stdout_file</span><span class="main">)</span><span class="main">)</span>
            <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">l</span><span class="main">,</span> <span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="entity">exit_st</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
              <span class="entity">compile</span>
                <span class="main">[</span> <span class="inner_quoted">"mv "</span> ^ <span class="entity">tmp_file</span> ^ <span class="inner_quoted">" "</span> ^ Path.implode <span class="main">(</span>Path.append <span class="entity">tmp_export_code</span>
                                                           <span class="main">(</span>Path.make <span class="main">[</span><span class="entity">SML.Filename.argument</span> <span class="entity">ml_ext_ml</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>
                <span class="main">,</span> <span class="inner_quoted">"cd "</span> ^ Path.implode <span class="entity">tmp_export_code</span> ^
                  <span class="inner_quoted">" &amp;&amp; echo 'use_thy \""</span> ^ <span class="entity">SML.main</span> ^ <span class="inner_quoted">"\";' | "</span> ^
                  Path.implode <span class="main">(</span>Path.expand <span class="main">(</span>Path.append <span class="main">(</span>Path.variable <span class="inner_quoted">"ISABELLE_HOME"</span><span class="main">)</span> <span class="main">(</span>Path.make <span class="main">[</span><span class="inner_quoted">"bin"</span><span class="main">,</span> <span class="inner_quoted">"isabelle"</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> ^
                  <span class="inner_quoted">" console"</span> <span class="main">]</span>
                <span class="inner_quoted">"true"</span>
            <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">stdout</span> <span class="main">=</span>
              <span class="keyword2"><span class="keyword">case</span></span> try File.read <span class="entity">stdout_file</span> <span class="keyword2"><span class="keyword">of</span></span>
                SOME <span class="entity">s</span> <span class="main">=&gt;</span> <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="main">)</span> <span class="main">=</span> File.rm <span class="entity">stdout_file</span> <span class="keyword2"><span class="keyword">in</span></span> <span class="entity">s</span> <span class="keyword2"><span class="keyword">end</span></span>
              <span class="main">|</span> NONE <span class="main">=&gt;</span> <span class="inner_quoted">""</span> <span class="keyword2"><span class="keyword">in</span></span>
            <span class="main">(</span><span class="entity">l</span><span class="main">,</span> <span class="main">(</span><span class="entity">stdout</span><span class="main">,</span> <span class="keyword2"><span class="keyword">if</span></span> List.exists <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">err</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> <span class="main">=&gt;</span>
                              List.exists <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="inner_quoted">"*** Error"</span> <span class="main">=&gt;</span> true <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> false<span class="main">)</span>
                                <span class="main">(</span>String.tokens <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="inner_quoted">#"\n"</span> <span class="main">=&gt;</span> true <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> false<span class="main">)</span> <span class="entity">err</span><span class="main">)</span><span class="main">)</span> <span class="entity">l</span> <span class="keyword2"><span class="keyword">then</span></span>
                           <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="main">)</span> <span class="main">=</span> fold <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">out</span><span class="main">,</span> <span class="entity">err</span><span class="main">)</span> <span class="main">=&gt;</span> K <span class="main">(</span>warning <span class="entity">err</span><span class="main">;</span> writeln <span class="entity">out</span><span class="main">)</span><span class="main">)</span> <span class="entity">l</span> <span class="main">(</span><span class="main">)</span> <span class="keyword2"><span class="keyword">in</span></span>
                           <span class="inner_numeral">1</span>
                           <span class="keyword2"><span class="keyword">end</span></span>
                         <span class="keyword2"><span class="keyword">else</span></span> <span class="entity">exit_st</span><span class="main">)</span><span class="main">)</span>
        <span class="keyword2"><span class="keyword">end</span></span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">end</span></span> <span class="main">]</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">Find</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">struct</span></span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">ext</span> <span class="entity">ml_compiler</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">case</span></span> List.find <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">ml_compiler0</span><span class="main">,</span> <span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">ml_compiler0</span> <span class="main">=</span> <span class="entity">ml_compiler</span><span class="main">)</span> <span class="entity">compiler</span> <span class="keyword2"><span class="keyword">of</span></span>
    SOME <span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="entity">ext</span><span class="main">,</span> <span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">ext</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">export_mode</span> <span class="entity">ml_compiler</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">case</span></span> List.find <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">ml_compiler0</span><span class="main">,</span> <span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">ml_compiler0</span> <span class="main">=</span> <span class="entity">ml_compiler</span><span class="main">)</span> <span class="entity">compiler</span> <span class="keyword2"><span class="keyword">of</span></span>
    SOME <span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">,</span> <span class="entity">mode</span><span class="main">,</span> <span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">mode</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">function</span> <span class="entity">ml_compiler</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">case</span></span> List.find <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">ml_compiler0</span><span class="main">,</span> <span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">ml_compiler0</span> <span class="main">=</span> <span class="entity">ml_compiler</span><span class="main">)</span> <span class="entity">compiler</span> <span class="keyword2"><span class="keyword">of</span></span>
    SOME <span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">,</span> <span class="entity">f</span><span class="main">,</span> <span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">f</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">check_compil</span> <span class="entity">ml_compiler</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">case</span></span> List.find <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">ml_compiler0</span><span class="main">,</span> <span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">ml_compiler0</span> <span class="main">=</span> <span class="entity">ml_compiler</span><span class="main">)</span> <span class="entity">compiler</span> <span class="keyword2"><span class="keyword">of</span></span>
    SOME <span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">,</span> <span class="entity">build</span><span class="main">,</span> <span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">build</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">init</span> <span class="entity">ml_compiler</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">case</span></span> List.find <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">ml_compiler0</span><span class="main">,</span> <span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">ml_compiler0</span> <span class="main">=</span> <span class="entity">ml_compiler</span><span class="main">)</span> <span class="entity">compiler</span> <span class="keyword2"><span class="keyword">of</span></span>
    SOME <span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">,</span> <span class="entity">build</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">build</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">build</span> <span class="entity">ml_compiler</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">case</span></span> List.find <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">ml_compiler0</span><span class="main">,</span> <span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">ml_compiler0</span> <span class="main">=</span> <span class="entity">ml_compiler</span><span class="main">)</span> <span class="entity">compiler</span> <span class="keyword2"><span class="keyword">of</span></span>
    SOME <span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">,</span> <span class="entity">build</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">build</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
›</span>

<span class="keyword1"><span class="command">ML</span></span><span class="quoted">‹
<span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">Deep</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">struct</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">absolute_path</span> <span class="entity">filename</span> <span class="entity">thy</span> <span class="main">=</span>
  Path.implode <span class="main">(</span>Path.append <span class="main">(</span><span class="entity">Resources.master_directory</span> <span class="entity">thy</span><span class="main">)</span> <span class="main">(</span>Path.explode <span class="entity">filename</span><span class="main">)</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">export_code_tmp_file</span> <span class="entity">seris</span> <span class="entity">g</span> <span class="main">=</span>
  fold
    <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="main">(</span><span class="entity">ml_compiler</span><span class="main">,</span> <span class="entity">ml_module</span><span class="main">)</span><span class="main">,</span> <span class="entity">export_arg</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">f</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">g</span> <span class="main">=&gt;</span>
      <span class="entity">f</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">accu</span> <span class="main">=&gt;</span>
        <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">tmp_name</span> <span class="main">=</span> Context.theory_name <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">theory</span><span class="antiquote">}</span></span></span> <span class="keyword2"><span class="keyword">in</span></span>
        <span class="main">(</span><span class="keyword2"><span class="keyword">if</span></span> <span class="entity">Deep0.Find.export_mode</span> <span class="entity">ml_compiler</span> <span class="main">=</span> <span class="entity">Deep0.Export_code_env.Directory</span> <span class="keyword2"><span class="keyword">then</span></span>
           <span class="entity">Isabelle_System.with_tmp_dir</span> <span class="entity">tmp_name</span>
         <span class="keyword2"><span class="keyword">else</span></span>
           <span class="entity">Isabelle_System.with_tmp_file</span> <span class="entity">tmp_name</span> <span class="main">(</span><span class="entity">Deep0.Find.ext</span> <span class="entity">ml_compiler</span><span class="main">)</span><span class="main">)</span>
          <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">filename</span> <span class="main">=&gt;</span>
             <span class="entity">g</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="entity">ml_compiler</span><span class="main">,</span> <span class="entity">ml_module</span><span class="main">)</span><span class="main">,</span> Path.implode <span class="entity">filename</span><span class="main">)</span><span class="main">,</span> <span class="entity">export_arg</span><span class="main">)</span> :: <span class="entity">accu</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
        <span class="keyword2"><span class="keyword">end</span></span><span class="main">)</span><span class="main">)</span>
    <span class="entity">seris</span>
    <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">f</span> <span class="main">=&gt;</span> <span class="entity">f</span> <span class="main">[</span><span class="main">]</span><span class="main">)</span>
    <span class="main">(</span><span class="entity">g</span> o rev<span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk_path_export_code</span> <span class="entity">tmp_export_code</span> <span class="entity">ml_compiler</span> <span class="entity">i</span> <span class="main">=</span>
  Path.append <span class="entity">tmp_export_code</span> <span class="main">(</span>Path.make <span class="main">[</span><span class="entity">ml_compiler</span> ^ Int.toString <span class="entity">i</span><span class="main">]</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">export_code_cmd'</span> <span class="entity">seris</span> <span class="entity">tmp_export_code</span> <span class="entity">f_err</span> <span class="entity">filename_thy</span> <span class="entity">raw_cs</span> <span class="entity">thy</span> <span class="main">=</span>
  <span class="entity">export_code_tmp_file</span> <span class="entity">seris</span>
    <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">seris</span> <span class="main">=&gt;</span>
      <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">mem_scala</span> <span class="main">=</span> List.exists <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="inner_quoted">"Scala"</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> <span class="main">=&gt;</span> true <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> false<span class="main">)</span> <span class="entity">seris</span>
          <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">thy'</span> <span class="comment1">(* FIXME unused *)</span> <span class="main">=</span> <span class="entity">Isabelle_Code_Target.export_code_cmd</span>
        false
        <span class="main">(</span><span class="keyword2"><span class="keyword">if</span></span> <span class="entity">mem_scala</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">Deep0.Export_code_env.Isabelle.function</span> :: <span class="entity">raw_cs</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="entity">raw_cs</span><span class="main">)</span>
        <span class="main">(</span><span class="main">(</span>map o apfst o apsnd<span class="main">)</span> SOME <span class="entity">seris</span><span class="main">)</span>
        <span class="main">(</span><span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">v</span> <span class="main">=</span> <span class="entity">Deep0.apply_hs_code_identifiers</span> <span class="entity">Deep0.Export_code_env.Haskell.argument</span> <span class="entity">thy</span> <span class="keyword2"><span class="keyword">in</span></span>
         <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">mem_scala</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">Code_printing.apply_code_printing</span> <span class="entity">v</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="entity">v</span> <span class="keyword2"><span class="keyword">end</span></span><span class="main">)</span> <span class="keyword2"><span class="keyword">in</span></span>
      <span class="entity">List_mapi</span>
        <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">i</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">seri</span> <span class="main">=&gt;</span> <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">seri</span> <span class="keyword2"><span class="keyword">of</span></span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="entity">ml_compiler</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span><span class="main">,</span> <span class="entity">filename</span><span class="main">)</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> <span class="main">=&gt;</span>
          <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">l</span><span class="main">,</span> <span class="main">(</span><span class="entity">out</span><span class="main">,</span> <span class="entity">err</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
                <span class="entity">Deep0.Find.build</span>
                  <span class="entity">ml_compiler</span>
                  <span class="main">(</span><span class="entity">mk_path_export_code</span> <span class="entity">tmp_export_code</span> <span class="entity">ml_compiler</span> <span class="entity">i</span><span class="main">)</span>
                  <span class="entity">filename</span>
              <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> <span class="entity">f_err</span> <span class="entity">seri</span> <span class="entity">err</span> <span class="keyword2"><span class="keyword">in</span></span>
          <span class="main">(</span><span class="entity">l</span><span class="main">,</span> <span class="entity">out</span><span class="main">)</span>
          <span class="keyword2"><span class="keyword">end</span></span><span class="main">)</span> <span class="entity">seris</span>
      <span class="keyword2"><span class="keyword">end</span></span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk_term</span> <span class="entity">ctxt</span> <span class="entity">s</span> <span class="main">=</span>
  fst <span class="main">(</span>Scan.pass <span class="main">(</span>Context.Proof <span class="entity">ctxt</span><span class="main">)</span> Args.term <span class="main">(</span>Token.explode0 <span class="main">(</span>Thy_Header.get_keywords' <span class="entity">ctxt</span><span class="main">)</span> <span class="entity">s</span><span class="main">)</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk_free</span> <span class="entity">ctxt</span> <span class="entity">s</span> <span class="entity">l</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">t_s</span> <span class="main">=</span> <span class="entity">mk_term</span> <span class="entity">ctxt</span> <span class="entity">s</span> <span class="keyword2"><span class="keyword">in</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> Term.is_Free <span class="entity">t_s</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">s</span> <span class="keyword2"><span class="keyword">else</span></span>
    <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">l</span> <span class="main">=</span> <span class="main">(</span><span class="entity">s</span><span class="main">,</span> <span class="inner_quoted">""</span><span class="main">)</span> :: <span class="entity">l</span> <span class="keyword2"><span class="keyword">in</span></span>
    <span class="entity">mk_free</span> <span class="entity">ctxt</span> <span class="main">(</span>fst <span class="main">(</span>hd <span class="main">(</span>Term.variant_frees <span class="entity">t_s</span> <span class="entity">l</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="entity">l</span>
    <span class="keyword2"><span class="keyword">end</span></span>
  <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">list_all_eq</span> <span class="main">=</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">x0</span> :: <span class="entity">xs</span> <span class="main">=&gt;</span>
  List.all <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">x1</span> <span class="main">=&gt;</span> <span class="entity">x0</span> <span class="main">=</span> <span class="entity">x1</span><span class="main">)</span> <span class="entity">xs</span>

<span class="keyword2"><span class="keyword">end</span></span>
›</span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Saving the History of Meta Commands›</span></span>

<span class="keyword1"><span class="command">ML</span></span><span class="quoted">‹
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">p_gen</span> <span class="entity">f</span> <span class="entity">g</span> <span class="main">=</span>  <span class="entity">f</span> <span class="inner_quoted">"["</span> <span class="inner_quoted">"]"</span> <span class="entity">g</span>
              <span class="comment1">(*|| f "{" "}" g*)</span>
              || <span class="entity">f</span> <span class="inner_quoted">"("</span> <span class="inner_quoted">")"</span> <span class="entity">g</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">paren</span> <span class="entity">f</span> <span class="main">=</span> <span class="entity">p_gen</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">s1</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">s2</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">f</span> <span class="main">=&gt;</span> Parse.$$$ <span class="entity">s1</span> |-- <span class="entity">f</span> --| Parse.$$$ <span class="entity">s2</span><span class="main">)</span> <span class="entity">f</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">parse_l</span> <span class="entity">f</span> <span class="main">=</span> Parse.$$$ <span class="inner_quoted">"["</span> |-- Parse.!!! <span class="main">(</span>Parse.list <span class="entity">f</span> --| Parse.$$$ <span class="inner_quoted">"]"</span><span class="main">)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">parse_l'</span> <span class="entity">f</span> <span class="main">=</span> Parse.$$$ <span class="inner_quoted">"["</span> |-- Parse.list <span class="entity">f</span> --| Parse.$$$ <span class="inner_quoted">"]"</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">parse_l1'</span> <span class="entity">f</span> <span class="main">=</span> Parse.$$$ <span class="inner_quoted">"["</span> |-- Parse.list1 <span class="entity">f</span> --| Parse.$$$ <span class="inner_quoted">"]"</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">annot_ty</span> <span class="entity">f</span> <span class="main">=</span> Parse.$$$ <span class="inner_quoted">"("</span> |-- <span class="entity">f</span> --| Parse.$$$ <span class="inner_quoted">"::"</span> -- Parse.binding --| Parse.$$$ <span class="inner_quoted">")"</span>
›</span>

<span class="keyword1"><span class="command">ML</span></span><span class="quoted">‹
<span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">Generation_mode</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">struct</span></span>

<span class="keyword1"><span class="keyword">datatype</span></span> <span class="entity">internal_deep</span> <span class="main">=</span> <span class="entity">Internal_deep</span> <span class="keyword2"><span class="keyword">of</span></span>
    <span class="main">(</span>string * <span class="main">(</span>string list <span class="comment1">(* imports *)</span> * string <span class="comment1">(* import optional (bootstrap) *)</span><span class="main">)</span><span class="main">)</span> option
  * <span class="main">(</span><span class="main">(</span>bstring <span class="comment1">(* compiler *)</span> * bstring <span class="comment1">(* main module *)</span> <span class="main">)</span> * Token.T list<span class="main">)</span> list <span class="comment1">(* seri_args *)</span>
  * bstring option <span class="comment1">(* filename_thy *)</span>
  * Path.T <span class="comment1">(* tmp dir export_code *)</span>
  * bool <span class="comment1">(* true: skip preview of code exportation *)</span>

<span class="keyword1"><span class="keyword">datatype</span></span> 'a <span class="entity">generation_mode</span> <span class="main">=</span> <span class="entity">Gen_deep</span> <span class="keyword2"><span class="keyword">of</span></span> unit META.compiler_env_config_ext
                                        * internal_deep
                            <span class="main">|</span> <span class="entity">Gen_shallow</span> <span class="keyword2"><span class="keyword">of</span></span> unit META.compiler_env_config_ext
                                           * 'a <span class="comment1">(* theory init *)</span>
                            <span class="main">|</span> <span class="entity">Gen_syntax_print</span> <span class="keyword2"><span class="keyword">of</span></span> int option

<span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">Data_gen</span> <span class="main">=</span> Theory_Data
  <span class="main">(</span><span class="keyword1"><span class="keyword">type</span></span> <span class="entity">T</span> <span class="main">=</span> theory <span class="entity">generation_mode</span> list Symtab.table
   <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">empty</span> <span class="main">=</span> Symtab.empty
   <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">extend</span> <span class="main">=</span> I
   <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">merge</span> <span class="main">=</span> Symtab.merge <span class="main">(</span>K true<span class="main">)</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">code_expr_argsP</span> <span class="main">=</span> Scan.optional <span class="main">(</span><span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">keyword</span> "<span class="keyword2">(</span>"<span class="antiquote">}</span></span></span> |-- Parse.args --| <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">keyword</span> "<span class="keyword2">)</span>"<span class="antiquote">}</span></span></span><span class="main">)</span> <span class="main">[</span><span class="main">]</span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">parse_scheme</span> <span class="main">=</span>
  <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">keyword</span> "<span class="keyword2">design</span>"<span class="antiquote">}</span></span></span> &gt;&gt; K META.Gen_only_design || <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">keyword</span> "<span class="keyword2">analysis</span>"<span class="antiquote">}</span></span></span> &gt;&gt; K META.Gen_only_analysis

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">parse_sorry_mode</span> <span class="main">=</span>
  Scan.optional <span class="main">(</span>  <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">keyword</span> "<span class="keyword2">SORRY</span>"<span class="antiquote">}</span></span></span> &gt;&gt; K <span class="main">(</span>SOME META.Gen_sorry<span class="main">)</span>
                || <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">keyword</span> "<span class="keyword2">no_dirty</span>"<span class="antiquote">}</span></span></span> &gt;&gt; K <span class="main">(</span>SOME META.Gen_no_dirty<span class="main">)</span><span class="main">)</span> NONE

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">parse_deep</span> <span class="main">=</span>
     Scan.optional <span class="main">(</span><span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">keyword</span> "<span class="keyword2">skip_export</span>"<span class="antiquote">}</span></span></span> &gt;&gt; K true<span class="main">)</span> false
  -- Scan.optional <span class="main">(</span><span class="main">(</span><span class="main">(</span>Parse.$$$ <span class="inner_quoted">"("</span> -- <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">keyword</span> "<span class="keyword2">THEORY</span>"<span class="antiquote">}</span></span></span><span class="main">)</span> |-- Parse.name -- <span class="main">(</span><span class="main">(</span>Parse.$$$ <span class="inner_quoted">")"</span>
                   -- Parse.$$$ <span class="inner_quoted">"("</span> -- <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">keyword</span> "<span class="keyword2">IMPORTS</span>"<span class="antiquote">}</span></span></span><span class="main">)</span> |-- <span class="entity">parse_l'</span> Parse.name -- Parse.name<span class="main">)</span>
                   --| Parse.$$$ <span class="inner_quoted">")"</span><span class="main">)</span> &gt;&gt; SOME<span class="main">)</span> NONE
  -- Scan.optional <span class="main">(</span><span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">keyword</span> "<span class="keyword2">SECTION</span>"<span class="antiquote">}</span></span></span> &gt;&gt; K true<span class="main">)</span> false
  -- <span class="entity">parse_sorry_mode</span>
  -- <span class="comment1">(* code_expr_inP *)</span> <span class="entity">parse_l1'</span> <span class="main">(</span><span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">keyword</span> "<span class="keyword2">in</span>"<span class="antiquote">}</span></span></span> |-- <span class="main">(</span>Parse.name
        -- Scan.optional <span class="main">(</span><span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">keyword</span> "<span class="keyword2">module_name</span>"<span class="antiquote">}</span></span></span> |-- Parse.name<span class="main">)</span> <span class="inner_quoted">""</span>
        -- <span class="entity">code_expr_argsP</span><span class="main">)</span><span class="main">)</span>
  -- Scan.optional
       <span class="main">(</span><span class="main">(</span>Parse.$$$ <span class="inner_quoted">"("</span> -- <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">keyword</span> "<span class="keyword2">output_directory</span>"<span class="antiquote">}</span></span></span><span class="main">)</span> |-- Parse.name --| Parse.$$$ <span class="inner_quoted">")"</span> &gt;&gt; SOME<span class="main">)</span>
       NONE

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">parse_semantics</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">z</span> <span class="main">=</span> <span class="inner_numeral">0</span> <span class="keyword2"><span class="keyword">in</span></span>
      Scan.optional
        <span class="main">(</span><span class="entity">paren</span> <span class="main">(</span><span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">keyword</span> "<span class="keyword2">generation_semantics</span>"<span class="antiquote">}</span></span></span>
               |-- <span class="entity">paren</span> <span class="main">(</span><span class="entity">parse_scheme</span>
                          -- Scan.optional <span class="main">(</span><span class="main">(</span>Parse.$$$ <span class="inner_quoted">","</span> -- <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">keyword</span> "<span class="keyword2">oid_start</span>"<span class="antiquote">}</span></span></span><span class="main">)</span> |-- Parse.nat<span class="main">)</span>
                                           <span class="entity">z</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
              <span class="main">(</span>META.Gen_default<span class="main">,</span> <span class="entity">z</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">mode</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk_env</span> <span class="entity">output_disable_thy</span> <span class="entity">output_header_thy</span> <span class="entity">oid_start</span> <span class="entity">design_analysis</span> <span class="entity">sorry_mode</span> <span class="entity">dirty</span> <span class="main">=</span>
    META.compiler_env_config_empty
    <span class="entity">output_disable_thy</span>
    <span class="main">(</span><span class="entity">From.option</span> <span class="main">(</span><span class="entity">From.pair</span> <span class="entity">From.string</span> <span class="main">(</span><span class="entity">From.pair</span> <span class="main">(</span><span class="entity">From.list</span> <span class="entity">From.string</span><span class="main">)</span> <span class="entity">From.string</span><span class="main">)</span><span class="main">)</span>
                 <span class="entity">output_header_thy</span><span class="main">)</span>
    <span class="main">(</span>META.oidInit <span class="main">(</span><span class="entity">From.internal_oid</span> <span class="entity">oid_start</span><span class="main">)</span><span class="main">)</span>
    <span class="entity">design_analysis</span>
    <span class="main">(</span><span class="entity">sorry_mode</span><span class="main">,</span> <span class="entity">dirty</span><span class="main">)</span> <span class="keyword2"><span class="keyword">in</span></span>

     <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">keyword</span> "<span class="keyword2">deep</span>"<span class="antiquote">}</span></span></span> |-- <span class="entity">parse_semantics</span> -- <span class="entity">parse_deep</span> &gt;&gt;
     <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span> <span class="main">(</span><span class="entity">design_analysis</span><span class="main">,</span> <span class="entity">oid_start</span><span class="main">)</span>
         <span class="main">,</span> <span class="main">(</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="entity">skip_exportation</span><span class="main">,</span> <span class="entity">output_header_thy</span><span class="main">)</span><span class="main">,</span> <span class="entity">output_disable_thy</span><span class="main">)</span><span class="main">,</span> <span class="entity">sorry_mode</span><span class="main">)</span><span class="main">,</span> <span class="entity">seri_args</span><span class="main">)</span>
           <span class="main">,</span> <span class="entity">filename_thy</span><span class="main">)</span><span class="main">)</span> <span class="main">=&gt;</span>
       <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">ctxt</span> <span class="main">=&gt;</span>
         <span class="entity">Gen_deep</span> <span class="main">(</span> <span class="entity">mk_env</span> <span class="main">(</span>not <span class="entity">output_disable_thy</span><span class="main">)</span>
                           <span class="entity">output_header_thy</span>
                           <span class="entity">oid_start</span>
                           <span class="entity">design_analysis</span>
                           <span class="entity">sorry_mode</span>
                           <span class="main">(</span>Config.get <span class="entity">ctxt</span> quick_and_dirty<span class="main">)</span>
                  <span class="main">,</span> <span class="entity">Internal_deep</span> <span class="main">(</span> <span class="entity">output_header_thy</span>
                                  <span class="main">,</span> <span class="entity">seri_args</span>
                                  <span class="main">,</span> <span class="entity">filename_thy</span>
                                  <span class="main">,</span> <span class="entity">Isabelle_System.create_tmp_path</span> <span class="inner_quoted">"deep_export_code"</span> <span class="inner_quoted">""</span>
                                  <span class="main">,</span> <span class="entity">skip_exportation</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
  || <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">keyword</span> "<span class="keyword2">shallow</span>"<span class="antiquote">}</span></span></span> |-- <span class="entity">parse_semantics</span> -- <span class="entity">parse_sorry_mode</span> &gt;&gt;
     <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="main">(</span><span class="entity">design_analysis</span><span class="main">,</span> <span class="entity">oid_start</span><span class="main">)</span><span class="main">,</span> <span class="entity">sorry_mode</span><span class="main">)</span> <span class="main">=&gt;</span>
       <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">ctxt</span> <span class="main">=&gt;</span>
       <span class="entity">Gen_shallow</span> <span class="main">(</span> <span class="entity">mk_env</span> true
                            NONE
                            <span class="entity">oid_start</span>
                            <span class="entity">design_analysis</span>
                            <span class="entity">sorry_mode</span>
                            <span class="main">(</span>Config.get <span class="entity">ctxt</span> quick_and_dirty<span class="main">)</span>
                   <span class="main">,</span> <span class="main">(</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
  || <span class="main">(</span><span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">keyword</span> "<span class="keyword2">syntax_print</span>"<span class="antiquote">}</span></span></span> |-- Scan.optional <span class="main">(</span>Parse.number &gt;&gt; SOME<span class="main">)</span> NONE<span class="main">)</span> &gt;&gt;
     <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">n</span> <span class="main">=&gt;</span> K <span class="main">(</span><span class="entity">Gen_syntax_print</span> <span class="main">(</span><span class="keyword2"><span class="keyword">case</span></span> <span class="entity">n</span> <span class="keyword2"><span class="keyword">of</span></span> NONE <span class="main">=&gt;</span> NONE <span class="main">|</span> SOME <span class="entity">n</span> <span class="main">=&gt;</span> Int.fromString <span class="entity">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">f_command</span> <span class="entity">l_mode</span> <span class="main">=</span>
  <span class="entity">Toplevel.theory</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">thy</span> <span class="main">=&gt;</span>
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">l_mode</span><span class="main">,</span> <span class="entity">thy</span><span class="main">)</span> <span class="main">=</span> META.mapM
  <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">Gen_shallow</span> <span class="main">(</span><span class="entity">env</span><span class="main">,</span> <span class="main">(</span><span class="main">)</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">thy0</span> <span class="main">=</span> <span class="entity">thy</span> <span class="keyword2"><span class="keyword">in</span></span>
                               <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">thy</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="entity">Gen_shallow</span> <span class="main">(</span><span class="entity">env</span><span class="main">,</span> <span class="entity">thy0</span><span class="main">)</span><span class="main">,</span> <span class="entity">thy</span><span class="main">)</span> <span class="keyword2"><span class="keyword">end</span></span>
    <span class="main">|</span> <span class="entity">Gen_syntax_print</span> <span class="entity">n</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">thy</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="entity">Gen_syntax_print</span> <span class="entity">n</span><span class="main">,</span> <span class="entity">thy</span><span class="main">)</span><span class="main">)</span>
    <span class="main">|</span> <span class="entity">Gen_deep</span> <span class="main">(</span><span class="entity">env</span><span class="main">,</span> <span class="entity">Internal_deep</span> <span class="main">(</span> <span class="entity">output_header_thy</span>
                                   <span class="main">,</span> <span class="entity">seri_args</span>
                                   <span class="main">,</span> <span class="entity">filename_thy</span>
                                   <span class="main">,</span> <span class="entity">tmp_export_code</span>
                                   <span class="main">,</span> <span class="entity">skip_exportation</span><span class="main">)</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">thy</span> <span class="main">=&gt;</span>
        <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span>
              warning <span class="main">(</span><span class="inner_quoted">"After closing Isabelle/jEdit, we may still need to remove this directory (by hand): "</span> ^
                       Path.implode <span class="main">(</span>Path.expand <span class="entity">tmp_export_code</span><span class="main">)</span><span class="main">)</span>
            <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">seri_args'</span> <span class="main">=</span> <span class="entity">List_mapi</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">i</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="main">(</span><span class="entity">ml_compiler</span><span class="main">,</span> <span class="entity">ml_module</span><span class="main">)</span><span class="main">,</span> <span class="entity">export_arg</span><span class="main">)</span> <span class="main">=&gt;</span>
              <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">tmp_export_code</span> <span class="main">=</span> <span class="entity">Deep.mk_path_export_code</span> <span class="entity">tmp_export_code</span> <span class="entity">ml_compiler</span> <span class="entity">i</span>
                  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk_fic</span> <span class="entity">s</span> <span class="main">=</span> Path.append <span class="entity">tmp_export_code</span> <span class="main">(</span>Path.make <span class="main">[</span><span class="entity">s</span><span class="main">]</span><span class="main">)</span>
                  <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="main">)</span> <span class="main">=</span> <span class="entity">Deep0.Find.check_compil</span> <span class="entity">ml_compiler</span> <span class="main">(</span><span class="main">)</span>
                  <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> <span class="entity">Isabelle_System.make_directory</span> <span class="entity">tmp_export_code</span> <span class="keyword2"><span class="keyword">in</span></span>
              <span class="main">(</span><span class="main">(</span><span class="main">(</span> <span class="main">(</span><span class="entity">ml_compiler</span><span class="main">,</span> <span class="entity">ml_module</span><span class="main">)</span>
                <span class="main">,</span> Path.implode <span class="main">(</span><span class="keyword2"><span class="keyword">if</span></span> <span class="entity">Deep0.Find.export_mode</span> <span class="entity">ml_compiler</span> <span class="main">=</span> <span class="entity">Deep0.Export_code_env.Directory</span> <span class="keyword2"><span class="keyword">then</span></span>
                                  <span class="entity">tmp_export_code</span>
                                <span class="keyword2"><span class="keyword">else</span></span>
                                  <span class="entity">mk_fic</span> <span class="main">(</span><span class="entity">Deep0.Find.function</span> <span class="entity">ml_compiler</span> <span class="main">(</span><span class="entity">Deep0.Find.ext</span> <span class="entity">ml_compiler</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
                <span class="main">,</span> <span class="entity">export_arg</span><span class="main">)</span><span class="main">,</span> <span class="entity">mk_fic</span><span class="main">)</span>
              <span class="keyword2"><span class="keyword">end</span></span><span class="main">)</span> <span class="entity">seri_args</span>
            <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">thy'</span> <span class="comment1">(* FIXME unused *)</span> <span class="main">=</span> <span class="entity">Isabelle_Code_Target.export_code_cmd</span>
                      <span class="main">(</span>List.exists <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="inner_quoted">"SML"</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> <span class="main">=&gt;</span> true <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> false<span class="main">)</span> <span class="entity">seri_args'</span><span class="main">)</span>
                      <span class="main">[</span><span class="entity">Deep0.Export_code_env.Isabelle.function</span><span class="main">]</span>
                      <span class="main">(</span>List.map <span class="main">(</span><span class="main">(</span>apfst o apsnd<span class="main">)</span> SOME o fst<span class="main">)</span> <span class="entity">seri_args'</span><span class="main">)</span>
                      <span class="main">(</span><span class="entity">Code_printing.apply_code_printing</span>
                        <span class="main">(</span><span class="entity">Deep0.apply_hs_code_identifiers</span> <span class="entity">Deep0.Export_code_env.Haskell.function</span> <span class="entity">thy</span><span class="main">)</span><span class="main">)</span>
            <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="main">)</span> <span class="main">=</span> fold <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="entity">ml_compiler</span><span class="main">,</span> <span class="entity">ml_module</span><span class="main">)</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span><span class="main">,</span> <span class="entity">mk_fic</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span>
              <span class="entity">Deep0.Find.init</span> <span class="entity">ml_compiler</span> <span class="entity">mk_fic</span> <span class="entity">ml_module</span> <span class="entity">Deep.mk_free</span> <span class="entity">thy</span><span class="main">)</span> <span class="entity">seri_args'</span> <span class="main">(</span><span class="main">)</span> <span class="keyword2"><span class="keyword">in</span></span>
        <span class="main">(</span><span class="entity">Gen_deep</span> <span class="main">(</span><span class="entity">env</span><span class="main">,</span> <span class="entity">Internal_deep</span> <span class="main">(</span> <span class="entity">output_header_thy</span>
                                      <span class="main">,</span> <span class="entity">seri_args</span>
                                      <span class="main">,</span> <span class="entity">filename_thy</span>
                                      <span class="main">,</span> <span class="entity">tmp_export_code</span>
                                      <span class="main">,</span> <span class="entity">skip_exportation</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="entity">thy</span><span class="main">)</span> <span class="keyword2"><span class="keyword">end</span></span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ctxt</span> <span class="main">=</span> Proof_Context.init_global <span class="entity">thy</span> <span class="keyword2"><span class="keyword">in</span></span>
      map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">f</span> <span class="main">=&gt;</span> <span class="entity">f</span> <span class="entity">ctxt</span><span class="main">)</span> <span class="entity">l_mode</span>
  <span class="keyword2"><span class="keyword">end</span></span>
  <span class="entity">thy</span> <span class="keyword2"><span class="keyword">in</span></span>
  Data_gen.map <span class="main">(</span>Symtab.map_default <span class="main">(</span><span class="entity">Deep0.default_key</span><span class="main">,</span> <span class="entity">l_mode</span><span class="main">)</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="entity">l_mode</span><span class="main">)</span><span class="main">)</span> <span class="entity">thy</span>
  <span class="keyword2"><span class="keyword">end</span></span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">update_compiler_config</span> <span class="entity">f</span> <span class="main">=</span>
  Data_gen.map
    <span class="main">(</span>Symtab.map_entry
      <span class="entity">Deep0.default_key</span>
      <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">l_mode</span> <span class="main">=&gt;</span>
        map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">Gen_deep</span> <span class="main">(</span><span class="entity">env</span><span class="main">,</span> <span class="entity">d</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">Gen_deep</span> <span class="main">(</span>META.compiler_env_config_update <span class="entity">f</span> <span class="entity">env</span><span class="main">,</span> <span class="entity">d</span><span class="main">)</span>
              <span class="main">|</span> <span class="entity">Gen_shallow</span> <span class="main">(</span><span class="entity">env</span><span class="main">,</span> <span class="entity">thy</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">Gen_shallow</span> <span class="main">(</span>META.compiler_env_config_update <span class="entity">f</span> <span class="entity">env</span><span class="main">,</span> <span class="entity">thy</span><span class="main">)</span>
              <span class="main">|</span> <span class="entity">Gen_syntax_print</span> <span class="entity">n</span> <span class="main">=&gt;</span> <span class="entity">Gen_syntax_print</span> <span class="entity">n</span><span class="main">)</span> <span class="entity">l_mode</span><span class="main">)</span><span class="main">)</span>
<span class="keyword2"><span class="keyword">end</span></span>
›</span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Factoring All Meta Commands Together›</span></span>

<span class="keyword1"><span class="command">setup</span></span><span class="quoted">‹ML_Antiquotation.inline <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">binding</span> mk_string<span class="antiquote">}</span></span></span> <span class="main">(</span>Scan.succeed
<span class="inner_quoted">"(fn ctxt =&gt; fn x =&gt; ML_Pretty.string_of_polyml (ML_system_pretty (x, FixedInt.fromInt (Config.get ctxt (ML_Print_Depth.print_depth)))))"</span><span class="main">)</span>
›</span>

<span class="keyword1"><span class="command">ML</span></span><span class="quoted">‹

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">exec_deep</span> <span class="main">(</span><span class="entity">env</span><span class="main">,</span> <span class="entity">output_header_thy</span><span class="main">,</span> <span class="entity">seri_args</span><span class="main">,</span> <span class="entity">filename_thy</span><span class="main">,</span> <span class="entity">tmp_export_code</span><span class="main">,</span> <span class="entity">l_obj</span><span class="main">)</span> <span class="entity">thy0</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword3"><span class="keyword">open</span></span> Generation_mode <span class="keyword2"><span class="keyword">in</span></span>
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">of_arg</span> <span class="main">=</span> META.isabelle_of_compiler_env_config META.isabelle_apply I <span class="keyword2"><span class="keyword">in</span></span>
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">def</span> <span class="entity">s</span> <span class="main">=</span> <span class="entity">Named_Target.theory_map</span> <span class="main">(</span>snd o <span class="entity">Specification.definition_cmd</span> NONE <span class="main">[</span><span class="main">]</span> <span class="main">[</span><span class="main">]</span> <span class="main">(</span>Binding.empty_atts<span class="main">,</span> <span class="entity">s</span><span class="main">)</span> false<span class="main">)</span> <span class="keyword2"><span class="keyword">in</span></span>
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">name_main</span> <span class="main">=</span> <span class="entity">Deep.mk_free</span> <span class="main">(</span>Proof_Context.init_global <span class="entity">thy0</span><span class="main">)</span>
                                   <span class="entity">Deep0.Export_code_env.Isabelle.argument_main</span> <span class="main">[</span><span class="main">]</span> <span class="keyword2"><span class="keyword">in</span></span>
  <span class="entity">thy0</span>
  |&gt; <span class="entity">def</span> <span class="main">(</span>String.concatWith <span class="inner_quoted">" "</span>
          <span class="main">(</span>  <span class="inner_quoted">"("</span> <span class="comment1">(* polymorphism weakening needed by export_code *)</span>
              ^ <span class="entity">name_main</span> ^ <span class="inner_quoted">" :: (_ × abr_string option) compiler_env_config_scheme)"</span>
          :: <span class="inner_quoted">"="</span>
          :: <span class="entity">To_string0</span>
               <span class="main">(</span><span class="entity">of_arg</span> <span class="main">(</span>META.compiler_env_config_more_map
                         <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="entity">l_obj</span><span class="main">,</span> <span class="entity">From.option</span>
                                             <span class="entity">From.string</span>
                                             <span class="main">(</span>Option.map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">filename_thy</span> <span class="main">=&gt;</span>
                                                            <span class="entity">Deep.absolute_path</span> <span class="entity">filename_thy</span> <span class="entity">thy0</span><span class="main">)</span>
                                                         <span class="entity">filename_thy</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
                         <span class="entity">env</span><span class="main">)</span><span class="main">)</span>
          :: <span class="main">[</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>
  |&gt; <span class="entity">Deep.export_code_cmd'</span> <span class="entity">seri_args</span>
                           <span class="entity">tmp_export_code</span>
                           <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span><span class="main">,</span> <span class="entity">msg</span><span class="main">)</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">err</span> <span class="main">=&gt;</span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">err</span> &lt;&gt; <span class="inner_numeral">0</span> <span class="keyword2"><span class="keyword">then</span></span> error <span class="entity">msg</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="main">(</span><span class="main">)</span><span class="main">)</span>
                           <span class="entity">filename_thy</span>
                           <span class="main">[</span><span class="entity">name_main</span><span class="main">]</span>
  |&gt; <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">l</span> <span class="main">=&gt;</span>
       <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">l_warn</span><span class="main">,</span> <span class="entity">l</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>map fst <span class="entity">l</span><span class="main">,</span> map snd <span class="entity">l</span><span class="main">)</span> <span class="keyword2"><span class="keyword">in</span></span>
       <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">Deep.list_all_eq</span> <span class="entity">l</span> <span class="keyword2"><span class="keyword">then</span></span>
         <span class="main">(</span>List.concat <span class="entity">l_warn</span><span class="main">,</span> hd <span class="entity">l</span><span class="main">)</span>
       <span class="keyword2"><span class="keyword">else</span></span>
         error <span class="inner_quoted">"There is an extracted language which does not produce a similar Isabelle content as the others"</span>
       <span class="keyword2"><span class="keyword">end</span></span><span class="main">)</span>
  |&gt; <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">l_warn</span><span class="main">,</span> <span class="entity">s</span><span class="main">)</span> <span class="main">=&gt;</span>
       <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="main">)</span> <span class="main">=</span> writeln
         <span class="main">(</span><span class="keyword2"><span class="keyword">case</span></span> <span class="main">(</span><span class="entity">output_header_thy</span><span class="main">,</span> <span class="entity">filename_thy</span><span class="main">)</span> <span class="keyword2"><span class="keyword">of</span></span>
            <span class="main">(</span>SOME <span class="main">_</span><span class="main">,</span> SOME <span class="main">_</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">s</span>
          <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> String.concat <span class="main">(</span>map <span class="main">(</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">s</span> <span class="main">=&gt;</span> <span class="entity">s</span> ^ <span class="inner_quoted">"\n"</span><span class="main">)</span>
                                    o Active.sendback_markup_command
                                    o trim_line<span class="main">)</span>
             <span class="main">(</span>String.tokens <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">c</span> <span class="main">=&gt;</span> <span class="entity">c</span> <span class="main">=</span> <span class="inner_quoted">#"\t"</span><span class="main">)</span> <span class="entity">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword2"><span class="keyword">in</span></span>
       fold <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">out</span><span class="main">,</span> <span class="entity">err</span><span class="main">)</span> <span class="main">=&gt;</span> K <span class="main">(</span> writeln <span class="main">(</span>Markup.markup Markup.keyword2 <span class="entity">err</span><span class="main">)</span>
                                <span class="main">;</span> <span class="keyword2"><span class="keyword">case</span></span> trim_line <span class="entity">out</span> <span class="keyword2"><span class="keyword">of</span></span>
                                    <span class="inner_quoted">""</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="main">)</span>
                                  <span class="main">|</span> <span class="entity">out</span> <span class="main">=&gt;</span> writeln <span class="main">(</span>Markup.markup Markup.keyword1 <span class="entity">out</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
            <span class="entity">l_warn</span>
            <span class="main">(</span><span class="main">)</span> <span class="keyword2"><span class="keyword">end</span></span><span class="main">)</span>

  <span class="keyword2"><span class="keyword">end</span></span> <span class="keyword2"><span class="keyword">end</span></span> <span class="keyword2"><span class="keyword">end</span></span> <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">outer_syntax_command0</span> <span class="entity">mk_string</span> <span class="entity">cmd_spec</span> <span class="entity">cmd_descr</span> <span class="entity">parser</span> <span class="entity">get_all_meta_embed</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword3"><span class="keyword">open</span></span> Generation_mode <span class="keyword2"><span class="keyword">in</span></span>
  <span class="entity">Outer_Syntax.command</span> <span class="entity">cmd_spec</span> <span class="entity">cmd_descr</span>
    <span class="main">(</span><span class="entity">parser</span> &gt;&gt; <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">name</span> <span class="main">=&gt;</span>
      <span class="entity">Toplevel.theory</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">thy</span> <span class="main">=&gt;</span>
        <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">env</span><span class="main">,</span> <span class="entity">thy</span><span class="main">)</span> <span class="main">=</span>
        META.mapM

          <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">get_all_meta_embed</span> <span class="main">=</span> <span class="entity">get_all_meta_embed</span> <span class="entity">name</span> <span class="keyword2"><span class="keyword">in</span></span>
          <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">Gen_syntax_print</span> <span class="entity">n</span> <span class="main">=&gt;</span>
               <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">thy</span> <span class="main">=&gt;</span>
                  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> writeln
                                <span class="main">(</span><span class="entity">mk_string</span>
                                  <span class="main">(</span>Proof_Context.init_global
                                    <span class="main">(</span><span class="keyword2"><span class="keyword">case</span></span> <span class="entity">n</span> <span class="keyword2"><span class="keyword">of</span></span> NONE <span class="main">=&gt;</span> <span class="entity">thy</span>
                                             <span class="main">|</span> SOME <span class="entity">n</span> <span class="main">=&gt;</span> Config.put_global ML_Print_Depth.print_depth <span class="entity">n</span> <span class="entity">thy</span><span class="main">)</span><span class="main">)</span>
                                  <span class="entity">name</span><span class="main">)</span> <span class="keyword2"><span class="keyword">in</span></span>
                  <span class="main">(</span><span class="entity">Gen_syntax_print</span> <span class="entity">n</span><span class="main">,</span> <span class="entity">thy</span><span class="main">)</span>
                  <span class="keyword2"><span class="keyword">end</span></span><span class="main">)</span>
           <span class="main">|</span> <span class="entity">Gen_deep</span> <span class="main">(</span><span class="entity">env</span><span class="main">,</span> <span class="entity">Internal_deep</span> <span class="main">(</span> <span class="entity">output_header_thy</span>
                                          <span class="main">,</span> <span class="entity">seri_args</span>
                                          <span class="main">,</span> <span class="entity">filename_thy</span>
                                          <span class="main">,</span> <span class="entity">tmp_export_code</span>
                                          <span class="main">,</span> <span class="entity">skip_exportation</span><span class="main">)</span><span class="main">)</span> <span class="main">=&gt;</span>
              <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">thy0</span> <span class="main">=&gt;</span>
                <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">l_obj</span> <span class="main">=</span> <span class="entity">get_all_meta_embed</span> <span class="entity">thy0</span> <span class="keyword2"><span class="keyword">in</span></span>
                <span class="entity">thy0</span> |&gt; <span class="main">(</span><span class="keyword2"><span class="keyword">if</span></span> <span class="entity">skip_exportation</span> <span class="keyword2"><span class="keyword">then</span></span>
                           K <span class="main">(</span><span class="main">)</span>
                         <span class="keyword2"><span class="keyword">else</span></span>
                           <span class="entity">exec_deep</span> <span class="main">(</span> META.d_output_header_thy_update <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> NONE<span class="main">)</span> <span class="entity">env</span>
                                     <span class="main">,</span> <span class="entity">output_header_thy</span>
                                     <span class="main">,</span> <span class="entity">seri_args</span>
                                     <span class="main">,</span> NONE
                                     <span class="main">,</span> <span class="entity">tmp_export_code</span>
                                     <span class="main">,</span> <span class="entity">l_obj</span><span class="main">)</span><span class="main">)</span>
                     |&gt; K <span class="main">(</span><span class="entity">Gen_deep</span> <span class="main">(</span> META.fold_thy_deep <span class="entity">l_obj</span> <span class="entity">env</span>
                                    <span class="main">,</span> <span class="entity">Internal_deep</span> <span class="main">(</span> <span class="entity">output_header_thy</span>
                                                    <span class="main">,</span> <span class="entity">seri_args</span>
                                                    <span class="main">,</span> <span class="entity">filename_thy</span>
                                                    <span class="main">,</span> <span class="entity">tmp_export_code</span>
                                                    <span class="main">,</span> <span class="entity">skip_exportation</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="entity">thy0</span><span class="main">)</span>
                <span class="keyword2"><span class="keyword">end</span></span><span class="main">)</span>
           <span class="main">|</span> <span class="entity">Gen_shallow</span> <span class="main">(</span><span class="entity">env</span><span class="main">,</span> <span class="entity">thy0</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">thy</span> <span class="main">=&gt;</span>
             <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">aux</span> <span class="main">(</span><span class="entity">env</span><span class="main">,</span> <span class="entity">thy</span><span class="main">)</span> <span class="entity">x</span> <span class="main">=</span>
                  META.fold_thy_shallow
                   <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">f</span> <span class="main">=&gt;</span> <span class="entity">f</span> <span class="main">(</span><span class="main">)</span> <span class="keyword3"><span class="keyword">handle</span></span> ERROR <span class="entity">e</span> <span class="main">=&gt;</span>
                     <span class="main">(</span> warning <span class="inner_quoted">"Shallow Backtracking: (true) Isabelle declarations occurring among the META-simulated ones are ignored (if any)"</span>
                       <span class="comment1">(* TODO automatically determine if there is such Isabelle declarations,
                               for raising earlier a specific error message *)</span>
                     <span class="main">;</span> error <span class="entity">e</span><span class="main">)</span><span class="main">)</span>
                   <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="entity">thy0</span><span class="main">)</span>
                   <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">l</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">env</span><span class="main">,</span> <span class="entity">thy</span><span class="main">)</span> <span class="main">=&gt;</span>
                     <span class="entity">Bind_META.all_meta</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">x</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">thy</span> <span class="main">=&gt;</span> <span class="entity">aux</span> <span class="main">(</span><span class="entity">env</span><span class="main">,</span> <span class="entity">thy</span><span class="main">)</span> <span class="main">[</span><span class="entity">x</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span>pair <span class="entity">env</span><span class="main">)</span> <span class="entity">l</span> <span class="entity">thy</span><span class="main">)</span>
                   <span class="entity">x</span>
                   <span class="main">(</span><span class="entity">env</span><span class="main">,</span> <span class="entity">thy</span><span class="main">)</span>
                 <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">env</span><span class="main">,</span> <span class="entity">thy</span><span class="main">)</span> <span class="main">=</span> <span class="entity">aux</span> <span class="main">(</span><span class="entity">env</span><span class="main">,</span> <span class="entity">thy</span><span class="main">)</span> <span class="main">(</span><span class="entity">get_all_meta_embed</span> <span class="entity">thy</span><span class="main">)</span> <span class="keyword2"><span class="keyword">in</span></span>
             <span class="main">(</span><span class="entity">Gen_shallow</span> <span class="main">(</span><span class="entity">env</span><span class="main">,</span> <span class="entity">thy0</span><span class="main">)</span><span class="main">,</span> <span class="entity">thy</span><span class="main">)</span>
             <span class="keyword2"><span class="keyword">end</span></span>
          <span class="keyword2"><span class="keyword">end</span></span>

          <span class="main">(</span><span class="keyword2"><span class="keyword">case</span></span> Symtab.lookup <span class="main">(</span>Data_gen.get <span class="entity">thy</span><span class="main">)</span> <span class="entity">Deep0.default_key</span> <span class="keyword2"><span class="keyword">of</span></span> SOME <span class="entity">l</span> <span class="main">=&gt;</span> <span class="entity">l</span>
                                                                    <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="main">[</span><span class="entity">Gen_syntax_print</span> NONE<span class="main">]</span><span class="main">)</span>
          <span class="entity">thy</span>
        <span class="keyword2"><span class="keyword">in</span></span>
        Data_gen.map <span class="main">(</span>Symtab.update <span class="main">(</span><span class="entity">Deep0.default_key</span><span class="main">,</span> <span class="entity">env</span><span class="main">)</span><span class="main">)</span> <span class="entity">thy</span> <span class="keyword2"><span class="keyword">end</span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">outer_syntax_command</span> <span class="entity">mk_string</span> <span class="entity">cmd_spec</span> <span class="entity">cmd_descr</span> <span class="entity">parser</span> <span class="entity">get_all_meta_embed</span> <span class="main">=</span>
 <span class="entity">outer_syntax_command0</span> <span class="entity">mk_string</span> <span class="entity">cmd_spec</span> <span class="entity">cmd_descr</span> <span class="entity">parser</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">a</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">thy</span> <span class="main">=&gt;</span> <span class="main">[</span><span class="entity">get_all_meta_embed</span> <span class="entity">a</span> <span class="entity">thy</span><span class="main">]</span><span class="main">)</span>

›</span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Parameterizing the Semantics of Embedded Languages›</span></span>

<span class="keyword1"><span class="command">ML</span></span><span class="quoted">‹
<span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="main">)</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword3"><span class="keyword">open</span></span> Generation_mode <span class="keyword2"><span class="keyword">in</span></span>
  <span class="entity">Outer_Syntax.command</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">command_keyword</span> <span class="keyword1">generation_syntax</span><span class="antiquote">}</span></span></span> <span class="inner_quoted">"set the generating list"</span>
    <span class="main">(</span><span class="main">(</span>   <span class="entity">mode</span> &gt;&gt; <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">x</span> <span class="main">=&gt;</span> SOME <span class="main">[</span><span class="entity">x</span><span class="main">]</span><span class="main">)</span>
      || <span class="entity">parse_l'</span> <span class="entity">mode</span> &gt;&gt; SOME
      || <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">keyword</span> "<span class="keyword2">deep</span>"<span class="antiquote">}</span></span></span> -- <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">keyword</span> "<span class="keyword2">flush_all</span>"<span class="antiquote">}</span></span></span> &gt;&gt; K NONE<span class="main">)</span> &gt;&gt;
    <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> SOME <span class="entity">x</span> <span class="main">=&gt;</span> <span class="entity">f_command</span> <span class="entity">x</span>
      <span class="main">|</span> NONE <span class="main">=&gt;</span>
      <span class="entity">Toplevel.theory</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">thy</span> <span class="main">=&gt;</span>
        <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">l</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">case</span></span> Symtab.lookup <span class="main">(</span>Data_gen.get <span class="entity">thy</span><span class="main">)</span> <span class="entity">Deep0.default_key</span> <span class="keyword2"><span class="keyword">of</span></span> SOME <span class="entity">l</span> <span class="main">=&gt;</span> <span class="entity">l</span> <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="main">[</span><span class="main">]</span>
            <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">l</span> <span class="main">=</span> List.concat <span class="main">(</span>List.map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">Gen_deep</span> <span class="entity">x</span> <span class="main">=&gt;</span> <span class="main">[</span><span class="entity">x</span><span class="main">]</span> <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="main">[</span><span class="main">]</span><span class="main">)</span> <span class="entity">l</span><span class="main">)</span>
            <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">l</span> <span class="keyword2"><span class="keyword">of</span></span> <span class="main">[</span><span class="main">]</span> <span class="main">=&gt;</span> warning <span class="inner_quoted">"Nothing to perform."</span> <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="main">)</span>
            <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">thy</span> <span class="main">=</span>
        fold
          <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">env</span><span class="main">,</span> <span class="entity">Internal_deep</span> <span class="main">(</span><span class="entity">output_header_thy</span><span class="main">,</span> <span class="entity">seri_args</span><span class="main">,</span> <span class="entity">filename_thy</span><span class="main">,</span> <span class="entity">tmp_export_code</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">thy0</span> <span class="main">=&gt;</span>
            <span class="entity">thy0</span> |&gt; <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">env</span><span class="main">,</span> <span class="entity">l_exec</span><span class="main">)</span> <span class="main">=</span> META.compiler_env_config_reset_all <span class="entity">env</span> <span class="keyword2"><span class="keyword">in</span></span>
                    <span class="entity">exec_deep</span> <span class="main">(</span><span class="entity">env</span><span class="main">,</span> <span class="entity">output_header_thy</span><span class="main">,</span> <span class="entity">seri_args</span><span class="main">,</span> <span class="entity">filename_thy</span><span class="main">,</span> <span class="entity">tmp_export_code</span><span class="main">,</span> <span class="entity">l_exec</span><span class="main">)</span> <span class="keyword2"><span class="keyword">end</span></span>
                 |&gt; K <span class="entity">thy0</span><span class="main">)</span>
          <span class="entity">l</span>
          <span class="entity">thy</span>
        <span class="keyword2"><span class="keyword">in</span></span>
        <span class="entity">thy</span> <span class="keyword2"><span class="keyword">end</span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
<span class="keyword2"><span class="keyword">end</span></span>
›</span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Common Parser for Toy›</span></span>

<span class="keyword1"><span class="command">ML</span></span><span class="quoted">‹
<span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">TOY_parse</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">struct</span></span>
  <span class="keyword1"><span class="keyword">datatype</span></span> <span class="main">(</span>'a<span class="main">,</span> 'b<span class="main">)</span> <span class="entity">use_context</span> <span class="main">=</span> <span class="entity">TOY_context_invariant</span> <span class="keyword2"><span class="keyword">of</span></span> 'a
                                <span class="main">|</span> <span class="entity">TOY_context_pre_post</span> <span class="keyword2"><span class="keyword">of</span></span> 'b

  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">optional</span> <span class="entity">f</span> <span class="main">=</span> Scan.optional <span class="main">(</span><span class="entity">f</span> &gt;&gt; SOME<span class="main">)</span> NONE
  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">colon</span> <span class="main">=</span> Parse.$$$ <span class="inner_quoted">":"</span>
  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">repeat2</span> <span class="entity">scan</span> <span class="main">=</span> <span class="entity">scan</span> ::: Scan.repeat1 <span class="entity">scan</span>

  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">xml_unescape</span> <span class="entity">s</span> <span class="main">=</span> <span class="main">(</span>XML.content_of <span class="main">(</span>YXML.parse_body <span class="entity">s</span><span class="main">)</span><span class="main">,</span> Position.none<span class="main">)</span>
                       |&gt; Symbol_Pos.explode |&gt; Symbol_Pos.implode |&gt; <span class="entity">From.string</span>

  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">outer_syntax_command2</span> <span class="entity">mk_string</span> <span class="entity">cmd_spec</span> <span class="entity">cmd_descr</span> <span class="entity">parser</span> <span class="entity">v_true</span> <span class="entity">v_false</span> <span class="entity">get_all_meta_embed</span> <span class="main">=</span>
    <span class="entity">outer_syntax_command</span> <span class="entity">mk_string</span> <span class="entity">cmd_spec</span> <span class="entity">cmd_descr</span>
      <span class="main">(</span><span class="entity">optional</span> <span class="main">(</span><span class="entity">paren</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">keyword</span> "<span class="keyword2">shallow</span>"<span class="antiquote">}</span></span></span><span class="main">)</span> -- <span class="entity">parser</span><span class="main">)</span>
      <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">is_shallow</span><span class="main">,</span> <span class="entity">use</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">thy</span> <span class="main">=&gt;</span>
         <span class="entity">get_all_meta_embed</span>
           <span class="main">(</span><span class="keyword2"><span class="keyword">if</span></span> <span class="entity">is_shallow</span> <span class="main">=</span> NONE <span class="keyword2"><span class="keyword">then</span></span>
              <span class="main">(</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">s</span> <span class="main">=&gt;</span>
                  META.T_to_be_parsed <span class="main">(</span> <span class="entity">From.string</span> <span class="entity">s</span>
                                     <span class="main">,</span> <span class="entity">xml_unescape</span> <span class="entity">s</span><span class="main">)</span>
              <span class="main">,</span> <span class="entity">v_true</span><span class="main">)</span>
            <span class="keyword2"><span class="keyword">else</span></span>
              <span class="main">(</span><span class="entity">From.toy_ctxt_term</span> <span class="entity">thy</span><span class="main">,</span> <span class="entity">v_false</span><span class="main">)</span><span class="main">)</span>
           <span class="entity">use</span><span class="main">)</span>

  <span class="comment1">(* *)</span>

  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ident_dot_dot</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">f</span> <span class="main">=</span> Parse.sym_ident &gt;&gt; <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="inner_quoted">"∙"</span> <span class="main">=&gt;</span> <span class="inner_quoted">"∙"</span> <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> Scan.fail <span class="inner_quoted">"Syntax error"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">in</span></span>
                      <span class="entity">f</span> -- <span class="entity">f</span> <span class="keyword2"><span class="keyword">end</span></span>
  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ident_star</span> <span class="main">=</span> Parse.sym_ident <span class="comment1">(* "*" *)</span>

  <span class="comment1">(* *)</span>

  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">unlimited_natural</span> <span class="main">=</span>  <span class="entity">ident_star</span> &gt;&gt; <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="inner_quoted">"*"</span> <span class="main">=&gt;</span> META.Mult_star
                                           <span class="main">|</span> <span class="inner_quoted">"∞"</span> <span class="main">=&gt;</span> META.Mult_infinity
                                           <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> Scan.fail <span class="inner_quoted">"Syntax error"</span><span class="main">)</span>
                        || Parse.number &gt;&gt; <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">s</span> <span class="main">=&gt;</span> META.Mult_nat
                                                      <span class="main">(</span><span class="keyword2"><span class="keyword">case</span></span> Int.fromString <span class="entity">s</span> <span class="keyword2"><span class="keyword">of</span></span>
                                                         SOME <span class="entity">i</span> <span class="main">=&gt;</span> Code_Numeral.natural_of_integer <span class="entity">i</span>
                                                       <span class="main">|</span> NONE <span class="main">=&gt;</span> Scan.fail <span class="inner_quoted">"Syntax error"</span><span class="main">)</span><span class="main">)</span>
  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">term_base</span> <span class="main">=</span>
       Parse.number &gt;&gt; <span class="main">(</span>META.ToyDefInteger o <span class="entity">From.string</span><span class="main">)</span>
    || Parse.float_number &gt;&gt; <span class="main">(</span>META.ToyDefReal o <span class="main">(</span><span class="entity">From.pair</span> <span class="entity">From.string</span> <span class="entity">From.string</span> o
         <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">s</span> <span class="main">=&gt;</span> <span class="keyword2"><span class="keyword">case</span></span> String.tokens <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="inner_quoted">#"."</span> <span class="main">=&gt;</span> true
                                       <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> false<span class="main">)</span> <span class="entity">s</span> <span class="keyword2"><span class="keyword">of</span></span> <span class="main">[</span><span class="entity">l1</span><span class="main">,</span><span class="entity">l2</span><span class="main">]</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="entity">l1</span><span class="main">,</span><span class="entity">l2</span><span class="main">)</span>
                                                        <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> Scan.fail <span class="inner_quoted">"Syntax error"</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
    || Parse.string &gt;&gt; <span class="main">(</span>META.ToyDefString o <span class="entity">From.string</span><span class="main">)</span>

  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">multiplicity</span> <span class="main">=</span> <span class="entity">parse_l'</span> <span class="main">(</span><span class="entity">unlimited_natural</span> -- <span class="entity">optional</span> <span class="main">(</span><span class="entity">ident_dot_dot</span> |-- <span class="entity">unlimited_natural</span><span class="main">)</span><span class="main">)</span>

  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">toy_term</span> <span class="entity">x</span> <span class="main">=</span>
   <span class="main">(</span>   <span class="entity">term_base</span> &gt;&gt; META.ShallB_term
    || Parse.binding &gt;&gt; <span class="main">(</span>META.ShallB_str o <span class="entity">From.binding</span><span class="main">)</span>
    || <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">keyword</span> "<span class="keyword2">self</span>"<span class="antiquote">}</span></span></span> |-- Parse.nat &gt;&gt; <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">n</span> <span class="main">=&gt;</span> META.ShallB_self <span class="main">(</span><span class="entity">From.internal_oid</span> <span class="entity">n</span><span class="main">)</span><span class="main">)</span>
    || <span class="entity">paren</span> <span class="main">(</span>Parse.list <span class="entity">toy_term</span><span class="main">)</span> &gt;&gt; <span class="comment1">(* untyped, corresponds to Set, Sequence or Pair *)</span>
                                      <span class="comment1">(* WARNING for Set: we are describing a finite set *)</span>
                                      META.ShallB_list<span class="main">)</span> <span class="entity">x</span>

  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">name_object</span> <span class="main">=</span> <span class="entity">optional</span> <span class="main">(</span>Parse.list1 Parse.binding --| <span class="entity">colon</span><span class="main">)</span> -- Parse.binding

  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">type_object_weak</span> <span class="main">=</span>
    <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">name_object</span> <span class="main">=</span> Parse.binding &gt;&gt; <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">s</span> <span class="main">=&gt;</span> <span class="main">(</span>NONE<span class="main">,</span> <span class="entity">s</span><span class="main">)</span><span class="main">)</span> <span class="keyword2"><span class="keyword">in</span></span>
                    <span class="entity">name_object</span> -- Scan.repeat <span class="main">(</span>Parse.$$$ <span class="inner_quoted">"&lt;"</span> |-- Parse.list1 <span class="entity">name_object</span><span class="main">)</span> &gt;&gt;
    <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">f</span> <span class="main">=</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="entity">s</span><span class="main">)</span> <span class="main">=&gt;</span> META.ToyTyCore_pre <span class="main">(</span><span class="entity">From.binding</span> <span class="entity">s</span><span class="main">)</span> <span class="keyword2"><span class="keyword">in</span></span>
    <span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">s</span><span class="main">,</span> <span class="entity">l</span><span class="main">)</span> <span class="main">=&gt;</span> META.ToyTyObj <span class="main">(</span><span class="entity">f</span> <span class="entity">s</span><span class="main">,</span> map <span class="main">(</span>map <span class="entity">f</span><span class="main">)</span> <span class="entity">l</span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">end</span></span>
    <span class="keyword2"><span class="keyword">end</span></span>

  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">type_object</span> <span class="main">=</span> <span class="entity">name_object</span> -- Scan.repeat <span class="main">(</span>Parse.$$$ <span class="inner_quoted">"&lt;"</span> |-- Parse.list1 <span class="entity">name_object</span><span class="main">)</span> &gt;&gt;
    <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">f</span> <span class="main">=</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="entity">s</span><span class="main">)</span> <span class="main">=&gt;</span> META.ToyTyCore_pre <span class="main">(</span><span class="entity">From.binding</span> <span class="entity">s</span><span class="main">)</span> <span class="keyword2"><span class="keyword">in</span></span>
    <span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">s</span><span class="main">,</span> <span class="entity">l</span><span class="main">)</span> <span class="main">=&gt;</span> META.ToyTyObj <span class="main">(</span><span class="entity">f</span> <span class="entity">s</span><span class="main">,</span> map <span class="main">(</span>map <span class="entity">f</span><span class="main">)</span> <span class="entity">l</span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">end</span></span>

  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">category</span> <span class="main">=</span>
       <span class="entity">multiplicity</span>
    -- <span class="entity">optional</span> <span class="main">(</span><span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">keyword</span> "<span class="keyword2">Role</span>"<span class="antiquote">}</span></span></span> |-- Parse.binding<span class="main">)</span>
    -- Scan.repeat <span class="main">(</span>   <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">keyword</span> "<span class="keyword2">Ordered</span>"<span class="antiquote">}</span></span></span> &gt;&gt; K META.Ordered0
                    || <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">keyword</span> "<span class="keyword2">Subsets</span>"<span class="antiquote">}</span></span></span> |-- Parse.binding &gt;&gt; K META.Subsets0
                    || <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">keyword</span> "<span class="keyword2">Union</span>"<span class="antiquote">}</span></span></span> &gt;&gt; K META.Union0
                    || <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">keyword</span> "<span class="keyword2">Redefines</span>"<span class="antiquote">}</span></span></span> |-- Parse.binding &gt;&gt; K META.Redefines0
                    || <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">keyword</span> "<span class="keyword2">Derived</span>"<span class="antiquote">}</span></span></span> -- Parse.$$$ <span class="inner_quoted">"="</span> |-- Parse.term &gt;&gt; K META.Derived0
                    || <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">keyword</span> "<span class="keyword2">Qualifier</span>"<span class="antiquote">}</span></span></span> |-- Parse.term &gt;&gt; K META.Qualifier0
                    || <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">keyword</span> "<span class="keyword2">Nonunique</span>"<span class="antiquote">}</span></span></span> &gt;&gt; K META.Nonunique0
                    || <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">keyword</span> "<span class="keyword2">Sequence_</span>"<span class="antiquote">}</span></span></span> &gt;&gt; K META.Sequence<span class="main">)</span> &gt;&gt;
    <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="main">(</span><span class="entity">l_mult</span><span class="main">,</span> <span class="entity">role</span><span class="main">)</span><span class="main">,</span> <span class="entity">l</span><span class="main">)</span> <span class="main">=&gt;</span>
       META.Toy_multiplicity_ext <span class="main">(</span><span class="entity">l_mult</span><span class="main">,</span> <span class="entity">From.option</span> <span class="entity">From.binding</span> <span class="entity">role</span><span class="main">,</span> <span class="entity">l</span><span class="main">,</span> <span class="main">(</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>

  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">type_base</span> <span class="main">=</span>   Parse.reserved <span class="inner_quoted">"Void"</span> &gt;&gt; K META.ToyTy_base_void
                 || Parse.reserved <span class="inner_quoted">"Boolean"</span> &gt;&gt; K META.ToyTy_base_boolean
                 || Parse.reserved <span class="inner_quoted">"Integer"</span> &gt;&gt; K META.ToyTy_base_integer
                 || Parse.reserved <span class="inner_quoted">"UnlimitedNatural"</span> &gt;&gt; K META.ToyTy_base_unlimitednatural
                 || Parse.reserved <span class="inner_quoted">"Real"</span> &gt;&gt; K META.ToyTy_base_real
                 || Parse.reserved <span class="inner_quoted">"String"</span> &gt;&gt; K META.ToyTy_base_string

  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">use_type_gen</span> <span class="entity">type_object</span> <span class="entity">v</span> <span class="main">=</span>
     <span class="main">(</span><span class="comment1">(* collection *)</span>
      Parse.reserved <span class="inner_quoted">"Set"</span> |-- <span class="entity">use_type</span> &gt;&gt;
        <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">l</span> <span class="main">=&gt;</span> META.ToyTy_collection <span class="main">(</span>META.Toy_multiplicity_ext <span class="main">(</span><span class="main">[</span><span class="main">]</span><span class="main">,</span> NONE<span class="main">,</span> <span class="main">[</span>META.Set<span class="main">]</span><span class="main">,</span> <span class="main">(</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="entity">l</span><span class="main">)</span><span class="main">)</span>
   || Parse.reserved <span class="inner_quoted">"Sequence"</span> |-- <span class="entity">use_type</span> &gt;&gt;
        <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">l</span> <span class="main">=&gt;</span> META.ToyTy_collection <span class="main">(</span>META.Toy_multiplicity_ext <span class="main">(</span><span class="main">[</span><span class="main">]</span><span class="main">,</span> NONE<span class="main">,</span> <span class="main">[</span>META.Sequence<span class="main">]</span><span class="main">,</span> <span class="main">(</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="entity">l</span><span class="main">)</span><span class="main">)</span>
   || <span class="entity">category</span> -- <span class="entity">use_type</span> &gt;&gt; META.ToyTy_collection

      <span class="comment1">(* pair *)</span>
   || Parse.reserved <span class="inner_quoted">"Pair"</span> |--
      <span class="main">(</span>   <span class="entity">use_type</span> -- <span class="entity">use_type</span>
      || Parse.$$$ <span class="inner_quoted">"("</span> |-- <span class="entity">use_type</span> --| Parse.$$$ <span class="inner_quoted">","</span> -- <span class="entity">use_type</span> --| Parse.$$$ <span class="inner_quoted">")"</span><span class="main">)</span> &gt;&gt; META.ToyTy_pair

      <span class="comment1">(* base *)</span>
   || <span class="entity">type_base</span>

      <span class="comment1">(* raw HOL *)</span>
   || Parse.sym_ident <span class="comment1">(* "´" *)</span> |-- Parse.typ --| Parse.sym_ident <span class="comment1">(* "´" *)</span> &gt;&gt;
        <span class="main">(</span>META.ToyTy_raw o <span class="entity">xml_unescape</span><span class="main">)</span>

      <span class="comment1">(* object type *)</span>
   || <span class="entity">type_object</span> &gt;&gt; META.ToyTy_object

   || <span class="main">(</span><span class="main">(</span>Parse.$$$ <span class="inner_quoted">"("</span> |-- Parse.list <span class="main">(</span>   <span class="main">(</span>Parse.binding --| <span class="entity">colon</span> &gt;&gt; <span class="main">(</span><span class="entity">From.option</span> <span class="entity">From.binding</span> o SOME<span class="main">)</span><span class="main">)</span>
                                      -- <span class="main">(</span>   Parse.$$$ <span class="inner_quoted">"("</span> |-- <span class="entity">use_type</span> --| Parse.$$$ <span class="inner_quoted">")"</span>
                                          || <span class="entity">use_type_gen</span> <span class="entity">type_object_weak</span><span class="main">)</span> &gt;&gt; META.ToyTy_binding
                                      <span class="main">)</span> --| Parse.$$$ <span class="inner_quoted">")"</span>
        &gt;&gt; <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">ty_arg</span> <span class="main">=&gt;</span> <span class="keyword2"><span class="keyword">case</span></span> rev <span class="entity">ty_arg</span> <span class="keyword2"><span class="keyword">of</span></span>
              <span class="main">[</span><span class="main">]</span> <span class="main">=&gt;</span> META.ToyTy_base_void
            <span class="main">|</span> <span class="entity">ty_arg</span> <span class="main">=&gt;</span> fold <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">x</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">acc</span> <span class="main">=&gt;</span> META.ToyTy_pair <span class="main">(</span><span class="entity">x</span><span class="main">,</span> <span class="entity">acc</span><span class="main">)</span><span class="main">)</span>
                             <span class="main">(</span>tl <span class="entity">ty_arg</span><span class="main">)</span>
                             <span class="main">(</span>hd <span class="entity">ty_arg</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
       -- <span class="entity">optional</span> <span class="main">(</span><span class="entity">colon</span> |-- <span class="entity">use_type</span><span class="main">)</span><span class="main">)</span>
      &gt;&gt; <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">ty_arg</span><span class="main">,</span> <span class="entity">ty_out</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">ty_out</span> <span class="keyword2"><span class="keyword">of</span></span> NONE <span class="main">=&gt;</span> <span class="entity">ty_arg</span>
                                              <span class="main">|</span> SOME <span class="entity">ty_out</span> <span class="main">=&gt;</span> META.ToyTy_arrow <span class="main">(</span><span class="entity">ty_arg</span><span class="main">,</span> <span class="entity">ty_out</span><span class="main">)</span><span class="main">)</span>
   || <span class="main">(</span>Parse.$$$ <span class="inner_quoted">"("</span> |-- <span class="entity">use_type</span> --| Parse.$$$ <span class="inner_quoted">")"</span> &gt;&gt; <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">s</span> <span class="main">=&gt;</span> META.ToyTy_binding <span class="main">(</span>NONE<span class="main">,</span> <span class="entity">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="entity">v</span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="entity">use_type</span> <span class="entity">x</span> <span class="main">=</span> <span class="entity">use_type_gen</span> <span class="entity">type_object</span> <span class="entity">x</span>

  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">use_prop</span> <span class="main">=</span>
   <span class="main">(</span><span class="entity">optional</span> <span class="main">(</span><span class="entity">optional</span> <span class="main">(</span>Parse.binding &gt;&gt; <span class="entity">From.binding</span><span class="main">)</span> --| Parse.$$$ <span class="inner_quoted">":"</span><span class="main">)</span> &gt;&gt; <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> NONE <span class="main">=&gt;</span> NONE
                                                                               <span class="main">|</span> SOME <span class="entity">x</span> <span class="main">=&gt;</span> <span class="entity">x</span><span class="main">)</span><span class="main">)</span>
   -- Parse.term --| <span class="entity">optional</span> <span class="main">(</span>Parse.$$$ <span class="inner_quoted">";"</span><span class="main">)</span> &gt;&gt; <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">n</span><span class="main">,</span> <span class="entity">e</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">from_expr</span> <span class="main">=&gt;</span>
                                                  META.ToyProp_ctxt <span class="main">(</span><span class="entity">n</span><span class="main">,</span> <span class="entity">from_expr</span> <span class="entity">e</span><span class="main">)</span><span class="main">)</span>

  <span class="comment1">(* *)</span>

  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">association_end</span> <span class="main">=</span>
       <span class="entity">type_object</span>
    -- <span class="entity">category</span>
    --| <span class="entity">optional</span> <span class="main">(</span>Parse.$$$ <span class="inner_quoted">";"</span><span class="main">)</span>

  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">association</span> <span class="main">=</span> <span class="entity">optional</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">keyword</span> "<span class="keyword2">Between</span>"<span class="antiquote">}</span></span></span> |-- Scan.optional <span class="main">(</span><span class="entity">repeat2</span> <span class="entity">association_end</span><span class="main">)</span> <span class="main">[</span><span class="main">]</span>

  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">invariant</span> <span class="main">=</span>
         <span class="entity">optional</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">keyword</span> "<span class="keyword2">Constraints</span>"<span class="antiquote">}</span></span></span>
     |-- Scan.optional <span class="main">(</span><span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">keyword</span> "<span class="keyword2">Existential</span>"<span class="antiquote">}</span></span></span> &gt;&gt; K true<span class="main">)</span> false
     --| <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">keyword</span> "<span class="keyword2">Inv</span>"<span class="antiquote">}</span></span></span>
     --  <span class="entity">use_prop</span>

  <span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">Outer_syntax_Association</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">struct</span></span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">make</span> <span class="entity">ass_ty</span> <span class="entity">l</span> <span class="main">=</span> META.Toy_association_ext <span class="main">(</span><span class="entity">ass_ty</span><span class="main">,</span> META.ToyAssRel <span class="entity">l</span><span class="main">,</span> <span class="main">(</span><span class="main">)</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">end</span></span>

  <span class="comment1">(* *)</span>

  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">context</span> <span class="main">=</span>
    Scan.repeat
      <span class="main">(</span><span class="main">(</span>   <span class="entity">optional</span> <span class="main">(</span><span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">keyword</span> "<span class="keyword2">Operations</span>"<span class="antiquote">}</span></span></span> || Parse.$$$ <span class="inner_quoted">"::"</span><span class="main">)</span>
        |-- Parse.binding
        -- <span class="entity">use_type</span>
        --| <span class="entity">optional</span> <span class="main">(</span>Parse.$$$ <span class="inner_quoted">"="</span> |-- Parse.term || Parse.term<span class="main">)</span>
        -- Scan.repeat
              <span class="main">(</span>      <span class="main">(</span><span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">keyword</span> "<span class="keyword2">Pre</span>"<span class="antiquote">}</span></span></span> || <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">keyword</span> "<span class="keyword2">Post</span>"<span class="antiquote">}</span></span></span><span class="main">)</span>
                  -- <span class="entity">use_prop</span> &gt;&gt; <span class="entity">TOY_context_pre_post</span>
               || <span class="entity">invariant</span> &gt;&gt; <span class="entity">TOY_context_invariant</span><span class="main">)</span>
        --| <span class="entity">optional</span> <span class="main">(</span>Parse.$$$ <span class="inner_quoted">";"</span><span class="main">)</span><span class="main">)</span> &gt;&gt;
              <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="main">(</span><span class="entity">name_fun</span><span class="main">,</span> <span class="entity">ty</span><span class="main">)</span><span class="main">,</span> <span class="entity">expr</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">from_expr</span> <span class="main">=&gt;</span>
                META.Ctxt_pp
                  <span class="main">(</span>META.Toy_ctxt_pre_post_ext
                    <span class="main">(</span> <span class="entity">From.binding</span> <span class="entity">name_fun</span>
                    <span class="main">,</span> <span class="entity">ty</span>
                    <span class="main">,</span> <span class="entity">From.list</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">TOY_context_pre_post</span> <span class="main">(</span><span class="entity">pp</span><span class="main">,</span> <span class="entity">expr</span><span class="main">)</span> <span class="main">=&gt;</span>
                                     META.T_pp <span class="main">(</span><span class="keyword2"><span class="keyword">if</span></span> <span class="entity">pp</span> <span class="main">=</span> <span class="inner_quoted">"Pre"</span> <span class="keyword2"><span class="keyword">then</span></span>
                                                  META.ToyCtxtPre
                                                <span class="keyword2"><span class="keyword">else</span></span>
                                                  META.ToyCtxtPost<span class="main">,</span> <span class="entity">expr</span> <span class="entity">from_expr</span><span class="main">)</span>
                                 <span class="main">|</span> <span class="entity">TOY_context_invariant</span> <span class="main">(</span><span class="entity">b</span><span class="main">,</span> <span class="entity">expr</span><span class="main">)</span> <span class="main">=&gt;</span>
                                     META.T_invariant <span class="main">(</span>META.T_inv <span class="main">(</span><span class="entity">b</span><span class="main">,</span> <span class="entity">expr</span> <span class="entity">from_expr</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="entity">expr</span>
                    <span class="main">,</span> <span class="main">(</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
       ||
       <span class="entity">invariant</span> &gt;&gt; <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">b</span><span class="main">,</span> <span class="entity">expr</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">from_expr</span> <span class="main">=&gt;</span> META.Ctxt_inv <span class="main">(</span>META.T_inv <span class="main">(</span><span class="entity">b</span><span class="main">,</span> <span class="entity">expr</span> <span class="entity">from_expr</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>

  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">class</span> <span class="main">=</span>
        <span class="entity">optional</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">keyword</span> "<span class="keyword2">Attributes</span>"<span class="antiquote">}</span></span></span>
    |-- Scan.repeat <span class="main">(</span>Parse.binding --| <span class="entity">colon</span> -- <span class="entity">use_type</span>
                     --| <span class="entity">optional</span> <span class="main">(</span>Parse.$$$ <span class="inner_quoted">";"</span><span class="main">)</span><span class="main">)</span>
    -- <span class="entity">context</span>

  <span class="keyword1"><span class="keyword">datatype</span></span> <span class="entity">use_classDefinition</span> <span class="main">=</span> <span class="entity">TOY_class</span> <span class="main">|</span> <span class="entity">TOY_class_abstract</span>
  <span class="keyword1"><span class="keyword">datatype</span></span> <span class="main">(</span>'a<span class="main">,</span> 'b<span class="main">)</span> <span class="entity">use_classDefinition_content</span> <span class="main">=</span> <span class="entity">TOY_class_content</span> <span class="keyword2"><span class="keyword">of</span></span> 'a <span class="main">|</span> <span class="entity">TOY_class_synonym</span> <span class="keyword2"><span class="keyword">of</span></span> 'b

  <span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">Outer_syntax_Class</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">struct</span></span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">make</span> <span class="entity">from_expr</span> <span class="entity">abstract</span> <span class="entity">ty_object</span> <span class="entity">attribute</span> <span class="entity">oper</span> <span class="main">=</span>
      META.Toy_class_raw_ext
        <span class="main">(</span> <span class="entity">ty_object</span>
        <span class="main">,</span> <span class="entity">From.list</span> <span class="main">(</span><span class="entity">From.pair</span> <span class="entity">From.binding</span> I<span class="main">)</span> <span class="entity">attribute</span>
        <span class="main">,</span> <span class="entity">From.list</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">f</span> <span class="main">=&gt;</span> <span class="entity">f</span> <span class="entity">from_expr</span><span class="main">)</span> <span class="entity">oper</span>
        <span class="main">,</span> <span class="entity">abstract</span>
        <span class="main">,</span> <span class="main">(</span><span class="main">)</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">end</span></span>

  <span class="comment1">(* *)</span>

  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">term_object</span> <span class="main">=</span> <span class="entity">parse_l</span> <span class="main">(</span>   <span class="entity">optional</span> <span class="main">(</span>    Parse.$$$ <span class="inner_quoted">"("</span>
                                          |-- Parse.binding
                                          --| Parse.$$$ <span class="inner_quoted">","</span>
                                          -- Parse.binding
                                          --| Parse.$$$ <span class="inner_quoted">")"</span>
                                          --| <span class="main">(</span>Parse.sym_ident &gt;&gt; <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="inner_quoted">"|="</span> <span class="main">=&gt;</span> Scan.succeed
                                                                    <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> Scan.fail <span class="inner_quoted">""</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
                             -- Parse.binding
                             -- <span class="main">(</span>    Parse.$$$ <span class="inner_quoted">"="</span>
                                 |-- <span class="entity">toy_term</span><span class="main">)</span><span class="main">)</span>

  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">list_attr'</span> <span class="main">=</span> <span class="entity">term_object</span> &gt;&gt; <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">res</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="entity">res</span><span class="main">,</span> <span class="main">[</span><span class="main">]</span> <span class="main">:</span> binding list<span class="main">)</span><span class="main">)</span>
  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">object_cast</span> <span class="entity">e</span> <span class="main">=</span>
    <span class="main">(</span>   <span class="entity">annot_ty</span> <span class="entity">term_object</span>
     -- Scan.repeat <span class="main">(</span>    <span class="main">(</span>Parse.sym_ident &gt;&gt; <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="inner_quoted">"-&gt;"</span> <span class="main">=&gt;</span> Scan.succeed
                                               <span class="main">|</span> <span class="inner_quoted">"↝"</span> <span class="main">=&gt;</span> Scan.succeed
                                               <span class="main">|</span> <span class="inner_quoted">"→"</span> <span class="main">=&gt;</span> Scan.succeed
                                               <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> Scan.fail <span class="inner_quoted">""</span><span class="main">)</span><span class="main">)</span>
                     |-- <span class="main">(</span>   Parse.reserved <span class="inner_quoted">"toyAsType"</span>
                             |-- Parse.$$$ <span class="inner_quoted">"("</span>
                             |-- Parse.binding
                             --| Parse.$$$ <span class="inner_quoted">")"</span>
                          || Parse.binding<span class="main">)</span><span class="main">)</span> &gt;&gt; <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="main">(</span><span class="entity">res</span><span class="main">,</span> <span class="entity">x</span><span class="main">)</span><span class="main">,</span> <span class="entity">l</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="entity">res</span><span class="main">,</span> rev <span class="main">(</span><span class="entity">x</span> :: <span class="entity">l</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="entity">e</span>
  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">object_cast'</span> <span class="main">=</span> <span class="entity">object_cast</span> &gt;&gt; <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">res</span><span class="main">,</span> <span class="entity">l</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="entity">res</span><span class="main">,</span> rev <span class="entity">l</span><span class="main">)</span><span class="main">)</span>

  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">get_toyinst</span> <span class="entity">l</span> <span class="main">_</span> <span class="main">=</span>
    META.ToyInstance <span class="main">(</span>map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="main">(</span><span class="entity">name</span><span class="main">,</span><span class="entity">typ</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="entity">l_attr</span><span class="main">,</span> <span class="entity">is_cast</span><span class="main">)</span><span class="main">)</span> <span class="main">=&gt;</span>
        <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">f</span> <span class="main">=</span> map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="main">(</span><span class="entity">pre_post</span><span class="main">,</span> <span class="entity">attr</span><span class="main">)</span><span class="main">,</span> <span class="entity">data</span><span class="main">)</span> <span class="main">=&gt;</span>
                              <span class="main">(</span> <span class="entity">From.option</span> <span class="main">(</span><span class="entity">From.pair</span> <span class="entity">From.binding</span> <span class="entity">From.binding</span><span class="main">)</span> <span class="entity">pre_post</span>
                              <span class="main">,</span> <span class="main">(</span> <span class="entity">From.binding</span> <span class="entity">attr</span>
                                <span class="main">,</span> <span class="entity">data</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
            <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">l_attr</span> <span class="main">=</span>
              fold
                <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">b</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">acc</span> <span class="main">=&gt;</span> META.ToyAttrCast <span class="main">(</span><span class="entity">From.binding</span> <span class="entity">b</span><span class="main">,</span> <span class="entity">acc</span><span class="main">,</span> <span class="main">[</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>
                <span class="entity">is_cast</span>
                <span class="main">(</span>META.ToyAttrNoCast <span class="main">(</span><span class="entity">f</span> <span class="entity">l_attr</span><span class="main">)</span><span class="main">)</span> <span class="keyword2"><span class="keyword">in</span></span>
        META.Toy_instance_single_ext
          <span class="main">(</span><span class="entity">From.option</span> <span class="entity">From.binding</span> <span class="entity">name</span><span class="main">,</span> <span class="entity">From.option</span> <span class="entity">From.binding</span> <span class="entity">typ</span><span class="main">,</span> <span class="entity">l_attr</span><span class="main">,</span> <span class="main">(</span><span class="main">)</span><span class="main">)</span> <span class="keyword2"><span class="keyword">end</span></span><span class="main">)</span> <span class="entity">l</span><span class="main">)</span>

  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">parse_instance</span> <span class="main">=</span> <span class="main">(</span>Parse.binding &gt;&gt; SOME<span class="main">)</span>
                     -- <span class="entity">optional</span> <span class="main">(</span><span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">keyword</span> "<span class="keyword2">::</span>"<span class="antiquote">}</span></span></span> |-- Parse.binding<span class="main">)</span> --| <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">keyword</span> "<span class="keyword2">=</span>"<span class="antiquote">}</span></span></span>
                     -- <span class="main">(</span><span class="entity">list_attr'</span> || <span class="entity">object_cast'</span><span class="main">)</span>

  <span class="comment1">(* *)</span>

  <span class="keyword1"><span class="keyword">datatype</span></span> <span class="entity">state_content</span> <span class="main">=</span>
    <span class="entity">ST_l_attr</span> <span class="keyword2"><span class="keyword">of</span></span> <span class="main">(</span><span class="main">(</span><span class="main">(</span>binding * binding<span class="main">)</span> option * binding<span class="main">)</span> * META.toy_data_shallow<span class="main">)</span> list * binding list
  <span class="main">|</span> <span class="entity">ST_binding</span> <span class="keyword2"><span class="keyword">of</span></span> binding

  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">state_parse</span> <span class="main">=</span> <span class="entity">parse_l'</span> <span class="main">(</span>   <span class="entity">object_cast</span> &gt;&gt; <span class="entity">ST_l_attr</span>
                              || Parse.binding &gt;&gt; <span class="entity">ST_binding</span><span class="main">)</span>

  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk_state</span> <span class="entity">thy</span> <span class="main">=</span>
    map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">ST_l_attr</span> <span class="entity">l</span> <span class="main">=&gt;</span>
              META.ToyDefCoreAdd
                <span class="main">(</span><span class="keyword2"><span class="keyword">case</span></span> <span class="entity">get_toyinst</span> <span class="main">(</span>map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">l_i</span><span class="main">,</span> <span class="entity">l_ty</span><span class="main">)</span> <span class="main">=&gt;</span>
                                         <span class="main">(</span><span class="main">(</span>NONE<span class="main">,</span> SOME <span class="main">(</span>hd <span class="entity">l_ty</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="entity">l_i</span><span class="main">,</span> rev <span class="main">(</span>tl <span class="entity">l_ty</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="entity">l</span><span class="main">]</span><span class="main">)</span>
                                  <span class="entity">thy</span> <span class="keyword2"><span class="keyword">of</span></span>
                   META.ToyInstance <span class="main">[</span><span class="entity">x</span><span class="main">]</span> <span class="main">=&gt;</span> <span class="entity">x</span><span class="main">)</span>
          <span class="main">|</span> <span class="entity">ST_binding</span> <span class="entity">b</span> <span class="main">=&gt;</span> META.ToyDefCoreBinding <span class="main">(</span><span class="entity">From.binding</span> <span class="entity">b</span><span class="main">)</span><span class="main">)</span>

  <span class="comment1">(* *)</span>

  <span class="keyword1"><span class="keyword">datatype</span></span> <span class="entity">state_pp_content</span> <span class="main">=</span> <span class="entity">ST_PP_l_attr</span> <span class="keyword2"><span class="keyword">of</span></span> state_content list
                            <span class="main">|</span> <span class="entity">ST_PP_binding</span> <span class="keyword2"><span class="keyword">of</span></span> binding

  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">state_pp_parse</span> <span class="main">=</span> <span class="entity">state_parse</span> &gt;&gt; <span class="entity">ST_PP_l_attr</span>
                       || Parse.binding &gt;&gt; <span class="entity">ST_PP_binding</span>

  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk_pp_state</span> <span class="entity">thy</span> <span class="main">=</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">ST_PP_l_attr</span> <span class="entity">l</span> <span class="main">=&gt;</span> META.ToyDefPPCoreAdd <span class="main">(</span><span class="entity">mk_state</span> <span class="entity">thy</span> <span class="entity">l</span><span class="main">)</span>
                         <span class="main">|</span> <span class="entity">ST_PP_binding</span> <span class="entity">s</span> <span class="main">=&gt;</span> META.ToyDefPPCoreBinding <span class="main">(</span><span class="entity">From.binding</span> <span class="entity">s</span><span class="main">)</span>
<span class="keyword2"><span class="keyword">end</span></span>
›</span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Setup of Meta Commands for Toy: Enum›</span></span>

<span class="keyword1"><span class="command">ML</span></span><span class="quoted">‹
<span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="main">)</span> <span class="main">=</span>
  <span class="entity">outer_syntax_command</span> <span class="antiquoted"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="antiquote">@{</span><span class="operator">mk_string</span><span class="antiquote">}</span></span></span></span></span></span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">command_keyword</span> <span class="keyword1">Enum</span><span class="antiquote">}</span></span></span> <span class="inner_quoted">""</span>
    <span class="main">(</span>Parse.binding -- <span class="entity">parse_l1'</span> Parse.binding<span class="main">)</span>
    <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">n1</span><span class="main">,</span> <span class="entity">n2</span><span class="main">)</span> <span class="main">=&gt;</span>
      K <span class="main">(</span>META.META_enum <span class="main">(</span>META.ToyEnum <span class="main">(</span><span class="entity">From.binding</span> <span class="entity">n1</span><span class="main">,</span> <span class="entity">From.list</span> <span class="entity">From.binding</span> <span class="entity">n2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
›</span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Setup of Meta Commands for Toy: (abstract) Class›</span></span>

<span class="keyword1"><span class="command">ML</span></span><span class="quoted">‹
<span class="keyword2"><span class="keyword">local</span></span>
  <span class="keyword3"><span class="keyword">open</span></span> TOY_parse

  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk_classDefinition</span> <span class="entity">abstract</span> <span class="entity">cmd_spec</span> <span class="main">=</span>
    <span class="entity">outer_syntax_command2</span> <span class="antiquoted"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="antiquote">@{</span><span class="operator">mk_string</span><span class="antiquote">}</span></span></span></span></span></span> <span class="entity">cmd_spec</span> <span class="inner_quoted">"Class generation"</span>
      <span class="main">(</span>   Parse.binding --| Parse.$$$ <span class="inner_quoted">"="</span> -- <span class="entity">TOY_parse.type_base</span> &gt;&gt; <span class="entity">TOY_class_synonym</span>
       ||    <span class="entity">type_object</span>
          -- <span class="entity">class</span> &gt;&gt; <span class="entity">TOY_class_content</span><span class="main">)</span>
      <span class="main">(</span>curry META.META_class_raw META.Floor1<span class="main">)</span>
      <span class="main">(</span>curry META.META_class_raw META.Floor2<span class="main">)</span>
      <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">from_expr</span><span class="main">,</span> <span class="entity">META_class_raw</span><span class="main">)</span> <span class="main">=&gt;</span>
       <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">TOY_class_content</span> <span class="main">(</span><span class="entity">ty_object</span><span class="main">,</span> <span class="main">(</span><span class="entity">attribute</span><span class="main">,</span> <span class="entity">oper</span><span class="main">)</span><span class="main">)</span> <span class="main">=&gt;</span>
            <span class="entity">META_class_raw</span> <span class="main">(</span><span class="entity">Outer_syntax_Class.make</span>
                             <span class="entity">from_expr</span>
                             <span class="main">(</span><span class="entity">abstract</span> <span class="main">=</span> <span class="entity">TOY_class_abstract</span><span class="main">)</span>
                             <span class="entity">ty_object</span>
                             <span class="entity">attribute</span>
                             <span class="entity">oper</span><span class="main">)</span>
        <span class="main">|</span> <span class="entity">TOY_class_synonym</span> <span class="main">(</span><span class="entity">n1</span><span class="main">,</span> <span class="entity">n2</span><span class="main">)</span> <span class="main">=&gt;</span>
            META.META_class_synonym <span class="main">(</span>META.ToyClassSynonym <span class="main">(</span><span class="entity">From.binding</span> <span class="entity">n1</span><span class="main">,</span> <span class="entity">n2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
<span class="keyword2"><span class="keyword">in</span></span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="main">)</span> <span class="main">=</span> <span class="entity">mk_classDefinition</span> <span class="entity">TOY_class</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">command_keyword</span> <span class="keyword1">Class</span><span class="antiquote">}</span></span></span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="main">)</span> <span class="main">=</span> <span class="entity">mk_classDefinition</span> <span class="entity">TOY_class_abstract</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">command_keyword</span> <span class="keyword1">Abstract_class</span><span class="antiquote">}</span></span></span>
<span class="keyword2"><span class="keyword">end</span></span>
›</span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Setup of Meta Commands for Toy: Association, Composition, Aggregation›</span></span>

<span class="keyword1"><span class="command">ML</span></span><span class="quoted">‹
<span class="keyword2"><span class="keyword">local</span></span>
  <span class="keyword3"><span class="keyword">open</span></span> TOY_parse

  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk_associationDefinition</span> <span class="entity">ass_ty</span> <span class="entity">cmd_spec</span> <span class="main">=</span>
    <span class="entity">outer_syntax_command</span> <span class="antiquoted"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="antiquote">@{</span><span class="operator">mk_string</span><span class="antiquote">}</span></span></span></span></span></span> <span class="entity">cmd_spec</span> <span class="inner_quoted">""</span>
      <span class="main">(</span>   <span class="entity">repeat2</span> <span class="entity">association_end</span>
       ||     <span class="entity">optional</span> Parse.binding
          |-- <span class="entity">association</span><span class="main">)</span>
      <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">l</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span>
        META.META_association <span class="main">(</span><span class="entity">Outer_syntax_Association.make</span> <span class="entity">ass_ty</span> <span class="entity">l</span><span class="main">)</span><span class="main">)</span>
<span class="keyword2"><span class="keyword">in</span></span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="main">)</span> <span class="main">=</span> <span class="entity">mk_associationDefinition</span> META.ToyAssTy_association <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">command_keyword</span> <span class="keyword1">Association</span><span class="antiquote">}</span></span></span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="main">)</span> <span class="main">=</span> <span class="entity">mk_associationDefinition</span> META.ToyAssTy_composition <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">command_keyword</span> <span class="keyword1">Composition</span><span class="antiquote">}</span></span></span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="main">)</span> <span class="main">=</span> <span class="entity">mk_associationDefinition</span> META.ToyAssTy_aggregation <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">command_keyword</span> <span class="keyword1">Aggregation</span><span class="antiquote">}</span></span></span>
<span class="keyword2"><span class="keyword">end</span></span>
›</span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Setup of Meta Commands for Toy: (abstract) Associationclass›</span></span>

<span class="keyword1"><span class="command">ML</span></span><span class="quoted">‹

<span class="keyword2"><span class="keyword">local</span></span>
  <span class="keyword3"><span class="keyword">open</span></span> TOY_parse

  <span class="keyword1"><span class="keyword">datatype</span></span> <span class="entity">use_associationClassDefinition</span> <span class="main">=</span> <span class="entity">TOY_associationclass</span> <span class="main">|</span> <span class="entity">TOY_associationclass_abstract</span>

  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk_associationClassDefinition</span> <span class="entity">abstract</span> <span class="entity">cmd_spec</span> <span class="main">=</span>
    <span class="entity">outer_syntax_command2</span> <span class="antiquoted"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="antiquote">@{</span><span class="operator">mk_string</span><span class="antiquote">}</span></span></span></span></span></span> <span class="entity">cmd_spec</span> <span class="inner_quoted">""</span>
      <span class="main">(</span>   <span class="entity">type_object</span>
       -- <span class="entity">association</span>
       -- <span class="entity">class</span>
       -- <span class="entity">optional</span> <span class="main">(</span>Parse.reserved <span class="inner_quoted">"aggregation"</span> || Parse.reserved <span class="inner_quoted">"composition"</span><span class="main">)</span><span class="main">)</span>
      <span class="main">(</span>curry META.META_ass_class META.Floor1<span class="main">)</span>
      <span class="main">(</span>curry META.META_ass_class META.Floor2<span class="main">)</span>
      <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">from_expr</span><span class="main">,</span> <span class="entity">META_ass_class</span><span class="main">)</span> <span class="main">=&gt;</span>
       <span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="entity">ty_object</span><span class="main">,</span> <span class="entity">l_ass</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="entity">attribute</span><span class="main">,</span> <span class="entity">oper</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="entity">assty</span><span class="main">)</span> <span class="main">=&gt;</span>
          <span class="entity">META_ass_class</span>
            <span class="main">(</span>META.ToyAssClass
              <span class="main">(</span> <span class="entity">Outer_syntax_Association.make</span>
                  <span class="main">(</span><span class="keyword2"><span class="keyword">case</span></span> <span class="entity">assty</span> <span class="keyword2"><span class="keyword">of</span></span> SOME <span class="inner_quoted">"aggregation"</span> <span class="main">=&gt;</span> META.ToyAssTy_aggregation
                               <span class="main">|</span> SOME <span class="inner_quoted">"composition"</span> <span class="main">=&gt;</span> META.ToyAssTy_composition
                               <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> META.ToyAssTy_association<span class="main">)</span>
                  <span class="entity">l_ass</span>
              <span class="main">,</span> <span class="entity">Outer_syntax_Class.make</span>
                  <span class="entity">from_expr</span>
                  <span class="main">(</span><span class="entity">abstract</span> <span class="main">=</span> <span class="entity">TOY_associationclass_abstract</span><span class="main">)</span>
                  <span class="entity">ty_object</span>
                  <span class="entity">attribute</span>
                  <span class="entity">oper</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
<span class="keyword2"><span class="keyword">in</span></span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="main">)</span> <span class="main">=</span> <span class="entity">mk_associationClassDefinition</span> <span class="entity">TOY_associationclass</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">command_keyword</span> <span class="keyword1">Associationclass</span><span class="antiquote">}</span></span></span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="main">)</span> <span class="main">=</span> <span class="entity">mk_associationClassDefinition</span> <span class="entity">TOY_associationclass_abstract</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">command_keyword</span> <span class="keyword1">Abstract_associationclass</span><span class="antiquote">}</span></span></span>
<span class="keyword2"><span class="keyword">end</span></span>
›</span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Setup of Meta Commands for Toy: Context›</span></span>

<span class="keyword1"><span class="command">ML</span></span><span class="quoted">‹
<span class="keyword2"><span class="keyword">local</span></span>
 <span class="keyword3"><span class="keyword">open</span></span> TOY_parse
<span class="keyword2"><span class="keyword">in</span></span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="main">)</span> <span class="main">=</span>
  <span class="entity">outer_syntax_command2</span> <span class="antiquoted"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="antiquote">@{</span><span class="operator">mk_string</span><span class="antiquote">}</span></span></span></span></span></span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">command_keyword</span> <span class="keyword1">Context</span><span class="antiquote">}</span></span></span> <span class="inner_quoted">""</span>
    <span class="main">(</span><span class="entity">optional</span> <span class="main">(</span>Parse.list1 Parse.binding --| <span class="entity">colon</span><span class="main">)</span>
     -- Parse.binding
     -- <span class="entity">context</span><span class="main">)</span>
    <span class="main">(</span>curry META.META_ctxt META.Floor1<span class="main">)</span>
    <span class="main">(</span>curry META.META_ctxt META.Floor2<span class="main">)</span>
    <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">from_expr</span><span class="main">,</span> <span class="entity">META_ctxt</span><span class="main">)</span> <span class="main">=&gt;</span>
    <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="main">(</span><span class="entity">l_param</span><span class="main">,</span> <span class="entity">name</span><span class="main">)</span><span class="main">,</span> <span class="entity">l</span><span class="main">)</span> <span class="main">=&gt;</span>
    <span class="entity">META_ctxt</span>
      <span class="main">(</span>META.Toy_ctxt_ext
        <span class="main">(</span> <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">l_param</span> <span class="keyword2"><span class="keyword">of</span></span> NONE <span class="main">=&gt;</span> <span class="main">[</span><span class="main">]</span> <span class="main">|</span> SOME <span class="entity">l</span> <span class="main">=&gt;</span> <span class="entity">From.list</span> <span class="entity">From.binding</span> <span class="entity">l</span>
        <span class="main">,</span> META.ToyTyObj <span class="main">(</span>META.ToyTyCore_pre <span class="main">(</span><span class="entity">From.binding</span> <span class="entity">name</span><span class="main">)</span><span class="main">,</span> <span class="main">[</span><span class="main">]</span><span class="main">)</span>
        <span class="main">,</span> <span class="entity">From.list</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">f</span> <span class="main">=&gt;</span> <span class="entity">f</span> <span class="entity">from_expr</span><span class="main">)</span> <span class="entity">l</span>
        <span class="main">,</span> <span class="main">(</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
<span class="keyword2"><span class="keyword">end</span></span>
›</span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Setup of Meta Commands for Toy: End›</span></span>

<span class="keyword1"><span class="command">ML</span></span><span class="quoted">‹
<span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="main">)</span> <span class="main">=</span>
  <span class="entity">outer_syntax_command0</span> <span class="antiquoted"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="antiquote">@{</span><span class="operator">mk_string</span><span class="antiquote">}</span></span></span></span></span></span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">command_keyword</span> <span class="keyword1">End</span><span class="antiquote">}</span></span></span> <span class="inner_quoted">"Class generation"</span>
    <span class="main">(</span>Scan.optional <span class="main">(</span> Parse.$$$ <span class="inner_quoted">"["</span> -- Parse.reserved <span class="inner_quoted">"forced"</span> -- Parse.$$$ <span class="inner_quoted">"]"</span> &gt;&gt; K true
                    || Parse.$$$ <span class="inner_quoted">"!"</span> &gt;&gt; K true<span class="main">)</span> false<span class="main">)</span>
    <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">b</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span>
       <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">b</span> <span class="keyword2"><span class="keyword">then</span></span>
         <span class="main">[</span>META.META_flush_all META.ToyFlushAll<span class="main">]</span>
       <span class="keyword2"><span class="keyword">else</span></span>
         <span class="main">[</span><span class="main">]</span><span class="main">)</span>
›</span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Setup of Meta Commands for Toy: BaseType, Instance, State›</span></span>

<span class="keyword1"><span class="command">ML</span></span><span class="quoted">‹
<span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="main">)</span> <span class="main">=</span>
  <span class="entity">outer_syntax_command</span> <span class="antiquoted"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="antiquote">@{</span><span class="operator">mk_string</span><span class="antiquote">}</span></span></span></span></span></span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">command_keyword</span> <span class="keyword1">BaseType</span><span class="antiquote">}</span></span></span> <span class="inner_quoted">""</span>
    <span class="main">(</span><span class="entity">parse_l'</span> <span class="entity">TOY_parse.term_base</span><span class="main">)</span>
    <span class="main">(</span>K o META.META_def_base_l o META.ToyDefBase<span class="main">)</span>

<span class="keyword2"><span class="keyword">local</span></span>
  <span class="keyword3"><span class="keyword">open</span></span> TOY_parse
<span class="keyword2"><span class="keyword">in</span></span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="main">)</span> <span class="main">=</span>
  <span class="entity">outer_syntax_command</span> <span class="antiquoted"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="antiquote">@{</span><span class="operator">mk_string</span><span class="antiquote">}</span></span></span></span></span></span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">command_keyword</span> <span class="keyword1">Instance</span><span class="antiquote">}</span></span></span> <span class="inner_quoted">""</span>
    <span class="main">(</span>Scan.optional <span class="main">(</span><span class="entity">parse_instance</span> -- Scan.repeat <span class="main">(</span><span class="entity">optional</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">keyword</span> "<span class="keyword2">and</span>"<span class="antiquote">}</span></span></span> |-- <span class="entity">parse_instance</span><span class="main">)</span> &gt;&gt;
                                                                        <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">x</span><span class="main">,</span> <span class="entity">xs</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">x</span> :: <span class="entity">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="main">]</span><span class="main">)</span>
    <span class="main">(</span>META.META_instance oo <span class="entity">get_toyinst</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="main">)</span> <span class="main">=</span>
  <span class="entity">outer_syntax_command</span> <span class="antiquoted"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="antiquote">@{</span><span class="operator">mk_string</span><span class="antiquote">}</span></span></span></span></span></span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">command_keyword</span> <span class="keyword1">State</span><span class="antiquote">}</span></span></span> <span class="inner_quoted">""</span>
    <span class="main">(</span><span class="entity">TOY_parse.optional</span> <span class="main">(</span><span class="entity">paren</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">keyword</span> "<span class="keyword2">shallow</span>"<span class="antiquote">}</span></span></span><span class="main">)</span> -- Parse.binding --| <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">keyword</span> "<span class="keyword2">=</span>"<span class="antiquote">}</span></span></span>
     -- <span class="entity">state_parse</span><span class="main">)</span>
     <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="main">(</span><span class="entity">is_shallow</span><span class="main">,</span> <span class="entity">name</span><span class="main">)</span><span class="main">,</span> <span class="entity">l</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">thy</span> <span class="main">=&gt;</span>
      META.META_def_state
        <span class="main">(</span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">is_shallow</span> <span class="main">=</span> NONE <span class="keyword2"><span class="keyword">then</span></span> META.Floor1 <span class="keyword2"><span class="keyword">else</span></span> META.Floor2
        <span class="main">,</span> META.ToyDefSt <span class="main">(</span><span class="entity">From.binding</span> <span class="entity">name</span><span class="main">,</span> <span class="entity">mk_state</span> <span class="entity">thy</span> <span class="entity">l</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
<span class="keyword2"><span class="keyword">end</span></span>
›</span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Setup of Meta Commands for Toy: PrePost›</span></span>

<span class="keyword1"><span class="command">ML</span></span><span class="quoted">‹
<span class="keyword2"><span class="keyword">local</span></span>
  <span class="keyword3"><span class="keyword">open</span></span> TOY_parse
<span class="keyword2"><span class="keyword">in</span></span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="main">)</span> <span class="main">=</span>
  <span class="entity">outer_syntax_command</span> <span class="antiquoted"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="antiquote">@{</span><span class="operator">mk_string</span><span class="antiquote">}</span></span></span></span></span></span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">command_keyword</span> <span class="keyword1">PrePost</span><span class="antiquote">}</span></span></span> <span class="inner_quoted">""</span>
    <span class="main">(</span><span class="entity">TOY_parse.optional</span> <span class="main">(</span><span class="entity">paren</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">keyword</span> "<span class="keyword2">shallow</span>"<span class="antiquote">}</span></span></span><span class="main">)</span>
     -- <span class="entity">TOY_parse.optional</span> <span class="main">(</span>Parse.binding --| <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">keyword</span> "<span class="keyword2">=</span>"<span class="antiquote">}</span></span></span><span class="main">)</span>
     -- <span class="entity">state_pp_parse</span>
     -- <span class="entity">TOY_parse.optional</span> <span class="entity">state_pp_parse</span><span class="main">)</span>
    <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="entity">is_shallow</span><span class="main">,</span> <span class="entity">n</span><span class="main">)</span><span class="main">,</span> <span class="entity">s_pre</span><span class="main">)</span><span class="main">,</span> <span class="entity">s_post</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">thy</span> <span class="main">=&gt;</span>
      META.META_def_pre_post
        <span class="main">(</span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">is_shallow</span> <span class="main">=</span> NONE <span class="keyword2"><span class="keyword">then</span></span> META.Floor1 <span class="keyword2"><span class="keyword">else</span></span> META.Floor2
        <span class="main">,</span> META.ToyDefPP <span class="main">(</span> <span class="entity">From.option</span> <span class="entity">From.binding</span> <span class="entity">n</span>
                       <span class="main">,</span> <span class="entity">mk_pp_state</span> <span class="entity">thy</span> <span class="entity">s_pre</span>
                       <span class="main">,</span> <span class="entity">From.option</span> <span class="main">(</span><span class="entity">mk_pp_state</span> <span class="entity">thy</span><span class="main">)</span> <span class="entity">s_post</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
<span class="keyword2"><span class="keyword">end</span></span>
<span class="comment1">(*val _ = print_depth 100*)</span>
›</span>
<span class="comment1">(*&gt;*)</span>
<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Design_deep">
<div class="head">
<h1>Theory Design_deep</h1>
</div>
<pre class="source"><span class="comment1">(******************************************************************************
 * HOL-TOY
 *
 * Copyright (c) 2011-2018 Université Paris-Saclay, Univ. Paris-Sud, France
 *               2013-2017 IRT SystemX, France
 *               2011-2015 Achim D. Brucker, Germany
 *               2016-2018 The University of Sheffield, UK
 *               2016-2017 Nanyang Technological University, Singapore
 *               2017-2018 Virginia Tech, USA
 *
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are
 * met:
 *
 *     * Redistributions of source code must retain the above copyright
 *       notice, this list of conditions and the following disclaimer.
 *
 *     * Redistributions in binary form must reproduce the above
 *       copyright notice, this list of conditions and the following
 *       disclaimer in the documentation and/or other materials provided
 *       with the distribution.
 *
 *     * Neither the name of the copyright holders nor the names of its
 *       contributors may be used to endorse or promote products derived
 *       from this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 ******************************************************************************)</span>

<span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹Example: A Class Model Converted into a Theory File›</span></span>
<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Introduction›</span></span>

<span class="keyword1"><span class="command">theory</span></span>
  Design_deep
<span class="keyword2"><span class="keyword">imports</span></span>
  <span class="quoted">"<a href="Generator_dynamic_sequential.html">../embedding/Generator_dynamic_sequential</a>"</span>
  <span class="quoted">"<a href="Antiquote_Setup.html">../../Antiquote_Setup</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹
In this example, we configure our package to generate a \verb|.thy| file,
without executing the associated generated code contained in this \verb|.thy| file
(c.f. <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">file</span></span> ‹Design_shallow.thy›<span class="antiquote"><span class="antiquote">}</span></span></span></span> for a direct evaluation).
This mode is particularly relevant for debugging purposes:
while by default no evaluation occurs,
the generated files (and their proofs!) can be executed on
a step by step basis, depending on how we interact with the output window
(by selectively clicking on what is generated).

After clicking on the generated content, the newly inserted content could depend on some theories
which are not loaded by this current one.
In this case, it is necessary to manually add all the needed dependencies above after the
keyword <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">keyword</span></span> "imports"<span class="antiquote"><span class="antiquote">}</span></span></span></span>.
One should compare this current theory with <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">file</span></span> ‹Design_shallow.thy›<span class="antiquote"><span class="antiquote">}</span></span></span></span>
to see the differences of imported theories, and which ones to manually import
(whenever an error happens).
›</span></span>

<span class="keyword1"><span class="command">generation_syntax</span></span> <span class="main">[</span> <span class="comment1">(*deep
                      (generation_semantics [ design (*, oid_start 10*) ])
                      (THEORY Design_generated)
                      (IMPORTS ["../Toy_Library", "../Toy_Library_Static"]
                               "../embedding/Generator_dynamic_sequential")
                      SECTION
                      (*SORRY*) (*no_dirty*)
                      [ (* in Haskell *)
                        (* in OCaml module_name M *)
                        (* in Scala module_name M *)
                        in SML module_name M ]
                      (output_directory "../document_generated")
                  (*, syntax_print*)*)</span> <span class="main">]</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹
\begin{verbatim}
generation_syntax
  [ deep
      (generation_semantics [ design ])
      (THEORY Design_generated)
      (IMPORTS ["../Toy_Library", "../Toy_Library_Static"]
               "../embedding/Generator_dynamic_sequential")
      SECTION
      (*SORRY*) (*no_dirty*)
      [ (* in Haskell *)
        (* in OCaml module_name M *)
        (* in Scala module_name M *)
        in SML module_name M ]
      (output_directory "../document_generated")
  (*, syntax_print*) ]
\end{verbatim}
While in theory it is possible to set the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">keyword</span></span> "deep"<span class="antiquote"><span class="antiquote">}</span></span></span></span> mode
for generating in all target languages, i.e. by writing
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>[ in Haskell, in OCaml module_name M, in Scala module_name M, in SML module_name M ]›</span></span></span></span>,
usually using only one target is enough,
since the task of all target is to generate the same Isabelle content.
However in case one language takes too much time to setup,
we recommend to try the generation with another target language,
because all optimizations are currently not (yet) seemingly implemented for all target languages,
or differently activated.›</span></span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Designing Class Models (I): Basics›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹
The following example shows the definitions of a set of classes,
called the ``universe'' of classes.
Instead of providing a single command for building all the complete universe of classes
directly in one block,
we are constructing classes one by one.
So globally the universe describing all classes is partial, it
will only be fully constructed when all classes will be finished to be defined.

This allows to define classes without having to follow a particular order of definitions.
Here <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Atom›</span></span></span></span> is defined before the one of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Molecule›</span></span></span></span>
(<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Molecule›</span></span></span></span> will come after):
›</span></span>

<span class="keyword1"><span class="command">Class</span></span> Atom <span class="main">&lt;</span> Molecule
  <span class="keyword2"><span class="keyword">Attributes</span></span> size <span class="main">:</span> Integer
<span class="keyword1"><span class="command">End</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The ``blue'' color of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">command</span></span> End<span class="antiquote"><span class="antiquote">}</span></span></span></span> indicates that
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">command</span></span> End<span class="antiquote"><span class="antiquote">}</span></span></span></span> is not a ``green'' keyword.
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">command</span></span> End<span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">command</span></span> Class<span class="antiquote"><span class="antiquote">}</span></span></span></span> are in fact similar, they belong to the group of meta-commands
(all meta-commands are defined in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">theory</span></span> <a href="Generator_dynamic_sequential.html"></a><a href="Generator_dynamic_sequential.html">Isabelle_Meta_Model.Generator_dynamic_sequential</a><span class="antiquote"><span class="antiquote">}</span></span></span></span>).
At run-time and in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">keyword</span></span> "deep"<span class="antiquote"><span class="antiquote">}</span></span></span></span> mode, the semantics of all meta-commands are
approximately similar: all meta-commands displays some quantity of Isabelle code
in the output window (as long as meta-commands are syntactically correctly formed).
However each meta-command is unique because what is displayed
in the output window depends on the sequence of all meta-commands already encountered before
(and also depends on arguments given to the meta-commands).›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹
One particularity of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">command</span></span> End<span class="antiquote"><span class="antiquote">}</span></span></span></span> is to behave as the identity function when
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">command</span></span> End<span class="antiquote"><span class="antiquote">}</span></span></span></span> is called without arguments.
As example, here we are calling lots of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">command</span></span> End<span class="antiquote"><span class="antiquote">}</span></span></span></span> without arguments,
and no Isabelle code is generated.›</span></span>
       <span class="keyword1"><span class="command">End</span></span> <span class="keyword1"><span class="command">End</span></span> <span class="keyword1"><span class="command">End</span></span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹
We remark that, like any meta-commands, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">command</span></span> End<span class="antiquote"><span class="antiquote">}</span></span></span></span> could have been written anywhere
in this theory, for example before <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">command</span></span> Class<span class="antiquote"><span class="antiquote">}</span></span></span></span> or even before <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">command</span></span> generation_syntax<span class="antiquote"><span class="antiquote">}</span></span></span></span>...
Something does not have to be specially opened before using an <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">command</span></span> End<span class="antiquote"><span class="antiquote">}</span></span></span></span>.
›</span></span>

<span class="keyword1"><span class="command">Class</span></span> Molecule <span class="main">&lt;</span> Person
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹As example, here no <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">command</span></span> End<span class="antiquote"><span class="antiquote">}</span></span></span></span> is written.›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹
The semantics of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">command</span></span> End<span class="antiquote"><span class="antiquote">}</span></span></span></span> is further precised here.
We earlier mentioned that the universe of classes is partially constructed, but one can still
examine what is partially constructed, and one possibility is to use <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">command</span></span> End<span class="antiquote"><span class="antiquote">}</span></span></span></span> for doing so.

<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">command</span></span> End<span class="antiquote"><span class="antiquote">}</span></span></span></span> can be seen as a lazy meta-command:
\begin{itemize}
\item without parameters, no code is generated,
\item with some parameters (e.g., the symbol \verb|!|), it forces the generation of the computation
of the universe, by considering all already encountered classes.
Then a partial representation of the universe can be interactively inspected.
\end{itemize}
›</span></span>

<span class="keyword1"><span class="command">Class</span></span> Galaxy
  <span class="keyword2"><span class="keyword">Attributes</span></span> wormhole <span class="main">:</span> UnlimitedNatural
             is_sound <span class="main">:</span> Void
<span class="keyword1"><span class="command">End</span></span><span class="main">!</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹At this position, in the output window,
we can observe for the first time some generated Isabelle code,
corresponding to the partial universe of classes being constructed.

Note: By default, <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Atom›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Molecule›</span></span></span></span> are not (yet) present in the shown universe
because <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Person›</span></span></span></span> has not been defined in a separate line (unlike <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Galaxy›</span></span></span></span> above).›</span></span>

<span class="keyword1"><span class="command">Class</span></span> Person <span class="main">&lt;</span> Galaxy
  <span class="keyword2"><span class="keyword">Attributes</span></span> salary <span class="main">:</span> Integer
             boss <span class="main">:</span> Person
             is_meta_thinking<span class="main">:</span> Boolean

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹
There is not only <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">command</span></span> End<span class="antiquote"><span class="antiquote">}</span></span></span></span> which forces the computation of the universe, for example
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">command</span></span> Instance<span class="antiquote"><span class="antiquote">}</span></span></span></span> declares a set of objects belonging to the classes earlier defined,
but the entire universe is needed as knowledge, so there is no choice than forcing
the generation of the universe.
›</span></span>

<span class="keyword1"><span class="command">Instance</span></span> X<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub>1 <span class="main">::</span> Person <span class="main">=</span> <span class="main">[</span> salary <span class="main">=</span> 1300 <span class="main">,</span> boss <span class="main">=</span> X<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub>2 <span class="main">]</span>
     <span class="keyword2"><span class="keyword">and</span></span> X<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub>2 <span class="main">::</span> Person <span class="main">=</span> <span class="main">[</span> salary <span class="main">=</span> 1800 <span class="main">]</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹
Here we will call <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">command</span></span> Instance<span class="antiquote"><span class="antiquote">}</span></span></span></span> again to show that the universe will not be computed again
since it was already computed in the previous <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">command</span></span> Instance<span class="antiquote"><span class="antiquote">}</span></span></span></span>.
›</span></span>

<span class="keyword1"><span class="command">Instance</span></span> X<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub>3 <span class="main">::</span> Person <span class="main">=</span> <span class="main">[</span> salary <span class="main">=</span> 1 <span class="main">]</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹However at any time, the universe can (or will) automatically be recomputed,
whenever we are adding meanwhile another class:

<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">verbatim</span></span> <span class="raw_text"><span class="raw_text">"(* Class Big_Bang &lt; Atom (* This will force the creation of a new universe. *) *)"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>

As remark, not only the universe is recomputed, but
the recomputation takes also into account all meta-commands already encountered.
So in the new setting, <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>X<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub>1›</span></span></span></span>, <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>X<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub>2›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>X<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub>3›</span></span></span></span>
will be resurrected... after the <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Big_Bang›</span></span></span></span>.
›</span></span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Designing Class Models (II): Jumping to Another Semantic Floor›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹
Until now, meta-commands was used to generate lines of code, and
these lines belong to the Isabelle language.
One particularity of meta-commands is to generate pieces of code containing not only Isabelle code
but also arbitrary meta-commands.
In <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">keyword</span></span> "deep"<span class="antiquote"><span class="antiquote">}</span></span></span></span> mode, this is particularly not a danger
for meta-commands to generate themselves
(whereas for <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">keyword</span></span> "shallow"<span class="antiquote"><span class="antiquote">}</span></span></span></span> the recursion might not terminate).

In this case, such meta-commands must automatically generate the appropriate call to
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">command</span></span> generation_syntax<span class="antiquote"><span class="antiquote">}</span></span></span></span> beforehand.
However this is not enough, the compiling environment (comprising the
history of meta-commands) are changing throughout the interactive evaluations,
so the environment must also be taken into account and propagated when meta-commands
are generating themselves.
For example, the environment is needed for consultation whenever resurrecting objects,
recomputing the universe or accessing the hierarchy of classes being
defined.

As a consequence, in the next example a line <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">command</span></span> setup<span class="antiquote"><span class="antiquote">}</span></span></span></span> is added
after <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">command</span></span> generation_syntax<span class="antiquote"><span class="antiquote">}</span></span></span></span> for bootstrapping the state of the compiling environment.
›</span></span>

<span class="keyword1"><span class="command">State</span></span> σ<span class="hidden">⇩</span><sub>1</sub> <span class="main">=</span>
  <span class="main">[</span> <span class="main">(</span><span class="main">[</span> salary <span class="main">=</span> 1000 <span class="main">,</span> boss <span class="main">=</span> <span class="keyword2"><span class="keyword">self</span></span> 1 <span class="main">]</span> <span class="main">::</span> Person<span class="main">)</span>
  <span class="main">,</span> <span class="main">(</span><span class="main">[</span> salary <span class="main">=</span> 1200 <span class="main">]</span> <span class="main">::</span> Person<span class="main">)</span>
  <span class="comment1">(* *)</span>
  <span class="main">,</span> <span class="main">(</span><span class="main">[</span> salary <span class="main">=</span> 2600 <span class="main">,</span> boss <span class="main">=</span> <span class="keyword2"><span class="keyword">self</span></span> 3 <span class="main">]</span> <span class="main">::</span> Person<span class="main">)</span>
  <span class="main">,</span> X<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub>1
  <span class="main">,</span> <span class="main">(</span><span class="main">[</span> salary <span class="main">=</span> 2300 <span class="main">,</span> boss <span class="main">=</span> <span class="keyword2"><span class="keyword">self</span></span> 2 <span class="main">]</span> <span class="main">::</span> Person<span class="main">)</span>
  <span class="comment1">(* *)</span>
  <span class="comment1">(* *)</span>
  <span class="main">,</span> X<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub>2 <span class="main">]</span>

<span class="keyword1"><span class="command">State</span></span> σ<span class="hidden">⇩</span><sub>1</sub>' <span class="main">=</span>
  <span class="main">[</span> X<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub>1
  <span class="main">,</span> X<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub>2
  <span class="main">,</span> X<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub>3 <span class="main">]</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
In certain circumstances, the command <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">command</span></span> setup<span class="antiquote"><span class="antiquote">}</span></span></span></span>
must be added again between some particular interleaving of two meta-commands
and this may not depend on the presence of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">command</span></span> generation_syntax<span class="antiquote"><span class="antiquote">}</span></span></span></span>
(which is defined only once when generating the first meta-command).
For more details, one can refer to the source code of
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"ignore_meta_header"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"bootstrap_floor"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">PrePost</span></span> σ<span class="hidden">⇩</span><sub>1</sub> σ<span class="hidden">⇩</span><sub>1</sub>'

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹
The generation of meta-commands allows to perform various extensions
on the Toy language being embedded, without altering the semantics of a particular command.
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">command</span></span> PrePost<span class="antiquote"><span class="antiquote">}</span></span></span></span> usually only takes ``bound variables'' as parameters
(not arbitrary <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>λ›</span></span></span></span>-terms), however the semantics of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">command</span></span> PrePost<span class="antiquote"><span class="antiquote">}</span></span></span></span> was extended
to mimic the support of some particular terms not restricted to variables.
This extension was implemented by executing some steps of ``<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>ζ›</span></span></span></span>-reductions rewriting rules''
operating on the meta-level of commands.
First, it is at least needed to extend the syntax of expressions accepted by <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">command</span></span> PrePost<span class="antiquote"><span class="antiquote">}</span></span></span></span>,
we then modify the parsing so that a larger subset of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>λ›</span></span></span></span>-terms
can be given as parameters.
Starting from this expression: \\
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">verbatim</span></span> <span class="raw_text"><span class="raw_text">"(* PrePost σ<span class="hidden">⇩</span><sub>1</sub> [ ([ salary = 1000 , boss = self 1 ] :: Person) ] *)"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>

the rewriting begins with a first call to the next semantic floor, we obtain
the following meta-commands (where <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">command</span></span> PrePost<span class="antiquote"><span class="antiquote">}</span></span></span></span> <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>[shallow]›</span></span></span></span> is an expression
in normal form): \\
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">verbatim</span></span> <span class="raw_text"><span class="raw_text">‹(* State WFF_10_post = [ ([ "salary" = 1000, "boss" = self 1 ] :: Person) ]›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> \\
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">verbatim</span></span> <span class="raw_text"><span class="raw_text">"   PrePost[shallow] σ<span class="hidden">⇩</span><sub>1</sub> WFF_10_post *)"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
(<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>WFF_10_post›</span></span></span></span> is an automatically generated name).

The rewriting of the above <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">command</span></span> State<span class="antiquote"><span class="antiquote">}</span></span></span></span> is performed in its turn.
Finally the overall ultimately terminates when reaching <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">command</span></span> Instance<span class="antiquote"><span class="antiquote">}</span></span></span></span> being already
in normal form: \\
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">verbatim</span></span> <span class="raw_text"><span class="raw_text">‹(* Instance WFF_10_post_object0 :: Person = [ "salary" = 1000, "boss" = [  ] ]›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> \\
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">verbatim</span></span> <span class="raw_text"><span class="raw_text">"   State[shallow] WFF_10_post = [ WFF_10_post_object0 ]"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> \\
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">verbatim</span></span> <span class="raw_text"><span class="raw_text">"   PrePost[shallow] σ<span class="hidden">⇩</span><sub>1</sub> WFF_10_post *)"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
›</span></span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Designing Class Models (III): Interaction with (Pure) Term›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹
Meta-commands are obviously not restricted to manipulate expressions in the Outer Syntax level.
It is possible to build meta-commands so that Inner Syntax expressions are directly parsed.
However the dependencies of this theory have been minimized so that experimentations
and debugging can easily occur in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">keyword</span></span> "deep"<span class="antiquote"><span class="antiquote">}</span></span></span></span> mode
(this file only depends on <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">theory</span></span> <a href="Generator_dynamic_sequential.html"></a><a href="Generator_dynamic_sequential.html">Isabelle_Meta_Model.Generator_dynamic_sequential</a><span class="antiquote"><span class="antiquote">}</span></span></span></span>).
Since the Inner Syntax expressions would perhaps manipulate expressions coming from other theories
than <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">theory</span></span> <a href="Generator_dynamic_sequential.html"></a><a href="Generator_dynamic_sequential.html">Isabelle_Meta_Model.Generator_dynamic_sequential</a><span class="antiquote"><span class="antiquote">}</span></span></span></span>,
it can be desirable to consider the Inner Syntax container as a string and leave the parsing
for subsequent semantic floors.

This is what is implemented here:
›</span></span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹
\verb|Context Person :: content ()| \\
\verb|  Post "&gt;&lt;"|
›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹
Here the expression <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">verbatim</span></span> <span class="raw_text"><span class="raw_text">"&gt;&lt;"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is not well-typed in Isabelle, but an error is not raised
because the above expression is not (yet) parsed as an Inner Syntax element\footnote{
In any case an error will not be raised, because the above code
is written in verbatim in the real <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">verbatim</span></span> <span class="raw_text"><span class="raw_text">".thy"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> file,
however one can copy-paste this code out of the verbatim scope to see that
no errors are really raised.
For presentation purposes, it was embedded in verbatim because we will later discuss about
meta-commands generating Isabelle code,
and then what is generated by this meta-command is of course not well-typed!}.

However, this is not the same for the resulting generated meta-command: \\
\verb|Context [shallow] Person :: content ()| \\
\verb|  Post : "(λ result self. (&gt;&lt;))"| \\
and an error is immediately raised because the parsing of Inner Syntax expressions
is activated in this case.
›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹For example, one can put the mouse, with the CTRL gesture,
over the variable <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">a</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">b</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> or <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">c</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
to be convinced that they are free variables compared with above:›</span></span>

<span class="keyword1"><span class="command">Context</span></span><span class="main">[</span><span class="keyword2"><span class="keyword">shallow</span></span><span class="main">]</span> Person <span class="main">::</span> content <span class="main">(</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">Post</span></span> <span class="main">:</span> <span class="quoted">"a + b = c"</span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Designing Class Models (IV): Saving the Generated to File›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹
The experimentations usually finish by saving all the universe
and generated Isabelle theory to the hard disk: \\
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">verbatim</span></span> <span class="raw_text"><span class="raw_text">"(* generation_syntax deep flush_all *)"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
›</span></span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Designing Class Models (V): Inspection of Generated Files›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹
According to options given to the (first) command <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">command</span></span> generation_syntax<span class="antiquote"><span class="antiquote">}</span></span></span></span> above,
we retrieve the first generated file in the mentioned directory:
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">file</span></span> ‹../document_generated/Design_generated.thy›<span class="antiquote"><span class="antiquote">}</span></span></span></span>.

Because this file still contains meta-commands, we are here executing again
a new generating step inside this file, the new result becomes saved in
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">file</span></span> ‹../document_generated/Design_generated_generated.thy›<span class="antiquote"><span class="antiquote">}</span></span></span></span>.
As remark, in this last file, the dependency to <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">theory</span></span> <a href="Generator_dynamic_sequential.html"></a><a href="Generator_dynamic_sequential.html">Isabelle_Meta_Model.Generator_dynamic_sequential</a><span class="antiquote"><span class="antiquote">}</span></span></span></span> was
automatically removed because the meta-compiler has detected the absence of meta-commands
in the generated content.

Note: While the first generated file is intended to be always well-typed,
it can happen that subsequent generations will lead to a not well-typed file.
This is because the meta-compiler only saves the history of meta-commands.
In case some ``native'' Isabelle declarations
are generated among meta-commands, then these Isabelle declarations
are not saved by the meta-compiler,
so these declarations will not be again generated.
Anyway, we see potential solutions for solving this and
they would perhaps be implemented in a future version of the meta-compiler...
›</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Toy_Library">
<div class="head">
<h1>Theory Toy_Library</h1>
</div>
<pre class="source"><span class="comment1">(******************************************************************************
 * HOL-TOY
 *
 * Copyright (c) 2011-2018 Université Paris-Saclay, Univ. Paris-Sud, France
 *               2013-2017 IRT SystemX, France
 *               2011-2015 Achim D. Brucker, Germany
 *               2016-2018 The University of Sheffield, UK
 *               2016-2017 Nanyang Technological University, Singapore
 *               2017-2018 Virginia Tech, USA
 *
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are
 * met:
 *
 *     * Redistributions of source code must retain the above copyright
 *       notice, this list of conditions and the following disclaimer.
 *
 *     * Redistributions in binary form must reproduce the above
 *       copyright notice, this list of conditions and the following
 *       disclaimer in the documentation and/or other materials provided
 *       with the distribution.
 *
 *     * Neither the name of the copyright holders nor the names of its
 *       contributors may be used to endorse or promote products derived
 *       from this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 ******************************************************************************)</span>

<span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹A Toy Library for Objects in a State›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Toy_Library
<span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">type_notation</span></span> option <span class="main">(</span><span class="quoted">"<span class="keyword1">⟨</span>_<span class="keyword1">⟩<span class="hidden">⇩</span><sub>⊥</sub></span>"</span><span class="main">)</span> <span class="comment1">(* NOTE: "_<span class="hidden">⇩</span><sub>⊥</sub>" also works *)</span>
<span class="keyword1"><span class="command">notation</span></span> Some <span class="main">(</span><span class="quoted">"<span class="keyword1">⌊</span><span class="keyword3">(</span>_<span class="keyword3">)</span><span class="keyword1">⌋</span>"</span><span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span>    <span class="entity">drop</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'α</span> option <span class="main">⇒</span> <span class="tfree">'α</span>"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">⌈</span><span class="keyword3">(</span>_<span class="keyword3">)</span><span class="keyword1">⌉</span>"</span><span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>  drop_lift<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="free">⌈</span></span><span class="main">⌊</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">⌋</span><span class="main"><span class="free">⌉</span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span>"</span></span>


<span class="keyword1"><span class="command">type_synonym</span></span> oid <span class="main">=</span> <span class="quoted">nat</span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'α</span> val' <span class="main">=</span> <span class="quoted"><span class="quoted">"unit <span class="main">⇒</span> <span class="tfree">'α</span>"</span></span>
<span class="keyword1"><span class="command">type_notation</span></span> val' <span class="main">(</span><span class="quoted">"<span class="keyword1">⋅</span><span class="keyword3">(</span>_<span class="keyword3">)</span>"</span><span class="main">)</span>

<span class="keyword1"><span class="command">record</span></span> <span class="main">(</span><span class="tfree">'𝔄</span><span class="main">)</span>state <span class="main">=</span>
             heap   <span class="main">::</span> <span class="quoted"><span class="quoted">"oid <span class="main">⇀</span> <span class="tfree">'𝔄</span> "</span></span>
             assocs <span class="main">::</span> <span class="quoted"><span class="quoted">"oid <span class="main">⇀</span> <span class="main">(</span><span class="main">(</span>oid list<span class="main">)</span> list<span class="main">)</span> list"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">,</span><span class="operator">code_unfold</span><span class="main">]</span> <span class="main">=</span> state.defs

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Design_shallow">
<div class="head">
<h1>Theory Design_shallow</h1>
</div>
<pre class="source"><span class="comment1">(******************************************************************************
 * HOL-TOY
 *
 * Copyright (c) 2011-2018 Université Paris-Saclay, Univ. Paris-Sud, France
 *               2013-2017 IRT SystemX, France
 *               2011-2015 Achim D. Brucker, Germany
 *               2016-2018 The University of Sheffield, UK
 *               2016-2017 Nanyang Technological University, Singapore
 *               2017-2018 Virginia Tech, USA
 *
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are
 * met:
 *
 *     * Redistributions of source code must retain the above copyright
 *       notice, this list of conditions and the following disclaimer.
 *
 *     * Redistributions in binary form must reproduce the above
 *       copyright notice, this list of conditions and the following
 *       disclaimer in the documentation and/or other materials provided
 *       with the distribution.
 *
 *     * Neither the name of the copyright holders nor the names of its
 *       contributors may be used to endorse or promote products derived
 *       from this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 ******************************************************************************)</span>

<span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹Example: A Class Model Interactively Executed›</span></span>
<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Introduction›</span></span>

<span class="keyword1"><span class="command">theory</span></span>
  Design_shallow
<span class="keyword2"><span class="keyword">imports</span></span>
  <span class="quoted">"<a href="Toy_Library.html">../Toy_Library</a>"</span>
  <span class="quoted">"<a href="Toy_Library_Static.html">../Toy_Library_Static</a>"</span>
  <span class="quoted">"<a href="Generator_dynamic_sequential.html">../embedding/Generator_dynamic_sequential</a>"</span>
  <span class="quoted">"<a href="Antiquote_Setup.html">../../Antiquote_Setup</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹
In this example, we configure our package to execute tactic SML code
(corresponding to some generated \verb|.thy| file, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">file</span></span> ‹Design_deep.thy›<span class="antiquote"><span class="antiquote">}</span></span></span></span>
details how to obtain such generated \verb|.thy| file).
Since SML code are already compiled (or reflected) and bound with the native Isabelle API in
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">theory</span></span> <a href="Generator_dynamic_sequential.html"></a><a href="Generator_dynamic_sequential.html">Isabelle_Meta_Model.Generator_dynamic_sequential</a><span class="antiquote"><span class="antiquote">}</span></span></span></span>, nothing is generated in this theory.
The system only parses arguments given to meta-commands and immediately calls the corresponding
compiled functions.

The execution time is comparatively similar as if tactics were written by hand,
except that the generated SML code potentially inherits all optimizations performed
by the raw code generation of Isabelle (if any).
›</span></span>

<span class="keyword1"><span class="command">generation_syntax</span></span> <span class="main">[</span> <span class="keyword2"><span class="keyword">shallow</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">generation_semantics</span></span> <span class="main">[</span> <span class="keyword2"><span class="keyword">design</span></span> <span class="main">]</span><span class="main">)</span>
                            <span class="comment1">(*SORRY*)</span> <span class="comment1">(*no_dirty*)</span>
                  <span class="comment1">(*, syntax_print*)</span> <span class="main">]</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹
The configuration in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">keyword</span></span> "shallow"<span class="antiquote"><span class="antiquote">}</span></span></span></span> mode is straightforward:
in this mode <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">command</span></span> generation_syntax<span class="antiquote"><span class="antiquote">}</span></span></span></span> basically terminates in $O(1)$.
›</span></span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Designing Class Models (I): Basics›</span></span>

<span class="keyword1"><span class="command">Class</span></span> Atom <span class="main">&lt;</span> Molecule
  <span class="keyword2"><span class="keyword">Attributes</span></span> size <span class="main">:</span> Integer
<span class="keyword1"><span class="command">End</span></span>

       <span class="keyword1"><span class="command">End</span></span> <span class="keyword1"><span class="command">End</span></span> <span class="keyword1"><span class="command">End</span></span>

<span class="keyword1"><span class="command">Class</span></span> Molecule <span class="main">&lt;</span> Person

<span class="keyword1"><span class="command">Class</span></span> Galaxy
  <span class="keyword2"><span class="keyword">Attributes</span></span> wormhole <span class="main">:</span> UnlimitedNatural
             is_sound <span class="main">:</span> Void
<span class="keyword1"><span class="command">End</span></span><span class="main">!</span>

<span class="keyword1"><span class="command">Class</span></span> Person <span class="main">&lt;</span> Galaxy
  <span class="keyword2"><span class="keyword">Attributes</span></span> salary <span class="main">:</span> Integer
             boss <span class="main">:</span> Person
             is_meta_thinking<span class="main">:</span> Boolean

<span class="keyword1"><span class="command">Instance</span></span> X<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub>1 <span class="main">::</span> Person <span class="main">=</span> <span class="main">[</span> salary <span class="main">=</span> 1300 <span class="main">,</span> boss <span class="main">=</span> X<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub>2 <span class="main">]</span>
     <span class="keyword2"><span class="keyword">and</span></span> X<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub>2 <span class="main">::</span> Person <span class="main">=</span> <span class="main">[</span> salary <span class="main">=</span> 1800 <span class="main">]</span>

<span class="keyword1"><span class="command">Instance</span></span> X<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub>3 <span class="main">::</span> Person <span class="main">=</span> <span class="main">[</span> salary <span class="main">=</span> 1 <span class="main">]</span>

<span class="comment1">(* Class Big_Bang &lt; Atom (* This will force the creation of a new universe. *) *)</span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Designing Class Models (II): Jumping to Another Semantic Floor›</span></span>

<span class="keyword1"><span class="command">State</span></span> σ<span class="hidden">⇩</span><sub>1</sub> <span class="main">=</span>
  <span class="main">[</span> <span class="main">(</span><span class="main">[</span> salary <span class="main">=</span> 1000 <span class="main">,</span> boss <span class="main">=</span> <span class="keyword2"><span class="keyword">self</span></span> 1 <span class="main">]</span> <span class="main">::</span> Person<span class="main">)</span>
  <span class="main">,</span> <span class="main">(</span><span class="main">[</span> salary <span class="main">=</span> 1200 <span class="main">]</span> <span class="main">::</span> Person<span class="main">)</span>
  <span class="comment1">(* *)</span>
  <span class="main">,</span> <span class="main">(</span><span class="main">[</span> salary <span class="main">=</span> 2600 <span class="main">,</span> boss <span class="main">=</span> <span class="keyword2"><span class="keyword">self</span></span> 3 <span class="main">]</span> <span class="main">::</span> Person<span class="main">)</span>
  <span class="main">,</span> X<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub>1
  <span class="main">,</span> <span class="main">(</span><span class="main">[</span> salary <span class="main">=</span> 2300 <span class="main">,</span> boss <span class="main">=</span> <span class="keyword2"><span class="keyword">self</span></span> 2 <span class="main">]</span> <span class="main">::</span> Person<span class="main">)</span>
  <span class="comment1">(* *)</span>
  <span class="comment1">(* *)</span>
  <span class="main">,</span> X<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub>2 <span class="main">]</span>

<span class="keyword1"><span class="command">State</span></span> σ<span class="hidden">⇩</span><sub>1</sub>' <span class="main">=</span>
  <span class="main">[</span> X<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub>1
  <span class="main">,</span> X<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub>2
  <span class="main">,</span> X<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub>3 <span class="main">]</span>

<span class="keyword1"><span class="command">PrePost</span></span> σ<span class="hidden">⇩</span><sub>1</sub> σ<span class="hidden">⇩</span><sub>1</sub>'

<span class="comment1">(* PrePost σ<span class="hidden">⇩</span><sub>1</sub> [ ([ salary = 1000 , boss = self 1 ] :: Person) ] *)</span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Designing Class Models (III): Interaction with (Pure) Term›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹
Here in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">keyword</span></span> "shallow"<span class="antiquote"><span class="antiquote">}</span></span></span></span> mode, the following expression is directly rejected: \\
\verb|Context Person :: content ()| \\
\verb|  Post "&gt;&lt;"|
›</span></span>

<span class="keyword1"><span class="command">Context</span></span><span class="main">[</span><span class="keyword2"><span class="keyword">shallow</span></span><span class="main">]</span> Person <span class="main">::</span> content <span class="main">(</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">Post</span></span> <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">+</span> <span class="free">b</span> <span class="main">=</span> <span class="free">c</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Rail">
<div class="head">
<h1>Theory Rail</h1>
</div>
<pre class="source"><span class="comment1">(******************************************************************************
 * Citadelle
 *
 * Copyright (c) 2011-2018 Université Paris-Saclay, Univ. Paris-Sud, France
 *               2013-2017 IRT SystemX, France
 *               2011-2015 Achim D. Brucker, Germany
 *               2016-2018 The University of Sheffield, UK
 *               2016-2017 Nanyang Technological University, Singapore
 *               2017-2018 Virginia Tech, USA
 *
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are
 * met:
 *
 *     * Redistributions of source code must retain the above copyright
 *       notice, this list of conditions and the following disclaimer.
 *
 *     * Redistributions in binary form must reproduce the above
 *       copyright notice, this list of conditions and the following
 *       disclaimer in the documentation and/or other materials provided
 *       with the distribution.
 *
 *     * Neither the name of the copyright holders nor the names of its
 *       contributors may be used to endorse or promote products derived
 *       from this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 ******************************************************************************)</span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">theory</span></span> Rail
<span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="Generator_dynamic_sequential.html">../toy_example/embedding/Generator_dynamic_sequential</a>"</span> <span class="quoted">"<a href="Antiquote_Setup.html">../Antiquote_Setup</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹Main Setup of Meta Commands›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
\begin{matharray}{rcl}
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">command_def</span></span> generation_syntax<span class="antiquote"><span class="antiquote">}</span></span></span></span> &amp; : &amp; <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>theory → theory›</span></span></span></span>
\end{matharray}

<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">rail</span></span> ‹
  <span class="keyword1"><span class="keyword1">@</span></span><span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">command</span></span> generation_syntax<span class="antiquote"><span class="antiquote">}</span></span></span></span>
    ( <span class="inner_quoted"><span class="inner_quoted">'['</span></span> (<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">syntax</span></span> syntax<span class="antiquote"><span class="antiquote">}</span></span></span></span> <span class="keyword3"><span class="keyword3">*</span></span> <span class="inner_quoted"><span class="inner_quoted">','</span></span>) <span class="inner_quoted"><span class="inner_quoted">']'</span></span>
    <span class="keyword3"><span class="keyword3">|</span></span> <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">syntax</span></span> syntax<span class="antiquote"><span class="antiquote">}</span></span></span></span>
    <span class="keyword3"><span class="keyword3">|</span></span> <span class="keyword1"><span class="keyword1">@</span></span><span class="inner_quoted"><span class="inner_quoted">'deep'</span></span> <span class="keyword1"><span class="keyword1">@</span></span><span class="inner_quoted"><span class="inner_quoted">'flush_all'</span></span>)
  <span class="keyword2"><span class="keyword2">;</span></span>
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">syntax_def</span></span> syntax<span class="antiquote"><span class="antiquote">}</span></span></span></span><span class="keyword2"><span class="keyword2">:</span></span>
                 <span class="keyword1"><span class="keyword1">@</span></span><span class="inner_quoted"><span class="inner_quoted">'deep'</span></span> <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">syntax</span></span> semantics<span class="antiquote"><span class="antiquote">}</span></span></span></span> <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">syntax</span></span> deep_embedding<span class="antiquote"><span class="antiquote">}</span></span></span></span>
               <span class="keyword3"><span class="keyword3">|</span></span> <span class="keyword1"><span class="keyword1">@</span></span><span class="inner_quoted"><span class="inner_quoted">'shallow'</span></span> <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">syntax</span></span> semantics<span class="antiquote"><span class="antiquote">}</span></span></span></span> <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">syntax</span></span> long_or_dirty<span class="antiquote"><span class="antiquote">}</span></span></span></span>
               <span class="keyword3"><span class="keyword3">|</span></span> <span class="keyword1"><span class="keyword1">@</span></span><span class="inner_quoted"><span class="inner_quoted">'syntax_print'</span></span> number<span class="keyword3"><span class="keyword3">?</span></span>
  <span class="keyword2"><span class="keyword2">;</span></span>
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">syntax_def</span></span> semantics<span class="antiquote"><span class="antiquote">}</span></span></span></span><span class="keyword2"><span class="keyword2">:</span></span>
               (<span class="inner_quoted"><span class="inner_quoted">'('</span></span> <span class="keyword1"><span class="keyword1">@</span></span><span class="inner_quoted"><span class="inner_quoted">'generation_semantics'</span></span> <span class="keyword2"><span class="keyword2">⏎</span></span>
                 (<span class="inner_quoted"><span class="inner_quoted">'['</span></span> (<span class="keyword1"><span class="keyword1">@</span></span><span class="inner_quoted"><span class="inner_quoted">'design'</span></span> <span class="keyword3"><span class="keyword3">|</span></span> <span class="keyword1"><span class="keyword1">@</span></span><span class="inner_quoted"><span class="inner_quoted">'analysis'</span></span>) (<span class="inner_quoted"><span class="inner_quoted">','</span></span> <span class="keyword1"><span class="keyword1">@</span></span><span class="inner_quoted"><span class="inner_quoted">'oid_start'</span></span> nat)<span class="keyword3"><span class="keyword3">?</span></span> <span class="inner_quoted"><span class="inner_quoted">']'</span></span>) <span class="inner_quoted"><span class="inner_quoted">')'</span></span>)<span class="keyword3"><span class="keyword3">?</span></span>
  <span class="keyword2"><span class="keyword2">;</span></span>
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">syntax_def</span></span> deep_embedding<span class="antiquote"><span class="antiquote">}</span></span></span></span><span class="keyword2"><span class="keyword2">:</span></span>
               (<span class="keyword1"><span class="keyword1">@</span></span><span class="inner_quoted"><span class="inner_quoted">'skip_export'</span></span>)<span class="keyword3"><span class="keyword3">?</span></span> <span class="keyword2"><span class="keyword2">⏎</span></span>
               (<span class="inner_quoted"><span class="inner_quoted">'('</span></span> <span class="keyword1"><span class="keyword1">@</span></span><span class="inner_quoted"><span class="inner_quoted">'THEORY'</span></span> name <span class="inner_quoted"><span class="inner_quoted">')'</span></span> <span class="keyword2"><span class="keyword2">⏎</span></span>
                <span class="inner_quoted"><span class="inner_quoted">'('</span></span> <span class="keyword1"><span class="keyword1">@</span></span><span class="inner_quoted"><span class="inner_quoted">'IMPORTS'</span></span> <span class="inner_quoted"><span class="inner_quoted">'['</span></span> (name <span class="keyword3"><span class="keyword3">*</span></span> <span class="inner_quoted"><span class="inner_quoted">','</span></span>) <span class="inner_quoted"><span class="inner_quoted">']'</span></span> name <span class="inner_quoted"><span class="inner_quoted">')'</span></span>)<span class="keyword3"><span class="keyword3">?</span></span> <span class="keyword2"><span class="keyword2">⏎</span></span>
               (<span class="keyword1"><span class="keyword1">@</span></span><span class="inner_quoted"><span class="inner_quoted">'SECTION'</span></span>)<span class="keyword3"><span class="keyword3">?</span></span> <span class="keyword2"><span class="keyword2">⏎</span></span>
               <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">syntax</span></span> long_or_dirty<span class="antiquote"><span class="antiquote">}</span></span></span></span> <span class="keyword2"><span class="keyword2">⏎</span></span>
               (<span class="inner_quoted"><span class="inner_quoted">'['</span></span> (<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">syntax</span></span> export_code<span class="antiquote"><span class="antiquote">}</span></span></span></span> <span class="keyword3"><span class="keyword3">+</span></span> <span class="inner_quoted"><span class="inner_quoted">','</span></span>) <span class="inner_quoted"><span class="inner_quoted">']'</span></span>) <span class="keyword2"><span class="keyword2">⏎</span></span>
               (<span class="inner_quoted"><span class="inner_quoted">'('</span></span> <span class="keyword1"><span class="keyword1">@</span></span><span class="inner_quoted"><span class="inner_quoted">'output_directory'</span></span> name <span class="inner_quoted"><span class="inner_quoted">')'</span></span>)<span class="keyword3"><span class="keyword3">?</span></span>
  <span class="keyword2"><span class="keyword2">;</span></span>
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">syntax_def</span></span> export_code<span class="antiquote"><span class="antiquote">}</span></span></span></span><span class="keyword2"><span class="keyword2">:</span></span>
               <span class="keyword1"><span class="keyword1">@</span></span><span class="inner_quoted"><span class="inner_quoted">'in'</span></span> (  <span class="inner_quoted"><span class="inner_quoted">'Haskell'</span></span>
                      <span class="keyword3"><span class="keyword3">|</span></span> ((  <span class="inner_quoted"><span class="inner_quoted">'OCaml'</span></span>
                          <span class="keyword3"><span class="keyword3">|</span></span> <span class="inner_quoted"><span class="inner_quoted">'Scala'</span></span>
                          <span class="keyword3"><span class="keyword3">|</span></span> <span class="inner_quoted"><span class="inner_quoted">'SML'</span></span>) <span class="keyword1"><span class="keyword1">@</span></span><span class="inner_quoted"><span class="inner_quoted">'module_name'</span></span> name)) ( <span class="inner_quoted"><span class="inner_quoted">'('</span></span> args <span class="inner_quoted"><span class="inner_quoted">')'</span></span> ) <span class="keyword3"><span class="keyword3">?</span></span>
  <span class="keyword2"><span class="keyword2">;</span></span>
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">syntax_def</span></span> long_or_dirty<span class="antiquote"><span class="antiquote">}</span></span></span></span><span class="keyword2"><span class="keyword2">:</span></span>
               (<span class="keyword1"><span class="keyword1">@</span></span><span class="inner_quoted"><span class="inner_quoted">'SORRY'</span></span> <span class="keyword3"><span class="keyword3">|</span></span> <span class="keyword1"><span class="keyword1">@</span></span><span class="inner_quoted"><span class="inner_quoted">'no_dirty'</span></span>)<span class="keyword3"><span class="keyword3">?</span></span>
  <span class="keyword2"><span class="keyword2">;</span></span>
›<span class="antiquote"><span class="antiquote">}</span></span></span></span>
›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">command</span></span> generation_syntax<span class="antiquote"><span class="antiquote">}</span></span></span></span> sets the behavior of all incoming meta-commands.
By default, without firstly writing <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">command</span></span> generation_syntax<span class="antiquote"><span class="antiquote">}</span></span></span></span>,
meta-commands will only print in output what they have parsed,
this is similar as giving to <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">command</span></span> generation_syntax<span class="antiquote"><span class="antiquote">}</span></span></span></span>
a non-empty list having only <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">keyword</span></span> "syntax_print"<span class="antiquote"><span class="antiquote">}</span></span></span></span> as elements
(on the other hand, nothing is printed when an empty list is received).
Additionally <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">keyword</span></span> "syntax_print"<span class="antiquote"><span class="antiquote">}</span></span></span></span> can be followed by an integer
indicating the printing depth in output, similar as declaring
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">attribute</span></span> "ML_print_depth"<span class="antiquote"><span class="antiquote">}</span></span></span></span> with an integer,
but the global option <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">keyword</span></span> "syntax_print"<span class="antiquote"><span class="antiquote">}</span></span></span></span> is restricted to meta-commands.
Besides the printing of syntaxes, several options are provided to further analyze
the semantics of languages being embedded,
and tell if their evaluation should occur immediately using the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">keyword</span></span> "shallow"<span class="antiquote"><span class="antiquote">}</span></span></span></span> mode,
or to only display what would have been evaluated using the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">keyword</span></span> "deep"<span class="antiquote"><span class="antiquote">}</span></span></span></span> mode
(i.e., to only show the generated Isabelle content in the output window).

Since several occurrences of
 <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">keyword</span></span> "deep"<span class="antiquote"><span class="antiquote">}</span></span></span></span>, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">keyword</span></span> "shallow"<span class="antiquote"><span class="antiquote">}</span></span></span></span> or <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">keyword</span></span> "syntax_print"<span class="antiquote"><span class="antiquote">}</span></span></span></span>
can appear in the parameterizing list,
for each meta-command the overall evaluation respects the order of events
given in the list (from head to tail).
At the time of writing, it is only possible to evaluate this list sequentially:
the execution stops as soon as one first error is raised, thus ignoring remaining events.

<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">command</span></span> generation_syntax<span class="antiquote"><span class="antiquote">}</span></span></span></span> <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">keyword</span></span> "deep"<span class="antiquote"><span class="antiquote">}</span></span></span></span> <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">keyword</span></span> "flush_all"<span class="antiquote"><span class="antiquote">}</span></span></span></span>
performs as side effect the writing of all the generated Isabelle contents
to the hard disk (all at the calling time),
by iterating the saving for each <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">keyword</span></span> "deep"<span class="antiquote"><span class="antiquote">}</span></span></span></span> mode in the list.
In particular, this is only effective
if there is at least one <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">keyword</span></span> "deep"<span class="antiquote"><span class="antiquote">}</span></span></span></span> mode earlier declared.

As a side note, target languages for the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">keyword</span></span> "deep"<span class="antiquote"><span class="antiquote">}</span></span></span></span> mode currently supported are:
 Haskell, OCaml, Scala and SML.
So in principle, all these targets generate the same Isabelle content and exit correctly.
However, depending on the intended use, exporting with some targets may be more appropriate
than other targets:
\begin{itemize}
\item For efficiency reasons, the meta-compiler has implemented a particular optimization
for accelerating the process of evaluating incoming meta-commands.
By default in Haskell and OCaml, the meta-compiler (at HOL side) is exported only once,
during the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">command</span></span> generation_syntax<span class="antiquote"><span class="antiquote">}</span></span></span></span> step.
Then all incoming meta-commands are considered as arguments sent to the exported meta-compiler.
As a compositionality aspect, these arguments are compiled then linked together
with the (already compiled) meta-compiler, but
this implies the use of one call of
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>unsafeCoerce›</span></span></span></span> in Haskell and one <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Obj.magic›</span></span></span></span> statement in OCaml
(otherwise another solution would be to extract the meta-compiler as a functor).
Similar optimizations are not yet implemented for Scala and are only half-implemented for the SML target
(which basically performs a step of marshalling to string in Isabelle/ML).
\item For safety reasons, it simply suffices to extract all the meta-compiler together with the respective
arguments in front of each incoming meta-commands everytime, then the overall needs to be newly
compiled everytime.
This is the current implemented behavior for Scala.
For Haskell, OCaml and SML, it was also the default behavior in a prototyping version of the compiler,
as a consequence one can restore that functionality for future versions.
\end{itemize}

Concerning the semantics of generated contents, if lemmas and proofs are generated,
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">keyword</span></span> "SORRY"<span class="antiquote"><span class="antiquote">}</span></span></span></span> allows to explicitly skip the evaluation of all proofs,
irrespective of the presence of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">command</span></span> sorry<span class="antiquote"><span class="antiquote">}</span></span></span></span> or not in generated proofs.
In any cases, the semantics of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">command</span></span> sorry<span class="antiquote"><span class="antiquote">}</span></span></span></span> has not been overloaded, e.g.,
red background may appear as usual.

Finally <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">keyword</span></span> "generation_semantics"<span class="antiquote"><span class="antiquote">}</span></span></span></span> is a container for specifying various options
for varying the semantics of languages being embedded.
For example, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">keyword</span></span> "design"<span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">keyword</span></span> "analysis"<span class="antiquote"><span class="antiquote">}</span></span></span></span> are two options for specifying how
the modelling of objects will be represented in the Toy Language.
Similarly, this would be a typical place for options like
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>eager›</span></span></span></span> or <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>lazy›</span></span></span></span> for choosing how the evaluation should happen...
›</span></span>

<span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹All Meta Commands of the Toy Language›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
\begin{matharray}{rcl}
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">command_def</span></span> Class<span class="antiquote"><span class="antiquote">}</span></span></span></span> &amp; : &amp; <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>theory → theory›</span></span></span></span> \\
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">command_def</span></span> Abstract_class<span class="antiquote"><span class="antiquote">}</span></span></span></span> &amp; : &amp; <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>theory → theory›</span></span></span></span> \\
\end{matharray}

<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">rail</span></span> ‹
  (  <span class="keyword1"><span class="keyword1">@</span></span><span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">command</span></span> Class<span class="antiquote"><span class="antiquote">}</span></span></span></span>
   <span class="keyword3"><span class="keyword3">|</span></span> <span class="keyword1"><span class="keyword1">@</span></span><span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">command</span></span> Abstract_class<span class="antiquote"><span class="antiquote">}</span></span></span></span>)
                   (  binding <span class="inner_quoted"><span class="inner_quoted">'='</span></span> <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">syntax</span></span> type_base<span class="antiquote"><span class="antiquote">}</span></span></span></span>
                    <span class="keyword3"><span class="keyword3">|</span></span> <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">syntax</span></span> type_object<span class="antiquote"><span class="antiquote">}</span></span></span></span>
                      <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">syntax</span></span> class<span class="antiquote"><span class="antiquote">}</span></span></span></span>)
  <span class="keyword2"><span class="keyword2">;</span></span>
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">syntax_def</span></span> class<span class="antiquote"><span class="antiquote">}</span></span></span></span><span class="keyword2"><span class="keyword2">:</span></span>
               <span class="keyword1"><span class="keyword1">@</span></span><span class="inner_quoted"><span class="inner_quoted">'Attributes'</span></span><span class="keyword3"><span class="keyword3">?</span></span> ((binding <span class="inner_quoted"><span class="inner_quoted">':'</span></span> <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">syntax</span></span> toy_type<span class="antiquote"><span class="antiquote">}</span></span></span></span>) <span class="keyword3"><span class="keyword3">*</span></span> (<span class="inner_quoted"><span class="inner_quoted">';'</span></span><span class="keyword3"><span class="keyword3">?</span></span>)) <span class="keyword2"><span class="keyword2">⏎</span></span>
               <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">syntax</span></span> context<span class="antiquote"><span class="antiquote">}</span></span></span></span>
  <span class="keyword2"><span class="keyword2">;</span></span>
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">syntax_def</span></span> context<span class="antiquote"><span class="antiquote">}</span></span></span></span><span class="keyword2"><span class="keyword2">:</span></span>
            (( ((() <span class="keyword3"><span class="keyword3">|</span></span> <span class="keyword1"><span class="keyword1">@</span></span><span class="inner_quoted"><span class="inner_quoted">'Operations'</span></span> <span class="keyword3"><span class="keyword3">|</span></span> <span class="inner_quoted"><span class="inner_quoted">'::'</span></span>)
                binding <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">syntax</span></span> toy_type<span class="antiquote"><span class="antiquote">}</span></span></span></span> <span class="keyword2"><span class="keyword2">⏎</span></span>
                (<span class="inner_quoted"><span class="inner_quoted">'='</span></span> term <span class="keyword3"><span class="keyword3">|</span></span> term)<span class="keyword3"><span class="keyword3">?</span></span> (((<span class="keyword1"><span class="keyword1">@</span></span><span class="inner_quoted"><span class="inner_quoted">'Pre'</span></span> <span class="keyword3"><span class="keyword3">|</span></span> <span class="keyword1"><span class="keyword1">@</span></span><span class="inner_quoted"><span class="inner_quoted">'Post'</span></span>) <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">syntax</span></span> use_prop<span class="antiquote"><span class="antiquote">}</span></span></span></span>
                                    <span class="keyword3"><span class="keyword3">|</span></span> <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">syntax</span></span> invariant<span class="antiquote"><span class="antiquote">}</span></span></span></span>) <span class="keyword3"><span class="keyword3">*</span></span> ())
               )
             <span class="keyword3"><span class="keyword3">|</span></span> <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">syntax</span></span> invariant<span class="antiquote"><span class="antiquote">}</span></span></span></span>) <span class="keyword3"><span class="keyword3">*</span></span> ())
  <span class="keyword2"><span class="keyword2">;</span></span>
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">syntax_def</span></span> invariant<span class="antiquote"><span class="antiquote">}</span></span></span></span><span class="keyword2"><span class="keyword2">:</span></span>
               <span class="keyword1"><span class="keyword1">@</span></span><span class="inner_quoted"><span class="inner_quoted">'Constraints'</span></span><span class="keyword3"><span class="keyword3">?</span></span> <span class="keyword1"><span class="keyword1">@</span></span><span class="inner_quoted"><span class="inner_quoted">'Existential'</span></span><span class="keyword3"><span class="keyword3">?</span></span> <span class="keyword1"><span class="keyword1">@</span></span><span class="inner_quoted"><span class="inner_quoted">'Inv'</span></span> <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">syntax</span></span> use_prop<span class="antiquote"><span class="antiquote">}</span></span></span></span>
  <span class="keyword2"><span class="keyword2">;</span></span>
›<span class="antiquote"><span class="antiquote">}</span></span></span></span>
›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
\begin{matharray}{rcl}
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">command_def</span></span> Aggregation<span class="antiquote"><span class="antiquote">}</span></span></span></span> &amp; : &amp; <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>theory → theory›</span></span></span></span> \\
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">command_def</span></span> Association<span class="antiquote"><span class="antiquote">}</span></span></span></span> &amp; : &amp; <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>theory → theory›</span></span></span></span> \\
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">command_def</span></span> Composition<span class="antiquote"><span class="antiquote">}</span></span></span></span> &amp; : &amp; <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>theory → theory›</span></span></span></span>
\end{matharray}

<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">rail</span></span> ‹
  (  <span class="keyword1"><span class="keyword1">@</span></span><span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">command</span></span> Aggregation<span class="antiquote"><span class="antiquote">}</span></span></span></span>
   <span class="keyword3"><span class="keyword3">|</span></span> <span class="keyword1"><span class="keyword1">@</span></span><span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">command</span></span> Association<span class="antiquote"><span class="antiquote">}</span></span></span></span>
   <span class="keyword3"><span class="keyword3">|</span></span> <span class="keyword1"><span class="keyword1">@</span></span><span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">command</span></span> Composition<span class="antiquote"><span class="antiquote">}</span></span></span></span>) binding<span class="keyword3"><span class="keyword3">?</span></span> <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">syntax</span></span> association<span class="antiquote"><span class="antiquote">}</span></span></span></span>
  <span class="keyword2"><span class="keyword2">;</span></span>
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">syntax_def</span></span> association<span class="antiquote"><span class="antiquote">}</span></span></span></span><span class="keyword2"><span class="keyword2">:</span></span>
               <span class="keyword1"><span class="keyword1">@</span></span><span class="inner_quoted"><span class="inner_quoted">'Between'</span></span><span class="keyword3"><span class="keyword3">?</span></span> (<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">syntax</span></span> association_end<span class="antiquote"><span class="antiquote">}</span></span></span></span> (<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">syntax</span></span> association_end<span class="antiquote"><span class="antiquote">}</span></span></span></span><span class="keyword3"><span class="keyword3">+</span></span>))<span class="keyword3"><span class="keyword3">?</span></span>
  <span class="keyword2"><span class="keyword2">;</span></span>
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">syntax_def</span></span> association_end<span class="antiquote"><span class="antiquote">}</span></span></span></span><span class="keyword2"><span class="keyword2">:</span></span>
               <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">syntax</span></span> type_object<span class="antiquote"><span class="antiquote">}</span></span></span></span>
               <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">syntax</span></span> category<span class="antiquote"><span class="antiquote">}</span></span></span></span>
               <span class="inner_quoted"><span class="inner_quoted">';'</span></span><span class="keyword3"><span class="keyword3">?</span></span>
  <span class="keyword2"><span class="keyword2">;</span></span>
›<span class="antiquote"><span class="antiquote">}</span></span></span></span>
›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
\begin{matharray}{rcl}
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">command_def</span></span> Associationclass<span class="antiquote"><span class="antiquote">}</span></span></span></span> &amp; : &amp; <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>theory → theory›</span></span></span></span> \\
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">command_def</span></span> Abstract_associationclass<span class="antiquote"><span class="antiquote">}</span></span></span></span> &amp; : &amp; <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>theory → theory›</span></span></span></span>
\end{matharray}

<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">rail</span></span> ‹
  (  <span class="keyword1"><span class="keyword1">@</span></span><span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">command</span></span> Associationclass<span class="antiquote"><span class="antiquote">}</span></span></span></span>
   <span class="keyword3"><span class="keyword3">|</span></span> <span class="keyword1"><span class="keyword1">@</span></span><span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">command</span></span> Abstract_associationclass<span class="antiquote"><span class="antiquote">}</span></span></span></span>) <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">syntax</span></span> type_object<span class="antiquote"><span class="antiquote">}</span></span></span></span> <span class="keyword2"><span class="keyword2">⏎</span></span>
                                            <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">syntax</span></span> association<span class="antiquote"><span class="antiquote">}</span></span></span></span> <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">syntax</span></span> class<span class="antiquote"><span class="antiquote">}</span></span></span></span> (() <span class="keyword3"><span class="keyword3">|</span></span> <span class="inner_quoted"><span class="inner_quoted">'aggregation'</span></span> <span class="keyword3"><span class="keyword3">|</span></span> <span class="inner_quoted"><span class="inner_quoted">'composition'</span></span>)
  <span class="keyword2"><span class="keyword2">;</span></span>
›<span class="antiquote"><span class="antiquote">}</span></span></span></span>
›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
\begin{matharray}{rcl}
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">command_def</span></span> Context<span class="antiquote"><span class="antiquote">}</span></span></span></span> &amp; : &amp; <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>theory → theory›</span></span></span></span>
\end{matharray}

<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">rail</span></span> ‹
  <span class="keyword1"><span class="keyword1">@</span></span><span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">command</span></span> Context<span class="antiquote"><span class="antiquote">}</span></span></span></span> (<span class="inner_quoted"><span class="inner_quoted">'['</span></span> <span class="keyword1"><span class="keyword1">@</span></span><span class="inner_quoted"><span class="inner_quoted">'shallow'</span></span> <span class="inner_quoted"><span class="inner_quoted">']'</span></span>)<span class="keyword3"><span class="keyword3">?</span></span> <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">syntax</span></span> type_object<span class="antiquote"><span class="antiquote">}</span></span></span></span> <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">syntax</span></span> context<span class="antiquote"><span class="antiquote">}</span></span></span></span>
  <span class="keyword2"><span class="keyword2">;</span></span>
›<span class="antiquote"><span class="antiquote">}</span></span></span></span>
›</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
\begin{matharray}{rcl}
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">command_def</span></span> Instance<span class="antiquote"><span class="antiquote">}</span></span></span></span> &amp; : &amp; <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>theory → theory›</span></span></span></span>
\end{matharray}

<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">rail</span></span> ‹
  <span class="keyword1"><span class="keyword1">@</span></span><span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">command</span></span> Instance<span class="antiquote"><span class="antiquote">}</span></span></span></span> ((binding (<span class="inner_quoted"><span class="inner_quoted">'::'</span></span> <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">syntax</span></span> type_object<span class="antiquote"><span class="antiquote">}</span></span></span></span>)<span class="keyword3"><span class="keyword3">?</span></span> <span class="inner_quoted"><span class="inner_quoted">'='</span></span> <span class="keyword2"><span class="keyword2">⏎</span></span>
                         (<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">syntax</span></span> term_object<span class="antiquote"><span class="antiquote">}</span></span></span></span> <span class="keyword3"><span class="keyword3">|</span></span> <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">syntax</span></span> object_cast<span class="antiquote"><span class="antiquote">}</span></span></span></span>)) <span class="keyword3"><span class="keyword3">*</span></span> (<span class="inner_quoted"><span class="inner_quoted">'and'</span></span><span class="keyword3"><span class="keyword3">?</span></span>))
  <span class="keyword2"><span class="keyword2">;</span></span>
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">syntax_def</span></span> term_object<span class="antiquote"><span class="antiquote">}</span></span></span></span><span class="keyword2"><span class="keyword2">:</span></span>
                 (<span class="inner_quoted"><span class="inner_quoted">'['</span></span> (((<span class="inner_quoted"><span class="inner_quoted">'('</span></span> binding <span class="inner_quoted"><span class="inner_quoted">','</span></span> binding <span class="inner_quoted"><span class="inner_quoted">')'</span></span> <span class="inner_quoted"><span class="inner_quoted">'|='</span></span>)<span class="keyword3"><span class="keyword3">?</span></span> <span class="keyword2"><span class="keyword2">⏎</span></span>
                        binding <span class="inner_quoted"><span class="inner_quoted">'='</span></span> <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">syntax</span></span> toy_term<span class="antiquote"><span class="antiquote">}</span></span></span></span>) <span class="keyword3"><span class="keyword3">*</span></span> <span class="inner_quoted"><span class="inner_quoted">','</span></span>) <span class="inner_quoted"><span class="inner_quoted">']'</span></span>)
  <span class="keyword2"><span class="keyword2">;</span></span>
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">syntax_def</span></span> object_cast<span class="antiquote"><span class="antiquote">}</span></span></span></span><span class="keyword2"><span class="keyword2">:</span></span>
               <span class="inner_quoted"><span class="inner_quoted">'('</span></span> <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">syntax</span></span> term_object<span class="antiquote"><span class="antiquote">}</span></span></span></span> <span class="inner_quoted"><span class="inner_quoted">'::'</span></span> <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">syntax</span></span> type_object<span class="antiquote"><span class="antiquote">}</span></span></span></span> <span class="inner_quoted"><span class="inner_quoted">')'</span></span> <span class="keyword2"><span class="keyword2">⏎</span></span>
               ((<span class="inner_quoted"><span class="inner_quoted">'→'</span></span> <span class="inner_quoted"><span class="inner_quoted">'toyAsType'</span></span> <span class="inner_quoted"><span class="inner_quoted">'('</span></span> <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">syntax</span></span> type_object<span class="antiquote"><span class="antiquote">}</span></span></span></span> <span class="inner_quoted"><span class="inner_quoted">')'</span></span>) <span class="keyword3"><span class="keyword3">*</span></span> ())
  <span class="keyword2"><span class="keyword2">;</span></span>
›<span class="antiquote"><span class="antiquote">}</span></span></span></span>
›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
\begin{matharray}{rcl}
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">command_def</span></span> State<span class="antiquote"><span class="antiquote">}</span></span></span></span> &amp; : &amp; <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>theory → theory›</span></span></span></span>
\end{matharray}

<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">rail</span></span> ‹
  <span class="keyword1"><span class="keyword1">@</span></span><span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">command</span></span> State<span class="antiquote"><span class="antiquote">}</span></span></span></span> (<span class="inner_quoted"><span class="inner_quoted">'['</span></span> <span class="keyword1"><span class="keyword1">@</span></span><span class="inner_quoted"><span class="inner_quoted">'shallow'</span></span> <span class="inner_quoted"><span class="inner_quoted">']'</span></span>)<span class="keyword3"><span class="keyword3">?</span></span> binding (<span class="inner_quoted"><span class="inner_quoted">'='</span></span> <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">syntax</span></span> state<span class="antiquote"><span class="antiquote">}</span></span></span></span>)<span class="keyword3"><span class="keyword3">?</span></span>
  <span class="keyword2"><span class="keyword2">;</span></span>
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">syntax_def</span></span> state<span class="antiquote"><span class="antiquote">}</span></span></span></span><span class="keyword2"><span class="keyword2">:</span></span>
               <span class="inner_quoted"><span class="inner_quoted">'['</span></span> ((binding <span class="keyword3"><span class="keyword3">|</span></span> <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">syntax</span></span> object_cast<span class="antiquote"><span class="antiquote">}</span></span></span></span>) <span class="keyword3"><span class="keyword3">*</span></span> <span class="inner_quoted"><span class="inner_quoted">','</span></span>) <span class="inner_quoted"><span class="inner_quoted">']'</span></span>
  <span class="keyword2"><span class="keyword2">;</span></span>
›<span class="antiquote"><span class="antiquote">}</span></span></span></span>
›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
\begin{matharray}{rcl}
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">command_def</span></span> PrePost<span class="antiquote"><span class="antiquote">}</span></span></span></span> &amp; : &amp; <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>theory → theory›</span></span></span></span>
\end{matharray}

<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">rail</span></span> ‹
  <span class="keyword1"><span class="keyword1">@</span></span><span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">command</span></span> PrePost<span class="antiquote"><span class="antiquote">}</span></span></span></span> (<span class="inner_quoted"><span class="inner_quoted">'['</span></span> <span class="keyword1"><span class="keyword1">@</span></span><span class="inner_quoted"><span class="inner_quoted">'shallow'</span></span> <span class="inner_quoted"><span class="inner_quoted">']'</span></span>)<span class="keyword3"><span class="keyword3">?</span></span> (binding <span class="inner_quoted"><span class="inner_quoted">'='</span></span>)<span class="keyword3"><span class="keyword3">?</span></span> <span class="keyword2"><span class="keyword2">⏎</span></span>
    <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">syntax</span></span> pre_post<span class="antiquote"><span class="antiquote">}</span></span></span></span>
    <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">syntax</span></span> pre_post<span class="antiquote"><span class="antiquote">}</span></span></span></span><span class="keyword3"><span class="keyword3">?</span></span>
  <span class="keyword2"><span class="keyword2">;</span></span>
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">syntax_def</span></span> pre_post<span class="antiquote"><span class="antiquote">}</span></span></span></span><span class="keyword2"><span class="keyword2">:</span></span>
               binding <span class="keyword3"><span class="keyword3">|</span></span> <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">syntax</span></span> state<span class="antiquote"><span class="antiquote">}</span></span></span></span>
  <span class="keyword2"><span class="keyword2">;</span></span>
›<span class="antiquote"><span class="antiquote">}</span></span></span></span>
›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
\begin{matharray}{rcl}
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">command_def</span></span> End<span class="antiquote"><span class="antiquote">}</span></span></span></span> &amp; : &amp; <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>theory → theory›</span></span></span></span>
\end{matharray}

<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">rail</span></span> ‹
  <span class="keyword1"><span class="keyword1">@</span></span><span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">command</span></span> End<span class="antiquote"><span class="antiquote">}</span></span></span></span> (<span class="inner_quoted"><span class="inner_quoted">'['</span></span> <span class="inner_quoted"><span class="inner_quoted">'forced'</span></span> <span class="inner_quoted"><span class="inner_quoted">']'</span></span> <span class="keyword3"><span class="keyword3">|</span></span> <span class="inner_quoted"><span class="inner_quoted">'!'</span></span>)<span class="keyword3"><span class="keyword3">?</span></span>
›<span class="antiquote"><span class="antiquote">}</span></span></span></span>
›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
\begin{matharray}{rcl}
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">command_def</span></span> BaseType<span class="antiquote"><span class="antiquote">}</span></span></span></span> &amp; : &amp; <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>theory → theory›</span></span></span></span>
\end{matharray}

<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">rail</span></span> ‹
  <span class="keyword1"><span class="keyword1">@</span></span><span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">command</span></span> BaseType<span class="antiquote"><span class="antiquote">}</span></span></span></span> <span class="inner_quoted"><span class="inner_quoted">'['</span></span> (<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">syntax</span></span> term_base<span class="antiquote"><span class="antiquote">}</span></span></span></span> <span class="keyword3"><span class="keyword3">*</span></span> <span class="inner_quoted"><span class="inner_quoted">','</span></span>) <span class="inner_quoted"><span class="inner_quoted">']'</span></span>
  <span class="keyword2"><span class="keyword2">;</span></span>
›<span class="antiquote"><span class="antiquote">}</span></span></span></span>
›</span></span>

<span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹Extensions of Isabelle Commands›</span></span>

<span class="comment1">(* WARNING syntax errors during the extraction to LaTeX for the symbol "acute":
           fun´, definition´ or code_reflect´ *)</span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
\begin{matharray}{rcl}
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">command_def</span></span> "code_reflect'"<span class="antiquote"><span class="antiquote">}</span></span></span></span> &amp; : &amp; <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>theory → theory›</span></span></span></span>
\end{matharray}

<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">rail</span></span> ‹
  <span class="keyword1"><span class="keyword1">@</span></span><span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">command</span></span> "code_reflect'"<span class="antiquote"><span class="antiquote">}</span></span></span></span> <span class="keyword1"><span class="keyword1">@</span></span><span class="inner_quoted"><span class="inner_quoted">'open'</span></span><span class="keyword3"><span class="keyword3">?</span></span> string <span class="keyword2"><span class="keyword2">⏎</span></span>
    ( <span class="keyword1"><span class="keyword1">@</span></span><span class="inner_quoted"><span class="inner_quoted">'datatypes'</span></span> ( string <span class="inner_quoted"><span class="inner_quoted">'='</span></span> ( <span class="inner_quoted"><span class="inner_quoted">'_'</span></span> <span class="keyword3"><span class="keyword3">|</span></span> ( string <span class="keyword3"><span class="keyword3">+</span></span> <span class="inner_quoted"><span class="inner_quoted">'|'</span></span> ) <span class="keyword3"><span class="keyword3">+</span></span> <span class="keyword1"><span class="keyword1">@</span></span><span class="inner_quoted"><span class="inner_quoted">'and'</span></span> ) ) ) <span class="keyword3"><span class="keyword3">?</span></span> <span class="keyword2"><span class="keyword2">⏎</span></span>
    ( <span class="keyword1"><span class="keyword1">@</span></span><span class="inner_quoted"><span class="inner_quoted">'functions'</span></span> ( string <span class="keyword3"><span class="keyword3">+</span></span> ) ) <span class="keyword3"><span class="keyword3">?</span></span> ( <span class="keyword1"><span class="keyword1">@</span></span><span class="inner_quoted"><span class="inner_quoted">'file'</span></span> string ) <span class="keyword3"><span class="keyword3">?</span></span>
  <span class="keyword2"><span class="keyword2">;</span></span>
›<span class="antiquote"><span class="antiquote">}</span></span></span></span>
›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">command</span></span> code_reflect'<span class="antiquote"><span class="antiquote">}</span></span></span></span> has the same semantics as <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">command</span></span> code_reflect<span class="antiquote"><span class="antiquote">}</span></span></span></span>
except that it additionally contains the option <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">keyword</span></span> "open"<span class="antiquote"><span class="antiquote">}</span></span></span></span> inspired
from the command <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">command</span></span> export_code<span class="antiquote"><span class="antiquote">}</span></span></span></span> (with the same semantics).
›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
\begin{matharray}{rcl}
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">command_def</span></span> lazy_code_printing<span class="antiquote"><span class="antiquote">}</span></span></span></span> &amp; : &amp; <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>theory → theory›</span></span></span></span> \\
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">command_def</span></span> apply_code_printing<span class="antiquote"><span class="antiquote">}</span></span></span></span> &amp; : &amp; <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>theory → theory›</span></span></span></span> \\
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">command_def</span></span> apply_code_printing_reflect<span class="antiquote"><span class="antiquote">}</span></span></span></span> &amp; : &amp; <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>local_theory → local_theory›</span></span></span></span>
\end{matharray}

<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">rail</span></span> ‹
  <span class="keyword1"><span class="keyword1">@</span></span><span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">command</span></span> lazy_code_printing<span class="antiquote"><span class="antiquote">}</span></span></span></span>
      ( ( printing_const <span class="keyword3"><span class="keyword3">|</span></span> printing_typeconstructor
      <span class="keyword3"><span class="keyword3">|</span></span> printing_class <span class="keyword3"><span class="keyword3">|</span></span> printing_class_relation <span class="keyword3"><span class="keyword3">|</span></span> printing_class_instance
      <span class="keyword3"><span class="keyword3">|</span></span> printing_module ) <span class="keyword3"><span class="keyword3">+</span></span> <span class="inner_quoted"><span class="inner_quoted">'|'</span></span> )
  <span class="keyword2"><span class="keyword2">;</span></span>
  <span class="keyword1"><span class="keyword1">@</span></span><span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">command</span></span> apply_code_printing<span class="antiquote"><span class="antiquote">}</span></span></span></span> <span class="inner_quoted"><span class="inner_quoted">'('</span></span> <span class="inner_quoted"><span class="inner_quoted">')'</span></span>
  <span class="keyword2"><span class="keyword2">;</span></span>
  <span class="keyword1"><span class="keyword1">@</span></span><span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">command</span></span> apply_code_printing_reflect<span class="antiquote"><span class="antiquote">}</span></span></span></span> text
  <span class="keyword2"><span class="keyword2">;</span></span>
›<span class="antiquote"><span class="antiquote">}</span></span></span></span>
›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">command</span></span> lazy_code_printing<span class="antiquote"><span class="antiquote">}</span></span></span></span> has the same semantics as <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">command</span></span> code_printing<span class="antiquote"><span class="antiquote">}</span></span></span></span>
or <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">command</span></span> ML<span class="antiquote"><span class="antiquote">}</span></span></span></span>,
except that no side effects occur until we give more details about its intended future semantics:
this will be precised by calling
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">command</span></span> apply_code_printing<span class="antiquote"><span class="antiquote">}</span></span></span></span> or <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">command</span></span> apply_code_printing_reflect<span class="antiquote"><span class="antiquote">}</span></span></span></span>.
›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">command</span></span> apply_code_printing<span class="antiquote"><span class="antiquote">}</span></span></span></span> repeatedly calls <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">command</span></span> code_printing<span class="antiquote"><span class="antiquote">}</span></span></span></span>
to all previously registered elements with <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">command</span></span> lazy_code_printing<span class="antiquote"><span class="antiquote">}</span></span></span></span> (the order is preserved).
›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">command</span></span> apply_code_printing_reflect<span class="antiquote"><span class="antiquote">}</span></span></span></span> repeatedly calls <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">command</span></span> ML<span class="antiquote"><span class="antiquote">}</span></span></span></span>
to all previously registered elements with <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">command</span></span> lazy_code_printing<span class="antiquote"><span class="antiquote">}</span></span></span></span> (the order is preserved).
As a consequence, code for other targets (Haskell, OCaml, Scala) are ignored.
Moreover before the execution of the overall,
it is possible to give an additional piece of SML code as argument to priorly execute.
›</span></span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword2"><span class="keyword">end</span></span>
<span class="comment1">(*&gt;*)</span>
</pre>
</div><div id="Design_generated">
<div class="head">
<h1>Theory Design_generated</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Design_generated <span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="Toy_Library.html">../Toy_Library</a>"</span>   <span class="quoted">"<a href="Toy_Library_Static.html">../Toy_Library_Static</a>"</span>   <span class="quoted">"<a href="Generator_dynamic_sequential.html">../embedding/Generator_dynamic_sequential</a>"</span> <span class="keyword2"><span class="keyword">begin</span></span>

<span class="comment1">(* 1 ************************************ 0 + 1 *)</span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  For certain concepts like classes and class-types, only a generic
  definition for its resulting semantics can be given. Generic means,
  there is a function outside HOL that ``compiles'' a concrete,
  closed-world class diagram into a ``theory'' of this data model,
  consisting of a bunch of definitions for classes, accessors, method,
  casts, and tests for actual types, as well as proofs for the
  fundamental properties of these operations in this concrete data
  model. ›</span></span>

<span class="comment1">(* 2 ************************************ 1 + 1 *)</span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
   Our data universe  consists in the concrete class diagram just of node's,
and implicitly of the class object. Each class implies the existence of a class
type defined for the corresponding object representations as follows: ›</span></span>

<span class="comment1">(* 3 ************************************ 2 + 10 *)</span>
<span class="keyword1"><span class="command">datatype</span></span> tyℰ𝒳𝒯<span class="hidden">⇩</span><sub>A</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>m</sub> <span class="main">=</span> mkℰ𝒳𝒯<span class="hidden">⇩</span><sub>A</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>m</sub> <span class="quoted"><span class="quoted">"oid"</span></span> <span class="quoted"><span class="quoted">"oid list option"</span></span> <span class="quoted"><span class="quoted">"int option"</span></span> <span class="quoted"><span class="quoted">"bool option"</span></span> <span class="quoted"><span class="quoted">"nat option"</span></span> <span class="quoted"><span class="quoted">"unit option"</span></span>
<span class="keyword1"><span class="command">datatype</span></span> ty<span class="hidden">⇩</span><sub>A</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>m</sub> <span class="main">=</span> mk<span class="hidden">⇩</span><sub>A</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>m</sub> <span class="quoted"><span class="quoted">"tyℰ𝒳𝒯<span class="hidden">⇩</span><sub>A</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>m</sub>"</span></span> <span class="quoted"><span class="quoted">"int option"</span></span>
<span class="keyword1"><span class="command">datatype</span></span> tyℰ𝒳𝒯<span class="hidden">⇩</span><sub>M</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub> <span class="main">=</span> mkℰ𝒳𝒯<span class="hidden">⇩</span><sub>M</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub>_<span class="hidden">⇩</span><sub>A</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>m</sub> <span class="quoted"><span class="quoted">"ty<span class="hidden">⇩</span><sub>A</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>m</sub>"</span></span>
                        <span class="main">|</span> mkℰ𝒳𝒯<span class="hidden">⇩</span><sub>M</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub> <span class="quoted"><span class="quoted">"oid"</span></span> <span class="quoted"><span class="quoted">"oid list option"</span></span> <span class="quoted"><span class="quoted">"int option"</span></span> <span class="quoted"><span class="quoted">"bool option"</span></span> <span class="quoted"><span class="quoted">"nat option"</span></span> <span class="quoted"><span class="quoted">"unit option"</span></span>
<span class="keyword1"><span class="command">datatype</span></span> ty<span class="hidden">⇩</span><sub>M</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub> <span class="main">=</span> mk<span class="hidden">⇩</span><sub>M</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub> <span class="quoted"><span class="quoted">"tyℰ𝒳𝒯<span class="hidden">⇩</span><sub>M</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub>"</span></span>
<span class="keyword1"><span class="command">datatype</span></span> tyℰ𝒳𝒯<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub> <span class="main">=</span> mkℰ𝒳𝒯<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub>_<span class="hidden">⇩</span><sub>M</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub> <span class="quoted"><span class="quoted">"ty<span class="hidden">⇩</span><sub>M</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub>"</span></span>
                        <span class="main">|</span> mkℰ𝒳𝒯<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub>_<span class="hidden">⇩</span><sub>A</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>m</sub> <span class="quoted"><span class="quoted">"ty<span class="hidden">⇩</span><sub>A</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>m</sub>"</span></span>
                        <span class="main">|</span> mkℰ𝒳𝒯<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub> <span class="quoted"><span class="quoted">"oid"</span></span> <span class="quoted"><span class="quoted">"nat option"</span></span> <span class="quoted"><span class="quoted">"unit option"</span></span>
<span class="keyword1"><span class="command">datatype</span></span> ty<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub> <span class="main">=</span> mk<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub> <span class="quoted"><span class="quoted">"tyℰ𝒳𝒯<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub>"</span></span> <span class="quoted"><span class="quoted">"oid list option"</span></span> <span class="quoted"><span class="quoted">"int option"</span></span> <span class="quoted"><span class="quoted">"bool option"</span></span>
<span class="keyword1"><span class="command">datatype</span></span> tyℰ𝒳𝒯<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>x</sub><span class="hidden">⇩</span><sub>y</sub> <span class="main">=</span> mkℰ𝒳𝒯<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>x</sub><span class="hidden">⇩</span><sub>y</sub>_<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub> <span class="quoted"><span class="quoted">"ty<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub>"</span></span>
                        <span class="main">|</span> mkℰ𝒳𝒯<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>x</sub><span class="hidden">⇩</span><sub>y</sub>_<span class="hidden">⇩</span><sub>M</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub> <span class="quoted"><span class="quoted">"ty<span class="hidden">⇩</span><sub>M</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub>"</span></span>
                        <span class="main">|</span> mkℰ𝒳𝒯<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>x</sub><span class="hidden">⇩</span><sub>y</sub>_<span class="hidden">⇩</span><sub>A</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>m</sub> <span class="quoted"><span class="quoted">"ty<span class="hidden">⇩</span><sub>A</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>m</sub>"</span></span>
                        <span class="main">|</span> mkℰ𝒳𝒯<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>x</sub><span class="hidden">⇩</span><sub>y</sub> <span class="quoted"><span class="quoted">"oid"</span></span>
<span class="keyword1"><span class="command">datatype</span></span> ty<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>x</sub><span class="hidden">⇩</span><sub>y</sub> <span class="main">=</span> mk<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>x</sub><span class="hidden">⇩</span><sub>y</sub> <span class="quoted"><span class="quoted">"tyℰ𝒳𝒯<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>x</sub><span class="hidden">⇩</span><sub>y</sub>"</span></span> <span class="quoted"><span class="quoted">"nat option"</span></span> <span class="quoted"><span class="quoted">"unit option"</span></span>
<span class="keyword1"><span class="command">datatype</span></span> tyℰ𝒳𝒯<span class="hidden">⇩</span><sub>T</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>y</sub><span class="hidden">⇩</span><sub>A</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>y</sub> <span class="main">=</span> mkℰ𝒳𝒯<span class="hidden">⇩</span><sub>T</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>y</sub><span class="hidden">⇩</span><sub>A</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>y</sub>_<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>x</sub><span class="hidden">⇩</span><sub>y</sub> <span class="quoted"><span class="quoted">"ty<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>x</sub><span class="hidden">⇩</span><sub>y</sub>"</span></span>
                        <span class="main">|</span> mkℰ𝒳𝒯<span class="hidden">⇩</span><sub>T</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>y</sub><span class="hidden">⇩</span><sub>A</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>y</sub>_<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub> <span class="quoted"><span class="quoted">"ty<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub>"</span></span>
                        <span class="main">|</span> mkℰ𝒳𝒯<span class="hidden">⇩</span><sub>T</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>y</sub><span class="hidden">⇩</span><sub>A</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>y</sub>_<span class="hidden">⇩</span><sub>M</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub> <span class="quoted"><span class="quoted">"ty<span class="hidden">⇩</span><sub>M</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub>"</span></span>
                        <span class="main">|</span> mkℰ𝒳𝒯<span class="hidden">⇩</span><sub>T</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>y</sub><span class="hidden">⇩</span><sub>A</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>y</sub>_<span class="hidden">⇩</span><sub>A</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>m</sub> <span class="quoted"><span class="quoted">"ty<span class="hidden">⇩</span><sub>A</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>m</sub>"</span></span>
                        <span class="main">|</span> mkℰ𝒳𝒯<span class="hidden">⇩</span><sub>T</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>y</sub><span class="hidden">⇩</span><sub>A</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>y</sub> <span class="quoted"><span class="quoted">"oid"</span></span>
<span class="keyword1"><span class="command">datatype</span></span> ty<span class="hidden">⇩</span><sub>T</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>y</sub><span class="hidden">⇩</span><sub>A</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>y</sub> <span class="main">=</span> mk<span class="hidden">⇩</span><sub>T</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>y</sub><span class="hidden">⇩</span><sub>A</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>y</sub> <span class="quoted"><span class="quoted">"tyℰ𝒳𝒯<span class="hidden">⇩</span><sub>T</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>y</sub><span class="hidden">⇩</span><sub>A</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>y</sub>"</span></span>

<span class="comment1">(* 4 ************************************ 12 + 1 *)</span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
   Now, we construct a concrete ``universe of ToyAny types'' by injection into a
sum type containing the class types. This type of ToyAny will be used as instance
for all respective type-variables. ›</span></span>

<span class="comment1">(* 5 ************************************ 13 + 1 *)</span>
<span class="keyword1"><span class="command">datatype</span></span> 𝔄 <span class="main">=</span> in<span class="hidden">⇩</span><sub>A</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>m</sub> <span class="quoted"><span class="quoted">"ty<span class="hidden">⇩</span><sub>A</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>m</sub>"</span></span>
                        <span class="main">|</span> in<span class="hidden">⇩</span><sub>M</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub> <span class="quoted"><span class="quoted">"ty<span class="hidden">⇩</span><sub>M</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub>"</span></span>
                        <span class="main">|</span> in<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub> <span class="quoted"><span class="quoted">"ty<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub>"</span></span>
                        <span class="main">|</span> in<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>x</sub><span class="hidden">⇩</span><sub>y</sub> <span class="quoted"><span class="quoted">"ty<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>x</sub><span class="hidden">⇩</span><sub>y</sub>"</span></span>
                        <span class="main">|</span> in<span class="hidden">⇩</span><sub>T</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>y</sub><span class="hidden">⇩</span><sub>A</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>y</sub> <span class="quoted"><span class="quoted">"ty<span class="hidden">⇩</span><sub>T</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>y</sub><span class="hidden">⇩</span><sub>A</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>y</sub>"</span></span>

<span class="comment1">(* 6 ************************************ 14 + 1 *)</span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
   Having fixed the object universe, we can introduce type synonyms that exactly correspond
to Toy types. Again, we exploit that our representation of Toy is a ``shallow embedding'' with a
one-to-one correspondance of Toy-types to types of the meta-language HOL. ›</span></span>

<span class="comment1">(* 7 ************************************ 15 + 5 *)</span>
<span class="keyword1"><span class="command">type_synonym</span></span> Atom <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="main">⟨</span>ty<span class="hidden">⇩</span><sub>A</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>m</sub><span class="main">⟩<span class="hidden">⇩</span><sub>⊥</sub></span><span class="main">⟩<span class="hidden">⇩</span><sub>⊥</sub></span>"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> Molecule <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="main">⟨</span>ty<span class="hidden">⇩</span><sub>M</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub><span class="main">⟩<span class="hidden">⇩</span><sub>⊥</sub></span><span class="main">⟩<span class="hidden">⇩</span><sub>⊥</sub></span>"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> Person <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="main">⟨</span>ty<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub><span class="main">⟩<span class="hidden">⇩</span><sub>⊥</sub></span><span class="main">⟩<span class="hidden">⇩</span><sub>⊥</sub></span>"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> Galaxy <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="main">⟨</span>ty<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>x</sub><span class="hidden">⇩</span><sub>y</sub><span class="main">⟩<span class="hidden">⇩</span><sub>⊥</sub></span><span class="main">⟩<span class="hidden">⇩</span><sub>⊥</sub></span>"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> ToyAny <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="main">⟨</span>ty<span class="hidden">⇩</span><sub>T</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>y</sub><span class="hidden">⇩</span><sub>A</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>y</sub><span class="main">⟩<span class="hidden">⇩</span><sub>⊥</sub></span><span class="main">⟩<span class="hidden">⇩</span><sub>⊥</sub></span>"</span></span>

<span class="comment1">(* 8 ************************************ 20 + 3 *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">oid<span class="hidden">⇩</span><sub>A</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>m</sub>_0___boss</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">oid<span class="hidden">⇩</span><sub>M</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub>_0___boss</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">oid<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub>_0___boss</span> <span class="main">=</span> <span class="main">0</span>"</span></span>

<span class="comment1">(* 9 ************************************ 23 + 2 *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">switch<span class="hidden">⇩</span><sub>2</sub>_01</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="main">[</span><span class="bound">x0</span> <span class="main">,</span> <span class="bound">x1</span><span class="main">]</span> <span class="main">⇒</span> <span class="main">(</span><span class="bound">x0</span> <span class="main">,</span> <span class="bound">x1</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">switch<span class="hidden">⇩</span><sub>2</sub>_10</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="main">[</span><span class="bound">x0</span> <span class="main">,</span> <span class="bound">x1</span><span class="main">]</span> <span class="main">⇒</span> <span class="main">(</span><span class="bound">x1</span> <span class="main">,</span> <span class="bound">x0</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="comment1">(* 10 ************************************ 25 + 3 *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">oid1</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">oid2</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">inst_assoc1</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">oid_class</span> <span class="bound">to_from</span> <span class="bound">oid</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="keyword1">case</span> <span class="main">(</span>deref_assocs_list <span class="main">(</span><span class="main">(</span><span class="bound">to_from</span><span class="main">::</span>oid list list <span class="main">⇒</span> oid list <span class="main">×</span> oid list<span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="bound">oid</span><span class="main">::</span>oid<span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span>drop <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="main">(</span>map_of_list <span class="main">(</span><span class="main">[</span><span class="main">(</span>oid<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub>_0___boss <span class="main">,</span> <span class="main">(</span>List.map <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span> <span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="main">[</span><span class="bound">x</span> <span class="main">,</span> <span class="bound">y</span><span class="main">]</span><span class="main">)</span> <span class="keyword1">o</span> switch<span class="hidden">⇩</span><sub>2</sub>_01<span class="main">)</span> <span class="main">(</span><span class="main">[</span><span class="main">[</span><span class="main">[</span>oid1<span class="main">]</span> <span class="main">,</span> <span class="main">[</span>oid2<span class="main">]</span><span class="main">]</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="bound">oid_class</span><span class="main">::</span>oid<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">of</span> Nil <span class="main">⇒</span> None
    <span class="main">|</span> <span class="bound">l</span> <span class="main">⇒</span> <span class="main">(</span>Some <span class="main">(</span><span class="bound">l</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">::</span>oid list option<span class="main">)</span><span class="main">)</span>"</span></span>

<span class="comment1">(* 11 ************************************ 28 + 0 *)</span>

<span class="comment1">(* 12 ************************************ 28 + 2 *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">oid3</span> <span class="main">=</span> <span class="numeral">3</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">inst_assoc3</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">oid_class</span> <span class="bound">to_from</span> <span class="bound">oid</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="keyword1">case</span> <span class="main">(</span>deref_assocs_list <span class="main">(</span><span class="main">(</span><span class="bound">to_from</span><span class="main">::</span>oid list list <span class="main">⇒</span> oid list <span class="main">×</span> oid list<span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="bound">oid</span><span class="main">::</span>oid<span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span>drop <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="main">(</span>map_of_list <span class="main">(</span><span class="main">[]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="bound">oid_class</span><span class="main">::</span>oid<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">of</span> Nil <span class="main">⇒</span> None
    <span class="main">|</span> <span class="bound">l</span> <span class="main">⇒</span> <span class="main">(</span>Some <span class="main">(</span><span class="bound">l</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">::</span>oid list option<span class="main">)</span><span class="main">)</span>"</span></span>

<span class="comment1">(* 13 ************************************ 30 + 0 *)</span>

<span class="comment1">(* 14 ************************************ 30 + 4 *)</span>
<span class="keyword1"><span class="command">generation_syntax</span></span> <span class="main">[</span> <span class="keyword2"><span class="keyword">shallow</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">generation_semantics</span></span> <span class="main">[</span> <span class="keyword2"><span class="keyword">design</span></span> <span class="main">]</span><span class="main">)</span> <span class="main">]</span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="main">(</span><span class="entity">Generation_mode.update_compiler_config</span> <span class="main">(</span><span class="main">(</span>K <span class="main">(</span><span class="keyword2"><span class="keyword">let</span></span> <span class="keyword3"><span class="keyword">open</span></span> META <span class="keyword2"><span class="keyword">in</span></span> Compiler_env_config_ext <span class="main">(</span>true<span class="main">,</span> NONE<span class="main">,</span> Oids <span class="main">(</span><span class="main">(</span>Code_Numeral.natural_of_integer <span class="inner_numeral">0</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>Code_Numeral.natural_of_integer <span class="inner_numeral">1</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>Code_Numeral.natural_of_integer <span class="inner_numeral">4</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> I <span class="main">(</span><span class="main">(</span>Code_Numeral.natural_of_integer <span class="inner_numeral">0</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>Code_Numeral.natural_of_integer <span class="inner_numeral">0</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> Gen_only_design<span class="main">,</span> SOME <span class="main">(</span>ToyClass <span class="main">(</span><span class="main">(</span>META.SS_base <span class="main">(</span>META.ST <span class="inner_quoted">"ToyAny"</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> nil<span class="main">,</span> uncurry cons <span class="main">(</span>ToyClass <span class="main">(</span><span class="main">(</span>META.SS_base <span class="main">(</span>META.ST <span class="inner_quoted">"Galaxy"</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> uncurry cons <span class="main">(</span>I <span class="main">(</span><span class="main">(</span>META.SS_base <span class="main">(</span>META.ST <span class="inner_quoted">"wormhole"</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> ToyTy_base_unlimitednatural<span class="main">)</span><span class="main">,</span> uncurry cons <span class="main">(</span>I <span class="main">(</span><span class="main">(</span>META.SS_base <span class="main">(</span>META.ST <span class="inner_quoted">"is_sound"</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> ToyTy_base_void<span class="main">)</span><span class="main">,</span> nil<span class="main">)</span><span class="main">)</span><span class="main">,</span> uncurry cons <span class="main">(</span>ToyClass <span class="main">(</span><span class="main">(</span>META.SS_base <span class="main">(</span>META.ST <span class="inner_quoted">"Person"</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> uncurry cons <span class="main">(</span>I <span class="main">(</span><span class="main">(</span>META.SS_base <span class="main">(</span>META.ST <span class="inner_quoted">"boss"</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> ToyTy_object <span class="main">(</span>ToyTyObj <span class="main">(</span>ToyTyCore <span class="main">(</span>Toy_ty_class_ext <span class="main">(</span><span class="main">(</span>META.SS_base <span class="main">(</span>META.ST <span class="inner_quoted">"oid"</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>Code_Numeral.natural_of_integer <span class="inner_numeral">0</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>Code_Numeral.natural_of_integer <span class="inner_numeral">2</span><span class="main">)</span><span class="main">,</span> Toy_ty_class_node_ext <span class="main">(</span><span class="main">(</span>Code_Numeral.natural_of_integer <span class="inner_numeral">0</span><span class="main">)</span><span class="main">,</span> Toy_multiplicity_ext <span class="main">(</span>uncurry cons <span class="main">(</span>I <span class="main">(</span>Mult_star<span class="main">,</span> NONE<span class="main">)</span><span class="main">,</span> nil<span class="main">)</span><span class="main">,</span> NONE<span class="main">,</span> uncurry cons <span class="main">(</span>Set<span class="main">,</span> nil<span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>META.SS_base <span class="main">(</span>META.ST <span class="inner_quoted">"Person"</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> Toy_ty_class_node_ext <span class="main">(</span><span class="main">(</span>Code_Numeral.natural_of_integer <span class="inner_numeral">1</span><span class="main">)</span><span class="main">,</span> Toy_multiplicity_ext <span class="main">(</span>uncurry cons <span class="main">(</span>I <span class="main">(</span>Mult_nat <span class="main">(</span><span class="main">(</span>Code_Numeral.natural_of_integer <span class="inner_numeral">0</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> SOME <span class="main">(</span>Mult_nat <span class="main">(</span><span class="main">(</span>Code_Numeral.natural_of_integer <span class="inner_numeral">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> nil<span class="main">)</span><span class="main">,</span> SOME <span class="main">(</span><span class="main">(</span>META.SS_base <span class="main">(</span>META.ST <span class="inner_quoted">"boss"</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> uncurry cons <span class="main">(</span>Set<span class="main">,</span> nil<span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>META.SS_base <span class="main">(</span>META.ST <span class="inner_quoted">"Person"</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> nil<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> uncurry cons <span class="main">(</span>I <span class="main">(</span><span class="main">(</span>META.SS_base <span class="main">(</span>META.ST <span class="inner_quoted">"salary"</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> ToyTy_base_integer<span class="main">)</span><span class="main">,</span> uncurry cons <span class="main">(</span>I <span class="main">(</span><span class="main">(</span>META.SS_base <span class="main">(</span>META.ST <span class="inner_quoted">"is_meta_thinking"</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> ToyTy_base_boolean<span class="main">)</span><span class="main">,</span> nil<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> uncurry cons <span class="main">(</span>ToyClass <span class="main">(</span><span class="main">(</span>META.SS_base <span class="main">(</span>META.ST <span class="inner_quoted">"Molecule"</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> nil<span class="main">,</span> uncurry cons <span class="main">(</span>ToyClass <span class="main">(</span><span class="main">(</span>META.SS_base <span class="main">(</span>META.ST <span class="inner_quoted">"Atom"</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> uncurry cons <span class="main">(</span>I <span class="main">(</span><span class="main">(</span>META.SS_base <span class="main">(</span>META.ST <span class="inner_quoted">"size"</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> ToyTy_base_integer<span class="main">)</span><span class="main">,</span> nil<span class="main">)</span><span class="main">,</span> nil<span class="main">)</span><span class="main">,</span> nil<span class="main">)</span><span class="main">)</span><span class="main">,</span> nil<span class="main">)</span><span class="main">)</span><span class="main">,</span> nil<span class="main">)</span><span class="main">)</span><span class="main">,</span> nil<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> uncurry cons <span class="main">(</span>META_instance <span class="main">(</span>ToyInstance <span class="main">(</span>uncurry cons <span class="main">(</span>Toy_instance_single_ext <span class="main">(</span>SOME <span class="main">(</span><span class="main">(</span>META.SS_base <span class="main">(</span>META.ST <span class="inner_quoted">"X<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub>3"</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> SOME <span class="main">(</span><span class="main">(</span>META.SS_base <span class="main">(</span>META.ST <span class="inner_quoted">"Person"</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> ToyAttrNoCast <span class="main">(</span>uncurry cons <span class="main">(</span>I <span class="main">(</span>NONE<span class="main">,</span> I <span class="main">(</span><span class="main">(</span>META.SS_base <span class="main">(</span>META.ST <span class="inner_quoted">"salary"</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> ShallB_term <span class="main">(</span>ToyDefInteger <span class="main">(</span><span class="main">(</span>META.SS_base <span class="main">(</span>META.ST <span class="inner_quoted">"1"</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> nil<span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> nil<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> uncurry cons <span class="main">(</span>META_instance <span class="main">(</span>ToyInstance <span class="main">(</span>uncurry cons <span class="main">(</span>Toy_instance_single_ext <span class="main">(</span>SOME <span class="main">(</span><span class="main">(</span>META.SS_base <span class="main">(</span>META.ST <span class="inner_quoted">"X<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub>1"</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> SOME <span class="main">(</span><span class="main">(</span>META.SS_base <span class="main">(</span>META.ST <span class="inner_quoted">"Person"</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> ToyAttrNoCast <span class="main">(</span>uncurry cons <span class="main">(</span>I <span class="main">(</span>NONE<span class="main">,</span> I <span class="main">(</span><span class="main">(</span>META.SS_base <span class="main">(</span>META.ST <span class="inner_quoted">"salary"</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> ShallB_term <span class="main">(</span>ToyDefInteger <span class="main">(</span><span class="main">(</span>META.SS_base <span class="main">(</span>META.ST <span class="inner_quoted">"1300"</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> uncurry cons <span class="main">(</span>I <span class="main">(</span>NONE<span class="main">,</span> I <span class="main">(</span><span class="main">(</span>META.SS_base <span class="main">(</span>META.ST <span class="inner_quoted">"boss"</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> ShallB_str <span class="main">(</span><span class="main">(</span>META.SS_base <span class="main">(</span>META.ST <span class="inner_quoted">"X<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub>2"</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> nil<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> uncurry cons <span class="main">(</span>Toy_instance_single_ext <span class="main">(</span>SOME <span class="main">(</span><span class="main">(</span>META.SS_base <span class="main">(</span>META.ST <span class="inner_quoted">"X<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub>2"</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> SOME <span class="main">(</span><span class="main">(</span>META.SS_base <span class="main">(</span>META.ST <span class="inner_quoted">"Person"</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> ToyAttrNoCast <span class="main">(</span>uncurry cons <span class="main">(</span>I <span class="main">(</span>NONE<span class="main">,</span> I <span class="main">(</span><span class="main">(</span>META.SS_base <span class="main">(</span>META.ST <span class="inner_quoted">"salary"</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> ShallB_term <span class="main">(</span>ToyDefInteger <span class="main">(</span><span class="main">(</span>META.SS_base <span class="main">(</span>META.ST <span class="inner_quoted">"1800"</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> nil<span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> nil<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> uncurry cons <span class="main">(</span>META_class_raw <span class="main">(</span>Floor1<span class="main">,</span> Toy_class_raw_ext <span class="main">(</span>ToyTyObj <span class="main">(</span>ToyTyCore_pre <span class="main">(</span><span class="main">(</span>META.SS_base <span class="main">(</span>META.ST <span class="inner_quoted">"Person"</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> uncurry cons <span class="main">(</span>uncurry cons <span class="main">(</span>ToyTyCore_pre <span class="main">(</span><span class="main">(</span>META.SS_base <span class="main">(</span>META.ST <span class="inner_quoted">"Galaxy"</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> nil<span class="main">)</span><span class="main">,</span> nil<span class="main">)</span><span class="main">)</span><span class="main">,</span> uncurry cons <span class="main">(</span>I <span class="main">(</span><span class="main">(</span>META.SS_base <span class="main">(</span>META.ST <span class="inner_quoted">"salary"</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> ToyTy_base_integer<span class="main">)</span><span class="main">,</span> uncurry cons <span class="main">(</span>I <span class="main">(</span><span class="main">(</span>META.SS_base <span class="main">(</span>META.ST <span class="inner_quoted">"boss"</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> ToyTy_object <span class="main">(</span>ToyTyObj <span class="main">(</span>ToyTyCore_pre <span class="main">(</span><span class="main">(</span>META.SS_base <span class="main">(</span>META.ST <span class="inner_quoted">"Person"</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> nil<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> uncurry cons <span class="main">(</span>I <span class="main">(</span><span class="main">(</span>META.SS_base <span class="main">(</span>META.ST <span class="inner_quoted">"is_meta_thinking"</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> ToyTy_base_boolean<span class="main">)</span><span class="main">,</span> nil<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> nil<span class="main">,</span> false<span class="main">,</span> <span class="main">(</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> uncurry cons <span class="main">(</span>META_class_raw <span class="main">(</span>Floor1<span class="main">,</span> Toy_class_raw_ext <span class="main">(</span>ToyTyObj <span class="main">(</span>ToyTyCore_pre <span class="main">(</span><span class="main">(</span>META.SS_base <span class="main">(</span>META.ST <span class="inner_quoted">"Galaxy"</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> nil<span class="main">)</span><span class="main">,</span> uncurry cons <span class="main">(</span>I <span class="main">(</span><span class="main">(</span>META.SS_base <span class="main">(</span>META.ST <span class="inner_quoted">"wormhole"</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> ToyTy_base_unlimitednatural<span class="main">)</span><span class="main">,</span> uncurry cons <span class="main">(</span>I <span class="main">(</span><span class="main">(</span>META.SS_base <span class="main">(</span>META.ST <span class="inner_quoted">"is_sound"</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> ToyTy_base_void<span class="main">)</span><span class="main">,</span> nil<span class="main">)</span><span class="main">)</span><span class="main">,</span> nil<span class="main">,</span> false<span class="main">,</span> <span class="main">(</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> uncurry cons <span class="main">(</span>META_class_raw <span class="main">(</span>Floor1<span class="main">,</span> Toy_class_raw_ext <span class="main">(</span>ToyTyObj <span class="main">(</span>ToyTyCore_pre <span class="main">(</span><span class="main">(</span>META.SS_base <span class="main">(</span>META.ST <span class="inner_quoted">"Molecule"</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> uncurry cons <span class="main">(</span>uncurry cons <span class="main">(</span>ToyTyCore_pre <span class="main">(</span><span class="main">(</span>META.SS_base <span class="main">(</span>META.ST <span class="inner_quoted">"Person"</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> nil<span class="main">)</span><span class="main">,</span> nil<span class="main">)</span><span class="main">)</span><span class="main">,</span> nil<span class="main">,</span> nil<span class="main">,</span> false<span class="main">,</span> <span class="main">(</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> uncurry cons <span class="main">(</span>META_class_raw <span class="main">(</span>Floor1<span class="main">,</span> Toy_class_raw_ext <span class="main">(</span>ToyTyObj <span class="main">(</span>ToyTyCore_pre <span class="main">(</span><span class="main">(</span>META.SS_base <span class="main">(</span>META.ST <span class="inner_quoted">"Atom"</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> uncurry cons <span class="main">(</span>uncurry cons <span class="main">(</span>ToyTyCore_pre <span class="main">(</span><span class="main">(</span>META.SS_base <span class="main">(</span>META.ST <span class="inner_quoted">"Molecule"</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> nil<span class="main">)</span><span class="main">,</span> nil<span class="main">)</span><span class="main">)</span><span class="main">,</span> uncurry cons <span class="main">(</span>I <span class="main">(</span><span class="main">(</span>META.SS_base <span class="main">(</span>META.ST <span class="inner_quoted">"size"</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> ToyTy_base_integer<span class="main">)</span><span class="main">,</span> nil<span class="main">)</span><span class="main">,</span> nil<span class="main">,</span> false<span class="main">,</span> <span class="main">(</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> nil<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> uncurry cons <span class="main">(</span>I <span class="main">(</span><span class="main">(</span>META.ST <span class="inner_quoted">"X<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub>3"</span><span class="main">)</span><span class="main">,</span> I <span class="main">(</span>Toy_instance_single_ext <span class="main">(</span>SOME <span class="main">(</span><span class="main">(</span>META.SS_base <span class="main">(</span>META.ST <span class="inner_quoted">"X<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub>3"</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> SOME <span class="main">(</span><span class="main">(</span>META.SS_base <span class="main">(</span>META.ST <span class="inner_quoted">"Person"</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> ToyAttrNoCast <span class="main">(</span>uncurry cons <span class="main">(</span>I <span class="main">(</span>NONE<span class="main">,</span> I <span class="main">(</span><span class="main">(</span>META.SS_base <span class="main">(</span>META.ST <span class="inner_quoted">"salary"</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> ShallB_term <span class="main">(</span>ToyDefInteger <span class="main">(</span><span class="main">(</span>META.SS_base <span class="main">(</span>META.ST <span class="inner_quoted">"1"</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> nil<span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> Oids <span class="main">(</span><span class="main">(</span>Code_Numeral.natural_of_integer <span class="inner_numeral">0</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>Code_Numeral.natural_of_integer <span class="inner_numeral">1</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>Code_Numeral.natural_of_integer <span class="inner_numeral">3</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> uncurry cons <span class="main">(</span>I <span class="main">(</span><span class="main">(</span>META.ST <span class="inner_quoted">"X<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub>2"</span><span class="main">)</span><span class="main">,</span> I <span class="main">(</span>Toy_instance_single_ext <span class="main">(</span>SOME <span class="main">(</span><span class="main">(</span>META.SS_base <span class="main">(</span>META.ST <span class="inner_quoted">"X<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub>2"</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> SOME <span class="main">(</span><span class="main">(</span>META.SS_base <span class="main">(</span>META.ST <span class="inner_quoted">"Person"</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> ToyAttrNoCast <span class="main">(</span>uncurry cons <span class="main">(</span>I <span class="main">(</span>NONE<span class="main">,</span> I <span class="main">(</span><span class="main">(</span>META.SS_base <span class="main">(</span>META.ST <span class="inner_quoted">"salary"</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> ShallB_term <span class="main">(</span>ToyDefInteger <span class="main">(</span><span class="main">(</span>META.SS_base <span class="main">(</span>META.ST <span class="inner_quoted">"1800"</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> nil<span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> Oids <span class="main">(</span><span class="main">(</span>Code_Numeral.natural_of_integer <span class="inner_numeral">0</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>Code_Numeral.natural_of_integer <span class="inner_numeral">1</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>Code_Numeral.natural_of_integer <span class="inner_numeral">2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> uncurry cons <span class="main">(</span>I <span class="main">(</span><span class="main">(</span>META.ST <span class="inner_quoted">"X<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub>1"</span><span class="main">)</span><span class="main">,</span> I <span class="main">(</span>Toy_instance_single_ext <span class="main">(</span>SOME <span class="main">(</span><span class="main">(</span>META.SS_base <span class="main">(</span>META.ST <span class="inner_quoted">"X<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub>1"</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> SOME <span class="main">(</span><span class="main">(</span>META.SS_base <span class="main">(</span>META.ST <span class="inner_quoted">"Person"</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> ToyAttrNoCast <span class="main">(</span>uncurry cons <span class="main">(</span>I <span class="main">(</span>NONE<span class="main">,</span> I <span class="main">(</span><span class="main">(</span>META.SS_base <span class="main">(</span>META.ST <span class="inner_quoted">"salary"</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> ShallB_term <span class="main">(</span>ToyDefInteger <span class="main">(</span><span class="main">(</span>META.SS_base <span class="main">(</span>META.ST <span class="inner_quoted">"1300"</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> uncurry cons <span class="main">(</span>I <span class="main">(</span>NONE<span class="main">,</span> I <span class="main">(</span><span class="main">(</span>META.SS_base <span class="main">(</span>META.ST <span class="inner_quoted">"boss"</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> ShallB_str <span class="main">(</span><span class="main">(</span>META.SS_base <span class="main">(</span>META.ST <span class="inner_quoted">"X<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub>2"</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> nil<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> Oids <span class="main">(</span><span class="main">(</span>Code_Numeral.natural_of_integer <span class="inner_numeral">0</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>Code_Numeral.natural_of_integer <span class="inner_numeral">1</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>Code_Numeral.natural_of_integer <span class="inner_numeral">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> nil<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> nil<span class="main">,</span> false<span class="main">,</span> false<span class="main">,</span> I <span class="main">(</span>nil<span class="main">,</span> nil<span class="main">)</span><span class="main">,</span> nil<span class="main">,</span> I <span class="main">(</span>NONE<span class="main">,</span> false<span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="main">)</span><span class="main">)</span> <span class="keyword2"><span class="keyword">end</span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>›</span>
<span class="keyword1"><span class="command">Instance</span></span> σ<span class="hidden">⇩</span><sub>1</sub>_object0 <span class="main">::</span> Person <span class="main">=</span> <span class="main">[</span> <span class="quoted">"salary"</span> <span class="main">=</span> 1000<span class="main">,</span> <span class="quoted">"boss"</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">self</span></span> 1 <span class="main">]</span>
     <span class="keyword2"><span class="keyword">and</span></span> σ<span class="hidden">⇩</span><sub>1</sub>_object1 <span class="main">::</span> Person <span class="main">=</span> <span class="main">[</span> <span class="quoted">"salary"</span> <span class="main">=</span> 1200 <span class="main">]</span>
     <span class="keyword2"><span class="keyword">and</span></span> σ<span class="hidden">⇩</span><sub>1</sub>_object2 <span class="main">::</span> Person <span class="main">=</span> <span class="main">[</span> <span class="quoted">"salary"</span> <span class="main">=</span> 2600<span class="main">,</span> <span class="quoted">"boss"</span> <span class="main">=</span> X<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub>1 <span class="main">]</span>
     <span class="keyword2"><span class="keyword">and</span></span> σ<span class="hidden">⇩</span><sub>1</sub>_object4 <span class="main">::</span> Person <span class="main">=</span> <span class="main">[</span> <span class="quoted">"salary"</span> <span class="main">=</span> 2300<span class="main">,</span> <span class="quoted">"boss"</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">self</span></span> 2 <span class="main">]</span>
<span class="keyword1"><span class="command">State</span></span><span class="main">[</span><span class="keyword2"><span class="keyword">shallow</span></span><span class="main">]</span> σ<span class="hidden">⇩</span><sub>1</sub> <span class="main">=</span> <span class="main">[</span> σ<span class="hidden">⇩</span><sub>1</sub>_object0<span class="main">,</span> σ<span class="hidden">⇩</span><sub>1</sub>_object1<span class="main">,</span> σ<span class="hidden">⇩</span><sub>1</sub>_object2<span class="main">,</span> X<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub>1<span class="main">,</span> σ<span class="hidden">⇩</span><sub>1</sub>_object4<span class="main">,</span> X<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub>2 <span class="main">]</span>

<span class="comment1">(* 15 ************************************ 34 + 1 *)</span>
<span class="keyword1"><span class="command">State</span></span><span class="main">[</span><span class="keyword2"><span class="keyword">shallow</span></span><span class="main">]</span> σ<span class="hidden">⇩</span><sub>1</sub>' <span class="main">=</span> <span class="main">[</span> X<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub>1<span class="main">,</span> X<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub>2<span class="main">,</span> X<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub>3 <span class="main">]</span>

<span class="comment1">(* 16 ************************************ 35 + 1 *)</span>
<span class="keyword1"><span class="command">PrePost</span></span><span class="main">[</span><span class="keyword2"><span class="keyword">shallow</span></span><span class="main">]</span> σ<span class="hidden">⇩</span><sub>1</sub> σ<span class="hidden">⇩</span><sub>1</sub>'

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Design_generated_generated">
<div class="head">
<h1>Theory Design_generated_generated</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Design_generated_generated <span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="Toy_Library.html">../Toy_Library</a>"</span>   <span class="quoted">"<a href="Toy_Library_Static.html">../Toy_Library_Static</a>"</span> <span class="keyword2"><span class="keyword">begin</span></span>

<span class="comment1">(* 1 ************************************ 0 + 1 *)</span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  For certain concepts like classes and class-types, only a generic
  definition for its resulting semantics can be given. Generic means,
  there is a function outside HOL that ``compiles'' a concrete,
  closed-world class diagram into a ``theory'' of this data model,
  consisting of a bunch of definitions for classes, accessors, method,
  casts, and tests for actual types, as well as proofs for the
  fundamental properties of these operations in this concrete data
  model. ›</span></span>

<span class="comment1">(* 2 ************************************ 1 + 1 *)</span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
   Our data universe  consists in the concrete class diagram just of node's,
and implicitly of the class object. Each class implies the existence of a class
type defined for the corresponding object representations as follows: ›</span></span>

<span class="comment1">(* 3 ************************************ 2 + 10 *)</span>
<span class="keyword1"><span class="command">datatype</span></span> tyℰ𝒳𝒯<span class="hidden">⇩</span><sub>A</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>m</sub> <span class="main">=</span> mkℰ𝒳𝒯<span class="hidden">⇩</span><sub>A</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>m</sub> <span class="quoted"><span class="quoted">"oid"</span></span> <span class="quoted"><span class="quoted">"oid list option"</span></span> <span class="quoted"><span class="quoted">"int option"</span></span> <span class="quoted"><span class="quoted">"bool option"</span></span> <span class="quoted"><span class="quoted">"nat option"</span></span> <span class="quoted"><span class="quoted">"unit option"</span></span>
<span class="keyword1"><span class="command">datatype</span></span> ty<span class="hidden">⇩</span><sub>A</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>m</sub> <span class="main">=</span> mk<span class="hidden">⇩</span><sub>A</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>m</sub> <span class="quoted"><span class="quoted">"tyℰ𝒳𝒯<span class="hidden">⇩</span><sub>A</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>m</sub>"</span></span> <span class="quoted"><span class="quoted">"int option"</span></span>
<span class="keyword1"><span class="command">datatype</span></span> tyℰ𝒳𝒯<span class="hidden">⇩</span><sub>M</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub> <span class="main">=</span> mkℰ𝒳𝒯<span class="hidden">⇩</span><sub>M</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub>_<span class="hidden">⇩</span><sub>A</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>m</sub> <span class="quoted"><span class="quoted">"ty<span class="hidden">⇩</span><sub>A</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>m</sub>"</span></span>
                        <span class="main">|</span> mkℰ𝒳𝒯<span class="hidden">⇩</span><sub>M</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub> <span class="quoted"><span class="quoted">"oid"</span></span> <span class="quoted"><span class="quoted">"oid list option"</span></span> <span class="quoted"><span class="quoted">"int option"</span></span> <span class="quoted"><span class="quoted">"bool option"</span></span> <span class="quoted"><span class="quoted">"nat option"</span></span> <span class="quoted"><span class="quoted">"unit option"</span></span>
<span class="keyword1"><span class="command">datatype</span></span> ty<span class="hidden">⇩</span><sub>M</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub> <span class="main">=</span> mk<span class="hidden">⇩</span><sub>M</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub> <span class="quoted"><span class="quoted">"tyℰ𝒳𝒯<span class="hidden">⇩</span><sub>M</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub>"</span></span>
<span class="keyword1"><span class="command">datatype</span></span> tyℰ𝒳𝒯<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub> <span class="main">=</span> mkℰ𝒳𝒯<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub>_<span class="hidden">⇩</span><sub>M</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub> <span class="quoted"><span class="quoted">"ty<span class="hidden">⇩</span><sub>M</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub>"</span></span>
                        <span class="main">|</span> mkℰ𝒳𝒯<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub>_<span class="hidden">⇩</span><sub>A</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>m</sub> <span class="quoted"><span class="quoted">"ty<span class="hidden">⇩</span><sub>A</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>m</sub>"</span></span>
                        <span class="main">|</span> mkℰ𝒳𝒯<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub> <span class="quoted"><span class="quoted">"oid"</span></span> <span class="quoted"><span class="quoted">"nat option"</span></span> <span class="quoted"><span class="quoted">"unit option"</span></span>
<span class="keyword1"><span class="command">datatype</span></span> ty<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub> <span class="main">=</span> mk<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub> <span class="quoted"><span class="quoted">"tyℰ𝒳𝒯<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub>"</span></span> <span class="quoted"><span class="quoted">"oid list option"</span></span> <span class="quoted"><span class="quoted">"int option"</span></span> <span class="quoted"><span class="quoted">"bool option"</span></span>
<span class="keyword1"><span class="command">datatype</span></span> tyℰ𝒳𝒯<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>x</sub><span class="hidden">⇩</span><sub>y</sub> <span class="main">=</span> mkℰ𝒳𝒯<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>x</sub><span class="hidden">⇩</span><sub>y</sub>_<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub> <span class="quoted"><span class="quoted">"ty<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub>"</span></span>
                        <span class="main">|</span> mkℰ𝒳𝒯<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>x</sub><span class="hidden">⇩</span><sub>y</sub>_<span class="hidden">⇩</span><sub>M</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub> <span class="quoted"><span class="quoted">"ty<span class="hidden">⇩</span><sub>M</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub>"</span></span>
                        <span class="main">|</span> mkℰ𝒳𝒯<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>x</sub><span class="hidden">⇩</span><sub>y</sub>_<span class="hidden">⇩</span><sub>A</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>m</sub> <span class="quoted"><span class="quoted">"ty<span class="hidden">⇩</span><sub>A</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>m</sub>"</span></span>
                        <span class="main">|</span> mkℰ𝒳𝒯<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>x</sub><span class="hidden">⇩</span><sub>y</sub> <span class="quoted"><span class="quoted">"oid"</span></span>
<span class="keyword1"><span class="command">datatype</span></span> ty<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>x</sub><span class="hidden">⇩</span><sub>y</sub> <span class="main">=</span> mk<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>x</sub><span class="hidden">⇩</span><sub>y</sub> <span class="quoted"><span class="quoted">"tyℰ𝒳𝒯<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>x</sub><span class="hidden">⇩</span><sub>y</sub>"</span></span> <span class="quoted"><span class="quoted">"nat option"</span></span> <span class="quoted"><span class="quoted">"unit option"</span></span>
<span class="keyword1"><span class="command">datatype</span></span> tyℰ𝒳𝒯<span class="hidden">⇩</span><sub>T</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>y</sub><span class="hidden">⇩</span><sub>A</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>y</sub> <span class="main">=</span> mkℰ𝒳𝒯<span class="hidden">⇩</span><sub>T</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>y</sub><span class="hidden">⇩</span><sub>A</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>y</sub>_<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>x</sub><span class="hidden">⇩</span><sub>y</sub> <span class="quoted"><span class="quoted">"ty<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>x</sub><span class="hidden">⇩</span><sub>y</sub>"</span></span>
                        <span class="main">|</span> mkℰ𝒳𝒯<span class="hidden">⇩</span><sub>T</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>y</sub><span class="hidden">⇩</span><sub>A</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>y</sub>_<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub> <span class="quoted"><span class="quoted">"ty<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub>"</span></span>
                        <span class="main">|</span> mkℰ𝒳𝒯<span class="hidden">⇩</span><sub>T</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>y</sub><span class="hidden">⇩</span><sub>A</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>y</sub>_<span class="hidden">⇩</span><sub>M</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub> <span class="quoted"><span class="quoted">"ty<span class="hidden">⇩</span><sub>M</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub>"</span></span>
                        <span class="main">|</span> mkℰ𝒳𝒯<span class="hidden">⇩</span><sub>T</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>y</sub><span class="hidden">⇩</span><sub>A</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>y</sub>_<span class="hidden">⇩</span><sub>A</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>m</sub> <span class="quoted"><span class="quoted">"ty<span class="hidden">⇩</span><sub>A</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>m</sub>"</span></span>
                        <span class="main">|</span> mkℰ𝒳𝒯<span class="hidden">⇩</span><sub>T</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>y</sub><span class="hidden">⇩</span><sub>A</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>y</sub> <span class="quoted"><span class="quoted">"oid"</span></span>
<span class="keyword1"><span class="command">datatype</span></span> ty<span class="hidden">⇩</span><sub>T</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>y</sub><span class="hidden">⇩</span><sub>A</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>y</sub> <span class="main">=</span> mk<span class="hidden">⇩</span><sub>T</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>y</sub><span class="hidden">⇩</span><sub>A</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>y</sub> <span class="quoted"><span class="quoted">"tyℰ𝒳𝒯<span class="hidden">⇩</span><sub>T</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>y</sub><span class="hidden">⇩</span><sub>A</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>y</sub>"</span></span>

<span class="comment1">(* 4 ************************************ 12 + 1 *)</span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
   Now, we construct a concrete ``universe of ToyAny types'' by injection into a
sum type containing the class types. This type of ToyAny will be used as instance
for all respective type-variables. ›</span></span>

<span class="comment1">(* 5 ************************************ 13 + 1 *)</span>
<span class="keyword1"><span class="command">datatype</span></span> 𝔄 <span class="main">=</span> in<span class="hidden">⇩</span><sub>A</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>m</sub> <span class="quoted"><span class="quoted">"ty<span class="hidden">⇩</span><sub>A</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>m</sub>"</span></span>
                        <span class="main">|</span> in<span class="hidden">⇩</span><sub>M</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub> <span class="quoted"><span class="quoted">"ty<span class="hidden">⇩</span><sub>M</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub>"</span></span>
                        <span class="main">|</span> in<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub> <span class="quoted"><span class="quoted">"ty<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub>"</span></span>
                        <span class="main">|</span> in<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>x</sub><span class="hidden">⇩</span><sub>y</sub> <span class="quoted"><span class="quoted">"ty<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>x</sub><span class="hidden">⇩</span><sub>y</sub>"</span></span>
                        <span class="main">|</span> in<span class="hidden">⇩</span><sub>T</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>y</sub><span class="hidden">⇩</span><sub>A</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>y</sub> <span class="quoted"><span class="quoted">"ty<span class="hidden">⇩</span><sub>T</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>y</sub><span class="hidden">⇩</span><sub>A</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>y</sub>"</span></span>

<span class="comment1">(* 6 ************************************ 14 + 1 *)</span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
   Having fixed the object universe, we can introduce type synonyms that exactly correspond
to Toy types. Again, we exploit that our representation of Toy is a ``shallow embedding'' with a
one-to-one correspondance of Toy-types to types of the meta-language HOL. ›</span></span>

<span class="comment1">(* 7 ************************************ 15 + 5 *)</span>
<span class="keyword1"><span class="command">type_synonym</span></span> Atom <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="main">⟨</span>ty<span class="hidden">⇩</span><sub>A</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>m</sub><span class="main">⟩<span class="hidden">⇩</span><sub>⊥</sub></span><span class="main">⟩<span class="hidden">⇩</span><sub>⊥</sub></span>"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> Molecule <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="main">⟨</span>ty<span class="hidden">⇩</span><sub>M</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub><span class="main">⟩<span class="hidden">⇩</span><sub>⊥</sub></span><span class="main">⟩<span class="hidden">⇩</span><sub>⊥</sub></span>"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> Person <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="main">⟨</span>ty<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub><span class="main">⟩<span class="hidden">⇩</span><sub>⊥</sub></span><span class="main">⟩<span class="hidden">⇩</span><sub>⊥</sub></span>"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> Galaxy <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="main">⟨</span>ty<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>x</sub><span class="hidden">⇩</span><sub>y</sub><span class="main">⟩<span class="hidden">⇩</span><sub>⊥</sub></span><span class="main">⟩<span class="hidden">⇩</span><sub>⊥</sub></span>"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> ToyAny <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="main">⟨</span>ty<span class="hidden">⇩</span><sub>T</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>y</sub><span class="hidden">⇩</span><sub>A</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>y</sub><span class="main">⟩<span class="hidden">⇩</span><sub>⊥</sub></span><span class="main">⟩<span class="hidden">⇩</span><sub>⊥</sub></span>"</span></span>

<span class="comment1">(* 8 ************************************ 20 + 3 *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">oid<span class="hidden">⇩</span><sub>A</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>m</sub>_0___boss</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">oid<span class="hidden">⇩</span><sub>M</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub>_0___boss</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">oid<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub>_0___boss</span> <span class="main">=</span> <span class="main">0</span>"</span></span>

<span class="comment1">(* 9 ************************************ 23 + 2 *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">switch<span class="hidden">⇩</span><sub>2</sub>_01</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="main">[</span><span class="bound">x0</span> <span class="main">,</span> <span class="bound">x1</span><span class="main">]</span> <span class="main">⇒</span> <span class="main">(</span><span class="bound">x0</span> <span class="main">,</span> <span class="bound">x1</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">switch<span class="hidden">⇩</span><sub>2</sub>_10</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="main">[</span><span class="bound">x0</span> <span class="main">,</span> <span class="bound">x1</span><span class="main">]</span> <span class="main">⇒</span> <span class="main">(</span><span class="bound">x1</span> <span class="main">,</span> <span class="bound">x0</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="comment1">(* 10 ************************************ 25 + 3 *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">oid1</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">oid2</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">inst_assoc1</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">oid_class</span> <span class="bound">to_from</span> <span class="bound">oid</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="keyword1">case</span> <span class="main">(</span>deref_assocs_list <span class="main">(</span><span class="main">(</span><span class="bound">to_from</span><span class="main">::</span>oid list list <span class="main">⇒</span> oid list <span class="main">×</span> oid list<span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="bound">oid</span><span class="main">::</span>oid<span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span>drop <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="main">(</span>map_of_list <span class="main">(</span><span class="main">[</span><span class="main">(</span>oid<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub>_0___boss <span class="main">,</span> <span class="main">(</span>List.map <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span> <span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="main">[</span><span class="bound">x</span> <span class="main">,</span> <span class="bound">y</span><span class="main">]</span><span class="main">)</span> <span class="keyword1">o</span> switch<span class="hidden">⇩</span><sub>2</sub>_01<span class="main">)</span> <span class="main">(</span><span class="main">[</span><span class="main">[</span><span class="main">[</span>oid1<span class="main">]</span> <span class="main">,</span> <span class="main">[</span>oid2<span class="main">]</span><span class="main">]</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="bound">oid_class</span><span class="main">::</span>oid<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">of</span> Nil <span class="main">⇒</span> None
    <span class="main">|</span> <span class="bound">l</span> <span class="main">⇒</span> <span class="main">(</span>Some <span class="main">(</span><span class="bound">l</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">::</span>oid list option<span class="main">)</span><span class="main">)</span>"</span></span>

<span class="comment1">(* 11 ************************************ 28 + 0 *)</span>

<span class="comment1">(* 12 ************************************ 28 + 2 *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">oid3</span> <span class="main">=</span> <span class="numeral">3</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">inst_assoc3</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">oid_class</span> <span class="bound">to_from</span> <span class="bound">oid</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="keyword1">case</span> <span class="main">(</span>deref_assocs_list <span class="main">(</span><span class="main">(</span><span class="bound">to_from</span><span class="main">::</span>oid list list <span class="main">⇒</span> oid list <span class="main">×</span> oid list<span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="bound">oid</span><span class="main">::</span>oid<span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span>drop <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="main">(</span>map_of_list <span class="main">(</span><span class="main">[]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="bound">oid_class</span><span class="main">::</span>oid<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">of</span> Nil <span class="main">⇒</span> None
    <span class="main">|</span> <span class="bound">l</span> <span class="main">⇒</span> <span class="main">(</span>Some <span class="main">(</span><span class="bound">l</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">::</span>oid list option<span class="main">)</span><span class="main">)</span>"</span></span>

<span class="comment1">(* 13 ************************************ 30 + 0 *)</span>

<span class="comment1">(* 14 ************************************ 30 + 5 *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">oid4</span> <span class="main">=</span> <span class="numeral">4</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">oid5</span> <span class="main">=</span> <span class="numeral">5</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">oid6</span> <span class="main">=</span> <span class="numeral">6</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">oid7</span> <span class="main">=</span> <span class="numeral">7</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">inst_assoc4</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">oid_class</span> <span class="bound">to_from</span> <span class="bound">oid</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="keyword1">case</span> <span class="main">(</span>deref_assocs_list <span class="main">(</span><span class="main">(</span><span class="bound">to_from</span><span class="main">::</span>oid list list <span class="main">⇒</span> oid list <span class="main">×</span> oid list<span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="bound">oid</span><span class="main">::</span>oid<span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span>drop <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="main">(</span>map_of_list <span class="main">(</span><span class="main">[</span><span class="main">(</span>oid<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub>_0___boss <span class="main">,</span> <span class="main">(</span>List.map <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span> <span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="main">[</span><span class="bound">x</span> <span class="main">,</span> <span class="bound">y</span><span class="main">]</span><span class="main">)</span> <span class="keyword1">o</span> switch<span class="hidden">⇩</span><sub>2</sub>_01<span class="main">)</span> <span class="main">(</span><span class="main">[</span><span class="main">[</span><span class="main">[</span>oid7<span class="main">]</span> <span class="main">,</span> <span class="main">[</span>oid6<span class="main">]</span><span class="main">]</span> <span class="main">,</span> <span class="main">[</span><span class="main">[</span>oid6<span class="main">]</span> <span class="main">,</span> <span class="main">[</span>oid1<span class="main">]</span><span class="main">]</span> <span class="main">,</span> <span class="main">[</span><span class="main">[</span>oid4<span class="main">]</span> <span class="main">,</span> <span class="main">[</span>oid5<span class="main">]</span><span class="main">]</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="bound">oid_class</span><span class="main">::</span>oid<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">of</span> Nil <span class="main">⇒</span> None
    <span class="main">|</span> <span class="bound">l</span> <span class="main">⇒</span> <span class="main">(</span>Some <span class="main">(</span><span class="bound">l</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">::</span>oid list option<span class="main">)</span><span class="main">)</span>"</span></span>

<span class="comment1">(* 15 ************************************ 35 + 0 *)</span>

<span class="comment1">(* 16 ************************************ 35 + 1 *)</span>
<span class="keyword1"><span class="command">locale</span></span> state_σ<span class="hidden">⇩</span><sub>1</sub> <span class="main">=</span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="quoted">"<span class="free">oid4</span>"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat"</span></span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="quoted">"<span class="free">oid5</span>"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat"</span></span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="quoted">"<span class="free">oid6</span>"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat"</span></span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="quoted">"<span class="free">oid1</span>"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat"</span></span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="quoted">"<span class="free">oid7</span>"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat"</span></span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="quoted">"<span class="free">oid2</span>"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat"</span></span>
<span class="keyword2"><span class="keyword">assumes</span></span> distinct_oid<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>distinct <span class="main">(</span><span class="main">[</span><span class="free">oid4</span> <span class="main">,</span> <span class="free">oid5</span> <span class="main">,</span> <span class="free">oid6</span> <span class="main">,</span> <span class="free">oid1</span> <span class="main">,</span> <span class="free">oid7</span> <span class="main">,</span> <span class="free">oid2</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="quoted">"<span class="free">σ<span class="hidden">⇩</span><sub>1</sub>_object0<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub></span>"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"ty<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub>"</span></span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="quoted">"<span class="free">σ<span class="hidden">⇩</span><sub>1</sub>_object0</span>"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">⋅</span>Person"</span></span>
<span class="keyword2"><span class="keyword">assumes</span></span> σ<span class="hidden">⇩</span><sub>1</sub>_object0_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">σ<span class="hidden">⇩</span><sub>1</sub>_object0</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">⌊</span><span class="main">⌊</span><span class="free">σ<span class="hidden">⇩</span><sub>1</sub>_object0<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub></span><span class="main">⌋</span><span class="main">⌋</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="quoted">"<span class="free">σ<span class="hidden">⇩</span><sub>1</sub>_object1<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub></span>"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"ty<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub>"</span></span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="quoted">"<span class="free">σ<span class="hidden">⇩</span><sub>1</sub>_object1</span>"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">⋅</span>Person"</span></span>
<span class="keyword2"><span class="keyword">assumes</span></span> σ<span class="hidden">⇩</span><sub>1</sub>_object1_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">σ<span class="hidden">⇩</span><sub>1</sub>_object1</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">⌊</span><span class="main">⌊</span><span class="free">σ<span class="hidden">⇩</span><sub>1</sub>_object1<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub></span><span class="main">⌋</span><span class="main">⌋</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="quoted">"<span class="free">σ<span class="hidden">⇩</span><sub>1</sub>_object2<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub></span>"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"ty<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub>"</span></span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="quoted">"<span class="free">σ<span class="hidden">⇩</span><sub>1</sub>_object2</span>"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">⋅</span>Person"</span></span>
<span class="keyword2"><span class="keyword">assumes</span></span> σ<span class="hidden">⇩</span><sub>1</sub>_object2_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">σ<span class="hidden">⇩</span><sub>1</sub>_object2</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">⌊</span><span class="main">⌊</span><span class="free">σ<span class="hidden">⇩</span><sub>1</sub>_object2<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub></span><span class="main">⌋</span><span class="main">⌋</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="quoted">"<span class="free">X<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub>1<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub></span>"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"ty<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub>"</span></span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="quoted">"<span class="free">X<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub>1</span>"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">⋅</span>Person"</span></span>
<span class="keyword2"><span class="keyword">assumes</span></span> X<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub>1_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub>1</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">⌊</span><span class="main">⌊</span><span class="free">X<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub>1<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub></span><span class="main">⌋</span><span class="main">⌋</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="quoted">"<span class="free">σ<span class="hidden">⇩</span><sub>1</sub>_object4<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub></span>"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"ty<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub>"</span></span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="quoted">"<span class="free">σ<span class="hidden">⇩</span><sub>1</sub>_object4</span>"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">⋅</span>Person"</span></span>
<span class="keyword2"><span class="keyword">assumes</span></span> σ<span class="hidden">⇩</span><sub>1</sub>_object4_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">σ<span class="hidden">⇩</span><sub>1</sub>_object4</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">⌊</span><span class="main">⌊</span><span class="free">σ<span class="hidden">⇩</span><sub>1</sub>_object4<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub></span><span class="main">⌋</span><span class="main">⌋</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="quoted">"<span class="free">X<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub>2<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub></span>"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"ty<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub>"</span></span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="quoted">"<span class="free">X<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub>2</span>"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">⋅</span>Person"</span></span>
<span class="keyword2"><span class="keyword">assumes</span></span> X<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub>2_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub>2</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">⌊</span><span class="main">⌊</span><span class="free">X<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub>2<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub></span><span class="main">⌋</span><span class="main">⌋</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="main">(</span>state.make <span class="main">(</span><span class="main">(</span>Map.empty <span class="main">(</span><span class="free">oid4</span> <span class="main">↦</span> <span class="main">(</span>in<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub> <span class="main">(</span><span class="free">σ<span class="hidden">⇩</span><sub>1</sub>_object0<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">oid5</span> <span class="main">↦</span> <span class="main">(</span>in<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub> <span class="main">(</span><span class="free">σ<span class="hidden">⇩</span><sub>1</sub>_object1<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">oid6</span> <span class="main">↦</span> <span class="main">(</span>in<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub> <span class="main">(</span><span class="free">σ<span class="hidden">⇩</span><sub>1</sub>_object2<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">oid1</span> <span class="main">↦</span> <span class="main">(</span>in<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub> <span class="main">(</span><span class="free">X<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub>1<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">oid7</span> <span class="main">↦</span> <span class="main">(</span>in<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub> <span class="main">(</span><span class="free">σ<span class="hidden">⇩</span><sub>1</sub>_object4<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">oid2</span> <span class="main">↦</span> <span class="main">(</span>in<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub> <span class="main">(</span><span class="free">X<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub>2<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span>map_of_list <span class="main">(</span><span class="main">[</span><span class="main">(</span>oid<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub>_0___boss <span class="main">,</span> <span class="main">(</span>List.map <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span> <span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="main">[</span><span class="bound">x</span> <span class="main">,</span> <span class="bound">y</span><span class="main">]</span><span class="main">)</span> <span class="keyword1">o</span> switch<span class="hidden">⇩</span><sub>2</sub>_01<span class="main">)</span> <span class="main">(</span><span class="main">[</span><span class="main">[</span><span class="main">[</span><span class="free">oid4</span><span class="main">]</span> <span class="main">,</span> <span class="main">[</span><span class="free">oid2</span><span class="main">]</span><span class="main">]</span> <span class="main">,</span> <span class="main">[</span><span class="main">[</span><span class="free">oid6</span><span class="main">]</span> <span class="main">,</span> <span class="main">[</span><span class="free">oid4</span><span class="main">]</span><span class="main">]</span> <span class="main">,</span> <span class="main">[</span><span class="main">[</span><span class="free">oid1</span><span class="main">]</span> <span class="main">,</span> <span class="main">[</span><span class="free">oid6</span><span class="main">]</span><span class="main">]</span> <span class="main">,</span> <span class="main">[</span><span class="main">[</span><span class="free">oid7</span><span class="main">]</span> <span class="main">,</span> <span class="main">[</span>oid3<span class="main">]</span><span class="main">]</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> perm_σ<span class="hidden">⇩</span><sub>1</sub> <span class="main">:</span> <span class="quoted"><span class="quoted">"σ<span class="hidden">⇩</span><sub>1</sub> <span class="main">=</span> <span class="main">(</span>state.make <span class="main">(</span><span class="main">(</span>Map.empty <span class="main">(</span><span class="free">oid2</span> <span class="main">↦</span> <span class="main">(</span>in<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub> <span class="main">(</span><span class="free">X<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub>2<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">oid7</span> <span class="main">↦</span> <span class="main">(</span>in<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub> <span class="main">(</span><span class="free">σ<span class="hidden">⇩</span><sub>1</sub>_object4<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">oid1</span> <span class="main">↦</span> <span class="main">(</span>in<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub> <span class="main">(</span><span class="free">X<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub>1<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">oid6</span> <span class="main">↦</span> <span class="main">(</span>in<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub> <span class="main">(</span><span class="free">σ<span class="hidden">⇩</span><sub>1</sub>_object2<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">oid5</span> <span class="main">↦</span> <span class="main">(</span>in<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub> <span class="main">(</span><span class="free">σ<span class="hidden">⇩</span><sub>1</sub>_object1<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">oid4</span> <span class="main">↦</span> <span class="main">(</span>in<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub> <span class="main">(</span><span class="free">σ<span class="hidden">⇩</span><sub>1</sub>_object0<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span>assocs <span class="main">(</span>σ<span class="hidden">⇩</span><sub>1</sub><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> σ<span class="hidden">⇩</span><sub>1</sub>_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> fun_upd_twist<span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> distinct_oid distinct_length_2_or_more<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> fun_upd_twist<span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> distinct_oid distinct_length_2_or_more<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> fun_upd_twist<span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> distinct_oid distinct_length_2_or_more<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> fun_upd_twist<span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> distinct_oid distinct_length_2_or_more<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> fun_upd_twist<span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> distinct_oid distinct_length_2_or_more<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> fun_upd_twist<span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> distinct_oid distinct_length_2_or_more<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> fun_upd_twist<span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> distinct_oid distinct_length_2_or_more<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> fun_upd_twist<span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> distinct_oid distinct_length_2_or_more<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> fun_upd_twist<span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> distinct_oid distinct_length_2_or_more<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> fun_upd_twist<span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> distinct_oid distinct_length_2_or_more<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> fun_upd_twist<span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> distinct_oid distinct_length_2_or_more<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> fun_upd_twist<span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> distinct_oid distinct_length_2_or_more<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> fun_upd_twist<span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> distinct_oid distinct_length_2_or_more<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> fun_upd_twist<span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> distinct_oid distinct_length_2_or_more<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> fun_upd_twist<span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> distinct_oid distinct_length_2_or_more<span class="main">)</span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="comment1">(* 17 ************************************ 36 + 1 *)</span>
<span class="keyword1"><span class="command">locale</span></span> state_σ<span class="hidden">⇩</span><sub>1</sub>' <span class="main">=</span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="quoted">"<span class="free">oid1</span>"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat"</span></span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="quoted">"<span class="free">oid2</span>"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat"</span></span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="quoted">"<span class="free">oid3</span>"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat"</span></span>
<span class="keyword2"><span class="keyword">assumes</span></span> distinct_oid<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>distinct <span class="main">(</span><span class="main">[</span><span class="free">oid1</span> <span class="main">,</span> <span class="free">oid2</span> <span class="main">,</span> <span class="free">oid3</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="quoted">"<span class="free">X<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub>1<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub></span>"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"ty<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub>"</span></span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="quoted">"<span class="free">X<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub>1</span>"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">⋅</span>Person"</span></span>
<span class="keyword2"><span class="keyword">assumes</span></span> X<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub>1_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub>1</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">⌊</span><span class="main">⌊</span><span class="free">X<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub>1<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub></span><span class="main">⌋</span><span class="main">⌋</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="quoted">"<span class="free">X<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub>2<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub></span>"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"ty<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub>"</span></span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="quoted">"<span class="free">X<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub>2</span>"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">⋅</span>Person"</span></span>
<span class="keyword2"><span class="keyword">assumes</span></span> X<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub>2_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub>2</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">⌊</span><span class="main">⌊</span><span class="free">X<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub>2<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub></span><span class="main">⌋</span><span class="main">⌋</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="quoted">"<span class="free">X<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub>3<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub></span>"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"ty<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub>"</span></span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="quoted">"<span class="free">X<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub>3</span>"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">⋅</span>Person"</span></span>
<span class="keyword2"><span class="keyword">assumes</span></span> X<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub>3_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub>3</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">⌊</span><span class="main">⌊</span><span class="free">X<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub>3<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub></span><span class="main">⌋</span><span class="main">⌋</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">=</span> <span class="main">(</span>state.make <span class="main">(</span><span class="main">(</span>Map.empty <span class="main">(</span><span class="free">oid1</span> <span class="main">↦</span> <span class="main">(</span>in<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub> <span class="main">(</span><span class="free">X<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub>1<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">oid2</span> <span class="main">↦</span> <span class="main">(</span>in<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub> <span class="main">(</span><span class="free">X<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub>2<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">oid3</span> <span class="main">↦</span> <span class="main">(</span>in<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub> <span class="main">(</span><span class="free">X<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub>3<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span>map_of_list <span class="main">(</span><span class="main">[</span><span class="main">(</span>oid<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub>_0___boss <span class="main">,</span> <span class="main">(</span>List.map <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span> <span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="main">[</span><span class="bound">x</span> <span class="main">,</span> <span class="bound">y</span><span class="main">]</span><span class="main">)</span> <span class="keyword1">o</span> switch<span class="hidden">⇩</span><sub>2</sub>_01<span class="main">)</span> <span class="main">(</span><span class="main">[</span><span class="main">[</span><span class="main">[</span><span class="free">oid1</span><span class="main">]</span> <span class="main">,</span> <span class="main">[</span><span class="free">oid2</span><span class="main">]</span><span class="main">]</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> perm_σ<span class="hidden">⇩</span><sub>1</sub>' <span class="main">:</span> <span class="quoted"><span class="quoted">"σ<span class="hidden">⇩</span><sub>1</sub>' <span class="main">=</span> <span class="main">(</span>state.make <span class="main">(</span><span class="main">(</span>Map.empty <span class="main">(</span><span class="free">oid3</span> <span class="main">↦</span> <span class="main">(</span>in<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub> <span class="main">(</span><span class="free">X<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub>3<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">oid2</span> <span class="main">↦</span> <span class="main">(</span>in<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub> <span class="main">(</span><span class="free">X<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub>2<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">oid1</span> <span class="main">↦</span> <span class="main">(</span>in<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub> <span class="main">(</span><span class="free">X<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub>1<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span>assocs <span class="main">(</span>σ<span class="hidden">⇩</span><sub>1</sub>'<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> σ<span class="hidden">⇩</span><sub>1</sub>'_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> fun_upd_twist<span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> distinct_oid distinct_length_2_or_more<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> fun_upd_twist<span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> distinct_oid distinct_length_2_or_more<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> fun_upd_twist<span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> distinct_oid distinct_length_2_or_more<span class="main">)</span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="comment1">(* 18 ************************************ 37 + 1 *)</span>
<span class="keyword1"><span class="command">locale</span></span> pre_post_σ<span class="hidden">⇩</span><sub>1</sub>_σ<span class="hidden">⇩</span><sub>1</sub>' <span class="main">=</span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="quoted">"<span class="free">oid1</span>"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat"</span></span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="quoted">"<span class="free">oid2</span>"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat"</span></span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="quoted">"<span class="free">oid3</span>"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat"</span></span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="quoted">"<span class="free">oid4</span>"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat"</span></span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="quoted">"<span class="free">oid5</span>"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat"</span></span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="quoted">"<span class="free">oid6</span>"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat"</span></span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="quoted">"<span class="free">oid7</span>"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat"</span></span>
<span class="keyword2"><span class="keyword">assumes</span></span> distinct_oid<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>distinct <span class="main">(</span><span class="main">[</span><span class="free">oid1</span> <span class="main">,</span> <span class="free">oid2</span> <span class="main">,</span> <span class="free">oid3</span> <span class="main">,</span> <span class="free">oid4</span> <span class="main">,</span> <span class="free">oid5</span> <span class="main">,</span> <span class="free">oid6</span> <span class="main">,</span> <span class="free">oid7</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="quoted">"<span class="free">X<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub>1<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub></span>"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"ty<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub>"</span></span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="quoted">"<span class="free">X<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub>1</span>"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">⋅</span>Person"</span></span>
<span class="keyword2"><span class="keyword">assumes</span></span> X<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub>1_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub>1</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">⌊</span><span class="main">⌊</span><span class="free">X<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub>1<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub></span><span class="main">⌋</span><span class="main">⌋</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="quoted">"<span class="free">X<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub>2<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub></span>"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"ty<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub>"</span></span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="quoted">"<span class="free">X<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub>2</span>"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">⋅</span>Person"</span></span>
<span class="keyword2"><span class="keyword">assumes</span></span> X<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub>2_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub>2</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">⌊</span><span class="main">⌊</span><span class="free">X<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub>2<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub></span><span class="main">⌋</span><span class="main">⌋</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="quoted">"<span class="free">X<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub>3<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub></span>"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"ty<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub>"</span></span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="quoted">"<span class="free">X<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub>3</span>"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">⋅</span>Person"</span></span>
<span class="keyword2"><span class="keyword">assumes</span></span> X<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub>3_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub>3</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">⌊</span><span class="main">⌊</span><span class="free">X<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub>3<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub></span><span class="main">⌋</span><span class="main">⌋</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="quoted">"<span class="free">σ<span class="hidden">⇩</span><sub>1</sub>_object0<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub></span>"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"ty<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub>"</span></span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="quoted">"<span class="free">σ<span class="hidden">⇩</span><sub>1</sub>_object0</span>"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">⋅</span>Person"</span></span>
<span class="keyword2"><span class="keyword">assumes</span></span> σ<span class="hidden">⇩</span><sub>1</sub>_object0_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">σ<span class="hidden">⇩</span><sub>1</sub>_object0</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">⌊</span><span class="main">⌊</span><span class="free">σ<span class="hidden">⇩</span><sub>1</sub>_object0<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub></span><span class="main">⌋</span><span class="main">⌋</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="quoted">"<span class="free">σ<span class="hidden">⇩</span><sub>1</sub>_object1<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub></span>"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"ty<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub>"</span></span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="quoted">"<span class="free">σ<span class="hidden">⇩</span><sub>1</sub>_object1</span>"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">⋅</span>Person"</span></span>
<span class="keyword2"><span class="keyword">assumes</span></span> σ<span class="hidden">⇩</span><sub>1</sub>_object1_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">σ<span class="hidden">⇩</span><sub>1</sub>_object1</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">⌊</span><span class="main">⌊</span><span class="free">σ<span class="hidden">⇩</span><sub>1</sub>_object1<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub></span><span class="main">⌋</span><span class="main">⌋</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="quoted">"<span class="free">σ<span class="hidden">⇩</span><sub>1</sub>_object2<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub></span>"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"ty<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub>"</span></span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="quoted">"<span class="free">σ<span class="hidden">⇩</span><sub>1</sub>_object2</span>"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">⋅</span>Person"</span></span>
<span class="keyword2"><span class="keyword">assumes</span></span> σ<span class="hidden">⇩</span><sub>1</sub>_object2_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">σ<span class="hidden">⇩</span><sub>1</sub>_object2</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">⌊</span><span class="main">⌊</span><span class="free">σ<span class="hidden">⇩</span><sub>1</sub>_object2<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub></span><span class="main">⌋</span><span class="main">⌋</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="quoted">"<span class="free">σ<span class="hidden">⇩</span><sub>1</sub>_object4<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub></span>"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"ty<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub>"</span></span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="quoted">"<span class="free">σ<span class="hidden">⇩</span><sub>1</sub>_object4</span>"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">⋅</span>Person"</span></span>
<span class="keyword2"><span class="keyword">assumes</span></span> σ<span class="hidden">⇩</span><sub>1</sub>_object4_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">σ<span class="hidden">⇩</span><sub>1</sub>_object4</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">⌊</span><span class="main">⌊</span><span class="free">σ<span class="hidden">⇩</span><sub>1</sub>_object4<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub></span><span class="main">⌋</span><span class="main">⌋</span><span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">assumes</span></span> σ<span class="hidden">⇩</span><sub>1</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>state_σ<span class="hidden">⇩</span><sub>1</sub> <span class="main">(</span><span class="free">oid4</span><span class="main">)</span> <span class="main">(</span><span class="free">oid5</span><span class="main">)</span> <span class="main">(</span><span class="free">oid6</span><span class="main">)</span> <span class="main">(</span><span class="free">oid1</span><span class="main">)</span> <span class="main">(</span><span class="free">oid7</span><span class="main">)</span> <span class="main">(</span><span class="free">oid2</span><span class="main">)</span> <span class="main">(</span><span class="free">σ<span class="hidden">⇩</span><sub>1</sub>_object0<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub></span><span class="main">)</span> <span class="main">(</span><span class="free">σ<span class="hidden">⇩</span><sub>1</sub>_object0</span><span class="main">)</span> <span class="main">(</span><span class="free">σ<span class="hidden">⇩</span><sub>1</sub>_object1<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub></span><span class="main">)</span> <span class="main">(</span><span class="free">σ<span class="hidden">⇩</span><sub>1</sub>_object1</span><span class="main">)</span> <span class="main">(</span><span class="free">σ<span class="hidden">⇩</span><sub>1</sub>_object2<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub></span><span class="main">)</span> <span class="main">(</span><span class="free">σ<span class="hidden">⇩</span><sub>1</sub>_object2</span><span class="main">)</span> <span class="main">(</span><span class="free">X<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub>1<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub></span><span class="main">)</span> <span class="main">(</span><span class="free">X<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub>1</span><span class="main">)</span> <span class="main">(</span><span class="free">σ<span class="hidden">⇩</span><sub>1</sub>_object4<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub></span><span class="main">)</span> <span class="main">(</span><span class="free">σ<span class="hidden">⇩</span><sub>1</sub>_object4</span><span class="main">)</span> <span class="main">(</span><span class="free">X<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub>2<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub></span><span class="main">)</span> <span class="main">(</span><span class="free">X<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub>2</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">assumes</span></span> σ<span class="hidden">⇩</span><sub>1</sub>'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>state_σ<span class="hidden">⇩</span><sub>1</sub>' <span class="main">(</span><span class="free">oid1</span><span class="main">)</span> <span class="main">(</span><span class="free">oid2</span><span class="main">)</span> <span class="main">(</span><span class="free">oid3</span><span class="main">)</span> <span class="main">(</span><span class="free">X<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub>1<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub></span><span class="main">)</span> <span class="main">(</span><span class="free">X<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub>1</span><span class="main">)</span> <span class="main">(</span><span class="free">X<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub>2<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub></span><span class="main">)</span> <span class="main">(</span><span class="free">X<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub>2</span><span class="main">)</span> <span class="main">(</span><span class="free">X<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub>3<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub></span><span class="main">)</span> <span class="main">(</span><span class="free">X<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub>3</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">interpretation</span></span> state_σ<span class="hidden">⇩</span><sub>1</sub><span class="main">:</span> state_σ<span class="hidden">⇩</span><sub>1</sub> <span class="quoted"><span class="quoted">"<span class="free">oid4</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">oid5</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">oid6</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">oid1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">oid7</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">oid2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ<span class="hidden">⇩</span><sub>1</sub>_object0<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ<span class="hidden">⇩</span><sub>1</sub>_object0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ<span class="hidden">⇩</span><sub>1</sub>_object1<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ<span class="hidden">⇩</span><sub>1</sub>_object1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ<span class="hidden">⇩</span><sub>1</sub>_object2<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ<span class="hidden">⇩</span><sub>1</sub>_object2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">X<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub>1<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">X<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub>1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ<span class="hidden">⇩</span><sub>1</sub>_object4<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ<span class="hidden">⇩</span><sub>1</sub>_object4</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">X<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub>2<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">X<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub>2</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> σ<span class="hidden">⇩</span><sub>1</sub><span class="main">)</span>

<span class="keyword1"><span class="command">interpretation</span></span> state_σ<span class="hidden">⇩</span><sub>1</sub>'<span class="main">:</span> state_σ<span class="hidden">⇩</span><sub>1</sub>' <span class="quoted"><span class="quoted">"<span class="free">oid1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">oid2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">oid3</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">X<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub>1<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">X<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub>1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">X<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub>2<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">X<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub>2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">X<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub>3<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">X<span class="hidden">⇩</span><sub>P</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>n</sub>3</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> σ<span class="hidden">⇩</span><sub>1</sub>'<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">heap_σ<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="main">(</span>heap <span class="main">(</span>state_σ<span class="hidden">⇩</span><sub>1</sub>.σ<span class="hidden">⇩</span><sub>1</sub><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">heap_σ<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">=</span> <span class="main">(</span>heap <span class="main">(</span>state_σ<span class="hidden">⇩</span><sub>1</sub>'.σ<span class="hidden">⇩</span><sub>1</sub>'<span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div>