<div id="Laws_of_Large_Numbers">
<div class="head">
<h1>Theory Laws_of_Large_Numbers</h1>
</div>
<pre class="source"><span class="comment1">(*
   File:     Laws_of_Large_Numbers.thy
   Author:   Manuel Eberl, TU München
*)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹The Laws of Large Numbers›</span></span>
<span class="keyword1"><span class="command">theory</span></span> Laws_of_Large_Numbers
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="../Ergodic_Theory/Shift_Operator.html">Ergodic_Theory.Shift_Operator</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We prove the strong law of large numbers in the following form: Let $(X_i)_{i\in\mathbb{N}}$
  be a sequence of i.i.d. random variables over a probability space <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>M›</span></span></span></span>. Further assume that
  the expected value $E[X_0]$ of $X_0$ exists. Then the sequence of random variables
  \[\overline{X}_n = \frac{1}{n} \sum_{i=0}^n X_i\]
  of running averages almost surely converges to $E[X_0]$.
  This means that
  \[\mathcal{P}[\overline{X}_n \longrightarrow E[X_0]] = 1\ .\]

  We start with the strong law.
›</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹The strong law›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The proof uses Birkhoff's Theorem from Gouëzel's formalisation of ergodic theory~\cite{gouezel}
  and the fact that the shift operator $T(x_1, x_2, x_3, \ldots) = (x_2, x_3, \ldots)$ is ergodic.
  This proof can be found in various textbooks on probability theory/ergodic
  theory, e.g. the ones by Krengel~\cite[p.~24]{krengel} and
  Simmonet~\cite[Chapter 15, pp.~311--325]{Simonnet1996}.
›</span></span>
<span class="keyword1"><span class="command">theorem</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> prob_space<span class="main">)</span> strong_law_of_large_numbers_iid<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">X</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> real"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> indep<span class="main">:</span> <span class="quoted"><span class="quoted">"indep_vars <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> borel<span class="main">)</span> <span class="free">X</span> UNIV"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> distr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> distr <span class="free">M</span> borel <span class="main">(</span><span class="free">X</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> distr <span class="free">M</span> borel <span class="main">(</span><span class="free">X</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> L1<span class="main">:</span>    <span class="quoted"><span class="quoted">"integrable <span class="free">M</span> <span class="main">(</span><span class="free">X</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">AE</span> <span class="bound">x</span> <span class="keyword1">in</span> <span class="free">M</span><span class="main">.</span> <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span><span class="bound">n</span><span class="main">.</span> <span class="free">X</span> <span class="bound">i</span> <span class="bound">x</span><span class="main">)</span> <span class="main">/</span> <span class="bound">n</span><span class="main">)</span> <span class="main">⇢</span> expectation <span class="main">(</span><span class="free">X</span> <span class="main">0</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
    We adopt a more explicit view of <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">term</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span class="quoted">‹<span class="free"><span class="free">M</span></span>›</span></span></span></span> as a countably infinite product of i.i.d.
    random variables, indexed by the natural numbers:
  ›</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">M'</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat <span class="main">⇒</span> real<span class="main">)</span> measure"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">M'</span> <span class="main">=</span> Pi<span class="hidden">⇩</span><sub>M</sub> UNIV <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> distr <span class="free">M</span> borel <span class="main">(</span><span class="free">X</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"random_variable borel <span class="main">(</span><span class="free">X</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
    <span class="keyword1"><span class="command">using</span></span> indep <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> indep_vars_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> M'_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">M'</span> <span class="main">=</span> distr <span class="free">M</span> <span class="main">(</span>Pi<span class="hidden">⇩</span><sub>M</sub> UNIV <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> borel<span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">λ</span><span class="bound">i</span><span class="main">∈</span>UNIV<span class="main">.</span> <span class="free">X</span> <span class="bound">i</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> indep <span class="keyword1"><span class="command">unfolding</span></span> M'_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> indep_vars_iff_distr_eq_PiM<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> space_M'<span class="main">:</span> <span class="quoted"><span class="quoted">"space <span class="skolem">M'</span> <span class="main">=</span> UNIV"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> M'_def space_PiM<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> sets_M' <span class="main">[</span><span class="operator">measurable_cong</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"sets <span class="skolem">M'</span> <span class="main">=</span> sets <span class="main">(</span>Pi<span class="hidden">⇩</span><sub>M</sub> UNIV <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> borel<span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> M'_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">interpret</span></span> M'<span class="main">:</span> prob_space <span class="quoted"><span class="skolem">M'</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> M'_eq <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> prob_space_distr<span class="main">)</span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We introduce a shift operator that forgets the first variable in the sequence.›</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">T</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat <span class="main">⇒</span> real<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span>nat <span class="main">⇒</span> real<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">T</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="main">∘</span> Suc<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> funpow_T<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">T</span> <span class="main">^^</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="main">∘</span> <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">+</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> T_def<span class="main">)</span>

  <span class="keyword1"><span class="command">interpret</span></span> T<span class="main">:</span> shift_operator_ergodic <span class="quoted"><span class="quoted">"distr <span class="free">M</span> borel <span class="main">(</span><span class="free">X</span> <span class="main">0</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="skolem">T</span></span> <span class="quoted"><span class="skolem">M'</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">interpret</span></span> X0<span class="main">:</span> prob_space <span class="quoted"><span class="quoted">"distr <span class="free">M</span> borel <span class="main">(</span><span class="free">X</span> <span class="main">0</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> prob_space_distr<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"shift_operator_ergodic <span class="main">(</span>distr <span class="free">M</span> borel <span class="main">(</span><span class="free">X</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">M'</span> <span class="main">≡</span> Pi<span class="hidden">⇩</span><sub>M</sub> UNIV <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> distr <span class="free">M</span> borel <span class="main">(</span><span class="free">X</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> "</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> M'_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> distr<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> T_def<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"integrable <span class="skolem">M'</span> <span class="main">(</span><span class="main">λ</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> M'_eq <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> integrable_distr_eq<span class="main">)</span> <span class="main">(</span><span class="operator">use</span> L1 <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">AE</span> <span class="bound">f</span> <span class="keyword1">in</span> <span class="skolem">M'</span><span class="main">.</span> <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> T.birkhoff_sum <span class="main">(</span><span class="main">λ</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="main">0</span><span class="main">)</span> <span class="bound">n</span> <span class="bound">f</span> <span class="main">/</span> real <span class="bound">n</span><span class="main">)</span>
            <span class="main">⇢</span> real_cond_exp <span class="skolem">M'</span> T.Invariants <span class="main">(</span><span class="main">λ</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="main">0</span><span class="main">)</span> <span class="bound">f</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> T.birkhoff_theorem_AE_nonergodic<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">AE</span> <span class="bound">x</span> <span class="keyword1">in</span> <span class="skolem">M'</span><span class="main">.</span> real_cond_exp <span class="skolem">M'</span> T.Invariants <span class="main">(</span><span class="main">λ</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="main">0</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span>
                    M'.expectation <span class="main">(</span><span class="main">λ</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="main">0</span><span class="main">)</span> <span class="main">/</span> M'.prob <span class="main">(</span>space <span class="skolem">M'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> T.Invariants_cond_exp_is_integral_fmpt<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">AE</span> <span class="bound">f</span> <span class="keyword1">in</span> <span class="skolem">M'</span><span class="main">.</span> <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> T.birkhoff_sum <span class="main">(</span><span class="main">λ</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="main">0</span><span class="main">)</span> <span class="bound">n</span> <span class="bound">f</span> <span class="main">/</span> real <span class="bound">n</span><span class="main">)</span>
                     <span class="main">⇢</span> M'.expectation <span class="main">(</span><span class="main">λ</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">eventually_elim</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> M'.prob_space<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"M'.expectation <span class="main">(</span><span class="main">λ</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> expectation <span class="main">(</span><span class="free">X</span> <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> M'_eq <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> integral_distr<span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"T.birkhoff_sum <span class="main">(</span><span class="main">λ</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">n</span> <span class="bound">f</span><span class="main">.</span> sum <span class="bound">f</span> <span class="main">{..&lt;</span><span class="bound">n</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> ext<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>T.birkhoff_sum_def funpow_T<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> M'_eq <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> AE_distr_iff<span class="main">)</span> <span class="operator">simp_all</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹The weak law›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  To go from the strong law to the weak one, we need the fact that almost sure convergence
  implies convergence in probability. We prove this for sequences of random variables here.
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> prob_space<span class="main">)</span> AE_convergence_imp_convergence_in_prob<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> random_variable borel <span class="main">(</span><span class="free">X</span> <span class="bound">i</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"random_variable borel <span class="free">Y</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> AE<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">AE</span> <span class="bound">x</span> <span class="keyword1">in</span> <span class="free">M</span><span class="main">.</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">X</span> <span class="bound">i</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⇢</span> <span class="free">Y</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">ε</span> <span class="main">&gt;</span> <span class="main">(</span><span class="main">0</span> <span class="main">::</span> real<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> prob <span class="main">{</span><span class="bound"><span class="bound">x</span></span><span class="main">∈</span>space <span class="free">M</span><span class="main">.</span> <span class="main">¦</span><span class="free">X</span> <span class="bound">i</span> <span class="bound">x</span> <span class="main">-</span> <span class="free">Y</span> <span class="bound">x</span><span class="main">¦</span> <span class="main">&gt;</span> <span class="free">ε</span><span class="main">}</span><span class="main">)</span> <span class="main">⇢</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">A</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span><span class="main">∈</span>space <span class="free">M</span><span class="main">.</span> <span class="main">¦</span><span class="free">X</span> <span class="bound">i</span> <span class="bound">x</span> <span class="main">-</span> <span class="free">Y</span> <span class="bound">x</span><span class="main">¦</span> <span class="main">&gt;</span> <span class="free">ε</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">B</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">i</span><span class="main">∈</span><span class="main">{</span><span class="bound">n</span><span class="main">..}</span><span class="main">.</span> <span class="skolem">A</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="skolem">i</span> <span class="main">∈</span> sets <span class="free">M</span>"</span></span>  <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="skolem">i</span> <span class="main">∈</span> sets <span class="free">M</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
    <span class="keyword1"><span class="command">unfolding</span></span> A_def B_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">measurable</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">AE</span> <span class="bound">x</span> <span class="keyword1">in</span> <span class="free">M</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∉</span> <span class="main">(</span><span class="main">⋂</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">B</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> AE <span class="keyword1"><span class="command">unfolding</span></span> B_def A_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">eventually_elim</span>
       <span class="main">(</span><span class="operator">use</span> <span class="quoted"><span class="quoted">‹<span class="free">ε</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted">‹<span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main">:</span> tendsto_iff dist_norm eventually_at_top_linorder›</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋂</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">B</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∈</span> null_sets <span class="free">M</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> AE_iff_null_sets<span class="main">)</span> <span class="operator">auto</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> prob <span class="main">(</span><span class="skolem">A</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">⇢</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> Lim_null_comparison<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> prob <span class="main">(</span><span class="skolem">B</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">⇢</span> prob <span class="main">(</span><span class="main">⋂</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">B</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> finite_Lim_measure_decseq<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"decseq <span class="skolem">B</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> decseq_SucI<span class="main">)</span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> B_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"prob <span class="main">(</span><span class="main">⋂</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">B</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main">⋂</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">B</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∈</span> null_sets <span class="free">M</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> measure_eq_0_null_sets<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> prob <span class="main">(</span><span class="skolem">B</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">⇢</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"prob <span class="main">(</span><span class="skolem">A</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">≤</span> prob <span class="main">(</span><span class="skolem">B</span> <span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">n</span>
      <span class="keyword1"><span class="command">unfolding</span></span> B_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> finite_measure_mono<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">∀<span class="hidden">⇩</span><sub>F</sub></span> <span class="bound">n</span> <span class="keyword1">in</span> at_top<span class="main">.</span> norm <span class="main">(</span>prob <span class="main">(</span><span class="skolem">A</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> prob <span class="main">(</span><span class="skolem">B</span> <span class="bound">n</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> always_eventually<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The weak law is now a simple corollary: we again have the same setting as before. The weak
  law now states that $\overline{X}_n$ converges to $E[X_0]$ in probability. This means that
  for any <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>ε &gt; 0›</span></span></span></span>, the probability that $|\overline{X}_n - X_0| &gt; \varepsilon$ vanishes as
  <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>n → ∞›</span></span></span></span>.
›</span></span>
<span class="keyword1"><span class="command">corollary</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> prob_space<span class="main">)</span> weak_law_of_large_numbers_iid<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">X</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">ε</span> <span class="main">::</span> <span class="quoted">real</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> indep<span class="main">:</span> <span class="quoted"><span class="quoted">"indep_vars <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> borel<span class="main">)</span> <span class="free">X</span> UNIV"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> distr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> distr <span class="free">M</span> borel <span class="main">(</span><span class="free">X</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> distr <span class="free">M</span> borel <span class="main">(</span><span class="free">X</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> L1<span class="main">:</span>    <span class="quoted"><span class="quoted">"integrable <span class="free">M</span> <span class="main">(</span><span class="free">X</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">ε</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> prob <span class="main">{</span><span class="bound"><span class="bound">x</span></span><span class="main">∈</span>space <span class="free">M</span><span class="main">.</span> <span class="main">¦</span><span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span><span class="bound">n</span><span class="main">.</span> <span class="free">X</span> <span class="bound">i</span> <span class="bound">x</span><span class="main">)</span> <span class="main">/</span> <span class="bound">n</span> <span class="main">-</span> expectation <span class="main">(</span><span class="free">X</span> <span class="main">0</span><span class="main">)</span><span class="main">¦</span> <span class="main">&gt;</span> <span class="free">ε</span><span class="main">}</span><span class="main">)</span> <span class="main">⇢</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> AE_convergence_imp_convergence_in_prob<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">AE</span> <span class="bound">x</span> <span class="keyword1">in</span> <span class="free">M</span><span class="main">.</span> <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span><span class="bound">n</span><span class="main">.</span> <span class="free">X</span> <span class="bound">i</span> <span class="bound">x</span><span class="main">)</span> <span class="main">/</span> <span class="bound">n</span><span class="main">)</span> <span class="main">⇢</span> expectation <span class="main">(</span><span class="free">X</span> <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> strong_law_of_large_numbers_iid<span class="main">)</span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"random_variable borel <span class="main">(</span><span class="free">X</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
    <span class="keyword1"><span class="command">using</span></span> indep <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> indep_vars_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"random_variable borel <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span><span class="skolem">n</span><span class="main">.</span> <span class="free">X</span> <span class="bound">i</span> <span class="bound">x</span><span class="main">)</span> <span class="main">/</span> real <span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">n</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">measurable</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">use</span> <span class="quoted"><span class="quoted">‹<span class="free">ε</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">simp_all</span><span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Laws_of_Large_Numbers_Example">
<div class="head">
<h1>Theory Laws_of_Large_Numbers_Example</h1>
</div>
<pre class="source"><span class="comment1">(*
   File:     Laws_of_Large_Numbers.thy
   Author:   Manuel Eberl, TU München
*)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Example›</span></span>
<span class="keyword1"><span class="command">theory</span></span> Laws_of_Large_Numbers_Example
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="Laws_of_Large_Numbers.html">Laws_of_Large_Numbers</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  As an example, we apply the strong law to the proportion of successes in an independent sequence
  of coin flips with success probability <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>p›</span></span></span></span>. We will show that proportion of successful coin
  flips among the first <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>n›</span></span></span></span> attempts almost surely converges to <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>p›</span></span></span></span> as <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>n → ∞›</span></span></span></span>.
›</span></span>

<span class="comment1">(* TODO: Move *)</span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> prob_space<span class="main">)</span> indep_vars_iff_distr_eq_PiM'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">I</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'i</span> set"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">X</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'i</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> rv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">I</span> <span class="main">⟹</span> random_variable <span class="main">(</span><span class="free">M'</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free">X</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"indep_vars <span class="free">M'</span> <span class="free">X</span> <span class="free">I</span> <span class="main">⟷</span>
           distr <span class="free">M</span> <span class="main">(</span><span class="keyword1">Π<span class="hidden">⇩</span><sub>M</sub></span> <span class="bound">i</span><span class="main">∈</span><span class="free">I</span><span class="main">.</span> <span class="free">M'</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">λ</span><span class="bound">i</span><span class="main">∈</span><span class="free">I</span><span class="main">.</span> <span class="free">X</span> <span class="bound">i</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">Π<span class="hidden">⇩</span><sub>M</sub></span> <span class="bound">i</span><span class="main">∈</span><span class="free">I</span><span class="main">.</span> distr <span class="free">M</span> <span class="main">(</span><span class="free">M'</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free">X</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∈</span> <span class="free">I</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">N'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">N'</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">I</span> <span class="keyword1">then</span> <span class="free">M'</span> <span class="bound">i</span> <span class="keyword1">else</span> <span class="free">M'</span> <span class="skolem">j</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">Y</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Y</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">I</span> <span class="keyword1">then</span> <span class="free">X</span> <span class="bound">i</span> <span class="keyword1">else</span> <span class="free">X</span> <span class="skolem">j</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> rv<span class="main">:</span> <span class="quoted"><span class="quoted">"random_variable <span class="main">(</span><span class="skolem">N'</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span><span class="skolem">Y</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
    <span class="keyword1"><span class="command">using</span></span> j <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> N'_def Y_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> assms<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"indep_vars <span class="free">M'</span> <span class="free">X</span> <span class="free">I</span> <span class="main">=</span> indep_vars <span class="skolem">N'</span> <span class="skolem">Y</span> <span class="free">I</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> indep_vars_cong<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> N'_def Y_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⟷</span> distr <span class="free">M</span> <span class="main">(</span><span class="keyword1">Π<span class="hidden">⇩</span><sub>M</sub></span> <span class="bound">i</span><span class="main">∈</span><span class="free">I</span><span class="main">.</span> <span class="skolem">N'</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">λ</span><span class="bound">i</span><span class="main">∈</span><span class="free">I</span><span class="main">.</span> <span class="skolem">Y</span> <span class="bound">i</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">Π<span class="hidden">⇩</span><sub>M</sub></span> <span class="bound">i</span><span class="main">∈</span><span class="free">I</span><span class="main">.</span> distr <span class="free">M</span> <span class="main">(</span><span class="skolem">N'</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="skolem">Y</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> indep_vars_iff_distr_eq_PiM rv assms<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">Π<span class="hidden">⇩</span><sub>M</sub></span> <span class="bound">i</span><span class="main">∈</span><span class="free">I</span><span class="main">.</span> <span class="skolem">N'</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">Π<span class="hidden">⇩</span><sub>M</sub></span> <span class="bound">i</span><span class="main">∈</span><span class="free">I</span><span class="main">.</span> <span class="free">M'</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> PiM_cong<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> N'_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">λ</span><span class="bound">i</span><span class="main">∈</span><span class="free">I</span><span class="main">.</span> <span class="skolem">Y</span> <span class="bound">i</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">λ</span><span class="bound">i</span><span class="main">∈</span><span class="free">I</span><span class="main">.</span> <span class="free">X</span> <span class="bound">i</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Y_def fun_eq_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">Π<span class="hidden">⇩</span><sub>M</sub></span> <span class="bound">i</span><span class="main">∈</span><span class="free">I</span><span class="main">.</span> distr <span class="free">M</span> <span class="main">(</span><span class="skolem">N'</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="skolem">Y</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">Π<span class="hidden">⇩</span><sub>M</sub></span> <span class="bound">i</span><span class="main">∈</span><span class="free">I</span><span class="main">.</span> distr <span class="free">M</span> <span class="main">(</span><span class="free">M'</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free">X</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> PiM_cong distr_cong<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> N'_def Y_def<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* TODO: Move *)</span>
<span class="keyword1"><span class="command">lemma</span></span> indep_vars_PiM_components<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> prob_space <span class="main">(</span><span class="free">M</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"prob_space.indep_vars <span class="main">(</span>PiM <span class="free">A</span> <span class="free">M</span><span class="main">)</span> <span class="free">M</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="bound">i</span><span class="main">)</span> <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">=</span> <span class="main">{}</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distr <span class="main">(</span>Pi<span class="hidden">⇩</span><sub>M</sub> <span class="free">A</span> <span class="free">M</span><span class="main">)</span> <span class="main">(</span>Pi<span class="hidden">⇩</span><sub>M</sub> <span class="free">A</span> <span class="free">M</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> restrict <span class="bound">x</span> <span class="free">A</span><span class="main">)</span> <span class="main">=</span> distr <span class="main">(</span>Pi<span class="hidden">⇩</span><sub>M</sub> <span class="free">A</span> <span class="free">M</span><span class="main">)</span> <span class="main">(</span>Pi<span class="hidden">⇩</span><sub>M</sub> <span class="free">A</span> <span class="free">M</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> distr_cong<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> restrict_def space_PiM PiE_def extensional_def Pi_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> Pi<span class="hidden">⇩</span><sub>M</sub> <span class="free">A</span> <span class="free">M</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> Pi<span class="hidden">⇩</span><sub>M</sub> <span class="free">A</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> distr <span class="main">(</span>Pi<span class="hidden">⇩</span><sub>M</sub> <span class="free">A</span> <span class="free">M</span><span class="main">)</span> <span class="main">(</span><span class="free">M</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> PiM_cong refl<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> distr_PiM_component<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> assms<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> prob_space.indep_vars_iff_distr_eq_PiM'<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prob_space_PiM assms False<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">interpret</span></span> prob_space <span class="quoted"><span class="quoted">"PiM <span class="free">A</span> <span class="free">M</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> prob_space_PiM assms<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> indep_vars_def indep_sets_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> True<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* TODO: Move *)</span>
<span class="keyword1"><span class="command">lemma</span></span> indep_vars_PiM_components'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> prob_space <span class="main">(</span><span class="free">M</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> <span class="free">g</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">M</span> <span class="bound">i</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>M</sub></span> <span class="free">N</span> <span class="bound">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"prob_space.indep_vars <span class="main">(</span>PiM <span class="free">A</span> <span class="free">M</span><span class="main">)</span> <span class="free">N</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="bound">f</span><span class="main">.</span> <span class="free">g</span> <span class="bound">i</span> <span class="main">(</span><span class="bound">f</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> prob_space.indep_vars_compose2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> prob_space_PiM indep_vars_PiM_components<span class="main"><span class="main">]</span></span><span class="main">)</span>
     <span class="main">(</span><span class="operator">use</span> assms <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">simp_all</span><span class="main">)</span>

<span class="comment1">(* TODO: Move *)</span>
<span class="keyword1"><span class="command">lemma</span></span> integrable_bernoulli_pmf <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"bool <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">::</span> <span class="main">{</span>banach<span class="main">,</span> second_countable_topology<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"integrable <span class="main">(</span>bernoulli_pmf <span class="free">p</span><span class="main">)</span> <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> integrable_measure_pmf_finite<span class="main">)</span> <span class="operator">auto</span>

<span class="comment1">(* TODO: Move *)</span>
<span class="keyword1"><span class="command">lemma</span></span> expectation_bernoulli_pmf<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"bool <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">::</span> <span class="main">{</span>banach<span class="main">,</span> second_countable_topology<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"measure_pmf.expectation <span class="main">(</span>bernoulli_pmf <span class="free">p</span><span class="main">)</span> <span class="free">f</span> <span class="main">=</span> <span class="free">p</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">f</span> True <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">p</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">f</span> False"</span></span>
  <span class="keyword1"><span class="command">using</span></span> p <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> integral_measure_pmf<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">UNIV</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> UNIV_bool<span class="main">)</span>

<span class="keyword1"><span class="command">experiment</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span> <span class="main">::</span> <span class="quoted">real</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">M</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat <span class="main">⇒</span> bool<span class="main">)</span> measure"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">Π<span class="hidden">⇩</span><sub>M</sub></span> <span class="bound">i</span><span class="main">∈</span><span class="main">(</span>UNIV <span class="main">::</span> nat set<span class="main">)</span><span class="main">.</span> measure_pmf <span class="main">(</span>bernoulli_pmf <span class="free">p</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">X</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="main">(</span>nat <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> real"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="bound">f</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">f</span> <span class="bound">i</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> prob_space <span class="quoted">M</span>
  <span class="keyword1"><span class="command">unfolding</span></span> M_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> prob_space_PiM measure_pmf.prob_space_axioms<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> random_variable_component<span class="main">:</span> <span class="quoted"><span class="quoted">"random_variable <span class="main">(</span>count_space UNIV<span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> X_def M_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">measurable</span>

<span class="keyword1"><span class="command">lemma</span></span> random_variable_X <span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"random_variable borel <span class="main">(</span>X <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> X_def M_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">measurable</span>

<span class="keyword1"><span class="command">lemma</span></span> distr_M_component<span class="main">:</span> <span class="quoted"><span class="quoted">"distr M <span class="main">(</span>count_space UNIV<span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span> measure_pmf <span class="main">(</span>bernoulli_pmf <span class="free">p</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distr M <span class="main">(</span>count_space UNIV<span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span> distr M <span class="main">(</span>measure_pmf <span class="main">(</span>bernoulli_pmf <span class="free">p</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="free">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> distr_cong<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> measure_pmf <span class="main">(</span>bernoulli_pmf <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> M_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> distr_PiM_component<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> measure_pmf.prob_space_axioms<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> distr_M_X<span class="main">:</span>
  <span class="quoted"><span class="quoted">"distr M borel <span class="main">(</span>X <span class="free">i</span><span class="main">)</span> <span class="main">=</span> distr <span class="main">(</span>measure_pmf <span class="main">(</span>bernoulli_pmf <span class="free">p</span><span class="main">)</span><span class="main">)</span> borel <span class="main">(</span><span class="main">λ</span><span class="bound">b</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">b</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distr M borel <span class="main">(</span>X <span class="free">i</span><span class="main">)</span> <span class="main">=</span> distr <span class="main">(</span>distr M <span class="main">(</span>count_space UNIV<span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span> 
                                    borel <span class="main">(</span><span class="main">λ</span><span class="bound">b</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">b</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span> <span class="main">::</span> real<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> distr_distr<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> M_def X_def o_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">note</span></span> distr_M_component<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">i</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> X_has_expectation<span class="main">:</span> <span class="quoted"><span class="quoted">"integrable M <span class="main">(</span>X <span class="main">0</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"integrable <span class="main">(</span>bernoulli_pmf <span class="free">p</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">b</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">b</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span> <span class="main">::</span> real<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"measure_pmf <span class="main">(</span>bernoulli_pmf <span class="free">p</span><span class="main">)</span> <span class="main">=</span> distr M <span class="main">(</span>count_space UNIV<span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> distr_M_component<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"integrable <span class="main">…</span> <span class="main">(</span><span class="main">λ</span><span class="bound">b</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">b</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span> <span class="main">::</span> real<span class="main">)</span> <span class="main">=</span> integrable M <span class="main">(</span>X <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> X_def <span class="keyword1"><span class="command">using</span></span> random_variable_component <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> integrable_distr_eq<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> indep<span class="main">:</span> <span class="quoted"><span class="quoted">"indep_vars <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> borel<span class="main">)</span> X UNIV"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> M_def X_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> indep_vars_PiM_components'<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> measure_pmf.prob_space_axioms<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> expectation_X<span class="main">:</span> <span class="quoted"><span class="quoted">"expectation <span class="main">(</span>X <span class="free">i</span><span class="main">)</span> <span class="main">=</span> <span class="free">p</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"expectation <span class="main">(</span>X <span class="free">i</span><span class="main">)</span> <span class="main">=</span>
        lebesgue_integral <span class="main">(</span>distr M <span class="main">(</span>count_space UNIV<span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">b</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">b</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span> <span class="main">::</span> real<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> integral_distr<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> random_variable_component X_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distr M <span class="main">(</span>count_space UNIV<span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span> measure_pmf <span class="main">(</span>bernoulli_pmf <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> distr_M_component<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"measure_pmf.expectation <span class="main">(</span>bernoulli_pmf <span class="free">p</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">b</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">b</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span> <span class="main">::</span> real<span class="main">)</span> <span class="main">=</span> <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> p <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> integral_bernoulli_pmf<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">AE</span> <span class="bound">f</span> <span class="keyword1">in</span> M<span class="main">.</span> <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> card <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="bound">n</span> <span class="main">∧</span> <span class="bound">f</span> <span class="bound">i</span><span class="main">}</span> <span class="main">/</span> <span class="bound">n</span><span class="main">)</span> <span class="main">⇢</span> <span class="free">p</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">AE</span> <span class="bound">f</span> <span class="keyword1">in</span> M<span class="main">.</span> <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span><span class="bound">n</span><span class="main">.</span> X <span class="bound">i</span> <span class="bound">f</span><span class="main">)</span> <span class="main">/</span> real <span class="bound">n</span><span class="main">)</span> <span class="main">⇢</span> expectation <span class="main">(</span>X <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> strong_law_of_large_numbers_iid<span class="main">)</span>
       <span class="main">(</span><span class="operator">use</span> indep X_has_expectation <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted">‹<span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main">:</span> distr_M_X›</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"expectation <span class="main">(</span>X <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> expectation_X<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">n</span><span class="main">.</span> <span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span><span class="bound">n</span><span class="main">.</span> X <span class="bound">i</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">n</span><span class="main">.</span> <span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="main">{</span><span class="bound"><span class="bound">i</span></span><span class="main">∈</span><span class="main">{..&lt;</span><span class="bound">n</span><span class="main">}</span><span class="main">.</span> <span class="bound">x</span> <span class="bound">i</span><span class="main">}</span><span class="main">.</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> ext sum.mono_neutral_cong_right<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> X_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">n</span><span class="main">.</span> real <span class="main">(</span>card <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="bound">n</span> <span class="main">∧</span> <span class="bound">x</span> <span class="bound">i</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div>